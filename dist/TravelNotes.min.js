/**
 * 
 * @source: https://github.com/wwwouaiebe/TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * travelnotes - version 3.2.0-dev
 * Build 00048 - 2021-11-29T12:22:22+0100 
 * Copyright 2017 2021 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";const t={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,pageBreak:!1,printNotes:!0,borderWidth:30,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashArray:0,dashChoices:[{text:"‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî",iDashArray:[0]},{text:"‚Äî ‚Äî ‚Äî ‚Äî ‚Äî",iDashArray:[4,2]},{text:"‚Äî‚Äß‚Äî‚Äß‚Äî‚Äß‚Äî‚Äß‚Äî",iDashArray:[4,2,0,2]},{text:"¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:2.5,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};class e{static get minColorValue(){return 0}static get maxColorValue(){return 255}static get rowsNumber(){return 6}static get cellsNumber(){return 6}static get deltaColor(){return 51}static get sliderMaxValue(){return 100}static get sliderStep(){return 20}static get initialRed(){return 0}}class s{static get d0(){return 0}static get d90(){return 90}static get d180(){return 180}static get d270(){return 270}static get d360(){return 360}static get d540(){return 540}static get toRadians(){return Math.PI/180}static get fromRadians(){return 180/Math.PI}}class i{static get fixed(){return 2}static get invalid(){return-1}static get defaultValue(){return 0}static get metersInKm(){return 1e3}}class r{static get fixed(){return 2}static get defaultValue(){return 0}}class a{static get refusedByUser(){return-1}static get disabled(){return 0}static get inactive(){return 1}static get active(){return 2}}class o{static get width(){return 40}static get height(){return 40}static get svgViewboxDim(){return 200}}class n{static get atStart(){return-1}static get onRoute(){return 0}static get atEnd(){return 1}}class h{static get defaultValue(){return 0}static get fixed(){return 6}static get maxLat(){return 90}static get minLat(){return-90}static get maxLng(){return 180}static get minLng(){return-180}}class l{static get invalidPane(){return"43a6a53e-008a-4910-80a6-7a87d301ea15"}static get itineraryPane(){return"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7"}static get travelNotesPane(){return"dffe782b-07df-4b81-a318-f287c0cf5ec6"}static get searchPane(){return"228f00d7-43a8-4c13-897d-70400cb6dd58"}}class c{static get notEdited(){return 0}static get editedNoChange(){return 1}static get editedChanged(){return 2}}class u{static get notSaved(){return"üî¥"}static get modified(){return"üü°"}static get saved(){return"üü¢"}}const v=20,d=6371e3,p=16,_=200,m=-1,g=[.3,10,1],w=-1,N="http://www.w3.org/2000/svg",T=20;class f{static t=0;static get nextObjId(){return++f.t}}const y="2.3.0",b="v3.2.0-dev";class I{i="";o=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];h=[];constructor(t,e){if(w===this.o.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.i=t,this.h=e,Object.freeze(this.h)}get name(){return this.i}get version(){return y}get properties(){return this.h}get jsonObject(){return{name:this.i,version:y}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.i);if(this.i!==t.name)throw new Error("Invalid name for "+this.i);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.i)}}class M{l=null;u=w;constructor(t){this.l=t}get value(){return this.u<this.l.length?this.l.at(this.u):null}get previous(){return 0>=this.u?null:this.l.at(this.u-1)}get next(){return this.u<this.l.length-1?this.l.at(this.u+1):null}get done(){return++this.u>=this.l.length}get first(){return 0===this.u}get last(){return this.u>=this.l.length-1}get index(){return this.u}}class D{v;p;_;m(t){return this.v.findIndex((e=>e.objId===t))}g(t,e,s){let i=this.m(t);if(w===i)throw new Error("invalid objId for next or previous function");if(1!==s&&-1!==s)throw new Error("invalid direction");let r=e;for(r||(r=()=>!0),i+=s;w<i&&i<this.v.length&&!r(this.v[i]);)i+=s;return w===i||this.v.length===i?null:this.v[i]}constructor(t){this.v=[],this._=t;const e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.p=e.objType.name}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.p)throw new Error("invalid object name for add function");this.v.push(t)}at(t){return t<this.v.length&&t>w?this.v[t]:null}forEach(t){let e=null;const s=this.iterator;for(;!s.done;)e=t(s.value,e);return e}getAt(t){const e=this.m(t);return w===e?null:this.v[e]}moveTo(t,e,s){let i=this.m(t),r=this.m(e);if(w===i||w===r)throw new Error("invalid objId for function  myMoveTo");s||r++,this.v.splice(r,0,this.v[i]),r<i&&i++,this.v.splice(i,1)}next(t,e){return this.g(t,e,1)}previous(t,e){return this.g(t,e,-1)}remove(t){const e=this.m(t);if(w===e)throw new Error("invalid objId for remove function");this.v.splice(e,1)}removeAll(t){t?this.v.splice(1,this.v.length-2):this.v.length=0}replace(t,e){const s=this.m(t);if(w===s)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.p)throw new Error("invalid object name for replace function");this.v[s]=e}reverse(){this.v.reverse()}sort(t){this.v.sort(t)}swap(t,e){const s=this.m(t);if(w===s||0===s&&e||this.v.length-1===s&&!e)throw new Error("invalid objId for swap function");const i=e?-1:1,r=this.v[s];this.v[s]=this.v[s+i],this.v[s+i]=r}get first(){return this.v[0]}get iterator(){return new M(this)}get last(){return this.v[this.v.length-1]}get length(){return this.v.length}get jsonObject(){const t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.v.length=0,Array.isArray(t)&&t.forEach((t=>{const e=new this._;e.jsonObject=t,this.add(e)}))}}class E{N;T;constructor(t,e){this.N=t,this.T=e}get url(){return this.N}get errorsString(){return this.T}}class x{I;T;constructor(t,e){this.I=t,this.T=e}get htmlString(){return this.I}get errorsString(){return this.T}}class P{M=new Map;constructor(){this.M.set("a",["href","target"]),this.M.set("div",[]),this.M.set("del",[]),this.M.set("em",[]),this.M.set("figcaption",[]),this.M.set("figure",[]),this.M.set("h1",[]),this.M.set("h2",[]),this.M.set("h3",[]),this.M.set("h4",[]),this.M.set("h5",[]),this.M.set("h6",[]),this.M.set("hr",[]),this.M.set("img",["src","alt","width","height"]),this.M.set("ins",[]),this.M.set("li",[]),this.M.set("mark",[]),this.M.set("ol",[]),this.M.set("p",[]),this.M.set("s",[]),this.M.set("small",[]),this.M.set("strong",[]),this.M.set("span",[]),this.M.set("sub",[]),this.M.set("sup",[]),this.M.set("ul",[]),this.M.set("svg",["xmlns","viewBox","class"]),this.M.set("text",["x","y","text-anchor"]),this.M.set("polyline",["points","class","transform"]),this.M.set("#text",[])}getValidAttributesNames(t){return this.M.get(t).concat(["id","class","dir","title"])}getValidNodeName(t){const e=t.toLowerCase();return this.M.get(e)?e:""}}class C{D="";P="";static C=new P;L(t){return t.replaceAll(/\u003c/g,"&lt;").replaceAll(/\u003e/g,"&gt;").replaceAll(/\u0022/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}k(t,e){const s=this.sanitizeToUrl(t,e).url;""===s&&""!==t?this.P+="\nAn invalid url ("+t+") was removed from a "+e+" attribute":this.D+=" "+e+'="'+s+'"'}S(t,e){C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(this.D+=" "+e+'="'+this.L(t.getAttributeNS(null,e))+'"',t.removeAttributeNS(null,e))}))}A(t,e){t.hasAttribute("target")&&(this.D+=' rel="noopener noreferrer"'),C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttribute(e)&&("href"===e||"src"===e?this.k(t.getAttribute(e),e):this.D+=" "+e+'="'+this.L(t.getAttribute(e))+'"',t.removeAttribute(e))}))}R(t){for(let e=0;e<t.attributes.length;e++)"rel"!==t.attributes[e].name&&(this.P+="\nAn unsecure attribute "+t.attributes[e].name+'="'+t.attributes[e].value+'" was removed.')}O(t){const e=t.childNodes;for(let s=0;s<e.length;s++){const e=t.childNodes[s],i=C.C.getValidNodeName(e.nodeName);""===i?this.P+="\nAn invalid tag "+e.nodeName+" was removed":"#text"===i?this.D+=this.L(e.nodeValue):(this.D+="<"+i,"svg"===i||"text"===i||"polyline"===i?this.S(e,i):this.A(e,i),this.D+=">",this.O(e),this.D+="</"+i+">",e.attributes&&this.R(e))}}B(t,e){const s=document.createElementNS(N,e);return C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(s.setAttributeNS(null,e,t.getAttributeNS(null,e)),t.removeAttributeNS(null,e))})),s}j(t,e){const s=document.createElement(e);return C.C.getValidAttributesNames(e).forEach((e=>{if(t.hasAttribute(e))if("href"===e||"src"===e){const i=this.sanitizeToUrl(t.getAttribute(e),e).url;""!==i&&s.setAttribute(e,i)}else s.setAttribute(e,t.getAttribute(e))})),t.hasAttribute("target")&&s.setAttribute("rel","noopener noreferrer"),s}H(t,e){const s=t.childNodes;for(let i=0;i<s.length;i++){const s=t.childNodes[i],r=C.C.getValidNodeName(s.nodeName);if("#text"===r)e.appendChild(document.createTextNode(s.nodeValue));else if(""!==r){const t="svg"===r||"text"===r||"polyline"===r?this.B(s,r):this.j(s,r);e.appendChild(t),this.H(s,t)}}}constructor(){}sanitizeToHtmlElement(t,e){const s=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html"),i=new DocumentFragment;s&&"#document"===s.nodeName?(this.H(s.body.firstChild,i),e.appendChild(i)):e.textContent=""}clone(t){const e=document.createElement(t.tagName);return this.H(t,e),e}sanitizeToHtmlString(t){this.D="",this.P="";const e=(new DOMParser).parseFromString("<div>"+t.replace("&nbsp;","‡®Ä")+"</div>","text/html");return e&&"#document"===e.nodeName?(this.O(e.body.firstChild),new x(this.D,this.P)):new x("","Parsing error")}sanitizeToUrl(t,e){const s=e||"href",i=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!i||"#document"!==i.nodeName)return new E("","Parsing error");const r=i.body.firstChild;let a="";for(let t=0;t<r.childNodes.length;t++){if("#text"!==r.childNodes[t].nodeName)return new E("","Invalid characters found in the url");a+=r.childNodes[t].nodeValue}if(a=a.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),a!==t)return new E("","Invalid characters found in the url");const o=["https:"];if("http:"!==window.location.protocol&&"href"!==s||o.push("http:"),"href"===s){o.push("mailto:"),o.push("sms:"),o.push("tel:");const t=a.match(/^\u0023\w*/);if(t&&a===t[0])return new E(a,"")}"src"===s&&o.push("data:");let n=null;try{n=new URL(a)}catch(t){return new E("","Invalid url string")}if(w===o.indexOf(n.protocol))return new E("","Invalid protocol "+n.protocol);if(w!==["sms:","tel:"].indexOf(n.protocol))return n.pathname.match(/^\+[0-9,*,\u0023]*$/)?new E(a,""):new E("","Invalid sms: or tel: url");try{encodeURIComponent(n.href)}catch(t){return new E("","Invalid character in url")}return new E(a,"")}sanitizeToJsString(t){const e=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";const s=e.body.firstChild;let i="";for(let t=0;t<s.childNodes.length;t++){if("#text"!==s.childNodes[t].nodeName)return"";i+=s.childNodes[t].nodeValue}return i=i.replaceAll(/</g,"‚â∫").replaceAll(/>/g,"‚âª").replaceAll(/"/g,"‚Ä≥").replaceAll(/\u0027/g,"‚Ä≤"),i}sanitizeToColor(t){const e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}}const L=new C;const k=new class{U=new Map;constructor(){}setTranslations(t){t.forEach((t=>this.U.set(t.msgid,L.sanitizeToJsString(t.msgstr))))}getText(t,e){let s=this.U.get(t);return e&&s&&Object.getOwnPropertyNames(e).forEach((t=>s=s.replace("{"+t+"}",e[t]))),s||t}};const S=new class{constructor(){}get UUID(){const t=["","","","-","","-","","-","","-","","","","","",""],e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let s="";for(let i=0;i<16;i++)s+=e[i].toString(p).padStart(2,"0")+t[i];return s}storageAvailable(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch(t){return!1}}openFile(t,e){const s=document.createElement("input");s.type="file",e&&(s.accept=e),s.addEventListener("change",t,!1),s.click()}saveFile(t,e,s){try{const i=s?window.URL.createObjectURL(new File([e],t,{type:s})):URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.click(),window.URL.revokeObjectURL(i)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){const e=Math.floor(t);if(0===e)return"";const s=Math.floor(e/86400),i=Math.floor(e%86400/3600),r=Math.floor(e%3600/60),a=Math.floor(e%60);return 0<s?s+"¬†"+k.getText("Utilities - Day")+"¬†"+i+"¬†"+k.getText("Utilities - Hour"):0<i?i+"¬†"+k.getText("Utilities - Hour")+"¬†"+r+"¬†"+k.getText("Utilities - Minute"):0<r?r+"¬†"+k.getText("Utilities - Minute"):a+"¬†"+k.getText("Utilities - Second")}formatDistance(t){const e=Math.floor(t);return 0>=e?"0¬†km":Math.floor(e/i.metersInKm)+","+Math.floor(e%i.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+"¬†km"}formatLat(t){return t>0?t.toFixed(h.fixed)+"¬†N":(-t).toFixed(h.fixed)+"¬†S"}formatLng(t){return t>0?t.toFixed(h.fixed)+"¬†E":(-t).toFixed(h.fixed)+"¬†W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+"¬†-¬†"+this.formatLng(t[1])}};class A{F;K(){this.F.routes.forEach((t=>{t.dashArray=0,t.hidden=!1}))}W(){this.F.routes.forEach((t=>{t.edited=c.notEdited}))}V(){this.W(),this.F.editedRoute={name:"",wayPoints:[{name:"",lat:0,lng:0,objId:2,objType:{name:"WayPoint",version:"1.4.0"}},{name:"",lat:0,lng:0,objId:3,objType:{name:"WayPoint",version:"1.4.0"}}],notes:[],itinerary:{itineraryPoints:[],maneuvers:[],provider:"",transitMode:"",objId:1,objType:{name:"Itinerary",version:"1.4.0"}},width:3,color:"_private_ff0000",dashArray:0,chain:!0,distance:0,duration:0,edited:c.notEdited,hidden:!1,chainedDistance:0,objId:4,objType:{name:"Route",version:"1.4.0"}}}G(){if(this.F.userData.layerId){const t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantm√§teriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===this.F.userData.layerId));this.F.layerName=t?t.layerName:"OSM - Color"}else this.F.layerName="OSM - Color"}Z(t){t.forEach((t=>{t.elev=r.defaultValue}))}X(){this.F.routes.forEach((t=>{t.itinerary.hasProfile=!1,t.itinerary.ascent=0,t.itinerary.descent=0,this.Z(t.itinerary.itineraryPoints)})),this.F.editedRoute.itinerary.hasProfile=!1,this.F.editedRoute.itinerary.ascent=0,this.F.editedRoute.itinerary.descent=0,this.Z(this.F.editedRoute.itinerary.itineraryPoints)}J(t){t.itinerary.maneuvers.forEach((t=>{"kArriveDefault"===t.iconName&&(t.distance=i.defaultValue)}))}Y(t){t.wayPoints.forEach((t=>{t.address=t.name,t.name=""}))}q(){this.F.routes.forEach((t=>{t.editionStatus=t.edited,this.J(t),this.Y(t)})),this.F.editedRoute.editionStatus=this.F.editedRoute.edited,this.J(this.F.editedRoute),this.Y(this.F.editedRoute)}$(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}tt(t){"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.$(t.iconContent),t.popupContent=this.$(t.popupContent),t.tooltipContent=this.$(t.tooltipContent),t.phone=this.$(t.phone),t.address=this.$(t.address)}et(){this.F.notes.forEach((t=>{this.tt(t)})),this.jsonTravel.routes.forEach((t=>{t.notes.forEach((t=>{this.tt(t)}))}))}st(){switch(this.F.objType.version){case"1.0.0":this.K();case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":this.V();case"1.5.0":this.G();case"1.6.0":this.X();case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":this.q();case"1.12.0":case"1.13.0":this.et();case"2.0.0":case"2.1.0":case"2.2.0":this.F.objType.version="2.3.0";break;default:throw new Error("invalid version for travel")}}constructor(){}update(t){t.objType.version!==y&&(this.F=t,this.st())}}class R{constructor(){}validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+this.objType.name);this.objType.validate(t.objType),"Travel"===this.objType.name&&this.objType.version!==t.objType.version&&(new A).update(t);const e=Object.getOwnPropertyNames(t);return this.objType.properties.forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+this.objType.name)})),t}}class O extends R{static it=new I("WayPoint",["address","name","lat","lng","objId"]);rt="";ot="";nt=h.defaultValue;ht=h.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get name(){return this.rt}set name(t){this.rt="string"==typeof t?L.sanitizeToJsString(t):""}get address(){return this.ot}set address(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get lat(){return this.nt}set lat(t){this.nt="number"==typeof t?t:h.defaultValue}get lng(){return this.ht}set lng(t){this.ht="number"==typeof t?t:h.defaultValue}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=S.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.nt=t[0],this.ht=t[1]):(this.nt=h.defaultValue,this.ht=h.defaultValue)}get objId(){return this.t}get objType(){return O.it}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.address=e.address,this.name=e.name,this.lat=e.lat,this.lng=e.lng,this.t=f.nextObjId}}class B extends R{static it=new I("ItineraryPoint",["lat","lng","distance","elev","objId"]);nt=h.defaultValue;ht=h.defaultValue;lt=i.defaultValue;ct=r.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get lat(){return this.nt}set lat(t){this.nt="number"==typeof t?t:h.defaultValue}get lng(){return this.ht}set lng(t){this.ht="number"==typeof t?t:h.defaultValue}get distance(){return this.lt}set distance(t){this.lt="number"==typeof t?t:i.defaultValue}get elev(){return this.ct}set elev(t){this.ct="number"==typeof t?t:h.defaultValue}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.nt=t[0],this.ht=t[1]):(this.nt=h.defaultValue,this.ht=h.defaultValue)}get objType(){return B.it}get objId(){return this.t}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),elev:parseFloat(this.elev.toFixed(r.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.elev=e.elev,this.t=f.nextObjId}}class j extends R{static it=new I("Maneuver",["iconName","instruction","distance","duration","itineraryPointObjId","objId"]);ut="";vt="";dt=m;lt=i.defaultValue;_t=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconName(){return this.ut}set iconName(t){this.ut="string"==typeof t?L.sanitizeToJsString(t):""}get instruction(){return this.vt}set instruction(t){this.vt="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPointObjId(){return this.dt}set itineraryPointObjId(t){this.dt="number"==typeof t?t:m}get distance(){return this.lt}set distance(t){this.lt="number"==typeof t?t:i.defaultValue}get duration(){return this._t}set duration(t){this._t="number"==typeof t?t:i.defaultValue}get objType(){return j.it}get objId(){return this.t}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconName=e.iconName,this.instruction=e.instruction,this.distance=e.distance,this.duration=e.duration,this.itineraryPointObjId=e.itineraryPointObjId,this.t=f.nextObjId}}class H extends R{static it=new I("Itinerary",["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"]);t=m;gt=!1;wt=0;Nt=0;Tt="";ft="";yt=new D(B);bt=new D(j);constructor(){super(),this.t=f.nextObjId}get hasProfile(){return this.gt}set hasProfile(t){this.gt="boolean"==typeof t&&t}get ascent(){return this.wt}set ascent(t){this.wt="number"==typeof t?Number.parseInt(t):0}get descent(){return this.Nt}set descent(t){this.Nt="number"==typeof t?Number.parseInt(t):0}get provider(){return this.Tt}set provider(t){this.Tt="string"==typeof t?L.sanitizeToJsString(t):""}get transitMode(){return this.ft}set transitMode(t){this.ft="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPoints(){return this.yt}get maneuvers(){return this.bt}get objType(){return H.it}get objId(){return this.t}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.hasProfile=e.hasProfile,this.ascent=e.ascent,this.descent=e.descent,this.itineraryPoints.jsonObject=e.itineraryPoints,this.maneuvers.jsonObject=e.maneuvers,this.provider=e.provider,this.transitMode=e.transitMode,this.t=f.nextObjId;const s=new Map;let i=0;const r=this.itineraryPoints.iterator;for(;!r.done;)s.set(e.itineraryPoints[i].objId,r.value.objId),i++;const a=this.maneuvers.iterator;for(;!a.done;)a.value.itineraryPointObjId=s.get(a.value.itineraryPointObjId)}}class U extends R{static it=new I("Note",["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"]);It=o.height;Mt=o.width;Dt="";Et="";xt="";Pt="";N="";ot="";Ct=h.defaultValue;Lt=h.defaultValue;nt=h.defaultValue;ht=h.defaultValue;lt=i.invalid;kt=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconHeight(){return this.It}set iconHeight(t){this.It="number"==typeof t?t:o.height}get iconWidth(){return this.Mt}set iconWidth(t){this.Mt="number"==typeof t?t:o.width}get iconContent(){return this.Dt}set iconContent(t){this.Dt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get popupContent(){return this.Et}set popupContent(t){this.Et="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get tooltipContent(){return this.xt}set tooltipContent(t){this.xt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get phone(){return this.Pt}set phone(t){this.Pt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get url(){return this.N}set url(t){this.N="string"==typeof t?encodeURI(L.sanitizeToUrl(t).url):""}get address(){return this.ot}set address(t){this.ot="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get iconLat(){return this.Ct}set iconLat(t){this.Ct="number"==typeof t?t:h.defaultValue}get iconLng(){return this.Lt}set iconLng(t){this.Lt="number"==typeof t?t:h.defaultValue}get lat(){return this.nt}set lat(t){this.nt="number"==typeof t?t:h.defaultValue}get lng(){return this.ht}set lng(t){this.ht="number"==typeof t?t:h.defaultValue}get distance(){return this.lt}set distance(t){this.lt="number"==typeof t?t:i.invalid}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get isRouteNote(){return this.lt!==i.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.Ct=t[0],this.Lt=t[1]):(this.Ct=h.defaultValue,this.Lt=h.defaultValue)}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.nt=t[0],this.ht=t[1]):(this.nt=h.defaultValue,this.ht=h.defaultValue)}get objType(){return U.it}get objId(){return this.t}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(h.fixed)),iconLng:parseFloat(this.iconLng.toFixed(h.fixed)),lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconHeight=e.iconHeight,this.iconWidth=e.iconWidth,this.iconContent=e.iconContent,this.popupContent=e.popupContent,this.tooltipContent=e.tooltipContent,this.phone=e.phone,this.url=e.url,this.address=e.address,this.iconLat=e.iconLat,this.iconLng=e.iconLng,this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class F extends R{static it=new I("Route",["name","wayPoints","notes","itinerary","width","color","dashArray","chain","chainedDistance","distance","duration","editionStatus","hidden","objId"]);rt="";St=new D(O);At=new D(U);Rt=new H;Ot=t.route.width;Bt=t.route.color;jt=t.route.dashArray;Ht=!0;kt=i.defaultValue;lt=i.defaultValue;_t=i.defaultValue;Ut=c.notEdited;Ft=!1;t=m;constructor(){super(),this.St.add(new O),this.St.add(new O),this.t=f.nextObjId}get name(){return this.rt}set name(t){this.rt="string"==typeof t?L.sanitizeToJsString(t):""}get wayPoints(){return this.St}get notes(){return this.At}get itinerary(){return this.Rt}get width(){return this.Ot}set width(e){this.Ot="number"==typeof e?e:t.route.width}get color(){return this.Bt}set color(e){this.Bt="string"==typeof e&&L.sanitizeToColor(e)||t.route.color}get dashArray(){return this.jt}set dashArray(e){this.jt="number"==typeof e&&t.route.dashChoices[e]?e:0}get chain(){return this.Ht}set chain(t){this.Ht="boolean"==typeof t&&t}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get distance(){return this.lt}set distance(t){this.lt="number"==typeof t?t:i.defaultValue}get duration(){return this._t}set duration(t){this._t="number"==typeof t?t:i.defaultValue}get editionStatus(){return this.Ut}set editionStatus(t){this.Ut="number"==typeof t?t:c.notEdited}get hidden(){return this.Ft}set hidden(t){this.Ft="boolean"==typeof t&&t}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ‚Æû "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.t}get objType(){return F.it}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&h.defaultValue!==e.lat&&h.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashArray:this.dashArray,chain:this.chain,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.name=e.name,this.wayPoints.jsonObject=e.wayPoints,this.notes.jsonObject=e.notes,this.itinerary.jsonObject=e.itinerary,this.width=e.width,this.color=e.color,this.dashArray=e.dashArray,this.chain=e.chain,this.distance=e.distance,this.duration=e.duration,this.editionStatus=e.editionStatus,this.hidden=e.hidden,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class K extends R{static it=new I("Travel",["editedRoute","routes","notes","layerName","name","readOnly","objId"]);Kt=new F;Wt=new D(F);At=new D(U);Vt="OSM - Color";rt="";zt=!1;t=m;constructor(){super(),this.Wt.add(new F),this.t=f.nextObjId}get editedRoute(){return this.Kt}set editedRoute(t){this.Kt="Route"===t?.objType?.name?t:new F}get routes(){return this.Wt}get notes(){return this.At}get layerName(){return this.Vt}set layerName(t){this.Vt="string"==typeof t?L.sanitizeToJsString(t):"OSM - Color"}get name(){return this.rt}set name(t){this.rt="string"==typeof t?L.sanitizeToJsString(t):""}get readOnly(){return this.zt}set readOnly(t){this.zt="boolean"!=typeof t||t}get objId(){return this.t}get objType(){return K.it}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName,this.name=e.name,this.readOnly=e.readOnly,this.routes.jsonObject=e.routes,this.notes.jsonObject=e.notes,this.t=f.nextObjId}}class W{Tt="";ft="";constructor(){}get provider(){return this.Tt}set provider(t){this.Tt="string"==typeof t?t:""}get transitMode(){return this.ft}set transitMode(t){this.ft="string"==typeof t?t:""}}const V=new class{Gt;Zt;Xt;Jt;Yt;qt;$t;Qt;constructor(){this.Gt=new Map,this.Zt=new Map,this.Xt=new W,this.Jt=S.UUID,this.Yt=null,this.qt=new K,this.$t=m,this.Qt=[]}get map(){return this.Yt}set map(t){this.Yt||(this.Yt=t)}get travel(){return this.qt}get editedRouteObjId(){return this.$t}set editedRouteObjId(t){this.$t="number"==typeof t?t:m}get searchData(){return this.Qt}get providers(){return this.Gt}get mapObjects(){return this.Zt}get routing(){return this.Xt}get UUID(){return this.Jt}};class z{nt;ht;constructor(t,e){this.nt=t,this.ht=e}static clone(t){return new z(t.lat,t.lng)}get latLng(){return[this.nt,this.ht]}get lat(){return this.nt}get lng(){return this.ht}}class G extends z{lt;constructor(t,e,s){super(t,e),this.lt=s}get distance(){return this.lt}}class Z extends G{ct;wt;constructor(t,e,s,i,r){super(t,e,s),this.ct=i,this.wt=r}get elev(){return this.ct}get ascent(){return this.wt}}class X{te;ee;constructor(t,e){this.te="string"==typeof t?t:"",this.ee="string"==typeof e?e:""}get providerName(){return this.te}get providerKey(){return this.ee}}class J{static get se(){return 100}constructor(){}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let s=0;const i=t.itinerary.itineraryPoints.iterator;for(;s<e&&!i.done;)s+=i.value.distance;const r=i.value;i.done;const a=(r.distance-s+e)/r.distance;return new Z(r.lat+(i.value.lat-r.lat)*a,r.lng+(i.value.lng-r.lng)*a,e,r.elev+(i.value.elev-r.elev)*a,J.se*(i.value.elev-r.elev)/r.distance)}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;const s=t.itinerary.itineraryPoints.iterator;s.done;let r=Number.MAX_VALUE;const a=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1]));let o=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng)),n=null,h=i.defaultValue,l=s.value.distance;for(;!s.done;){const t=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng));let e=window.L.LineUtil.pointToSegmentDistance(a,o,t);e<r&&(r=e,n=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(a,o,t)),h=l-n.distanceTo(window.L.latLng(s.value.lat,s.value.lng))),l+=s.value.distance,o=t}return new G(n.lat,n.lng,h)}getLatLngBounds(t){const e=window.L.latLng([h.maxLat,h.maxLng]),s=window.L.latLng([h.minLat,h.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),s.lat=Math.max(s.lat,t[0]),s.lng=Math.max(s.lng,t[1])})),window.L.latLngBounds(e,s)}getSquareBoundingBox(t,e){const i=t[0]*s.toRadians,r=e/d*s.fromRadians,a=Math.acos((Math.cos(e/d)-Math.sin(i)**2)/Math.cos(i)**2)*s.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-r,t[1]-a]),window.L.latLng([t[0]+r,t[1]+a]))}project(t,e){const s=V.map.project(window.L.latLng(t),e);return[s.x,s.y]}screenCoordToLatLng(t,e){const s=V.map.containerPointToLatLng(window.L.point(t,e));return[s.lat,s.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}}const Y=new J;const q=new class{ie(t){return(t+s.d540)%s.d360-s.d180}constructor(){}arcFromSummitArcArc(t,e,s){return Math.acos(Math.cos(e)*Math.cos(s)+Math.sin(e)*Math.sin(s)*Math.cos(t))}summitFromArcArcArc(t,e,s){return Math.acos((Math.cos(s)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,e){if(t[0]===e[0]&&t[1]===e[1])return 0;const i=t[0]*s.toRadians,r=e[0]*s.toRadians,a=(this.ie(e[1])-this.ie(t[1]))*s.toRadians;return Math.acos(Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos(a))*d}};class ${re;ae;constructor(t,e){this.re=t,this.ae=e}get note(){return this.re}get route(){return this.ae}}class Q{constructor(){}distance=Number.MAX_VALUE;route=null;distanceOnRoute=0;latLngOnRoute=[h.defaultValue,h.defaultValue]}const tt=new class{oe(t,e,s){if(t.objId!==V.editedRouteObjId){const i=Y.getClosestLatLngDistance(t,e);if(i){const r=q.pointsDistance(e,i.latLng);r<s.distance&&(s.route=t,s.distance=r,s.latLngOnRoute=i.latLng,s.distanceOnRoute=i.distance)}}}constructor(){}getNearestRouteData(t){const e=new Q;return V.travel.routes.forEach((s=>this.oe(s,t,e))),m!==V.editedRouteObjId&&this.oe(V.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=V.travel.routes.getAt(t),e||t===V.travel.editedRoute.objId&&(e=V.travel.editedRoute),e}getNoteAndRoute(t){let e=null,s=null;if(e=V.travel.notes.getAt(t),!e){const i=V.travel.routes.iterator;for(;!i.done&&!e;)e=i.value.notes.getAt(t),e&&(s=i.value);e||(e=V.travel.editedRoute.notes.getAt(t),e&&(s=V.travel.editedRoute))}return new $(e,s)}getWayPoint(t){let e=V.travel.editedRoute.wayPoints.getAt(t);if(!e){const s=V.travel.routes.iterator;for(;!s.done&&!e;)e=s.value.wayPoints.getAt(t)}return e}};const et=new class{ne(t,e){for(const s in e)try{if("dataset"===s){const s=e.dataset;for(const e in s)t.dataset["tan"+e]=s[e]}else t[s]=e[s]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){}create(t,e,s){let i=null;return"text"===t.toLowerCase()?i=document.createTextNode(e.value||""):(i="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.ne(i,e)),s&&s.appendChild(i),i}};class st{he;constructor(t){this.he=t}handleEvent(){this.he.onOk()}}class it{he;constructor(t){this.he=t}handleEvent(){this.he.onCancel()}}class rt{le;constructor(t){this.le=t}handleEvent(t){this.le.dragStartX=t.screenX,this.le.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class at{le;ce;ue;constructor(t,e,s){this.le=t,this.ce=e,this.ue=s}handleEvent(t){this.le.dialogX+=t.screenX-this.le.dragStartX,this.le.dialogX=Math.min(Math.max(this.le.dialogX,v),this.ue.clientWidth-this.ce.clientWidth-v),this.le.dialogY+=t.screenY-this.le.dragStartY,this.le.dialogY=Math.max(this.le.dialogY,v);const e=this.ue.clientHeight-Math.max(this.le.dialogY,0)-v;this.ce.style.left=String(this.le.dialogX)+"px",this.ce.style.top=String(this.le.dialogY)+"px",this.ce.style["max-height"]=String(e)+"px"}}class ot{he;constructor(t){this.he=t}handleEvent(t){this.he.keyboardELEnabled&&("Escape"===t.key||"Esc"===t.key?this.he.onCancel():"Enter"===t.key&&this.he.onOk())}}class nt{ve;constructor(){}handleEvent(t){if("start"===t.action)return void(this.ve=V.map.getCenter());const e=Y.screenCoordToLatLng(t.startX,t.startY),s=Y.screenCoordToLatLng(t.endX,t.endY);V.map.panTo([this.ve.lat+e[0]-s[0],this.ve.lng+e[1]-s[1]])}}class ht{static get de(){return 25}pe;_e;constructor(){this.pe=0}handleEvent(t){if("start"===t.action)return this.pe=V.map.getZoom(),void(this._e=window.L.point(t.clientX,t.clientY));let e=Math.floor(this.pe+(t.startY-t.endY)/ht.de);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(this._e,e)}}class lt{constructor(){}handleEvent(t){if(!t.target.classList.contains("TravelNotes-Background"))return;let e=V.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class ct{constructor(){}handleEvent(t){t.preventDefault()}}class ut{constructor(){}handleEvent(t){t.preventDefault()}}class vt{me=!1;ge=0;we=0;Ne=null;Te=0;fe="";ye(t,e){const s=new Event(this.fe);s.startX=this.ge,s.startY=this.we,s.endX=t.screenX,s.endY=t.screenY,s.clientX=t.clientX,s.clientY=t.clientY,s.action=e,this.Ne.dispatchEvent(s)}constructor(t,e){switch(this.Ne=t,this.Te=e,e){case 0:this.fe="leftpan";break;case 1:this.fe="middlepan";break;case 2:this.fe="rightpan";break;default:this.Te=w}}handleEvent(t){switch(t.type){case"mousedown":t.button===this.Te&&t.target===this.Ne&&(this.ge=t.screenX,this.we=t.screenY,this.me=!0,this.ye(t,"start"));break;case"mouseup":t.button!==this.Te||!this.me||this.ge===t.screenX&&this.we===t.screenY||this.ye(t,"end"),this.me=!1;break;case"mousemove":this.me&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.ye(t,"move"))}}}class dt{Ne;be;static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}constructor(t,e){this.Ne=t,this.be=new vt(t,e??0),this.Ne.addEventListener("mousedown",this.be),this.Ne.addEventListener("mouseup",this.be),this.Ne.addEventListener("mousemove",this.be)}detach(){this.Ne.removeEventListener("mousedown",this.be),this.Ne.removeEventListener("mouseup",this.be),this.Ne.removeEventListener("mousemove",this.be),this.be=null,this.Ne=null}}class pt{constructor(){}dragStartX=0;dragStartY=0;dialogX=0;dialogY=0}class _t{Ie=null;Me=null;De=null;Ee=null;xe=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.Ie=t.firstButtonText;break;case"secondButtonText":this.Me=t.secondButtonText;break;case"selectOptionsData":this.De=t.selectOptionsData;break;case"title":this.Ee=t.title;break;case"text":this.xe=t.text}}get firstButtonText(){return this.Ie}get secondButtonText(){return this.Me}get selectOptionsData(){return this.De}get title(){return this.Ee}get text(){return this.xe}}class mt{Pe;Ce;Le;ke;Se;Ae;Re;Oe;Be;je;He;le;Ue;Fe;Ke;We;Ve;ze;Ge;Ze;Xe;Je;Ye=null;qe;$e;Qe(){this.Pe=et.create("div",{className:"TravelNotes-Background"}),this.Be=new dt(this.Pe,dt.LEFT_BUTTON),this.je=new dt(this.Pe,dt.RIGHT_BUTTON),this.Ue=new nt,this.Pe.addEventListener("leftpan",this.Ue,!1),this.Fe=new ht,this.Pe.addEventListener("rightpan",this.Fe,!1),this.Ke=new ut,this.Pe.addEventListener("dragover",this.Ke,!1),this.We=new lt,this.Pe.addEventListener("wheel",this.We,{passive:!0}),this.Ve=new ct,this.Pe.addEventListener("contextmenu",this.Ve,!1)}ts(){this.Ce=et.create("div",{className:"TravelNotes-BaseDialog-Container"},this.Pe)}es(){this.Re=et.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this.Ce),this.ze=new rt(this.le),this.Re.addEventListener("dragstart",this.ze,!1),this.Ge=new at(this.le,this.Ce,this.Pe),this.Re.addEventListener("dragend",this.Ge,!1),this.Ae=et.create("div",{textContent:"‚ùå",className:"TravelNotes-BaseDialog-CancelButton",title:k.getText("BaseDialog - Cancel")},this.Re),this.Ze=new it(this),this.Ae.addEventListener("click",this.Ze,!1)}ss(){et.create("text",{value:this.title},et.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this.Ce))}rs(){const t=et.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this.Ce);this.contentHTMLElements.forEach((e=>t.appendChild(e)))}os(){this.Le=et.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this.Ce)}ns(){et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},this.ke=et.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this.Ce)))}hs(){const t=et.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this.Ce);this.Se=et.create("div",{textContent:this.Ye.firstButtonText||"üÜó",className:"TravelNotes-BaseDialog-Button"},t),this.Xe=new st(this),this.Se.addEventListener("click",this.Xe,!1),this.Ye.secondButtonText?(this.Oe=et.create("div",{textContent:this.Ye.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.Oe.addEventListener("click",this.Ze,!1)):this.Oe=null,this.footerHTMLElements.forEach((e=>t.appendChild(e)))}ls(){this.Qe(),this.ts(),this.es(),this.ss(),this.rs(),this.os(),this.ns(),this.hs()}cs(){this.le.dialogX=(this.Pe.clientWidth-this.Ce.clientWidth)/2,this.le.dialogY=(this.Pe.clientHeight-this.Ce.clientHeight)/2,this.le.dialogX=Math.min(Math.max(this.le.dialogX,v),this.Pe.clientWidth-this.Ce.clientWidth-v),this.le.dialogY=Math.max(this.le.dialogY,v);const t=this.Pe.clientHeight-Math.max(this.le.dialogY,0)-v;this.Ce.style.left=String(this.le.dialogX)+"px",this.Ce.style.top=String(this.le.dialogY)+"px",this.Ce.style["max-height"]=String(t)+"px"}us(t,e){this.qe=t,this.$e=e,this.ls(),document.body.appendChild(this.Pe),this.cs(),this.Je=new ot(this),document.addEventListener("keydown",this.Je,{capture:!0}),this.onShow()}constructor(t){this.le=new pt,this.Ye=new _t(t),this.He=!0}vs(){document.removeEventListener("keydown",this.Je,{capture:!0}),this.Je=null,this.Re.removeEventListener("dragstart",this.ze,!1),this.ze=null,this.Re.removeEventListener("dragend",this.Ge,!1),this.Ge=null,this.Ae.removeEventListener("click",this.Ze,!1),this.Ye.secondButtonText&&this.Oe.removeEventListener("click",this.Ze,!1),this.Ze=null,this.Se.removeEventListener("click",this.Xe,!1),this.Xe=null,this.Pe.removeEventListener("leftpan",this.Ue,!1),this.Ue=null,this.Pe.removeEventListener("rightpan",this.Fe,!1),this.Fe=null,this.Pe.removeEventListener("wheel",this.We,{passive:!0}),this.We=null,this.Pe.removeEventListener("contextmenu",this.Ve,!1),this.Ve=null,this.Pe.removeEventListener("dragover",this.Ke,!1),this.Ke=null,this.Be.detach(),this.je.detach(),document.body.removeChild(this.Pe)}onCancel(){this.vs(),this.$e("Canceled by user")}canClose(){return!0}onOk(t){return!!this.canClose()&&(this.vs(),this.qe(t),!0)}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((t,e)=>this.us(t,e)))}showWait(){this.ke.classList.remove("TravelNotes-Hidden"),this.Se.classList.add("TravelNotes-Hidden")}hideWait(){this.ke.classList.add("TravelNotes-Hidden"),this.Se.classList.remove("TravelNotes-Hidden")}showError(t){this.Le.textContent="",L.sanitizeToHtmlElement(t,this.Le),this.Le.classList.remove("TravelNotes-Hidden")}hideError(){this.Le.textContent="",this.Le.classList.add("TravelNotes-Hidden")}get keyboardELEnabled(){return this.He}set keyboardELEnabled(t){this.He=t}get options(){return this.Ye}}class gt{ds=null;constructor(t){this.ds=t}handleEvent(t){t.currentTarget.textContent="üëÄ",t.stopPropagation,this.ds.type="text"}}class wt{ds;constructor(t){this.ds=t}handleEvent(t){t.currentTarget.textContent="üëÅÔ∏è",t.stopPropagation,this.ds.type="password",this.ds.focus()}}class Nt extends mt{ps;ds;_s;gs;ws;Ns;static get Ts(){return 12}constructor(t){super(),this.gs=t,this.ps=et.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this.ds=et.create("input",{type:"password"},this.ps),this._s=et.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"üëÅÔ∏è"},this.ps),this.ws=new gt(this.ds),this.Ns=new wt(this.ds),this._s.addEventListener("mousedown",this.ws,!1),this._s.addEventListener("mouseup",this.Ns,!1)}fs(){this._s.removeEventListener("mousedown",this.ws,!1),this._s.removeEventListener("mouseup",this.Ns,!1),this.ws=null,this.Ns=null}canClose(){return this.hideError(),!(this.gs&&(this.ds.value.length<Nt.Ts||!this.ds.value.match(/[0-9]+/)||!this.ds.value.match(/[a-z]+/)||!this.ds.value.match(/[A-Z]+/)||!this.ds.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+k.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+k.getText("PasswordDialog - Password rules2")+"</li><li>"+k.getText("PasswordDialog - Password rules3")+"</li><li>"+k.getText("PasswordDialog - Password rules4")+"</li><li>"+k.getText("PasswordDialog - Password rules5")+"</li><li>"+k.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.ds.focus(),!1)}onCancel(){this.fs(),super.onCancel()}onOk(){this.fs(),super.onOk((new window.TextEncoder).encode(this.ds.value))}onShow(){this.ds.focus()}get contentHTMLElements(){return[this.ps]}get title(){return k.getText("PasswordDialog - password")}}class Tt{ys;bs(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}Is(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}Ms(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}Ds(t,e,s){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,s)}constructor(t){this.ys=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."}encryptData(t,e,s,i){let r=window.crypto.getRandomValues(new Uint8Array(16));i.then((t=>this.bs(t))).then((t=>this.Is(t,this.ys))).then((e=>this.Ds(e,r,t))).then((t=>{e(new Blob([r,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(s)}decryptData(t,e,s,i){i.then((t=>this.bs(t))).then((t=>this.Is(t,this.ys))).then((e=>this.Ms(e,t))).then(e).catch(s)}}class ft{constructor(){}handleEvent(t){t.stopPropagation();const e=new Event("apikeydeleted");e.data={objId:Number.parseInt(t.target.dataset.tanObjId)},t.target.parentNode.parentNode.dispatchEvent(e)}}class yt{Es;xs;Ps;t;constructor(e){this.t=f.nextObjId,this.Es=et.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this.xs=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:k.getText("APIKeysDialog - provider name")},this.Es),this.Ps=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:k.getText("APIKeysDialog - API key"),type:t.APIKeysDialog.showAPIKeys?"text":"password"},this.Es),et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:k.getText("APIKeysDialog - delete API key"),textContent:"‚ùå",dataset:{ObjId:this.t}},this.Es).addEventListener("click",new ft,!1)}get objId(){return this.t}get HTMLElements(){return[this.Es]}get providerName(){return this.xs.value}get providerKey(){return this.Ps.value}get apiKey(){return new X(this.xs.value,this.Ps.value)}}class bt{Cs;constructor(t){this.Cs=t}onErrorDecrypt(t){this.Cs.hideWait(),this.Cs.keyboardELEnabled=!0,t&&"Canceled by user"!==t&&this.Cs.showError(k.getText("APIKeysDialog - An error occurs when reading the file"))}onOkDecrypt(t){try{this.Cs.addAPIKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.Cs.hideWait(),this.Cs.hideError(),this.Cs.keyboardELEnabled=!0}onOkEncrypt(t){this.Cs.hideError(),this.Cs.hideWait(),S.saveFile("APIKeys",t),this.Cs.keyboardELEnabled=!0}onErrorEncrypt(){this.Cs.showError(k.getText("APIKeysDialog - An error occurs when saving the keys")),this.Cs.hideWait(),this.Cs.keyboardELEnabled=!0}}class It{Ls;constructor(t){this.Ls=t}getAPIKeysJsonString(){const t=[];return this.Ls.forEach((e=>{t.push({providerName:e.providerName,providerKey:e.providerKey})})),JSON.stringify(t)}}class Mt{Cs;Ls;constructor(t,e){this.Cs=t,this.Ls=e}handleEvent(t){t.stopPropagation(),this.Ls.delete(t.data.objId),this.Cs.refreshAPIKeys()}}class Dt{Cs;constructor(t){this.Cs=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{this.Cs.addAPIKeys(JSON.parse(e.result))}catch(t){this.Cs.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Et{Cs;constructor(t){this.Cs=t}handleEvent(t){t.stopPropagation(),this.Cs.hideError(),S.openFile(new Dt(this.Cs),".json")}}class xt{Cs;constructor(t){this.Cs=t}handleEvent(t){t.stopPropagation(),this.Cs.hideError(),this.Cs.showWait(),this.Cs.keyboardELEnabled=!1,fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{_===t.status&&t.ok?t.arrayBuffer().then((t=>{const e=new bt(this.Cs);(new Tt).decryptData(t,(t=>{e.onOkDecrypt(t)}),(t=>{e.onErrorDecrypt(t)}),new Nt(!1).show())})):new bt(this.Cs).onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{new bt(this.Cs).onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class Pt{Cs;constructor(t){this.Cs=t}handleEvent(t){t.stopPropagation(),this.Cs.showWait(),this.Cs.keyboardELEnabled=!1;const e=new FileReader;e.onload=()=>{const t=new bt(this.Cs);(new Tt).decryptData(e.result,(e=>{t.onOkDecrypt(e)}),(e=>{t.onErrorDecrypt(e)}),new Nt(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class Ct{Cs;constructor(t){this.Cs=t}handleEvent(t){t.stopPropagation(),this.Cs.hideError(),S.openFile(new Pt(this.Cs))}}class Lt{Cs;Ls;constructor(t,e){this.Cs=t,this.Ls=e}handleEvent(t){if(t.stopPropagation(),!this.Cs.validateAPIKeys())return;this.Cs.showWait(),this.Cs.keyboardELEnabled=!1;const e=new bt(this.Cs);(new Tt).encryptData((new window.TextEncoder).encode(new It(this.Ls).getAPIKeysJsonString()),(t=>e.onOkEncrypt(t)),(()=>e.onErrorEncrypt()),new Nt(!0).show())}}class kt{Cs;Ls;constructor(t,e){this.Cs=t,this.Ls=e}handleEvent(t){t.stopPropagation(),this.Cs.validateAPIKeys()&&S.saveFile("APIKeys.json",new It(this.Ls).getAPIKeysJsonString(),"application/json")}}class St{Cs;Ls;constructor(t,e){this.Cs=t,this.Ls=e}handleEvent(t){t.stopPropagation();const e=new X,s=new yt(e);this.Ls.set(s.objId,s),this.Cs.refreshAPIKeys()}}class At{Cs;Ls;ks;Es;Ss;As;Rs;Os;Bs;js;Hs;Us;Fs;Ks;Ws;Vs;zs(){this.Ss=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("APIKeysDialog - Reload from server"),textContent:"üîÑ"},this.Es),this.Hs=new xt(this.Cs),this.Ss.addEventListener("click",this.Hs,!1)}Gs(){this.As=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("APIKeysDialog - Save to file"),textContent:"üíæ"},this.Es),this.Us=new Lt(this.Cs,this.Ls),this.As.addEventListener("click",this.Us,!1)}Zs(){this.Rs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("APIKeysDialog - Open file"),textContent:"üìÇ"},this.Es),this.Fs=new Ct(this.Cs),this.Rs.addEventListener("click",this.Fs,!1)}Xs(){this.Os=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("APIKeysDialog - new API key"),textContent:"+"},this.Es),this.Ks=new St(this.Cs,this.Ls),this.Os.addEventListener("click",this.Ks,!1)}Js(){this.Bs=et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:k.getText("APIKeysDialog - Save to json file"),textContent:"üíæ"},this.Es),this.Ws=new kt(this.Cs,this.Ls),this.Bs.addEventListener("click",this.Ws,!1)}Ys(){this.js=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("APIKeysDialog - Open json file"),textContent:"üìÇ"},this.Es),this.Vs=new Et(this.Cs),this.js.addEventListener("click",this.Vs,!1)}qs(){window?.crypto?.subtle?.importKey&&window.isSecureContext&&(this.ks&&this.zs(),this.Gs(),this.Zs()),this.Xs(),t.APIKeysDialog.haveUnsecureButtons&&(this.Js(),this.Ys())}constructor(t,e,s){this.Cs=t,this.Ls=e,this.ks=s,this.Es=et.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this.qs()}destructor(){this.Ss&&this.Ss.removeEventListener("click",this.Hs,!1),this.Hs=null,this.As&&this.As.removeEventListener("click",this.Us,!1),this.Us=null,this.Rs&&this.Rs.removeEventListener("click",this.Fs,!1),this.Fs=null,this.Os&&this.Os.removeEventListener("click",this.Ks,!1),this.Ks=null,this.Bs&&this.Bs.removeEventListener("click",this.Ws,!1),this.Ws=null,this.js&&this.js.removeEventListener("click",this.Vs,!1),this.Vs=null}get rootHTMLElement(){return this.Es}}const Rt=new class{$s;Qs;ti;ei;si;ii;ri(){this.ti&&(clearTimeout(this.ti),this.ti=null),this.$s.classList.remove("TravelNotes-ErrorsUI-"+this.ii),this.$s.classList.add("TravelNotes-Hidden"),this.si.classList.add("TravelNotes-Hidden"),this.Qs.textContent=""}us(e,s){if(this.ii=s,!t.errorsUI["show"+this.ii]||"Help"===s&&this.ei.checked)return;this.ti&&(clearTimeout(this.ti),this.ti=null),this.Qs.textContent="",L.sanitizeToHtmlElement(e,this.Qs),this.$s.classList.add("TravelNotes-ErrorsUI-"+this.ii),this.$s.classList.remove("TravelNotes-Hidden");let i=t.errorsUI.timeOut;"Help"===this.ii&&(this.si.classList.remove("TravelNotes-Hidden"),i=t.errorsUI.helpTimeOut),this.ti=setTimeout((()=>this.ri()),i)}constructor(){}createUI(){if(this.$s)return;this.$s=et.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);const e=et.create("div",null,this.$s);et.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"‚ùå"},e).addEventListener("click",(()=>this.ri()),!1),this.Qs=et.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.$s),this.si=et.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.$s),this.ei=et.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox",checked:!t.errorsUI.showHelp},this.si),et.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:"Don't show help again"},this.si)}showError(t){this.us(t,"Error")}showWarning(t){this.us(t,"Warning")}showInfo(t){this.us(t,"Info")}showHelp(t){this.us(t,"Help")}};class Ot extends mt{ai;oi;ni;hi;li(){this.ni=et.create("div"),this.hi=new Mt(this,this.ai),this.ni.addEventListener("apikeydeleted",this.hi,!1)}constructor(t,e){super(),this.ai=new Map,this.oi=new At(this,this.ai,e),this.li(),this.addAPIKeys(t)}fs(){this.oi.destructor(),this.oi=null,this.ni.removeEventListener("apikeydeleted",this.hi,!1),this.hi=null}validateAPIKeys(){this.hideError();let t=!1;const e=[];this.ai.forEach((s=>{t=t||""===s.providerName||""===s.providerKey,e.push(s.providerName)}));let s=!1;return e.forEach((t=>{s=s||e.indexOf(t)!==e.lastIndexOf(t)})),t?(this.showError(k.getText("APIKeysDialog - empty API key name or value")),!1):!s||(this.showError(k.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(t){this.ai.clear(),t.forEach((t=>{const e=new yt(t);this.ai.set(e.objId,e)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this.ni.firstChild;)this.ni.removeChild(this.ni.firstChild);this.ai.forEach((t=>{this.ni.appendChild(t.HTMLElements[0])}))}onShow(){Rt.showHelp("<p>"+k.getText("Help - Complete the APIKeys1")+"</p><p>"+k.getText("Help - Complete the APIKeys2")+"</p><p>"+k.getText("Help - Complete the APIKeys3")+"</p>")}canClose(){return this.validateAPIKeys()}onCancel(){this.fs(),super.onCancel()}onOk(){const t=[];this.ai.forEach((e=>t.push(e.apiKey))),super.onOk(t)&&this.fs()}get title(){return k.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this.oi.rootHTMLElement,this.ni]}}const Bt=new class{constructor(){}dispatch(t,e){const s=new Event(t);e&&(s.data=e),document.dispatchEvent(s)}};const jt=new class{ks=!1;ci=new Map;ui(t){this.vi(JSON.parse((new TextDecoder).decode(t)))}di(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&Rt.showError(k.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}pi(t){window.isSecureContext&&window?.crypto?.subtle?.importKey&&(new Tt).decryptData(t,(t=>this.ui(t)),(t=>this.di(t)),new Nt(!1).show())}_i(t){return this.ci.get(t.toLowerCase())}mi(t,e){this.ci.set(t.toLowerCase(),e)}gi(){let t=0;for(let e=0;e<sessionStorage.length;e++){const s=sessionStorage.key(e);s.match(/^\w*ProviderKey$/)&&(this.mi(s.replace("ProviderKey",""),atob(sessionStorage.getItem(s))),t++)}return V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this._i(t.name)||"")})),t}vi(e){sessionStorage.clear(),this.ci.clear();const s=S.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage;e.forEach((t=>{s&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.mi(t.providerName,t.providerKey)})),V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this._i(t.name)||"")})),Bt.dispatch("providersadded")}constructor(){}hasKey(t){return this.ci.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){const e=this.ci.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.gi()&&(Bt.dispatch("providersadded"),t=!0),fetch(window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{_===e.status&&e.ok&&(this.ks=!0,t||e.arrayBuffer().then((t=>this.pi(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){const t=[];this.ci.forEach(((e,s)=>{t.push(new X(s,e))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new Ot(t,this.ks).show().then((t=>this.vi(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){const e=new t,s=e.name.toLowerCase();let i=this._i(s);e.providerKeyNeeded&&!i&&S.storageAvailable("sessionStorage")&&(i=sessionStorage.getItem(s),i&&(i=atob(i))),e.providerKeyNeeded&&i&&(e.providerKey=i),V.providers.set(e.name.toLowerCase(),e)}};class Ht{ae;wi;Ni;Ti;fi;yi;bi;static get PROFILE_MARGIN(){return 100}static get PROFILE_HEIGHT(){return 500}static get PROFILE_WIDTH(){return 1e3}static get X_DELTA_TEXT(){return 10}static get Y_DELTA_TEXT(){return 30}static get Ii(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}static get Mi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3]}static get Di(){return 8}static get Ei(){return 4}static get xi(){return Ht.PROFILE_MARGIN.toFixed(0)}static get Pi(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH).toFixed(0)}static get Ci(){return Ht.PROFILE_MARGIN.toFixed(0)}static get Li(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT).toFixed(0)}static get ki(){return(Ht.PROFILE_MARGIN-Ht.X_DELTA_TEXT).toFixed(0)}static get Si(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH+Ht.X_DELTA_TEXT).toFixed(0)}static get Ai(){return Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT+Ht.PROFILE_MARGIN/2}Ri(){let t="",e=0,s=0,i=0;this.ae.itinerary.itineraryPoints.forEach((r=>{s=(Ht.PROFILE_MARGIN+this.Ti*e).toFixed(0),i=(Ht.PROFILE_MARGIN+this.Ni*(this.yi-r.elev)).toFixed(0),t+=s+","+i+" ",e+=r.distance}));const r=document.createElementNS(N,"polyline");r.setAttributeNS(null,"points",t),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.wi.appendChild(r)}Oi(){const t=Ht.xi+","+Ht.Ci+" "+Ht.xi+","+Ht.Li+" "+Ht.Pi+","+Ht.Li+" "+Ht.Pi+","+Ht.Ci,e=document.createElementNS(N,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.wi.appendChild(e)}Bi(){let t=Number.MAX_VALUE,e=0;Ht.Ii.forEach((s=>{const i=Math.abs(this.ae.distance/Ht.Di-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.ae.chainedDistance/e)*e;for(;s<this.ae.distance+this.ae.chainedDistance;){const t=document.createElementNS(N,"text");t.appendChild(document.createTextNode(i.metersInKm<e||0<this.ae.chainedDistance?s/i.metersInKm+" km":s+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",Ht.PROFILE_MARGIN+(s-this.ae.chainedDistance)*this.Ti),t.setAttributeNS(null,"y",Ht.Ai),t.setAttributeNS(null,"text-anchor","start"),this.wi.appendChild(t),s+=e}}ji(){let t=Number.MAX_VALUE,e=0;Ht.Mi.forEach((s=>{const i=Math.abs(this.bi/Ht.Ei-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.fi/e)*e;for(;s<this.yi;){const t=Ht.PROFILE_MARGIN+(this.yi-s)*this.Ni,i=document.createElementNS(N,"text");i.appendChild(document.createTextNode(s.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",Ht.Si),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","start"),this.wi.appendChild(i);const r=document.createElementNS(N,"text");r.appendChild(document.createTextNode(s.toFixed(0))),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),r.setAttributeNS(null,"x",Ht.ki),r.setAttributeNS(null,"y",t),r.setAttributeNS(null,"text-anchor","end"),this.wi.appendChild(r),s+=e}}Hi(){this.wi=document.createElementNS(N,"svg"),this.wi.setAttributeNS(null,"viewBox","0 0 "+(Ht.PROFILE_WIDTH+2*Ht.PROFILE_MARGIN)+" "+(Ht.PROFILE_HEIGHT+2*Ht.PROFILE_MARGIN)),this.wi.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){}createSvg(t){return this.ae=t,this.fi=Number.MAX_VALUE,this.yi=0,this.ae.itinerary.itineraryPoints.forEach((t=>{this.yi=Math.max(this.yi,t.elev),this.fi=Math.min(this.fi,t.elev)})),this.bi=this.yi-this.fi,this.Ni=Ht.PROFILE_HEIGHT/this.bi,this.Ti=Ht.PROFILE_WIDTH/this.ae.distance,this.Hi(),this.Ri(),this.Oi(),this.ji(),this.Bi(),this.wi}}class Ut{static get Ui(){return 40}static get Fi(){return 40}constructor(){}getNoteTextAndIconHTML(e,s){const i=et.create("div",{dataset:{ObjId:s.note.objId}}),r=et.create("div",{className:e+(s.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},i);let a=1;L.sanitizeToHtmlElement(s.note.iconContent,r),"TravelNotes-Roadbook-"===e&&r.firstChild&&("svg"===r.firstChild.tagName?(r.firstChild.setAttributeNS(null,"viewBox","0 0 "+o.svgViewboxDim+" "+o.svgViewboxDim),a=t.note.svgIcon.roadbookFactor):r?.firstChild?.classList?.contains("TravelNotes-MapNoteCategory-0073")&&(a=t.note.svgIcon.roadbookFactor)),r.style.width=String(s.note.iconWidth*a)+"px",r.style.height=String(s.note.iconHeight*a)+"px";const n=this.getNoteTextHTML(e,s);return n.className=e+(s.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),i.appendChild(n),i}getNoteTextHTML(t,e){const s=e.note,i=et.create("div");if(0!==s.tooltipContent.length&&L.sanitizeToHtmlElement(s.tooltipContent,et.create("div",{className:t+"NoteHtml-TooltipContent"},i)),0!==s.popupContent.length&&L.sanitizeToHtmlElement(s.popupContent,et.create("div",{className:t+"NoteHtml-PopupContent"},i)),0!==s.address.length&&L.sanitizeToHtmlElement("<span>"+k.getText("NoteHTMLViewsFactory - Address")+"</span>¬†:¬†"+s.address,et.create("div",{className:t+"NoteHtml-Address"},i)),0!==s.url.length&&L.sanitizeToHtmlElement("<span>"+k.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+s.url+' target="_blank" >'+s.url.substr(0,Ut.Ui)+"...</a>",et.create("div",{className:t+"NoteHtml-Url"},i)),0!==s.phone.length){let e=s.phone;if(s.phone.match(/^\+[0-9, ,*,\u0023]*$/)){const t=s.phone.replaceAll(/\u0020/g,""),i=s.phone.replaceAll(/\u0020/g,"¬†");e=k.getText("NoteHTMLViewsFactory - Phone")+"¬†:¬†"+k.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+i+"</a>"+k.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+i+"</a>"}else e=k.getText("NoteHTMLViewsFactory - Phone")+"¬†:¬†"+s.phone;L.sanitizeToHtmlElement(e,et.create("div",{className:t+"NoteHtml-Phone"},i))}if(L.sanitizeToHtmlElement(S.formatLatLng(s.latLng),et.create("div",{className:t+"NoteHtml-LatLng"},i)),e.route){e.route.chain&&L.sanitizeToHtmlElement("<span>"+k.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span>¬†:¬†"+S.formatDistance(s.chainedDistance+s.distance),et.create("div",{className:t+"NoteHtml-Distance"},i)),L.sanitizeToHtmlElement("<span>"+k.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span>¬†:¬†"+S.formatDistance(s.distance),et.create("div",{className:t+"NoteHtml-Distance"},i));const r=e.route.notes.next(s.objId);if(r){const e=r.distance-s.distance;Ut.Fi<e&&L.sanitizeToHtmlElement("<span>"+k.getText("NoteHTMLViewsFactory - Next note after")+"</span>¬†:¬†"+S.formatDistance(e),et.create("div",{className:t+"NoteHtml-NextDistance"},i))}}return i}getTravelNotesHTML(t){const e=et.create("div",{className:t+"Travel-Notes"}),s=V.travel.notes.iterator;for(;!s.done;){const i=this.getNoteTextAndIconHTML(t,{note:s.value,route:null});i.className=t+"Travel-Notes-Row",e.appendChild(i)}return e}}const Ft=new Ut;const Kt=new class{Ki(t,e){const s=et.create("div"),r=et.create("div",{className:t+"Route-ManeuversAndNotes-IconCell TravelNotes-ManeuverNote-"+e.maneuver.iconName},s);r.style.width=String(o.width)+"px",r.style.height=String(o.height)+"px";const a=et.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},s);return L.sanitizeToHtmlElement(e.maneuver.instruction,et.create("div",null,a)),e.route.chain&&L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span>¬†:¬†"+S.formatDistance(e.route.chainedDistance+e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-Distance"},a)),L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span>¬†:¬†"+S.formatDistance(e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-Distance"},a)),i.defaultValue<e.maneuver.distance&&L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span>¬†:¬†"+S.formatDistance(e.maneuver.distance),et.create("div",{className:t+"Route-Maneuver-Distance"},a)),s}constructor(){}getRouteProfileHTML(t,e){const s=et.create("div",{className:t+"RouteProfile"});return L.sanitizeToHtmlElement(k.getText("RouteHTMLViewsFactory - Profile"),s),s.appendChild((new Ht).createSvg(e)),s}getRouteManeuversAndNotesHTML(t,e,s){const i=[],r=e.notes.iterator;for(;!r.done;)i.push({data:r.value,distance:r.value.distance});const a=e.itinerary.maneuvers.iterator;let o=0;for(;!a.done;)i.push({data:a.value,distance:o}),o+=a.value.distance;i.sort(((t,e)=>t.distance-e.distance));const n=et.create("div",{className:t+"Route-ManeuversAndNotes"});return i.forEach((i=>{let r=null;"Note"===i.data.objType.name?(r=Ft.getNoteTextAndIconHTML(t,{note:i.data,route:e}),r.className=t+"Route-Notes-Row"):(r=this.Ki(t,{route:e,maneuver:i.data,maneuverDistance:i.distance}),r.className=t+"Route-Maneuvers-Row"),s&&(r.dataset.tanObjId=i.data.objId,r.dataset.tanMarkerObjId=f.nextObjId,r.dataset.tanObjType=i.data.objType.name),n.appendChild(r)})),n}getRouteHeaderHTML(t,e){const s=et.create("div",{className:t+"Route-Header",id:"route"+e.objId});return L.sanitizeToHtmlElement(e.computedName,et.create("div",{className:t+"Route-Header-Name"},s)),0!==e.distance&&L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Route distance")+"</span>¬†:¬†"+S.formatDistance(e.distance),et.create("div",{className:t+"Route-Header-Distance"},s)),V.travel.readOnly||"bike"===e.itinerary.transitMode||L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Duration")+"</span>¬†:¬†"+S.formatTime(e.duration),et.create("div",{className:t+"Route-Header-Duration"},s)),e.itinerary.hasProfile&&(L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Ascent")+"</span>¬†:¬†"+String(e.itinerary.ascent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Ascent"},s)),L.sanitizeToHtmlElement("<span>"+k.getText("RouteHTMLViewsFactory - Descent")+"</span>¬†:¬†"+String(e.itinerary.descent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Descent"},s))),s}getRouteFooterHTML(t,e){let s=""!==e.itinerary.provider&&""!==e.itinerary.transitMode?k.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:k.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}):"";const i=et.create("div",{className:t+"RouteFooter"});return L.sanitizeToHtmlElement(s,i),i}};class Wt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onKeydownKeyboard(t.key)}}class Vt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onCancelMenu()}}class zt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onMouseLeaveMenuItem(t.currentTarget)}}class Gt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onMouseEnterMenuItem(t.currentTarget)}}class Zt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.selectItem(Number.parseInt(t.currentTarget.dataset.tanObjId))}}class Xt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onMouseLeaveContainer()}}class Jt{Wi=null;constructor(t){this.Wi=t}handleEvent(t){t.stopPropagation(),this.Wi.onMouseEnterContainer()}}class Yt{static Vi=Object.freeze({get previousItem(){return-1},get firstItem(){return 0},get nextItem(){return 1},get lastItem(){return 2}});zi=null;Gi;Zi;Xi;Ji;Yi;qi;$i;Qi=w;ti=null;tr(){this.zi.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}er(t){switch(this.tr(),t){case Yt.Vi.previousItem:case Yt.Vi.nextItem:this.Qi+=t,w===this.Qi&&(this.Qi=this.zi.menuItemHTMLElements.length-1),this.zi.menuItemHTMLElements.length===this.Qi&&(this.Qi=0);break;case Yt.Vi.firstItem:this.Qi=0;break;case Yt.Vi.lastItem:this.Qi=this.zi.menuItemHTMLElements.length-1}this.zi.menuItemHTMLElements[this.Qi].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(t){this.zi=t,this.Gi=new Wt(this),this.Zi=new Xt(this),this.Xi=new Jt(this),this.Ji=new Vt(this),this.Yi=new Zt(this),this.qi=new zt(this),this.$i=new Gt(this),document.addEventListener("keydown",this.Gi,!0),this.zi.container.addEventListener("mouseleave",this.Zi),this.zi.container.addEventListener("mouseenter",this.Xi),this.zi.cancelButton.addEventListener("click",this.Ji),this.zi.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.Yi),t.addEventListener("mouseleave",this.qi),t.addEventListener("mouseenter",this.$i)}))}destructor(){this.ti&&(clearTimeout(this.ti),this.ti=null),document.removeEventListener("keydown",this.Gi,!0),this.zi.container.removeEventListener("mouseleave",this.Zi),this.zi.container.removeEventListener("mouseenter",this.Xi),this.zi.cancelButton.removeEventListener("click",this.Ji),this.zi.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.Yi),t.removeEventListener("mouseleave",this.qi),t.removeEventListener("mouseenter",this.$i)})),this.Gi=null,this.Zi=null,this.Xi=null,this.Ji=null,this.Yi=null,this.qi=null,this.$i=null,this.zi.parentNode.removeChild(this.zi.container),this.zi=null}onMouseLeaveContainer(){this.ti=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.ti&&(clearTimeout(this.ti),this.ti=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.er(Yt.Vi.nextItem);break;case"ArrowUp":case"ArrowLeft":this.er(Yt.Vi.previousItem);break;case"Home":this.er(Yt.Vi.firstItem);break;case"End":this.er(Yt.Vi.lastItem);break;case"Enter":if(w===this.Qi||this.zi.menuItemHTMLElements[this.Qi].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.zi.onOk(this.Qi)}}onCancelMenu(){this.zi.onCancel("Canceled by user")}selectItem(t){this.zi.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.zi.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(t){this.tr(),this.Qi=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class qt{sr;ir;rr;constructor(t,e,s){this.sr=t,this.ir=e,this.rr=s}get itemText(){return this.sr}get isActive(){return this.ir}get action(){return this.rr}}class $t{ar;nr;hr;lr;cr;constructor(t,e){this.ar=t.clientX||t.originalEvent.clientX||0,this.nr=t.clientY||t.originalEvent.clientY||0,this.hr=[t.latlng?t.latlng.lat:h.defaultValue,t.latlng?t.latlng.lng:h.defaultValue],this.lr=t.target?.objId??(Number.parseInt(t?.currentTarget?.dataset?.tanObjId)||m),this.cr=Boolean(e)}get clientX(){return this.ar}get clientY(){return this.nr}get latLng(){return this.hr}get targetObjId(){return this.lr}get haveParentNode(){return this.cr}}class Qt{static ur=null;vr;dr;pr;ce;Ae;_r;mr;Wi;static get gr(){return 20}wr(){this.ce=et.create("div",{className:"TravelNotes-ContextMenu-Container"},this.pr)}Nr(){this.Ae=et.create("div",{textContent:"‚ùå",className:"TravelNotes-ContextMenu-CloseButton",title:k.getText("ContextMenu - Close")},this.ce)}Tr(){this._r=[];let t=0;this.menuItems.forEach((e=>{const s=et.create("div",{textContent:e.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(t++)}},this.ce);e.isActive||s.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this._r.push(s)}))}yr(){const t=Math.min(this.mr.clientY,V.map.getContainer().clientHeight-this.ce.clientHeight-Qt.gr);if(this.ce.style.top=String(t)+"px",this.mr.haveParentNode)this.ce.style.right=String(Qt.gr)+"px";else{const t=Math.min(this.mr.clientX,V.map.getContainer().clientWidth-this.ce.clientWidth-Qt.gr);this.ce.style.left=String(t)+"px"}}br(t,e){this.vr=t,this.dr=e,this.wr(),this.Nr(),this.Tr(),this.yr(),this.Wi=new Yt(this)}constructor(t,e){Qt.ur?Qt.ur.onCancel():(this.mr=new $t(t,e),this.pr=e||document.body,Qt.ur=this)}onOk(t){this.Wi.destructor(),Qt.ur=null,this.vr(t)}onCancel(){this.Wi.destructor(),Qt.ur=null,this.dr()}show(){Qt.ur&&new Promise(((t,e)=>{this.br(t,e)})).then((t=>this.menuItems[t].action())).catch((t=>{t&&console.error(t)}))}get menuItems(){return[]}get parentNode(){return this.pr}get container(){return this.ce}get cancelButton(){return this.Ae}get menuItemHTMLElements(){return this._r}get eventData(){return this.mr}}class te{Ee;Ir;Mr;constructor(t){if("string"!=typeof t?.title||"string"!=typeof t?.htmlBefore||t.htmlAfter&&"string"!=typeof t.htmlAfter)throw new Error("Invalid toolbar button");let e=(t.htmlBefore||"")+(t.htmlAfter||""),s=L.sanitizeToHtmlString(e).errorsString;if(""!==s)throw new Error("Invalid toolbar button : "+e+s);this.Ee=L.sanitizeToHtmlString(t.title).htmlString,""===this.title&&(this.title="?"),this.Ir=t.htmlBefore||"",this.Mr=t.htmlAfter||""}get title(){return this.Ee}get htmlBefore(){return this.Ir}get htmlAfter(){return this.Mr}}class ee{rt;Dr;Er;Ot;Pr;constructor(t){this.rt="string"==typeof t?.name?L.sanitizeToJsString(t.name):"?",this.Dr="string"==typeof t.icon?L.sanitizeToHtmlString(t?.icon).htmlString:"?",this.Er="string"==typeof t?.tooltip?L.sanitizeToHtmlString(t.tooltip).htmlString:"?",this.Ot="number"==typeof t?.width?t.width:o.width,this.Pr="number"==typeof t?.height?t.height:o.height}get name(){return this.rt}get icon(){return this.Dr}get tooltip(){return this.Er}get width(){return this.Ot}get height(){return this.Pr}}const se=new class{Cr;Lr;kr;constructor(){this.Cr=[],this.Lr=new Map,this.kr=[]}get editionButtonsData(){return this.Cr}get preDefinedIconsData(){return this.kr}preDefinedIconDataAt(t){return this.kr[t]}preDefinedIconDataFromName(t){const e=this.Lr.get(t);return e?e.icon:""}loadJson(t){if(t.editionButtons&&t.editionButtons.forEach((t=>{try{let e=new te(t);this.Cr.push(e)}catch(t){console.error(t.message)}})),t.preDefinedIconsList){t.preDefinedIconsList.forEach((t=>{const e=new ee(t);this.Lr.set(e.name,e)})),this.kr.length=0;for(const t of this.Lr)this.kr.push(t[1]);this.kr=this.kr.sort(((t,e)=>t.name.localeCompare(e.name)))}}};class ie{Es;Sr;Ar;Rr;Or;Br(){this.Sr=et.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.Es),se.preDefinedIconsData.forEach((t=>{this.Sr.add(et.create("option",{text:t.name}))})),this.Sr.selectedIndex=w}qs(){this.Ar=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("NoteDialog - show hidden contents"),textContent:"‚ñº"},this.Es),this.Rr=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("NoteDialog - Open a configuration file"),textContent:"üìÇ"},this.Es)}jr(){se.editionButtonsData.forEach((t=>{const e=et.create("div",{dataset:{HtmlBefore:t.htmlBefore,HtmlAfter:t.htmlAfter},className:"TravelNotes-NoteDialog-EditorButton"},this.Es);L.sanitizeToHtmlElement(t.title,e),this.Or.push(e)}))}Hr(){this.Br(),this.qs(),this.jr()}Ur(t){this.Sr.addEventListener("change",t.iconSelectorChange),this.Ar.addEventListener("click",t.toggleContentsButtonClick),this.Or.forEach((e=>{e.addEventListener("click",t.editionButtonsClick)})),this.Rr.addEventListener("click",t.openFileButtonClick,!1)}Fr(t){this.Sr.removeEventListener("change",t.iconSelectorChange),this.Ar.removeEventListener("click",t.toggleContentsButtonClick),this.Or.forEach((e=>{e.removeEventListener("click",t.editionButtonsClick)})),this.Rr.removeEventListener("click",t.openFileButtonClick,!1)}constructor(t){this.Or=[],this.Es=et.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.Hr(),this.Ur(t)}destructor(t){this.Fr(t)}update(t){this.Fr(t),this.Es.textContent="",this.Or=[],this.Hr(),this.Ur(t)}get rootHTMLElement(){return this.Es}}class re{Kr=null;Wr=null;Vr=null;constructor(t){this.Kr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:k.getText("NoteDialog - Icon width")},this.Kr),this.Wr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:o.width,dataset:{Name:"iconWidth"}},this.Kr),et.create("text",{value:k.getText("NoteDialog - Icon height")},this.Kr),this.Vr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:o.height,dataset:{Name:"iconHeight"}},this.Kr),this.Wr.addEventListener("input",t.controlInput),this.Vr.addEventListener("input",t.controlInput)}destructor(t){this.Wr.removeEventListener("input",t.controlInput),this.Vr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Kr]}get iconWidth(){return Number.parseInt(this.Wr.value)}set iconWidth(t){this.Wr.value=t}get iconHeight(){return Number.parseInt(this.Vr.value)}set iconHeight(t){this.Vr.value=t}}class ae{zr;Gr;constructor(e){this.zr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:k.getText("NoteDialog - Icon content")}),this.Gr=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:t.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this.zr),this.Gr.addEventListener("focus",e.controlFocus),this.Gr.addEventListener("input",e.controlInput)}destructor(t){this.Gr.removeEventListener("focus",t.controlFocus),this.Gr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.zr]}get iconContent(){return this.Gr.value}set iconContent(t){this.Gr.value=t}}class oe{Zr;Xr;constructor(t){this.Zr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:k.getText("NoteDialog - Tooltip content")}),this.Xr=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this.Zr),this.Xr.addEventListener("focus",t.controlFocus),this.Xr.addEventListener("input",t.controlInput)}destructor(t){this.Xr.removeEventListener("focus",t.controlFocus),this.Xr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Zr]}get tooltipContent(){return this.Xr.value}set tooltipContent(t){this.Xr.value=t}}class ne{Jr;Yr;constructor(e){this.Jr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:k.getText("NoteDialog - Text")}),this.Yr=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:t.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this.Jr),this.Yr.addEventListener("focus",e.controlFocus),this.Yr.addEventListener("input",e.controlInput)}destructor(t){this.Yr.removeEventListener("focus",t.controlFocus),this.Yr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Jr]}get popupContent(){return this.Yr.value}set popupContent(t){this.Yr.value=t}}class he{qr;$r;Qr;ta;constructor(t){this.qr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.ta=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("NoteDialog - Reset address"),textContent:"üîÑ"},this.qr),et.create("text",{value:k.getText("NoteDialog - Address")},this.qr),this.$r=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.Qr=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this.$r),this.Qr.addEventListener("focus",t.controlFocus),this.Qr.addEventListener("input",t.controlInput),this.ta.addEventListener("click",t.addressButtonClick)}destructor(t){this.Qr.removeEventListener("focus",t.controlFocus),this.Qr.removeEventListener("input",t.controlInput),this.ta.removeEventListener("click",t.addressButtonClick)}get HTMLElements(){return[this.qr,this.$r]}get address(){return this.Qr.value}set address(t){this.Qr.value=t}}class le{ea;sa;ia;ra(e){t.noteDialog.theDevil.addButton&&et.create("text",{value:"üëø"},et.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(h.fixed)+","+e[1].toFixed(h.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},et.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this.ea)))}constructor(t,e){this.ea=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.ra(e),et.create("text",{value:k.getText("NoteDialog - Link")},this.ea),this.sa=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.ia=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this.sa),this.ia.addEventListener("focus",t.controlFocus),this.ia.addEventListener("input",t.controlInput),this.ia.addEventListener("blur",t.urlInputBlur)}destructor(t){this.ia.removeEventListener("focus",t.controlFocus),this.ia.removeEventListener("input",t.controlInput),this.ia.removeEventListener("blur",t.urlInputBlur)}get HTMLElements(){return[this.ea,this.sa]}get url(){return this.ia.value}set url(t){this.ia.value=t}}class ce{aa;oa;na;constructor(t){this.aa=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:"¬†"+k.getText("NoteDialog - Phone")},this.aa),this.oa=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.na=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this.oa),this.na.addEventListener("focus",t.controlFocus),this.na.addEventListener("input",t.controlInput)}destructor(t){this.na.removeEventListener("focus",t.controlFocus),this.na.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.aa,this.oa]}get phone(){return this.na.value}set phone(t){this.na.value=t}}class ue{ha;la;constructor(t){this.la=t,this.ha=et.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.ha.appendChild(Ft.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",new $(this.la,null)))}update(){this.ha.textContent="",this.ha.appendChild(Ft.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.la,route:null}))}get HTMLElements(){return[this.ha]}}class ve{searchPlaces=!0;searchWays=!0;searchRelations=!0;setGeometry=!0;constructor(){}}class de{Ye;ca;ua;va;da;pa;_a;hr;ma;ga;wa;Na(){this.ua.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.nodes.forEach((s=>{const i=this.ca.get(s);t.geometry[0].push([i.lat,i.lon]),t.lat+=i.lat,t.lon+=i.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.va.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.members.forEach((s=>{if("way"===s.type){const i=this.ua.get(s.ref);t.geometry.push(i.geometry[0]),t.lat+=i.lat,t.lon+=i.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}Ta(e){e.forEach((e=>{switch(e.type){case"node":if(this.ca.set(e.id,e),e?.tags?.place&&this.Ye.searchPlaces&&this._a[e.tags.place]&&e?.tags?.name){const t=q.pointsDistance(this.hr,[e.lat,e.lon]),s=this._a[e.tags.place];s.maxDistance>t&&s.distance>t&&(s.distance=t,s.name=e.tags.name)}break;case"way":this.Ye.searchWays&&this.ua.set(e.id,e);break;case"relation":this.Ye.searchRelations&&this.va.set(e.id,e);break;case"area":if(this.Ye.searchPlaces){let s=e.tags.name;"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(s=e.tags["name:"+t.nominatim.language]),this.da[Number.parseInt(e.tags.admin_level)]=s,"2"===e.tags.admin_level&&(this.pa=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.pa)}}})),this.Ye.setGeometry&&this.Na(),this.Ye.searchPlaces&&this.fa()}fa(){let t=null;for(let e=2;e<this.da.length;e++)void 0!==this.da[e]&&(this.pa>=e?this.ga=this.da[e]:t=this.da[e]);let e=Number.MAX_VALUE;Object.values(this._a).forEach((t=>{t.distance<e&&(e=t.distance,this.ma=t.name)})),this.ma=t||this.ma,this.ma===this.ga&&(this.ma=null)}async ya(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&_===t[e].value.status&&t[e].value.ok){const s=await t[e].value.json();this.Ta(s.elements)}else this.wa=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(this.Ye=new ve,t)for(const[e,s]of Object.entries(t))this.Ye[e]&&(this.Ye[e]=s);this.ca=new Map,this.ua=new Map,this.va=new Map}async loadData(e,s){this.hr=s,this.wa=!0,this.da=[],this.pa=t.geoCoder.osmCityAdminLevel.DEFAULT,this._a=Object.freeze({hamlet:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet}),village:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village}),city:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city}),town:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town})}),this.ma=null,this.ga=null,this.ca.clear(),this.ua.clear(),this.va.clear();const i=[];e.forEach((e=>{i.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(i).then((t=>this.ya(t)))}get nodes(){return this.ca}get ways(){return this.ua}get relations(){return this.va}get place(){return this.ma}get city(){return this.ga}get country(){return this.da[2]}get statusOk(){return this.wa}}class pe{ba=!1;rt="";Ia="";ga="";Ma="";Da(t,e){t.error||e.error?this.ba=!1:(this.rt=e.namedetails.name,e.address.house_number&&(this.Ia=e.address.house_number+" "),e.address.road?this.Ia+=e.address.road+" ":e.address.pedestrian&&(this.Ia+=e.address.pedestrian+" "),this.ga=t.address.city||t.address.town||t.address.village||"",this.Ma=e.address.country,this.ba=!0)}constructor(){}async loadData(e){this.ba=!1;const s=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1];let i=s+"&zoom=10&addressdetails=1&namedetails=0",r=s+"&zoom=18&addressdetails=1&namedetails=1";const a=t.nominatim.language;a&&"*"!==a&&(i+="&accept-language="+a,r+="&accept-language="+a);const o=new Headers;a&&"*"===a&&o.append("accept-language","");const n=await fetch(i,{headers:o}),h=await fetch(r,{headers:o});_===n.status&&n.ok&&_===h.status&&h.ok?this.Da(await n.json(),await h.json()):this.ba=!1}get name(){return this.ba?this.rt:null}get street(){return this.ba?this.Ia:null}get city(){return this.ba?this.ga:null}get country(){return this.ba?this.Ma:null}}class _e{rt;Ia;ga;constructor(t,e,s){this.rt=L.sanitizeToJsString(t),this.Ia=L.sanitizeToJsString(e),this.ga=L.sanitizeToJsString(s)}get name(){return this.rt}get street(){return this.Ia}get city(){return this.ga}}class me{static get Ea(){return Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town)}hr;xa;Pa;Ca(){let t=this.Pa.city||this.Pa.country||"";const e=this.xa.place;e&&e!==t&&(t+=" ("+e+")");let s=(this.Pa.street||"").replaceAll(";"," "),i=this.Pa.name||"";return(s.includes(i)||t.includes(i))&&(i=""),new _e(i,s,t)}La(){return["node(around:"+me.Ea+","+this.hr[0]+","+this.hr[1]+")[place];out;"]}async ka(){return await this.xa.loadData(this.La(),this.hr),await this.Pa.loadData(this.hr),this.Ca()}async Sa(t,e){t(await this.ka())}constructor(){this.xa=new de({searchWays:!1,searchRelations:!1,setGeometry:!0}),this.Pa=new pe({searchPlaces:!0,searchWays:!1,searchRelations:!1,setGeometry:!1})}async getAddressAsync(t){return this.hr=t,this.ka()}getAddressWithPromise(t){return this.hr=t,new Promise(((t,e)=>this.Sa(t,e)))}}class ge{Aa;xa;Ra;Oa(){this.Ra=document.createElementNS(N,"svg"),this.Ra.setAttributeNS(null,"viewBox",String(o.svgViewboxDim/4)+" "+o.svgViewboxDim/4+" "+o.svgViewboxDim/2+" "+o.svgViewboxDim/2),this.Ra.setAttributeNS(null,"class","TravelNotes-SvgIcon")}Ba(){let e=-1,s=w,i=w;const r=[];if(this.Aa.route.itinerary.itineraryPoints.forEach((a=>{e++;const n=Y.addPoints(Y.project(a.latLng,t.note.svgIcon.zoom),this.Aa.translation);r.push(n);n[0]>=0&&n[1]>=0&&n[0]<=o.svgViewboxDim&&n[1]<=o.svgViewboxDim&&(w===s&&(s=e),i=e)})),w!==s&&w!==i){0<s&&s--,this.Aa.route.itinerary.itineraryPoints.length-1>i&&i++;let t="";for(e=s;e<=i;e++)t+=r[e][0].toFixed(0)+","+r[e][1].toFixed(0)+" ";const a=document.createElementNS(N,"polyline");a.setAttributeNS(null,"points",t),a.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),a.setAttributeNS(null,"transform","rotate("+this.Aa.rotation+","+o.svgViewboxDim/2+","+o.svgViewboxDim/2+")"),this.Ra.appendChild(a)}}ja(){this.xa.ways.forEach((e=>{let s=w,i=w,r=-1;const a=[];if(e.nodes.forEach((e=>{r++;const n=this.xa.nodes.get(e),h=Y.addPoints(Y.project([n.lat,n.lon],t.note.svgIcon.zoom),this.Aa.translation);a.push(h);h[0]>=0&&h[1]>=0&&h[0]<=o.svgViewboxDim&&h[1]<=o.svgViewboxDim&&(w===s&&(s=r),i=r)})),w!==s&&w!==i){0<s&&s--,e.nodes.length-1>i&&i++;let t="";for(r=s;r<=i;r++)t+=a[r][0].toFixed(0)+","+a[r][1].toFixed(0)+" ";const n=document.createElementNS(N,"polyline");n.setAttributeNS(null,"points",t),n.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),n.setAttributeNS(null,"transform","rotate("+this.Aa.rotation+","+o.svgViewboxDim/2+","+o.svgViewboxDim/2+")"),this.Ra.appendChild(n)}}))}Ha(){if(""===this.Aa.rcnRef)return;const t=document.createElementNS(N,"text");t.textContent=this.Aa.rcnRef,t.setAttributeNS(null,"x",String(o.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(.6*o.svgViewboxDim)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.Ra.appendChild(t)}constructor(){}buildSvg(t,e,s){this.Aa=t,this.xa=s,this.Oa(),this.Ba(),this.ja(),this.Ha(),e.iconContent=this.Ra.outerHTML}}class we{isMini;isEntry;isExit;constructor(){this.isMini=!1,this.isEntry=!1,this.isExit=!1}}class Ne{Aa;Ua;xa;Fa;Ka;Wa;Va;za;Ga;Za;Xa;Ja(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}Ya(t){const e=5e-6;let s=!1;return this.Aa.route.wayPoints.forEach((i=>{Math.abs(t.lat-i.lat)<e&&Math.abs(t.lng-i.lng)<e&&(s=!0)})),!s&&(this.Ua.latLng[0]!==t.lat||this.Ua.latLng[1]!==t.lng)}qa(){const e=this.Aa.route.itinerary.itineraryPoints.previous(this.Aa.nearestItineraryPointObjId,(t=>this.Ya(t))),s=this.Aa.route.itinerary.itineraryPoints.next(this.Aa.nearestItineraryPointObjId,(t=>this.Ya(t)));let r=Number.MAX_VALUE,a=Number.MAX_VALUE,o=Number.MAX_VALUE,n=Number.MAX_VALUE,h=i.defaultValue;this.xa.nodes.forEach((i=>{h=q.pointsDistance([i.lat,i.lon],this.Ua.latLng),"bike"===this.Aa.route.itinerary.transitMode&&i?.tags?.rcn_ref&&i.tags["network:type"]&&"node_network"===i.tags["network:type"]&&h<t.note.svgIcon.rcnRefDistance&&h<a&&(this.Fa=i,a=h),h<r&&(this.Wa=i.id,r=h),e&&(h=q.pointsDistance([i.lat,i.lon],e.latLng),h<o&&(this.Va=i.id,o=h)),s&&(h=q.pointsDistance([i.lat,i.lon],s.latLng),h<n&&(this.za=i.id,n=h))})),this.Ka=this.xa.nodes.get(this.Wa)}$a(){this.Xa.isMini="mini_roundabout"===this?.Ka?.tags?.highway}Qa(){this.Fa&&(this.Aa.rcnRef=this.Fa.tags.rcn_ref,this.Ua.tooltipContent+=k.getText("MapIconDataBuilder - rcnRef",{rcnRef:this.Aa.rcnRef}))}eo(){this.xa.ways.forEach((t=>{if(!t.nodes.includes(this.Wa))return;const e=this.Ja(t),s=""!==e,i=t.nodes.includes(this.Va),r=t.nodes.includes(this.za);let a=2*t.nodes.filter((t=>t===this.Wa)).length;if(t.nodes[0]===this.Wa&&a--,t.nodes[t.nodes.length-1]===this.Wa&&a--,i&&(this.Ga=s?e:"???",a--,"roundabout"===t?.tags?.junction&&(this.Xa.isExit=!0)),0!==a&&(r&&(this.Za=s?e:"???",a--,"roundabout"===t?.tags?.junction&&(this.Xa.isEntry=!0)),0!==a&&s))for(;0!==a;)this.Ua.address=""===this.Ua.address?e:this.Ua.address+" ‚™•  "+e,a--}))}so(){""!==this.xa.city&&(this.Ua.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.xa.city+"</span>"),this.xa.place&&this.xa.place!==this.xa.city&&(this.Ua.address+=" ("+this.xa.place+")")}io(){n.atStart===this.Aa.positionOnRoute?(this.Ua.address="üü¢ "+this.Za,this.so()):n.atEnd===this.Aa.positionOnRoute?(this.so(),this.Ua.address=this.Ga,this.so(),this.Ua.address+=" üî¥ "):(this.Ua.address=this.Ga+(""===this.Ua.address?"":" ‚™•  "+this.Ua.address)+" "+this.Aa.directionArrow+" "+this.Za,this.so())}ro(){this.Xa.isEntry&&!this.Xa.isExit?this.Ua.tooltipContent+=k.getText("MapIconDataBuilder - entry roundabout"):!this.Xa.isEntry&&this.Xa.isExit?this.Ua.tooltipContent+=k.getText("MapIconDataBuilder - exit roundabout"):this.Xa.isEntry&&this.Xa.isExit&&(this.Ua.tooltipContent+=k.getText("MapIconDataBuilder - continue roundabout")),this.Xa.isMini&&(this.Ua.tooltipContent+=k.getText("MapIconDataBuilder - at the small roundabout on the ground"))}constructor(){}findData(t,e,s){this.Aa=t,this.Ua=e,this.xa=s,this.Wa=w,this.Va=w,this.za=w,this.Ga="",this.Za="",this.Xa=new we,this.qa(),this.$a(),this.Qa(),this.eo(),this.io(),this.ro()}}class Te{constructor(){}findData(e,s){null!==e.direction&&(e.direction<t.note.svgIcon.angleDirection.right?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn right"),e.directionArrow="ü¢Ç"):e.direction<t.note.svgIcon.angleDirection.slightRight?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn slight right"),e.directionArrow="ü¢Ö"):e.direction<t.note.svgIcon.angleDirection.continue?(s.tooltipContent=k.getText("MapIconDataBuilder - Continue"),e.directionArrow="ü¢Å"):e.direction<t.note.svgIcon.angleDirection.slightLeft?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn slight left"),e.directionArrow="ü¢Ñ"):e.direction<t.note.svgIcon.angleDirection.left?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn left"),e.directionArrow="ü¢Ä"):e.direction<t.note.svgIcon.angleDirection.sharpLeft?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn sharp left"),e.directionArrow="ü¢á"):e.direction<t.note.svgIcon.angleDirection.sharpRight?(s.tooltipContent=k.getText("MapIconDataBuilder - Turn sharp right"),e.directionArrow="ü¢Ü"):(s.tooltipContent=k.getText("MapIconDataBuilder - Turn right"),e.directionArrow="ü¢Ç")),n.atStart===e.positionOnRoute?s.tooltipContent=k.getText("MapIconDataBuilder - Start"):n.atEnd===e.positionOnRoute&&(s.tooltipContent=k.getText("MapIconDataBuilder - Stop"))}}class fe{Aa;Ua;ao;oo;no;ho(){this.Aa.translation=Y.subtrackPoints([o.svgViewboxDim/2,o.svgViewboxDim/2],Y.project(this.Ua.latLng,t.note.svgIcon.zoom))}lo(){this.ao=this.Aa.route.itinerary.itineraryPoints.previous(this.Aa.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Ua.latLng)>t.note.svgIcon.angleDistance))||this.Aa.route.itinerary.itineraryPoints.first}co(){this.oo=this.Aa.route.itinerary.itineraryPoints.next(this.Aa.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Ua.latLng)>t.note.svgIcon.angleDistance))||this.Aa.route.itinerary.itineraryPoints.last}uo(){this.no=Y.addPoints(Y.project(this.Ua.latLng,t.note.svgIcon.zoom),this.Aa.translation)}vo(){if(this.Aa.nearestItineraryPointObjId!==this.Aa.route.itinerary.itineraryPoints.first.objId){const e=Y.addPoints(Y.project(this.ao.latLng,t.note.svgIcon.zoom),this.Aa.translation);this.Aa.rotation=Math.atan((this.no[1]-e[1])/(e[0]-this.no[0]))*s.d180/Math.PI,0>this.Aa.rotation&&(this.Aa.rotation+=s.d360),this.Aa.rotation-=s.d270,0>e[0]-this.no[0]&&(this.Aa.rotation+=s.d180)}}do(){if(this.Aa.nearestItineraryPointObjId!==this.Aa.route.itinerary.itineraryPoints.last.objId){const e=Y.addPoints(Y.project(this.oo.latLng,t.note.svgIcon.zoom),this.Aa.translation);for(this.Aa.direction=Math.atan((this.no[1]-e[1])/(e[0]-this.no[0]))*s.d180/Math.PI,0>e[0]-this.no[0]&&(this.Aa.direction+=s.d180),this.Aa.direction-=this.Aa.rotation;s.d0>this.Aa.direction;)this.Aa.direction+=s.d360;for(;s.d360<this.Aa.direction;)this.Aa.direction-=s.d360}}po(){this.Aa.nearestItineraryPointObjId===this.Aa.route.itinerary.itineraryPoints.first.objId&&(this.Aa.rotation=-this.Aa.direction-s.d90,this.Aa.direction=null,this.Aa.positionOnRoute=n.atStart),this.Ua.latLng[0]===this.Aa.route.itinerary.itineraryPoints.last.lat&&this.Ua.latLng[1]===this.Aa.route.itinerary.itineraryPoints.last.lng&&(this.Aa.direction=null,this.Aa.positionOnRoute=n.atEnd)}constructor(){}findData(t,e){this.Aa=t,this.Ua=e,this.ho(),this.lo(),this.co(),this.uo(),this.vo(),this.do(),this.po()}}class ye{constructor(){}iconContent="";tooltipContent="";address="";latLng=[h.defaultValue,h.defaultValue]}class be{constructor(){}nearestItineraryPointObjId=m;route=null;positionOnRoute=n.onRoute;direction=null;directionArrow=" ";rcnRef="";rotation=0;translation=[0,0]}class Ie{Ua;Aa;xa;Ea;_o;static get mo(){return 1.5}wo(){let t=null,e=Number.MAX_VALUE;this.Aa.route.itinerary.itineraryPoints.forEach((s=>{const i=q.pointsDistance(this.Ua.latLng,s.latLng);e>i&&(e=i,t=s)})),this.Ua.latLng=t.latLng,this.Aa.nearestItineraryPointObjId=t.objId}No(){return(new fe).findData(this.Aa,this.Ua),(new Te).findData(this.Aa,this.Ua),(new Ne).findData(this.Aa,this.Ua,this.xa),(new ge).buildSvg(this.Aa,this.Ua,this.xa),this._o=!1,this.Ua}async To(){if(this._o)return null;this._o=!0,this.Aa.nearestItineraryPointObjId=m,this.Aa.positionOnRoute=n.onRoute,this.Aa.direction=null,this.Aa.directionArrow=" ",this.Aa.translation=[0,0],this.Aa.rotation=0,this.Aa.rcnRef="",this.Ua.iconContent="",this.Ua.tooltipContent="",this.Ua.address="",this.wo();const t=this.Ua.latLng[0].toFixed(h.fixed)+","+this.Ua.latLng[1].toFixed(h.fixed),e=["way[highway](around:"+(o.svgViewboxDim*Ie.mo).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.Ea+","+t+")[place];out;"];return await this.xa.loadData(e,this.Ua.latLng),this.xa.statusOk?this.No():null}async fo(t,e){const s=await this.To();s?t(s):e("An error occurs...")}constructor(){this.Ua=new ye,this.Aa=new be,this.xa=new de({searchRelations:!1,setGeometry:!1}),this.Ea=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town),this._o=!1}async getIconAndAdressAsync(t,e){return this.Ua.latLng=t,this.Aa.route=e,this.To()}getIconAndAdressWithPromise(t){return this.Ua.latLng=t.latLng,this.Aa.route=t.route,new Promise(((t,e)=>this.fo(t,e)))}}class Me{yo;bo(t){this.yo.hideWait();let e=t.street;""!==t.city&&(e+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"),this.yo.setControlsValues({address:e}),this.yo.updatePreview({address:e})}constructor(t){this.yo=t}setAddressWithGeoCoder(t){this.yo.showWait(),this.yo.hideError(),(new me).getAddressWithPromise(t).then((t=>{this.bo(t)})).catch((t=>{t&&console.error(t),this.yo.hideWait(),this.yo.showError(k.getText("Notedialog - an error occurs when searching the adress"))}))}}class De{yo;hr;constructor(t,e){this.yo=t,this.hr=e}handleEvent(t){t.stopPropagation(),new Me(this.yo).setAddressWithGeoCoder(this.hr)}}class Ee{yo;constructor(t){this.yo=t}handleEvent(t){t.stopPropagation(),"url"===t.target.dataset.tanName?this.yo.focusControl=null:this.yo.focusControl=t.target}}class xe{yo;constructor(t){this.yo=t}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return void this.yo.hideError();""===L.sanitizeToUrl(t.target.value).errorsString?this.yo.hideError():this.yo.showError(k.getText("NoteDialog - invalidUrl"))}}class Pe{yo;constructor(t){this.yo=t}handleEvent(t){t.stopPropagation();const e={};e[t.target.dataset.tanName]=t.target.value,this.yo.updatePreview(e)}}class Ce{yo;constructor(t){this.yo=t}handleEvent(t){if(!this.yo.focusControl)return;const e=t.currentTarget;let s=this.yo.focusControl.selectionStart,i=this.yo.focusControl.selectionEnd;this.yo.focusControl.value=this.yo.focusControl.value.slice(0,s)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.yo.focusControl.value.slice(s,i))+e.dataset.tanHtmlAfter+this.yo.focusControl.value.slice(i),s===i||0===e.dataset.tanHtmlAfter.length?(s+=e.dataset.tanHtmlBefore.length,i=s):i+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.yo.focusControl.setSelectionRange(s,i),this.yo.focusControl.focus();const r={};r[this.yo.focusControl.dataset.tanName]=this.yo.focusControl.value,this.yo.updatePreview(r)}}class Le{yo;Io(t){this.yo.setControlsValues(t),this.yo.updatePreview(t)}Mo(){const t=this.yo.mapIconData;t.route?(this.yo.showWait(),(new Ie).getIconAndAdressWithPromise(t).then((t=>{this.yo.hideWait(),this.Io(t)})).catch((t=>{t instanceof Error&&console.error(t),this.yo.hideWait(),this.yo.showError(k.getText("Notedialog - an error occurs when creating the SVG icon"))}))):this.yo.showError(k.getText("Notedialog - not possible to create a SVG icon for a travel note"))}constructor(t){this.yo=t}handleEvent(t){t.stopPropagation();const e=se.preDefinedIconDataAt(t.target.selectedIndex);"SvgIcon"!==e.icon?this.Io({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.Mo()}}class ke{yo;constructor(t){this.yo=t}handleEvent(t){t.target.textContent="‚ñº"===t.target.textContent?"‚ñ∂":"‚ñº",this.yo.toogleContents()}}class Se{yo;constructor(t){this.yo=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{se.loadJson(JSON.parse(e.result)),this.yo.updateToolbar()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Ae{yo;constructor(t){this.yo=t}handleEvent(t){t.stopPropagation(),S.openFile(new Se(this.yo),".json")}}class Re{Do;Eo;xo;Po;Co;Lo;ko;So;constructor(t,e){this.Do=new Ee(t),this.Eo=new Pe(t),this.xo=new De(t,e),this.Po=new xe(t),this.Co=new Ce(t),this.Lo=new Le(t),this.ko=new ke(t),this.So=new Ae(t)}destructor(){this.Do=null,this.Eo=null,this.xo=null,this.Po=null,this.Co=null,this.Lo=null,this.ko=null,this.So=null}get controlFocus(){return this.Do}get controlInput(){return this.Eo}get addressButtonClick(){return this.xo}get urlInputBlur(){return this.Po}get editionButtonsClick(){return this.Co}get iconSelectorChange(){return this.Lo}get toggleContentsButtonClick(){return this.ko}get openFileButtonClick(){return this.So}}class Oe{hr;ae;constructor(t,e){this.hr=t,this.ae=e}get latLng(){return this.hr}get route(){return this.ae}}class Be extends mt{re;Ao;ae;la;Ro;Oo;Bo;jo;Ho;Uo;Fo;Ko;oi;Wo;Vo;fs(){this.oi.destructor(this.Vo),this.Ro.destructor(this.Vo),this.Oo.destructor(this.Vo),this.Bo.destructor(this.Vo),this.jo.destructor(this.Vo),this.Ho.destructor(this.Vo),this.Uo.destructor(this.Vo),this.Fo.destructor(this.Vo),this.Vo.destructor()}constructor(t,e){super(),this.Wo=null,this.re=t,this.ae=e,this.Ao=""===this.re.address,this.Vo=new Re(this,t.latLng),this.la=new U,this.la.jsonObject=t.jsonObject,this.oi=new ie(this.Vo),this.Ro=new re(this.Vo),this.Oo=new ae(this.Vo),this.Bo=new oe(this.Vo),this.jo=new ne(this.Vo),this.Ho=new he(this.Vo,this.Ao),this.Uo=new le(this.Vo,t.latLng),this.Fo=new ce(this.Vo),this.Ko=new ue(this.la),this.setControlsValues(t)}get focusControl(){return this.Wo}set focusControl(t){this.Wo=t}get mapIconData(){return new Oe(this.la.latLng,this.ae)}updatePreview(t){for(const e in t)this.la[e]=t[e];this.Ko.update()}onShow(){this.Ao&&new Me(this).setAddressWithGeoCoder(this.la.latLng),this.toogleContents()}canClose(){return""===this.Oo.iconContent?(this.showError(k.getText("Notedialog - The icon content cannot be empty")),!1):""===this.Uo.url||""!==L.sanitizeToUrl(this.Uo.url).url||(this.showError(k.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this.fs(),super.onCancel()}onOk(){super.onOk()&&(this.re.iconWidth=this.Ro.iconWidth,this.re.iconHeight=this.Ro.iconHeight,this.re.iconContent=this.Oo.iconContent,this.re.tooltipContent=this.Bo.tooltipContent,this.re.popupContent=this.jo.popupContent,this.re.address=this.Ho.address,this.re.url=this.Uo.url,this.re.phone=this.Fo.phone,this.re.latLng=this.la.latLng,this.fs())}get title(){return k.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this.oi.rootHTMLElement,this.Ro.HTMLElements,this.Oo.HTMLElements,this.Bo.HTMLElements,this.jo.HTMLElements,this.Ho.HTMLElements,this.Uo.HTMLElements,this.Fo.HTMLElements)}get footerHTMLElements(){return this.Ko.HTMLElements}setControlsValues(t){this.Ro.iconHeight=t.iconHeight||this.Ro.iconHeight,this.Ro.iconWidth=t.iconWidth||this.Ro.iconWidth,this.Oo.iconContent=t.iconContent||this.Oo.iconContent,this.Bo.tooltipContent=t.tooltipContent||this.Bo.tooltipContent,this.jo.popupContent=t.popupContent||this.jo.popupContent,this.Ho.address=t.address||this.Ho.address,this.Uo.url=t.url||this.Uo.url,this.Fo.phone=t.phone||this.Fo.phone}toogleContents(){t.noteDialog.mask.iconsDimension&&this.Ro.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.iconTextArea&&this.Oo.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.popupContent&&this.jo.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.tooltip&&this.Bo.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.address&&(this.Ho.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Ho.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.link&&(this.Uo.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Uo.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.phone&&(this.Fo.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Fo.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}updateToolbar(){this.oi.update(this.Vo)}}class je{Pe;zo;constructor(){}createUI(){if(this.Pe)return;this.Pe=et.create("div",{className:"TravelNotes-Background"},document.body);const t=et.create("div",{id:"TravelNotes-WaitUI"},this.Pe);this.zo=et.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.zo.textContent=t}close(){document.body.removeChild(this.Pe),this.Pe=null}}const He=new class{re=null;ae=null;Go=!0;Zo=null;Xo(){this.Go?this.ae?(this.ae.notes.add(this.re),this.re.chainedDistance=this.ae.chainedDistance,this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("showitinerary")):(V.travel.notes.add(this.re),Bt.dispatch("showtravelnotes")):Bt.dispatch(this.ae?"updateitinerary":"updatetravelnotes"),Bt.dispatch("noteupdated",{removedNoteObjId:this.re.objId,addedNoteObjId:this.re.objId}),Bt.dispatch("roadbookupdate")}yo(){new Be(this.re,this.ae).show().then((()=>this.Xo())).catch((t=>{console.error(t)}))}Jo(t){this.Go=!0,this.re=new U,this.re.latLng=t,this.re.iconLatLng=t}async Yo(t){if(t.tags.rcn_ref?this.re.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":this.re.iconContent=se.preDefinedIconDataFromName(t.description),this.re.url=t.tags.website||"",this.re.phone=t.tags.phone||"",this.re.tooltipContent=t.description||"",this.re.popupContent=t.tags.name||"",t.tags["addr:street"]&&t.tags["addr:city"])this.re.address=(t.tags["addr:housenumber"]?t.tags["addr:housenumber"]+" ":"")+t.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.tags["addr:city"]+"</span>";else{const e=new je;e.createUI(),e.showInfo("Creating address");let s=null;try{s=await(new me).getAddressAsync([t.lat,t.lon])}catch(t){console.error(t)}e.close(),this.re.address=s.street,""!==s.city&&(this.re.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+s.city+"</span>")}this.osmSearchNoteDialog||""===this.re.iconContent?this.yo():this.Xo()}constructor(){}get osmSearchNoteDialog(){return null===this.Zo&&(this.Zo=t.osmSearch.showSearchNoteDialog),this.Zo}changeOsmSearchNoteDialog(){this.Zo=!this.osmSearchNoteDialog}newRouteNote(t,e){this.ae=tt.getRoute(t);const s=Y.getClosestLatLngDistance(this.ae,e);this.Jo(s.latLng),this.re.distance=s.distance,this.yo()}newSearchRouteNote(t){const e=tt.getNearestRouteData([t.lat,t.lon]);e.route?(this.Jo(e.latLngOnRoute),this.re.iconLatLng=[t.lat,t.lon],this.re.distance=e.distanceOnRoute,this.ae=e.route,this.Yo(t)):Rt.showError(k.getText("NoteEditor - No route was found"))}newSearchTravelNote(t){this.ae=null,this.Jo([t.lat,t.lon]),this.Yo(t)}newTravelNote(t){this.ae=null,this.Jo(t),this.yo()}editNote(t){this.Go=!1;const e=tt.getNoteAndRoute(t);this.ae=e.route,this.re=e.note,this.yo()}removeNote(t){const e=tt.getNoteAndRoute(t);e.route?(e.route.notes.remove(t),Bt.dispatch("updateitinerary")):(V.travel.notes.remove(t),Bt.dispatch("updatetravelnotes")),Bt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:m}),Bt.dispatch("roadbookupdate")}hideNotes(){let t=V.travel.notes.iterator;for(;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});if(m!==V.editedRouteObjId)for(t=V.travel.editedRoute.notes.iterator;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();const t=V.travel.notes.iterator;for(;!t.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)e.value.hidden||Bt.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){const e=tt.getNoteAndRoute(t).note,s=tt.getNearestRouteData(e.latLng);s.route&&(V.travel.notes.remove(t),e.distance=s.distance,e.latLng=s.latLngOnRoute,e.chainedDistance=s.route.chainedDistance,s.route.notes.add(e),s.route.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),Bt.dispatch("updateitinerary"),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate"))}detachNoteFromRoute(t){const e=tt.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=i.invalid,e.note.chainedDistance=i.defaultValue,V.travel.notes.add(e.note),Bt.dispatch("updateitinerary"),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate")}travelNoteDropped(t,e,s){V.travel.notes.moveTo(t,e,s),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate")}};class Ue{qo;$o;ae;static get Qo(){return"\n"}static get tn(){return"\n\t"}static get en(){return"\n\t\t"}static get sn(){return"\n\t\t\t"}static get rn(){return"\n\t\t\t\t"}an(){this.qo='<?xml version="1.0"?>'+Ue.Qo,this.qo+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}nn(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}hn(){const t=this.ae.wayPoints.iterator;for(;!t.done;)this.qo+=Ue.tn+'<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Ue.en+this.$o+Ue.en+"<name>"+this.nn(t.value.fullName)+"</name>"+Ue.tn+"</wpt>"}ln(){this.qo+=Ue.tn+"<rte>",this.qo+=Ue.en+"<name>"+this.nn(this.ae.computedName)+"</name>";const t=this.ae.itinerary.maneuvers.iterator;for(;!t.done;){const e=this.ae.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId);this.qo+=Ue.en+'<rtept lat="'+e.lat+'" lon="'+e.lng+'">'+Ue.sn+this.$o+Ue.sn+"<desc>"+this.nn(t.value.instruction)+"</desc>"+Ue.en+"</rtept>"}this.qo+=Ue.tn+"</rte>"}cn(){this.qo+=Ue.tn+"<trk>",this.qo+=Ue.en+"<name>"+this.nn(this.ae.computedName)+"</name>",this.qo+=Ue.en+"<trkseg>";const t=this.ae.itinerary.itineraryPoints.iterator;for(;!t.done;)this.qo+=Ue.sn+'<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Ue.rn+this.$o+Ue.rn+"<ele>"+t.value.elev+"</ele>"+Ue.sn+"</trkpt>";this.qo+=Ue.en+"</trkseg>",this.qo+=Ue.tn+"</trk>"}un(){this.qo+=Ue.Qo+"</gpx>"}vn(){let t=(""===V.travel.name?"":V.travel.name+" - ")+this.ae.computedName;""===t&&(t="TravelNote"),t+=".gpx",S.saveFile(t,this.qo,"application/xml")}constructor(){}routeToGpx(t){this.ae=tt.getRoute(t),this.ae&&(this.$o="<time>"+(new Date).toISOString()+"</time>",this.an(),this.hn(),this.ln(),this.cn(),this.un(),this.vn())}}class Fe{dn;pn;_n;constructor(t,s,i){this.dn="number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t?t:e.maxColorValue,this.pn="number"==typeof s&&e.maxColorValue>=s&&e.minColorValue<=s?s:e.maxColorValue,this._n="number"==typeof i&&e.maxColorValue>=i&&e.minColorValue<=i?i:e.maxColorValue}get red(){return this.dn}set red(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.dn=t)}get green(){return this.pn}set green(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.pn=t)}get blue(){return this._n}set blue(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this._n=t)}get cssColor(){return"#"+this.dn.toString(p).padStart(2,"0")+this.pn.toString(p).padStart(2,"0")+this._n.toString(p).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.dn=Number.parseInt(t.substr(1,2),p),this.pn=Number.parseInt(t.substr(3,2),p),this._n=Number.parseInt(t.substr(5,2),p)):"rgb"===t.substr(0,3)&&([this.dn,this.pn,this._n]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}clone(){return new Fe(this.dn,this.pn,this._n)}copyTo(t){t.red=this.dn,t.green=this.pn,t.blue=this._n}}class Ke{mn;constructor(t){this.mn=t}handleEvent(t){t.stopPropagation();const s=new Fe;s.red=Math.ceil(t.target.valueAsNumber*(e.maxColorValue/e.sliderMaxValue));for(let t=0;t<e.rowsNumber;++t){s.blue=t*e.deltaColor;for(let i=0;i<e.rowsNumber;++i)s.green=i*e.deltaColor,this.mn[e.rowsNumber*t+i].style["background-color"]=s.cssColor}}}class We{gn;wn;constructor(t,e){this.gn=t,this.wn=e}handleEvent(t){t.stopPropagation();const e=new Fe(Number.parseInt(this.wn.red.value),Number.parseInt(this.wn.green.value),Number.parseInt(this.wn.blue.value));this.gn.color=e}}class Ve{gn=null;constructor(t){this.gn=t}handleEvent(t){t.stopPropagation();const e=new Fe;e.cssColor=t.target.style["background-color"],this.gn.color=e}}class ze{dn;pn;_n;constructor(t,e,s){this.dn=t,this.pn=e,this._n=s}get red(){return this.dn}get green(){return this.pn}get blue(){return this._n}}class Ge{Nn;mn;wn;Tn;fn;yn;bn;In;Mn;Dn;En(){const t=et.create("div",null,this.Nn),s=new Fe(e.initialRed,e.minColorValue,e.minColorValue);this.In=new Ve(this);for(let i=0;i<e.rowsNumber;++i){const i=et.create("div",null,t);s.green=e.minColorValue;for(let t=0;t<e.cellsNumber;++t){const t=et.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},i);t.style["background-color"]=s.cssColor,t.addEventListener("click",this.In,!1),s.green+=e.deltaColor,this.mn.push(t)}s.blue+=e.deltaColor}}xn(){const t=et.create("div",null,this.Nn);this.Tn=et.create("input",{type:"range",value:Math.ceil(e.initialRed*(e.sliderMaxValue/e.maxColorValue)),min:0,max:e.sliderMaxValue,step:e.sliderStep},t),this.Dn=new Ke(this.mn),this.Tn.addEventListener("input",this.Dn,!1),this.Tn.focus()}Pn(t,s){et.create("text",{value:t},this.fn);return et.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:s,min:e.minColorValue,max:e.maxColorValue},this.fn)}Cn(){this.fn=et.create("div",null,this.Nn),this.wn=new ze(this.Pn(k.getText("ColorControl - Red"),this.bn.red),this.Pn(k.getText("ColorControl - Green"),this.bn.green),this.Pn(k.getText("ColorControl - Blue"),this.bn.blue)),this.Mn=new We(this,this.wn);for(const t in this.wn)this.wn[t].addEventListener("input",this.Mn,!1)}Ln(){this.yn=et.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this.Nn),this.yn.style["background-color"]=this.bn.cssColor}constructor(t){this.mn=[],this.bn=new Fe,this.bn.cssColor=t,this.Nn=et.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this.En(),this.xn(),this.Cn(),this.Ln()}destructor(){this.mn.forEach((t=>{t.removeEventListener("click",this.In,!1)})),this.In=null;for(const t in this.wn)this.wn[t].removeEventListener("input",this.Mn,!1);this.Mn=null,this.Tn.removeEventListener("input",this.Dn,!1),this.Dn=null}get HTMLElements(){return[this.Nn]}get cssColor(){return this.bn.cssColor}set color(t){this.wn.red.value=t.red,this.wn.green.value=t.green,this.wn.blue.value=t.blue,this.yn.style["background-color"]=t.cssColor,t.copyTo(this.bn)}}class Ze extends mt{ae;gn;kn;Sn;An;Rn;static get On(){return 1}static get Bn(){return 40}jn(){const t=et.create("div",{textContent:k.getText("RoutePropertiesDialog - Name")}),e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this.kn=et.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this.ae.computedName},e),[t,e]}Hn(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return et.create("text",{value:k.getText("RoutePropertiesDialog - Width")},et.create("span",null,t)),this.Sn=et.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this.ae.width,min:Ze.On,max:Ze.Bn},t),t}Un(){const e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});et.create("text",{value:k.getText("RoutePropertiesDialog - Linetype")},et.create("span",null,e)),this.An=et.create("select",null,e);const s=t.route.dashChoices;return s.forEach((t=>{this.An.add(et.create("option",{text:t.text}))})),this.An.selectedIndex=this.ae.dashArray<s.length?this.ae.dashArray:0,e}Fn(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return et.create("text",{value:k.getText("RoutePropertiesDialog - Chained route")},et.create("span",null,t)),this.Rn=et.create("input",{type:"checkbox",checked:this.ae.chain},t),t}Kn(){return et.create("div",{textContent:k.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(t){super(),this.ae=t,this.gn=new Ge(t.color)}onCancel(){this.gn.destructor(),super.onCancel()}onOk(){this.ae.color=this.gn.cssColor,this.ae.computedName!==this.kn.value&&(this.ae.name=this.kn.value),this.ae.width=parseInt(this.Sn.value),this.ae.chain=this.Rn.checked,this.ae.dashArray=this.An.selectedIndex,this.gn.destructor(),super.onOk()}get title(){return k.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this.jn(),this.Hn(),this.Un(),this.Fn(),this.Kn(),this.gn.HTMLElements)}}class Xe{constructor(){}paperWidth=0;paperHeight=0;borderWidth=0;zoomFactor=0;pageBreak=!1;printNotes=!1}class Je extends mt{Wn;Vn;zn;Gn;Zn;Xn;static get Jn(){return 15}Yn(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:k.getText("PrintRouteMapDialog - Paper width")},e),this.Wn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),this.Wn.value=t.printRouteMap.paperWidth,et.create("text",{value:k.getText("PrintRouteMapDialog - Paper width units")},e),e}qn(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:k.getText("PrintRouteMapDialog - Paper height")},e),this.Vn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.paperHeight},e),et.create("text",{value:k.getText("PrintRouteMapDialog - Paper height units")},e),e}$n(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:k.getText("PrintRouteMapDialog - Border width")},e),this.zn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.borderWidth},e),et.create("text",{value:k.getText("PrintRouteMapDialog - Border width units")},e),e}Qn(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:k.getText("PrintRouteMapDialog - Zoom factor")},e),this.Xn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(t.printRouteMap.zoomFactor,Je.Jn),min:V.map.getMinZoom(),max:Math.min(V.map.getMaxZoom(),Je.Jn)},e),e}th(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.Gn=et.create("input",{type:"checkbox",checked:t.printRouteMap.pageBreak},e),et.create("text",{value:k.getText("PrintRouteMapDialog - Page break")},e),e}eh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.Zn=et.create("input",{type:"checkbox",checked:t.printRouteMap.printNotes},e),et.create("text",{value:k.getText("PrintRouteMapDialog - Print notes")},e),e}constructor(){super()}onOk(){const t=new Xe;t.paperWidth=parseInt(this.Wn.value),t.paperHeight=parseInt(this.Vn.value),t.borderWidth=parseInt(this.zn.value),t.zoomFactor=parseInt(this.Xn.value),t.pageBreak=this.Gn.checked,t.printNotes=this.Zn.checked,Object.freeze(t),super.onOk(t)}get contentHTMLElements(){return[this.Yn(),this.qn(),this.$n(),this.Qn(),this.th(),this.eh()]}get title(){return k.getText("PrintRouteMapDialog - Print")}}class Ye{le;constructor(t){this.le=t}handleEvent(t){this.le.dragStartX=t.screenX,this.le.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class qe{le;constructor(t){this.le=t}handleEvent(t){const e=t.target.parentNode;this.le.dialogX+=t.screenX-this.le.dragStartX,this.le.dialogY+=t.screenY-this.le.dragStartY,this.le.dialogX=Math.min(Math.max(this.le.dialogX,v),V.map.getContainer().clientWidth-e.clientWidth-v),this.le.dialogY=Math.max(this.le.dialogY,v);const s=V.map.getContainer().clientHeight-Math.max(this.le.dialogY,0)-v;e.style.top=String(this.le.dialogY)+"px",e.style.left=String(this.le.dialogX)+"px",e.style["max-height"]=String(s)+"px"}}class $e{sh=[];ih(t){this.sh.push(t.latLng),this.sh.push(t.iconLatLng)}rh(t){t.itinerary.itineraryPoints.forEach((t=>this.sh.push(t.latLng))),t.notes.forEach((t=>this.ih(t)))}constructor(){}zoomToLatLng(t){Bt.dispatch("zoomto",{latLng:t})}zoomToManeuver(t){const e=V.travel.editedRoute.itinerary.maneuvers.getAt(t).itineraryPointObjId,s=V.travel.editedRoute.itinerary.itineraryPoints.getAt(e).latLng;Bt.dispatch("zoomto",{latLng:s})}zoomToNote(t){this.sh=[],this.ih(tt.getNoteAndRoute(t).note),Bt.dispatch("zoomto",{geometry:[this.sh]})}zoomToRoute(t){this.sh=[],this.rh(tt.getRoute(t)),Bt.dispatch("zoomto",{geometry:[this.sh]})}zoomToTravel(){this.sh=[],V.travel.routes.forEach((t=>this.rh(t))),m!==V.travel.editedRouteObjId&&this.rh(V.travel.editedRoute),V.travel.notes.forEach((t=>this.ih(t))),Bt.dispatch("zoomto",{geometry:[this.sh]})}zoomToPoi(t){Bt.dispatch("zoomto",t)}}class Qe extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(k.getText("ProfileContextMenu - Add a note to the route at this point"),!0,(()=>He.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new qt(k.getText("ProfileContextMenu - Zoom to this point"),!0,(()=>(new $e).zoomToLatLng(this.eventData.latLng)))]}}class ts{constructor(){}getlatLngElevOnRouteAtMousePosition(t){const e=tt.getRoute(Number.parseInt(t.currentTarget.dataset.tanObjId)),s=t.currentTarget.getBoundingClientRect(),i=(t.clientX-s.x-Ht.PROFILE_MARGIN/(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*s.width)/(Ht.PROFILE_WIDTH/(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*s.width)*e.distance;return 0<i&&i<e.distance?Y.getLatLngElevAtDist(e,i):null}}class es extends ts{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();const e=this.getlatLngElevOnRouteAtMousePosition(t);e&&(t.latlng={lat:e.latLng[0],lng:e.latLng[1]},new Qe(t).show())}}class ss{constructor(){}handleEvent(t){t.preventDefault(),t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.currentTarget.dataset.tanMarkerObjId)})}}class is extends ts{ah;oh;nh;hh;lh;uh;dh;ph(t,e){const s=document.createElementNS(N,"text");return s.appendChild(document.createTextNode(t)),s.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),s.setAttributeNS(null,"x",this.uh),s.setAttributeNS(null,"y",e),s.setAttributeNS(null,"text-anchor",this.lh),this.dh.appendChild(s),s}constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.dh=t.currentTarget;const e=this.getlatLngElevOnRouteAtMousePosition(t);if(e){const s=Number.parseInt(this.dh.dataset.tanMarkerObjId);Bt.dispatch("removeobject",{objId:s}),Bt.dispatch("additinerarypointmarker",{objId:s,latLng:e.latLng}),this.ah&&this.dh.contains(this.ah)?(this.dh.removeChild(this.ah),this.dh.removeChild(this.oh),this.dh.removeChild(this.nh),this.dh.removeChild(this.hh)):(this.ah=null,this.oh=null,this.nh=null,this.hh=null);const i=this.dh.getBoundingClientRect();this.uh=(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*(t.clientX-i.x)/i.width;const r=Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT;this.ah=document.createElementNS(N,"polyline"),this.ah.setAttributeNS(null,"points",String(this.uh)+","+Ht.PROFILE_MARGIN+" "+this.uh+","+r),this.ah.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.dh.appendChild(this.ah);const a=tt.getRoute(Number.parseInt(this.dh.dataset.tanObjId));this.lh=e.distance>a.distance/2?"end":"start",this.uh+=e.distance>a.distance/2?-Ht.X_DELTA_TEXT:Ht.X_DELTA_TEXT,this.oh=this.ph(S.formatDistance(e.distance),Ht.PROFILE_MARGIN+Ht.Y_DELTA_TEXT),this.nh=this.ph("Alt. "+e.elev.toFixed(0)+" m.",Ht.PROFILE_MARGIN+2*Ht.Y_DELTA_TEXT),this.hh=this.ph("Pente "+e.ascent.toFixed(0)+" % ",Ht.PROFILE_MARGIN+3*Ht.Y_DELTA_TEXT)}}}class rs extends class{le;Ce;Re;_h;mh;ze;Ge;ts(){this.Ce=et.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}es(){this.Re=et.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this.Ce),this.Re.addEventListener("dragstart",this.ze,!1),this.Re.addEventListener("dragend",this.Ge,!1),et.create("div",{textContent:"‚ùå",className:"TravelNotes-FloatWindow-CancelButton",title:k.getText("FloatWindow - Close")},this.Re).addEventListener("click",(()=>this.close()),!1)}ss(){this._h=et.create("div",null,this.Ce)}rs(){this.mh=et.create("div",null,this.Ce)}constructor(){this.le=new pt,this.ze=new Ye(this.le),this.Ge=new qe(this.le),this.ts(),this.es(),this.ss(),this.rs()}close(){this.Re.removeEventListener("dragstart",this.ze,!1),this.Re.removeEventListener("dragend",this.Ge,!1),this.ze=null,this.Ge=null,document.body.removeChild(this.Ce)}update(){}get header(){return this._h}get content(){return this.mh}}{wi=null;gh=null;ae=null;wh=null;Nh=null;Th=null;fh=f.nextObjId;yh(){this.wi&&(this.wi.removeEventListener("contextmenu",this.wh,!1),this.wi.removeEventListener("mousemove",this.Nh,!1),this.wi.removeEventListener("mouseleave",this.Th,!1),Bt.dispatch("removeobject",{objId:this.fh}),this.content.removeChild(this.gh),this.content.removeChild(this.wi)),this.wi=null,this.gh=null}constructor(){super(),this.wh=new es,this.Nh=new is,this.Th=new ss}close(){this.yh(),Bt.dispatch("profileclosed",{objId:this.ae.objId}),super.close()}update(t){this.yh(),this.ae=t,this.wi=(new Ht).createSvg(this.ae),this.wi.dataset.tanObjId=t.objId,this.wi.dataset.tanMarkerObjId=this.fh,this.header.textContent=k.getText("ProfileWindow - Profile {name}",{name:this.ae.computedName}),this.content.appendChild(this.wi),this.wi.addEventListener("contextmenu",this.wh,!1),this.wi.addEventListener("mousemove",this.Nh,!1),this.wi.addEventListener("mouseleave",this.Th,!1),this.gh=et.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:k.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this.ae.itinerary.ascent.toFixed(0),descent:this.ae.itinerary.descent.toFixed(0),distance:S.formatDistance(this.ae.distance)})}),this.content.appendChild(this.gh)}}class as{ae;bh;Ih;get Mh(){return t.route.elev.smoothPoints}Dh(){this.Ih=[],this.Ih.push({distance:0,elev:this.ae.itinerary.itineraryPoints.first.elev,smoothElev:this.ae.itinerary.itineraryPoints.first.elev});const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=0,s=t.value.distance,i=t.value.elev;t.done;let r=this.bh;for(;r<this.ae.distance;){if(s<r)for(e=s,i=t.value.elev;s<r;)s+=t.value.distance,t.done;const a=i+(r-e)*((t.value.elev-i)/(s-e));this.Ih.push({distance:r,elev:a,smoothElev:0}),r+=this.bh}this.Ih.push({distance:this.ae.distance,elev:this.ae.itinerary.itineraryPoints.last.elev,smoothElev:this.ae.itinerary.itineraryPoints.last.elev})}Eh(){let t=(this.Ih[this.Mh-1].elev-this.Ih[0].elev)/(this.Mh-1),e=0;for(e=0;e<this.Mh;e++)this.Ih[e].smoothElev=this.Ih[0].elev+t*e;for(e=this.Mh;e<this.Ih.length-this.Mh;e++){let t=0;for(let s=e-this.Mh;s<=e+this.Mh;s++)t+=this.Ih[s].elev;this.Ih[e].smoothElev=t/(2*this.Mh+1)}e--;const s=(this.Ih[e+this.Mh].smoothElev-this.Ih[e].smoothElev)/this.Mh;let i=this.Ih[e].smoothElev,r=1;for(e++;e<this.Ih.length-1;r++,e++)this.Ih[e].smoothElev=i+s*r}xh(){const e=this.ae.itinerary.itineraryPoints.iterator;let s=0;for(;!e.done;)s+=e.next?Math.abs(e.value.elev-e.next.elev):0;this.bh=Math.floor(Math.min(t.route.elev.smoothCoefficient*this.ae.distance/s,this.ae.distance/(3*this.Mh)))}Ph(){const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=t.value.distance;for(;!t.done;){const s=this.Ih[Math.floor(e/this.bh)],i=this.Ih[Math.ceil(e/this.bh)];if(s&&i){const r=e-s.distance,a=(i.elev-s.elev)/(i.distance-s.distance);t.value.elev=s.elev+r*a}e+=t.value.distance}}constructor(){}smooth(t){this.ae=t,this.xh(),this.Dh(),this.Eh(),this.Ph()}}const os=new class{Ch=new Map;constructor(){}createProfile(e){const s=this.Ch.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new as).smooth(e);let i=0,r=0,a=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let e=t.elev-a;0>e?r-=e:i+=e,a=t.elev})),e.itinerary.ascent=i,e.itinerary.descent=r,s&&s.update(e)}else s&&s.close()}updateProfile(t,e){const s=this.Ch.get(t);s&&(this.Ch.delete(t),e&&e.itinerary.hasProfile?(s.update(e),this.Ch.set(e.objId,s)):s.close())}deleteProfile(t){const e=this.Ch.get(t);e&&e.close()}deleteAllProfiles(){this.Ch.forEach((t=>t.close()))}showProfile(t){let e=this.Ch.get(t);e||(e=new rs);const s=tt.getRoute(t);e.update(s),this.Ch.set(t,e)}onProfileClosed(t){this.Ch.delete(t)}};class ns{Ot;Pr;constructor(t,e){this.Ot=t,this.Pr=e}get width(){return this.Ot}get height(){return this.Pr}}class hs{constructor(){}bottomLeft;upperRight;entryPoint;exitPoint}class ls{Lh;ae;kh;Sh(t,e,s){return e.lng===s.lng?new z(e.lat>s.lat?t.bottomLeft.lat:t.upperRight.lat,e.lng):e.lat===s.lat?new z(e.lat,e.lng<s.lng?t.upperRight.lng:t.bottomLeft.lng):null}Ah(t,e){const s=1e-6;return e.lat-t.bottomLeft.lat<s||t.upperRight.lat-e.lat<s||e.lng-t.bottomLeft.lng<s||t.upperRight.lng-e.lng<s?z.clone(e):null}Rh(t,e,s){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){const t=Math.min(Math.abs(this.kh.height/(s.lat-e.lat)),Math.abs(this.kh.width/(s.lng-e.lng)));return new z(e.lat+t*(s.lat-e.lat),e.lng+t*(s.lng-e.lng))}return null}Oh(t,e,s){let i=this.Rh(t,e,s);if(i)return i;if(i=this.Ah(t,e),i)return i;if(i=this.Sh(t,e,s),i)return i;const r=(e.lat-s.lat)/(e.lng-s.lng),a=e.lat-r*e.lng;if(i=new z(r*t.upperRight.lng+a,t.upperRight.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng<s.lng)return i;if(i=new z(t.upperRight.lat,(t.upperRight.lat-a)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat<s.lat)return i;if(i=new z(r*t.bottomLeft.lng+a,t.bottomLeft.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng>s.lng)return i;if(i=new z(t.bottomLeft.lat,(t.bottomLeft.lat-a)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat>s.lat)return i;throw new Error("intermediate point not found")}Bh(){this.Lh=[];const t=this.ae.itinerary.itineraryPoints.iterator;let e=t.done,s=new hs;s.bottomLeft=z.clone(t.value),s.upperRight=z.clone(t.value),s.entryPoint=z.clone(t.value);let i=t.value,r=z.clone(t.value);e=t.done;let a=t.value;for(;!e;){const o=new hs;o.bottomLeft=new z(Math.min(s.bottomLeft.lat,a.lat),Math.min(s.bottomLeft.lng,a.lng)),o.upperRight=new z(Math.max(s.upperRight.lat,a.lat),Math.max(s.upperRight.lng,a.lng)),o.entryPoint=z.clone(s.entryPoint),this.kh.height>o.upperRight.lat-o.bottomLeft.lat&&this.kh.width>o.upperRight.lng-o.bottomLeft.lng?(s=o,i=t.value,r=z.clone(t.value),e=t.done,a=t.value,e&&(s.exitPoint=r,this.Lh.push(Object.freeze(s)))):(r=this.Oh(s,i,a),s.bottomLeft=new z(Math.min(s.bottomLeft.lat,r.lat),Math.min(s.bottomLeft.lng,r.lng)),s.upperRight=new z(Math.max(s.upperRight.lat,r.lat),Math.max(s.upperRight.lng,r.lng)),s.exitPoint=r,this.Lh.push(Object.freeze(s)),s=new hs,s.bottomLeft=z.clone(r),s.upperRight=z.clone(r),s.entryPoint=z.clone(r))}}constructor(t,e){this.ae=t,this.kh=e,this.Bh()}get printViews(){return this.Lh}}class cs{xe;Bt;jh;constructor(t){if("string"!=typeof t?.text||"string"!=typeof t?.color||"string"!=typeof t?.backgroundColor)throw new Error("invalid toolbar for layer");this.xe=L.sanitizeToJsString(t.text),this.Bt=L.sanitizeToColor(t.color),this.jh=L.sanitizeToColor(t.backgroundColor)}get text(){return this.xe}get color(){return this.Bt}get backgroundColor(){return this.jh}}class us{rt=null;Hh=null;N=null;Uh=null;Fh=null;Kh=null;Wh=null;Vh=null;te=null;zh=!1;Gh=null;Zh=null;Xh(){if("string"!=typeof this.Zh?.name)throw new Error("invalid name for layer");this.rt=L.sanitizeToJsString(this.Zh.name)}Jh(){if("wms"!==this.Zh?.service&&"wmts"!==this.Zh?.service)throw new Error("invalid service for layer "+this.rt);this.Hh=this.Zh.service}Yh(){if("string"!=typeof this.Zh?.url)throw new Error("invalid url for layer "+this.rt);this.N=this.Zh.url}qh(){if("wms"===this.Hh){if("string"!=typeof this.Zh?.wmsOptions?.layers||"string"!=typeof this.Zh?.wmsOptions?.format||"boolean"!=typeof this.Zh?.wmsOptions?.transparent)throw new Error("invalid wmsOptions for layer "+this.rt);this.Uh=this.Zh.wmsOptions,this.Uh.layers=L.sanitizeToJsString(this.Uh.layers),this.Uh.format=L.sanitizeToJsString(this.Uh.format)}}$h(){try{this.Zh.bounds&&"number"==typeof this.Zh.bounds[0][0]&&"number"==typeof this.Zh.bounds[0][1]&&"number"==typeof this.Zh.bounds[1][0]&&"number"==typeof this.Zh.bounds[1][1]&&(this.Fh=this.Zh.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.rt)}}Qh(){if(this.Zh.minZoom){if("number"!=typeof this.Zh.minZoom)throw new Error("invalid minZoom for layer "+this.rt);this.Kh=this.Zh.minZoom}if(this.Zh.maxZoom){if("number"!=typeof this.Zh.maxZoom)throw new Error("invalid maxZoom for layer "+this.rt);this.Wh=this.Zh.maxZoom}}tl(){this.Vh=new cs(this.Zh.toolbar)}el(){if("string"!=typeof this.Zh?.providerName)throw new Error("invalid providerName for layer "+this.rt);this.te=L.sanitizeToJsString(this.Zh.providerName)}sl(){if("boolean"!=typeof this.Zh.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.rt);this.zh=this.Zh.providerKeyNeeded}il(){if(""===this.Zh.attribution)this.Gh="";else{if("string"!=typeof this.Zh?.attribution)throw new Error("invalid attribution for map layer "+this.rt);this.Gh=L.sanitizeToHtmlString(this.Zh.attribution).htmlString}}constructor(t){this.Zh=t,this.Xh(),this.Jh(),this.Yh(),this.qh(),this.$h(),this.Qh(),this.tl(),this.el(),this.sl(),this.il(),this.Zh=null}get name(){return this.rt}get service(){return this.Hh}get url(){return this.N}get wmsOptions(){return this.Uh}get bounds(){return this.Fh}get minZoom(){return this.Kh}get maxZoom(){return this.Wh}get toolbarButtonData(){return this.Vh}get providerName(){return this.te}get providerKeyNeeded(){return this.zh}get attribution(){return this.Gh}}const vs=new class{rl;al;ol;constructor(){this.rl=new Map,this.ol=!1,this.al=new us({service:"wmts",url:"https://{s}.tile.osm.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.rl.set(this.al.name,this.al)}getMapLayer(t){let e=this.rl.get(t)||this.al;return e.providerKeyNeeded&&(jt.hasKey(e.providerName.toLowerCase())||(e=this.al)),e}forEach(t){this.rl.forEach(t)}addMapLayers(t){this.ol||(t.forEach((t=>{const e=new us(t);this.rl.get(e.name)||this.rl.set(e.name,e)})),this.ol=!0)}get defaultMapLayer(){return this.al}};class ds{constructor(){}handleEvent(){window.print()}}class ps{nl=null;constructor(t){this.nl=t}handleEvent(){this.nl.onAfterPrint(),this.nl=null}}class _s{hl;ae;Lh;ll;cl;Ae;ul;vl;dl;pl;_l;onAfterPrint(){this.vl.forEach((t=>document.body.removeChild(t))),this.vl.length=0,this.cl.removeEventListener("click",this.pl,!1),this.Ae.removeEventListener("click",this._l,!1),document.body.removeChild(this.ll);const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");V.map.invalidateSize(!1),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),window.removeEventListener("afterprint",this._l,!0),this._l=null,this.pl=null}ml(){const t=vs.getMapLayer(V.travel.layerName),e=jt.getUrl(t),s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);return s.options.attribution=L.sanitizeToHtmlString(' ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| ¬© <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,s}gl(){const t=[];return this.ae.notes.forEach((e=>{const s=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),i=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:s,draggable:!0});t.push(i)})),t}wl(e){this.ul++;const s="TravelNotes-RouteViewDiv"+this.ul,i=document.createElement("div");i.className="TravelNotes-routeViewDiv",i.id=s,document.body.appendChild(i),this.vl.push(i),this.hl.pageBreak&&i.classList.add("TravelNotes-PrintPageBreak"),i.style.width=String(this.hl.paperWidth)+"mm",i.style.height=String(this.hl.paperHeight)+"mm";const r=this.hl.printNotes?this.gl():[];r.push(this.ml()),r.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),r.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),r.push(this.dl),window.L.map(s,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.hl.zoomFactor,minZoom:this.hl.zoomFactor,maxZoom:this.hl.zoomFactor,layers:r})}Nl(){this.ll=et.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.cl=et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("PrintPageBuilder - Print"),textContent:"üñ®Ô∏è"},this.ll),this.cl.addEventListener("click",this.pl,!1),this.Ae=et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("PrintPageBuilder - Cancel print"),textContent:"‚ùå"},this.ll),this.Ae.addEventListener("click",this._l,!1)}constructor(t,e,s){this.ae=t,this.Lh=e,this.hl=s,this.ul=0,this.vl=[],this.pl=new ds,this._l=new ps(this)}preparePage(){const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===V.travel.name?"maps":V.travel.name+" - "+this.ae.computedName+" - maps",this.Nl(),window.addEventListener("afterprint",this._l,!0);const e=[],s=this.ae.itinerary.itineraryPoints.iterator;for(;!s.done;)e.push(s.value.latLng);this.dl=window.L.polyline(e,{color:this.ae.color,weight:this.ae.width}),this.ul=0,this.Lh.forEach((t=>this.wl(t)))}}class ms{Tl=0;static get fl(){return 256}yl(t){const e=et.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm";const s=Y.screenCoordToLatLng(0,0),i=Y.screenCoordToLatLng(e.clientWidth,e.clientHeight);this.Tl=Math.ceil(e.clientWidth/ms.fl)*Math.ceil(e.clientHeight/ms.fl),document.body.removeChild(e);const r=V.map.getZoomScale(V.map.getZoom(),t.zoomFactor);return new ns(Math.abs(s[1]-i[1])*r,Math.abs(s[0]-i[0])*r)}constructor(){}print(e,s){const i=tt.getRoute(s);if(!i)return;const r=new ls(i,this.yl(e));if(t.printRouteMap.maxTiles<r.printViews.length*this.Tl)return void Rt.showError(k.getText("RoutePrinter - The maximum of allowed pages is reached."));new _s(i,r.printViews,e).preparePage()}}const gs=new class{constructor(){}addRoute(){const t=new F;V.travel.routes.add(t),this.chainRoutes(),c.editedChanged===V.travel.editedRoute.editionStatus?(Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate")):this.editRoute(t.objId)}editRoute(t){const e=tt.getRoute(t),s=e.itinerary.provider,i=V.providers.get(s.toLowerCase());if(s&&""!==s&&(!i||i.providerKeyNeeded&&!jt.hasKey(s)))return void Rt.showError(k.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:s}));m!==V.editedRouteObjId&&this.cancelEdition(),s&&""!==s&&Bt.dispatch("setprovider",{provider:s});const r=e.itinerary.transitMode;r&&""!==r&&Bt.dispatch("settransitmode",{transitMode:r}),V.travel.editedRoute=new F,e.editionStatus=c.editedNoChange,V.travel.editedRoute.jsonObject=e.jsonObject,V.editedRouteObjId=e.objId,V.travel.editedRoute.hidden=!1,e.hidden=!1,os.updateProfile(V.editedRouteObjId,V.travel.editedRoute),this.chainRoutes(),Bt.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:V.travel.editedRoute.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("showitinerary"),Bt.dispatch("setrouteslist")}removeRoute(t){let e=t;e!==V.editedRouteObjId&&e!==V.travel.editedRoute.objId||(e=V.editedRouteObjId,this.cancelEdition()),Bt.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:m}),V.travel.routes.remove(e),os.deleteProfile(e),this.chainRoutes(),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist")}saveGpx(t){(new Ue).routeToGpx(t)}chainRoutes(){const t=V.travel.routes.iterator;let e=i.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=i.defaultValue;const s=t.value.notes.iterator;for(;!s.done;)s.value.chainedDistance=t.value.chainedDistance;if(t.value.objId===V.editedRouteObjId){V.travel.editedRoute.chainedDistance=V.travel.editedRoute.chain?t.value.chainedDistance:i.defaultValue;const e=V.travel.editedRoute.notes.iterator;for(;!e.done;)e.value.chainedDistance=V.travel.editedRoute.chainedDistance}}}saveEdition(){const t=new F;t.jsonObject=V.travel.editedRoute.jsonObject,V.travel.routes.replace(V.editedRouteObjId,t),V.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){const t=tt.getRoute(V.editedRouteObjId);t.editionStatus=c.notEdited,os.updateProfile(V.travel.editedRoute.objId,t),Bt.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.editedRouteObjId}),V.editedRouteObjId=m,V.travel.editedRoute=new F,this.chainRoutes(),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary")}routeProperties(t){const e=tt.getRoute(t);new Ze(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&Bt.dispatch("routepropertiesupdated",{routeObjId:e.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist"),Bt.dispatch("updateitinerary")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new Je).show().then((e=>(new ms).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){tt.getRoute(t).hidden=!1,Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t}),Bt.dispatch("setrouteslist")}hideRoute(t){tt.getRoute(t).hidden=!0,Bt.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:m}),Bt.dispatch("setrouteslist")}showRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId}));Bt.dispatch("setrouteslist")}hideRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===V.editedRouteObjId||(t.value.hidden=!0,Bt.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:m}));Bt.dispatch("setrouteslist")}};class ws extends mt{bl;Qr;Il;kn;async handleEvent(e){if(e.stopPropagation(),!t.wayPoint.reverseGeocoding)return;this.showWait();const s=await(new me).getAddressAsync(this.bl.latLng);this.hideWait(),t.wayPoint.geocodingIncludeName&&(this.kn.value=s.name);let i=s.street;""!==s.city&&(i+=" "+s.city),this.Qr.value=i}Ml(){const t=et.create("div");this.Il=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:k.getText("WayPointPropertiesDialog - Reset address"),textContent:"üîÑ"},t),this.Il.addEventListener("click",this,!1),et.create("text",{value:k.getText("WayPointPropertiesDialog - Address")},t);const e=et.create("div");return this.Qr=et.create("input",{type:"text",value:this.bl.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}Dl(){const t=et.create("div",{textContent:k.getText("WayPointPropertiesDialog - Name")}),e=et.create("div");return this.kn=et.create("input",{type:"text",value:this.bl.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}constructor(t){super(),this.bl=t}onCancel(){this.Il.removeEventListener("click",this,!1),super.onCancel()}onOk(){this.bl.address=this.Qr.value,this.bl.name=this.kn.value,this.Il.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this.Dl(),this.Ml())}get title(){return k.getText("WayPointPropertiesDialog - Waypoint properties")}}const Ns=new class{El;xl;Pl(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;for(e.done,s.done,s.value.distance=i.defaultValue,s.done,t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=i.defaultValue),s.done)}Cl(t){this.El=!1,t instanceof Error?(console.error(t),Rt.showError(t.message)):Rt.showError("A network error occurs when calling the provider")}Ll(){if(this.El=!1,this.Pl(V.travel.editedRoute),"circle"!==V.travel.editedRoute.itinerary.transitMode){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng).latLng}const t=V.travel.editedRoute.notes.iterator;for(;!t.done;){const e=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng);t.value.latLng=e.latLng,t.value.distance=e.distance}gs.chainRoutes(),V.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.xl&&(new $e).zoomToRoute(V.travel.editedRoute.objId),os.createProfile(V.travel.editedRoute),Bt.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.travel.editedRoute.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("showitinerary"),Bt.dispatch("setrouteslist")}constructor(){}startRouting(){if(!this.El&&V.travel.editedRoute.haveValidWayPoints()){this.xl=0===V.travel.editedRoute.itinerary.itineraryPoints.length,this.El=!0;const t=V.providers.get(V.routing.provider.toLowerCase());V.travel.editedRoute.itinerary.provider=t.name,V.travel.editedRoute.itinerary.transitMode=V.routing.transitMode,t.getPromiseRoute(V.travel.editedRoute).then((()=>this.Ll())).catch((()=>this.Cl()))}}};const Ts=new class{async kl(e){if(!t.wayPoint.reverseGeocoding)return Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),void Bt.dispatch("roadbookupdate");const s=await(new me).getAddressAsync(e.latLng);V.travel.editedRoute.editionStatus=c.editedChanged,e.address=s.street,""!==s.city&&(e.address+=" "+s.city),e.name="",t.wayPoint.geocodingIncludeName&&(e.name=s.name),Bt.dispatch("setrouteslist"),Bt.dispatch("updateitinerary"),Bt.dispatch("roadbookupdate")}constructor(){}addWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=new O;e.latLng=t,V.travel.editedRoute.wayPoints.add(e),this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.last,letter:V.travel.editedRoute.wayPoints.length-2}),V.travel.editedRoute.wayPoints.swap(e.objId,!0),Ns.startRouting()}addWayPointOnRoute(t,e){const s=Y.getClosestLatLngDistance(V.travel.editedRoute,t).distance;V.travel.editedRoute.editionStatus=c.editedChanged;const i=new O;i.latLng=e;let r="";const a=V.travel.editedRoute.wayPoints.iterator;for(;!a.done;){if(s<Y.getClosestLatLngDistance(V.travel.editedRoute,a.value.latLng).distance){r=String(a.index),V.travel.editedRoute.wayPoints.add(i),V.travel.editedRoute.wayPoints.moveTo(i.objId,a.value.objId,!0),this.kl(i),Bt.dispatch("addwaypoint",{wayPoint:i,letter:r}),Ns.startRouting();break}}}reverseWayPoints(){V.travel.editedRoute.editionStatus=c.editedChanged;let t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});for(V.travel.editedRoute.wayPoints.reverse(),t=V.travel.editedRoute.wayPoints.iterator;!t.done;)Bt.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":String(t.index)});Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate"),Ns.startRouting()}removeWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,Bt.dispatch("removeobject",{objId:t}),V.travel.editedRoute.wayPoints.remove(t),Ns.startRouting()}setStartPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=V.travel.editedRoute.wayPoints.first;e.latLng=t,this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:e,letter:"A"}),Ns.startRouting()}setEndPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=V.travel.editedRoute.wayPoints.last;e.latLng=t,this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:e,letter:"B"}),Ns.startRouting()}wayPointDragEnd(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=V.travel.editedRoute.wayPoints.getAt(t.target.objId),s=t.target.getLatLng();e.latLng=[s.lat,s.lng],this.kl(e),Ns.startRouting()}wayPointProperties(t){const e=V.travel.editedRoute.wayPoints.getAt(t);new ws(e).show().then((()=>{Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class fs extends mt{constructor(t){super(t)}get contentHTMLElements(){return[et.create("div",{textContent:this.options.text||""})]}get title(){return this.options.title||""}}class ys{ae=null;Sl=0;Al(t){const e=new U;for(const s in t)e[s]=t[s];e.iconLatLng=e.latLng,e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,e.chainedDistance=this.ae.chainedDistance,this.ae.notes.add(e),Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.objId})}async Rl(){const t=new je;t.createUI();const e=new Ie,s=this.ae.itinerary.maneuvers.iterator;for(;!s.done;){t.showInfo(k.getText("NoteEditor - Creating note",{noteNumber:s.index+1,notesLength:this.Sl}));const i=this.ae.itinerary.itineraryPoints.getAt(s.value.itineraryPointObjId).latLng,r=await e.getIconAndAdressAsync(i,this.ae);r?this.Al(r):console.error("An error occurs when creating the svg icon "+s.index)}this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("updateitinerary"),Bt.dispatch("roadbookupdate"),t.close()}constructor(){}addAllManeuverNotes(e){this.ae=tt.getRoute(e),this.Sl=this.ae.itinerary.maneuvers.length,t.note.maxManeuversNotes<this.Sl?Rt.showError(k.getText("NoteEditor - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:this.Sl,maxManeuversNotes:t.note.maxManeuversNotes})):new fs({title:k.getText("NoteEditor - Add a note for each maneuver"),text:k.getText("NoteEditor - Add a note for each maneuver. Are you sure?",{noteLength:this.Sl}),secondButtonText:"‚ùå"}).show().then((()=>this.Rl())).catch((t=>{t instanceof Error&&console.error(t)}))}}class bs extends Qt{ae=null;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getRoute(this.eventData.targetObjId))}get menuItems(){return[new qt(k.getText("RouteContextMenu - Edit this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId&&c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>gs.editRoute(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Delete this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId||c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>gs.removeRoute(this.eventData.targetObjId))),new qt(k.getText(this.ae.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),this.ae.hidden||V.travel.editedRoute.objId!==this.eventData.targetObjId,(()=>{this.ae.hidden?gs.showRoute(this.eventData.targetObjId):gs.hideRoute(this.eventData.targetObjId)})),new qt(k.getText("RouteContextMenu - Properties"),!this.ae.hidden,(()=>gs.routeProperties(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Zoom to route"),!this.ae.hidden,(()=>(new $e).zoomToRoute(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - View the elevation"),this.ae.itinerary.hasProfile,(()=>os.showProfile(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Print route map"),t.printRouteMap.isEnabled,(()=>gs.printRouteMap(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Save this route in a GPX file"),0<this.ae.itinerary.itineraryPoints.length,(()=>gs.saveGpx(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Invert waypoints"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>Ts.reverseWayPoints())),new qt(k.getText("RouteContextMenu - Add a note on the route"),!this.eventData.haveParentNode,(()=>He.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new qt(k.getText("RouteContextMenu - Create a note for each route maneuver"),!this.ae.hidden,(()=>(new ys).addAllManeuverNotes(this.eventData.targetObjId))),new qt(k.getText("RouteContextMenu - Save modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>gs.saveEdition())),new qt(k.getText("RouteContextMenu - Cancel modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>gs.cancelEdition()))]}}class Is{static handleEvent(t){const e=tt.getRoute(t.target.objId);let s=Y.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;s+=e.chainedDistance,s=S.formatDistance(s);const i=V.mapObjects.get(t.target.objId);i.closeTooltip();let r=e.computedName;V.travel.readOnly||(r+=0===r.length?"":" - ",r+=s),i.setTooltipContent(r),i.openTooltip(t.latlng)}}class Ms{static handleEvent(t){window.L.DomEvent.stopPropagation(t),new bs(t).show()}}class Ds{ah;Ol;Bl;constructor(t,e,s){this.ah=t,this.Ol=e,this.Bl=s}get marker(){return this.ah}get polyline(){return this.Ol}get bullet(){return this.Bl}}class Es{jl;Hl;static get Ul(){return 18}static get Fl(){return 0}static get Kl(){return 100}constructor(){this.jl=null,this.Hl=null}addToMap(t,e){e.objId=t,e.addTo(V.map),V.mapObjects.set(t,e)}addRoute(t){const e=tt.getRoute(t),s=[],i=e.itinerary.itineraryPoints.iterator;for(;!i.done;)s.push(i.value.latLng);const r=window.L.polyline(s,{color:e.color,weight:e.width,dashArray:this.getDashArray(e)});this.addToMap(e.objId,r),c.notEdited===e.editionStatus&&(r.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(r,"mouseover",Is.handleEvent),window.L.DomEvent.on(r,"mousemove",Is.handleEvent)),r.bindPopup((t=>L.clone(Kt.getRouteHeaderHTML("TravelNotes-Map-",tt.getRoute(t.objId))))),window.L.DomEvent.on(r,"click",(t=>t.target.openPopup(t.latlng)));const a=e.notes.iterator;for(;!a.done;)this.addNote(a.value.objId);return e}addNote(e){const s=tt.getNoteAndRoute(e).note,i=window.L.marker(s.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!V.travel.readOnly});i.objId=s.objId;const r=window.L.marker(s.iconLatLng,{zIndexOffset:Es.Kl,icon:window.L.divIcon({iconSize:[s.iconWidth,s.iconHeight],iconAnchor:[s.iconWidth/2,s.iconHeight/2],popupAnchor:[0,-s.iconHeight/2],html:s.iconContent,className:"TravelNotes-Map-AllNotes "}),draggable:!V.travel.readOnly});r.objId=s.objId,r.bindPopup((t=>L.clone(Ft.getNoteTextHTML("TravelNotes-Map-",tt.getNoteAndRoute(t.objId))))),0!==s.tooltipContent.length&&(r.bindTooltip((t=>tt.getNoteAndRoute(t.objId).note.tooltipContent)),r.getTooltip().options.offset[0]=s.iconWidth/2);const a=window.L.polyline([s.latLng,s.iconLatLng],t.note.polyline);a.objId=s.objId;const o=window.L.layerGroup([r,a,i]);return o.markerId=window.L.Util.stamp(r),o.polylineId=window.L.Util.stamp(a),o.bulletId=window.L.Util.stamp(i),this.addToMap(s.objId,o),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),new Ds(r,a,i)}getDashArray(e){e.dashArray>=t.route.dashChoices.length&&(e.dashArray=0);const s=t.route.dashChoices[e.dashArray].iDashArray;if(s){let t="",i=0;for(i=0;i<s.length-1;i++)t+=s[i]*e.width+",";return t+=s[i]*e.width,t}return null}zoomTo(e,s){if(s){let t=[];s.forEach((e=>t=t.concat(e))),V.map.fitBounds(Y.getLatLngBounds(t))}else V.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){const s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);this.jl&&V.map.removeLayer(this.jl),V.map.addLayer(s),this.jl=s,V.travel.readOnly||(V.map.getZoom()<(t.minZoom||Es.Fl)&&V.map.setZoom(t.minZoom||Es.Fl),V.map.setMinZoom(t.minZoom||Es.Fl),V.map.getZoom()>(t.maxZoom||Es.Ul)&&V.map.setZoom(t.maxZoom||Es.Ul),V.map.setMaxZoom(t.maxZoom||Es.Ul),t.bounds?(V.map.getBounds().intersects(t.bounds)&&!V.map.getBounds().contains(t.bounds)||(V.map.setMaxBounds(null),V.map.fitBounds(t.bounds),V.map.setZoom(t.minZoom||Es.Fl)),V.map.setMaxBounds(t.bounds)):V.map.setMaxBounds(null)),V.map.fire("baselayerchange",s)}onGeolocationStatusChanged(t){a.active!==t&&this.Hl&&(V.map.removeLayer(this.Hl),this.Hl=null)}onGeolocationPositionChanged(e){let s=t.geoLocation.zoomToPosition;this.Hl&&(V.map.removeLayer(this.Hl),s=!1),this.Hl=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).bindTooltip(S.formatLatLng([e.coords.latitude,e.coords.longitude])).addTo(V.map),s&&V.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class xs{static marker=null;static initialLatLng=null}class Ps{static handleEvent(){xs.marker&&(window.L.DomEvent.off(xs.marker),V.map.removeLayer(xs.marker),xs.marker=null)}}class Cs{static handleEvent(){window.L.DomEvent.off(xs.marker,"mouseout",Ps.handleEvent)}}class Ls{static handleEvent(t){t.latlng.lat=xs.initialLatLng[0],t.latlng.lng=xs.initialLatLng[1],t.target.objId=V.travel.editedRoute.objId,new bs(t).show()}}class ks{static handleEvent(t){Ts.addWayPointOnRoute(xs.initialLatLng,[t.target.getLatLng().lat,t.target.getLatLng().lng]),xs.marker&&(window.L.DomEvent.off(xs.marker,"dragstart",Cs.handleEvent),window.L.DomEvent.off(xs.marker,"dragend",ks.handleEvent),window.L.DomEvent.off(xs.marker,"contextmenu",Ls.handleEvent),V.map.removeLayer(xs.marker),xs.marker=null)}}class Ss{static Wl=1;static handleEvent(e){const s=tt.getRoute(e.target.objId);if(c.notEdited!==s.editionStatus)if(xs.initialLatLng=[e.latlng.lat,e.latlng.lng],xs.marker)xs.marker.setLatLng(e.latlng);else{xs.marker=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:'<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>',className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});let i="";(w===t.route.showDragTooltip||Ss.Wl<=t.route.showDragTooltip)&&(Ss.Wl++,i=k.getText("MapEditor - Drag and drop to add a waypoint")+" - "),i+=s.computedName+" - ";let r=Y.getClosestLatLngDistance(s,[e.latlng.lat,e.latlng.lng]).distance;r+=s.chainedDistance,i+=S.formatDistance(r),xs.marker.bindTooltip(i),xs.marker.getTooltip().options.offset=[0,0],xs.marker.addTo(V.map),window.L.DomEvent.on(xs.marker,"mouseout",Ps.handleEvent),window.L.DomEvent.on(xs.marker,"dragstart",Cs.handleEvent),window.L.DomEvent.on(xs.marker,"dragend",ks.handleEvent),window.L.DomEvent.on(xs.marker,"contextmenu",Ls.handleEvent)}}}class As{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId),s=e.note,i=e.route,r=V.mapObjects.get(t.target.objId);if(null===i)s.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],Bt.dispatch("updatetravelnotes");else{const e=Y.getClosestLatLngDistance(i,[t.target.getLatLng().lat,t.target.getLatLng().lng]);s.latLng=e.latLng,s.distance=e.distance,i.notes.sort(((t,e)=>t.distance-e.distance)),r.getLayer(r.bulletId).setLatLng(e.latLng),Bt.dispatch("updateitinerary")}r.getLayer(r.polylineId).setLatLngs([s.latLng,s.iconLatLng]),Bt.dispatch("roadbookupdate")}}class Rs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],e.iconLatLng])}}class Os{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}}class Bs{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}}class js extends Qt{ae;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getNoteAndRoute(this.eventData.targetObjId).route)}get menuItems(){return[new qt(k.getText("NoteContextMenu - Edit this note"),!0,(()=>He.editNote(this.eventData.targetObjId))),new qt(k.getText("NoteContextMenu - Delete this note"),!0,(()=>He.removeNote(this.eventData.targetObjId))),new qt(k.getText("NoteContextMenu - Zoom to note"),!0,(()=>(new $e).zoomToNote(this.eventData.targetObjId))),new qt(k.getText(this.ae?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),m===V.editedRouteObjId,(()=>{this.ae?He.detachNoteFromRoute(this.eventData.targetObjId):He.attachNoteToRoute(this.eventData.targetObjId)}))]}}class Hs{static handleEvent(t){new js(t).show()}}class Us{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note;e.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];const s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,e.iconLatLng])}}class Fs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,[t.latlng.lat,t.latlng.lng]])}}class Ks extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(k.getText("WayPointContextMenu - Delete this waypoint"),V.travel.editedRoute.wayPoints.first.objId!==this.eventData.targetObjId&&V.travel.editedRoute.wayPoints.last.objId!==this.eventData.targetObjId,(()=>Ts.removeWayPoint(this.eventData.targetObjId))),new qt(k.getText("WayPointContextMenu - Modify properties"),!0,(()=>Ts.wayPointProperties(this.eventData.targetObjId)))]}}class Ws{static handleEvent(t){new Ks(t).show()}}class Vs{static handleEvent(t){Ts.wayPointDragEnd(t)}}class zs extends Es{static get Vl(){return.01}zl(t){const e=V.mapObjects.get(t);e&&(window.L.DomEvent.off(e),V.map.removeLayer(e),V.mapObjects.delete(t))}constructor(){super()}updateRoute(t,e){if(m!==t){const e=tt.getRoute(t);this.zl(e.objId);const s=e.notes.iterator;for(;!s.done;)this.zl(s.value.objId);const i=e.wayPoints.iterator;for(;!i.done;)this.zl(i.value.objId)}if(m!==e){const t=this.addRoute(e),s=V.mapObjects.get(e);if(!V.travel.readOnly){window.L.DomEvent.on(s,"contextmenu",Ms.handleEvent),window.L.DomEvent.on(s,"mouseover",Ss.handleEvent);const e=t.notes.iterator;for(;!e.done;){const t=V.mapObjects.get(e.value.objId),s=t.getLayer(t.markerId),i=t.getLayer(t.bulletId);window.L.DomEvent.on(i,"dragend",As.handleEvent),window.L.DomEvent.on(i,"drag",Rs.handleEvent),window.L.DomEvent.on(i,"mouseenter",Os.handleEvent),window.L.DomEvent.on(i,"mouseleave",Bs.handleEvent),window.L.DomEvent.on(s,"contextmenu",Hs.handleEvent),window.L.DomEvent.on(s,"dragend",Us.handleEvent),window.L.DomEvent.on(s,"drag",Fs.handleEvent)}}if(!V.travel.readOnly&&c.notEdited!==t.editionStatus){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)this.addWayPoint(t.value,t.first?"A":t.last?"B":t.index)}}}updateRouteProperties(t){const e=V.mapObjects.get(t),s=tt.getRoute(t);e.setStyle({color:s.color,weight:s.width,dashArray:this.getDashArray(s)})}updateNote(t,e){let s=!1;if(m!==t){const e=V.mapObjects.get(t);e&&(s=e.getLayer(e.markerId).isPopupOpen()),this.zl(t)}if(m!==e){const t=this.addNote(e);s&&t.marker.openPopup(),V.travel.readOnly||(window.L.DomEvent.on(t.bullet,"dragend",As.handleEvent),window.L.DomEvent.on(t.bullet,"drag",Rs.handleEvent),window.L.DomEvent.on(t.bullet,"mouseenter",Os.handleEvent),window.L.DomEvent.on(t.bullet,"mouseleave",Bs.handleEvent),window.L.DomEvent.on(t.marker,"contextmenu",Hs.handleEvent),window.L.DomEvent.on(t.marker,"dragend",Us.handleEvent),window.L.DomEvent.on(t.marker,"drag",Fs.handleEvent))}}removeObject(t){this.zl(t)}removeAllObjects(){V.mapObjects.forEach((t=>{window.L.DomEvent.off(t),V.map.removeLayer(t)})),V.mapObjects.clear()}addWayPoint(t,e){if(h.defaultValue===t.lat&&h.defaultValue===t.lng)return;const s='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===e?"Start":"B"===e?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+e+"</div>",i=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:s,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});i.bindTooltip((t=>tt.getWayPoint(t.objId).fullName)),i.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(i,"contextmenu",Ws.handleEvent),i.objId=t.objId,this.addToMap(t.objId,i),window.L.DomEvent.on(i,"dragend",Vs.handleEvent)}addItineraryPointMarker(e,s){this.addToMap(e,window.L.circleMarker(s,t.itineraryPoint.marker))}addSearchPointMarker(e,s,i){let r=!1;if(i){let t=[];i.forEach((e=>{t=t.concat(e)}));const e=Y.getLatLngBounds(t),s=V.map.getBounds();r=(e.getEast()-e.getWest())/(s.getEast()-s.getWest())>zs.Vl&&(e.getNorth()-e.getSouth())/(s.getNorth()-s.getSouth())>zs.Vl}r?this.addToMap(e,window.L.polyline(i,t.osmSearch.searchPointPolyline)):this.addToMap(e,window.L.circleMarker(s,t.osmSearch.searchPointMarker))}addRectangle(t,e,s){this.addToMap(t,window.L.rectangle(e,s))}setLayer(t){const e=jt.getUrl(t);e&&super.setLayer(t,e)}}const Gs=new zs;class Zs{Gl;Jt;Zl;static get Xl(){return 1}Jl(t,e){if(this.Gl)return void t();const s=window.indexedDB.open("TravelNotesDb",Zs.Xl);s.onerror=()=>{this.Gl=null,e(new Error("Not possible to open the db"))},s.onsuccess=e=>{this.Gl=e.target.result,t()},s.onupgradeneeded=t=>{this.Gl=t.target.result,this.Gl.createObjectStore("Travels",{keyPath:"UUID"})}}Yl(t,e){if(!this.Gl)return void e(new Error("Database not opened"));const s=this.Gl.transaction(["Travels"],"readonly");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").get(this.Jt).onsuccess=e=>t(e.target.result?e.target.result.data:null)}ql(t,e){if(!this.Gl)return void e(new Error("Database not opened"));const s=this.Gl.transaction(["Travels"],"readwrite");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").put({UUID:this.Jt,data:this.Zl}).onsuccess=()=>t()}$l(){this.Gl.close(),this.Gl=null}constructor(){}getOpenPromise(){return new Promise(((t,e)=>this.Jl(t,e)))}getReadPromise(t){return this.Jt=t,new Promise(((t,e)=>this.Yl(t,e)))}getWritePromise(t,e){return this.Jt=t,this.Zl=e,new Promise(((t,e)=>this.ql(t,e)))}closeDb(t){if(!this.Gl)return;if(!t)return void this.$l();const e=this.Gl.transaction(["Travels"],"readwrite");e.onerror=()=>{};const s=e.objectStore("Travels").delete(t);s.onerror=()=>this.$l(),s.onsuccess=()=>this.$l()}}const Xs=new Zs;const Js=new class{Ql(e){const s=et.create("div",{className:e+"Travel-Header"});L.sanitizeToHtmlElement(V.travel.name,et.create("div",{className:e+"Travel-Header-Name"},s));let r=i.defaultValue,a=0,o=0;const n=V.travel.routes.iterator;for(;!n.done;){const i=n.value.objId===V.editedRouteObjId&&t.routeEditor.showEditedRouteInRoadbook?V.travel.editedRoute:n.value;L.sanitizeToHtmlElement('<a href="#route'+i.objId+'" >'+i.computedName+"</a>¬†:¬†"+S.formatDistance(i.distance)+".",et.create("div",{className:e+"Travel-Header-RouteName"},s)),i.chain&&(r+=i.distance,a+=i.itinerary.ascent,o+=i.itinerary.descent)}return L.sanitizeToHtmlElement("<span>"+k.getText("TravelHTMLViewsFactory - Travel distance")+"</span>¬†:¬†"+S.formatDistance(r),et.create("div",{className:e+"Travel-Header-TravelDistance"},s)),0!==a&&L.sanitizeToHtmlElement("<span>"+k.getText("travelHTMLViewsFactory - Travel ascent")+"</span>¬†:¬†"+String(a.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelAscent"},s)),0!==o&&L.sanitizeToHtmlElement("<span>"+k.getText("TravelHTMLViewsFactory - Travel descent")+"</span>¬†:¬†"+String(o.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelDescent"},s)),s}tc(t){const e=k.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/TravelNotes" >Travel & Notes</a>, ¬© <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 2021</a> ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+k.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",s=et.create("div",{className:t+"TravelFooter"});return L.sanitizeToHtmlElement(e,s),s}constructor(){}getTravelHTML(e){const s=et.create("div",{className:e+"Travel"});s.appendChild(this.Ql(e)),s.appendChild(Ft.getTravelNotesHTML(e));const i=V.travel.routes.iterator;for(;!i.done;){const r=t.routeEditor.showEditedRouteInRoadbook&&i.value.objId===V.editedRouteObjId?V.travel.editedRoute:i.value;s.appendChild(Kt.getRouteHeaderHTML(e,r)),r.itinerary.hasProfile&&s.appendChild(Kt.getRouteProfileHTML(e,r)),s.appendChild(Kt.getRouteManeuversAndNotesHTML(e,r,!1)),s.appendChild(Kt.getRouteFooterHTML(e,r))}return s.appendChild(this.tc(e)),s}};class Ys{ec;sc;ic;rc;ac;static get oc(){return 3e5}nc(){this.ec&&(this.ec.textContent=this.sc+"¬†"+this.ic+"¬†-¬†Zoom¬†:¬†"+this.rc)}constructor(){this.sc=u.saved,this.ic="",this.rc="",this.ac=null}set saveStatus(t){u.modified===t&&u.notSaved===this.sc||(this.sc=t,u.modified!==t||this.ac?u.saved===t&&this.ac&&(clearTimeout(this.ac),this.ac=null):this.ac=setTimeout((()=>this.sc=u.notSaved),Ys.oc),this.nc())}createUI(){this.ec=et.create("span",null,et.create("div",{id:"TravelNotes-MouseUI"},document.body)),this.rc=V.map.getZoom(),this.ic=S.formatLat(t.map.center.lat)+"¬†-¬†"+S.formatLng(t.map.center.lng),V.map.on("mousemove",(t=>{this.ic=S.formatLatLng([t.latlng.lat,t.latlng.lng]),this.nc()})),V.map.on("zoomend",(()=>{this.rc=String(V.map.getZoom()),this.nc()}))}}const qs=new Ys;class $s{static get hc(){return.5}static get lc(){return 5}static get cc(){return 10}static get uc(){return 31}static get vc(){return 32}static get dc(){return 63}_c(t){return Math.floor(Math.abs(t)+$s.hc)*(0<=t?1:-1)}mc(t,e,s){const i=this._c(t*s),r=this._c(e*s);let a=i-r;a<<=1,0>i-r&&(a=~a);let o="";for(;$s.vc<=a;)o+=String.fromCharCode(($s.vc|a&$s.uc)+$s.dc),a>>=$s.lc;return o+=String.fromCharCode(a+$s.dc),o}u;gc(t){let e=null,s=0,i=0;do{e=t.charCodeAt(this.u++)-$s.dc,i|=(e&$s.uc)<<s,s+=$s.lc}while($s.vc<=e);return 1&i?~(i>>1):i>>1}constructor(){}encode(t,e){if(!t.length)return"";const s=e.length,i=Array.from(e,(t=>Math.pow($s.cc,t)));let r="";for(let e=0;e<s;e++)r+=this.mc(t[0][e],0,i[e]);for(let e=1;e<t.length;e++){const a=t[e],o=t[e-1];for(let t=0;t<s;t++)r+=this.mc(a[t],o[t],i[t])}return r}decode(t,e){const s=e.length;if(!t||0===t.length)return[];this.u=0;const i=[],r=Array.from(e,(t=>Math.pow($s.cc,t))),a=new Array(s).fill(0);for(;this.u<t.length;){const e=new Array(s).fill(0);for(let i=0;i<s;i++)a[i]+=this.gc(t),e[i]=a[i]/r[i];i.push(e)}return i}}class Qs{wc(t){const e={values:"",objType:(new B).objType.jsonObject},s=[];t.itinerary.itineraryPoints.forEach((t=>{s.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),e.values=(new $s).encode(s,[h.fixed,h.fixed,2,2,0]),t.itinerary.itineraryPoints=e}Nc(t){const e=[];if(t.itinerary.itineraryPoints.values)(new $s).decode(t.itinerary.itineraryPoints.values,[h.fixed,h.fixed,2,2,0]).forEach((s=>{const a={lat:h.defaultValue,lng:h.defaultValue,distance:i.defaultValue,elev:r.defaultValue,objId:m};[a.lat,a.lng,a.distance,a.elev,a.objId]=s,a.objType=t.itinerary.itineraryPoints.objType,e.push(a)}));else{t.itinerary.itineraryPoints.latLngs=(new $s).decode(t.itinerary.itineraryPoints.latLngs,[h.fixed,h.fixed]);let s=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{const a={};a.lat=i[0],a.lng=i[1],a.distance=t.itinerary.itineraryPoints.distances[s],t.itinerary.itineraryPoints.elevs?a.elev=t.itinerary.itineraryPoints.elevs[s]:a.elev=r.defaultValue,a.objId=t.itinerary.itineraryPoints.objIds[s],a.objType=t.itinerary.itineraryPoints.objType,e.push(a),s++}))}t.itinerary.itineraryPoints=e}constructor(){}decompress(t){t.routes.forEach(this.Nc),t.editedRoute&&this.Nc(t.editedRoute)}compress(t){const e=t.jsonObject;return e.routes.forEach((t=>this.wc(t))),this.wc(e.editedRoute),e}}class ti{Tc;fc;yc;constructor(t,e,s){this.Tc=t,this.fc=e,this.yc=s}get removeTravelNotes(){return this.Tc}get removeRoutesNotes(){return this.fc}get removeManeuvers(){return this.yc}}class ei extends mt{bc;Ic;Mc;Dc;Ec;xc;Pc(t){const e=et.create("div",null),s=et.create("input",{type:"checkbox",checked:!1},e);return et.create("text",{value:t},e),[e,s]}constructor(t){super(t),[this.Dc,this.bc]=this.Pc(k.getText("SaveAsDialog - Remove Travel Notes")),[this.Ec,this.Ic]=this.Pc(k.getText("SaveAsDialog - Remove Routes Notes")),[this.xc,this.Mc]=this.Pc(k.getText("SaveAsDialog - Remove Maneuvers"))}onOk(){super.onOk(new ti(this.bc.checked,this.Ic.checked,this.Mc.checked))}get contentHTMLElements(){return[this.Dc,this.Ec,this.xc]}get title(){return k.getText("SaveAsDialog - SaveAs")}}const si=new class{Cc(t){const e=new K;e.jsonObject=V.travel.jsonObject,e.name+="-partial";let s=e.routes.iterator;for(;!s.done;)s.value.hidden=!1;if(t.removeTravelNotes&&e.notes.removeAll(),t.removeRoutesNotes)for(s=e.routes.iterator;!s.done;)s.value.notes.removeAll();if(t.removeManeuvers)for(s=e.routes.iterator;!s.done;)s.value.itinerary.maneuvers.removeAll();const i=(new Qs).compress(e);S.saveFile(i.name+".trv",JSON.stringify(i),"application/json")}constructor(){}routeDropped(t,e,s){const i=t===V.travel.editedRoute.objId?V.editedRouteObjId:t,r=e===V.travel.editedRoute.objId?V.editedRouteObjId:e;V.travel.routes.moveTo(i,r,s),gs.chainRoutes(),Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate")}saveAsTravel(){""!==V.travel.name?m===V.editedRouteObjId?(new ei).show().then((t=>{this.Cc(t)})).catch((t=>{t instanceof Error&&console.error(t)})):Rt.showError(k.getText("TravelEditor - Not possible to partial save when a route is edited.")):Rt.showError(k.getText("TravelEditor - Gives a name to the travel"))}saveTravel(){if(""===V.travel.name)return void Rt.showError(k.getText("TravelEditor - Gives a name to the travel"));const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden=!1;const e=(new Qs).compress(V.travel);S.saveFile(e.name+".trv",JSON.stringify(e),"application/json"),qs.saveStatus=u.saved}newTravel(){t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(k.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(os.deleteAllProfiles(),Bt.dispatch("removeallobjects"),V.editedRouteObjId=m,V.travel.jsonObject=(new K).jsonObject,Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate"),Bt.dispatch("travelnameupdated"),t.travelEditor.startupRouteEdition&&gs.editRoute(V.travel.routes.first.objId),qs.saveStatus=u.saved)}};class ii{Lc;qt;ae;kc;Sc(t){let e=new B;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)switch(s[t].nodeName){case"ele":e.elev=Number.parseFloat(s[t].textContent),0!==e.elev&&(this.ae.itinerary.hasProfile=!0)}this.ae.itinerary.itineraryPoints.add(e)}Ac(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"trkpt":this.Sc(e[t])}}Rc(){let t=0,e=0,s=this.ae.itinerary.itineraryPoints.iterator;for(s.done;!s.done;){let i=s.value.elev-s.previous.elev;0>i?e-=i:t+=i}this.ae.itinerary.ascent=t,this.ae.itinerary.descent=e}Oc(t){this.ae=new F;const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"trkseg":this.Ac(e[t])}this.ae.itinerary.hasProfile&&this.Rc(),this.qt.routes.add(this.ae)}Bc(t){let e=Number.MAX_VALUE,s=m;return this.ae.itinerary.itineraryPoints.forEach((i=>{const r=q.pointsDistance(t,i.latLng);r<e&&(e=r,s=i.objId)})),s}jc(t){const e=new j;e.iconName="kUndefined";const s=Number.parseFloat(t.getAttributeNS(null,"lat")),i=Number.parseFloat(t.getAttributeNS(null,"lon"));e.itineraryPointObjId=this.Bc([s,i]);const r=t.childNodes;for(let t=0;t<r.length;t++)switch(r[t].nodeName){case"desc":e.instruction=r[t].textContent}this.ae.itinerary.maneuvers.add(e)}Hc(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"rtept":this.jc(e[t])}}Uc(t){const e=new U;e.latLng=t.latLng,e.iconLatLng=t.latLng;const s=t.name.split("+");e.iconContent='<div class="TravelNotes-MapNote TravelNotes-MapNoteCategory-0073"><svg viewBox="0 0 20 20"><text x="10" y="14">'+s[0]+"</text></svg></div>",e.tooltipContent=k.getText("GpxParser - Network node")+s[0],s[1]&&(e.tooltipContent+=k.getText("GpxParser - Go to network node")+s[1]),e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,this.ae.notes.add(e)}Fc(t){let e=new O;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)switch(s[t].nodeName){case"name":e.name=s[t].textContent}this.ae.wayPoints.add(e),this.kc&&this.Uc(e)}Kc(t){for(let e=0;e<t.length;e++)this.Fc(t[e])}Wc(){this.qt.routes.forEach((t=>{t.wayPoints.remove(t.wayPoints.first.objId),t.wayPoints.remove(t.wayPoints.last.objId);const e=new O;e.latLng=t.itinerary.itineraryPoints.first.latLng,t.wayPoints.add(e);const s=new O;s.latLng=t.itinerary.itineraryPoints.last.latLng,t.wayPoints.add(s)}))}Pl(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;e.done;let r=s.done;for(r||(s.value.distance=i.defaultValue,r=s.done),t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,r||(s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=i.defaultValue),s.done))}constructor(){}parse(t){this.Lc=(new DOMParser).parseFromString(t,"text/xml"),this.kc=Boolean(this.Lc.querySelector("gpx").getAttributeNS(null,"creator").match(/fietsnet/g)),this.qt=new K,this.qt.routes.remove(this.qt.routes.first.objId);const e=this.Lc.querySelectorAll("trk");for(let t=0;t<e.length;t++)this.Oc(e[t]);const s=this.Lc.querySelectorAll("rte");1===s.length&&1===this.qt.routes.length&&this.Hc(s[0]),this.qt.routes.forEach((t=>this.Pl(t)));const i=this.Lc.querySelectorAll("wpt");return 0<i.length&&1===this.qt.routes.length?(this.ae.wayPoints.remove(this.ae.wayPoints.first.objId),this.ae.wayPoints.remove(this.ae.wayPoints.last.objId),this.Kc(i)):this.Wc(),this.qt}}const ri=new class{$s=null;constructor(){}createUI(){this.$s=et.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){const e='¬© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| ¬© <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.$s.firstChild;)this.$s.removeChild(this.$s.firstChild);L.sanitizeToHtmlElement(e,this.$s)}};class ai{constructor(){}handleEvent(t){const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.backgroundColor,t.target.style["background-color"]=e.toolbarButtonData.color}}class oi{constructor(){}handleEvent(t){t.stopPropagation();const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.color,t.target.style["background-color"]=e.toolbarButtonData.backgroundColor}}class ni{constructor(){}handleEvent(t){t.stopPropagation();const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);Bt.dispatch("layerchange",{layer:e}),ri.attributions=e.attribution,V.travel.layerName=e.name}}class hi{Vc;zc;Gc;Zc;constructor(t,e){this.Vc=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button",title:t.name,dataset:{MapLayerName:t.name},textContent:t.toolbarButtonData.text,style:"color:"+t.toolbarButtonData.color+";background-color:"+t.toolbarButtonData.backgroundColor},e),this.zc=new ai,this.Gc=new oi,this.Zc=new ni,this.Vc.addEventListener("mouseenter",this.zc,!1),this.Vc.addEventListener("mouseleave",this.Gc,!1),this.Vc.addEventListener("click",this.Zc,!1)}destructor(){this.Vc.removeEventListener("mouseenter",this.zc,!1),this.Vc.removeEventListener("mouseleave",this.Gc,!1),this.Vc.removeEventListener("click",this.Zc,!1)}get height(){return this.Vc.clientHeight}}class li{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Enter"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Leave")}}class ci{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Leave"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Enter")}}class ui{Xc;Jc;Yc;constructor(t,e){this.Yc=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-LinkButton TravelNotes-MapLayersToolbarUI-LinkButton-Leave"},e),et.create("a",t,this.Yc),this.Xc=new li,this.Jc=new ci,this.Yc.addEventListener("mouseenter",this.Xc,!1),this.Yc.addEventListener("mouseleave",this.Jc,!1)}destructor(){this.Yc.removeEventListener("mouseenter",this.Xc,!1),this.Yc.removeEventListener("mouseleave",this.Jc,!1)}get height(){return this.Yc.clientHeight}}class vi{constructor(){}marginTop=0;buttonHeight=0;buttonsHeight=0;buttonTop=0}class di{qc;static get $c(){return 3}constructor(t){this.qc=t}handleEvent(t){t.stopPropagation(),t.deltaY&&(this.qc.marginTop-=t.deltaY*g[t.deltaMode],this.qc.marginTop=this.qc.marginTop>this.qc.buttonTop?this.qc.buttonTop:this.qc.marginTop,this.qc.marginTop=this.qc.marginTop<this.qc.buttonTop-this.qc.buttonsHeight+di.$c*this.qc.buttonHeight?this.qc.buttonTop-this.qc.buttonsHeight+di.$c*this.qc.buttonHeight:this.qc.marginTop,t.currentTarget.style.marginTop=String(this.qc.marginTop)+"px")}}const pi=new class{$s;Qc;tu;qc;ti;eu;us(){if(this.ti)return clearTimeout(this.ti),void(this.ti=null);if(this.Qc=et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Buttons"},this.$s),this.qc.buttonTop=this.$s.clientHeight,this.qc.buttonsHeight=0,vs.forEach((t=>{if(t.providerKeyNeeded&&jt.hasKey(t.providerName.toLowerCase())||!t.providerKeyNeeded){const e=new hi(t,this.Qc);this.qc.buttonHeight=e.height,this.qc.buttonsHeight+=e.height,this.tu.push(e)}})),t.layersToolbarUI?.theDevil?.addButton){const t=new ui({href:"https://www.google.com/maps/@"+V.map.getCenter().lat+","+V.map.getCenter().lng+","+V.map.getZoom()+"z",title:"Reminder! The devil will know everything about you",textContent:"üëø",target:"_blank"},this.Qc);this.qc.buttonsHeight+=t.height,this.tu.push(t)}this.qc.buttonTop+=this.qc.buttonHeight,this.qc.marginTop=this.qc.buttonTop,this.Qc.style.marginTop=String(this.qc.marginTop)+"px",this.Qc.addEventListener("wheel",this.eu,{passive:!0})}ri(){this.tu.forEach((t=>t.destructor())),this.tu.length=0,this.Qc.removeEventListener("wheel",this.eu,{passive:!0}),this.$s.removeChild(this.Qc),this.ti=null}su(){this.ti=setTimeout((()=>this.ri()),t.layersToolbarUI.toolbarTimeOut)}constructor(){this.qc=new vi,this.eu=new di(this.qc),this.tu=[]}createUI(){this.$s=et.create("div",{id:"TravelNotes-MapLayersToolbarUI"},document.body),et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Header",textContent:k.getText("MapLayersToolbarUI - Layers")},this.$s),this.$s.addEventListener("mouseenter",(()=>this.us()),!1),this.$s.addEventListener("mouseleave",(()=>this.su()),!1),Bt.dispatch("layerchange",{layer:vs.defaultMapLayer}),ri.attributions=vs.defaultMapLayer.attribution}setMapLayer(t){const e=vs.getMapLayer(t);Bt.dispatch("layerchange",{layer:e}),ri.attributions=e.attribution,V.travel.layerName=e.name}};class _i{iu(){Bt.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const t=V.travel.routes.iterator;for(;!t.done;)c.notEdited===t.value.editionStatus&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId});m!==V.editedRouteObjId&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const e=V.travel.notes.iterator;for(;!e.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.value.objId});if((new $e).zoomToTravel(),pi.setMapLayer(V.travel.layerName),m!==V.editedRouteObjId){const t=V.travel.editedRoute.itinerary.provider;if(""===t||V.providers.get(t.toLowerCase())){Bt.dispatch("setprovider",{provider:t});const e=V.travel.editedRoute.itinerary.transitMode;""!==e&&Bt.dispatch("settransitmode",{transitMode:e})}else Rt.showError(k.getText("FileLoader - Not possible to select as provider",{provider:t}))}gs.chainRoutes(),Bt.dispatch("setrouteslist"),Bt.dispatch("travelnameupdated"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate")}constructor(){}openLocalGpxFile(t){os.deleteAllProfiles(),V.travel.jsonObject=(new ii).parse(t).jsonObject,V.editedRouteObjId=m,this.iu(),qs.saveStatus=u.saved}openLocalTrvFile(t){os.deleteAllProfiles();const e=JSON.parse(t);(new Qs).decompress(e),V.travel.jsonObject=e,V.editedRouteObjId=m,V.travel.routes.forEach((t=>{c.notEdited!==t.editionStatus&&(V.editedRouteObjId=t.objId)})),this.iu(),qs.saveStatus=u.saved}ru(t){const e=t.routes.iterator;for(;!e.done;)V.travel.routes.add(e.value);const s=t.notes.iterator;for(;!s.done;)V.travel.notes.add(s.value);this.iu(),qs.saveStatus=u.modified}mergeLocalGpxFile(t){this.ru((new ii).parse(t))}mergeLocalTrvFile(t){const e=JSON.parse(t);(new Qs).decompress(e);const s=new K;s.jsonObject=e,this.ru(s)}}class mi{constructor(){}handleEvent(t){t.stopPropagation(),si.saveAsTravel()}}class gi{constructor(){}handleEvent(t){t.stopPropagation(),si.newTravel(),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name)}}class wi{constructor(){}handleEvent(t){t.stopPropagation(),si.saveTravel()}}class Ni{constructor(){}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{switch(t.target.files[0].name.split(".").pop().toLowerCase()){case"trv":(new _i).openLocalTrvFile(e.result);break;case"gpx":(new _i).openLocalGpxFile(e.result)}}catch(t){t instanceof Error&&(console.error(t),Rt.showError("An error occurs when reading the file : "+t.message))}},e.readAsText(t.target.files[0])}}class Ti{constructor(){}handleEvent(e){e.stopPropagation(),t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(k.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||S.openFile(new Ni,".trv,.gpx")}}class fi{constructor(){}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{switch(t.target.files[0].name.split(".").pop().toLowerCase()){case"trv":(new _i).mergeLocalTrvFile(e.result);break;case"gpx":(new _i).mergeLocalGpxFile(e.result)}}catch(t){t instanceof Error&&(console.error(t),Rt.showError("An error occurs when reading the file : "+t.message))}},e.readAsText(t.target.files[0])}}class yi{constructor(){}handleEvent(t){t.stopPropagation(),m===V.editedRouteObjId?S.openFile(new fi,".trv,.gpx"):Rt.showError(k.getText("TravelUI - Not possible to merge a travel when a route is edited"))}}class bi{au;ou(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-TravelUI-SaveAsButton",title:k.getText("TravelUI - Save as travel"),textContent:"üíæ"},this.au).addEventListener("click",new mi,!1)}nu(){et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelUI - Cancel travel"),textContent:"‚ùå"},this.au).addEventListener("click",new gi,!1)}hu(){et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelUI - Save travel"),textContent:"üíæ"},this.au).addEventListener("click",new wi,!1)}lu(){et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelUI - Open travel"),textContent:"üìÇ"},this.au).addEventListener("click",new Ti,!1)}cu(){et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelUI - Import travel"),textContent:"üåè"},this.au).addEventListener("click",new yi,!1)}uu(){et.create("text",{value:"üìã"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+t.travelNotes.language+"&page="+V.UUID,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelUI - Open travel roadbook")},this.au)))}constructor(t){this.au=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.ou(),this.nu(),this.hu(),this.lu(),this.cu(),this.uu()}}class Ii{constructor(){}handleEvent(t){t.preventDefault()}}class Mi{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class Di{constructor(){}handleEvent(t){t.preventDefault();const e=t.target,s=e.getBoundingClientRect();si.routeDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class Ei{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class xi{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new bs(t,t.target.parentNode).show()}}class Pi{vu;du;pu;_u;constructor(t){this.vu=et.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},t),this.vu.addEventListener("dragover",new Ii),this.vu.addEventListener("wheel",new Ei,{passive:!0}),this.du=new xi,this.pu=new Di,this._u=new Mi}toogleExpand(){return this.vu.classList.toggle("TravelNotes-Hidden"),this.vu.classList.contains("TravelNotes-Hidden")}setRoutesList(){for(;this.vu.firstChild;)this.vu.firstChild.removeEventListener("dragstart",this._u),this.vu.firstChild.removeEventListener("drop",this.pu),this.vu.firstChild.removeEventListener("contextmenu",this.du),this.vu.removeChild(this.vu.firstChild);const t=V.travel.routes.iterator;for(;!t.done;){const e=t.value.objId===V.editedRouteObjId?V.travel.editedRoute:t.value,s=(t.value.objId===V.editedRouteObjId?"üî¥¬†":"")+(e.chain?"‚õì¬†":"")+(t.value.objId===V.editedRouteObjId?V.travel.editedRoute.computedName:e.computedName),i=et.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(t.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),dataset:{ObjId:e.objId},textContent:s},this.vu);i.addEventListener("dragstart",this._u),i.addEventListener("drop",this.pu),i.addEventListener("contextmenu",this.du)}}}class Ci{constructor(){}handleEvent(t){t.stopPropagation(),V.travel.name=L.sanitizeToJsString(t.target.value),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),Bt.dispatch("roadbookupdate")}}class Li{mu=null;constructor(t){this.mu=t}handleEvent(t){t.stopPropagation();const e=this.mu.toogleExpand();t.target.textContent=e?"‚ñ∂":"‚ñº",t.target.title=e?k.getText("TravelUI - Show"):k.getText("TravelUI - Hide")}}class ki{constructor(){}handleEvent(t){t.stopPropagation(),gs.addRoute()}}class Si{gu;wu;mu;Nu;Tu(t){const e=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t);et.create("span",{textContent:k.getText("TravelUI - Travel")},e),this.wu=et.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:V.travel.name},e),this.wu.addEventListener("change",new Ci,!1)}fu(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:k.getText("TravelUI - Add a route"),textContent:"+"},this.gu).addEventListener("click",new ki,!1)}yu(t){this.gu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Nu=et.create("div",{textContent:"‚ñº",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},this.gu),et.create("span",{textContent:k.getText("TravelUI - Travel routes")},this.gu),this.fu(this.gu)}constructor(t){this.Tu(t),new bi(t),this.yu(t),this.mu=new Pi(t),this.Nu.addEventListener("click",new Li(this.mu),!1)}setTravelName(){this.wu.value=V.travel.name}get routesListUI(){return this.mu}}class Ai{bu=null;constructor(t){this.bu=t}handleEvent(t){this.bu.showPane(t.target.dataset.tanPaneId)}}class Ri{constructor(){}handleEvent(t){t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Oi{Iu;Mu;Du;Eu;_h;xu(){l.invalidPane!==this.Iu&&this.Mu.get(this.Iu).remove()}constructor(t){this.Iu=l.invalidPane,this.Mu=new Map,this._h=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Eu=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},t),this.Du=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},t),this.Du.addEventListener("wheel",new Ri,{passive:!0})}addPane(t){const e=new t(this.Du,this.Eu);this.Mu.set(e.paneId,e),et.create("div",{textContent:e.buttonText,className:"TravelNotes-PanesManagerUI-PaneButton",dataset:{PaneId:e.paneId}},this._h).addEventListener("click",new Ai(this))}showPane(t){this.xu(),this.Iu=t,this.Mu.get(this.Iu).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach((t=>{t.dataset.tanPaneId===this.Iu?t.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):t.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")}))}updatePane(t){t===this.Iu&&this.showPane(t)}}class Bi{Pu;ft;Vc;static get Cu(){return Object.freeze({bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625 H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /> </svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /> </g> </svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"> <path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"> <rect x="1" y="10" width="2" height="3" /> <rect x="11" y="10" width="2" height="3" /> </g> </g> </svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"> <path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2= "11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1= "16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'})}constructor(t,e){this.Pu=t,this.ft=e,this.Vc=et.create("img",{src:Bi.Cu[e],id:"TravelNotes-ProvidersToolbarUI-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:k.getText("ProvidersToolbarUI - "+e)}),this.Vc.addEventListener("click",this),this.visible=!1}handleEvent(t){t.stopPropagation(),this.Pu.transitMode=this.ft,Ns.startRouting()}get buttonHTMLElement(){return this.Vc}get transitMode(){return this.ft}set active(t){t?this.Vc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"):this.Vc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}set visible(t){t?this.Vc.classList.remove("TravelNotes-Hidden"):this.Vc.classList.add("TravelNotes-Hidden")}}class ji{Pu;Tt;Vc;constructor(t,e){this.Pu=t,this.Tt=e,this.Vc=et.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbarUI-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:e.title||e.name}),this.Vc.addEventListener("click",this)}handleEvent(t){t.stopPropagation(),this.Pu.provider=this.Tt.name,Ns.startRouting()}get buttonHTMLElement(){return this.Vc}get provider(){return this.Tt}set active(t){t?this.Vc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"):this.Vc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton")}}class Hi{Lu;ku;Su;Au;Ru;Ou(){["bike","pedestrian","car","train","line","circle"].forEach((t=>{const e=new Bi(this,t);this.ku.set(t,e),this.Lu.appendChild(e.buttonHTMLElement)}))}Bu(){V.providers.forEach((t=>{if(!t.providerKeyNeeded||jt.hasKey(t.name)){const e=new ji(this,t);this.Su.set(t.name,e),this.Lu.appendChild(e.buttonHTMLElement)}}))}constructor(t){this.ku=new Map,this.Su=new Map,this.Lu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},t),this.Ou(),this.Bu(),this.provider=this.Su.keys().next().value}set provider(t){V.routing.provider=t,this.Ru&&(this.Ru.active=!1),this.Ru=this.Su.get(t),this.Ru.active=!0;const e=V.providers.get(t.toLowerCase());this.ku.forEach((t=>{t.visible=w!==e.transitModes.indexOf(t.transitMode)})),this.Au&&w!==e.transitModes.indexOf(this.Au.transitMode)||(this.Au=null,this.ku.forEach((t=>{this.Au||w===e.transitModes.indexOf(t.transitMode)?t.active=!1:(this.Au=t,t.active=!0,V.routing.transitMode=t.transitMode)})))}set transitMode(t){V.routing.transitMode=t,this.Au&&(this.Au.active=!1),this.Au=this.ku.get(t),this.Au.active=!0}providersAdded(){for(;this.Lu.firstChild;)this.Lu.removeChild(this.Lu.firstChild);this.ku.clear(),this.Su.clear(),this.Ou(),this.Bu(),this.provider=this.Su.keys().next().value;const t=this.Su.keys().next().value;this.provider=t,this.transitMode=V.providers.get(t.toLowerCase()).transitModes[0]}}const Ui=new class{ju=navigator.geolocation?a.inactive:a.disabled;Hu=null;Uu(t){Bt.dispatch("geolocationpositionchanged",{position:t})}Fu(){a.active===this.ju&&(this.ju=a.inactive),Bt.dispatch("geolocationstatuschanged",{status:this.ju}),navigator.geolocation.clearWatch(this.Hu),this.Hu=null}Ku(t){1===t.code&&(this.ju=a.refusedByUser),this.Fu()}Wu(){this.ju=a.active,Bt.dispatch("geolocationstatuschanged",{status:this.ju}),navigator.geolocation.getCurrentPosition((t=>this.Uu(t)),(t=>this.Ku(t)),t.geoLocation.options),this.Hu=navigator.geolocation.watchPosition((t=>this.Uu(t)),(t=>this.Ku(t)),t.geoLocation.options)}constructor(){}get status(){return this.ju}switch(){switch(this.ju){case a.inactive:this.Wu();break;case a.active:this.Fu()}return this.ju}};class Fi{constructor(){}handleEvent(t){t.stopPropagation(),jt.setKeysFromDialog()}}class Ki{constructor(){}handleEvent(t){t.stopPropagation(),Ui.switch()}}class Wi{constructor(){}handleEvent(t){t.stopPropagation(),t.target.textContent="üìå"===t.target.textContent?"‚ùå":"üìå",Bt.dispatch("uipinned")}}class Vi{Vu;au;zu(){et.create("text",{value:"üè†"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Home"},this.au)))}Gu(){et.create("text",{value:"?"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://github.com/wwwouaiebe/TravelNotes/tree/v3.2.0-dev/TravelNotesGuides#"+t.travelNotes.language,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Help"},this.au)))}Zu(){et.create("text",{value:"@"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:t.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},this.au)))}Xu(){t.APIKeysDialog.showButton&&et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelNotesToolbarUI - API keys"),textContent:"üîë"},this.au).addEventListener("click",new Fi,!1)}Ju(){a.disabled<Ui.status&&(this.Vu=et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("TravelNotesToolbarUI - Geo location"),textContent:"üåê"},this.au),this.Vu.addEventListener("click",new Ki,!1))}Yu(){et.create("div",{textContent:t.travelEditor.startMinimized?"üìå":"‚ùå",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},this.au).addEventListener("click",new Wi,!1)}constructor(t){this.au=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.zu(),this.Gu(),this.Zu(),this.Xu(),this.Ju(),this.Yu()}geoLocationStatusChanged(t){switch(t){case a.inactive:this.Vu.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case a.active:this.Vu.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:this.Vu&&(this.Vu.parentNode.removeChild(this.Vu),this.Vu=null)}}}class zi{Du;Eu;constructor(t,e){this.Du=t,this.Eu=e}get paneData(){return this.Du}get paneControl(){return this.Eu}remove(){}add(){}get paneId(){return l.invalidPane}get buttonText(){return""}}class Gi{qu;constructor(t){this.qu=t}handleEvent(t){t.stopPropagation(),this.qu.toggleNotes()}}class Zi{qu;constructor(t){this.qu=t}handleEvent(t){t.stopPropagation(),this.qu.toggleManeuvers()}}class Xi{$u;Qu;tv;ev;sv=t.itineraryPaneUI.showNotes;rv=t.itineraryPaneUI.showManeuvers;av=null;ov=null;Eu=null;qu=null;constructor(t,e){this.Eu=t,this.qu=e,this.av=new Gi(e),this.ov=new Zi(e)}addControl(){this.Qu=et.create("div",null,this.Eu),et.create("text",{value:k.getText("ItineraryPaneUI - Show notes")},this.Qu),this.tv=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:this.sv},this.Qu),this.tv.addEventListener("click",this.av),et.create("text",{value:k.getText("ItineraryPaneUI - Show maneuvers")},this.Qu),this.ev=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:this.rv},this.Qu),this.ev.addEventListener("click",this.ov),this.$u=Kt.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute),this.Eu.appendChild(this.$u),this.rv||this.qu.toggleManeuvers(),this.sv||this.qu.toggleNotes()}clearControl(){this.Qu&&(this.ev&&(this.rv=this.ev.checked,this.ev.removeEventListener("click",this.ov),this.Qu.removeChild(this.ev),this.ev=null),this.tv&&(this.sv=this.tv.checked,this.tv.removeEventListener("click",this.av),this.Qu.removeChild(this.tv),this.tv=null),this.Eu.removeChild(this.Qu),this.Qu=null),this.$u&&(this.Eu.removeChild(this.$u),this.$u=null)}}class Ji extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(k.getText("ManeuverContextMenu - Zoom to this maneuver"),!0,(()=>(new $e).zoomToManeuver(this.eventData.targetObjId)))]}}class Yi{Du;constructor(t){this.Du=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Ji(t,this.Du).show()}}class qi{Du;constructor(t){this.Du=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new js(t,this.Du).show()}}class $i{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.itinerary.itineraryPoints.getAt(V.travel.editedRoute.itinerary.maneuvers.getAt(Number.parseInt(t.target.dataset.tanObjId)).itineraryPointObjId).latLng})}}class Qi{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.notes.getAt(Number.parseInt(t.target.dataset.tanObjId)).latLng})}}class tr{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId)})}}class er{Du;nv;hv;lv;cv;uv;vv;dv(t){this.nv.childNodes.forEach((e=>{t===e.dataset.tanObjType&&e.classList.toggle("TravelNotes-Hidden")}))}constructor(t){this.Du=t,this.hv=new Yi(this.Du),this.lv=new qi(this.Du),this.cv=new $i,this.uv=new Qi,this.vv=new tr}toggleNotes(){this.dv("Note")}toggleManeuvers(){this.dv("Maneuver")}addData(){this.nv=Kt.getRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute,!0),this.nv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.addEventListener("contextmenu",this.hv),t.addEventListener("mouseenter",this.cv),t.addEventListener("mouseleave",this.vv)):"Note"===t.dataset.tanObjType&&(t.addEventListener("contextmenu",this.lv),t.addEventListener("mouseenter",this.uv),t.addEventListener("mouseleave",this.vv))})),this.Du.appendChild(this.nv)}clearData(){this.nv&&(this.nv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.removeEventListener("contextmenu",this.hv),t.removeEventListener("mouseenter",this.cv),t.removeEventListener("mouseleave",this.vv)):"Note"===t.dataset.tanObjType&&(t.removeEventListener("contextmenu",this.lv),t.removeEventListener("mouseenter",this.uv),t.removeEventListener("mouseleave",this.vv))})),this.Du.removeChild(this.nv)),this.nv=null}}class sr extends zi{qu;pv;constructor(t,e){super(t,e),this.qu=new er(this.paneData),this.pv=new Xi(this.paneControl,this.qu)}remove(){this.qu.clearData(),this.pv.clearControl()}add(){m!==V.editedRouteObjId&&(this.qu.addData(),this.pv.addControl())}get paneId(){return l.itineraryPane}get buttonText(){return k.getText("PanesManagerUI - Itinerary")}}class ir{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class rr{constructor(){}handleEvent(t){t.preventDefault()}}class ar{constructor(){}handleEvent(t){t.preventDefault();const e=t.currentTarget,s=e.getBoundingClientRect();He.travelNoteDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class or{Du=null;constructor(t){this.Du=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new js(t,this.Du).show()}}class nr extends zi{_v;mv;gv;wv;Nv;constructor(t,e){super(t,e),this.mv=new ir,this.gv=new rr,this.wv=new ar,this.Nv=new or(t)}remove(){this._v&&(this._v.childNodes.forEach((t=>{t.removeEventListener("contextmenu",this.Nv,!1),t.removeEventListener("dragstart",this.mv,!1),t.removeEventListener("drop",this.wv,!1)})),this._v.removeEventListener("dragover",this.gv,!1),this.paneData.removeChild(this._v)),this._v=null}add(){this._v=Ft.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),this._v.addEventListener("dragover",this.gv,!1),this.paneData.appendChild(this._v),this._v.childNodes.forEach((t=>{t.draggable=!0,t.addEventListener("contextmenu",this.Nv,!1),t.addEventListener("dragstart",this.mv,!1),t.addEventListener("drop",this.wv,!1),t.classList.add("TravelNotes-UI-MoveCursor")}))}get paneId(){return l.travelNotesPane}get buttonText(){return k.getText("PanesManagerUI - Travel notes")}}class hr{rt="";Tv=!1;fv=[];yv=["node","way","relation"];bv=[];Iv=!1;Mv=!1;t=m;constructor(t,e){this.rt=L.sanitizeToJsString(t),e&&(this.Mv=!0,this.Tv=!0),this.t=f.nextObjId}get name(){return this.rt}get isRoot(){return this.Tv}get items(){return this.fv}get elementTypes(){return this.yv}setElementType(t){w!==["node","way","relation"].indexOf(t)&&(this.yv=[t])}get filterTagsArray(){return this.bv}get isSelected(){return this.Iv}set isSelected(t){this.Iv=t,this.items.forEach((e=>{e.isSelected=t}))}get isExpanded(){return this.Mv}set isExpanded(t){this.Mv=t}get objId(){return this.t}}const lr=new class{Dv;Ev;xv;Pv;Cv(t){const e=t.split(";");for(;""===e[e.length-1];)e.pop();let s=0;const i=[];e.forEach((t=>{if(""!==t)if(w===t.indexOf("="))this.xv=new hr(t),this.Ev.set(this.xv.objId,this.xv),this.Pv[s].push(this.xv),this.Pv[s+1]=this.xv.items;else{let e=t.split("=");if("element"===e[0])this.xv.setElementType(e[1]);else{let t={};t[e[0]]="*"===e[1]?null:e[1],i.push(t)}}s++})),0!==i.length&&this.xv.filterTagsArray.push(i)}Lv(t){t.items.forEach((t=>{this.Lv(t)})),t.isExpanded=!0}kv(t){t.items.forEach((t=>{this.kv(t)})),t.isExpanded=!1}constructor(){this.Dv=new hr("",!0),this.Ev=new Map,this.Ev.set(this.Dv.objId,this.Dv),this.Pv=[this.Dv.items]}get dictionary(){return this.Dv}parseDictionary(t){t.split(/\r\n|\r|\n/).forEach((t=>{""!==t&&this.Cv(t)}))}selectItem(t,e){this.Ev.get(t).isSelected=e}unselectAll(){this.Dv.isSelected=!1}expandItem(t){let e=this.Ev.get(t);e.isExpanded=!e.isExpanded}expand(){this.Lv(this.Dv)}collapse(){this.Dv.items.forEach((t=>this.kv(t)))}};class cr{Sv;Av;Rv;static get Ov(){return 5e3}Bv(t,e){let s=!0;return e.forEach((e=>{const[i,r]=Object.entries(e)[0];s=s&&t.tags[i]&&(!r||t.tags[i]===r)})),s}jv(t,e){this.Av.forEach((s=>{s.filterTagsArray.forEach((i=>{this.Bv(t,i)&&(t.description=s.name,e.set(t.id,t))}))}))}Hv(){const e=[],s=new Map;this.Av.forEach((t=>{t.filterTagsArray.forEach((e=>{const[i,r]=Object.entries(e[0])[0];let a=s.get(i);a||(a={values:new Map,elements:new Map},s.set(i,a)),a.values.set(r,r),t.elementTypes.forEach((t=>{a.elements.set(t,t)}))}))}));const i=this.Uv();this.Rv=i;const r="("+i.getSouthWest().lat.toFixed(h.fixed)+","+i.getSouthWest().lng.toFixed(h.fixed)+","+i.getNorthEast().lat.toFixed(h.fixed)+","+i.getNorthEast().lng.toFixed(h.fixed)+")";return s.forEach(((s,i)=>{let a='"'+i+'"';if(1===s.values.size){const t=s.values.values().next().value;t&&(a+='="'+t+'"')}else 1<s.values.size&&(a+='~"',s.values.forEach((t=>{a+=t+"|"})),a=a.substr(0,a.length-1)+'"');if(t.overpassApi.useNwr){const t=1===s.elements.size?s.elements.values().next().value:"nwr";e.push(t+"["+a+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}else{let t=[];1===s.elements.size?t.push(s.elements.values().next().value):t=["node","way","rel"],t.forEach((t=>{e.push(t+"["+a+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}))}})),e}Fv(t){t.isSelected&&0<t.filterTagsArray.length&&this.Av.push(t),t.items.forEach((t=>this.Fv(t)))}Uv(){const t=V.map.getCenter(),e=V.map.getBounds(),s=Y.getSquareBoundingBox([t.lat,t.lng],cr.Ov);return e.getSouthWest().lat=Math.max(e.getSouthWest().lat,s.getSouthWest().lat),e.getSouthWest().lng=Math.max(e.getSouthWest().lng,s.getSouthWest().lng),e.getNorthEast().lat=Math.min(e.getNorthEast().lat,s.getNorthEast().lat),e.getNorthEast().lng=Math.min(e.getNorthEast().lng,s.getNorthEast().lng),e}constructor(){this.Sv=!1,this.Av=[],this.Rv=null}async search(){if(this.Sv)return;this.Sv=!0,this.Av=[],this.Fv(lr.dictionary);const t=new de({searchPlaces:!1});await t.loadData(this.Hv());const e=new Map;[t.nodes,t.ways,t.relations].forEach((t=>{t.forEach((t=>{t.tags&&this.jv(t,e)}))})),V.searchData.length=0,Array.from(e.values()).sort(((t,e)=>t.description>e.description)).forEach((t=>V.searchData.push(t))),this.Sv=!1,Bt.dispatch("showsearch")}get searchBounds(){return this.Uv()}get previousSearchBounds(){return this.Rv}}const ur=new cr;class vr{Kv;Wv;Vv(){m===this.Wv?this.Wv=f.nextObjId:Bt.dispatch("removeobject",{objId:this.Wv}),Bt.dispatch("addrectangle",{objId:this.Wv,bounds:ur.searchBounds,properties:t.osmSearch.nextSearchLimit})}zv(){const e=ur.previousSearchBounds;e&&(m===this.Kv?this.Kv=f.nextObjId:Bt.dispatch("removeobject",{objId:this.Kv}),Bt.dispatch("addrectangle",{objId:this.Kv,bounds:[[e.getSouthWest().lat,e.getSouthWest().lng],[e.getNorthEast().lat,e.getNorthEast().lng]],properties:t.osmSearch.previousSearchLimit}))}constructor(){this.Kv=m,this.Wv=m}show(){V.map.on("zoom",this.Vv,this),V.map.on("move",this.Vv,this),this.Vv(),this.zv()}hide(){V.map.off("zoom",this.Vv,this),V.map.off("move",this.Vv,this),m!==this.Wv&&(Bt.dispatch("removeobject",{objId:this.Wv}),this.Wv=m),m!==this.Kv&&(Bt.dispatch("removeobject",{objId:this.Kv}),this.Kv=m)}}class dr{hr;sh;constructor(t,e){this.hr=t,this.sh=e}get latLng(){return this.hr}get geometry(){return this.sh}}class pr extends Qt{Gv;hr;constructor(t,e){super(t,e),this.Gv=V.searchData[Number.parseInt(t.currentTarget.dataset.tanElementIndex)],this.hr=[this.Gv.lat,this.Gv.lon]}get menuItems(){return[new qt(k.getText("MapContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>Ts.setStartPoint(this.hr))),new qt(k.getText("MapContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>Ts.addWayPoint(this.hr))),new qt(k.getText("MapContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>Ts.setEndPoint(this.hr))),new qt(k.getText("OsmSearchContextMenu - Create a route note with this result"),!0,(()=>He.newSearchRouteNote(this.Gv))),new qt(k.getText("OsmSearchContextMenu - Create a travel note with this result"),!0,(()=>He.newSearchTravelNote(this.Gv))),new qt(k.getText(He.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),!0,(()=>He.changeOsmSearchNoteDialog())),new qt(k.getText("OsmSearchContextMenu - Zoom to this result"),!0,(()=>(new $e).zoomToPoi(new dr(this.hr,this.Gv.geometry))))]}}class _r{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new pr(t,this.paneDataDiv).show()}}class mr{constructor(){}handleEvent(t){t.stopPropagation();const e=V.searchData[Number.parseInt(t.target.dataset.tanElementIndex)];Bt.dispatch("addsearchpointmarker",{objId:Number.parseInt(t.target.dataset.tanObjId),latLng:[e.lat,e.lon],geometry:e.geometry})}}class gr{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanObjId)})}}class wr{Du;Zv;Xv;Jv;Yv;qv;$v;Qv;td(){let t="";t=this.Zv.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.Zv.tags.rcn_ref+"</text></svg></div>":se.preDefinedIconDataFromName(this.Zv.description)||"";const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},this.Xv);L.sanitizeToHtmlElement(t,e)}ed(t){t&&et.create("div",{textContent:t},this.Jv)}io(){const t=(this.Zv.tags["addr:street"]?(this.Zv.tags["addr:housenumber"]?this.Zv.tags["addr:housenumber"]+" ":"")+this.Zv.tags["addr:street"]+" ":"")+(this.Zv.tags["addr:city"]?(this.Zv.tags["addr:postcode"]?this.Zv.tags["addr:postcode"]+" ":"")+this.Zv.tags["addr:city"]:"");""!==t&&this.ed(t,this.Jv)}sd(){this.Zv.tags.phone&&this.ed("‚òéÔ∏è : "+this.Zv.tags.phone,this.Jv)}rd(){this.Zv.tags.email&&et.create("a",{href:"mailto:"+this.Zv.tags.email,textContent:this.Zv.tags.email},et.create("div",{textContent:"üìß : "},this.Jv))}ad(){this.Zv.tags.website&&et.create("a",{href:this.Zv.tags.website,target:"_blank",textContent:this.Zv.tags.website},et.create("div",null,this.Jv))}od(){this.Jv=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},this.Xv),this.ed(this.Zv.description),this.ed(this.Zv.tags.name),this.ed(this.Zv.tags.rcn_ref),this.io(),this.sd(),this.rd(),this.ad()}nd(){for(const[t,e]of Object.entries(this.Zv.tags))this.Xv.title+=t+"="+e+"\n"}Ur(){this.Xv.addEventListener("contextmenu",this.qv,!1),this.Xv.addEventListener("mouseenter",this.$v,!1),this.Xv.addEventListener("mouseleave",this.Qv,!1)}hd(t){this.Xv=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",dataset:{ObjId:f.nextObjId,ElementIndex:this.Yv++}},t),this.td(),this.od(),this.nd(),this.Ur()}constructor(t){this.Du=t,this.qv=new _r,this.$v=new mr,this.Qv=new gr,this.Yv=0}addData(){this.Zv=null,this.Xv=null,this.Jv=null,this.Yv=0,V.searchData.forEach((t=>{this.Zv=t,this.hd(this.Du)}))}clearData(){for(;this.Du.firstChild;)this.Du.firstChild.removeEventListener("contextmenu",this.qv,!1),this.Du.firstChild.removeEventListener("mouseenter",this.$v,!1),this.Du.firstChild.removeEventListener("mouseleave",this.Qv,!1),Bt.dispatch("removeobject",{objId:Number.parseInt(this.Du.firstChild.dataset.tanObjId)}),this.Du.removeChild(this.Du.firstChild)}}class Nr{ld;ud;constructor(t,e){this.ld=t,this.ud=e}handleEvent(t){t.stopPropagation(),lr.dictionary.isExpanded=!1,this.ld.redraw(),V.searchData.length=0,Bt.dispatch("showsearch"),this.ud.showWait(),ur.search()}}class Tr{ld;constructor(t){this.ld=t}handleEvent(t){t.stopPropagation(),lr.expand(),this.ld.redraw()}}class fr{ld;constructor(t){this.ld=t}handleEvent(t){t.stopPropagation(),lr.collapse(),this.ld.redraw()}}class yr{ld;constructor(t){this.ld=t}handleEvent(t){t.stopPropagation(),lr.unselectAll(),this.ld.redraw()}}class br{Lu;constructor(t,e){this.Lu=et.create("div"),et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("OsmSearchPaneUI - Search OpenStreetMap"),textContent:"üîé"},this.Lu).addEventListener("click",new Nr(t,e),!1),et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("OsmSearchPaneUI - Expand tree"),textContent:"‚ñº"},this.Lu).addEventListener("click",new Tr(t),!1),et.create("div",{className:"TravelNotes-UI-Button",title:k.getText("OsmSearchPaneUI - Collapse tree"),textContent:"‚ñ∂"},this.Lu).addEventListener("click",new fr(t),!1),et.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:k.getText("OsmSearchPaneUI - Clear tree"),textContent:"‚ùå"},this.Lu).addEventListener("click",new yr(t),!1)}get toolbarHTMLElement(){return this.Lu}}class Ir{ld=null;constructor(t){this.ld=t}handleEvent(t){t.stopPropagation(),lr.selectItem(Number.parseInt(t.target.parentNode.dataset.tanObjId),t.target.checked),this.ld.redraw()}}class Mr{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Dr{ld=null;constructor(t){this.ld=t}handleEvent(t){t.stopPropagation(),lr.expandItem(Number.parseInt(t.target.parentNode.dataset.tanObjId)),this.ld.redraw()}}class Er{vd;dd;pd;_d;md(t){this._d++;const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+this._d,dataset:{ObjId:t.objId}},this.vd);if(!t.isRoot){et.create("input",{type:"checkbox",checked:t.isSelected},e).addEventListener("change",this.pd,!1)}if(0===t.filterTagsArray.length){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:t.isExpanded?"‚ñº":"‚ñ∂"},e).addEventListener("click",this.dd,!1)}et.create("text",{value:t.name},e),t.isExpanded&&t.items.forEach((t=>this.md(t))),this._d--}constructor(){this._d=0,this.vd=et.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"}),this.vd.addEventListener("wheel",new Mr,{passive:!0}),this.pd=new Ir(this),this.dd=new Dr(this),this.md(lr.dictionary)}redraw(){this.vd.textContent="",this.md(lr.dictionary)}get treeHTMLElement(){return this.vd}}class xr{ke;gd;constructor(){this.ke=et.create("div",{className:"TravelNotes-WaitAnimation"}),this.gd=et.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.ke),this.ke.classList.add("TravelNotes-Hidden")}showWait(){this.ke.classList.remove("TravelNotes-Hidden")}hideWait(){this.ke.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.ke}}class Pr{ld;wd;ud;Eu;constructor(t){this.Eu=t,this.ld=new Er,this.ud=new xr,this.wd=new br(this.ld,this.ud)}addControl(){this.Eu.appendChild(this.wd.toolbarHTMLElement),this.Eu.appendChild(this.ld.treeHTMLElement),this.Eu.appendChild(this.ud.waitHTMLElement)}clearControl(){this.Eu.removeChild(this.ld.treeHTMLElement),this.Eu.removeChild(this.wd.toolbarHTMLElement),this.ud.hideWait(),this.Eu.removeChild(this.ud.waitHTMLElement)}}class Cr extends zi{Nd;Td;fd;constructor(t,e){super(t,e),this.Nd=new wr(this.paneData),this.Td=new Pr(this.paneControl),this.fd=new vr}remove(){this.fd.hide(),this.Nd.clearData(),this.Td.clearControl()}add(){this.fd.show(),this.Td.addControl(),this.Nd.addData()}get paneId(){return l.searchPane}get buttonText(){return k.getText("PanesManagerUI - Search")}}const Lr=new class{$s;yd;bd;Id;Md;Pu;ti;Dd;su(){this.Dd||(this.ti=setTimeout((()=>this.ri()),t.travelEditor.timeout))}us(){if(this.Dd)return;this.ti&&(clearTimeout(this.ti),this.ti=null),this.$s.classList.remove("TravelNotes-UI-Minimized"),this.yd.classList.add("TravelNotes-Hidden");const t=this.$s.childNodes;for(let e=1;e<t.length;e++)t[e].classList.remove("TravelNotes-Hidden")}ri(){if(this.Dd)return;this.$s.classList.add("TravelNotes-UI-Minimized"),this.yd.classList.remove("TravelNotes-Hidden");const t=this.$s.childNodes;for(let e=1;e<t.length;e++)t[e].classList.add("TravelNotes-Hidden")}constructor(){this.Dd=!1}pin(){this.Dd=!this.Dd}createUI(e){this.$s||(this.$s=et.create("div",{id:"TravelNotes-UI-MainDiv"},e),this.yd=et.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"Travel¬†&¬†Notes"},this.$s),this.bd=new Vi(this.$s),this.Id=new Si(this.$s),this.Md=new Oi(this.$s),this.Md.addPane(sr),this.Md.addPane(nr),this.Md.addPane(Cr),this.Pu=new Hi(this.$s),this.$s.addEventListener("mouseenter",(()=>this.us()),!1),this.$s.addEventListener("mouseleave",(()=>this.su()),!1),t.travelEditor.startMinimized?(this.ri(),this.Dd=!1):(this.us(),this.Dd=!0))}get travelNotesToolbarUI(){return this.bd}get travelUI(){return this.Id}get panesManagerUI(){return this.Md}get providersToolbarUI(){return this.Pu}};class kr{constructor(){}openDistantFile(t){(new Qs).decompress(t),V.travel.jsonObject=t,V.travel.readOnly=!0,document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const e=V.travel.routes.iterator;for(;!e.done;)c.notEdited===e.value.editionStatus?Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:e.value.objId}):V.editedRouteObjId=e.value.objId;m!==V.editedRouteObjId&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const s=V.travel.notes.iterator;for(;!s.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:s.value.objId});(new $e).zoomToTravel()}}class Sr extends mt{Ed=null;constructor(){super(),this.Ed=et.create("div",{id:"TravelNotes-AboutDialog-AboutDiv"}),L.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2021 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank">https://github.com/wwwouaiebe/TravelNotes</a></p><p>Version : v3.2.0-dev.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.Ed)}get contentHTMLElements(){return[this.Ed]}get title(){return k.getText("AboutDialog - About Travel & Notes")}}class Ar extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(k.getText("MapContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>Ts.setStartPoint(this.eventData.latLng))),new qt(k.getText("MapContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>Ts.addWayPoint(this.eventData.latLng))),new qt(k.getText("MapContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>Ts.setEndPoint(this.eventData.latLng))),new qt(k.getText("MapContextMenu - Add a route"),!0,(()=>gs.addRoute())),new qt(k.getText("MapContextMenu - Hide all routes"),!0,(()=>gs.hideRoutes())),new qt(k.getText("MapContextMenu - Show all routes"),!0,(()=>gs.showRoutes())),new qt(k.getText("MapContextMenu - New travel note"),!0,(()=>He.newTravelNote(this.eventData.latLng))),new qt(k.getText("MapContextMenu - Hide all notes"),!0,(()=>He.hideNotes())),new qt(k.getText("MapContextMenu - Show all notes"),!0,(()=>He.showNotes())),new qt(k.getText("MapContextMenu - Zoom to travel"),!0,(()=>(new $e).zoomToTravel())),new qt(k.getText("MapContextMenu - About Travel & Notes"),!0,(()=>(new Sr).show().catch((()=>{}))))]}}const Rr=new class{xd=!1;async Pd(t){const e=await fetch(t);_===e.status&&e.ok?(new kr).openDistantFile(await e.json()):(V.map.setView([h.defaultValue,h.defaultValue],2),document.title="Travel & Notes")}constructor(){}addReadOnlyMap(t){this.xd||(this.xd=!0,ri.createUI(),pi.setMapLayer("OSM - Color"),this.Pd(t))}addControl(){this.xd||(this.xd=!0,document.title="Travel & Notes",V.map.on("contextmenu",(t=>new Ar(t).show())),V.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),Lr.createUI(et.create("div",{id:"TravelNotes-UI"},document.body)),ri.createUI(),t.layersToolbarUI.haveLayersToolbarUI?pi.createUI():pi.setMapLayer("OSM - Color"),t.mouseUI.haveMouseUI&&(qs.createUI(),qs.saveStatus=u.saved),Rt.showHelp("<p>"+k.getText("Help - Continue with interface1")+"</p><p>"+k.getText("Help - Continue with interface2")+"</p>"),jt.setKeysFromServerFile(),V.travel.jsonObject=(new K).jsonObject,t.travelEditor.startupRouteEdition&&gs.editRoute(V.travel.routes.first.objId),Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate"))}addProvider(t){jt.addProvider(t)}showInfo(t){Rt.showInfo(t)}get overpassApiUrl(){return t.overpassApi.url}get map(){return V.map}get version(){return b}};class Or{Cd(t,e){if("object"==typeof t&&"object"==typeof e){for(const s in e)"object"==typeof e[s]?this.Cd(t[s],e[s]):typeof t[s]==typeof e[s]&&("string"==typeof e[s]?e[s]="color"===s?L.sanitizeToColor(t[s])||e[s]:"url"===s?L.sanitizeToUrl(t[s]).url:L.sanitizeToJsString(t[s]):e[s]=t[s]||e[s]);for(const s in t)"object"==typeof t[s]?("[object Array]"===Object.prototype.toString.call(t[s])?e[s]=e[s]||[]:e[s]=e[s]||{},this.Cd(t[s],e[s])):"string"==typeof e.property?e[s]=L.sanitizeToHtmlString(t[s],[]).htmlString:e[s]=t[s]}}Ld(t){for(const e in t)"object"==typeof t[e]&&this.Ld(t[e]);Object.freeze(t)}constructor(){}overload(e){this.Cd(e,t),this.Ld(t)}}class Br{kd;constructor(){this.kd=S.storageAvailable("localStorage")}handleEvent(){qs.saveStatus=u.modified,this.kd&&Xs.getOpenPromise().then((()=>{Xs.getWritePromise(V.UUID,Js.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(V.UUID,Date.now()))).catch((t=>{t instanceof Error&&console.error(t)}))}}(new class{Sd;Ad;Rd;Od;Bd(){document.addEventListener("routeupdated",(t=>{t.data&&Gs.updateRoute(t.data.removedRouteObjId,t.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(t=>{t.data&&Gs.updateRouteProperties(t.data.routeObjId)}),!1),document.addEventListener("noteupdated",(t=>{t.data&&Gs.updateNote(t.data.removedNoteObjId,t.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(t=>{t.data&&Gs.removeObject(t.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>Gs.removeAllObjects()),!1),document.addEventListener("zoomto",(t=>{t.data&&Gs.zoomTo(t.data.latLng,t.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(t=>{t.data&&Gs.addItineraryPointMarker(t.data.objId,t.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(t=>{t.data&&Gs.addSearchPointMarker(t.data.objId,t.data.latLng,t.data.geometry)}),!1),document.addEventListener("addrectangle",(t=>{t.data&&Gs.addRectangle(t.data.objId,t.data.bounds,t.data.properties)}),!1),document.addEventListener("addwaypoint",(t=>{t.data&&Gs.addWayPoint(t.data.wayPoint,t.data.letter)}),!1),document.addEventListener("layerchange",(t=>{t.data&&Gs.setLayer(t.data.layer)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&Gs.onGeolocationPositionChanged(t.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&Gs.onGeolocationStatusChanged(t.data.status)}),!1),document.addEventListener("roadbookupdate",new Br,!1),document.addEventListener("profileclosed",(t=>{t.data&&os.onProfileClosed(t.data.objId)}),!1),document.addEventListener("uipinned",(()=>Lr.pin()),!1),document.addEventListener("geolocationstatuschanged",(t=>{Lr.travelNotesToolbarUI.geoLocationStatusChanged(t.data.status)}),!1),document.addEventListener("travelnameupdated",(()=>Lr.travelUI.setTravelName()),!1),document.addEventListener("setrouteslist",(()=>Lr.travelUI.routesListUI.setRoutesList()),!1),document.addEventListener("showitinerary",(()=>Lr.panesManagerUI.showPane(l.itineraryPane)),!1),document.addEventListener("updateitinerary",(()=>Lr.panesManagerUI.updatePane(l.itineraryPane)),!1),document.addEventListener("showtravelnotes",(()=>Lr.panesManagerUI.showPane(l.travelNotesPane)),!1),document.addEventListener("updatetravelnotes",(()=>Lr.panesManagerUI.updatePane(l.travelNotesPane)),!1),document.addEventListener("showsearch",(()=>Lr.panesManagerUI.showPane(l.searchPane)),!1),document.addEventListener("updatesearch",(()=>Lr.panesManagerUI.updatePane(l.searchPane)),!1),document.addEventListener("providersadded",(()=>Lr.providersToolbarUI.providersAdded()),!1),document.addEventListener("setprovider",(t=>{t?.data?.provider&&(Lr.providersToolbarUI.provider=t.data.provider)}),!1),document.addEventListener("settransitmode",(t=>{t?.data?.transitMode&&(Lr.providersToolbarUI.transitMode=t.data.transitMode)}),!1)}jd(){window.addEventListener("unload",(()=>localStorage.removeItem(V.UUID))),window.addEventListener("beforeunload",(e=>{if(Xs.closeDb(V.UUID),t.travelNotes.haveBeforeUnloadWarning)return e.returnValue="x","x"}))}Hd(){const t=new URL(window.location);let e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");const s=new URL(e);if(!(t.protocol&&s.protocol&&t.protocol===s.protocol&&t.hostname&&s.hostname&&t.hostname===s.hostname))throw new Error("The distant file is not on the same site than the app");this.Sd=encodeURI(s.href)}catch(t){t instanceof Error&&console.error(t)}const s=t.searchParams.get("lng");s&&s.match(/^[A-Z,a-z]{2}$/)&&(this.Ad=s.toLowerCase())}async Ud(){const e=await fetch(this.Rd+"Config.json");if(_===e.status&&e.ok){const s=await e.json();return s.travelNotes.language=this.Ad||s.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(s.APIKeysDialog.haveUnsecureButtons=!0,s.errorsUI.showHelp=!0,s.layersToolbarUI.theDevil.addButton=!1,s.note.maxManeuversNotes=120,s.note.haveBackground=!0,s.noteDialog.theDevil.addButton=!1,s.printRouteMap.maxTiles=10,s.route.showDragTooltip=w),(new Or).overload(s),V.providers.forEach((e=>{e.userLanguage=t.travelNotes.language})),!0}return!1}async Fd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(k.setTranslations(await t.value.json()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(k.setTranslations(await e.value.json()),this.Od+="Not possible to load the TravelNotes"+this.Ad.toUpperCase()+".json file. English will be used. ",!0):(this.Od+="Not possible to load the translations. ",!1)}async Kd(t,e){if("fulfilled"===t.status&&_===t.value.status&&t.value.ok){const e=await t.value.json();return se.loadJson(e),!0}if("fulfilled"===e.status&&_===e.value.status&&e.value.ok){const t=await e.value.json();return se.loadJson(t),this.Od+="Not possible to load the TravelNotesNoteDialog"+this.Ad.toUpperCase()+".json file. English will be used. ",!0}return this.Od+="Not possible to load the translations for the note dialog. ",!1}async Wd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(lr.parseDictionary(await t.value.text()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(lr.parseDictionary(await e.value.text()),this.Od+="Not possible to load the TravelNotesSearchDictionary"+this.Ad.toUpperCase()+".csv file. English will be used. ",!0):(this.Od+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async Vd(t){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(vs.addMapLayers(await t.value.json()),!0):(this.Od+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async zd(){const t=await Promise.allSettled([fetch(this.Rd+this.Ad.toUpperCase()+".json"),fetch(this.Rd+"EN.json"),fetch(this.Rd+"NoteDialog"+this.Ad.toUpperCase()+".json"),fetch(this.Rd+"NoteDialogEN.json"),fetch(this.Rd+"SearchDictionary"+this.Ad.toUpperCase()+".csv"),fetch(this.Rd+"SearchDictionaryEN.csv"),fetch(this.Rd+"Layers.json")]),e=await this.Fd(t[0],t[1])&&await this.Kd(t[2],t[3])&&await this.Wd(t[4],t[5])&&await this.Vd(t[6]);return""!==this.Od&&e?Rt.showError(this.Od):""!==this.Od&&(document.body.textContent=this.Od),e}Gd(){const t=document.createElement("div");t.id="TravelNotes-Map",document.body.appendChild(t),V.map=window.L.map(t.id,{attributionControl:!1,zoomControl:!1}).setView([h.defaultValue,h.defaultValue],0),this.Sd?Rr.addReadOnlyMap(this.Sd):(this.jd(),Rr.addControl("TravelNotes-UI"))}constructor(){this.Rd=window.location.href.substr(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",this.Od=""}async loadApp(){this.Bd(),window.TaN=Rr,this.Hd(),await this.Ud()?(this.Ad=this.Ad||t.travelNotes.language||"fr",Rt.createUI(),await this.zd()&&this.Gd()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();