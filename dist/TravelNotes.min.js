/**
 * 
 * @source: https://github.com/wwwouaiebe/TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * travelnotes - version 3.6.0
 * Build 00066 - 2022-06-03T08:22:43+0200 
 * Copyright 2017 2022 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";const t={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},watch:!0,zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},paneUI:{switchToItinerary:!1,switchToTravelNotes:!1,switchToSearch:!0},printRouteMap:{firefoxBrowser:!0,isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,printNotes:!0,borderWidth:10,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashIndex:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:2.5,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};class e{static get minColorValue(){return 0}static get maxColorValue(){return 255}static get rowsNumber(){return 6}static get cellsNumber(){return 6}static get deltaColor(){return 51}static get sliderMaxValue(){return 100}static get sliderStep(){return 20}static get initialRed(){return 0}}class s{static get d0(){return 0}static get d90(){return 90}static get d180(){return 180}static get d270(){return 270}static get d360(){return 360}static get d540(){return 540}static get toRadians(){return Math.PI/180}static get fromRadians(){return 180/Math.PI}}class i{static get fixed(){return 2}static get invalid(){return-1}static get defaultValue(){return 0}static get metersInKm(){return 1e3}}class r{static get fixed(){return 2}static get defaultValue(){return 0}}class o{static get refusedByUser(){return-1}static get disabled(){return 0}static get inactive(){return 1}static get active(){return 2}}class a{static get width(){return 40}static get height(){return 40}static get svgViewboxDim(){return 200}}class n{static get atStart(){return-1}static get onRoute(){return 0}static get atEnd(){return 1}}class h{static get defaultValue(){return 0}static get fixed(){return 6}static get maxLat(){return 90}static get minLat(){return-90}static get maxLng(){return 180}static get minLng(){return-180}}class l{static get invalidPane(){return"43a6a53e-008a-4910-80a6-7a87d301ea15"}static get itineraryPane(){return"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7"}static get travelNotesPane(){return"dffe782b-07df-4b81-a318-f287c0cf5ec6"}static get searchPane(){return"228f00d7-43a8-4c13-897d-70400cb6dd58"}}class c{static get notEdited(){return 0}static get editedNoChange(){return 1}static get editedChanged(){return 2}}class u{static get notSaved(){return"🔴"}static get modified(){return"🟡"}static get saved(){return"🟢"}}const v=20,d=6371e3,p=16,_=200,m=-1,g=[.3,10,1],w=-1,N="http://www.w3.org/2000/svg",T=20;class f{static t=0;static get nextObjId(){return++f.t}}const b="2.4.0",y="v3.6.0";class I{i="";o=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];h=[];constructor(t,e){if(w===this.o.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.i=t,this.h=e,Object.freeze(this.h)}get name(){return this.i}get version(){return b}get properties(){return this.h}get jsonObject(){return{name:this.i,version:b}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.i);if(this.i!==t.name)throw new Error("Invalid name for "+this.i);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.i)}}class M{l=null;u=w;constructor(t){this.l=t}get value(){return this.u<this.l.length?this.l.at(this.u):null}get previous(){return 0>=this.u?null:this.l.at(this.u-1)}get next(){return this.u<this.l.length-1?this.l.at(this.u+1):null}get done(){return++this.u>=this.l.length}get first(){return 0===this.u}get last(){return this.u>=this.l.length-1}get index(){return this.u}}class D{v;p;_;m(t){return this.v.findIndex((e=>e.objId===t))}g(t,e,s){let i=this.m(t);if(w===i)throw new Error("invalid objId for next or previous function");if(1!==s&&-1!==s)throw new Error("invalid direction");let r=e;for(r||(r=()=>!0),i+=s;w<i&&i<this.v.length&&!r(this.v[i]);)i+=s;return w===i||this.v.length===i?null:this.v[i]}constructor(t){this.v=[],this._=t;const e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.p=e.objType.name}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.p)throw new Error("invalid object name for add function");this.v.push(t)}at(t){return t<this.v.length&&t>w?this.v[t]:null}forEach(t){let e=null;const s=this.iterator;for(;!s.done;)e=t(s.value,e);return e}getAt(t){const e=this.m(t);return w===e?null:this.v[e]}moveTo(t,e,s){let i=this.m(t),r=this.m(e);if(w===i||w===r)throw new Error("invalid objId for function  myMoveTo");s||r++,this.v.splice(r,0,this.v[i]),r<i&&i++,this.v.splice(i,1)}next(t,e){return this.g(t,e,1)}previous(t,e){return this.g(t,e,-1)}remove(t){const e=this.m(t);if(w===e)throw new Error("invalid objId for remove function");this.v.splice(e,1)}removeAll(t){t?this.v.splice(1,this.v.length-2):this.v.length=0}replace(t,e){const s=this.m(t);if(w===s)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.p)throw new Error("invalid object name for replace function");this.v[s]=e}reverse(){this.v.reverse()}sort(t){this.v.sort(t)}swap(t,e){const s=this.m(t);if(w===s||0===s&&e||this.v.length-1===s&&!e)throw new Error("invalid objId for swap function");const i=e?-1:1,r=this.v[s];this.v[s]=this.v[s+i],this.v[s+i]=r}get first(){return this.v[0]}get iterator(){return new M(this)}get last(){return this.v[this.v.length-1]}get length(){return this.v.length}get jsonObject(){const t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.v.length=0,Array.isArray(t)&&t.forEach((t=>{const e=new this._;e.jsonObject=t,this.add(e)}))}}class x{N;T;constructor(t,e){this.N=t,this.T=e}get url(){return this.N}get errorsString(){return this.T}}class E{I;T;constructor(t,e){this.I=t,this.T=e}get htmlString(){return this.I}get errorsString(){return this.T}}class P{M=new Map;constructor(){this.M.set("a",["href","target"]),this.M.set("div",[]),this.M.set("del",[]),this.M.set("em",[]),this.M.set("figcaption",[]),this.M.set("figure",[]),this.M.set("h1",[]),this.M.set("h2",[]),this.M.set("h3",[]),this.M.set("h4",[]),this.M.set("h5",[]),this.M.set("h6",[]),this.M.set("hr",[]),this.M.set("img",["src","alt","width","height"]),this.M.set("ins",[]),this.M.set("li",[]),this.M.set("mark",[]),this.M.set("ol",[]),this.M.set("p",[]),this.M.set("s",[]),this.M.set("small",[]),this.M.set("strong",[]),this.M.set("span",[]),this.M.set("sub",[]),this.M.set("sup",[]),this.M.set("ul",[]),this.M.set("svg",["xmlns","viewBox","class"]),this.M.set("text",["x","y","text-anchor"]),this.M.set("polyline",["points","class","transform"]),this.M.set("#text",[])}getValidAttributesNames(t){return this.M.get(t).concat(["id","class","dir","title"])}getValidNodeName(t){const e=t.toLowerCase();return this.M.get(e)?e:""}}class C{D="";P="";static C=new P;L(t){return t.replaceAll(/\u003c/g,"&lt;").replaceAll(/\u003e/g,"&gt;").replaceAll(/\u0022/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}S(t,e){const s=this.sanitizeToUrl(t,e).url;""===s&&""!==t?this.P+="\nAn invalid url ("+t+") was removed from a "+e+" attribute":this.D+=" "+e+'="'+s+'"'}k(t,e){C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(this.D+=" "+e+'="'+this.L(t.getAttributeNS(null,e))+'"',t.removeAttributeNS(null,e))}))}A(t,e){t.hasAttribute("target")&&(this.D+=' rel="noopener noreferrer"'),C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttribute(e)&&("href"===e||"src"===e?this.S(t.getAttribute(e),e):this.D+=" "+e+'="'+this.L(t.getAttribute(e))+'"',t.removeAttribute(e))}))}R(t){for(let e=0;e<t.attributes.length;e++)"rel"!==t.attributes[e].name&&(this.P+="\nAn unsecure attribute "+t.attributes[e].name+'="'+t.attributes[e].value+'" was removed.')}O(t){const e=t.childNodes;for(let s=0;s<e.length;s++){const e=t.childNodes[s],i=C.C.getValidNodeName(e.nodeName);""===i?this.P+="\nAn invalid tag "+e.nodeName+" was removed":"#text"===i?this.D+=this.L(e.nodeValue):(this.D+="<"+i,"svg"===i||"text"===i||"polyline"===i?this.k(e,i):this.A(e,i),this.D+=">",this.O(e),this.D+="</"+i+">",e.attributes&&this.R(e))}}B(t,e){const s=document.createElementNS(N,e);return C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(s.setAttributeNS(null,e,t.getAttributeNS(null,e)),t.removeAttributeNS(null,e))})),s}j(t,e){const s=document.createElement(e);return C.C.getValidAttributesNames(e).forEach((e=>{if(t.hasAttribute(e))if("href"===e||"src"===e){const i=this.sanitizeToUrl(t.getAttribute(e),e).url;""!==i&&s.setAttribute(e,i)}else s.setAttribute(e,t.getAttribute(e))})),t.hasAttribute("target")&&s.setAttribute("rel","noopener noreferrer"),s}H(t,e){const s=t.childNodes;for(let i=0;i<s.length;i++){const s=t.childNodes[i],r=C.C.getValidNodeName(s.nodeName);if("#text"===r)e.appendChild(document.createTextNode(s.nodeValue));else if(""!==r){const t="svg"===r||"text"===r||"polyline"===r?this.B(s,r):this.j(s,r);e.appendChild(t),this.H(s,t)}}}constructor(){}sanitizeToHtmlElement(t,e){const s=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html"),i=new DocumentFragment;s&&"#document"===s.nodeName?(this.H(s.body.firstChild,i),e.appendChild(i)):e.textContent=""}clone(t){const e=document.createElement(t.tagName);return this.H(t,e),e}sanitizeToHtmlString(t){this.D="",this.P="";const e=(new DOMParser).parseFromString("<div>"+t.replace("&nbsp;","਀")+"</div>","text/html");return e&&"#document"===e.nodeName?(this.O(e.body.firstChild),new E(this.D,this.P)):new E("","Parsing error")}sanitizeToUrl(t,e){const s=e||"href",i=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!i||"#document"!==i.nodeName)return new x("","Parsing error");const r=i.body.firstChild;let o="";for(let t=0;t<r.childNodes.length;t++){if("#text"!==r.childNodes[t].nodeName)return new x("","Invalid characters found in the url");o+=r.childNodes[t].nodeValue}if(o=o.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),o!==t)return new x("","Invalid characters found in the url");const a=["https:"];if("http:"!==window.location.protocol&&"href"!==s||a.push("http:"),"href"===s){a.push("mailto:"),a.push("sms:"),a.push("tel:");const t=o.match(/^\u0023\w*/);if(t&&o===t[0])return new x(o,"")}"src"===s&&a.push("data:");let n=null;try{n=new URL(o)}catch(t){return new x("","Invalid url string")}if(w===a.indexOf(n.protocol))return new x("","Invalid protocol "+n.protocol);if(w!==["sms:","tel:"].indexOf(n.protocol))return n.pathname.match(/^\+[0-9,*,\u0023]*$/)?new x(o,""):new x("","Invalid sms: or tel: url");try{encodeURIComponent(n.href)}catch(t){return new x("","Invalid character in url")}return new x(o,"")}sanitizeToJsString(t){const e=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";const s=e.body.firstChild;let i="";for(let t=0;t<s.childNodes.length;t++){if("#text"!==s.childNodes[t].nodeName)return"";i+=s.childNodes[t].nodeValue}return i=i.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),i}sanitizeToColor(t){const e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}}const L=new C;const S=new class{U=new Map;constructor(){}setTranslations(t){t.forEach((t=>this.U.set(t.msgid,L.sanitizeToJsString(t.msgstr))))}getText(t,e){let s=this.U.get(t);return e&&s&&Object.getOwnPropertyNames(e).forEach((t=>s=s.replace("{"+t+"}",e[t]))),s||t}};const k=new class{constructor(){}get UUID(){const t=["","","","-","","-","","-","","-","","","","","",""],e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let s="";for(let i=0;i<16;i++)s+=e[i].toString(p).padStart(2,"0")+t[i];return s}storageAvailable(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch(t){return!1}}openFile(t,e){const s=document.createElement("input");s.type="file",e&&(s.accept=e),s.addEventListener("change",t,!1),s.click()}saveFile(t,e,s){try{const i=s?window.URL.createObjectURL(new File([e],t,{type:s})):URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.click(),window.URL.revokeObjectURL(i)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){const e=Math.floor(t);if(0===e)return"";const s=Math.floor(e/86400),i=Math.floor(e%86400/3600),r=Math.floor(e%3600/60),o=Math.floor(e%60);return 0<s?s+" "+S.getText("Utilities - Day")+" "+i+" "+S.getText("Utilities - Hour"):0<i?i+" "+S.getText("Utilities - Hour")+" "+r+" "+S.getText("Utilities - Minute"):0<r?r+" "+S.getText("Utilities - Minute"):o+" "+S.getText("Utilities - Second")}formatDistance(t){const e=Math.floor(t);return 0>=e?"0 km":Math.floor(e/i.metersInKm)+","+Math.floor(e%i.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}numberToDMS(t){let e=t,s=Math.floor(t);e-=s;let i=Math.floor(60*e);e-=i/60,e*=3600;let r=Math.floor(e);return e-=r,e=Math.floor(100*e),s.toString()+"° "+i.toString()+"' "+r+'" '+e}formatLatDMS(t){return t>0?this.numberToDMS(t)+" N":this.numberToDMS(-t)+" S"}formatLngDMS(t){return t>0?this.numberToDMS(t)+" E":this.numberToDMS(-t)+" W"}formatLatLngDMS(t){return 0===t[0]&&0===t[1]?"":this.formatLatDMS(t[0])+" - "+this.formatLngDMS(t[1])}formatLat(t){return t>0?t.toFixed(h.fixed)+" N":(-t).toFixed(h.fixed)+" S"}formatLng(t){return t>0?t.toFixed(h.fixed)+" E":(-t).toFixed(h.fixed)+" W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+" - "+this.formatLng(t[1])}};class A{F;K(){this.F.routes.forEach((t=>{t.dashArray=0,t.hidden=!1}))}W(){this.F.routes.forEach((t=>{t.edited=c.notEdited}))}V(){this.W(),this.F.editedRoute={name:"",wayPoints:[{name:"",lat:0,lng:0,objId:2,objType:{name:"WayPoint",version:"1.4.0"}},{name:"",lat:0,lng:0,objId:3,objType:{name:"WayPoint",version:"1.4.0"}}],notes:[],itinerary:{itineraryPoints:[],maneuvers:[],provider:"",transitMode:"",objId:1,objType:{name:"Itinerary",version:"1.4.0"}},width:3,color:"_private_ff0000",dashArray:0,chain:!0,distance:0,duration:0,edited:c.notEdited,hidden:!1,chainedDistance:0,objId:4,objType:{name:"Route",version:"1.4.0"}}}G(){if(this.F.userData.layerId){const t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===this.F.userData.layerId));this.F.layerName=t?t.layerName:"OSM - Color"}else this.F.layerName="OSM - Color"}Z(t){t.forEach((t=>{t.elev=r.defaultValue}))}X(){this.F.routes.forEach((t=>{t.itinerary.hasProfile=!1,t.itinerary.ascent=0,t.itinerary.descent=0,this.Z(t.itinerary.itineraryPoints)})),this.F.editedRoute.itinerary.hasProfile=!1,this.F.editedRoute.itinerary.ascent=0,this.F.editedRoute.itinerary.descent=0,this.Z(this.F.editedRoute.itinerary.itineraryPoints)}J(t){t.itinerary.maneuvers.forEach((t=>{"kArriveDefault"===t.iconName&&(t.distance=i.defaultValue)}))}Y(t){t.wayPoints.forEach((t=>{t.address=t.name,t.name=""}))}q(){this.F.routes.forEach((t=>{t.editionStatus=t.edited,this.J(t),this.Y(t)})),this.F.editedRoute.editionStatus=this.F.editedRoute.edited,this.J(this.F.editedRoute),this.Y(this.F.editedRoute)}$(){this.F.routes.forEach((t=>{t.dashIndex=t.dashArray})),this.F.editedRoute.dashIndex=this.F.editedRoute.dashArray}tt(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}et(t){"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.tt(t.iconContent),t.popupContent=this.tt(t.popupContent),t.tooltipContent=this.tt(t.tooltipContent),t.phone=this.tt(t.phone),t.address=this.tt(t.address)}st(){this.F.notes.forEach((t=>{this.et(t)})),this.jsonTravel.routes.forEach((t=>{t.notes.forEach((t=>{this.et(t)}))}))}it(){switch(this.F.objType.version){case"1.0.0":this.K();case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":this.V();case"1.5.0":this.G();case"1.6.0":this.X();case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":this.q();case"1.12.0":case"1.13.0":this.st();case"2.0.0":case"2.1.0":case"2.2.0":case"2.3.0":this.$(),this.F.objType.version="2.4.0";break;default:throw new Error("invalid version for travel")}}constructor(){}update(t){t.objType.version!==b&&(this.F=t,this.it())}}class R{constructor(){}validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+this.objType.name);this.objType.validate(t.objType),"Travel"===this.objType.name&&this.objType.version!==t.objType.version&&(new A).update(t);const e=Object.getOwnPropertyNames(t);return this.objType.properties.forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+this.objType.name)})),t}}class O extends R{static rt=new I("WayPoint",["address","name","lat","lng","objId"]);ot="";nt="";ht=h.defaultValue;lt=h.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get address(){return this.nt}set address(t){this.nt="string"==typeof t?L.sanitizeToJsString(t):""}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=k.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objId(){return this.t}get objType(){return O.rt}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.address=e.address,this.name=e.name,this.lat=e.lat,this.lng=e.lng,this.t=f.nextObjId}}class B extends R{static rt=new I("ItineraryPoint",["lat","lng","distance","elev","objId"]);ht=h.defaultValue;lt=h.defaultValue;ct=i.defaultValue;ut=r.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get elev(){return this.ut}set elev(t){this.ut="number"==typeof t?t:h.defaultValue}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objType(){return B.rt}get objId(){return this.t}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),elev:parseFloat(this.elev.toFixed(r.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.elev=e.elev,this.t=f.nextObjId}}class j extends R{static rt=new I("Maneuver",["iconName","instruction","distance","duration","itineraryPointObjId","objId"]);vt="";dt="";_t=m;ct=i.defaultValue;gt=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconName(){return this.vt}set iconName(t){this.vt="string"==typeof t?L.sanitizeToJsString(t):""}get instruction(){return this.dt}set instruction(t){this.dt="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPointObjId(){return this._t}set itineraryPointObjId(t){this._t="number"==typeof t?t:m}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get duration(){return this.gt}set duration(t){this.gt="number"==typeof t?t:i.defaultValue}get objType(){return j.rt}get objId(){return this.t}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconName=e.iconName,this.instruction=e.instruction,this.distance=e.distance,this.duration=e.duration,this.itineraryPointObjId=e.itineraryPointObjId,this.t=f.nextObjId}}class H extends R{static rt=new I("Itinerary",["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"]);t=m;wt=!1;Nt=0;Tt=0;ft="";bt="";yt=new D(B);It=new D(j);constructor(){super(),this.t=f.nextObjId}get hasProfile(){return this.wt}set hasProfile(t){this.wt="boolean"==typeof t&&t}get ascent(){return this.Nt}set ascent(t){this.Nt="number"==typeof t?Number.parseInt(t):0}get descent(){return this.Tt}set descent(t){this.Tt="number"==typeof t?Number.parseInt(t):0}get provider(){return this.ft}set provider(t){this.ft="string"==typeof t?L.sanitizeToJsString(t):""}get transitMode(){return this.bt}set transitMode(t){this.bt="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPoints(){return this.yt}get maneuvers(){return this.It}get objType(){return H.rt}get objId(){return this.t}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.hasProfile=e.hasProfile,this.ascent=e.ascent,this.descent=e.descent,this.itineraryPoints.jsonObject=e.itineraryPoints,this.maneuvers.jsonObject=e.maneuvers,this.provider=e.provider,this.transitMode=e.transitMode,this.t=f.nextObjId;const s=new Map;let i=0;const r=this.itineraryPoints.iterator;for(;!r.done;)s.set(e.itineraryPoints[i].objId,r.value.objId),i++;const o=this.maneuvers.iterator;for(;!o.done;)o.value.itineraryPointObjId=s.get(o.value.itineraryPointObjId)}}class U extends R{static rt=new I("Note",["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"]);Mt=a.height;Dt=a.width;xt="";Et="";Pt="";Ct="";N="";nt="";Lt=h.defaultValue;St=h.defaultValue;ht=h.defaultValue;lt=h.defaultValue;ct=i.invalid;kt=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconHeight(){return this.Mt}set iconHeight(t){this.Mt="number"==typeof t?t:a.height}get iconWidth(){return this.Dt}set iconWidth(t){this.Dt="number"==typeof t?t:a.width}get iconContent(){return this.xt}set iconContent(t){this.xt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get popupContent(){return this.Et}set popupContent(t){this.Et="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get tooltipContent(){return this.Pt}set tooltipContent(t){this.Pt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get phone(){return this.Ct}set phone(t){this.Ct="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get url(){return this.N}set url(t){this.N="string"==typeof t?encodeURI(L.sanitizeToUrl(t).url):""}get address(){return this.nt}set address(t){this.nt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get iconLat(){return this.Lt}set iconLat(t){this.Lt="number"==typeof t?t:h.defaultValue}get iconLng(){return this.St}set iconLng(t){this.St="number"==typeof t?t:h.defaultValue}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.invalid}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get isRouteNote(){return this.ct!==i.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.Lt=t[0],this.St=t[1]):(this.Lt=h.defaultValue,this.St=h.defaultValue)}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objType(){return U.rt}get objId(){return this.t}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(h.fixed)),iconLng:parseFloat(this.iconLng.toFixed(h.fixed)),lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconHeight=e.iconHeight,this.iconWidth=e.iconWidth,this.iconContent=e.iconContent,this.popupContent=e.popupContent,this.tooltipContent=e.tooltipContent,this.phone=e.phone,this.url=e.url,this.address=e.address,this.iconLat=e.iconLat,this.iconLng=e.iconLng,this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class F extends R{static rt=new I("Route",["name","wayPoints","notes","itinerary","width","color","dashIndex","chain","chainedDistance","distance","duration","editionStatus","hidden","objId"]);ot="";At=new D(O);Rt=new D(U);Ot=new H;Bt=t.route.width;jt=t.route.color;Ht=t.route.dashIndex;Ut=!0;kt=i.defaultValue;ct=i.defaultValue;gt=i.defaultValue;Ft=c.notEdited;Kt=!1;t=m;constructor(){super(),this.At.add(new O),this.At.add(new O),this.t=f.nextObjId}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get wayPoints(){return this.At}get notes(){return this.Rt}get itinerary(){return this.Ot}get width(){return this.Bt}set width(e){this.Bt="number"==typeof e?e:t.route.width}get color(){return this.jt}set color(e){this.jt="string"==typeof e&&L.sanitizeToColor(e)||t.route.color}get dashIndex(){return this.Ht}set dashIndex(e){this.Ht="number"==typeof e&&t.route.dashChoices[e]?e:0}get dashString(){let e="";return t.route.dashChoices[this.Ht].iDashArray.forEach((t=>e+=String(t*this.Bt)+",")),e.substring(0,e.length-1)}get chain(){return this.Ut}set chain(t){this.Ut="boolean"==typeof t&&t}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get duration(){return this.gt}set duration(t){this.gt="number"==typeof t?t:i.defaultValue}get editionStatus(){return this.Ft}set editionStatus(t){this.Ft="number"==typeof t?t:c.notEdited}get hidden(){return this.Kt}set hidden(t){this.Kt="boolean"==typeof t&&t}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.t}get objType(){return F.rt}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&h.defaultValue!==e.lat&&h.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashIndex:this.dashIndex,chain:this.chain,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.name=e.name,this.wayPoints.jsonObject=e.wayPoints,this.notes.jsonObject=e.notes,this.itinerary.jsonObject=e.itinerary,this.width=e.width,this.color=e.color,this.dashIndex=e.dashIndex,this.chain=e.chain,this.distance=e.distance,this.duration=e.duration,this.editionStatus=e.editionStatus,this.hidden=e.hidden,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class K extends R{static rt=new I("Travel",["editedRoute","routes","notes","layerName","name","readOnly","objId"]);Wt=new F;Vt=new D(F);Rt=new D(U);zt="OSM - Color";ot="";Gt=!1;t=m;constructor(){super(),this.Vt.add(new F),this.t=f.nextObjId}get editedRoute(){return this.Wt}set editedRoute(t){this.Wt="Route"===t?.objType?.name?t:new F}get routes(){return this.Vt}get notes(){return this.Rt}get layerName(){return this.zt}set layerName(t){this.zt="string"==typeof t?L.sanitizeToJsString(t):"OSM - Color"}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get readOnly(){return this.Gt}set readOnly(t){this.Gt="boolean"!=typeof t||t}get objId(){return this.t}get objType(){return K.rt}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName,this.name=e.name,this.readOnly=e.readOnly,this.routes.jsonObject=e.routes,this.notes.jsonObject=e.notes,this.t=f.nextObjId}}class W{ft="";bt="";constructor(){}get provider(){return this.ft}set provider(t){this.ft="string"==typeof t?t:""}get transitMode(){return this.bt}set transitMode(t){this.bt="string"==typeof t?t:""}}const V=new class{Zt;Xt;Jt;Yt;qt;$t;Qt;te;constructor(){this.Zt=new Map,this.Xt=new Map,this.Jt=new W,this.Yt=k.UUID,this.qt=null,this.$t=new K,this.Qt=m,this.te=[]}get map(){return this.qt}set map(t){this.qt||(this.qt=t)}get travel(){return this.$t}get editedRouteObjId(){return this.Qt}set editedRouteObjId(t){this.Qt="number"==typeof t?t:m}get searchData(){return this.te}get providers(){return this.Zt}get mapObjects(){return this.Xt}get routing(){return this.Jt}get UUID(){return this.Yt}};class z{ht;lt;constructor(t,e){this.ht=t,this.lt=e}static clone(t){return new z(t.lat,t.lng)}get latLng(){return[this.ht,this.lt]}get lat(){return this.ht}get lng(){return this.lt}}class G extends z{ct;constructor(t,e,s){super(t,e),this.ct=s}get distance(){return this.ct}}class Z extends G{ut;Nt;constructor(t,e,s,i,r){super(t,e,s),this.ut=i,this.Nt=r}get elev(){return this.ut}get ascent(){return this.Nt}}class X{ee;se;constructor(t,e){this.ee="string"==typeof t?t:"",this.se="string"==typeof e?e:""}get providerName(){return this.ee}get providerKey(){return this.se}}class J{static get ie(){return 100}constructor(){}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let s=0;const i=t.itinerary.itineraryPoints.iterator;for(;s<e&&!i.done;)s+=i.value.distance;const r=i.value;i.done;const o=(r.distance-s+e)/r.distance;return new Z(r.lat+(i.value.lat-r.lat)*o,r.lng+(i.value.lng-r.lng)*o,e,r.elev+(i.value.elev-r.elev)*o,J.ie*(i.value.elev-r.elev)/r.distance)}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;const s=t.itinerary.itineraryPoints.iterator;s.done;let r=Number.MAX_VALUE;const o=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1]));let a=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng)),n=null,h=i.defaultValue,l=s.value.distance;for(;!s.done;){const t=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng));let e=window.L.LineUtil.pointToSegmentDistance(o,a,t);e<r&&(r=e,n=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(o,a,t)),h=l-n.distanceTo(window.L.latLng(s.value.lat,s.value.lng))),l+=s.value.distance,a=t}return new G(n.lat,n.lng,h)}getLatLngBounds(t){const e=window.L.latLng([h.maxLat,h.maxLng]),s=window.L.latLng([h.minLat,h.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),s.lat=Math.max(s.lat,t[0]),s.lng=Math.max(s.lng,t[1])})),window.L.latLngBounds(e,s)}getSquareBoundingBox(t,e){const i=t[0]*s.toRadians,r=e/d*s.fromRadians,o=Math.acos((Math.cos(e/d)-Math.sin(i)**2)/Math.cos(i)**2)*s.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-r,t[1]-o]),window.L.latLng([t[0]+r,t[1]+o]))}project(t,e){const s=V.map.project(window.L.latLng(t),e);return[s.x,s.y]}screenCoordToLatLng(t,e){const s=V.map.containerPointToLatLng(window.L.point(t,e));return[s.lat,s.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}}const Y=new J;const q=new class{re(t){return(t+s.d540)%s.d360-s.d180}constructor(){}arcFromSummitArcArc(t,e,s){return Math.acos(Math.cos(e)*Math.cos(s)+Math.sin(e)*Math.sin(s)*Math.cos(t))}summitFromArcArcArc(t,e,s){return Math.acos((Math.cos(s)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,e){if(t[0]===e[0]&&t[1]===e[1])return 0;const i=t[0]*s.toRadians,r=e[0]*s.toRadians,o=(this.re(e[1])-this.re(t[1]))*s.toRadians;return Math.acos(Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos(o))*d}};class ${oe;ae;constructor(t,e){this.oe=t,this.ae=e}get note(){return this.oe}get route(){return this.ae}}class Q{constructor(){}distance=Number.MAX_VALUE;route=null;distanceOnRoute=0;latLngOnRoute=[h.defaultValue,h.defaultValue]}const tt=new class{ne(t,e,s){if(t.objId!==V.editedRouteObjId){const i=Y.getClosestLatLngDistance(t,e);if(i){const r=q.pointsDistance(e,i.latLng);r<s.distance&&(s.route=t,s.distance=r,s.latLngOnRoute=i.latLng,s.distanceOnRoute=i.distance)}}}constructor(){}getNearestRouteData(t){const e=new Q;return V.travel.routes.forEach((s=>this.ne(s,t,e))),m!==V.editedRouteObjId&&this.ne(V.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=V.travel.routes.getAt(t),e||t===V.travel.editedRoute.objId&&(e=V.travel.editedRoute),e}getNoteAndRoute(t){let e=null,s=null;if(e=V.travel.notes.getAt(t),!e){const i=V.travel.routes.iterator;for(;!i.done&&!e;)e=i.value.notes.getAt(t),e&&(s=i.value);e||(e=V.travel.editedRoute.notes.getAt(t),e&&(s=V.travel.editedRoute))}return new $(e,s)}getWayPoint(t){let e=V.travel.editedRoute.wayPoints.getAt(t);if(!e){const s=V.travel.routes.iterator;for(;!s.done&&!e;)e=s.value.wayPoints.getAt(t)}return e}};const et=new class{he(t,e){for(const s in e)try{if("dataset"===s){const s=e.dataset;for(const e in s)t.dataset["tan"+e]=s[e]}else t[s]=e[s]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){}create(t,e,s){let i=null;return"text"===t.toLowerCase()?i=document.createTextNode(e.value||""):(i="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.he(i,e)),s&&s.appendChild(i),i}};class st{le;constructor(t){this.le=t}handleEvent(){this.le.onOk()}}class it{le;constructor(t){this.le=t}handleEvent(){this.le.onCancel()}}class rt{ce;constructor(t){this.ce=t}handleEvent(t){this.ce.dragStartX=t.screenX,this.ce.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class ot{ce;ue;ve;constructor(t,e,s){this.ce=t,this.ue=e,this.ve=s}handleEvent(t){this.ce.dialogX+=t.screenX-this.ce.dragStartX,this.ce.dialogX=Math.min(Math.max(this.ce.dialogX,v),this.ve.clientWidth-this.ue.clientWidth-v),this.ce.dialogY+=t.screenY-this.ce.dragStartY,this.ce.dialogY=Math.max(this.ce.dialogY,v);const e=this.ve.clientHeight-Math.max(this.ce.dialogY,0)-v;this.ue.style.left=String(this.ce.dialogX)+"px",this.ue.style.top=String(this.ce.dialogY)+"px",this.ue.style["max-height"]=String(e)+"px"}}class at{le;constructor(t){this.le=t}handleEvent(t){this.le.keyboardELEnabled&&("Escape"===t.key||"Esc"===t.key?this.le.onCancel():"Enter"===t.key&&this.le.onOk())}}class nt{de;constructor(){}handleEvent(t){if("start"===t.action)return void(this.de=V.map.getCenter());const e=Y.screenCoordToLatLng(t.startX,t.startY),s=Y.screenCoordToLatLng(t.endX,t.endY);V.map.panTo([this.de.lat+e[0]-s[0],this.de.lng+e[1]-s[1]])}}class ht{static get pe(){return 25}_e;me;constructor(){this._e=0}handleEvent(t){if("start"===t.action)return this._e=V.map.getZoom(),void(this.me=window.L.point(t.clientX,t.clientY));let e=Math.floor(this._e+(t.startY-t.endY)/ht.pe);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(this.me,e)}}class lt{constructor(){}handleEvent(t){if(!t.target.classList.contains("TravelNotes-Background"))return;let e=V.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class ct{constructor(){}handleEvent(t){t.preventDefault()}}class ut{constructor(){}handleEvent(t){t.preventDefault()}}class vt{ge=!1;we=0;Ne=0;Te=null;fe=0;be="";ye(t,e){const s=new Event(this.be);s.startX=this.we,s.startY=this.Ne,s.endX=t.screenX,s.endY=t.screenY,s.clientX=t.clientX,s.clientY=t.clientY,s.action=e,this.Te.dispatchEvent(s)}constructor(t,e){switch(this.Te=t,this.fe=e,e){case 0:this.be="leftpan";break;case 1:this.be="middlepan";break;case 2:this.be="rightpan";break;default:this.fe=w}}handleEvent(t){switch(t.type){case"mousedown":t.button===this.fe&&t.target===this.Te&&(this.we=t.screenX,this.Ne=t.screenY,this.ge=!0,this.ye(t,"start"));break;case"mouseup":t.button!==this.fe||!this.ge||this.we===t.screenX&&this.Ne===t.screenY||this.ye(t,"end"),this.ge=!1;break;case"mousemove":this.ge&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.ye(t,"move"))}}}class dt{Te;Ie;static get LEFT_BUTTON(){return 0}static get MIDDLE_BUTTON(){return 1}static get RIGHT_BUTTON(){return 2}constructor(t,e){this.Te=t,this.Ie=new vt(t,e??0),this.Te.addEventListener("mousedown",this.Ie),this.Te.addEventListener("mouseup",this.Ie),this.Te.addEventListener("mousemove",this.Ie)}detach(){this.Te.removeEventListener("mousedown",this.Ie),this.Te.removeEventListener("mouseup",this.Ie),this.Te.removeEventListener("mousemove",this.Ie),this.Ie=null,this.Te=null}}class pt{constructor(){}dragStartX=0;dragStartY=0;dialogX=0;dialogY=0}class _t{Me=null;De=null;xe=null;Ee=null;Pe=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.Me=t.firstButtonText;break;case"secondButtonText":this.De=t.secondButtonText;break;case"selectOptionsData":this.xe=t.selectOptionsData;break;case"title":this.Ee=t.title;break;case"text":this.Pe=t.text}}get firstButtonText(){return this.Me}get secondButtonText(){return this.De}get selectOptionsData(){return this.xe}get title(){return this.Ee}get text(){return this.Pe}}class mt{Ce;Le;Se;ke;Ae;Re;Oe;Be;je;He;Ue;ce;Fe;Ke;We;Ve;ze;Ge;Ze;Xe;Je;Ye;qe=null;$e;Qe;ts(){this.Ce=et.create("div",{className:"TravelNotes-Background"}),this.je=new dt(this.Ce,dt.LEFT_BUTTON),this.He=new dt(this.Ce,dt.RIGHT_BUTTON),this.Fe=new nt,this.Ce.addEventListener("leftpan",this.Fe,!1),this.Ke=new ht,this.Ce.addEventListener("rightpan",this.Ke,!1),this.We=new ut,this.Ce.addEventListener("dragover",this.We,!1),this.Ve=new lt,this.Ce.addEventListener("wheel",this.Ve,{passive:!0}),this.ze=new ct,this.Ce.addEventListener("contextmenu",this.ze,!1)}es(){this.Le=et.create("div",{className:"TravelNotes-BaseDialog-Container"},this.Ce)}ss(){this.Oe=et.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this.Le),this.Ge=new rt(this.ce),this.Oe.addEventListener("dragstart",this.Ge,!1),this.Ze=new ot(this.ce,this.Le,this.Ce),this.Oe.addEventListener("dragend",this.Ze,!1),this.Re=et.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:S.getText("BaseDialog - Cancel")},this.Oe),this.Xe=new it(this),this.Re.addEventListener("click",this.Xe,!1)}rs(){et.create("text",{value:this.title},et.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this.Le))}os(){const t=et.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this.Le);this.contentHTMLElements.forEach((e=>t.appendChild(e)))}ns(){this.Se=et.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this.Le)}hs(){et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},this.ke=et.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this.Le)))}ls(){const t=et.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this.Le);this.Ae=et.create("div",{textContent:this.qe.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},t),this.Je=new st(this),this.Ae.addEventListener("click",this.Je,!1),this.qe.secondButtonText?(this.Be=et.create("div",{textContent:this.qe.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.Be.addEventListener("click",this.Xe,!1)):this.Be=null,this.footerHTMLElements.forEach((e=>t.appendChild(e)))}cs(){this.ts(),this.es(),this.ss(),this.rs(),this.os(),this.ns(),this.hs(),this.ls()}us(){this.ce.dialogX=(this.Ce.clientWidth-this.Le.clientWidth)/2,this.ce.dialogY=(this.Ce.clientHeight-this.Le.clientHeight)/2,this.ce.dialogX=Math.min(Math.max(this.ce.dialogX,v),this.Ce.clientWidth-this.Le.clientWidth-v),this.ce.dialogY=Math.max(this.ce.dialogY,v);const t=this.Ce.clientHeight-Math.max(this.ce.dialogY,0)-v;this.Le.style.left=String(this.ce.dialogX)+"px",this.Le.style.top=String(this.ce.dialogY)+"px",this.Le.style["max-height"]=String(t)+"px"}vs(t,e){this.$e=t,this.Qe=e,this.cs(),document.body.appendChild(this.Ce),this.us(),this.Ye=new at(this),document.addEventListener("keydown",this.Ye,{capture:!0}),this.onShow()}constructor(t){this.ce=new pt,this.qe=new _t(t),this.Ue=!0}ds(){document.removeEventListener("keydown",this.Ye,{capture:!0}),this.Ye=null,this.Oe.removeEventListener("dragstart",this.Ge,!1),this.Ge=null,this.Oe.removeEventListener("dragend",this.Ze,!1),this.Ze=null,this.Re.removeEventListener("click",this.Xe,!1),this.qe.secondButtonText&&this.Be.removeEventListener("click",this.Xe,!1),this.Xe=null,this.Ae.removeEventListener("click",this.Je,!1),this.Je=null,this.Ce.removeEventListener("leftpan",this.Fe,!1),this.Fe=null,this.Ce.removeEventListener("rightpan",this.Ke,!1),this.Ke=null,this.Ce.removeEventListener("wheel",this.Ve,{passive:!0}),this.Ve=null,this.Ce.removeEventListener("contextmenu",this.ze,!1),this.ze=null,this.Ce.removeEventListener("dragover",this.We,!1),this.We=null,this.je.detach(),this.He.detach(),document.body.removeChild(this.Ce)}onCancel(){this.ds(),this.Qe("Canceled by user")}canClose(){return!0}onOk(t){return!!this.canClose()&&(this.ds(),this.$e(t),!0)}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((t,e)=>this.vs(t,e)))}showWait(){this.ke.classList.remove("TravelNotes-Hidden"),this.Ae.classList.add("TravelNotes-Hidden")}hideWait(){this.ke.classList.add("TravelNotes-Hidden"),this.Ae.classList.remove("TravelNotes-Hidden")}showError(t){this.Se.textContent="",L.sanitizeToHtmlElement(t,this.Se),this.Se.classList.remove("TravelNotes-Hidden")}hideError(){this.Se.textContent="",this.Se.classList.add("TravelNotes-Hidden")}get keyboardELEnabled(){return this.Ue}set keyboardELEnabled(t){this.Ue=t}get options(){return this.qe}}class gt{ps=null;constructor(t){this.ps=t}handleEvent(t){t.currentTarget.textContent="👀",t.stopPropagation,this.ps.type="text"}}class wt{ps;constructor(t){this.ps=t}handleEvent(t){t.currentTarget.textContent="👁️",t.stopPropagation,this.ps.type="password",this.ps.focus()}}class Nt extends mt{_s;ps;gs;ws;Ns;Ts;static get fs(){return 12}constructor(t){super(),this.ws=t,this._s=et.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this.ps=et.create("input",{type:"password"},this._s),this.gs=et.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"👁️"},this._s),this.Ns=new gt(this.ps),this.Ts=new wt(this.ps),this.gs.addEventListener("mousedown",this.Ns,!1),this.gs.addEventListener("mouseup",this.Ts,!1)}bs(){this.gs.removeEventListener("mousedown",this.Ns,!1),this.gs.removeEventListener("mouseup",this.Ts,!1),this.Ns=null,this.Ts=null}canClose(){return this.hideError(),!(this.ws&&(this.ps.value.length<Nt.fs||!this.ps.value.match(/[0-9]+/)||!this.ps.value.match(/[a-z]+/)||!this.ps.value.match(/[A-Z]+/)||!this.ps.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+S.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+S.getText("PasswordDialog - Password rules2")+"</li><li>"+S.getText("PasswordDialog - Password rules3")+"</li><li>"+S.getText("PasswordDialog - Password rules4")+"</li><li>"+S.getText("PasswordDialog - Password rules5")+"</li><li>"+S.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.ps.focus(),!1)}onCancel(){this.bs(),super.onCancel()}onOk(){this.bs(),super.onOk((new window.TextEncoder).encode(this.ps.value))}onShow(){this.ps.focus()}get contentHTMLElements(){return[this._s]}get title(){return S.getText("PasswordDialog - password")}}class Tt{ys;Is(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}Ms(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}Ds(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}xs(t,e,s){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,s)}constructor(t){this.ys=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."}encryptData(t,e,s,i){let r=window.crypto.getRandomValues(new Uint8Array(16));i.then((t=>this.Is(t))).then((t=>this.Ms(t,this.ys))).then((e=>this.xs(e,r,t))).then((t=>{e(new Blob([r,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(s)}decryptData(t,e,s,i){i.then((t=>this.Is(t))).then((t=>this.Ms(t,this.ys))).then((e=>this.Ds(e,t))).then(e).catch(s)}}class ft{constructor(){}handleEvent(t){t.stopPropagation();const e=new Event("apikeydeleted");e.data={objId:Number.parseInt(t.target.dataset.tanObjId)},t.target.parentNode.parentNode.dispatchEvent(e)}}class bt{Es;Ps;Cs;t;constructor(e){this.t=f.nextObjId,this.Es=et.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this.Ps=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:S.getText("APIKeysDialogKeyControl - provider name")},this.Es),this.Cs=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:S.getText("APIKeysDialogKeyControl - API key"),type:t.APIKeysDialog.showAPIKeys?"text":"password"},this.Es),et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:S.getText("APIKeysDialogKeyControl - delete API key"),textContent:"❌",dataset:{ObjId:this.t}},this.Es).addEventListener("click",new ft,!1)}get objId(){return this.t}get HTMLElements(){return[this.Es]}get providerName(){return this.Ps.value}get providerKey(){return this.Cs.value}get apiKey(){return new X(this.Ps.value,this.Cs.value)}}class yt{Ls;constructor(t){this.Ls=t}onErrorDecrypt(t){this.Ls.hideWait(),this.Ls.keyboardELEnabled=!0,t&&"Canceled by user"!==t&&this.Ls.showError(S.getText("DataEncryptorHandlers - An error occurs when reading the file"))}onOkDecrypt(t){try{this.Ls.addAPIKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.Ls.hideWait(),this.Ls.hideError(),this.Ls.keyboardELEnabled=!0}onOkEncrypt(t){this.Ls.hideError(),this.Ls.hideWait(),k.saveFile("APIKeys",t),this.Ls.keyboardELEnabled=!0}onErrorEncrypt(){this.Ls.showError(S.getText("DataEncryptorHandlers - An error occurs when saving the keys")),this.Ls.hideWait(),this.Ls.keyboardELEnabled=!0}}class It{Ss;constructor(t){this.Ss=t}getAPIKeysJsonString(){const t=[];return this.Ss.forEach((e=>{t.push({providerName:e.providerName,providerKey:e.providerKey})})),JSON.stringify(t)}}class Mt{Ls;Ss;constructor(t,e){this.Ls=t,this.Ss=e}handleEvent(t){t.stopPropagation(),this.Ss.delete(t.data.objId),this.Ls.refreshAPIKeys()}}class Dt{Ls;constructor(t){this.Ls=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{this.Ls.addAPIKeys(JSON.parse(e.result))}catch(t){this.Ls.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class xt{Ls;constructor(t){this.Ls=t}handleEvent(t){t.stopPropagation(),this.Ls.hideError(),k.openFile(new Dt(this.Ls),".json")}}class Et{Ls;constructor(t){this.Ls=t}handleEvent(t){t.stopPropagation(),this.Ls.hideError(),this.Ls.showWait(),this.Ls.keyboardELEnabled=!1,fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{_===t.status&&t.ok?t.arrayBuffer().then((t=>{const e=new yt(this.Ls);(new Tt).decryptData(t,(t=>{e.onOkDecrypt(t)}),(t=>{e.onErrorDecrypt(t)}),new Nt(!1).show())})):new yt(this.Ls).onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{new yt(this.Ls).onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class Pt{Ls;constructor(t){this.Ls=t}handleEvent(t){t.stopPropagation(),this.Ls.showWait(),this.Ls.keyboardELEnabled=!1;const e=new FileReader;e.onload=()=>{const t=new yt(this.Ls);(new Tt).decryptData(e.result,(e=>{t.onOkDecrypt(e)}),(e=>{t.onErrorDecrypt(e)}),new Nt(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class Ct{Ls;constructor(t){this.Ls=t}handleEvent(t){t.stopPropagation(),this.Ls.hideError(),k.openFile(new Pt(this.Ls))}}class Lt{Ls;Ss;constructor(t,e){this.Ls=t,this.Ss=e}handleEvent(t){if(t.stopPropagation(),!this.Ls.validateAPIKeys())return;this.Ls.showWait(),this.Ls.keyboardELEnabled=!1;const e=new yt(this.Ls);(new Tt).encryptData((new window.TextEncoder).encode(new It(this.Ss).getAPIKeysJsonString()),(t=>e.onOkEncrypt(t)),(()=>e.onErrorEncrypt()),new Nt(!0).show())}}class St{Ls;Ss;constructor(t,e){this.Ls=t,this.Ss=e}handleEvent(t){t.stopPropagation(),this.Ls.validateAPIKeys()&&k.saveFile("APIKeys.json",new It(this.Ss).getAPIKeysJsonString(),"application/json")}}class kt{Ls;Ss;constructor(t,e){this.Ls=t,this.Ss=e}handleEvent(t){t.stopPropagation();const e=new X,s=new bt(e);this.Ss.set(s.objId,s),this.Ls.refreshAPIKeys()}}class At{Ls;Ss;ks;Es;As;Rs;Os;Bs;js;Hs;Us;Fs;Ks;Ws;Vs;zs;Gs(){this.As=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Reload from server"),textContent:"🔄"},this.Es),this.Us=new Et(this.Ls),this.As.addEventListener("click",this.Us,!1)}Zs(){this.Rs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Save to file"),textContent:"💾"},this.Es),this.Fs=new Lt(this.Ls,this.Ss),this.Rs.addEventListener("click",this.Fs,!1)}Xs(){this.Os=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Open file"),textContent:"📂"},this.Es),this.Ks=new Ct(this.Ls),this.Os.addEventListener("click",this.Ks,!1)}Js(){this.Bs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - new API key"),textContent:"+"},this.Es),this.Ws=new kt(this.Ls,this.Ss),this.Bs.addEventListener("click",this.Ws,!1)}Ys(){this.js=et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:S.getText("APIKeysDialogToolbar - Save to json file"),textContent:"💾"},this.Es),this.Vs=new St(this.Ls,this.Ss),this.js.addEventListener("click",this.Vs,!1)}qs(){this.Hs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Open json file"),textContent:"📂"},this.Es),this.zs=new xt(this.Ls),this.Hs.addEventListener("click",this.zs,!1)}$s(){window?.crypto?.subtle?.importKey&&window.isSecureContext&&(this.ks&&this.Gs(),this.Zs(),this.Xs()),this.Js(),t.APIKeysDialog.haveUnsecureButtons&&(this.Ys(),this.qs())}constructor(t,e,s){this.Ls=t,this.Ss=e,this.ks=s,this.Es=et.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this.$s()}destructor(){this.As&&this.As.removeEventListener("click",this.Us,!1),this.Us=null,this.Rs&&this.Rs.removeEventListener("click",this.Fs,!1),this.Fs=null,this.Os&&this.Os.removeEventListener("click",this.Ks,!1),this.Ks=null,this.Bs&&this.Bs.removeEventListener("click",this.Ws,!1),this.Ws=null,this.js&&this.js.removeEventListener("click",this.Vs,!1),this.Vs=null,this.Hs&&this.Hs.removeEventListener("click",this.zs,!1),this.zs=null}get rootHTMLElement(){return this.Es}}const Rt=new class{Qs;ti;ei;si;ii;ri;oi(){this.ei&&(clearTimeout(this.ei),this.ei=null),this.Qs.classList.remove("TravelNotes-ErrorsUI-"+this.ri),this.Qs.classList.add("TravelNotes-Hidden"),this.ii.classList.add("TravelNotes-Hidden"),this.ti.textContent=""}vs(e,s){if(this.ri=s,!t.errorsUI["show"+this.ri]||"Help"===s&&this.si.checked)return;this.ei&&(clearTimeout(this.ei),this.ei=null),this.ti.textContent="",L.sanitizeToHtmlElement(e,this.ti),this.Qs.classList.add("TravelNotes-ErrorsUI-"+this.ri),this.Qs.classList.remove("TravelNotes-Hidden");let i=t.errorsUI.timeOut;"Help"===this.ri&&(this.ii.classList.remove("TravelNotes-Hidden"),i=t.errorsUI.helpTimeOut),this.ei=setTimeout((()=>this.oi()),i)}constructor(){}createUI(){if(this.Qs)return;this.Qs=et.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);const e=et.create("div",null,this.Qs);et.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this.oi()),!1),this.ti=et.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.Qs),this.ii=et.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.Qs),this.si=et.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox",checked:!t.errorsUI.showHelp},this.ii),et.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:"Don't show help again"},this.ii)}showError(t){this.vs(t,"Error")}showWarning(t){this.vs(t,"Warning")}showInfo(t){this.vs(t,"Info")}showHelp(t){this.vs(t,"Help")}};class Ot extends mt{ai;ni;hi;li;ci(){this.hi=et.create("div"),this.li=new Mt(this,this.ai),this.hi.addEventListener("apikeydeleted",this.li,!1)}constructor(t,e){super(),this.ai=new Map,this.ni=new At(this,this.ai,e),this.ci(),this.addAPIKeys(t)}bs(){this.ni.destructor(),this.ni=null,this.hi.removeEventListener("apikeydeleted",this.li,!1),this.li=null}validateAPIKeys(){this.hideError();let t=!1;const e=[];this.ai.forEach((s=>{t=t||""===s.providerName||""===s.providerKey,e.push(s.providerName)}));let s=!1;return e.forEach((t=>{s=s||e.indexOf(t)!==e.lastIndexOf(t)})),t?(this.showError(S.getText("APIKeysDialog - empty API key name or value")),!1):!s||(this.showError(S.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(t){this.ai.clear(),t.forEach((t=>{const e=new bt(t);this.ai.set(e.objId,e)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this.hi.firstChild;)this.hi.removeChild(this.hi.firstChild);this.ai.forEach((t=>{this.hi.appendChild(t.HTMLElements[0])}))}onShow(){Rt.showHelp("<p>"+S.getText("Help - Complete the APIKeys1")+"</p><p>"+S.getText("Help - Complete the APIKeys2")+"</p><p>"+S.getText("Help - Complete the APIKeys3")+"</p>")}canClose(){return this.validateAPIKeys()}onCancel(){this.bs(),super.onCancel()}onOk(){const t=[];this.ai.forEach((e=>t.push(e.apiKey))),super.onOk(t)&&this.bs()}get title(){return S.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this.ni.rootHTMLElement,this.hi]}}const Bt=new class{constructor(){}dispatch(t,e){const s=new Event(t);e&&(s.data=e),document.dispatchEvent(s)}};const jt=new class{ks=!1;ui=new Map;vi(t){this.di(JSON.parse((new TextDecoder).decode(t)))}pi(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&Rt.showError(S.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}_i(t){window.isSecureContext&&window?.crypto?.subtle?.importKey&&(new Tt).decryptData(t,(t=>this.vi(t)),(t=>this.pi(t)),new Nt(!1).show())}mi(t){return this.ui.get(t.toLowerCase())}gi(t,e){this.ui.set(t.toLowerCase(),e)}wi(){if(!k.storageAvailable("sessionStorage"))return 0;let t=0;for(let e=0;e<sessionStorage.length;e++){const s=sessionStorage.key(e);s.match(/^\w*ProviderKey$/)&&(this.gi(s.replace("ProviderKey",""),atob(sessionStorage.getItem(s))),t++)}return V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.mi(t.name)||"")})),t}di(e){sessionStorage.clear(),this.ui.clear();const s=k.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage;e.forEach((t=>{s&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.gi(t.providerName,t.providerKey)})),V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.mi(t.name)||"")})),Bt.dispatch("providersadded")}constructor(){}hasKey(t){return this.ui.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){const e=this.ui.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.wi()&&(Bt.dispatch("providersadded"),t=!0),fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{_===e.status&&e.ok&&(this.ks=!0,t||e.arrayBuffer().then((t=>this._i(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){const t=[];this.ui.forEach(((e,s)=>{t.push(new X(s,e))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new Ot(t,this.ks).show().then((t=>this.di(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){const e=new t,s=e.name.toLowerCase();let i=this.mi(s);e.providerKeyNeeded&&!i&&k.storageAvailable("sessionStorage")&&(i=sessionStorage.getItem(s),i&&(i=atob(i))),e.providerKeyNeeded&&i&&(e.providerKey=i),V.providers.set(e.name.toLowerCase(),e)}};class Ht{ae;Ni;Ti;fi;bi;yi;Ii;static get PROFILE_MARGIN(){return 100}static get PROFILE_HEIGHT(){return 500}static get PROFILE_WIDTH(){return 1e3}static get X_DELTA_TEXT(){return 10}static get Y_DELTA_TEXT(){return 30}static get Mi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}static get Di(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3]}static get xi(){return 8}static get Ei(){return 4}static get Pi(){return Ht.PROFILE_MARGIN.toFixed(0)}static get Ci(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH).toFixed(0)}static get Li(){return Ht.PROFILE_MARGIN.toFixed(0)}static get Si(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT).toFixed(0)}static get ki(){return(Ht.PROFILE_MARGIN-Ht.X_DELTA_TEXT).toFixed(0)}static get Ai(){return(Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH+Ht.X_DELTA_TEXT).toFixed(0)}static get Ri(){return Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT+Ht.PROFILE_MARGIN/2}Oi(){let t="",e=0,s=0,i=0;this.ae.itinerary.itineraryPoints.forEach((r=>{s=(Ht.PROFILE_MARGIN+this.fi*e).toFixed(0),i=(Ht.PROFILE_MARGIN+this.Ti*(this.yi-r.elev)).toFixed(0),t+=s+","+i+" ",e+=r.distance}));const r=document.createElementNS(N,"polyline");r.setAttributeNS(null,"points",t),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.Ni.appendChild(r)}Bi(){const t=Ht.Pi+","+Ht.Li+" "+Ht.Pi+","+Ht.Si+" "+Ht.Ci+","+Ht.Si+" "+Ht.Ci+","+Ht.Li,e=document.createElementNS(N,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.Ni.appendChild(e)}ji(){let t=Number.MAX_VALUE,e=0;Ht.Mi.forEach((s=>{const i=Math.abs(this.ae.distance/Ht.xi-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.ae.chainedDistance/e)*e;for(;s<this.ae.distance+this.ae.chainedDistance;){const t=document.createElementNS(N,"text");t.appendChild(document.createTextNode(i.metersInKm<e||0<this.ae.chainedDistance?s/i.metersInKm+" km":s+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",Ht.PROFILE_MARGIN+(s-this.ae.chainedDistance)*this.fi),t.setAttributeNS(null,"y",Ht.Ri),t.setAttributeNS(null,"text-anchor","start"),this.Ni.appendChild(t),s+=e}}Hi(){let t=Number.MAX_VALUE,e=0;Ht.Di.forEach((s=>{const i=Math.abs(this.Ii/Ht.Ei-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.bi/e)*e;for(;s<this.yi;){const t=Ht.PROFILE_MARGIN+(this.yi-s)*this.Ti,i=document.createElementNS(N,"text");i.appendChild(document.createTextNode(s.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",Ht.Ai),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","start"),this.Ni.appendChild(i);const r=document.createElementNS(N,"text");r.appendChild(document.createTextNode(s.toFixed(0))),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),r.setAttributeNS(null,"x",Ht.ki),r.setAttributeNS(null,"y",t),r.setAttributeNS(null,"text-anchor","end"),this.Ni.appendChild(r),s+=e}}Ui(){this.Ni=document.createElementNS(N,"svg"),this.Ni.setAttributeNS(null,"viewBox","0 0 "+(Ht.PROFILE_WIDTH+2*Ht.PROFILE_MARGIN)+" "+(Ht.PROFILE_HEIGHT+2*Ht.PROFILE_MARGIN)),this.Ni.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){}createSvg(t){return this.ae=t,this.bi=Number.MAX_VALUE,this.yi=0,this.ae.itinerary.itineraryPoints.forEach((t=>{this.yi=Math.max(this.yi,t.elev),this.bi=Math.min(this.bi,t.elev)})),this.Ii=this.yi-this.bi,this.Ti=Ht.PROFILE_HEIGHT/this.Ii,this.fi=Ht.PROFILE_WIDTH/this.ae.distance,this.Ui(),this.Oi(),this.Bi(),this.Hi(),this.ji(),this.Ni}}class Ut{static get Fi(){return 40}static get Ki(){return 40}constructor(){}getNoteTextAndIconHTML(e,s){const i=et.create("div",{dataset:{ObjId:s.note.objId}}),r=et.create("div",{className:e+(s.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},i);let o=1;L.sanitizeToHtmlElement(s.note.iconContent,r),"TravelNotes-Roadbook-"===e&&r.firstChild&&("svg"===r.firstChild.tagName?(r.firstChild.setAttributeNS(null,"viewBox","0 0 "+a.svgViewboxDim+" "+a.svgViewboxDim),o=t.note.svgIcon.roadbookFactor):r?.firstChild?.classList?.contains("TravelNotes-MapNoteCategory-0073")&&(o=t.note.svgIcon.roadbookFactor)),r.dataset.tanWidth=String(s.note.iconWidth*o)+"px",r.dataset.tanHeight=String(s.note.iconHeight*o)+"px",r.style.width=String(s.note.iconWidth*o)+"px",r.style.height=String(s.note.iconHeight*o)+"px";const n=this.getNoteTextHTML(e,s);return n.className=e+(s.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),i.appendChild(n),i}getNoteTextHTML(t,e){const s=e.note,i=et.create("div");if(0!==s.tooltipContent.length&&L.sanitizeToHtmlElement(s.tooltipContent,et.create("div",{className:t+"NoteHtml-TooltipContent"},i)),0!==s.popupContent.length&&L.sanitizeToHtmlElement(s.popupContent,et.create("div",{className:t+"NoteHtml-PopupContent"},i)),0!==s.address.length&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Address")+"</span> : "+s.address,et.create("div",{className:t+"NoteHtml-Address"},i)),0!==s.url.length&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+s.url+' target="_blank" >'+s.url.substring(0,Ut.Fi)+"...</a>",et.create("div",{className:t+"NoteHtml-Url"},i)),0!==s.phone.length){let e=s.phone;if(s.phone.match(/^\+[0-9, ,*,\u0023]*$/)){const t=s.phone.replaceAll(/\u0020/g,""),i=s.phone.replaceAll(/\u0020/g," ");e=S.getText("NoteHTMLViewsFactory - Phone")+" : "+S.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+i+"</a>"+S.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+i+"</a>"}else e=S.getText("NoteHTMLViewsFactory - Phone")+" : "+s.phone;L.sanitizeToHtmlElement(e,et.create("div",{className:t+"NoteHtml-Phone"},i))}if(L.sanitizeToHtmlElement(k.formatLatLng(s.latLng),et.create("div",{className:t+"NoteHtml-LatLng"},i)),e.route){e.route.chain&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+k.formatDistance(s.chainedDistance+s.distance),et.create("div",{className:t+"NoteHtml-TravelDistance"},i)),L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+k.formatDistance(s.distance),et.create("div",{className:t+"NoteHtml-RouteDistance"},i));const r=e.route.notes.next(s.objId);if(r){const e=r.distance-s.distance;Ut.Ki<e&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+k.formatDistance(e),et.create("div",{className:t+"NoteHtml-NextDistance"},i))}}return i}getTravelNotesHTML(t){const e=et.create("div",{className:t+"Travel-Notes"}),s=V.travel.notes.iterator;for(;!s.done;){const i=this.getNoteTextAndIconHTML(t,{note:s.value,route:null});i.className=t+"Travel-Notes-Row",e.appendChild(i)}return e}}const Ft=new Ut;const Kt=new class{Wi(t,e){const s=et.create("div"),r=et.create("div",{className:t+"Route-ManeuversAndNotes-IconCell"},s);et.create("div",{className:"TravelNotes-ManeuverNote TravelNotes-ManeuverNote-"+e.maneuver.iconName},r),r.dataset.tanWidth=String(a.width)+"px",r.dataset.tanHeight=String(a.height)+"px";const o=et.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},s);return et.create("div",{className:t+"Route-Maneuver-TooltipContent",textContent:S.getText("RouteHTMLViewsFactory - "+e.maneuver.iconName)},o),L.sanitizeToHtmlElement(e.maneuver.instruction,et.create("div",{className:t+"Route-Maneuver-Instruction"},o)),e.route.chain&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+k.formatDistance(e.route.chainedDistance+e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-TravelDistance"},o)),L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+k.formatDistance(e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-RouteDistance"},o)),i.defaultValue<e.maneuver.distance&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+k.formatDistance(e.maneuver.distance),et.create("div",{className:t+"Route-Maneuver-NextDistance"},o)),s}constructor(){}getRouteProfileHTML(t,e){const s=et.create("div",{className:t+"RouteProfile"});return L.sanitizeToHtmlElement(S.getText("RouteHTMLViewsFactory - Profile"),s),s.appendChild((new Ht).createSvg(e)),s}getRouteManeuversAndNotesHTML(t,e,s){const i=[],r=e.notes.iterator;for(;!r.done;)i.push({data:r.value,distance:r.value.distance});const o=e.itinerary.maneuvers.iterator;let a=0;for(;!o.done;)i.push({data:o.value,distance:a}),a+=o.value.distance;i.sort(((t,e)=>t.distance-e.distance));const n=et.create("div",{className:t+"Route-ManeuversAndNotes"});return i.forEach((i=>{let r=null;"Note"===i.data.objType.name?(r=Ft.getNoteTextAndIconHTML(t,{note:i.data,route:e}),r.className=t+"Route-Notes-Row"):(r=this.Wi(t,{route:e,maneuver:i.data,maneuverDistance:i.distance}),r.className=t+"Route-Maneuvers-Row"),s&&(r.dataset.tanObjId=i.data.objId,r.dataset.tanMarkerObjId=f.nextObjId,r.dataset.tanObjType=i.data.objType.name),n.appendChild(r)})),n}getRouteHeaderHTML(t,e){const s=et.create("div",{className:t+"Route-Header",id:"route"+e.objId});return L.sanitizeToHtmlElement(e.computedName,et.create("div",{className:t+"Route-Header-Name"},s)),0!==e.distance&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+k.formatDistance(e.distance),et.create("div",{className:t+"Route-Header-Distance"},s)),V.travel.readOnly||"bike"===e.itinerary.transitMode||L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+k.formatTime(e.duration),et.create("div",{className:t+"Route-Header-Duration"},s)),e.itinerary.hasProfile&&(L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(e.itinerary.ascent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Ascent"},s)),L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(e.itinerary.descent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Descent"},s))),s}getRouteFooterHTML(t,e){let s=""!==e.itinerary.provider&&""!==e.itinerary.transitMode?S.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:S.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}):"";const i=et.create("div",{className:t+"RouteFooter"});return L.sanitizeToHtmlElement(s,i),i}};class Wt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onKeydownKeyboard(t.key)}}class Vt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onCancelMenu()}}class zt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onMouseLeaveMenuItem(t.currentTarget)}}class Gt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onMouseEnterMenuItem(t.currentTarget)}}class Zt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.selectItem(Number.parseInt(t.currentTarget.dataset.tanObjId))}}class Xt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onMouseLeaveContainer()}}class Jt{Vi=null;constructor(t){this.Vi=t}handleEvent(t){t.stopPropagation(),this.Vi.onMouseEnterContainer()}}class Yt{static zi=Object.freeze({get previousItem(){return-1},get firstItem(){return 0},get nextItem(){return 1},get lastItem(){return 2}});Gi=null;Zi;Xi;Ji;Yi;qi;$i;Qi;tr=w;ei=null;er(){this.Gi.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}sr(t){switch(this.er(),t){case Yt.zi.previousItem:case Yt.zi.nextItem:this.tr+=t,w===this.tr&&(this.tr=this.Gi.menuItemHTMLElements.length-1),this.Gi.menuItemHTMLElements.length===this.tr&&(this.tr=0);break;case Yt.zi.firstItem:this.tr=0;break;case Yt.zi.lastItem:this.tr=this.Gi.menuItemHTMLElements.length-1}this.Gi.menuItemHTMLElements[this.tr].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(t){this.Gi=t,this.Zi=new Wt(this),this.Xi=new Xt(this),this.Ji=new Jt(this),this.Yi=new Vt(this),this.qi=new Zt(this),this.$i=new zt(this),this.Qi=new Gt(this),document.addEventListener("keydown",this.Zi,!0),this.Gi.container.addEventListener("mouseleave",this.Xi),this.Gi.container.addEventListener("mouseenter",this.Ji),this.Gi.cancelButton.addEventListener("click",this.Yi),this.Gi.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.qi),t.addEventListener("mouseleave",this.$i),t.addEventListener("mouseenter",this.Qi)}))}destructor(){this.ei&&(clearTimeout(this.ei),this.ei=null),document.removeEventListener("keydown",this.Zi,!0),this.Gi.container.removeEventListener("mouseleave",this.Xi),this.Gi.container.removeEventListener("mouseenter",this.Ji),this.Gi.cancelButton.removeEventListener("click",this.Yi),this.Gi.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.qi),t.removeEventListener("mouseleave",this.$i),t.removeEventListener("mouseenter",this.Qi)})),this.Zi=null,this.Xi=null,this.Ji=null,this.Yi=null,this.qi=null,this.$i=null,this.Qi=null,this.Gi.parentNode.removeChild(this.Gi.container),this.Gi=null}onMouseLeaveContainer(){this.ei=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.ei&&(clearTimeout(this.ei),this.ei=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.sr(Yt.zi.nextItem);break;case"ArrowUp":case"ArrowLeft":this.sr(Yt.zi.previousItem);break;case"Home":this.sr(Yt.zi.firstItem);break;case"End":this.sr(Yt.zi.lastItem);break;case"Enter":if(w===this.tr||this.Gi.menuItemHTMLElements[this.tr].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.Gi.onOk(this.tr)}}onCancelMenu(){this.Gi.onCancel("Canceled by user")}selectItem(t){this.Gi.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.Gi.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(t){this.er(),this.tr=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class qt{ir;rr;ar;constructor(t,e,s){this.ir=t,this.rr=e,this.ar=s}get itemText(){return this.ir}get isActive(){return this.rr}get action(){return this.ar}}class $t{nr;hr;lr;cr;ur;constructor(t,e){this.nr=t.clientX||t.originalEvent.clientX||0,this.hr=t.clientY||t.originalEvent.clientY||0,this.lr=[t.latlng?t.latlng.lat:h.defaultValue,t.latlng?t.latlng.lng:h.defaultValue],this.cr=t.target?.objId??(Number.parseInt(t?.currentTarget?.dataset?.tanObjId)||m),this.ur=Boolean(e)}get clientX(){return this.nr}get clientY(){return this.hr}get latLng(){return this.lr}get targetObjId(){return this.cr}get haveParentNode(){return this.ur}}class Qt{static vr=null;dr;pr;_r;ue;Re;mr;gr;Vi;static get wr(){return 20}Nr(){this.ue=et.create("div",{className:"TravelNotes-ContextMenu-Container"},this._r)}Tr(){this.Re=et.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CloseButton",title:S.getText("BaseContextMenu - Close")},this.ue)}br(){this.mr=[];let t=0;this.menuItems.forEach((e=>{const s=et.create("div",{textContent:e.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(t++)}},this.ue);e.isActive||s.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this.mr.push(s)}))}yr(){const t=Math.min(this.gr.clientY,V.map.getContainer().clientHeight-this.ue.clientHeight-Qt.wr);if(this.ue.style.top=String(t)+"px",this.gr.haveParentNode)this.ue.style.right=String(Qt.wr)+"px";else{const t=Math.min(this.gr.clientX,V.map.getContainer().clientWidth-this.ue.clientWidth-Qt.wr);this.ue.style.left=String(t)+"px"}}Ir(t,e){this.dr=t,this.pr=e,this.Nr(),this.Tr(),this.br(),this.yr(),this.Vi=new Yt(this)}constructor(t,e){Qt.vr?Qt.vr.onCancel():(this.gr=new $t(t,e),this._r=e||document.body,Qt.vr=this)}onOk(t){this.Vi.destructor(),Qt.vr=null,this.dr(t)}onCancel(){this.Vi.destructor(),Qt.vr=null,this.pr()}show(){Qt.vr&&new Promise(((t,e)=>{this.Ir(t,e)})).then((t=>this.menuItems[t].action())).catch((t=>{t&&console.error(t)}))}get menuItems(){return[]}get parentNode(){return this._r}get container(){return this.ue}get cancelButton(){return this.Re}get menuItemHTMLElements(){return this.mr}get eventData(){return this.gr}}class te{Ee;Mr;Dr;constructor(t){if("string"!=typeof t?.title||"string"!=typeof t?.htmlBefore||t.htmlAfter&&"string"!=typeof t.htmlAfter)throw new Error("Invalid toolbar button");let e=(t.htmlBefore||"")+(t.htmlAfter||""),s=L.sanitizeToHtmlString(e).errorsString;if(""!==s)throw new Error("Invalid toolbar button : "+e+s);this.Ee=L.sanitizeToHtmlString(t.title).htmlString,""===this.title&&(this.title="?"),this.Mr=t.htmlBefore||"",this.Dr=t.htmlAfter||""}get title(){return this.Ee}get htmlBefore(){return this.Mr}get htmlAfter(){return this.Dr}}class ee{ot;Er;Pr;Bt;Cr;constructor(t){this.ot="string"==typeof t?.name?L.sanitizeToJsString(t.name):"?",this.Er="string"==typeof t.icon?L.sanitizeToHtmlString(t?.icon).htmlString:"?",this.Pr="string"==typeof t?.tooltip?L.sanitizeToHtmlString(t.tooltip).htmlString:"?",this.Bt="number"==typeof t?.width?t.width:a.width,this.Cr="number"==typeof t?.height?t.height:a.height}get name(){return this.ot}get icon(){return this.Er}get tooltip(){return this.Pr}get width(){return this.Bt}get height(){return this.Cr}}const se=new class{Lr;Sr;kr;constructor(){this.Lr=[],this.Sr=new Map,this.kr=[]}get editionButtonsData(){return this.Lr}get preDefinedIconsData(){return this.kr}preDefinedIconDataAt(t){return this.kr[t]}preDefinedIconDataFromName(t){const e=this.Sr.get(t);return e?e.icon:""}loadJson(t){if(t.editionButtons&&t.editionButtons.forEach((t=>{try{let e=new te(t);this.Lr.push(e)}catch(t){console.error(t.message)}})),t.preDefinedIconsList){t.preDefinedIconsList.forEach((t=>{const e=new ee(t);this.Sr.set(e.name,e)})),this.kr.length=0;for(const t of this.Sr)this.kr.push(t[1]);this.kr=this.kr.sort(((t,e)=>t.name.localeCompare(e.name)))}}};class ie{Es;Ar;Rr;Or;Br;jr(){this.Ar=et.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.Es),se.preDefinedIconsData.forEach((t=>{this.Ar.add(et.create("option",{text:t.name}))})),this.Ar.selectedIndex=w}$s(){this.Rr=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogToolbar - show hidden contents"),textContent:"▼"},this.Es),this.Or=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogToolbar - Open a configuration file"),textContent:"📂"},this.Es)}Hr(){se.editionButtonsData.forEach((t=>{const e=et.create("div",{dataset:{HtmlBefore:t.htmlBefore,HtmlAfter:t.htmlAfter},className:"TravelNotes-NoteDialog-EditorButton"},this.Es);L.sanitizeToHtmlElement(t.title,e),this.Br.push(e)}))}Ur(){this.jr(),this.$s(),this.Hr()}Fr(t){this.Ar.addEventListener("change",t.iconSelectorChange),this.Rr.addEventListener("click",t.toggleContentsButtonClick),this.Br.forEach((e=>{e.addEventListener("click",t.editionButtonsClick)})),this.Or.addEventListener("click",t.openFileButtonClick,!1)}Kr(t){this.Ar.removeEventListener("change",t.iconSelectorChange),this.Rr.removeEventListener("click",t.toggleContentsButtonClick),this.Br.forEach((e=>{e.removeEventListener("click",t.editionButtonsClick)})),this.Or.removeEventListener("click",t.openFileButtonClick,!1)}constructor(t){this.Br=[],this.Es=et.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.Ur(),this.Fr(t)}destructor(t){this.Kr(t)}update(t){this.Kr(t),this.Es.textContent="",this.Br=[],this.Ur(),this.Fr(t)}get rootHTMLElement(){return this.Es}}class re{Wr=null;Vr=null;zr=null;constructor(t){this.Wr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:S.getText("NoteDialogIconDimsControl - Icon width")},this.Wr),this.Vr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:a.width,dataset:{Name:"iconWidth"}},this.Wr),et.create("text",{value:S.getText("NoteDialogIconDimsControl - Icon height")},this.Wr),this.zr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:a.height,dataset:{Name:"iconHeight"}},this.Wr),this.Vr.addEventListener("input",t.controlInput),this.zr.addEventListener("input",t.controlInput)}destructor(t){this.Vr.removeEventListener("input",t.controlInput),this.zr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Wr]}get iconWidth(){return Number.parseInt(this.Vr.value)}set iconWidth(t){this.Vr.value=t}get iconHeight(){return Number.parseInt(this.zr.value)}set iconHeight(t){this.zr.value=t}}class oe{Gr;Zr;constructor(e){this.Gr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogIconControl - Icon content")}),this.Zr=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:t.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this.Gr),this.Zr.addEventListener("focus",e.controlFocus),this.Zr.addEventListener("input",e.controlInput)}destructor(t){this.Zr.removeEventListener("focus",t.controlFocus),this.Zr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Gr]}get iconContent(){return this.Zr.value}set iconContent(t){this.Zr.value=t}}class ae{Xr;Jr;constructor(t){this.Xr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogTooltipControl - Tooltip content")}),this.Jr=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this.Xr),this.Jr.addEventListener("focus",t.controlFocus),this.Jr.addEventListener("input",t.controlInput)}destructor(t){this.Jr.removeEventListener("focus",t.controlFocus),this.Jr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Xr]}get tooltipContent(){return this.Jr.value}set tooltipContent(t){this.Jr.value=t}}class ne{Yr;qr;constructor(e){this.Yr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogPopupControl - Text")}),this.qr=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:t.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this.Yr),this.qr.addEventListener("focus",e.controlFocus),this.qr.addEventListener("input",e.controlInput)}destructor(t){this.qr.removeEventListener("focus",t.controlFocus),this.qr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Yr]}get popupContent(){return this.qr.value}set popupContent(t){this.qr.value=t}}class he{$r;Qr;eo;so;constructor(t){this.$r=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.so=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogAddressControl - Reset address"),textContent:"🔄"},this.$r),et.create("text",{value:S.getText("NoteDialogAddressControl - Address")},this.$r),this.Qr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.eo=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this.Qr),this.eo.addEventListener("focus",t.controlFocus),this.eo.addEventListener("input",t.controlInput),this.so.addEventListener("click",t.addressButtonClick)}destructor(t){this.eo.removeEventListener("focus",t.controlFocus),this.eo.removeEventListener("input",t.controlInput),this.so.removeEventListener("click",t.addressButtonClick)}get HTMLElements(){return[this.$r,this.Qr]}get address(){return this.eo.value}set address(t){this.eo.value=t}}class le{io;ro;oo;ao(e){t.noteDialog.theDevil.addButton&&et.create("text",{value:"👿"},et.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(h.fixed)+","+e[1].toFixed(h.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},et.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this.io)))}constructor(t,e){this.io=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.ao(e),et.create("text",{value:S.getText("NoteDialogLinkControl - Link")},this.io),this.ro=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.oo=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this.ro),this.oo.addEventListener("focus",t.controlFocus),this.oo.addEventListener("input",t.controlInput),this.oo.addEventListener("blur",t.urlInputBlur)}destructor(t){this.oo.removeEventListener("focus",t.controlFocus),this.oo.removeEventListener("input",t.controlInput),this.oo.removeEventListener("blur",t.urlInputBlur)}get HTMLElements(){return[this.io,this.ro]}get url(){return this.oo.value}set url(t){this.oo.value=t}}class ce{no;ho;lo;constructor(t){this.no=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:" "+S.getText("NoteDialogPhoneControl - Phone")},this.no),this.ho=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.lo=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this.ho),this.lo.addEventListener("focus",t.controlFocus),this.lo.addEventListener("input",t.controlInput)}destructor(t){this.lo.removeEventListener("focus",t.controlFocus),this.lo.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.no,this.ho]}get phone(){return this.lo.value}set phone(t){this.lo.value=t}}class ue{co;uo;constructor(t){this.uo=t,this.co=et.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.co.appendChild(Ft.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",new $(this.uo,null)))}update(){this.co.textContent="",this.co.appendChild(Ft.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.uo,route:null}))}get HTMLElements(){return[this.co]}}class ve{searchPlaces=!0;searchWays=!0;searchRelations=!0;setGeometry=!0;constructor(){}}class de{qe;vo;do;po;_o;mo;wo;lr;No;To;fo;bo(){this.do.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.nodes.forEach((s=>{const i=this.vo.get(s);t.geometry[0].push([i.lat,i.lon]),t.lat+=i.lat,t.lon+=i.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.po.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.members.forEach((s=>{if("way"===s.type){const i=this.do.get(s.ref);t.geometry.push(i.geometry[0]),t.lat+=i.lat,t.lon+=i.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}yo(e){e.forEach((e=>{switch(e.type){case"node":if(this.vo.set(e.id,e),e?.tags?.place&&this.qe.searchPlaces&&this.wo[e.tags.place]&&e?.tags?.name){const t=q.pointsDistance(this.lr,[e.lat,e.lon]),s=this.wo[e.tags.place];s.maxDistance>t&&s.distance>t&&(s.distance=t,s.name=e.tags.name)}break;case"way":this.qe.searchWays&&this.do.set(e.id,e);break;case"relation":this.qe.searchRelations&&this.po.set(e.id,e);break;case"area":if(this.qe.searchPlaces){let s=e.tags.name;"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(s=e.tags["name:"+t.nominatim.language]),this._o[Number.parseInt(e.tags.admin_level)]=s,"2"===e.tags.admin_level&&(this.mo=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.mo)}}})),this.qe.setGeometry&&this.bo(),this.qe.searchPlaces&&this.Io()}Io(){let t=null;for(let e=2;e<this._o.length;e++)void 0!==this._o[e]&&(this.mo>=e?this.To=this._o[e]:t=this._o[e]);let e=Number.MAX_VALUE;Object.values(this.wo).forEach((t=>{t.distance<e&&(e=t.distance,this.No=t.name)})),this.No=t||this.No,this.No===this.To&&(this.No=null)}async Mo(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&_===t[e].value.status&&t[e].value.ok){const s=await t[e].value.json();this.yo(s.elements)}else this.fo=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(this.qe=new ve,t)for(const[e,s]of Object.entries(t))this.qe[e]&&(this.qe[e]=s);this.vo=new Map,this.do=new Map,this.po=new Map}async loadData(e,s){this.lr=s,this.fo=!0,this._o=[],this.mo=t.geoCoder.osmCityAdminLevel.DEFAULT,this.wo=Object.freeze({hamlet:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet}),village:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village}),city:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city}),town:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town})}),this.No=null,this.To=null,this.vo.clear(),this.do.clear(),this.po.clear();const i=[];e.forEach((e=>{i.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(i).then((t=>this.Mo(t)))}get nodes(){return this.vo}get ways(){return this.do}get relations(){return this.po}get place(){return this.No}get city(){return this.To}get country(){return this._o[2]}get statusOk(){return this.fo}}class pe{Do=!1;ot="";xo="";To="";Eo="";Po(t,e){t.error||e.error?this.Do=!1:(this.ot=e.namedetails.name,e.address.house_number&&(this.xo=e.address.house_number+" "),e.address.road?this.xo+=e.address.road+" ":e.address.pedestrian&&(this.xo+=e.address.pedestrian+" "),this.To=t.address.city||t.address.town||t.address.municipality||t.address.village||"",this.Eo=e.address.country,this.Do=!0)}constructor(){}async loadData(e){this.Do=!1;const s=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1];let i=s+"&zoom=10&addressdetails=1&namedetails=0",r=s+"&zoom=18&addressdetails=1&namedetails=1";const o=t.nominatim.language;o&&"*"!==o&&(i+="&accept-language="+o,r+="&accept-language="+o);const a=new Headers;o&&"*"===o&&a.append("accept-language","");const n=await fetch(i,{headers:a}),h=await fetch(r,{headers:a});_===n.status&&n.ok&&_===h.status&&h.ok?this.Po(await n.json(),await h.json()):this.Do=!1}get name(){return this.Do?this.ot:null}get street(){return this.Do?this.xo:null}get city(){return this.Do?this.To:null}get country(){return this.Do?this.Eo:null}}class _e{ot;xo;To;constructor(t,e,s){this.ot=L.sanitizeToJsString(t),this.xo=L.sanitizeToJsString(e),this.To=L.sanitizeToJsString(s)}get name(){return this.ot}get street(){return this.xo}get city(){return this.To}}class me{static get Co(){return Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town)}lr;Lo;So;ko(){let t=this.So.city||this.So.country||"";const e=this.Lo.place;e&&e!==t&&(t+=" ("+e+")");let s=(this.So.street||"").replaceAll(";"," "),i=this.So.name||"";return(s.includes(i)||t.includes(i))&&(i=""),new _e(i,s,t)}Ao(){return["node(around:"+me.Co+","+this.lr[0]+","+this.lr[1]+")[place];out;"]}async Ro(){return await this.Lo.loadData(this.Ao(),this.lr),await this.So.loadData(this.lr),this.ko()}async Oo(t,e){t(await this.Ro())}constructor(){this.Lo=new de({searchWays:!1,searchRelations:!1,setGeometry:!0}),this.So=new pe({searchPlaces:!0,searchWays:!1,searchRelations:!1,setGeometry:!1})}async getAddressAsync(t){return this.lr=t,this.Ro()}getAddressWithPromise(t){return this.lr=t,new Promise(((t,e)=>this.Oo(t,e)))}}class ge{Bo;Lo;jo;Ho(){this.jo=document.createElementNS(N,"svg"),this.jo.setAttributeNS(null,"viewBox",String(a.svgViewboxDim/4)+" "+a.svgViewboxDim/4+" "+a.svgViewboxDim/2+" "+a.svgViewboxDim/2),this.jo.setAttributeNS(null,"class","TravelNotes-SvgIcon")}Uo(){let e=-1,s=w,i=w;const r=[];if(this.Bo.route.itinerary.itineraryPoints.forEach((o=>{e++;const n=Y.addPoints(Y.project(o.latLng,t.note.svgIcon.zoom),this.Bo.translation);r.push(n);n[0]>=0&&n[1]>=0&&n[0]<=a.svgViewboxDim&&n[1]<=a.svgViewboxDim&&(w===s&&(s=e),i=e)})),w!==s&&w!==i){0<s&&s--,this.Bo.route.itinerary.itineraryPoints.length-1>i&&i++;let t="";for(e=s;e<=i;e++)t+=r[e][0].toFixed(0)+","+r[e][1].toFixed(0)+" ";const o=document.createElementNS(N,"polyline");o.setAttributeNS(null,"points",t),o.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),o.setAttributeNS(null,"transform","rotate("+this.Bo.rotation+","+a.svgViewboxDim/2+","+a.svgViewboxDim/2+")"),this.jo.appendChild(o)}}Fo(){this.Lo.ways.forEach((e=>{let s=w,i=w,r=-1;const o=[];if(e.nodes.forEach((e=>{r++;const n=this.Lo.nodes.get(e),h=Y.addPoints(Y.project([n.lat,n.lon],t.note.svgIcon.zoom),this.Bo.translation);o.push(h);h[0]>=0&&h[1]>=0&&h[0]<=a.svgViewboxDim&&h[1]<=a.svgViewboxDim&&(w===s&&(s=r),i=r)})),w!==s&&w!==i){0<s&&s--,e.nodes.length-1>i&&i++;let t="";for(r=s;r<=i;r++)t+=o[r][0].toFixed(0)+","+o[r][1].toFixed(0)+" ";const n=document.createElementNS(N,"polyline");n.setAttributeNS(null,"points",t),n.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),n.setAttributeNS(null,"transform","rotate("+this.Bo.rotation+","+a.svgViewboxDim/2+","+a.svgViewboxDim/2+")"),this.jo.appendChild(n)}}))}Ko(){if(""===this.Bo.rcnRef)return;const t=document.createElementNS(N,"text");t.textContent=this.Bo.rcnRef,t.setAttributeNS(null,"x",String(a.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(a.svgViewboxDim/2)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.jo.appendChild(t)}constructor(){}buildSvg(t,e,s){this.Bo=t,this.Lo=s,this.Ho(),this.Uo(),this.Fo(),this.Ko(),e.iconContent=this.jo.outerHTML}}class we{isMini;isEntry;isExit;constructor(){this.isMini=!1,this.isEntry=!1,this.isExit=!1}}class Ne{Bo;Wo;Lo;Vo;zo;Go;Zo;Xo;Jo;Yo;qo;$o(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}Qo(t){const e=5e-6;let s=!1;return this.Bo.route.wayPoints.forEach((i=>{Math.abs(t.lat-i.lat)<e&&Math.abs(t.lng-i.lng)<e&&(s=!0)})),!s&&(this.Wo.latLng[0]!==t.lat||this.Wo.latLng[1]!==t.lng)}ta(){const e=this.Bo.route.itinerary.itineraryPoints.previous(this.Bo.nearestItineraryPointObjId,(t=>this.Qo(t))),s=this.Bo.route.itinerary.itineraryPoints.next(this.Bo.nearestItineraryPointObjId,(t=>this.Qo(t)));let r=Number.MAX_VALUE,o=Number.MAX_VALUE,a=Number.MAX_VALUE,n=Number.MAX_VALUE,h=i.defaultValue;this.Lo.nodes.forEach((i=>{h=q.pointsDistance([i.lat,i.lon],this.Wo.latLng),"bike"===this.Bo.route.itinerary.transitMode&&i?.tags?.rcn_ref&&i.tags["network:type"]&&"node_network"===i.tags["network:type"]&&h<t.note.svgIcon.rcnRefDistance&&h<o&&(this.Vo=i,o=h),h<r&&(this.Go=i.id,r=h),e&&(h=q.pointsDistance([i.lat,i.lon],e.latLng),h<a&&(this.Zo=i.id,a=h)),s&&(h=q.pointsDistance([i.lat,i.lon],s.latLng),h<n&&(this.Xo=i.id,n=h))})),this.zo=this.Lo.nodes.get(this.Go)}ea(){this.qo.isMini="mini_roundabout"===this?.zo?.tags?.highway}sa(){this.Vo&&(this.Bo.rcnRef=this.Vo.tags.rcn_ref,this.Wo.tooltipContent+=S.getText("StreetFinder - rcnRef",{rcnRef:this.Bo.rcnRef}))}ia(){this.Lo.ways.forEach((t=>{if(!t.nodes.includes(this.Go))return;const e=this.$o(t),s=""!==e,i=t.nodes.includes(this.Zo),r=t.nodes.includes(this.Xo);let o=2*t.nodes.filter((t=>t===this.Go)).length;if(t.nodes[0]===this.Go&&o--,t.nodes[t.nodes.length-1]===this.Go&&o--,i&&(this.Jo=s?e:"???",o--,"roundabout"===t?.tags?.junction&&(this.qo.isExit=!0)),0!==o&&(r&&(this.Yo=s?e:"???",o--,"roundabout"===t?.tags?.junction&&(this.qo.isEntry=!0)),0!==o&&s))for(;0!==o;)this.Wo.address=""===this.Wo.address?e:this.Wo.address+" ⪥  "+e,o--}))}ra(){""!==this.Lo.city&&(this.Wo.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.Lo.city+"</span>"),this.Lo.place&&this.Lo.place!==this.Lo.city&&(this.Wo.address+=" ("+this.Lo.place+")")}oa(){n.atStart===this.Bo.positionOnRoute?(this.Wo.address="🟢 "+this.Yo,this.ra()):n.atEnd===this.Bo.positionOnRoute?(this.ra(),this.Wo.address=this.Jo,this.ra(),this.Wo.address+=" 🔴 "):(this.Wo.address=this.Jo+(""===this.Wo.address?"":" ⪥  "+this.Wo.address)+" "+this.Bo.directionArrow+" "+this.Yo,this.ra())}aa(){this.qo.isEntry&&!this.qo.isExit?this.Wo.tooltipContent+=S.getText("StreetFinder - entry roundabout"):!this.qo.isEntry&&this.qo.isExit?this.Wo.tooltipContent+=S.getText("StreetFinder - exit roundabout"):this.qo.isEntry&&this.qo.isExit&&(this.Wo.tooltipContent+=S.getText("StreetFinder - continue roundabout")),this.qo.isMini&&(this.Wo.tooltipContent+=S.getText("StreetFinder - at the small roundabout on the ground"))}constructor(){}findData(t,e,s){this.Bo=t,this.Wo=e,this.Lo=s,this.Go=w,this.Zo=w,this.Xo=w,this.Jo="",this.Yo="",this.qo=new we,this.ta(),this.ea(),this.sa(),this.ia(),this.oa(),this.aa()}}class Te{constructor(){}findData(e,s){null!==e.direction&&(e.direction<t.note.svgIcon.angleDirection.right?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂"):e.direction<t.note.svgIcon.angleDirection.slightRight?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn slight right"),e.directionArrow="🢅"):e.direction<t.note.svgIcon.angleDirection.continue?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Continue"),e.directionArrow="🢁"):e.direction<t.note.svgIcon.angleDirection.slightLeft?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn slight left"),e.directionArrow="🢄"):e.direction<t.note.svgIcon.angleDirection.left?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn left"),e.directionArrow="🢀"):e.direction<t.note.svgIcon.angleDirection.sharpLeft?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn sharp left"),e.directionArrow="🢇"):e.direction<t.note.svgIcon.angleDirection.sharpRight?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn sharp right"),e.directionArrow="🢆"):(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂")),n.atStart===e.positionOnRoute?s.tooltipContent=S.getText("ArrowAndTooltipFinder - Start"):n.atEnd===e.positionOnRoute&&(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Stop"))}}class fe{Bo;Wo;na;ha;la;ca(){this.Bo.translation=Y.subtrackPoints([a.svgViewboxDim/2,a.svgViewboxDim/2],Y.project(this.Wo.latLng,t.note.svgIcon.zoom))}ua(){this.na=this.Bo.route.itinerary.itineraryPoints.previous(this.Bo.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Wo.latLng)>t.note.svgIcon.angleDistance))||this.Bo.route.itinerary.itineraryPoints.first}va(){this.ha=this.Bo.route.itinerary.itineraryPoints.next(this.Bo.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Wo.latLng)>t.note.svgIcon.angleDistance))||this.Bo.route.itinerary.itineraryPoints.last}da(){this.la=Y.addPoints(Y.project(this.Wo.latLng,t.note.svgIcon.zoom),this.Bo.translation)}pa(){if(this.Bo.nearestItineraryPointObjId!==this.Bo.route.itinerary.itineraryPoints.first.objId){const e=Y.addPoints(Y.project(this.na.latLng,t.note.svgIcon.zoom),this.Bo.translation);this.Bo.rotation=Math.atan((this.la[1]-e[1])/(e[0]-this.la[0]))*s.d180/Math.PI,0>this.Bo.rotation&&(this.Bo.rotation+=s.d360),this.Bo.rotation-=s.d270,0>e[0]-this.la[0]&&(this.Bo.rotation+=s.d180)}}_a(){if(this.Bo.nearestItineraryPointObjId!==this.Bo.route.itinerary.itineraryPoints.last.objId){const e=Y.addPoints(Y.project(this.ha.latLng,t.note.svgIcon.zoom),this.Bo.translation);for(this.Bo.direction=Math.atan((this.la[1]-e[1])/(e[0]-this.la[0]))*s.d180/Math.PI,0>e[0]-this.la[0]&&(this.Bo.direction+=s.d180),this.Bo.direction-=this.Bo.rotation;s.d0>this.Bo.direction;)this.Bo.direction+=s.d360;for(;s.d360<this.Bo.direction;)this.Bo.direction-=s.d360}}ma(){this.Bo.nearestItineraryPointObjId===this.Bo.route.itinerary.itineraryPoints.first.objId&&(this.Bo.rotation=-this.Bo.direction-s.d90,this.Bo.direction=null,this.Bo.positionOnRoute=n.atStart),this.Wo.latLng[0]===this.Bo.route.itinerary.itineraryPoints.last.lat&&this.Wo.latLng[1]===this.Bo.route.itinerary.itineraryPoints.last.lng&&(this.Bo.direction=null,this.Bo.positionOnRoute=n.atEnd)}constructor(){}findData(t,e){this.Bo=t,this.Wo=e,this.ca(),this.ua(),this.va(),this.da(),this.pa(),this._a(),this.ma()}}class be{constructor(){}iconContent="";tooltipContent="";address="";latLng=[h.defaultValue,h.defaultValue]}class ye{constructor(){}nearestItineraryPointObjId=m;route=null;positionOnRoute=n.onRoute;direction=null;directionArrow=" ";rcnRef="";rotation=0;translation=[0,0]}class Ie{Wo;Bo;Lo;Co;ga;static get wa(){return 1.5}Na(){let t=null,e=Number.MAX_VALUE;this.Bo.route.itinerary.itineraryPoints.forEach((s=>{const i=q.pointsDistance(this.Wo.latLng,s.latLng);e>i&&(e=i,t=s)})),this.Wo.latLng=t.latLng,this.Bo.nearestItineraryPointObjId=t.objId}Ta(){return(new fe).findData(this.Bo,this.Wo),(new Te).findData(this.Bo,this.Wo),(new Ne).findData(this.Bo,this.Wo,this.Lo),(new ge).buildSvg(this.Bo,this.Wo,this.Lo),this.ga=!1,this.Wo}async fa(){if(this.ga)return null;this.ga=!0,this.Bo.nearestItineraryPointObjId=m,this.Bo.positionOnRoute=n.onRoute,this.Bo.direction=null,this.Bo.directionArrow=" ",this.Bo.translation=[0,0],this.Bo.rotation=0,this.Bo.rcnRef="",this.Wo.iconContent="",this.Wo.tooltipContent="",this.Wo.address="",this.Na();const t=this.Wo.latLng[0].toFixed(h.fixed)+","+this.Wo.latLng[1].toFixed(h.fixed),e=["way[highway](around:"+(a.svgViewboxDim*Ie.wa).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.Co+","+t+")[place];out;"];return await this.Lo.loadData(e,this.Wo.latLng),this.Lo.statusOk?this.Ta():null}async ba(t,e){const s=await this.fa();s?t(s):e("An error occurs...")}constructor(){this.Wo=new be,this.Bo=new ye,this.Lo=new de({searchRelations:!1,setGeometry:!1}),this.Co=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town),this.ga=!1}async getIconAndAdressAsync(t,e){return this.Wo.latLng=t,this.Bo.route=e,this.fa()}getIconAndAdressWithPromise(t){return this.Wo.latLng=t.latLng,this.Bo.route=t.route,new Promise(((t,e)=>this.ba(t,e)))}}class Me{ya;Ia(t){this.ya.hideWait();let e=t.street;""!==t.city&&(e+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"),this.ya.setControlsValues({address:e}),this.ya.updatePreview({address:e})}constructor(t){this.ya=t}setAddressWithGeoCoder(t){this.ya.showWait(),this.ya.hideError(),(new me).getAddressWithPromise(t).then((t=>{this.Ia(t)})).catch((t=>{t&&console.error(t),this.ya.hideWait(),this.ya.showError(S.getText("NoteDialogGeoCoderHelper - an error occurs when searching the adress"))}))}}class De{ya;lr;constructor(t,e){this.ya=t,this.lr=e}handleEvent(t){t.stopPropagation(),new Me(this.ya).setAddressWithGeoCoder(this.lr)}}class xe{ya;constructor(t){this.ya=t}handleEvent(t){t.stopPropagation(),"url"===t.target.dataset.tanName?this.ya.focusControl=null:this.ya.focusControl=t.target}}class Ee{ya;constructor(t){this.ya=t}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return void this.ya.hideError();""===L.sanitizeToUrl(t.target.value).errorsString?this.ya.hideError():this.ya.showError(S.getText("UrlInputBlurEL - invalidUrl"))}}class Pe{ya;constructor(t){this.ya=t}handleEvent(t){t.stopPropagation();const e={};"iconWidth"===t.target.dataset.tanName||"iconHeight"===t.target.dataset.tanName?e[t.target.dataset.tanName]=Number.parseInt(t.target.value):e[t.target.dataset.tanName]=t.target.value,this.ya.updatePreview(e)}}class Ce{ya;constructor(t){this.ya=t}handleEvent(t){if(!this.ya.focusControl)return;const e=t.currentTarget;let s=this.ya.focusControl.selectionStart,i=this.ya.focusControl.selectionEnd;this.ya.focusControl.value=this.ya.focusControl.value.slice(0,s)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.ya.focusControl.value.slice(s,i))+e.dataset.tanHtmlAfter+this.ya.focusControl.value.slice(i),s===i||0===e.dataset.tanHtmlAfter.length?(s+=e.dataset.tanHtmlBefore.length,i=s):i+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.ya.focusControl.setSelectionRange(s,i),this.ya.focusControl.focus();const r={};r[this.ya.focusControl.dataset.tanName]=this.ya.focusControl.value,this.ya.updatePreview(r)}}class Le{ya;Ma(t){this.ya.setControlsValues(t),this.ya.updatePreview(t)}Da(){const t=this.ya.mapIconData;t.route?(this.ya.showWait(),(new Ie).getIconAndAdressWithPromise(t).then((t=>{this.ya.hideWait(),this.Ma(t)})).catch((t=>{t instanceof Error&&console.error(t),this.ya.hideWait(),this.ya.showError(S.getText("IconSelectorChangeEL - an error occurs when creating the SVG icon"))}))):this.ya.showError(S.getText("IconSelectorChangeEL - not possible to create a SVG icon for a travel note"))}constructor(t){this.ya=t}handleEvent(t){t.stopPropagation();const e=se.preDefinedIconDataAt(t.target.selectedIndex);"SvgIcon"!==e.icon?this.Ma({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.Da()}}class Se{ya;constructor(t){this.ya=t}handleEvent(t){t.target.textContent="▼"===t.target.textContent?"▶":"▼",this.ya.toogleContents()}}class ke{ya;constructor(t){this.ya=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{se.loadJson(JSON.parse(e.result)),this.ya.updateToolbar()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Ae{ya;constructor(t){this.ya=t}handleEvent(t){t.stopPropagation(),k.openFile(new ke(this.ya),".json")}}class Re{xa;Ea;Pa;Ca;La;Sa;ka;Aa;constructor(t,e){this.xa=new xe(t),this.Ea=new Pe(t),this.Pa=new De(t,e),this.Ca=new Ee(t),this.La=new Ce(t),this.Sa=new Le(t),this.ka=new Se(t),this.Aa=new Ae(t)}destructor(){this.xa=null,this.Ea=null,this.Pa=null,this.Ca=null,this.La=null,this.Sa=null,this.ka=null,this.Aa=null}get controlFocus(){return this.xa}get controlInput(){return this.Ea}get addressButtonClick(){return this.Pa}get urlInputBlur(){return this.Ca}get editionButtonsClick(){return this.La}get iconSelectorChange(){return this.Sa}get toggleContentsButtonClick(){return this.ka}get openFileButtonClick(){return this.Aa}}class Oe{lr;ae;constructor(t,e){this.lr=t,this.ae=e}get latLng(){return this.lr}get route(){return this.ae}}class Be extends mt{oe;Ra;ae;uo;Oa;Ba;ja;Ha;Ua;Fa;Ka;Wa;ni;Va;za;bs(){this.ni.destructor(this.za),this.Oa.destructor(this.za),this.Ba.destructor(this.za),this.ja.destructor(this.za),this.Ha.destructor(this.za),this.Ua.destructor(this.za),this.Fa.destructor(this.za),this.Ka.destructor(this.za),this.za.destructor()}constructor(t,e){super(),this.Va=null,this.oe=t,this.ae=e,this.Ra=""===this.oe.address,this.za=new Re(this,t.latLng),this.uo=new U,this.uo.jsonObject=t.jsonObject,this.ni=new ie(this.za),this.Oa=new re(this.za),this.Ba=new oe(this.za),this.ja=new ae(this.za),this.Ha=new ne(this.za),this.Ua=new he(this.za,this.Ra),this.Fa=new le(this.za,t.latLng),this.Ka=new ce(this.za),this.Wa=new ue(this.uo),this.setControlsValues(t)}get focusControl(){return this.Va}set focusControl(t){this.Va=t}get mapIconData(){return new Oe(this.uo.latLng,this.ae)}updatePreview(t){for(const e in t)this.uo[e]=t[e];this.Wa.update()}onShow(){this.Ra&&new Me(this).setAddressWithGeoCoder(this.uo.latLng),this.toogleContents()}canClose(){return""===this.Ba.iconContent?(this.showError(S.getText("Notedialog - The icon content cannot be empty")),!1):""===this.Fa.url||""!==L.sanitizeToUrl(this.Fa.url).url||(this.showError(S.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this.bs(),super.onCancel()}onOk(){super.onOk()&&(this.oe.iconWidth=this.Oa.iconWidth,this.oe.iconHeight=this.Oa.iconHeight,this.oe.iconContent=this.Ba.iconContent,this.oe.tooltipContent=this.ja.tooltipContent,this.oe.popupContent=this.Ha.popupContent,this.oe.address=this.Ua.address,this.oe.url=this.Fa.url,this.oe.phone=this.Ka.phone,this.oe.latLng=this.uo.latLng,this.bs())}get title(){return S.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this.ni.rootHTMLElement,this.Oa.HTMLElements,this.Ba.HTMLElements,this.ja.HTMLElements,this.Ha.HTMLElements,this.Ua.HTMLElements,this.Fa.HTMLElements,this.Ka.HTMLElements)}get footerHTMLElements(){return this.Wa.HTMLElements}setControlsValues(t){this.Oa.iconHeight=t.iconHeight||this.Oa.iconHeight,this.Oa.iconWidth=t.iconWidth||this.Oa.iconWidth,this.Ba.iconContent=t.iconContent||this.Ba.iconContent,this.ja.tooltipContent=t.tooltipContent||this.ja.tooltipContent,this.Ha.popupContent=t.popupContent||this.Ha.popupContent,this.Ua.address=t.address||this.Ua.address,this.Fa.url=t.url||this.Fa.url,this.Ka.phone=t.phone||this.Ka.phone}toogleContents(){t.noteDialog.mask.iconsDimension&&this.Oa.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.iconTextArea&&this.Ba.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.popupContent&&this.Ha.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.tooltip&&this.ja.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.address&&(this.Ua.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Ua.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.link&&(this.Fa.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Fa.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.phone&&(this.Ka.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Ka.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}updateToolbar(){this.ni.update(this.za)}}class je{Ce;Ga;constructor(){}createUI(){if(this.Ce)return;this.Ce=et.create("div",{className:"TravelNotes-Background"},document.body);const t=et.create("div",{id:"TravelNotes-WaitUI"},this.Ce);this.Ga=et.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.Ga.textContent=t}close(){document.body.removeChild(this.Ce),this.Ce=null}}const He=new class{oe=null;ae=null;Za=!0;Xa=null;Ja(){this.Za?this.ae?(this.ae.notes.add(this.oe),this.oe.chainedDistance=this.ae.chainedDistance,this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("showitinerary")):(V.travel.notes.add(this.oe),Bt.dispatch("showtravelnotes")):Bt.dispatch(this.ae?"updateitinerary":"updatetravelnotes"),Bt.dispatch("noteupdated",{removedNoteObjId:this.oe.objId,addedNoteObjId:this.oe.objId}),Bt.dispatch("roadbookupdate")}ya(){new Be(this.oe,this.ae).show().then((()=>this.Ja())).catch((t=>{console.error(t)}))}Ya(t){this.Za=!0,this.oe=new U,this.oe.latLng=t,this.oe.iconLatLng=t}async qa(t){if(t.tags.rcn_ref?this.oe.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":this.oe.iconContent=se.preDefinedIconDataFromName(t.description),this.oe.url=t.tags.website||"",this.oe.phone=t.tags.phone||"",this.oe.tooltipContent=t.description||"",this.oe.popupContent=t.tags.name||"",t.tags["addr:street"]&&t.tags["addr:city"])this.oe.address=(t.tags["addr:housenumber"]?t.tags["addr:housenumber"]+" ":"")+t.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.tags["addr:city"]+"</span>";else{const e=new je;e.createUI(),e.showInfo("Creating address");let s=null;try{s=await(new me).getAddressAsync([t.lat,t.lon])}catch(t){console.error(t)}e.close(),this.oe.address=s.street,""!==s.city&&(this.oe.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+s.city+"</span>")}this.osmSearchNoteDialog||""===this.oe.iconContent?this.ya():this.Ja()}constructor(){}get osmSearchNoteDialog(){return null===this.Xa&&(this.Xa=t.osmSearch.showSearchNoteDialog),this.Xa}changeOsmSearchNoteDialog(){this.Xa=!this.osmSearchNoteDialog}newRouteNote(t,e){this.ae=tt.getRoute(t);const s=Y.getClosestLatLngDistance(this.ae,e);this.Ya(s.latLng),this.oe.distance=s.distance,this.ya()}newSearchRouteNote(t){const e=tt.getNearestRouteData([t.lat,t.lon]);e.route?(this.Ya(e.latLngOnRoute),this.oe.iconLatLng=[t.lat,t.lon],this.oe.distance=e.distanceOnRoute,this.ae=e.route,this.qa(t)):Rt.showError(S.getText("NoteEditor - No route was found"))}newSearchTravelNote(t){this.ae=null,this.Ya([t.lat,t.lon]),this.qa(t)}newTravelNote(t){this.ae=null,this.Ya(t),this.ya()}editNote(t){this.Za=!1;const e=tt.getNoteAndRoute(t);this.ae=e.route,this.oe=e.note,this.ya()}removeNote(t){const e=tt.getNoteAndRoute(t);e.route?(e.route.notes.remove(t),Bt.dispatch("updateitinerary")):(V.travel.notes.remove(t),Bt.dispatch("updatetravelnotes")),Bt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:m}),Bt.dispatch("roadbookupdate")}hideNotes(){let t=V.travel.notes.iterator;for(;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});if(m!==V.editedRouteObjId)for(t=V.travel.editedRoute.notes.iterator;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();const t=V.travel.notes.iterator;for(;!t.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)e.value.hidden||Bt.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){const e=tt.getNoteAndRoute(t).note,s=tt.getNearestRouteData(e.latLng);s.route&&(V.travel.notes.remove(t),e.distance=s.distance,e.latLng=s.latLngOnRoute,e.chainedDistance=s.route.chainedDistance,s.route.notes.add(e),s.route.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),Bt.dispatch("updateitinerary"),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate"))}detachNoteFromRoute(t){const e=tt.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=i.invalid,e.note.chainedDistance=i.defaultValue,V.travel.notes.add(e.note),Bt.dispatch("updateitinerary"),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate")}travelNoteDropped(t,e,s){V.travel.notes.moveTo(t,e,s),Bt.dispatch("updatetravelnotes"),Bt.dispatch("roadbookupdate")}};class Ue{$a;Qa;ae;static get tn(){return"\n"}static get en(){return"\n\t"}static get sn(){return"\n\t\t"}static get rn(){return"\n\t\t\t"}static get an(){return"\n\t\t\t\t"}nn(){this.$a='<?xml version="1.0"?>'+Ue.tn,this.$a+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}hn(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}ln(){const t=this.ae.wayPoints.iterator;for(;!t.done;)this.$a+=Ue.en+'<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Ue.sn+this.Qa+Ue.sn+"<name>"+this.hn(t.value.fullName)+"</name>"+Ue.en+"</wpt>"}cn(){this.$a+=Ue.en+"<rte>",this.$a+=Ue.sn+"<name>"+this.hn(this.ae.computedName)+"</name>";const t=this.ae.itinerary.maneuvers.iterator;for(;!t.done;){const e=this.ae.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId);this.$a+=Ue.sn+'<rtept lat="'+e.lat+'" lon="'+e.lng+'">'+Ue.rn+this.Qa+Ue.rn+"<desc>"+this.hn(t.value.instruction)+"</desc>"+Ue.sn+"</rtept>"}this.$a+=Ue.en+"</rte>"}un(){this.$a+=Ue.en+"<trk>",this.$a+=Ue.sn+"<name>"+this.hn(this.ae.computedName)+"</name>",this.$a+=Ue.sn+"<trkseg>";const t=this.ae.itinerary.itineraryPoints.iterator;for(;!t.done;)this.$a+=Ue.rn+'<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Ue.an+this.Qa+Ue.an+"<ele>"+t.value.elev+"</ele>"+Ue.rn+"</trkpt>";this.$a+=Ue.sn+"</trkseg>",this.$a+=Ue.en+"</trk>"}vn(){this.$a+=Ue.tn+"</gpx>"}dn(){let t=(""===V.travel.name?"":V.travel.name+" - ")+this.ae.computedName;""===t&&(t="TravelNote"),t+=".gpx",k.saveFile(t,this.$a,"application/xml")}constructor(){}routeToGpx(t){this.ae=tt.getRoute(t),this.ae&&(this.Qa="<time>"+(new Date).toISOString()+"</time>",this.nn(),this.ln(),this.cn(),this.un(),this.vn(),this.dn())}}class Fe{pn;_n;mn;constructor(t,s,i){this.pn="number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t?t:e.maxColorValue,this._n="number"==typeof s&&e.maxColorValue>=s&&e.minColorValue<=s?s:e.maxColorValue,this.mn="number"==typeof i&&e.maxColorValue>=i&&e.minColorValue<=i?i:e.maxColorValue}get red(){return this.pn}set red(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.pn=t)}get green(){return this._n}set green(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this._n=t)}get blue(){return this.mn}set blue(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.mn=t)}get cssColor(){return"#"+this.pn.toString(p).padStart(2,"0")+this._n.toString(p).padStart(2,"0")+this.mn.toString(p).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.pn=Number.parseInt(t.substring(1,3),p),this._n=Number.parseInt(t.substring(3,5),p),this.mn=Number.parseInt(t.substring(5,7),p)):"rgb"===t.substring(0,3)&&([this.pn,this._n,this.mn]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}clone(){return new Fe(this.pn,this._n,this.mn)}copyTo(t){t.red=this.pn,t.green=this._n,t.blue=this.mn}}class Ke{gn;constructor(t){this.gn=t}handleEvent(t){t.stopPropagation();const s=new Fe;s.red=Math.ceil(t.target.valueAsNumber*(e.maxColorValue/e.sliderMaxValue));for(let t=0;t<e.rowsNumber;++t){s.blue=t*e.deltaColor;for(let i=0;i<e.rowsNumber;++i)s.green=i*e.deltaColor,this.gn[e.rowsNumber*t+i].style["background-color"]=s.cssColor}}}class We{wn;Nn;constructor(t,e){this.wn=t,this.Nn=e}handleEvent(t){t.stopPropagation();const e=new Fe(Number.parseInt(this.Nn.red.value),Number.parseInt(this.Nn.green.value),Number.parseInt(this.Nn.blue.value));this.wn.color=e}}class Ve{wn=null;constructor(t){this.wn=t}handleEvent(t){t.stopPropagation();const e=new Fe;e.cssColor=t.target.style["background-color"],this.wn.color=e}}class ze{pn;_n;mn;constructor(t,e,s){this.pn=t,this._n=e,this.mn=s}get red(){return this.pn}get green(){return this._n}get blue(){return this.mn}}class Ge{Tn;gn;Nn;fn;bn;yn;In;Mn;Dn;xn;En(){const t=et.create("div",null,this.Tn),s=new Fe(e.initialRed,e.minColorValue,e.minColorValue);this.Mn=new Ve(this);for(let i=0;i<e.rowsNumber;++i){const i=et.create("div",null,t);s.green=e.minColorValue;for(let t=0;t<e.cellsNumber;++t){const t=et.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},i);t.style["background-color"]=s.cssColor,t.addEventListener("click",this.Mn,!1),s.green+=e.deltaColor,this.gn.push(t)}s.blue+=e.deltaColor}}Pn(){const t=et.create("div",null,this.Tn);this.fn=et.create("input",{type:"range",value:Math.ceil(e.initialRed*(e.sliderMaxValue/e.maxColorValue)),min:0,max:e.sliderMaxValue,step:e.sliderStep},t),this.xn=new Ke(this.gn),this.fn.addEventListener("input",this.xn,!1),this.fn.focus()}Cn(t,s){et.create("text",{value:t},this.bn);return et.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:s,min:e.minColorValue,max:e.maxColorValue},this.bn)}Ln(){this.bn=et.create("div",null,this.Tn),this.Nn=new ze(this.Cn(S.getText("ColorControl - Red"),this.In.red),this.Cn(S.getText("ColorControl - Green"),this.In.green),this.Cn(S.getText("ColorControl - Blue"),this.In.blue)),this.Dn=new We(this,this.Nn);for(const t in this.Nn)this.Nn[t].addEventListener("input",this.Dn,!1)}Sn(){this.yn=et.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this.Tn),this.yn.style["background-color"]=this.In.cssColor}constructor(t){this.gn=[],this.In=new Fe,this.In.cssColor=t,this.Tn=et.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this.En(),this.Pn(),this.Ln(),this.Sn()}destructor(){this.gn.forEach((t=>{t.removeEventListener("click",this.Mn,!1)})),this.Mn=null;for(const t in this.Nn)this.Nn[t].removeEventListener("input",this.Dn,!1);this.Dn=null,this.fn.removeEventListener("input",this.xn,!1),this.xn=null}get HTMLElements(){return[this.Tn]}get cssColor(){return this.In.cssColor}set color(t){this.Nn.red.value=t.red,this.Nn.green.value=t.green,this.Nn.blue.value=t.blue,this.yn.style["background-color"]=t.cssColor,t.copyTo(this.In)}}class Ze extends mt{ae;wn;kn;An;Rn;On;static get Bn(){return 1}static get jn(){return 40}Hn(){const t=et.create("div",{textContent:S.getText("RoutePropertiesDialog - Name")}),e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this.kn=et.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this.ae.computedName},e),[t,e]}Un(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return et.create("text",{value:S.getText("RoutePropertiesDialog - Width")},et.create("span",null,t)),this.An=et.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this.ae.width,min:Ze.Bn,max:Ze.jn},t),t}Fn(){const e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});et.create("text",{value:S.getText("RoutePropertiesDialog - Linetype")},et.create("span",null,e)),this.Rn=et.create("select",null,e);const s=t.route.dashChoices;return s.forEach((t=>{this.Rn.add(et.create("option",{text:t.text}))})),this.Rn.selectedIndex=this.ae.dashIndex<s.length?this.ae.dashIndex:0,e}Kn(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return et.create("text",{value:S.getText("RoutePropertiesDialog - Chained route")},et.create("span",null,t)),this.On=et.create("input",{type:"checkbox",checked:this.ae.chain},t),t}Wn(){return et.create("div",{textContent:S.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(t){super(),this.ae=t,this.wn=new Ge(t.color)}onCancel(){this.wn.destructor(),super.onCancel()}onOk(){this.ae.color=this.wn.cssColor,this.ae.computedName!==this.kn.value&&(this.ae.name=this.kn.value),this.ae.width=parseInt(this.An.value),this.ae.chain=this.On.checked,this.ae.dashIndex=this.Rn.selectedIndex,this.wn.destructor(),super.onOk()}get title(){return S.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this.Hn(),this.Un(),this.Fn(),this.Kn(),this.Wn(),this.wn.HTMLElements)}}class Xe{constructor(){}paperWidth=0;paperHeight=0;borderWidth=0;zoomFactor=0;printNotes=!1;firefoxBrowser=!0}class Je extends mt{Vn;zn;Gn;Zn;Xn;Jn;static get Yn(){return 15}qn(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Paper width")},e),this.Vn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),this.Vn.value=t.printRouteMap.paperWidth,et.create("text",{value:S.getText("PrintRouteMapDialog - Paper width units")},e),e}$n(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Paper height")},e),this.zn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.paperHeight},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Paper height units")},e),e}Qn(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Border width")},e),this.Gn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.borderWidth},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Border width units")},e),e}th(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Zoom factor")},e),this.Xn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(t.printRouteMap.zoomFactor,Je.Yn),min:V.map.getMinZoom(),max:Math.min(V.map.getMaxZoom(),Je.Yn)},e),e}eh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.Zn=et.create("input",{type:"checkbox",checked:t.printRouteMap.printNotes},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Print notes")},e),e}sh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Print with")},e),this.Jn=et.create("input",{type:"radio",checked:t.printRouteMap.firefoxBrowser,id:"TravelNotes-PrintRouteMapDialog-FirefoxBrowser",name:"Browser"},e),et.create("label",{htmlFor:"TravelNotes-PrintRouteMapDialog-FirefoxBrowser",innerText:"Firefox"},e),et.create("input",{type:"radio",checked:!t.printRouteMap.firefoxBrowser,id:"TravelNotes-PrintRouteMapDialog-OtherBrowser",name:"Browser"},e),et.create("label",{htmlFor:"TravelNotes-PrintRouteMapDialog-OtherBrowser",innerText:S.getText("PrintRouteMapDialog - Another browser")},e),e}constructor(){super()}onOk(){const t=new Xe;t.paperWidth=parseInt(this.Vn.value),t.paperHeight=parseInt(this.zn.value),t.borderWidth=parseInt(this.Gn.value),t.zoomFactor=parseInt(this.Xn.value),t.printNotes=this.Zn.checked,t.firefoxBrowser=this.Jn.checked,Object.freeze(t),super.onOk(t)}get contentHTMLElements(){return[this.qn(),this.$n(),this.Qn(),this.th(),this.eh(),this.sh()]}get title(){return S.getText("PrintRouteMapDialog - Print")}}class Ye{ce;constructor(t){this.ce=t}handleEvent(t){this.ce.dragStartX=t.screenX,this.ce.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class qe{ce;constructor(t){this.ce=t}handleEvent(t){const e=t.target.parentNode;this.ce.dialogX+=t.screenX-this.ce.dragStartX,this.ce.dialogY+=t.screenY-this.ce.dragStartY,this.ce.dialogX=Math.min(Math.max(this.ce.dialogX,v),V.map.getContainer().clientWidth-e.clientWidth-v),this.ce.dialogY=Math.max(this.ce.dialogY,v);const s=V.map.getContainer().clientHeight-Math.max(this.ce.dialogY,0)-v;e.style.top=String(this.ce.dialogY)+"px",e.style.left=String(this.ce.dialogX)+"px",e.style["max-height"]=String(s)+"px"}}class $e{ih=[];rh(t){this.ih.push(t.latLng),this.ih.push(t.iconLatLng)}oh(t){t.itinerary.itineraryPoints.forEach((t=>this.ih.push(t.latLng))),t.notes.forEach((t=>this.rh(t)))}constructor(){}zoomToLatLng(t){Bt.dispatch("zoomto",{latLng:t})}zoomToManeuver(t){const e=V.travel.editedRoute.itinerary.maneuvers.getAt(t).itineraryPointObjId,s=V.travel.editedRoute.itinerary.itineraryPoints.getAt(e).latLng;Bt.dispatch("zoomto",{latLng:s})}zoomToNote(t){this.ih=[],this.rh(tt.getNoteAndRoute(t).note),Bt.dispatch("zoomto",{geometry:[this.ih]})}zoomToRoute(t){this.ih=[],this.oh(tt.getRoute(t)),Bt.dispatch("zoomto",{geometry:[this.ih]})}zoomToTravel(){this.ih=[],V.travel.routes.forEach((t=>this.oh(t))),m!==V.travel.editedRouteObjId&&this.oh(V.travel.editedRoute),V.travel.notes.forEach((t=>this.rh(t))),Bt.dispatch("zoomto",{geometry:[this.ih]})}zoomToPoi(t){Bt.dispatch("zoomto",t)}}class Qe extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(S.getText("ProfileContextMenu - Add a note to the route at this point"),!0,(()=>He.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new qt(S.getText("ProfileContextMenu - Zoom to this point"),!0,(()=>(new $e).zoomToLatLng(this.eventData.latLng)))]}}class ts{constructor(){}getlatLngElevOnRouteAtMousePosition(t){const e=tt.getRoute(Number.parseInt(t.currentTarget.dataset.tanObjId)),s=t.currentTarget.getBoundingClientRect(),i=(t.clientX-s.x-Ht.PROFILE_MARGIN/(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*s.width)/(Ht.PROFILE_WIDTH/(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*s.width)*e.distance;return 0<i&&i<e.distance?Y.getLatLngElevAtDist(e,i):null}}class es extends ts{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();const e=this.getlatLngElevOnRouteAtMousePosition(t);e&&(t.latlng={lat:e.latLng[0],lng:e.latLng[1]},new Qe(t).show())}}class ss{constructor(){}handleEvent(t){t.preventDefault(),t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.currentTarget.dataset.tanMarkerObjId)})}}class is extends ts{ah;nh;hh;lh;uh;dh;ph;_h(t,e){const s=document.createElementNS(N,"text");return s.appendChild(document.createTextNode(t)),s.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),s.setAttributeNS(null,"x",this.dh),s.setAttributeNS(null,"y",e),s.setAttributeNS(null,"text-anchor",this.uh),this.ph.appendChild(s),s}constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.ph=t.currentTarget;const e=this.getlatLngElevOnRouteAtMousePosition(t);if(e){const s=Number.parseInt(this.ph.dataset.tanMarkerObjId);Bt.dispatch("removeobject",{objId:s}),Bt.dispatch("additinerarypointmarker",{objId:s,latLng:e.latLng}),this.ah&&this.ph.contains(this.ah)?(this.ph.removeChild(this.ah),this.ph.removeChild(this.nh),this.ph.removeChild(this.hh),this.ph.removeChild(this.lh)):(this.ah=null,this.nh=null,this.hh=null,this.lh=null);const i=this.ph.getBoundingClientRect();this.dh=(2*Ht.PROFILE_MARGIN+Ht.PROFILE_WIDTH)*(t.clientX-i.x)/i.width;const r=Ht.PROFILE_MARGIN+Ht.PROFILE_HEIGHT;this.ah=document.createElementNS(N,"polyline"),this.ah.setAttributeNS(null,"points",String(this.dh)+","+Ht.PROFILE_MARGIN+" "+this.dh+","+r),this.ah.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.ph.appendChild(this.ah);const o=tt.getRoute(Number.parseInt(this.ph.dataset.tanObjId));this.uh=e.distance>o.distance/2?"end":"start",this.dh+=e.distance>o.distance/2?-Ht.X_DELTA_TEXT:Ht.X_DELTA_TEXT,this.nh=this._h(k.formatDistance(e.distance),Ht.PROFILE_MARGIN+Ht.Y_DELTA_TEXT),this.hh=this._h("Alt. "+e.elev.toFixed(0)+" m.",Ht.PROFILE_MARGIN+2*Ht.Y_DELTA_TEXT),this.lh=this._h("Pente "+e.ascent.toFixed(0)+" % ",Ht.PROFILE_MARGIN+3*Ht.Y_DELTA_TEXT)}}}class rs extends class{ce;Le;Oe;mh;gh;Ge;Ze;es(){this.Le=et.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}ss(){this.Oe=et.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this.Le),this.Oe.addEventListener("dragstart",this.Ge,!1),this.Oe.addEventListener("dragend",this.Ze,!1),et.create("div",{textContent:"❌",className:"TravelNotes-FloatWindow-CancelButton",title:S.getText("FloatWindow - Close")},this.Oe).addEventListener("click",(()=>this.close()),!1)}rs(){this.mh=et.create("div",null,this.Le)}os(){this.gh=et.create("div",null,this.Le)}constructor(){this.ce=new pt,this.Ge=new Ye(this.ce),this.Ze=new qe(this.ce),this.es(),this.ss(),this.rs(),this.os()}close(){this.Oe.removeEventListener("dragstart",this.Ge,!1),this.Oe.removeEventListener("dragend",this.Ze,!1),this.Ge=null,this.Ze=null,document.body.removeChild(this.Le)}update(){}get header(){return this.mh}get content(){return this.gh}}{Ni=null;wh=null;ae=null;Nh=null;Th=null;fh=null;bh=f.nextObjId;yh(){this.Ni&&(this.Ni.removeEventListener("contextmenu",this.Nh,!1),this.Ni.removeEventListener("mousemove",this.Th,!1),this.Ni.removeEventListener("mouseleave",this.fh,!1),Bt.dispatch("removeobject",{objId:this.bh}),this.content.removeChild(this.wh),this.content.removeChild(this.Ni)),this.Ni=null,this.wh=null}constructor(){super(),this.Nh=new es,this.Th=new is,this.fh=new ss}close(){this.yh(),Bt.dispatch("profileclosed",{objId:this.ae.objId}),super.close()}update(t){this.yh(),this.ae=t,this.Ni=(new Ht).createSvg(this.ae),this.Ni.dataset.tanObjId=t.objId,this.Ni.dataset.tanMarkerObjId=this.bh,this.header.textContent=S.getText("ProfileWindow - Profile {name}",{name:this.ae.computedName}),this.content.appendChild(this.Ni),this.Ni.addEventListener("contextmenu",this.Nh,!1),this.Ni.addEventListener("mousemove",this.Th,!1),this.Ni.addEventListener("mouseleave",this.fh,!1),this.wh=et.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:S.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this.ae.itinerary.ascent.toFixed(0),descent:this.ae.itinerary.descent.toFixed(0),distance:k.formatDistance(this.ae.distance)})}),this.content.appendChild(this.wh)}}class os{ae;Ih;Mh;get Dh(){return t.route.elev.smoothPoints}xh(){this.Mh=[],this.Mh.push({distance:0,elev:this.ae.itinerary.itineraryPoints.first.elev,smoothElev:this.ae.itinerary.itineraryPoints.first.elev});const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=0,s=t.value.distance,i=t.value.elev;t.done;let r=this.Ih;for(;r<this.ae.distance;){if(s<r)for(e=s,i=t.value.elev;s<r;)s+=t.value.distance,t.done;const o=i+(r-e)*((t.value.elev-i)/(s-e));this.Mh.push({distance:r,elev:o,smoothElev:0}),r+=this.Ih}this.Mh.push({distance:this.ae.distance,elev:this.ae.itinerary.itineraryPoints.last.elev,smoothElev:this.ae.itinerary.itineraryPoints.last.elev})}Eh(){let t=(this.Mh[this.Dh-1].elev-this.Mh[0].elev)/(this.Dh-1),e=0;for(e=0;e<this.Dh;e++)this.Mh[e].smoothElev=this.Mh[0].elev+t*e;for(e=this.Dh;e<this.Mh.length-this.Dh;e++){let t=0;for(let s=e-this.Dh;s<=e+this.Dh;s++)t+=this.Mh[s].elev;this.Mh[e].smoothElev=t/(2*this.Dh+1)}e--;const s=(this.Mh[e+this.Dh].smoothElev-this.Mh[e].smoothElev)/this.Dh;let i=this.Mh[e].smoothElev,r=1;for(e++;e<this.Mh.length-1;r++,e++)this.Mh[e].smoothElev=i+s*r}Ph(){const e=this.ae.itinerary.itineraryPoints.iterator;let s=0;for(;!e.done;)s+=e.next?Math.abs(e.value.elev-e.next.elev):0;this.Ih=Math.floor(Math.min(t.route.elev.smoothCoefficient*this.ae.distance/s,this.ae.distance/(3*this.Dh)))}Ch(){const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=t.value.distance;for(;!t.done;){const s=this.Mh[Math.floor(e/this.Ih)],i=this.Mh[Math.ceil(e/this.Ih)];if(s&&i){const r=e-s.distance,o=(i.elev-s.elev)/(i.distance-s.distance);t.value.elev=s.elev+r*o}e+=t.value.distance}}constructor(){}smooth(t){this.ae=t,this.Ph(),this.xh(),this.Eh(),this.Ch()}}const as=new class{Lh=new Map;constructor(){}createProfile(e){const s=this.Lh.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new os).smooth(e);let i=0,r=0,o=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let e=t.elev-o;0>e?r-=e:i+=e,o=t.elev})),e.itinerary.ascent=i,e.itinerary.descent=r,s&&s.update(e)}else s&&s.close()}updateProfile(t,e){const s=this.Lh.get(t);s&&(this.Lh.delete(t),e&&e.itinerary.hasProfile?(s.update(e),this.Lh.set(e.objId,s)):s.close())}deleteProfile(t){const e=this.Lh.get(t);e&&e.close()}deleteAllProfiles(){this.Lh.forEach((t=>t.close()))}showProfile(t){let e=this.Lh.get(t);e||(e=new rs);const s=tt.getRoute(t);e.update(s),this.Lh.set(t,e)}onProfileClosed(t){this.Lh.delete(t)}};class ns{Bt;Cr;constructor(t,e){this.Bt=t,this.Cr=e}get width(){return this.Bt}get height(){return this.Cr}}class hs{constructor(){}bottomLeft;upperRight;entryPoint;exitPoint}class ls{Sh;ae;kh;Ah(t,e,s){return e.lng===s.lng?new z(e.lat>s.lat?t.bottomLeft.lat:t.upperRight.lat,e.lng):e.lat===s.lat?new z(e.lat,e.lng<s.lng?t.upperRight.lng:t.bottomLeft.lng):null}Rh(t,e){const s=1e-6;return e.lat-t.bottomLeft.lat<s||t.upperRight.lat-e.lat<s||e.lng-t.bottomLeft.lng<s||t.upperRight.lng-e.lng<s?z.clone(e):null}Oh(t,e,s){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){const t=Math.min(Math.abs(this.kh.height/(s.lat-e.lat)),Math.abs(this.kh.width/(s.lng-e.lng)));return new z(e.lat+t*(s.lat-e.lat),e.lng+t*(s.lng-e.lng))}return null}Bh(t,e,s){let i=this.Oh(t,e,s);if(i)return i;if(i=this.Rh(t,e),i)return i;if(i=this.Ah(t,e,s),i)return i;const r=(e.lat-s.lat)/(e.lng-s.lng),o=e.lat-r*e.lng;if(i=new z(r*t.upperRight.lng+o,t.upperRight.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng<s.lng)return i;if(i=new z(t.upperRight.lat,(t.upperRight.lat-o)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat<s.lat)return i;if(i=new z(r*t.bottomLeft.lng+o,t.bottomLeft.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng>s.lng)return i;if(i=new z(t.bottomLeft.lat,(t.bottomLeft.lat-o)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat>s.lat)return i;throw new Error("intermediate point not found")}jh(){this.Sh=[];const t=this.ae.itinerary.itineraryPoints.iterator;let e=t.done,s=new hs;s.bottomLeft=z.clone(t.value),s.upperRight=z.clone(t.value),s.entryPoint=z.clone(t.value);let i=t.value,r=z.clone(t.value);e=t.done;let o=t.value;for(;!e;){const a=new hs;a.bottomLeft=new z(Math.min(s.bottomLeft.lat,o.lat),Math.min(s.bottomLeft.lng,o.lng)),a.upperRight=new z(Math.max(s.upperRight.lat,o.lat),Math.max(s.upperRight.lng,o.lng)),a.entryPoint=z.clone(s.entryPoint),this.kh.height>a.upperRight.lat-a.bottomLeft.lat&&this.kh.width>a.upperRight.lng-a.bottomLeft.lng?(s=a,i=t.value,r=z.clone(t.value),e=t.done,o=t.value,e&&(s.exitPoint=r,this.Sh.push(Object.freeze(s)))):(r=this.Bh(s,i,o),s.bottomLeft=new z(Math.min(s.bottomLeft.lat,r.lat),Math.min(s.bottomLeft.lng,r.lng)),s.upperRight=new z(Math.max(s.upperRight.lat,r.lat),Math.max(s.upperRight.lng,r.lng)),s.exitPoint=r,this.Sh.push(Object.freeze(s)),s=new hs,s.bottomLeft=z.clone(r),s.upperRight=z.clone(r),s.entryPoint=z.clone(r))}}constructor(t,e){this.ae=t,this.kh=e,this.jh()}get printViews(){return this.Sh}}class cs{Pe;jt;Hh;constructor(t){if("string"!=typeof t?.text||"string"!=typeof t?.color||"string"!=typeof t?.backgroundColor)throw new Error("invalid toolbar for layer");this.Pe=L.sanitizeToJsString(t.text),this.jt=L.sanitizeToColor(t.color),this.Hh=L.sanitizeToColor(t.backgroundColor)}get text(){return this.Pe}get color(){return this.jt}get backgroundColor(){return this.Hh}}class us{ot=null;Uh=null;N=null;Fh=null;Kh=null;Wh=null;Vh=null;zh=null;ee=null;Gh=!1;Zh=null;Xh=null;Jh(){if("string"!=typeof this.Xh?.name)throw new Error("invalid name for layer");this.ot=L.sanitizeToJsString(this.Xh.name)}Yh(){if("wms"!==this.Xh?.service&&"wmts"!==this.Xh?.service)throw new Error("invalid service for layer "+this.ot);this.Uh=this.Xh.service}qh(){if("string"!=typeof this.Xh?.url)throw new Error("invalid url for layer "+this.ot);this.N=this.Xh.url}$h(){if("wms"===this.Uh){if("string"!=typeof this.Xh?.wmsOptions?.layers||"string"!=typeof this.Xh?.wmsOptions?.format||"boolean"!=typeof this.Xh?.wmsOptions?.transparent)throw new Error("invalid wmsOptions for layer "+this.ot);this.Fh=this.Xh.wmsOptions,this.Fh.layers=L.sanitizeToJsString(this.Fh.layers),this.Fh.format=L.sanitizeToJsString(this.Fh.format)}}Qh(){try{this.Xh.bounds&&"number"==typeof this.Xh.bounds[0][0]&&"number"==typeof this.Xh.bounds[0][1]&&"number"==typeof this.Xh.bounds[1][0]&&"number"==typeof this.Xh.bounds[1][1]&&(this.Kh=this.Xh.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.ot)}}tl(){if(this.Xh.minZoom){if("number"!=typeof this.Xh.minZoom)throw new Error("invalid minZoom for layer "+this.ot);this.Wh=this.Xh.minZoom}if(this.Xh.maxZoom){if("number"!=typeof this.Xh.maxZoom)throw new Error("invalid maxZoom for layer "+this.ot);this.Vh=this.Xh.maxZoom}}el(){this.zh=new cs(this.Xh.toolbar)}sl(){if("string"!=typeof this.Xh?.providerName)throw new Error("invalid providerName for layer "+this.ot);this.ee=L.sanitizeToJsString(this.Xh.providerName)}il(){if("boolean"!=typeof this.Xh.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.ot);this.Gh=this.Xh.providerKeyNeeded}rl(){if(""===this.Xh.attribution)this.Zh="";else{if("string"!=typeof this.Xh?.attribution)throw new Error("invalid attribution for map layer "+this.ot);this.Zh=L.sanitizeToHtmlString(this.Xh.attribution).htmlString}}constructor(t){this.Xh=t,this.Jh(),this.Yh(),this.qh(),this.$h(),this.Qh(),this.tl(),this.el(),this.sl(),this.il(),this.rl(),this.Xh=null}get name(){return this.ot}get service(){return this.Uh}get url(){return this.N}get wmsOptions(){return this.Fh}get bounds(){return this.Kh}get minZoom(){return this.Wh}get maxZoom(){return this.Vh}get toolbarButtonData(){return this.zh}get providerName(){return this.ee}get providerKeyNeeded(){return this.Gh}get attribution(){return this.Zh}}const vs=new class{ol;al;nl;constructor(){this.ol=new Map,this.nl=!1,this.al=new us({service:"wmts",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.ol.set(this.al.name,this.al)}getMapLayer(t){let e=this.ol.get(t)||this.al;return e.providerKeyNeeded&&(jt.hasKey(e.providerName.toLowerCase())||(e=this.al)),e}forEach(t){this.ol.forEach(t)}addMapLayers(t){this.nl||(t.forEach((t=>{const e=new us(t);this.ol.get(e.name)||this.ol.set(e.name,e)})),this.nl=!0)}get defaultMapLayer(){return this.al}};class ds{constructor(){}handleEvent(){window.print()}}class ps{hl=null;constructor(t){this.hl=t}handleEvent(){this.hl.onAfterPrint(),this.hl=null}}class _s{ll;ae;Sh;cl;ul;Re;vl;dl;pl;_l;ml;onAfterPrint(){this.dl.forEach((t=>document.body.removeChild(t))),this.dl.length=0,this.ul.removeEventListener("click",this._l,!1),this.Re.removeEventListener("click",this.ml,!1),document.body.removeChild(this.cl);const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");V.map.invalidateSize(!1),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),window.removeEventListener("afterprint",this.ml,!0),this.ml=null,this._l=null}gl(){const t=vs.getMapLayer(V.travel.layerName),e=jt.getUrl(t),s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);return s.options.attribution=L.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,s}wl(){const t=[];return this.ae.notes.forEach((e=>{const s=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),i=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:s,draggable:!0});t.push(i)})),t}Nl(e){this.vl++;const s="TravelNotes-RouteViewDiv"+this.vl,i=document.createElement("div");i.className="TravelNotes-routeViewDiv",i.id=s,document.body.appendChild(i),this.dl.push(i),i.style.width=String(this.ll.paperWidth)+"mm",i.style.height=String(this.ll.paperHeight)+"mm";const r=this.ll.printNotes?this.wl():[];r.push(this.gl()),r.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),r.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),r.push(this.pl),window.L.map(s,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.ll.zoomFactor,minZoom:this.ll.zoomFactor,maxZoom:this.ll.zoomFactor,layers:r})}Tl(){this.cl=et.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.ul=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.cl),this.ul.addEventListener("click",this._l,!1),this.Re=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.cl),this.Re.addEventListener("click",this.ml,!1)}constructor(t,e,s){this.ae=t,this.Sh=e,this.ll=s,this.vl=0,this.dl=[],this._l=new ds,this.ml=new ps(this)}preparePage(){this.ll.firefoxBrowser?document.body.classList.add("TravelNotes-Maps-FirefoxBrowser"):document.body.classList.remove("TravelNotes-Maps-FirefoxBrowser");const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===V.travel.name?"maps":V.travel.name+" - "+this.ae.computedName+" - maps",this.Tl(),window.addEventListener("afterprint",this.ml,!0);const e=[],s=this.ae.itinerary.itineraryPoints.iterator;for(;!s.done;)e.push(s.value.latLng);this.pl=window.L.polyline(e,{color:this.ae.color,weight:this.ae.width,dashArray:this.ae.dashString}),this.vl=0,this.Sh.forEach((t=>this.Nl(t)))}}class ms{fl=0;static get bl(){return 256}yl(t){const e=et.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm";const s=Y.screenCoordToLatLng(0,0),i=Y.screenCoordToLatLng(e.clientWidth,e.clientHeight);this.fl=Math.ceil(e.clientWidth/ms.bl)*Math.ceil(e.clientHeight/ms.bl),document.body.removeChild(e);const r=V.map.getZoomScale(V.map.getZoom(),t.zoomFactor);return new ns(Math.abs(s[1]-i[1])*r,Math.abs(s[0]-i[0])*r)}constructor(){}print(e,s){const i=tt.getRoute(s);if(!i)return;const r=new ls(i,this.yl(e));if(t.printRouteMap.maxTiles<r.printViews.length*this.fl)return void Rt.showError(S.getText("RoutePrinter - The maximum of allowed pages is reached."));new _s(i,r.printViews,e).preparePage()}}const gs=new class{constructor(){}addRoute(){const t=new F;V.travel.routes.add(t),this.chainRoutes(),c.editedChanged===V.travel.editedRoute.editionStatus?(Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate")):this.editRoute(t.objId)}editRoute(t){const e=tt.getRoute(t),s=e.itinerary.provider,i=V.providers.get(s.toLowerCase());if(s&&""!==s&&(!i||i.providerKeyNeeded&&!jt.hasKey(s)))return void Rt.showError(S.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:s}));m!==V.editedRouteObjId&&this.cancelEdition(),s&&""!==s&&Bt.dispatch("setprovider",{provider:s});const r=e.itinerary.transitMode;r&&""!==r&&Bt.dispatch("settransitmode",{transitMode:r}),V.travel.editedRoute=new F,e.editionStatus=c.editedNoChange,V.travel.editedRoute.jsonObject=e.jsonObject,V.editedRouteObjId=e.objId,V.travel.editedRoute.hidden=!1,e.hidden=!1,as.updateProfile(V.editedRouteObjId,V.travel.editedRoute),this.chainRoutes(),Bt.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:V.travel.editedRoute.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("showitinerary"),Bt.dispatch("setrouteslist")}removeRoute(t){let e=t;e!==V.editedRouteObjId&&e!==V.travel.editedRoute.objId||(e=V.editedRouteObjId,this.cancelEdition()),Bt.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:m}),V.travel.routes.remove(e),as.deleteProfile(e),this.chainRoutes(),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist")}saveGpx(t){(new Ue).routeToGpx(t)}chainRoutes(){const t=V.travel.routes.iterator;let e=i.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=i.defaultValue;const s=t.value.notes.iterator;for(;!s.done;)s.value.chainedDistance=t.value.chainedDistance;if(t.value.objId===V.editedRouteObjId){V.travel.editedRoute.chainedDistance=V.travel.editedRoute.chain?t.value.chainedDistance:i.defaultValue;const e=V.travel.editedRoute.notes.iterator;for(;!e.done;)e.value.chainedDistance=V.travel.editedRoute.chainedDistance}}}saveEdition(){const t=new F;t.jsonObject=V.travel.editedRoute.jsonObject,V.travel.routes.replace(V.editedRouteObjId,t),V.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){const t=tt.getRoute(V.editedRouteObjId);t.editionStatus=c.notEdited,as.updateProfile(V.travel.editedRoute.objId,t),Bt.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.editedRouteObjId}),V.editedRouteObjId=m,V.travel.editedRoute=new F,this.chainRoutes(),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary")}routeProperties(t){const e=tt.getRoute(t);new Ze(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&Bt.dispatch("routepropertiesupdated",{routeObjId:e.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("setrouteslist"),Bt.dispatch("updateitinerary")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new Je).show().then((e=>(new ms).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){tt.getRoute(t).hidden=!1,Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t}),Bt.dispatch("setrouteslist")}hideRoute(t){tt.getRoute(t).hidden=!0,Bt.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:m}),Bt.dispatch("setrouteslist")}showRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId}));Bt.dispatch("setrouteslist")}hideRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===V.editedRouteObjId||(t.value.hidden=!0,Bt.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:m}));Bt.dispatch("setrouteslist")}};class ws extends mt{Il;eo;Ml;kn;async handleEvent(e){if(e.stopPropagation(),!t.wayPoint.reverseGeocoding)return;this.showWait();const s=await(new me).getAddressAsync(this.Il.latLng);this.hideWait(),t.wayPoint.geocodingIncludeName&&(this.kn.value=s.name);let i=s.street;""!==s.city&&(i+=" "+s.city),this.eo.value=i}Dl(){const t=et.create("div");this.Ml=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("WayPointPropertiesDialog - Reset address"),textContent:"🔄"},t),this.Ml.addEventListener("click",this,!1),et.create("text",{value:S.getText("WayPointPropertiesDialog - Address")},t);const e=et.create("div");return this.eo=et.create("input",{type:"text",value:this.Il.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}xl(){const t=et.create("div",{textContent:S.getText("WayPointPropertiesDialog - Name")}),e=et.create("div");return this.kn=et.create("input",{type:"text",value:this.Il.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}constructor(t){super(),this.Il=t}onCancel(){this.Ml.removeEventListener("click",this,!1),super.onCancel()}onOk(){this.Il.address=this.eo.value,this.Il.name=this.kn.value,this.Ml.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this.xl(),this.Dl())}get title(){return S.getText("WayPointPropertiesDialog - Waypoint properties")}}const Ns=new class{El;Pl;Cl(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;for(e.done,s.done,s.value.distance=i.defaultValue,s.done,t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=i.defaultValue),s.done)}Ll(t){this.El=!1,t instanceof Error?(console.error(t),Rt.showError(t.message)):Rt.showError("A network error occurs when calling the provider")}Sl(){if(this.El=!1,this.Cl(V.travel.editedRoute),"circle"!==V.travel.editedRoute.itinerary.transitMode){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng).latLng}const t=V.travel.editedRoute.notes.iterator;for(;!t.done;){const e=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng);t.value.latLng=e.latLng,t.value.distance=e.distance}gs.chainRoutes(),V.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.Pl&&(new $e).zoomToRoute(V.travel.editedRoute.objId),as.createProfile(V.travel.editedRoute),Bt.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.travel.editedRoute.objId}),Bt.dispatch("roadbookupdate"),Bt.dispatch("showitinerary"),Bt.dispatch("setrouteslist")}constructor(){}startRouting(){if(!this.El&&V.travel.editedRoute.haveValidWayPoints()){this.Pl=0===V.travel.editedRoute.itinerary.itineraryPoints.length,this.El=!0;const t=V.providers.get(V.routing.provider.toLowerCase());V.travel.editedRoute.itinerary.provider=t.name,V.travel.editedRoute.itinerary.transitMode=V.routing.transitMode,t.getPromiseRoute(V.travel.editedRoute).then((()=>this.Sl())).catch((()=>this.Ll()))}}};const Ts=new class{async kl(e){if(!t.wayPoint.reverseGeocoding)return Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),void Bt.dispatch("roadbookupdate");const s=await(new me).getAddressAsync(e.latLng);V.editedRouteObjId===V.travel.editedRoute.objId&&(V.travel.editedRoute.editionStatus=c.editedChanged),e.address=s.street,""!==s.city&&(e.address+=" "+s.city),e.name="",t.wayPoint.geocodingIncludeName&&(e.name=s.name),Bt.dispatch("setrouteslist"),Bt.dispatch("updateitinerary"),Bt.dispatch("roadbookupdate")}Al(t){const e=V.travel.editedRoute.wayPoints.first;e.latLng=t,this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:e,letter:"A"})}Rl(t){const e=V.travel.editedRoute.wayPoints.last;e.latLng=t,this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:e,letter:"B"})}constructor(){}addWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=new O;e.latLng=t,V.travel.editedRoute.wayPoints.add(e),this.kl(e),Bt.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.last,letter:V.travel.editedRoute.wayPoints.length-2}),V.travel.editedRoute.wayPoints.swap(e.objId,!0),Ns.startRouting()}addWayPointOnRoute(t,e){const s=Y.getClosestLatLngDistance(V.travel.editedRoute,t).distance;V.travel.editedRoute.editionStatus=c.editedChanged;const i=new O;i.latLng=e;let r="";const o=V.travel.editedRoute.wayPoints.iterator;for(;!o.done;){if(s<Y.getClosestLatLngDistance(V.travel.editedRoute,o.value.latLng).distance){r=String(o.index),V.travel.editedRoute.wayPoints.add(i),V.travel.editedRoute.wayPoints.moveTo(i.objId,o.value.objId,!0),this.kl(i),Bt.dispatch("addwaypoint",{wayPoint:i,letter:r}),Ns.startRouting();break}}}reverseWayPoints(){V.travel.editedRoute.editionStatus=c.editedChanged;let t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)Bt.dispatch("removeobject",{objId:t.value.objId});for(V.travel.editedRoute.wayPoints.reverse(),t=V.travel.editedRoute.wayPoints.iterator;!t.done;)Bt.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":String(t.index)});Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate"),Ns.startRouting()}removeWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,Bt.dispatch("removeobject",{objId:t}),V.travel.editedRoute.wayPoints.remove(t),Ns.startRouting()}setStartPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.Al(t),Ns.startRouting()}setEndPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.Rl(t),Ns.startRouting()}setStartAndEndPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.Al(t),this.Rl(t),2<V.travel.editedRoute.wayPoints.length&&Ns.startRouting()}wayPointDragEnd(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=V.travel.editedRoute.wayPoints.getAt(t.target.objId),s=t.target.getLatLng();e.latLng=[s.lat,s.lng],this.kl(e),Ns.startRouting()}wayPointProperties(t){const e=V.travel.editedRoute.wayPoints.getAt(t);new ws(e).show().then((()=>{Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class fs extends mt{constructor(t){super(t)}get contentHTMLElements(){return[et.create("div",{textContent:this.options.text||""})]}get title(){return this.options.title||""}}class bs{ae=null;Ol=0;Bl(t){const e=new U;for(const s in t)e[s]=t[s];e.iconLatLng=e.latLng,e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,e.chainedDistance=this.ae.chainedDistance,this.ae.notes.add(e),Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.objId})}async jl(){const t=new je;t.createUI();const e=new Ie,s=this.ae.itinerary.maneuvers.iterator;for(;!s.done;){t.showInfo(S.getText("AllManeuverNotesBuilder - Creating note",{noteNumber:s.index+1,notesLength:this.Ol}));const i=this.ae.itinerary.itineraryPoints.getAt(s.value.itineraryPointObjId).latLng,r=await e.getIconAndAdressAsync(i,this.ae);r?this.Bl(r):console.error("An error occurs when creating the svg icon "+s.index)}this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Bt.dispatch("updateitinerary"),Bt.dispatch("roadbookupdate"),t.close()}constructor(){}addAllManeuverNotes(e){this.ae=tt.getRoute(e),this.Ol=this.ae.itinerary.maneuvers.length,t.note.maxManeuversNotes<this.Ol?Rt.showError(S.getText("AllManeuverNotesBuilder - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:this.Ol,maxManeuversNotes:t.note.maxManeuversNotes})):new fs({title:S.getText("AllManeuverNotesBuilder - Add a note for each maneuver"),text:S.getText("AllManeuverNotesBuilder - Add a note for each maneuver. Are you sure?",{noteLength:this.Ol}),secondButtonText:"❌"}).show().then((()=>this.jl())).catch((t=>{t instanceof Error&&console.error(t)}))}}class ys extends Qt{ae=null;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getRoute(this.eventData.targetObjId))}get menuItems(){return[new qt(S.getText("RouteContextMenu - Edit this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId&&c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>gs.editRoute(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Delete this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId||c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>gs.removeRoute(this.eventData.targetObjId))),new qt(S.getText(this.ae.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),this.ae.hidden||V.travel.editedRoute.objId!==this.eventData.targetObjId,(()=>{this.ae.hidden?gs.showRoute(this.eventData.targetObjId):gs.hideRoute(this.eventData.targetObjId)})),new qt(S.getText("RouteContextMenu - Properties"),!this.ae.hidden,(()=>gs.routeProperties(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Zoom to route"),!this.ae.hidden,(()=>(new $e).zoomToRoute(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - View the elevation"),this.ae.itinerary.hasProfile,(()=>as.showProfile(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Print route map"),t.printRouteMap.isEnabled,(()=>gs.printRouteMap(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Save this route in a GPX file"),0<this.ae.itinerary.itineraryPoints.length,(()=>gs.saveGpx(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Invert waypoints"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>Ts.reverseWayPoints())),new qt(S.getText("RouteContextMenu - Add a note on the route"),!this.eventData.haveParentNode,(()=>He.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new qt(S.getText("RouteContextMenu - Create a note for each route maneuver"),!this.ae.hidden,(()=>(new bs).addAllManeuverNotes(this.eventData.targetObjId))),new qt(S.getText("RouteContextMenu - Save modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>gs.saveEdition())),new qt(S.getText("RouteContextMenu - Cancel modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>gs.cancelEdition()))]}}class Is{static handleEvent(t){const e=tt.getRoute(t.target.objId);let s=Y.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;s+=e.chainedDistance,s=k.formatDistance(s);const i=V.mapObjects.get(t.target.objId);i.closeTooltip();let r=e.computedName;V.travel.readOnly||(r+=0===r.length?"":" - ",r+=s),i.setTooltipContent(r),i.openTooltip(t.latlng)}}class Ms{static handleEvent(t){window.L.DomEvent.stopPropagation(t),new ys(t).show()}}class Ds{ah;Hl;Ul;constructor(t,e,s){this.ah=t,this.Hl=e,this.Ul=s}get marker(){return this.ah}get polyline(){return this.Hl}get bullet(){return this.Ul}}class xs{Fl;Kl;static get Wl(){return 18}static get Vl(){return 0}static get zl(){return 100}constructor(){this.Fl=null,this.Kl=null}addToMap(t,e){e.objId=t,e.addTo(V.map),V.mapObjects.set(t,e)}addRoute(t){const e=tt.getRoute(t),s=[],i=e.itinerary.itineraryPoints.iterator;for(;!i.done;)s.push(i.value.latLng);const r=window.L.polyline(s,{color:e.color,weight:e.width,dashArray:e.dashString});this.addToMap(e.objId,r),c.notEdited===e.editionStatus&&(r.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(r,"mouseover",Is.handleEvent),window.L.DomEvent.on(r,"mousemove",Is.handleEvent)),r.bindPopup((t=>L.clone(Kt.getRouteHeaderHTML("TravelNotes-Map-",tt.getRoute(t.objId))))),window.L.DomEvent.on(r,"click",(t=>t.target.openPopup(t.latlng)));const o=e.notes.iterator;for(;!o.done;)this.addNote(o.value.objId);return e}addNote(e){const s=tt.getNoteAndRoute(e).note,i=window.L.marker(s.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!V.travel.readOnly});i.objId=s.objId;const r=window.L.marker(s.iconLatLng,{zIndexOffset:xs.zl,icon:window.L.divIcon({iconSize:[s.iconWidth,s.iconHeight],iconAnchor:[s.iconWidth/2,s.iconHeight/2],popupAnchor:[0,-s.iconHeight/2],html:s.iconContent,className:"TravelNotes-Map-AllNotes "}),draggable:!V.travel.readOnly});r.objId=s.objId,r.bindPopup((t=>L.clone(Ft.getNoteTextHTML("TravelNotes-Map-",tt.getNoteAndRoute(t.objId))))),0!==s.tooltipContent.length&&(r.bindTooltip((t=>tt.getNoteAndRoute(t.objId).note.tooltipContent)),r.getTooltip().options.offset[0]=s.iconWidth/2);const o=window.L.polyline([s.latLng,s.iconLatLng],t.note.polyline);o.objId=s.objId;const a=window.L.layerGroup([r,o,i]);return a.markerId=window.L.Util.stamp(r),a.polylineId=window.L.Util.stamp(o),a.bulletId=window.L.Util.stamp(i),this.addToMap(s.objId,a),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),new Ds(r,o,i)}zoomTo(e,s){if(s){let t=[];s.forEach((e=>t=t.concat(e))),V.map.fitBounds(Y.getLatLngBounds(t))}else V.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){const s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);this.Fl&&V.map.removeLayer(this.Fl),V.map.addLayer(s),this.Fl=s,V.travel.readOnly||(V.map.getZoom()<(t.minZoom||xs.Vl)&&V.map.setZoom(t.minZoom||xs.Vl),V.map.setMinZoom(t.minZoom||xs.Vl),V.map.getZoom()>(t.maxZoom||xs.Wl)&&V.map.setZoom(t.maxZoom||xs.Wl),V.map.setMaxZoom(t.maxZoom||xs.Wl),t.bounds?(V.map.getBounds().intersects(t.bounds)&&!V.map.getBounds().contains(t.bounds)||(V.map.setMaxBounds(null),V.map.fitBounds(t.bounds),V.map.setZoom(t.minZoom||xs.Vl)),V.map.setMaxBounds(t.bounds)):V.map.setMaxBounds(null)),V.map.fire("baselayerchange",s)}onGeolocationStatusChanged(t){o.active!==t&&this.Kl&&(V.map.removeLayer(this.Kl),this.Kl=null)}onGeolocationPositionChanged(e){let s=t.geoLocation.zoomToPosition;this.Kl&&(V.map.removeLayer(this.Kl),s=!1);let i="Position (+/- "+e.coords.accuracy.toFixed(0)+" m) : <br/>"+k.formatLatLngDMS([e.coords.latitude,e.coords.longitude])+"<br/>"+k.formatLatLng([e.coords.latitude,e.coords.longitude])+"<br/>";e.coords.altitude&&(i+="<br/> Altitude (+/- "+e.coords.altitudeAccuracy.toFixed(0)+" m) :<br/>"+e.coords.altitude.toFixed(0)+" m"),0===t.geoLocation.marker.radius?this.Kl=window.L.circle(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).setRadius(e.coords.accuracy.toFixed(0)):this.Kl=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker),this.Kl.bindTooltip(i).bindPopup(i).addTo(V.map),this.Kl.openPopup(),s&&V.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class Es{static marker=null;static initialLatLng=null}class Ps{static handleEvent(){Es.marker&&(window.L.DomEvent.off(Es.marker),V.map.removeLayer(Es.marker),Es.marker=null)}}class Cs{static handleEvent(){window.L.DomEvent.off(Es.marker,"mouseout",Ps.handleEvent)}}class Ls{static handleEvent(t){V.mapObjects.get(V.travel.editedRoute.objId).openPopup(t.latlng)}}class Ss{static handleEvent(t){t.latlng.lat=Es.initialLatLng[0],t.latlng.lng=Es.initialLatLng[1],t.target.objId=V.travel.editedRoute.objId,new ys(t).show()}}class ks{static handleEvent(t){Ts.addWayPointOnRoute(Es.initialLatLng,[t.target.getLatLng().lat,t.target.getLatLng().lng]),Es.marker&&(window.L.DomEvent.off(Es.marker,"dragstart",Cs.handleEvent),window.L.DomEvent.off(Es.marker,"dragend",ks.handleEvent),window.L.DomEvent.off(Es.marker,"contextmenu",Ss.handleEvent),V.map.removeLayer(Es.marker),Es.marker=null)}}class As{static Gl=1;static handleEvent(e){const s=tt.getRoute(e.target.objId);if(c.notEdited!==s.editionStatus)if(Es.initialLatLng=[e.latlng.lat,e.latlng.lng],Es.marker)Es.marker.setLatLng(e.latlng);else{Es.marker=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:'<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>',className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});let i="";(w===t.route.showDragTooltip||As.Gl<=t.route.showDragTooltip)&&(As.Gl++,i=S.getText("EditedRouteMouseOverEL - Drag and drop to add a waypoint")+" - "),i+=s.computedName+" - ";let r=Y.getClosestLatLngDistance(s,[e.latlng.lat,e.latlng.lng]).distance;r+=s.chainedDistance,i+=k.formatDistance(r),Es.marker.bindTooltip(i),Es.marker.getTooltip().options.offset=[0,0],Es.marker.addTo(V.map),window.L.DomEvent.on(Es.marker,"mouseout",Ps.handleEvent),window.L.DomEvent.on(Es.marker,"dragstart",Cs.handleEvent),window.L.DomEvent.on(Es.marker,"dragend",ks.handleEvent),window.L.DomEvent.on(Es.marker,"contextmenu",Ss.handleEvent),window.L.DomEvent.on(Es.marker,"click",Ls.handleEvent)}}}class Rs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId),s=e.note,i=e.route,r=V.mapObjects.get(t.target.objId);if(null===i)s.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],Bt.dispatch("updatetravelnotes");else{const e=Y.getClosestLatLngDistance(i,[t.target.getLatLng().lat,t.target.getLatLng().lng]);s.latLng=e.latLng,s.distance=e.distance,i.notes.sort(((t,e)=>t.distance-e.distance)),r.getLayer(r.bulletId).setLatLng(e.latLng),Bt.dispatch("updateitinerary")}r.getLayer(r.polylineId).setLatLngs([s.latLng,s.iconLatLng]),Bt.dispatch("roadbookupdate")}}class Os{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],e.iconLatLng])}}class Bs{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}}class js{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}}class Hs extends Qt{ae;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getNoteAndRoute(this.eventData.targetObjId).route)}get menuItems(){return[new qt(S.getText("NoteContextMenu - Edit this note"),!0,(()=>He.editNote(this.eventData.targetObjId))),new qt(S.getText("NoteContextMenu - Delete this note"),!0,(()=>He.removeNote(this.eventData.targetObjId))),new qt(S.getText("NoteContextMenu - Zoom to note"),!0,(()=>(new $e).zoomToNote(this.eventData.targetObjId))),new qt(S.getText(this.ae?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),m===V.editedRouteObjId,(()=>{this.ae?He.detachNoteFromRoute(this.eventData.targetObjId):He.attachNoteToRoute(this.eventData.targetObjId)}))]}}class Us{static handleEvent(t){new Hs(t).show()}}class Fs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note;e.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];const s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,e.iconLatLng])}}class Ks{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,[t.latlng.lat,t.latlng.lng]])}}class Ws extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(S.getText("WayPointContextMenu - Delete this waypoint"),V.travel.editedRoute.wayPoints.first.objId!==this.eventData.targetObjId&&V.travel.editedRoute.wayPoints.last.objId!==this.eventData.targetObjId,(()=>Ts.removeWayPoint(this.eventData.targetObjId))),new qt(S.getText("WayPointContextMenu - Modify properties"),!0,(()=>Ts.wayPointProperties(this.eventData.targetObjId)))]}}class Vs{static handleEvent(t){new Ws(t).show()}}class zs{static handleEvent(t){Ts.wayPointDragEnd(t)}}class Gs extends xs{static get Zl(){return.01}Xl(t){const e=V.mapObjects.get(t);e&&(window.L.DomEvent.off(e),V.map.removeLayer(e),V.mapObjects.delete(t))}constructor(){super()}updateRoute(t,e){if(m!==t){const e=tt.getRoute(t);this.Xl(e.objId);const s=e.notes.iterator;for(;!s.done;)this.Xl(s.value.objId);const i=e.wayPoints.iterator;for(;!i.done;)this.Xl(i.value.objId)}if(m!==e){const t=this.addRoute(e),s=V.mapObjects.get(e);if(!V.travel.readOnly){window.L.DomEvent.on(s,"contextmenu",Ms.handleEvent),window.L.DomEvent.on(s,"mouseover",As.handleEvent);const e=t.notes.iterator;for(;!e.done;){const t=V.mapObjects.get(e.value.objId),s=t.getLayer(t.markerId),i=t.getLayer(t.bulletId);window.L.DomEvent.on(i,"dragend",Rs.handleEvent),window.L.DomEvent.on(i,"drag",Os.handleEvent),window.L.DomEvent.on(i,"mouseenter",Bs.handleEvent),window.L.DomEvent.on(i,"mouseleave",js.handleEvent),window.L.DomEvent.on(s,"contextmenu",Us.handleEvent),window.L.DomEvent.on(s,"dragend",Fs.handleEvent),window.L.DomEvent.on(s,"drag",Ks.handleEvent)}}if(!V.travel.readOnly&&c.notEdited!==t.editionStatus){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)this.addWayPoint(t.value,t.first?"A":t.last?"B":t.index)}}}updateRouteProperties(t){const e=V.mapObjects.get(t),s=tt.getRoute(t);e.setStyle({color:s.color,weight:s.width,dashArray:s.dashString})}updateNote(t,e){let s=!1;if(m!==t){const e=V.mapObjects.get(t);e&&(s=e.getLayer(e.markerId).isPopupOpen()),this.Xl(t)}if(m!==e){const t=this.addNote(e);s&&t.marker.openPopup(),V.travel.readOnly||(window.L.DomEvent.on(t.bullet,"dragend",Rs.handleEvent),window.L.DomEvent.on(t.bullet,"drag",Os.handleEvent),window.L.DomEvent.on(t.bullet,"mouseenter",Bs.handleEvent),window.L.DomEvent.on(t.bullet,"mouseleave",js.handleEvent),window.L.DomEvent.on(t.marker,"contextmenu",Us.handleEvent),window.L.DomEvent.on(t.marker,"dragend",Fs.handleEvent),window.L.DomEvent.on(t.marker,"drag",Ks.handleEvent))}}removeObject(t){this.Xl(t)}removeAllObjects(){V.mapObjects.forEach((t=>{window.L.DomEvent.off(t),V.map.removeLayer(t)})),V.mapObjects.clear()}addWayPoint(t,e){if(h.defaultValue===t.lat&&h.defaultValue===t.lng)return;const s='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===e?"Start":"B"===e?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+e+"</div>",i=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:s,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});i.bindTooltip((t=>tt.getWayPoint(t.objId).fullName)),i.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(i,"contextmenu",Vs.handleEvent),i.objId=t.objId,this.addToMap(t.objId,i),window.L.DomEvent.on(i,"dragend",zs.handleEvent)}addItineraryPointMarker(e,s){this.addToMap(e,window.L.circleMarker(s,t.itineraryPoint.marker))}addSearchPointMarker(e,s,i){let r=!1;if(i){let t=[];i.forEach((e=>{t=t.concat(e)}));const e=Y.getLatLngBounds(t),s=V.map.getBounds();r=(e.getEast()-e.getWest())/(s.getEast()-s.getWest())>Gs.Zl&&(e.getNorth()-e.getSouth())/(s.getNorth()-s.getSouth())>Gs.Zl}r?this.addToMap(e,window.L.polyline(i,t.osmSearch.searchPointPolyline)):this.addToMap(e,window.L.circleMarker(s,t.osmSearch.searchPointMarker))}addRectangle(t,e,s){this.addToMap(t,window.L.rectangle(e,s))}setLayer(t){const e=jt.getUrl(t);e&&super.setLayer(t,e)}}const Zs=new Gs;class Xs{Jl;Yt;Yl;static get ql(){return 1}$l(t,e){if(this.Jl)return void t();const s=window.indexedDB.open("TravelNotesDb",Xs.ql);s.onerror=()=>{this.Jl=null,e(new Error("Not possible to open the db"))},s.onsuccess=e=>{this.Jl=e.target.result,t()},s.onupgradeneeded=t=>{this.Jl=t.target.result,this.Jl.createObjectStore("Travels",{keyPath:"UUID"})}}Ql(t,e){if(!this.Jl)return void e(new Error("Database not opened"));const s=this.Jl.transaction(["Travels"],"readonly");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").get(this.Yt).onsuccess=e=>t(e.target.result?e.target.result.data:null)}tc(t,e){if(!this.Jl)return void e(new Error("Database not opened"));const s=this.Jl.transaction(["Travels"],"readwrite");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").put({UUID:this.Yt,data:this.Yl}).onsuccess=()=>t()}ec(){this.Jl.close(),this.Jl=null}constructor(){}getOpenPromise(){return new Promise(((t,e)=>this.$l(t,e)))}getReadPromise(t){return this.Yt=t,new Promise(((t,e)=>this.Ql(t,e)))}getWritePromise(t,e){return this.Yt=t,this.Yl=e,new Promise(((t,e)=>this.tc(t,e)))}closeDb(t){if(!this.Jl)return;if(!t)return void this.ec();const e=this.Jl.transaction(["Travels"],"readwrite");e.onerror=()=>{};const s=e.objectStore("Travels").delete(t);s.onerror=()=>this.ec(),s.onsuccess=()=>this.ec()}}const Js=new Xs;const Ys=new class{sc(e){const s=et.create("div",{className:e+"Travel-Header"});L.sanitizeToHtmlElement(V.travel.name,et.create("div",{className:e+"Travel-Header-Name"},s));let r=i.defaultValue,o=0,a=0;const n=V.travel.routes.iterator;for(;!n.done;){const i=n.value.objId===V.editedRouteObjId&&t.routeEditor.showEditedRouteInRoadbook?V.travel.editedRoute:n.value;L.sanitizeToHtmlElement('<a href="#route'+i.objId+'" >'+i.computedName+"</a> : "+k.formatDistance(i.distance)+".",et.create("div",{className:e+"Travel-Header-RouteName"},s)),i.chain&&(r+=i.distance,o+=i.itinerary.ascent,a+=i.itinerary.descent)}return L.sanitizeToHtmlElement("<span>"+S.getText("TravelHTMLViewsFactory - Travel distance")+"</span> : "+k.formatDistance(r),et.create("div",{className:e+"Travel-Header-TravelDistance"},s)),0!==o&&L.sanitizeToHtmlElement("<span>"+S.getText("travelHTMLViewsFactory - Travel ascent")+"</span> : "+String(o.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelAscent"},s)),0!==a&&L.sanitizeToHtmlElement("<span>"+S.getText("TravelHTMLViewsFactory - Travel descent")+"</span> : "+String(a.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelDescent"},s)),s}ic(t){const e=S.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 '+new Date(Date.now()).getFullYear()+'</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+S.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",s=et.create("div",{className:t+"TravelFooter"});return L.sanitizeToHtmlElement(e,s),s}constructor(){}getTravelHTML(e){const s=et.create("div",{className:e+"Travel"});s.appendChild(this.sc(e)),s.appendChild(Ft.getTravelNotesHTML(e));const i=V.travel.routes.iterator;for(;!i.done;){const r=t.routeEditor.showEditedRouteInRoadbook&&i.value.objId===V.editedRouteObjId?V.travel.editedRoute:i.value;s.appendChild(Kt.getRouteHeaderHTML(e,r)),r.itinerary.hasProfile&&s.appendChild(Kt.getRouteProfileHTML(e,r)),s.appendChild(Kt.getRouteManeuversAndNotesHTML(e,r,!1)),s.appendChild(Kt.getRouteFooterHTML(e,r))}return s.appendChild(this.ic(e)),s}};class qs{rc;oc;ac;nc;hc;static get lc(){return 3e5}cc(){this.rc&&(this.rc.textContent=this.oc+" "+this.ac+" - Zoom : "+this.nc)}constructor(){this.oc=u.saved,this.ac="",this.nc="",this.hc=null}set saveStatus(t){u.modified===t&&u.notSaved===this.oc||(this.oc=t,u.modified!==t||this.hc?u.saved===t&&this.hc&&(clearTimeout(this.hc),this.hc=null):this.hc=setTimeout((()=>this.oc=u.notSaved),qs.lc),this.cc())}createUI(){this.rc=et.create("span",null,et.create("div",{id:"TravelNotes-MouseUI"},document.body)),this.nc=V.map.getZoom(),this.ac=k.formatLat(t.map.center.lat)+" - "+k.formatLng(t.map.center.lng),V.map.on("mousemove",(t=>{this.ac=k.formatLatLng([t.latlng.lat,t.latlng.lng]),this.cc()})),V.map.on("zoomend",(()=>{this.nc=String(V.map.getZoom()),this.cc()}))}}const $s=new qs;class Qs{static get uc(){return.5}static get vc(){return 5}static get dc(){return 10}static get _c(){return 31}static get mc(){return 32}static get gc(){return 63}wc(t){return Math.floor(Math.abs(t)+Qs.uc)*(0<=t?1:-1)}Nc(t,e,s){const i=this.wc(t*s),r=this.wc(e*s);let o=i-r;o<<=1,0>i-r&&(o=~o);let a="";for(;Qs.mc<=o;)a+=String.fromCharCode((Qs.mc|o&Qs._c)+Qs.gc),o>>=Qs.vc;return a+=String.fromCharCode(o+Qs.gc),a}u;Tc(t){let e=null,s=0,i=0;do{e=t.charCodeAt(this.u++)-Qs.gc,i|=(e&Qs._c)<<s,s+=Qs.vc}while(Qs.mc<=e);return 1&i?~(i>>1):i>>1}constructor(){}encode(t,e){if(!t.length)return"";const s=e.length,i=Array.from(e,(t=>Math.pow(Qs.dc,t)));let r="";for(let e=0;e<s;e++)r+=this.Nc(t[0][e],0,i[e]);for(let e=1;e<t.length;e++){const o=t[e],a=t[e-1];for(let t=0;t<s;t++)r+=this.Nc(o[t],a[t],i[t])}return r}decode(t,e){const s=e.length;if(!t||0===t.length)return[];this.u=0;const i=[],r=Array.from(e,(t=>Math.pow(Qs.dc,t))),o=new Array(s).fill(0);for(;this.u<t.length;){const e=new Array(s).fill(0);for(let i=0;i<s;i++)o[i]+=this.Tc(t),e[i]=o[i]/r[i];i.push(e)}return i}}class ti{fc(t){const e={values:"",objType:(new B).objType.jsonObject},s=[];t.itinerary.itineraryPoints.forEach((t=>{s.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),e.values=(new Qs).encode(s,[h.fixed,h.fixed,2,2,0]),t.itinerary.itineraryPoints=e}bc(t){const e=[];if(t.itinerary.itineraryPoints.values)(new Qs).decode(t.itinerary.itineraryPoints.values,[h.fixed,h.fixed,2,2,0]).forEach((s=>{const o={lat:h.defaultValue,lng:h.defaultValue,distance:i.defaultValue,elev:r.defaultValue,objId:m};[o.lat,o.lng,o.distance,o.elev,o.objId]=s,o.objType=t.itinerary.itineraryPoints.objType,e.push(o)}));else{t.itinerary.itineraryPoints.latLngs=(new Qs).decode(t.itinerary.itineraryPoints.latLngs,[h.fixed,h.fixed]);let s=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{const o={};o.lat=i[0],o.lng=i[1],o.distance=t.itinerary.itineraryPoints.distances[s],t.itinerary.itineraryPoints.elevs?o.elev=t.itinerary.itineraryPoints.elevs[s]:o.elev=r.defaultValue,o.objId=t.itinerary.itineraryPoints.objIds[s],o.objType=t.itinerary.itineraryPoints.objType,e.push(o),s++}))}t.itinerary.itineraryPoints=e}constructor(){}decompress(t){t.routes.forEach(this.bc),t.editedRoute&&this.bc(t.editedRoute)}compress(t){const e=t.jsonObject;return e.routes.forEach((t=>this.fc(t))),this.fc(e.editedRoute),e}}class ei{yc;Ic;Mc;constructor(t,e,s){this.yc=t,this.Ic=e,this.Mc=s}get removeTravelNotes(){return this.yc}get removeRoutesNotes(){return this.Ic}get removeManeuvers(){return this.Mc}}class si extends mt{Dc;xc;Ec;Pc;Cc;Lc;Sc(t){const e=et.create("div",null),s=et.create("input",{type:"checkbox",checked:!1},e);return et.create("text",{value:t},e),[e,s]}constructor(t){super(t),[this.Pc,this.Dc]=this.Sc(S.getText("SaveAsDialog - Remove Travel Notes")),[this.Cc,this.xc]=this.Sc(S.getText("SaveAsDialog - Remove Routes Notes")),[this.Lc,this.Ec]=this.Sc(S.getText("SaveAsDialog - Remove Maneuvers"))}onOk(){super.onOk(new ei(this.Dc.checked,this.xc.checked,this.Ec.checked))}get contentHTMLElements(){return[this.Pc,this.Cc,this.Lc]}get title(){return S.getText("SaveAsDialog - SaveAs")}}const ii=new class{kc(t){const e=new K;e.jsonObject=V.travel.jsonObject,e.name+="-partial";let s=e.routes.iterator;for(;!s.done;)s.value.hidden=!1;if(t.removeTravelNotes&&e.notes.removeAll(),t.removeRoutesNotes)for(s=e.routes.iterator;!s.done;)s.value.notes.removeAll();if(t.removeManeuvers)for(s=e.routes.iterator;!s.done;)s.value.itinerary.maneuvers.removeAll();const i=(new ti).compress(e);k.saveFile(i.name+".trv",JSON.stringify(i),"application/json")}constructor(){}routeDropped(t,e,s){const i=t===V.travel.editedRoute.objId?V.editedRouteObjId:t,r=e===V.travel.editedRoute.objId?V.editedRouteObjId:e;V.travel.routes.moveTo(i,r,s),gs.chainRoutes(),Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate")}saveAsTravel(){""!==V.travel.name?m===V.editedRouteObjId?(new si).show().then((t=>{this.kc(t)})).catch((t=>{t instanceof Error&&console.error(t)})):Rt.showError(S.getText("TravelEditor - Not possible to partial save when a route is edited.")):Rt.showError(S.getText("TravelEditor - Gives a name to the travel"))}saveTravel(){if(""===V.travel.name)return void Rt.showError(S.getText("TravelEditor - Gives a name to the travel"));const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden=!1;const e=(new ti).compress(V.travel);k.saveFile(e.name+".trv",JSON.stringify(e),"application/json"),$s.saveStatus=u.saved}newTravel(){t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(S.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(as.deleteAllProfiles(),Bt.dispatch("removeallobjects"),V.editedRouteObjId=m,V.travel.jsonObject=(new K).jsonObject,Bt.dispatch("setrouteslist"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate"),Bt.dispatch("travelnameupdated"),t.travelEditor.startupRouteEdition&&gs.editRoute(V.travel.routes.first.objId),$s.saveStatus=u.saved)}};class ri{Ac;$t;ae;Rc;Oc(t){let e=new B;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)if("ele"===s[t].nodeName)e.elev=Number.parseFloat(s[t].textContent),0!==e.elev&&(this.ae.itinerary.hasProfile=!0);this.ae.itinerary.itineraryPoints.add(e)}Bc(t){const e=t.childNodes;for(let t=0;t<e.length;t++)if("trkpt"===e[t].nodeName)this.Oc(e[t])}jc(){let t=0,e=0,s=this.ae.itinerary.itineraryPoints.iterator;for(s.done;!s.done;){let i=s.value.elev-s.previous.elev;0>i?e-=i:t+=i}this.ae.itinerary.ascent=t,this.ae.itinerary.descent=e}Hc(t){this.ae=new F;const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"trkseg":this.Bc(e[t])}this.ae.itinerary.hasProfile&&this.jc(),this.$t.routes.add(this.ae)}Uc(t){let e=Number.MAX_VALUE,s=m;return this.ae.itinerary.itineraryPoints.forEach((i=>{const r=q.pointsDistance(t,i.latLng);r<e&&(e=r,s=i.objId)})),s}Fc(t){const e=new j;e.iconName="kUndefined";const s=Number.parseFloat(t.getAttributeNS(null,"lat")),i=Number.parseFloat(t.getAttributeNS(null,"lon"));e.itineraryPointObjId=this.Uc([s,i]);const r=t.childNodes;for(let t=0;t<r.length;t++)if("desc"===r[t].nodeName)e.instruction=r[t].textContent;this.ae.itinerary.maneuvers.add(e)}Kc(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"rtept":this.Fc(e[t])}}Wc(t){const e=new U;e.latLng=t.latLng,e.iconLatLng=t.latLng;const s=t.name.split("+");e.iconContent='<div class="TravelNotes-MapNote TravelNotes-MapNoteCategory-0073"><svg viewBox="0 0 20 20"><text x="10" y="14">'+s[0]+"</text></svg></div>",e.tooltipContent=S.getText("GpxParser - Network node")+s[0],s[1]&&(e.tooltipContent+=S.getText("GpxParser - Go to network node")+s[1]),e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,this.ae.notes.add(e)}Vc(t){let e=new O;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)if("name"===s[t].nodeName)e.name=s[t].textContent;this.ae.wayPoints.add(e),this.Rc&&this.Wc(e)}zc(t){for(let e=0;e<t.length;e++)this.Vc(t[e])}Gc(){this.$t.routes.forEach((t=>{t.wayPoints.remove(t.wayPoints.first.objId),t.wayPoints.remove(t.wayPoints.last.objId);const e=new O;e.latLng=t.itinerary.itineraryPoints.first.latLng,t.wayPoints.add(e);const s=new O;s.latLng=t.itinerary.itineraryPoints.last.latLng,t.wayPoints.add(s)}))}Cl(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;e.done;let r=s.done;for(r||(s.value.distance=i.defaultValue,r=s.done),t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,r||(s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(r=s.done,s.value.distance=i.defaultValue),r=s.done))}constructor(){}parse(t){this.Ac=(new DOMParser).parseFromString(t,"text/xml"),this.Rc=Boolean(this.Ac.querySelector("gpx").getAttributeNS(null,"creator").match(/fietsnet|knooppuntnet/g)),this.$t=new K,this.$t.routes.remove(this.$t.routes.first.objId);const e=this.Ac.querySelectorAll("trk");for(let t=0;t<e.length;t++)this.Hc(e[t]);const s=this.Ac.querySelectorAll("rte");1===s.length&&1===this.$t.routes.length&&this.Kc(s[0]),this.$t.routes.forEach((t=>this.Cl(t)));const i=this.Ac.querySelectorAll("wpt");return 0<i.length&&1===this.$t.routes.length?(this.ae.wayPoints.remove(this.ae.wayPoints.first.objId),this.ae.wayPoints.remove(this.ae.wayPoints.last.objId),this.zc(i)):this.Gc(),this.$t}}const oi=new class{Qs=null;constructor(){}createUI(){this.Qs=et.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){const e='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.Qs.firstChild;)this.Qs.removeChild(this.Qs.firstChild);L.sanitizeToHtmlElement(e,this.Qs)}};class ai{constructor(){}handleEvent(t){const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.backgroundColor,t.target.style["background-color"]=e.toolbarButtonData.color}}class ni{constructor(){}handleEvent(t){t.stopPropagation();const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.color,t.target.style["background-color"]=e.toolbarButtonData.backgroundColor}}class hi{constructor(){}handleEvent(t){t.stopPropagation();const e=vs.getMapLayer(t.target.dataset.tanMapLayerName);Bt.dispatch("layerchange",{layer:e}),oi.attributions=e.attribution,V.travel.layerName=e.name}}class li{Zc;Xc;Jc;Yc;constructor(t,e){this.Zc=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button",title:t.name,dataset:{MapLayerName:t.name},textContent:t.toolbarButtonData.text,style:"color:"+t.toolbarButtonData.color+";background-color:"+t.toolbarButtonData.backgroundColor},e),this.Xc=new ai,this.Jc=new ni,this.Yc=new hi,this.Zc.addEventListener("mouseenter",this.Xc,!1),this.Zc.addEventListener("mouseleave",this.Jc,!1),this.Zc.addEventListener("click",this.Yc,!1)}destructor(){this.Zc.removeEventListener("mouseenter",this.Xc,!1),this.Zc.removeEventListener("mouseleave",this.Jc,!1),this.Zc.removeEventListener("click",this.Yc,!1)}get height(){return this.Zc.clientHeight}}class ci{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Enter"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Leave")}}class ui{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Leave"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Enter")}}class vi{qc;$c;Qc;constructor(t,e){this.Qc=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-LinkButton TravelNotes-MapLayersToolbarUI-LinkButton-Leave"},e),et.create("a",t,this.Qc),this.qc=new ci,this.$c=new ui,this.Qc.addEventListener("mouseenter",this.qc,!1),this.Qc.addEventListener("mouseleave",this.$c,!1)}destructor(){this.Qc.removeEventListener("mouseenter",this.qc,!1),this.Qc.removeEventListener("mouseleave",this.$c,!1)}get height(){return this.Qc.clientHeight}}class di{constructor(){}marginTop=0;buttonHeight=0;buttonsHeight=0;buttonTop=0}class pi{tu;static get eu(){return 3}constructor(t){this.tu=t}handleEvent(t){t.stopPropagation(),t.deltaY&&(this.tu.marginTop-=t.deltaY*g[t.deltaMode],this.tu.marginTop=this.tu.marginTop>this.tu.buttonTop?this.tu.buttonTop:this.tu.marginTop,this.tu.marginTop=this.tu.marginTop<this.tu.buttonTop-this.tu.buttonsHeight+pi.eu*this.tu.buttonHeight?this.tu.buttonTop-this.tu.buttonsHeight+pi.eu*this.tu.buttonHeight:this.tu.marginTop,t.currentTarget.style.marginTop=String(this.tu.marginTop)+"px")}}const _i=new class{Qs;su;iu;tu;ei;ru;vs(){if(this.ei)return clearTimeout(this.ei),void(this.ei=null);if(this.su=et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Buttons"},this.Qs),this.tu.buttonTop=this.Qs.clientHeight,this.tu.buttonsHeight=0,vs.forEach((t=>{if(t.providerKeyNeeded&&jt.hasKey(t.providerName.toLowerCase())||!t.providerKeyNeeded){const e=new li(t,this.su);this.tu.buttonHeight=e.height,this.tu.buttonsHeight+=e.height,this.iu.push(e)}})),t.layersToolbarUI?.theDevil?.addButton){const t=new vi({href:"https://www.google.com/maps/@"+V.map.getCenter().lat+","+V.map.getCenter().lng+","+V.map.getZoom()+"z",title:"Reminder! The devil will know everything about you",textContent:"👿",target:"_blank"},this.su);this.tu.buttonsHeight+=t.height,this.iu.push(t)}this.tu.buttonTop+=this.tu.buttonHeight,this.tu.marginTop=this.tu.buttonTop,this.su.style.marginTop=String(this.tu.marginTop)+"px",this.su.addEventListener("wheel",this.ru,{passive:!0})}oi(){this.iu.forEach((t=>t.destructor())),this.iu.length=0,this.su.removeEventListener("wheel",this.ru,{passive:!0}),this.Qs.removeChild(this.su),this.ei=null}ou(){this.ei=setTimeout((()=>this.oi()),t.layersToolbarUI.toolbarTimeOut)}constructor(){this.tu=new di,this.ru=new pi(this.tu),this.iu=[]}createUI(){this.Qs=et.create("div",{id:"TravelNotes-MapLayersToolbarUI"},document.body),et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Header",textContent:S.getText("MapLayersToolbarUI - Layers")},this.Qs),this.Qs.addEventListener("mouseenter",(()=>this.vs()),!1),this.Qs.addEventListener("mouseleave",(()=>this.ou()),!1),Bt.dispatch("layerchange",{layer:vs.defaultMapLayer}),oi.attributions=vs.defaultMapLayer.attribution}setMapLayer(t){const e=vs.getMapLayer(t);Bt.dispatch("layerchange",{layer:e}),oi.attributions=e.attribution,V.travel.layerName=e.name}};class mi{au(){Bt.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const t=V.travel.routes.iterator;for(;!t.done;)c.notEdited===t.value.editionStatus&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId});m!==V.editedRouteObjId&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const e=V.travel.notes.iterator;for(;!e.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.value.objId});if((new $e).zoomToTravel(),_i.setMapLayer(V.travel.layerName),m!==V.editedRouteObjId){const t=V.travel.editedRoute.itinerary.provider;if(""===t||V.providers.get(t.toLowerCase())){Bt.dispatch("setprovider",{provider:t});const e=V.travel.editedRoute.itinerary.transitMode;""!==e&&Bt.dispatch("settransitmode",{transitMode:e})}else Rt.showError(S.getText("FileLoader - Not possible to select as provider",{provider:t}))}gs.chainRoutes(),Bt.dispatch("setrouteslist"),Bt.dispatch("travelnameupdated"),Bt.dispatch("showitinerary"),Bt.dispatch("roadbookupdate")}constructor(){}openLocalGpxFile(t){as.deleteAllProfiles(),V.travel.jsonObject=(new ri).parse(t).jsonObject,V.editedRouteObjId=m,this.au(),$s.saveStatus=u.saved}openLocalTrvFile(t){as.deleteAllProfiles();const e=JSON.parse(t);(new ti).decompress(e),V.travel.jsonObject=e,V.editedRouteObjId=m,V.travel.routes.forEach((t=>{c.notEdited!==t.editionStatus&&(V.editedRouteObjId=t.objId)})),this.au(),$s.saveStatus=u.saved}nu(t){const e=t.routes.iterator;for(;!e.done;)V.travel.routes.add(e.value);const s=t.notes.iterator;for(;!s.done;)V.travel.notes.add(s.value);this.au(),$s.saveStatus=u.modified}mergeLocalGpxFile(t){this.nu((new ri).parse(t))}mergeLocalTrvFile(t){const e=JSON.parse(t);(new ti).decompress(e);const s=new K;s.jsonObject=e,this.nu(s)}}class gi{constructor(){}handleEvent(t){t.stopPropagation(),ii.saveAsTravel()}}class wi{constructor(){}handleEvent(t){t.stopPropagation(),ii.newTravel(),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name)}}class Ni{constructor(){}handleEvent(t){t.stopPropagation(),ii.saveTravel()}}class Ti{constructor(){}handleEvent(t){t.stopPropagation();const e=t.target.files[0].name.split(".").pop().toLowerCase(),s=new FileReader;s.onload=()=>{try{switch(e){case"trv":(new mi).openLocalTrvFile(s.result);break;case"gpx":(new mi).openLocalGpxFile(s.result)}}catch(t){t instanceof Error&&(console.error(t),Rt.showError("An error occurs when reading the file : "+t.message))}},s.readAsText(t.target.files[0])}}class fi{constructor(){}handleEvent(e){e.stopPropagation(),t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(S.getText("OpenButtonClickEL - This page ask to close; data are perhaps not saved."))||k.openFile(new Ti,".trv,.gpx")}}class bi{constructor(){}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{switch(t.target.files[0].name.split(".").pop().toLowerCase()){case"trv":(new mi).mergeLocalTrvFile(e.result);break;case"gpx":(new mi).mergeLocalGpxFile(e.result)}}catch(t){t instanceof Error&&(console.error(t),Rt.showError("An error occurs when reading the file : "+t.message))}},e.readAsText(t.target.files[0])}}class yi{constructor(){}handleEvent(t){t.stopPropagation(),m===V.editedRouteObjId?k.openFile(new bi,".trv,.gpx"):Rt.showError(S.getText("TravelToolbarUI - Not possible to merge a travel when a route is edited"))}}class Ii{hu;lu(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-TravelUI-SaveAsButton",title:S.getText("TravelToolbarUI - Save as travel"),textContent:"💾"},this.hu).addEventListener("click",new gi,!1)}cu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Cancel travel"),textContent:"❌"},this.hu).addEventListener("click",new wi,!1)}uu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Save travel"),textContent:"💾"},this.hu).addEventListener("click",new Ni,!1)}vu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Open travel"),textContent:"📂"},this.hu).addEventListener("click",new fi,!1)}du(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Import travel"),textContent:"🌏"},this.hu).addEventListener("click",new yi,!1)}pu(){et.create("text",{value:"📋"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+t.travelNotes.language+"&page="+V.UUID,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Open travel roadbook")},this.hu)))}constructor(t){this.hu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.lu(),this.cu(),this.uu(),this.vu(),this.du(),this.pu()}}class Mi{constructor(){}handleEvent(t){t.preventDefault()}}class Di{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class xi{constructor(){}handleEvent(t){t.preventDefault();const e=t.target,s=e.getBoundingClientRect();ii.routeDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class Ei{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Pi{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new ys(t,t.target.parentNode).show()}}class Ci{_u;mu;gu;wu;constructor(t){this._u=et.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},t),this._u.addEventListener("dragover",new Mi),this._u.addEventListener("wheel",new Ei,{passive:!0}),this.mu=new Pi,this.gu=new xi,this.wu=new Di}toogleExpand(){return this._u.classList.toggle("TravelNotes-Hidden"),this._u.classList.contains("TravelNotes-Hidden")}setRoutesList(){for(;this._u.firstChild;)this._u.firstChild.removeEventListener("dragstart",this.wu),this._u.firstChild.removeEventListener("drop",this.gu),this._u.firstChild.removeEventListener("contextmenu",this.mu),this._u.removeChild(this._u.firstChild);const t=V.travel.routes.iterator;for(;!t.done;){const e=t.value.objId===V.editedRouteObjId?V.travel.editedRoute:t.value,s=(t.value.objId===V.editedRouteObjId?"🔴 ":"")+(e.chain?"⛓ ":"")+(t.value.objId===V.editedRouteObjId?V.travel.editedRoute.computedName:e.computedName),i=et.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(t.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),dataset:{ObjId:e.objId},textContent:s},this._u);i.addEventListener("dragstart",this.wu),i.addEventListener("drop",this.gu),i.addEventListener("contextmenu",this.mu)}}}class Li{constructor(){}handleEvent(t){t.stopPropagation(),V.travel.name=L.sanitizeToJsString(t.target.value),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),Bt.dispatch("roadbookupdate")}}class Si{Nu=null;constructor(t){this.Nu=t}handleEvent(t){t.stopPropagation();const e=this.Nu.toogleExpand();t.target.textContent=e?"▶":"▼",t.target.title=e?S.getText("TravelUI - Show"):S.getText("TravelUI - Hide")}}class ki{constructor(){}handleEvent(t){t.stopPropagation(),gs.addRoute()}}class Ai{Tu;fu;Nu;bu;yu(t){const e=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t);et.create("span",{textContent:S.getText("TravelUI - Travel")},e),this.fu=et.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:V.travel.name},e),this.fu.addEventListener("change",new Li,!1)}Iu(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:S.getText("TravelUI - Add a route"),textContent:"+"},this.Tu).addEventListener("click",new ki,!1)}Mu(t){this.Tu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.bu=et.create("div",{textContent:"▼",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},this.Tu),et.create("span",{textContent:S.getText("TravelUI - Travel routes")},this.Tu),this.Iu(this.Tu)}constructor(t){this.yu(t),new Ii(t),this.Mu(t),this.Nu=new Ci(t),this.bu.addEventListener("click",new Si(this.Nu),!1)}setTravelName(){this.fu.value=V.travel.name}get routesListUI(){return this.Nu}}class Ri{Du=null;constructor(t){this.Du=t}handleEvent(t){this.Du.showPane(t.target.dataset.tanPaneId)}}class Oi{constructor(){}handleEvent(t){t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Bi{xu;Eu;Pu;Cu;mh;Lu(){l.invalidPane!==this.xu&&this.Eu.get(this.xu).remove()}constructor(t){this.xu=l.invalidPane,this.Eu=new Map,this.mh=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Cu=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},t),this.Pu=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},t),this.Pu.addEventListener("wheel",new Oi,{passive:!0})}addPane(t){const e=new t(this.Pu,this.Cu);this.Eu.set(e.paneId,e),et.create("div",{textContent:e.buttonText,className:"TravelNotes-PanesManagerUI-PaneButton",dataset:{PaneId:e.paneId}},this.mh).addEventListener("click",new Ri(this))}showPane(t){this.Lu(),this.xu=t,this.Eu.get(this.xu).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach((t=>{t.dataset.tanPaneId===this.xu?t.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):t.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")}))}updatePane(t){t===this.xu&&this.showPane(t)}}class ji{Su;bt;Zc;static get ku(){return Object.freeze({bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625 H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /> </svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /> </g> </svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"> <path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"> <rect x="1" y="10" width="2" height="3" /> <rect x="11" y="10" width="2" height="3" /> </g> </g> </svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"> <path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2= "11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1= "16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'})}constructor(t,e){this.Su=t,this.bt=e,this.Zc=et.create("img",{src:ji.ku[e],id:"TravelNotes-ProvidersToolbarUI-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:S.getText("ProvidersToolbarUI - "+e)}),this.Zc.addEventListener("click",this),this.visible=!1}handleEvent(t){t.stopPropagation(),this.Su.transitMode=this.bt,Ns.startRouting()}get buttonHTMLElement(){return this.Zc}get transitMode(){return this.bt}set active(t){t?this.Zc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"):this.Zc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}set visible(t){t?this.Zc.classList.remove("TravelNotes-Hidden"):this.Zc.classList.add("TravelNotes-Hidden")}}class Hi{Su;ft;Zc;constructor(t,e){this.Su=t,this.ft=e,this.Zc=et.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbarUI-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:e.title||e.name}),this.Zc.addEventListener("click",this)}handleEvent(t){t.stopPropagation(),this.Su.provider=this.ft.name,Ns.startRouting()}get buttonHTMLElement(){return this.Zc}get provider(){return this.ft}set active(t){t?this.Zc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"):this.Zc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton")}}class Ui{Au;Ru;Ou;Bu;ju;Hu(){["bike","pedestrian","car","train","line","circle"].forEach((t=>{const e=new ji(this,t);this.Ru.set(t,e),this.Au.appendChild(e.buttonHTMLElement)}))}Uu(){V.providers.forEach((t=>{if(!t.providerKeyNeeded||jt.hasKey(t.name)){const e=new Hi(this,t);this.Ou.set(t.name,e),this.Au.appendChild(e.buttonHTMLElement)}}))}constructor(t){this.Ru=new Map,this.Ou=new Map,this.Au=et.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},t),this.Hu(),this.Uu(),this.provider=this.Ou.keys().next().value}set provider(t){V.routing.provider=t,this.ju&&(this.ju.active=!1),this.ju=this.Ou.get(t),this.ju.active=!0;const e=V.providers.get(t.toLowerCase());this.Ru.forEach((t=>{t.visible=w!==e.transitModes.indexOf(t.transitMode)})),this.Bu&&w!==e.transitModes.indexOf(this.Bu.transitMode)||(this.Bu=null,this.Ru.forEach((t=>{this.Bu||w===e.transitModes.indexOf(t.transitMode)?t.active=!1:(this.Bu=t,t.active=!0,V.routing.transitMode=t.transitMode)})))}set transitMode(t){V.routing.transitMode=t,this.Bu&&(this.Bu.active=!1),this.Bu=this.Ru.get(t),this.Bu.active=!0}providersAdded(){for(;this.Au.firstChild;)this.Au.removeChild(this.Au.firstChild);this.Ru.clear(),this.Ou.clear(),this.Hu(),this.Uu(),this.provider=this.Ou.keys().next().value;const t=this.Ou.keys().next().value;this.provider=t,this.transitMode=V.providers.get(t.toLowerCase()).transitModes[0]}}const Fi=new class{Fu=navigator.geolocation?o.inactive:o.disabled;Ku=null;Wu(t){Bt.dispatch("geolocationpositionchanged",{position:t})}Vu(){o.active===this.Fu&&(this.Fu=o.inactive),Bt.dispatch("geolocationstatuschanged",{status:this.Fu}),this.Ku&&(navigator.geolocation.clearWatch(this.Ku),this.Ku=null)}zu(t){1===t.code&&(this.Fu=o.refusedByUser),this.Vu()}Gu(){this.Fu=o.active,Bt.dispatch("geolocationstatuschanged",{status:this.Fu}),navigator.geolocation.getCurrentPosition((t=>this.Wu(t)),(t=>this.zu(t)),t.geoLocation.options),t.geoLocation.watch&&(this.Ku=navigator.geolocation.watchPosition((t=>this.Wu(t)),(t=>this.zu(t)),t.geoLocation.options))}constructor(){}get status(){return this.Fu}switch(){switch(this.Fu){case o.inactive:this.Gu();break;case o.active:this.Vu()}return this.Fu}};class Ki{constructor(){}handleEvent(t){t.stopPropagation(),jt.setKeysFromDialog()}}class Wi{constructor(){}handleEvent(t){t.stopPropagation(),Fi.switch()}}class Vi{constructor(){}handleEvent(t){t.stopPropagation(),t.target.textContent="📌"===t.target.textContent?"❌":"📌",Bt.dispatch("uipinned")}}class zi{Zu;hu;Xu(){et.create("text",{value:"🏠"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Home"},this.hu)))}Ju(){et.create("text",{value:"?"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://wwwouaiebe.github.io/TravelNotes/userGuides/README.html#"+t.travelNotes.language,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Help"},this.hu)))}Yu(){et.create("text",{value:"@"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:t.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},this.hu)))}qu(){t.APIKeysDialog.showButton&&et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelNotesToolbarUI - API keys"),textContent:"🔑"},this.hu).addEventListener("click",new Ki,!1)}$u(){o.disabled<Fi.status&&(this.Zu=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelNotesToolbarUI - Geo location"),textContent:"🌐"},this.hu),this.Zu.addEventListener("click",new Wi,!1))}Qu(){et.create("div",{textContent:t.travelEditor.startMinimized?"📌":"❌",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},this.hu).addEventListener("click",new Vi,!1)}constructor(t){this.hu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Xu(),this.Ju(),this.Yu(),this.qu(),this.$u(),this.Qu()}geoLocationStatusChanged(t){switch(t){case o.inactive:this.Zu.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case o.active:this.Zu.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:this.Zu&&(this.Zu.parentNode.removeChild(this.Zu),this.Zu=null)}}}class Gi{Pu;Cu;constructor(t,e){this.Pu=t,this.Cu=e}get paneData(){return this.Pu}get paneControl(){return this.Cu}remove(){}add(){}get paneId(){return l.invalidPane}get buttonText(){return""}}class Zi{tv;constructor(t){this.tv=t}handleEvent(t){t.stopPropagation(),this.tv.toggleNotes()}}class Xi{tv;constructor(t){this.tv=t}handleEvent(t){t.stopPropagation(),this.tv.toggleManeuvers()}}class Ji{ev;sv;rv;ov;av=t.itineraryPaneUI.showNotes;nv=t.itineraryPaneUI.showManeuvers;hv=null;lv=null;Cu=null;tv=null;constructor(t,e){this.Cu=t,this.tv=e,this.hv=new Zi(e),this.lv=new Xi(e)}addControl(){this.sv=et.create("div",null,this.Cu),et.create("text",{value:S.getText("ItineraryControlUI - Show notes")},this.sv),this.rv=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:this.av},this.sv),this.rv.addEventListener("click",this.hv),et.create("text",{value:S.getText("ItineraryControlUI - Show maneuvers")},this.sv),this.ov=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:this.nv},this.sv),this.ov.addEventListener("click",this.lv),this.ev=Kt.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute),this.Cu.appendChild(this.ev),this.nv||this.tv.toggleManeuvers(),this.av||this.tv.toggleNotes()}clearControl(){this.sv&&(this.ov&&(this.nv=this.ov.checked,this.ov.removeEventListener("click",this.lv),this.sv.removeChild(this.ov),this.ov=null),this.rv&&(this.av=this.rv.checked,this.rv.removeEventListener("click",this.hv),this.sv.removeChild(this.rv),this.rv=null),this.Cu.removeChild(this.sv),this.sv=null),this.ev&&(this.Cu.removeChild(this.ev),this.ev=null)}}class Yi extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(S.getText("ManeuverContextMenu - Zoom to this maneuver"),!0,(()=>(new $e).zoomToManeuver(this.eventData.targetObjId)))]}}class qi{Pu;constructor(t){this.Pu=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Yi(t,this.Pu).show()}}class $i{Pu;constructor(t){this.Pu=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Hs(t,this.Pu).show()}}class Qi{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.itinerary.itineraryPoints.getAt(V.travel.editedRoute.itinerary.maneuvers.getAt(Number.parseInt(t.target.dataset.tanObjId)).itineraryPointObjId).latLng})}}class tr{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.notes.getAt(Number.parseInt(t.target.dataset.tanObjId)).latLng})}}class er{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId)})}}class sr{Pu;cv;uv;vv;dv;pv;_v;mv(t){this.cv.childNodes.forEach((e=>{t===e.dataset.tanObjType&&e.classList.toggle("TravelNotes-Hidden")}))}constructor(t){this.Pu=t,this.uv=new qi(this.Pu),this.vv=new $i(this.Pu),this.dv=new Qi,this.pv=new tr,this._v=new er}toggleNotes(){this.mv("Note")}toggleManeuvers(){this.mv("Maneuver")}addData(){this.cv=Kt.getRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute,!0),this.cv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.addEventListener("contextmenu",this.uv),t.addEventListener("mouseenter",this.dv),t.addEventListener("mouseleave",this._v)):"Note"===t.dataset.tanObjType&&(t.addEventListener("contextmenu",this.vv),t.addEventListener("mouseenter",this.pv),t.addEventListener("mouseleave",this._v))})),this.Pu.appendChild(this.cv)}clearData(){this.cv&&(this.cv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.removeEventListener("contextmenu",this.uv),t.removeEventListener("mouseenter",this.dv),t.removeEventListener("mouseleave",this._v)):"Note"===t.dataset.tanObjType&&(t.removeEventListener("contextmenu",this.vv),t.removeEventListener("mouseenter",this.pv),t.removeEventListener("mouseleave",this._v))})),this.Pu.removeChild(this.cv)),this.cv=null}}class ir extends Gi{tv;gv;constructor(t,e){super(t,e),this.tv=new sr(this.paneData),this.gv=new Ji(this.paneControl,this.tv)}remove(){this.tv.clearData(),this.gv.clearControl()}add(){m!==V.editedRouteObjId&&(this.tv.addData(),this.gv.addControl())}get paneId(){return l.itineraryPane}get buttonText(){return S.getText("ItineraryPaneUI - Itinerary")}}class rr{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class or{constructor(){}handleEvent(t){t.preventDefault()}}class ar{constructor(){}handleEvent(t){t.preventDefault();const e=t.currentTarget,s=e.getBoundingClientRect();He.travelNoteDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class nr{Pu=null;constructor(t){this.Pu=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Hs(t,this.Pu).show()}}class hr extends Gi{wv;Nv;Tv;fv;bv;constructor(t,e){super(t,e),this.Nv=new rr,this.Tv=new or,this.fv=new ar,this.bv=new nr(t)}remove(){this.wv&&(this.wv.childNodes.forEach((t=>{t.removeEventListener("contextmenu",this.bv,!1),t.removeEventListener("dragstart",this.Nv,!1),t.removeEventListener("drop",this.fv,!1)})),this.wv.removeEventListener("dragover",this.Tv,!1),this.paneData.removeChild(this.wv)),this.wv=null}add(){this.wv=Ft.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),this.wv.addEventListener("dragover",this.Tv,!1),this.paneData.appendChild(this.wv),this.wv.childNodes.forEach((t=>{t.draggable=!0,t.addEventListener("contextmenu",this.bv,!1),t.addEventListener("dragstart",this.Nv,!1),t.addEventListener("drop",this.fv,!1),t.classList.add("TravelNotes-UI-MoveCursor")}))}get paneId(){return l.travelNotesPane}get buttonText(){return S.getText("TravelNotesPaneUI - Travel notes")}}class lr{ot="";yv=!1;Iv=[];Mv=["node","way","relation"];Dv=[];xv=!1;Ev=!1;t=m;constructor(t,e){this.ot=L.sanitizeToJsString(t),e&&(this.Ev=!0,this.yv=!0),this.t=f.nextObjId}get name(){return this.ot}get isRoot(){return this.yv}get items(){return this.Iv}get elementTypes(){return this.Mv}setElementType(t){w!==["node","way","relation"].indexOf(t)&&(this.Mv=[t])}get filterTagsArray(){return this.Dv}get isSelected(){return this.xv}set isSelected(t){this.xv=t,this.items.forEach((e=>{e.isSelected=t}))}get isExpanded(){return this.Ev}set isExpanded(t){this.Ev=t}get objId(){return this.t}}const cr=new class{Pv;Cv;Lv;Sv;kv(t){const e=t.split(";");for(;""===e[e.length-1];)e.pop();let s=0;const i=[];e.forEach((t=>{if(""!==t)if(w===t.indexOf("="))this.Lv=new lr(t),this.Cv.set(this.Lv.objId,this.Lv),this.Sv[s].push(this.Lv),this.Sv[s+1]=this.Lv.items;else{let e=t.split("=");if("element"===e[0])this.Lv.setElementType(e[1]);else{let t={};t[e[0]]="*"===e[1]?null:e[1],i.push(t)}}s++})),0!==i.length&&this.Lv.filterTagsArray.push(i)}Av(t){t.items.forEach((t=>{this.Av(t)})),t.isExpanded=!0}Rv(t){t.items.forEach((t=>{this.Rv(t)})),t.isExpanded=!1}constructor(){this.Pv=new lr("",!0),this.Cv=new Map,this.Cv.set(this.Pv.objId,this.Pv),this.Sv=[this.Pv.items]}get dictionary(){return this.Pv}parseDictionary(t){t.split(/\r\n|\r|\n/).forEach((t=>{""!==t&&this.kv(t)}))}selectItem(t,e){this.Cv.get(t).isSelected=e}unselectAll(){this.Pv.isSelected=!1}expandItem(t){let e=this.Cv.get(t);e.isExpanded=!e.isExpanded}expand(){this.Av(this.Pv)}collapse(){this.Pv.items.forEach((t=>this.Rv(t)))}};class ur{Ov;Bv;jv;static get Hv(){return 5e3}Uv(t,e){let s=!0;return e.forEach((e=>{const[i,r]=Object.entries(e)[0];s=s&&t.tags[i]&&(!r||t.tags[i]===r)})),s}Fv(t,e){this.Bv.forEach((s=>{s.filterTagsArray.forEach((i=>{this.Uv(t,i)&&(t.description=s.name,e.set(t.id,t))}))}))}Kv(){const e=[],s=new Map;this.Bv.forEach((t=>{t.filterTagsArray.forEach((e=>{const[i,r]=Object.entries(e[0])[0];let o=s.get(i);o||(o={values:new Map,elements:new Map},s.set(i,o)),o.values.set(r,r),t.elementTypes.forEach((t=>{o.elements.set(t,t)}))}))}));const i=this.Wv();this.jv=i;const r="("+i.getSouthWest().lat.toFixed(h.fixed)+","+i.getSouthWest().lng.toFixed(h.fixed)+","+i.getNorthEast().lat.toFixed(h.fixed)+","+i.getNorthEast().lng.toFixed(h.fixed)+")";return s.forEach(((s,i)=>{let o='"'+i+'"';if(1===s.values.size){const t=s.values.values().next().value;t&&(o+='="'+t+'"')}else 1<s.values.size&&(o+='~"',s.values.forEach((t=>{o+=t+"|"})),o=o.substring(0,o.length-1)+'"');if(t.overpassApi.useNwr){const t=1===s.elements.size?s.elements.values().next().value:"nwr";e.push(t+"["+o+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}else{let t=[];1===s.elements.size?t.push(s.elements.values().next().value):t=["node","way","rel"],t.forEach((t=>{e.push(t+"["+o+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}))}})),e}Vv(t){t.isSelected&&0<t.filterTagsArray.length&&this.Bv.push(t),t.items.forEach((t=>this.Vv(t)))}Wv(){const t=V.map.getCenter(),e=V.map.getBounds(),s=Y.getSquareBoundingBox([t.lat,t.lng],ur.Hv);return e.getSouthWest().lat=Math.max(e.getSouthWest().lat,s.getSouthWest().lat),e.getSouthWest().lng=Math.max(e.getSouthWest().lng,s.getSouthWest().lng),e.getNorthEast().lat=Math.min(e.getNorthEast().lat,s.getNorthEast().lat),e.getNorthEast().lng=Math.min(e.getNorthEast().lng,s.getNorthEast().lng),e}constructor(){this.Ov=!1,this.Bv=[],this.jv=null}async search(){if(this.Ov)return;this.Ov=!0,this.Bv=[],this.Vv(cr.dictionary);const t=new de({searchPlaces:!1});await t.loadData(this.Kv());const e=new Map;[t.nodes,t.ways,t.relations].forEach((t=>{t.forEach((t=>{t.tags&&this.Fv(t,e)}))})),V.searchData.length=0,Array.from(e.values()).sort(((t,e)=>t.description>e.description)).forEach((t=>V.searchData.push(t))),this.Ov=!1,Bt.dispatch("showsearch")}get searchBounds(){return this.Wv()}get previousSearchBounds(){return this.jv}}const vr=new ur;class dr{zv;Gv;Zv(){m===this.Gv?this.Gv=f.nextObjId:Bt.dispatch("removeobject",{objId:this.Gv}),Bt.dispatch("addrectangle",{objId:this.Gv,bounds:vr.searchBounds,properties:t.osmSearch.nextSearchLimit})}Xv(){const e=vr.previousSearchBounds;e&&(m===this.zv?this.zv=f.nextObjId:Bt.dispatch("removeobject",{objId:this.zv}),Bt.dispatch("addrectangle",{objId:this.zv,bounds:[[e.getSouthWest().lat,e.getSouthWest().lng],[e.getNorthEast().lat,e.getNorthEast().lng]],properties:t.osmSearch.previousSearchLimit}))}constructor(){this.zv=m,this.Gv=m}show(){V.map.on("zoom",this.Zv,this),V.map.on("move",this.Zv,this),this.Zv(),this.Xv()}hide(){V.map.off("zoom",this.Zv,this),V.map.off("move",this.Zv,this),m!==this.Gv&&(Bt.dispatch("removeobject",{objId:this.Gv}),this.Gv=m),m!==this.zv&&(Bt.dispatch("removeobject",{objId:this.zv}),this.zv=m)}}class pr{lr;ih;constructor(t,e){this.lr=t,this.ih=e}get latLng(){return this.lr}get geometry(){return this.ih}}class _r extends Qt{Jv;lr;constructor(t,e){super(t,e),this.Jv=V.searchData[Number.parseInt(t.currentTarget.dataset.tanElementIndex)],this.lr=[this.Jv.lat,this.Jv.lon]}get menuItems(){return[new qt(S.getText("OsmSearchContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>Ts.setStartPoint(this.lr))),new qt(S.getText("OsmSearchContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>Ts.addWayPoint(this.lr))),new qt(S.getText("OsmSearchContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>Ts.setEndPoint(this.lr))),new qt(S.getText("OsmSearchContextMenu - Create a route note with this result"),!0,(()=>He.newSearchRouteNote(this.Jv))),new qt(S.getText("OsmSearchContextMenu - Create a travel note with this result"),!0,(()=>He.newSearchTravelNote(this.Jv))),new qt(S.getText(He.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),!0,(()=>He.changeOsmSearchNoteDialog())),new qt(S.getText("OsmSearchContextMenu - Zoom to this result"),!0,(()=>(new $e).zoomToPoi(new pr(this.lr,this.Jv.geometry))))]}}class mr{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new _r(t,this.paneDataDiv).show()}}class gr{constructor(){}handleEvent(t){t.stopPropagation();const e=V.searchData[Number.parseInt(t.target.dataset.tanElementIndex)];Bt.dispatch("addsearchpointmarker",{objId:Number.parseInt(t.target.dataset.tanObjId),latLng:[e.lat,e.lon],geometry:e.geometry})}}class wr{constructor(){}handleEvent(t){t.stopPropagation(),Bt.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanObjId)})}}class Nr{Pu;Yv;qv;$v;Qv;td;ed;sd;rd(){let t="";t=this.Yv.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.Yv.tags.rcn_ref+"</text></svg></div>":se.preDefinedIconDataFromName(this.Yv.description)||"";const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},this.qv);L.sanitizeToHtmlElement(t,e)}od(t){t&&et.create("div",{textContent:t},this.$v)}oa(){const t=(this.Yv.tags["addr:street"]?(this.Yv.tags["addr:housenumber"]?this.Yv.tags["addr:housenumber"]+" ":"")+this.Yv.tags["addr:street"]+" ":"")+(this.Yv.tags["addr:city"]?(this.Yv.tags["addr:postcode"]?this.Yv.tags["addr:postcode"]+" ":"")+this.Yv.tags["addr:city"]:"");""!==t&&this.od(t,this.$v)}ad(){this.Yv.tags.phone&&this.od("☎️ : "+this.Yv.tags.phone,this.$v)}nd(){this.Yv.tags.email&&et.create("a",{href:"mailto:"+this.Yv.tags.email,textContent:this.Yv.tags.email},et.create("div",{textContent:"📧 : "},this.$v))}hd(){this.Yv.tags.website&&et.create("a",{href:this.Yv.tags.website,target:"_blank",textContent:this.Yv.tags.website},et.create("div",null,this.$v))}ld(){this.$v=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},this.qv),this.od(this.Yv.description),this.od(this.Yv.tags.name),this.od(this.Yv.tags.rcn_ref),this.oa(),this.ad(),this.nd(),this.hd()}ud(){for(const[t,e]of Object.entries(this.Yv.tags))this.qv.title+=t+"="+e+"\n"}Fr(){this.qv.addEventListener("contextmenu",this.td,!1),this.qv.addEventListener("mouseenter",this.ed,!1),this.qv.addEventListener("mouseleave",this.sd,!1)}vd(t){this.qv=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",dataset:{ObjId:f.nextObjId,ElementIndex:this.Qv++}},t),this.rd(),this.ld(),this.ud(),this.Fr()}constructor(t){this.Pu=t,this.td=new mr,this.ed=new gr,this.sd=new wr,this.Qv=0}addData(){this.Yv=null,this.qv=null,this.$v=null,this.Qv=0,V.searchData.forEach((t=>{this.Yv=t,this.vd(this.Pu)}))}clearData(){for(;this.Pu.firstChild;)this.Pu.firstChild.removeEventListener("contextmenu",this.td,!1),this.Pu.firstChild.removeEventListener("mouseenter",this.ed,!1),this.Pu.firstChild.removeEventListener("mouseleave",this.sd,!1),Bt.dispatch("removeobject",{objId:Number.parseInt(this.Pu.firstChild.dataset.tanObjId)}),this.Pu.removeChild(this.Pu.firstChild)}}class Tr{dd;pd;constructor(t,e){this.dd=t,this.pd=e}handleEvent(t){t.stopPropagation(),cr.dictionary.isExpanded=!1,this.dd.redraw(),V.searchData.length=0,Bt.dispatch("showsearch"),this.pd.showWait(),vr.search()}}class fr{dd;constructor(t){this.dd=t}handleEvent(t){t.stopPropagation(),cr.expand(),this.dd.redraw()}}class br{dd;constructor(t){this.dd=t}handleEvent(t){t.stopPropagation(),cr.collapse(),this.dd.redraw()}}class yr{dd;constructor(t){this.dd=t}handleEvent(t){t.stopPropagation(),cr.unselectAll(),this.dd.redraw()}}class Ir{Au;constructor(t,e){this.Au=et.create("div"),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Search OpenStreetMap"),textContent:"🔎"},this.Au).addEventListener("click",new Tr(t,e),!1),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Expand tree"),textContent:"▼"},this.Au).addEventListener("click",new fr(t),!1),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Collapse tree"),textContent:"▶"},this.Au).addEventListener("click",new br(t),!1),et.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Clear tree"),textContent:"❌"},this.Au).addEventListener("click",new yr(t),!1)}get toolbarHTMLElement(){return this.Au}}class Mr{dd=null;constructor(t){this.dd=t}handleEvent(t){t.stopPropagation(),cr.selectItem(Number.parseInt(t.target.parentNode.dataset.tanObjId),t.target.checked),this.dd.redraw()}}class Dr{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class xr{dd=null;constructor(t){this.dd=t}handleEvent(t){t.stopPropagation(),cr.expandItem(Number.parseInt(t.target.parentNode.dataset.tanObjId)),this.dd.redraw()}}class Er{_d;md;gd;wd;Nd(t){this.wd++;const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+this.wd,dataset:{ObjId:t.objId}},this._d);if(!t.isRoot){et.create("input",{type:"checkbox",checked:t.isSelected},e).addEventListener("change",this.gd,!1)}if(0===t.filterTagsArray.length){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:t.isExpanded?"▼":"▶"},e).addEventListener("click",this.md,!1)}et.create("text",{value:t.name},e),t.isExpanded&&t.items.forEach((t=>this.Nd(t))),this.wd--}constructor(){this.wd=0,this._d=et.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"}),this._d.addEventListener("wheel",new Dr,{passive:!0}),this.gd=new Mr(this),this.md=new xr(this),this.Nd(cr.dictionary)}redraw(){this._d.textContent="",this.Nd(cr.dictionary)}get treeHTMLElement(){return this._d}}class Pr{ke;constructor(){this.ke=et.create("div",{className:"TravelNotes-WaitAnimation"}),et.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.ke),this.ke.classList.add("TravelNotes-Hidden")}showWait(){this.ke.classList.remove("TravelNotes-Hidden")}hideWait(){this.ke.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.ke}}class Cr{dd;Td;pd;Cu;constructor(t){this.Cu=t,this.dd=new Er,this.pd=new Pr,this.Td=new Ir(this.dd,this.pd)}addControl(){this.Cu.appendChild(this.Td.toolbarHTMLElement),this.Cu.appendChild(this.dd.treeHTMLElement),this.Cu.appendChild(this.pd.waitHTMLElement)}clearControl(){this.Cu.removeChild(this.dd.treeHTMLElement),this.Cu.removeChild(this.Td.toolbarHTMLElement),this.pd.hideWait(),this.Cu.removeChild(this.pd.waitHTMLElement)}}class Lr extends Gi{fd;bd;yd;constructor(t,e){super(t,e),this.fd=new Nr(this.paneData),this.bd=new Cr(this.paneControl),this.yd=new dr}remove(){this.yd.hide(),this.fd.clearData(),this.bd.clearControl()}add(){this.yd.show(),this.bd.addControl(),this.fd.addData()}get paneId(){return l.searchPane}get buttonText(){return S.getText("OsmSearchPaneUI - Search")}}const Sr=new class{Qs;Id;Md;Dd;xd;Su;ei;Ed;ou(){this.Ed||(this.ei=setTimeout((()=>this.oi()),t.travelEditor.timeout))}vs(){if(this.Ed)return;this.ei&&(clearTimeout(this.ei),this.ei=null),this.Qs.classList.remove("TravelNotes-UI-Minimized"),this.Id.classList.add("TravelNotes-Hidden");const t=this.Qs.childNodes;for(let e=1;e<t.length;e++)t[e].classList.remove("TravelNotes-Hidden")}oi(){if(this.Ed)return;this.Qs.classList.add("TravelNotes-UI-Minimized"),this.Id.classList.remove("TravelNotes-Hidden");const t=this.Qs.childNodes;for(let e=1;e<t.length;e++)t[e].classList.add("TravelNotes-Hidden")}constructor(){this.Ed=!1}pin(){this.Ed=!this.Ed}createUI(e){this.Qs||(this.Qs=et.create("div",{id:"TravelNotes-UI-MainDiv"},e),this.Id=et.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"Travel & Notes"},this.Qs),this.Md=new zi(this.Qs),this.Dd=new Ai(this.Qs),this.xd=new Bi(this.Qs),this.xd.addPane(ir),this.xd.addPane(hr),this.xd.addPane(Lr),this.xd.showPane(l.itineraryPane),this.Su=new Ui(this.Qs),this.Qs.addEventListener("mouseenter",(()=>this.vs()),!1),this.Qs.addEventListener("mouseleave",(()=>this.ou()),!1),t.travelEditor.startMinimized?(this.oi(),this.Ed=!1):(this.vs(),this.Ed=!0))}get travelNotesToolbarUI(){return this.Md}get travelUI(){return this.Dd}get panesManagerUI(){return this.xd}get providersToolbarUI(){return this.Su}};class kr{constructor(){}openDistantFile(t){(new ti).decompress(t),V.travel.jsonObject=t,V.travel.readOnly=!0,document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const e=V.travel.routes.iterator;for(;!e.done;)c.notEdited===e.value.editionStatus?Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:e.value.objId}):V.editedRouteObjId=e.value.objId;m!==V.editedRouteObjId&&Bt.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const s=V.travel.notes.iterator;for(;!s.done;)Bt.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:s.value.objId});(new $e).zoomToTravel()}}class Ar extends mt{Pd=null;constructor(){super(),this.Pd=et.create("div",{id:"TravelNotes-AboutDialog-AboutDiv"}),L.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2022 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank">https://github.com/wwwouaiebe/TravelNotes</a></p><p>Version : v3.6.0.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.Pd)}get contentHTMLElements(){return[this.Pd]}get title(){return S.getText("AboutDialog - About Travel & Notes")}}class Rr extends Qt{constructor(t,e){super(t,e)}get menuItems(){return[new qt(S.getText("MapContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>Ts.setStartPoint(this.eventData.latLng))),new qt(S.getText("MapContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>Ts.addWayPoint(this.eventData.latLng))),new qt(S.getText("MapContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>Ts.setEndPoint(this.eventData.latLng))),new qt(S.getText("MapContextMenu - Select this point as start and end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>Ts.setStartAndEndPoint(this.eventData.latLng))),new qt(S.getText("MapContextMenu - Add a route"),!0,(()=>gs.addRoute())),new qt(S.getText("MapContextMenu - Hide all routes"),!0,(()=>gs.hideRoutes())),new qt(S.getText("MapContextMenu - Show all routes"),!0,(()=>gs.showRoutes())),new qt(S.getText("MapContextMenu - New travel note"),!0,(()=>He.newTravelNote(this.eventData.latLng))),new qt(S.getText("MapContextMenu - Hide all notes"),!0,(()=>He.hideNotes())),new qt(S.getText("MapContextMenu - Show all notes"),!0,(()=>He.showNotes())),new qt(S.getText("MapContextMenu - Zoom to travel"),!0,(()=>(new $e).zoomToTravel())),new qt(S.getText("MapContextMenu - About Travel & Notes"),!0,(()=>(new Ar).show().catch((()=>{}))))]}}const Or=new class{Cd=!1;async Ld(t){const e=await fetch(t);_===e.status&&e.ok?(new kr).openDistantFile(await e.json()):(V.map.setView([h.defaultValue,h.defaultValue],2),document.title="Travel & Notes")}constructor(){}addReadOnlyMap(t){this.Cd||(this.Cd=!0,oi.createUI(),_i.setMapLayer("OSM - Color"),this.Ld(t))}addControl(){this.Cd||(this.Cd=!0,document.title="Travel & Notes",V.map.on("contextmenu",(t=>new Rr(t).show())),V.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),Sr.createUI(et.create("div",{id:"TravelNotes-UI"},document.body)),oi.createUI(),t.layersToolbarUI.haveLayersToolbarUI?_i.createUI():_i.setMapLayer("OSM - Color"),t.mouseUI.haveMouseUI&&($s.createUI(),$s.saveStatus=u.saved),Rt.showHelp("<p>"+S.getText("Help - Continue with interface1")+"</p><p>"+S.getText("Help - Continue with interface2")+"</p>"),jt.setKeysFromServerFile(),V.travel.jsonObject=(new K).jsonObject,t.travelEditor.startupRouteEdition&&gs.editRoute(V.travel.routes.first.objId),Bt.dispatch("setrouteslist"),Bt.dispatch("roadbookupdate"))}addProvider(t){jt.addProvider(t)}showInfo(t){Rt.showInfo(t)}get overpassApiUrl(){return t.overpassApi.url}get map(){return V.map}get version(){return y}};class Br{Sd(t,e){if("object"==typeof t&&"object"==typeof e){for(const s in e)"object"==typeof e[s]?this.Sd(t[s],e[s]):typeof t[s]==typeof e[s]&&("string"==typeof e[s]?e[s]="color"===s?L.sanitizeToColor(t[s])||e[s]:"url"===s?L.sanitizeToUrl(t[s]).url:L.sanitizeToJsString(t[s]):e[s]=t[s]||e[s]);for(const s in t)"object"==typeof t[s]?("[object Array]"===Object.prototype.toString.call(t[s])?e[s]=e[s]||[]:e[s]=e[s]||{},this.Sd(t[s],e[s])):"string"==typeof e.property?e[s]=L.sanitizeToHtmlString(t[s],[]).htmlString:e[s]=t[s]}}kd(t){for(const e in t)"object"==typeof t[e]&&this.kd(t[e]);Object.freeze(t)}constructor(){}overload(e){this.Sd(e,t),this.kd(t)}}class jr{Ad;constructor(){this.Ad=k.storageAvailable("localStorage")}handleEvent(){$s.saveStatus=u.modified,this.Ad&&Js.getOpenPromise().then((()=>{Js.getWritePromise(V.UUID,Ys.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(V.UUID,Date.now()))).catch((t=>{t instanceof Error&&console.error(t)}))}}(new class{Rd;Od;Bd;jd;Hd(){document.addEventListener("routeupdated",(t=>{t.data&&Zs.updateRoute(t.data.removedRouteObjId,t.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(t=>{t.data&&Zs.updateRouteProperties(t.data.routeObjId)}),!1),document.addEventListener("noteupdated",(t=>{t.data&&Zs.updateNote(t.data.removedNoteObjId,t.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(t=>{t.data&&Zs.removeObject(t.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>Zs.removeAllObjects()),!1),document.addEventListener("zoomto",(t=>{t.data&&Zs.zoomTo(t.data.latLng,t.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(t=>{t.data&&Zs.addItineraryPointMarker(t.data.objId,t.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(t=>{t.data&&Zs.addSearchPointMarker(t.data.objId,t.data.latLng,t.data.geometry)}),!1),document.addEventListener("addrectangle",(t=>{t.data&&Zs.addRectangle(t.data.objId,t.data.bounds,t.data.properties)}),!1),document.addEventListener("addwaypoint",(t=>{t.data&&Zs.addWayPoint(t.data.wayPoint,t.data.letter)}),!1),document.addEventListener("layerchange",(t=>{t.data&&Zs.setLayer(t.data.layer)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&Zs.onGeolocationPositionChanged(t.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&Zs.onGeolocationStatusChanged(t.data.status)}),!1),document.addEventListener("roadbookupdate",new jr,!1),document.addEventListener("profileclosed",(t=>{t.data&&as.onProfileClosed(t.data.objId)}),!1),document.addEventListener("uipinned",(()=>Sr.pin()),!1),document.addEventListener("geolocationstatuschanged",(t=>{Sr.travelNotesToolbarUI.geoLocationStatusChanged(t.data.status)}),!1),document.addEventListener("travelnameupdated",(()=>Sr.travelUI.setTravelName()),!1),document.addEventListener("setrouteslist",(()=>Sr.travelUI.routesListUI.setRoutesList()),!1),document.addEventListener("showitinerary",(()=>{t.paneUI.switchToItinerary?Sr.panesManagerUI.showPane(l.itineraryPane):Sr.panesManagerUI.updatePane(l.itineraryPane)}),!1),document.addEventListener("updateitinerary",(()=>Sr.panesManagerUI.updatePane(l.itineraryPane)),!1),document.addEventListener("showtravelnotes",(()=>{t.paneUI.switchToTravelNotes?Sr.panesManagerUI.showPane(l.travelNotesPane):Sr.panesManagerUI.updatePane(l.travelNotesPane)}),!1),document.addEventListener("updatetravelnotes",(()=>Sr.panesManagerUI.updatePane(l.travelNotesPane)),!1),document.addEventListener("showsearch",(()=>{t.paneUI.switchToSearch?Sr.panesManagerUI.showPane(l.searchPane):Sr.panesManagerUI.updatePane(l.searchPane)}),!1),document.addEventListener("updatesearch",(()=>Sr.panesManagerUI.updatePane(l.searchPane)),!1),document.addEventListener("providersadded",(()=>Sr.providersToolbarUI.providersAdded()),!1),document.addEventListener("setprovider",(t=>{t?.data?.provider&&(Sr.providersToolbarUI.provider=t.data.provider)}),!1),document.addEventListener("settransitmode",(t=>{t?.data?.transitMode&&(Sr.providersToolbarUI.transitMode=t.data.transitMode)}),!1)}Ud(){window.addEventListener("unload",(()=>localStorage.removeItem(V.UUID))),window.addEventListener("beforeunload",(e=>{if(Js.closeDb(V.UUID),t.travelNotes.haveBeforeUnloadWarning)return e.returnValue="x","x"}))}Fd(){const t=new URL(window.location);let e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");const s=new URL(e);if(!(t.protocol&&s.protocol&&t.protocol===s.protocol&&t.hostname&&s.hostname&&t.hostname===s.hostname))throw new Error("The distant file is not on the same site than the app");this.Rd=encodeURI(s.href)}catch(t){t instanceof Error&&console.error(t)}const s=t.searchParams.get("lng");s&&s.match(/^[A-Z,a-z]{2}$/)&&(this.Od=s.toLowerCase())}async Kd(){const e=await fetch(this.Bd+"Config.json");if(_===e.status&&e.ok){const s=await e.json();return s.travelNotes.language=this.Od||s.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(s.APIKeysDialog.haveUnsecureButtons=!0,s.errorsUI.showHelp=!0,s.layersToolbarUI.theDevil.addButton=!1,s.note.maxManeuversNotes=120,s.note.haveBackground=!0,s.noteDialog.theDevil.addButton=!1,s.printRouteMap.maxTiles=10,s.route.showDragTooltip=w),(new Br).overload(s),V.providers.forEach((e=>{e.userLanguage=t.travelNotes.language})),!0}return!1}async Wd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(S.setTranslations(await t.value.json()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(S.setTranslations(await e.value.json()),this.jd+="Not possible to load the TravelNotes"+this.Od.toUpperCase()+".json file. English will be used. ",!0):(this.jd+="Not possible to load the translations. ",!1)}async Vd(t,e){if("fulfilled"===t.status&&_===t.value.status&&t.value.ok){const e=await t.value.json();return se.loadJson(e),!0}if("fulfilled"===e.status&&_===e.value.status&&e.value.ok){const t=await e.value.json();return se.loadJson(t),this.jd+="Not possible to load the TravelNotesNoteDialog"+this.Od.toUpperCase()+".json file. English will be used. ",!0}return this.jd+="Not possible to load the translations for the note dialog. ",!1}async zd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(cr.parseDictionary(await t.value.text()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(cr.parseDictionary(await e.value.text()),this.jd+="Not possible to load the TravelNotesSearchDictionary"+this.Od.toUpperCase()+".csv file. English will be used. ",!0):(this.jd+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async Gd(t){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(vs.addMapLayers(await t.value.json()),!0):(this.jd+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async Zd(){const t=await Promise.allSettled([fetch(this.Bd+this.Od.toUpperCase()+".json"),fetch(this.Bd+"EN.json"),fetch(this.Bd+"NoteDialog"+this.Od.toUpperCase()+".json"),fetch(this.Bd+"NoteDialogEN.json"),fetch(this.Bd+"SearchDictionary"+this.Od.toUpperCase()+".csv"),fetch(this.Bd+"SearchDictionaryEN.csv"),fetch(this.Bd+"Layers.json")]),e=await this.Wd(t[0],t[1])&&await this.Vd(t[2],t[3])&&await this.zd(t[4],t[5])&&await this.Gd(t[6]);return""!==this.jd&&e?Rt.showError(this.jd):""!==this.jd&&(document.body.textContent=this.jd),e}Xd(){const t=document.createElement("div");t.id="TravelNotes-Map",document.body.appendChild(t),V.map=window.L.map(t.id,{attributionControl:!1,zoomControl:!1}).setView([h.defaultValue,h.defaultValue],0),this.Rd?Or.addReadOnlyMap(this.Rd):(this.Ud(),Or.addControl("TravelNotes-UI"))}constructor(){this.Bd=window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",this.jd=""}async loadApp(){this.Hd(),window.TaN=Or,this.Fd(),await this.Kd()?(this.Od=this.Od||t.travelNotes.language||"fr",Rt.createUI(),await this.Zd()&&this.Xd()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();