/**
 * 
 * @source: https://github.com/wwwouaiebe/TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * travelnotes - version 4.0.0-beta
 * Build 01910 - 2022-09-07T12:07:09+0200 
 * Copyright 2017 2022 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";const t={ApiKeys:{saveToSessionStorage:!0},ApiKeysDialog:{haveUnsecureButtons:!0,showApiKeys:!1,showButton:!0},baseDialog:{cancelTouchX:100,cancelTouchY:150,deltaZoomDistance:75},contextMenu:{timeout:1500},dockableBaseDialog:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!1,showInfo:!0,showWarning:!0,timeOut:1e4},fontSize:{initialValue:3.5,incrementValue:.5},FullScreenUI:{timeOut:5e3,screenMaxWidth:1200},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:0},options:{enableHighAccuracy:!0,maximumAge:0,timeout:36e5},watch:!0,zoomFactor:17,zoomToPosition:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},mapContextMenu:{mouseMaxRouteDistance:10,touchMaxRouteDistance:10},mapLayersToolbar:{theDevil:{addButton:!0}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:6,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},theDevil:{addButton:!0,zoomFactor:17}},osmSearchDialog:{dialogX:50,dialogY:0},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{firefoxBrowser:!0,isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,printNotes:!0,borderWidth:10,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashIndex:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:2.5,smoothPoints:3},showDragTooltip:0,width:5},routeEditor:{showEditedRouteInRoadbook:!0},toolbars:{timeOut:1500},travelNotes:{haveBeforeUnloadWarning:!0,language:"fr",startupRouteEdition:!0},TravelNotesToolbar:{contactMail:{url:"https://github.com/wwwouaiebe/TravelNotes/issues"}},travelNotesDialog:{dialogX:250,dialogY:0},travelPropertiesDialog:{dialogX:50,dialogY:0},wayPoint:{reverseGeocoding:!0,geocodingIncludeName:!0}};class e{static get d0(){return 0}static get d90(){return 90}static get d180(){return 180}static get d270(){return 270}static get d360(){return 360}static get d540(){return 540}static get toRadians(){return Math.PI/180}static get fromRadians(){return 180/Math.PI}}class o{static get fixed(){return 2}static get invalid(){return-1}static get defaultValue(){return 0}static get metersInKm(){return 1e3}}class s{static get fixed(){return 2}static get defaultValue(){return 0}}class i{static get refusedByUser(){return-1}static get disabled(){return 0}static get inactive(){return 1}static get active(){return 2}}class n{static get width(){return 40}static get height(){return 40}static get svgViewboxDim(){return 200}}class r{static get atStart(){return-1}static get onRoute(){return 0}static get atEnd(){return 1}}class a{static get defaultValue(){return 0}static get fixed(){return 6}static get maxLat(){return 90}static get minLat(){return-90}static get maxLng(){return 180}static get minLng(){return-180}}class l{static get notEdited(){return 0}static get editedNoChange(){return 1}static get editedChanged(){return 2}}class d{static get notSaved(){return"🔴"}static get modified(){return"🟡"}static get saved(){return"🟢"}}class c{static get topLeft(){return"TravelNotes-BaseToolbar-TopLeft"}static get topRight(){return"TravelNotes-BaseToolbar-TopRight"}static get bottomLeft(){return"TravelNotes-BaseToolbar-BottomLeft"}static get bottomRight(){return"TravelNotes-BaseToolbar-BottomRight"}}const h=40,u=6371e3,m=16,g=200,p=-1,v=[.3,10,1],T=-1,L="http://www.w3.org/2000/svg",E=20;class b{static#t=0;static get nextObjId(){return++b.#t}}const y="2.4.0",w="v4.0.0-beta";class f{#e="";#o=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];#s=[];constructor(t,e){if(Object.freeze(this),T===this.#o.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.#e=t,this.#s=e,Object.freeze(this.#s)}get name(){return this.#e}get version(){return y}get properties(){return this.#s}get jsonObject(){return{name:this.#e,version:y}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.#e);if(this.#e!==t.name)throw new Error("Invalid name for "+this.#e);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.#e)}}class M{#i=null;#n=T;constructor(t){Object.freeze(this),this.#i=t}get value(){return this.#n<this.#i.length?this.#i.at(this.#n):null}get previous(){return 0>=this.#n?null:this.#i.at(this.#n-1)}get next(){return this.#n<this.#i.length-1?this.#i.at(this.#n+1):null}get done(){return++this.#n>=this.#i.length}get first(){return 0===this.#n}get last(){return this.#n>=this.#i.length-1}get index(){return this.#n}}class I{#r;#a;#l;#d(t){return this.#r.findIndex((e=>e.objId===t))}#c(t,e,o){let s=this.#d(t);if(T===s)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let i=e;for(i||(i=()=>!0),s+=o;T<s&&s<this.#r.length&&!i(this.#r[s]);)s+=o;return T===s||this.#r.length===s?null:this.#r[s]}constructor(t){Object.freeze(this),this.#r=[],this.#l=t;const e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.#a=e.objType.name}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.#a)throw new Error("invalid object name for add function");this.#r.push(t)}at(t){return t<this.#r.length&&t>T?this.#r[t]:null}forEach(t){let e=null;const o=this.iterator;for(;!o.done;)e=t(o.value,e);return e}getAt(t){const e=this.#d(t);return T===e?null:this.#r[e]}moveTo(t,e,o){let s=this.#d(t),i=this.#d(e);if(T===s||T===i)throw new Error("invalid objId for function  myMoveTo");o||i++,this.#r.splice(i,0,this.#r[s]),i<s&&s++,this.#r.splice(s,1)}next(t,e){return this.#c(t,e,1)}previous(t,e){return this.#c(t,e,-1)}remove(t){const e=this.#d(t);if(T===e)throw new Error("invalid objId for remove function");this.#r.splice(e,1)}removeAll(t){t?this.#r.splice(1,this.#r.length-2):this.#r.length=0}replace(t,e){const o=this.#d(t);if(T===o)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.#a)throw new Error("invalid object name for replace function");this.#r[o]=e}reverse(){this.#r.reverse()}sort(t){this.#r.sort(t)}swap(t,e){const o=this.#d(t);if(T===o||0===o&&e||this.#r.length-1===o&&!e)throw new Error("invalid objId for swap function");const s=e?-1:1,i=this.#r[o];this.#r[o]=this.#r[o+s],this.#r[o+s]=i}get first(){return this.#r[0]}get iterator(){return new M(this)}get last(){return this.#r[this.#r.length-1]}get length(){return this.#r.length}get jsonObject(){const t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.#r.length=0,Array.isArray(t)&&t.forEach((t=>{const e=new this.#l;e.jsonObject=t,this.add(e)}))}}class N{#h=new Map;constructor(){Object.freeze(this),this.#h.set("a",["href","target"]),this.#h.set("div",[]),this.#h.set("del",[]),this.#h.set("em",[]),this.#h.set("figcaption",[]),this.#h.set("figure",[]),this.#h.set("h1",[]),this.#h.set("h2",[]),this.#h.set("h3",[]),this.#h.set("h4",[]),this.#h.set("h5",[]),this.#h.set("h6",[]),this.#h.set("hr",[]),this.#h.set("img",["src","alt","width","height"]),this.#h.set("ins",[]),this.#h.set("li",[]),this.#h.set("mark",[]),this.#h.set("ol",[]),this.#h.set("p",[]),this.#h.set("s",[]),this.#h.set("small",[]),this.#h.set("strong",[]),this.#h.set("span",[]),this.#h.set("sub",[]),this.#h.set("sup",[]),this.#h.set("ul",[]),this.#h.set("svg",["xmlns","viewBox","class"]),this.#h.set("text",["x","y","text-anchor"]),this.#h.set("polyline",["points","class","transform"]),this.#h.set("#text",[])}getValidAttributesNames(t){return this.#h.get(t).concat(["id","class","dir","title"])}getValidNodeName(t){const e=t.toLowerCase();return this.#h.get(e)?e:""}}class C{#u;#m;constructor(t,e){Object.freeze(this),this.#u=t,this.#m=e}get htmlString(){return this.#u}get errorsString(){return this.#m}}class D{#g;#m;constructor(t,e){Object.freeze(this),this.#g=t,this.#m=e}get url(){return this.#g}get errorsString(){return this.#m}}class x{#p="";#v="";static#T=new N;#L(t){return t.replaceAll(/\u003c/g,"&lt;").replaceAll(/\u003e/g,"&gt;").replaceAll(/\u0022/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}#E(t,e){const o=this.sanitizeToUrl(t,e).url;""===o&&""!==t?this.#v+="\nAn invalid url ("+t+") was removed from a "+e+" attribute":this.#p+=" "+e+'="'+o+'"'}#b(t,e){x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(this.#p+=" "+e+'="'+this.#L(t.getAttributeNS(null,e))+'"',t.removeAttributeNS(null,e))}))}#y(t,e){t.hasAttribute("target")&&(this.#p+=' rel="noopener noreferrer"'),x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttribute(e)&&("href"===e||"src"===e?this.#E(t.getAttribute(e),e):this.#p+=" "+e+'="'+this.#L(t.getAttribute(e))+'"',t.removeAttribute(e))}))}#w(t){for(let e=0;e<t.attributes.length;e++)"rel"!==t.attributes[e].name&&(this.#v+="\nAn unsecure attribute "+t.attributes[e].name+'="'+t.attributes[e].value+'" was removed.')}#f(t){const e=t.childNodes;for(let o=0;o<e.length;o++){const e=t.childNodes[o],s=x.#T.getValidNodeName(e.nodeName);""===s?this.#v+="\nAn invalid tag "+e.nodeName+" was removed":"#text"===s?this.#p+=this.#L(e.nodeValue):(this.#p+="<"+s,"svg"===s||"text"===s||"polyline"===s?this.#b(e,s):this.#y(e,s),this.#p+=">",this.#f(e),this.#p+="</"+s+">",e.attributes&&this.#w(e))}}#M(t,e){const o=document.createElementNS(L,e);return x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(o.setAttributeNS(null,e,t.getAttributeNS(null,e)),t.removeAttributeNS(null,e))})),o}#I(t,e){const o=document.createElement(e);return x.#T.getValidAttributesNames(e).forEach((e=>{if(t.hasAttribute(e))if("href"===e||"src"===e){const s=this.sanitizeToUrl(t.getAttribute(e),e).url;""!==s&&o.setAttribute(e,s)}else o.setAttribute(e,t.getAttribute(e))})),t.hasAttribute("target")&&o.setAttribute("rel","noopener noreferrer"),o}#N(t,e){const o=t.childNodes;for(let s=0;s<o.length;s++){const o=t.childNodes[s],i=x.#T.getValidNodeName(o.nodeName);if("#text"===i)e.appendChild(document.createTextNode(o.nodeValue));else if(""!==i){const t="svg"===i||"text"===i||"polyline"===i?this.#M(o,i):this.#I(o,i);e.appendChild(t),this.#N(o,t)}}}constructor(){Object.freeze(this)}sanitizeToHtmlElement(t,e){const o=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html"),s=new DocumentFragment;o&&"#document"===o.nodeName?(this.#N(o.body.firstChild,s),e.appendChild(s)):e.textContent=""}clone(t){const e=document.createElement(t.tagName);return this.#N(t,e),e}sanitizeToHtmlString(t){this.#p="",this.#v="";const e=(new DOMParser).parseFromString("<div>"+t.replace("&nbsp;","਀")+"</div>","text/html");return e&&"#document"===e.nodeName?(this.#f(e.body.firstChild),new C(this.#p,this.#v)):new C("","Parsing error")}sanitizeToUrl(t,e){const o=e||"href",s=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!s||"#document"!==s.nodeName)return new D("","Parsing error");const i=s.body.firstChild;let n="";for(let t=0;t<i.childNodes.length;t++){if("#text"!==i.childNodes[t].nodeName)return new D("","Invalid characters found in the url");n+=i.childNodes[t].nodeValue}if(n=n.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),n!==t)return new D("","Invalid characters found in the url");const r=["https:"];if("http:"!==window.location.protocol&&"href"!==o||r.push("http:"),"href"===o){r.push("mailto:"),r.push("sms:"),r.push("tel:");const t=n.match(/^\u0023\w*/);if(t&&n===t[0])return new D(n,"")}"src"===o&&r.push("data:");let a=null;try{a=new URL(n)}catch(t){return new D("","Invalid url string")}if(T===r.indexOf(a.protocol))return new D("","Invalid protocol "+a.protocol);if(T!==["sms:","tel:"].indexOf(a.protocol))return a.pathname.match(/^\+[0-9,*,\u0023]*$/)?new D(n,""):new D("","Invalid sms: or tel: url");try{encodeURIComponent(a.href)}catch(t){return new D("","Invalid character in url")}return new D(n,"")}sanitizeToJsString(t){const e=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";const o=e.body.firstChild;let s="";for(let t=0;t<o.childNodes.length;t++){if("#text"!==o.childNodes[t].nodeName)return"";s+=o.childNodes[t].nodeValue}return s=s.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),s}sanitizeToColor(t){const e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}}const O=new x;const j=new class{#C=new Map;constructor(){Object.freeze(this)}setTranslations(t){t.forEach((t=>this.#C.set(t.msgid,O.sanitizeToJsString(t.msgstr))))}getText(t,e){let o=this.#C.get(t);return e&&o&&Object.getOwnPropertyNames(e).forEach((t=>o=o.replace("{"+t+"}",e[t]))),o||t}};const S=new class{constructor(){Object.freeze(this)}get UUID(){const t=["","","","-","","-","","-","","-","","","","","",""],e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let s=0;s<16;s++)o+=e[s].toString(m).padStart(2,"0")+t[s];return o}storageAvailable(t){try{const e=window[t],o="__storage_test__";return e.setItem(o,o),e.removeItem(o),!0}catch(t){return!1}}openFile(t,e){const o=document.createElement("input");o.type="file",e&&(o.accept=e),o.addEventListener("change",t,!1),o.click()}saveFile(t,e,o){try{const s=o?window.URL.createObjectURL(new File([e],t,{type:o})):URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",t),i.click(),window.URL.revokeObjectURL(s)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){const e=Math.floor(t);if(0===e)return"";const o=Math.floor(e/86400),s=Math.floor(e%86400/3600),i=Math.floor(e%3600/60),n=Math.floor(e%60);return 0<o?o+" "+j.getText("Utilities - Day")+" "+s+" "+j.getText("Utilities - Hour"):0<s?s+" "+j.getText("Utilities - Hour")+" "+i+" "+j.getText("Utilities - Minute"):0<i?i+" "+j.getText("Utilities - Minute"):n+" "+j.getText("Utilities - Second")}formatDistance(t){const e=Math.floor(t);return 0>=e?"0 km":Math.floor(e/o.metersInKm)+","+Math.floor(e%o.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}numberToDMS(t){let e=t,o=Math.floor(t);e-=o;let s=Math.floor(60*e);e-=s/60,e*=3600;let i=Math.floor(e);return e-=i,e=Math.floor(100*e),o.toString()+"° "+s.toString()+"' "+i+'" '+e}formatLatDMS(t){return t>0?this.numberToDMS(t)+" N":this.numberToDMS(-t)+" S"}formatLngDMS(t){return t>0?this.numberToDMS(t)+" E":this.numberToDMS(-t)+" W"}formatLatLngDMS(t){return 0===t[0]&&0===t[1]?"":this.formatLatDMS(t[0])+" - "+this.formatLngDMS(t[1])}formatLat(t){return t>0?t.toFixed(a.fixed)+" N":(-t).toFixed(a.fixed)+" S"}formatLng(t){return t>0?t.toFixed(a.fixed)+" E":(-t).toFixed(a.fixed)+" W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+" - "+this.formatLng(t[1])}};class H{#D;#x(){this.#D.routes.forEach((t=>{t.dashArray=0,t.hidden=!1}))}#O(){this.#D.routes.forEach((t=>{t.edited=l.notEdited}))}#j(){this.#O(),this.#D.editedRoute={name:"",wayPoints:[{name:"",lat:0,lng:0,objId:2,objType:{name:"WayPoint",version:"1.4.0"}},{name:"",lat:0,lng:0,objId:3,objType:{name:"WayPoint",version:"1.4.0"}}],notes:[],itinerary:{itineraryPoints:[],maneuvers:[],provider:"",transitMode:"",objId:1,objType:{name:"Itinerary",version:"1.4.0"}},width:3,color:"#ff0000",dashArray:0,chain:!0,distance:0,duration:0,edited:l.notEdited,hidden:!1,chainedDistance:0,objId:4,objType:{name:"Route",version:"1.4.0"}}}#S(){if(this.#D.userData.layerId){const t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===this.#D.userData.layerId));this.#D.layerName=t?t.layerName:"OSM - Color"}else this.#D.layerName="OSM - Color"}#H(t){t.forEach((t=>{t.elev=s.defaultValue}))}#P(){this.#D.routes.forEach((t=>{t.itinerary.hasProfile=!1,t.itinerary.ascent=0,t.itinerary.descent=0,this.#H(t.itinerary.itineraryPoints)})),this.#D.editedRoute.itinerary.hasProfile=!1,this.#D.editedRoute.itinerary.ascent=0,this.#D.editedRoute.itinerary.descent=0,this.#H(this.#D.editedRoute.itinerary.itineraryPoints)}#R(t){t.itinerary.maneuvers.forEach((t=>{"kArriveDefault"===t.iconName&&(t.distance=o.defaultValue)}))}#A(t){t.wayPoints.forEach((t=>{t.address=t.name,t.name=""}))}#k(){this.#D.routes.forEach((t=>{t.editionStatus=t.edited,this.#R(t),this.#A(t)})),this.#D.editedRoute.editionStatus=this.#D.editedRoute.edited,this.#R(this.#D.editedRoute),this.#A(this.#D.editedRoute)}#B(){this.#D.routes.forEach((t=>{t.dashIndex=t.dashArray})),this.#D.editedRoute.dashIndex=this.#D.editedRoute.dashArray}#F(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}#_(t){"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.#F(t.iconContent),t.popupContent=this.#F(t.popupContent),t.tooltipContent=this.#F(t.tooltipContent),t.phone=this.#F(t.phone),t.address=this.#F(t.address)}#z(){this.#D.notes.forEach((t=>{this.#_(t)})),this.jsonTravel.routes.forEach((t=>{t.notes.forEach((t=>{this.#_(t)}))}))}#K(){switch(this.#D.objType.version){case"1.0.0":this.#x();case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":this.#j();case"1.5.0":this.#S();case"1.6.0":this.#P();case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":this.#k();case"1.12.0":case"1.13.0":this.#z();case"2.0.0":case"2.1.0":case"2.2.0":case"2.3.0":this.#B(),this.#D.objType.version="2.4.0";break;default:throw new Error("invalid version for travel")}}constructor(){Object.freeze(this)}update(t){t.objType.version!==y&&(this.#D=t,this.#K())}}class P{constructor(){Object.freeze(this)}validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+this.objType.name);this.objType.validate(t.objType),"Travel"===this.objType.name&&this.objType.version!==t.objType.version&&(new H).update(t);const e=Object.getOwnPropertyNames(t);return this.objType.properties.forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+this.objType.name)})),t}}class R extends P{static#U=new f("WayPoint",["address","name","lat","lng","objId"]);#V="";#W="";#X=a.defaultValue;#Y=a.defaultValue;#t=p;constructor(){super(),this.#t=b.nextObjId}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get address(){return this.#W}set address(t){this.#W="string"==typeof t?O.sanitizeToJsString(t):""}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=S.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objId(){return this.#t}get objType(){return R.#U}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.address=e.address,this.name=e.name,this.lat=e.lat,this.lng=e.lng,this.#t=b.nextObjId}}class A extends P{static#U=new f("ItineraryPoint",["lat","lng","distance","elev","objId"]);#X=a.defaultValue;#Y=a.defaultValue;#G=o.defaultValue;#Z=s.defaultValue;#t=p;constructor(){super(),this.#t=b.nextObjId}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get elev(){return this.#Z}set elev(t){this.#Z="number"==typeof t?t:a.defaultValue}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objType(){return A.#U}get objId(){return this.#t}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),elev:parseFloat(this.elev.toFixed(s.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.elev=e.elev,this.#t=b.nextObjId}}class k extends P{static#U=new f("Maneuver",["iconName","instruction","distance","duration","itineraryPointObjId","objId"]);#J="";#q="";#$=p;#G=o.defaultValue;#Q=o.defaultValue;#t=p;constructor(){super(),this.#t=b.nextObjId}get iconName(){return this.#J}set iconName(t){this.#J="string"==typeof t?O.sanitizeToJsString(t):""}get instruction(){return this.#q}set instruction(t){this.#q="string"==typeof t?O.sanitizeToJsString(t):""}get itineraryPointObjId(){return this.#$}set itineraryPointObjId(t){this.#$="number"==typeof t?t:p}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get duration(){return this.#Q}set duration(t){this.#Q="number"==typeof t?t:o.defaultValue}get objType(){return k.#U}get objId(){return this.#t}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconName=e.iconName,this.instruction=e.instruction,this.distance=e.distance,this.duration=e.duration,this.itineraryPointObjId=e.itineraryPointObjId,this.#t=b.nextObjId}}class B extends P{static#U=new f("Itinerary",["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"]);#t=p;#tt=!1;#et=0;#ot=0;#st="";#it="";#nt=new I(A);#rt=new I(k);constructor(){super(),this.#t=b.nextObjId}get hasProfile(){return this.#tt}set hasProfile(t){this.#tt="boolean"==typeof t&&t}get ascent(){return this.#et}set ascent(t){this.#et="number"==typeof t?Number.parseInt(t):0}get descent(){return this.#ot}set descent(t){this.#ot="number"==typeof t?Number.parseInt(t):0}get provider(){return this.#st}set provider(t){this.#st="string"==typeof t?O.sanitizeToJsString(t):""}get transitMode(){return this.#it}set transitMode(t){this.#it="string"==typeof t?O.sanitizeToJsString(t):""}get itineraryPoints(){return this.#nt}get maneuvers(){return this.#rt}get objType(){return B.#U}get objId(){return this.#t}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.hasProfile=e.hasProfile,this.ascent=e.ascent,this.descent=e.descent,this.itineraryPoints.jsonObject=e.itineraryPoints,this.maneuvers.jsonObject=e.maneuvers,this.provider=e.provider,this.transitMode=e.transitMode,this.#t=b.nextObjId;const o=new Map;let s=0;const i=this.itineraryPoints.iterator;for(;!i.done;)o.set(e.itineraryPoints[s].objId,i.value.objId),s++;const n=this.maneuvers.iterator;for(;!n.done;)n.value.itineraryPointObjId=o.get(n.value.itineraryPointObjId)}}class F extends P{static#U=new f("Note",["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"]);#at=n.height;#lt=n.width;#dt="";#ct="";#ht="";#ut="";#g="";#W="";#mt=a.defaultValue;#gt=a.defaultValue;#X=a.defaultValue;#Y=a.defaultValue;#G=o.invalid;#pt=o.defaultValue;#t=p;constructor(){super(),this.#t=b.nextObjId}get iconHeight(){return this.#at}set iconHeight(t){this.#at="number"==typeof t?t:n.height}get iconWidth(){return this.#lt}set iconWidth(t){this.#lt="number"==typeof t?t:n.width}get iconContent(){return this.#dt}set iconContent(t){this.#dt="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get popupContent(){return this.#ct}set popupContent(t){this.#ct="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get tooltipContent(){return this.#ht}set tooltipContent(t){this.#ht="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get phone(){return this.#ut}set phone(t){this.#ut="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get url(){return this.#g}set url(t){this.#g="string"==typeof t?encodeURI(O.sanitizeToUrl(t).url):""}get address(){return this.#W}set address(t){this.#W="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get iconLat(){return this.#mt}set iconLat(t){this.#mt="number"==typeof t?t:a.defaultValue}get iconLng(){return this.#gt}set iconLng(t){this.#gt="number"==typeof t?t:a.defaultValue}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.invalid}get chainedDistance(){return this.#pt}set chainedDistance(t){this.#pt="number"==typeof t?t:o.defaultValue}get isRouteNote(){return this.#G!==o.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#mt=t[0],this.#gt=t[1]):(this.#mt=a.defaultValue,this.#gt=a.defaultValue)}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objType(){return F.#U}get objId(){return this.#t}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(a.fixed)),iconLng:parseFloat(this.iconLng.toFixed(a.fixed)),lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconHeight=e.iconHeight,this.iconWidth=e.iconWidth,this.iconContent=e.iconContent,this.popupContent=e.popupContent,this.tooltipContent=e.tooltipContent,this.phone=e.phone,this.url=e.url,this.address=e.address,this.iconLat=e.iconLat,this.iconLng=e.iconLng,this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.chainedDistance=e.chainedDistance,this.#t=b.nextObjId}}class _ extends P{static#U=new f("Route",["name","wayPoints","notes","itinerary","width","color","dashIndex","chain","chainedDistance","distance","duration","editionStatus","hidden","objId"]);#V="";#vt=new I(R);#Tt=new I(F);#Lt=new B;#Et=t.route.width;#bt=t.route.color;#yt=t.route.dashIndex;#wt=!0;#pt=o.defaultValue;#G=o.defaultValue;#Q=o.defaultValue;#ft=l.notEdited;#Mt=!1;#t=p;constructor(){super(),this.#vt.add(new R),this.#vt.add(new R),this.#t=b.nextObjId}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get wayPoints(){return this.#vt}get notes(){return this.#Tt}get itinerary(){return this.#Lt}get width(){return this.#Et}set width(e){this.#Et="number"==typeof e?e:t.route.width}get color(){return this.#bt}set color(e){this.#bt="string"==typeof e&&O.sanitizeToColor(e)||t.route.color}get dashIndex(){return this.#yt}set dashIndex(e){this.#yt="number"==typeof e&&t.route.dashChoices[e]?e:0}get dashString(){let e="";return t.route.dashChoices[this.#yt].iDashArray.forEach((t=>e+=String(t*this.#Et)+",")),e.substring(0,e.length-1)}get chain(){return this.#wt}set chain(t){this.#wt="boolean"==typeof t&&t}get chainedDistance(){return this.#pt}set chainedDistance(t){this.#pt="number"==typeof t?t:o.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get duration(){return this.#Q}set duration(t){this.#Q="number"==typeof t?t:o.defaultValue}get editionStatus(){return this.#ft}set editionStatus(t){this.#ft="number"==typeof t?t:l.notEdited}get hidden(){return this.#Mt}set hidden(t){this.#Mt="boolean"==typeof t&&t}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.#t}get objType(){return _.#U}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&a.defaultValue!==e.lat&&a.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashIndex:this.dashIndex,chain:this.chain,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.name=e.name,this.wayPoints.jsonObject=e.wayPoints,this.notes.jsonObject=e.notes,this.itinerary.jsonObject=e.itinerary,this.width=e.width,this.color=e.color,this.dashIndex=e.dashIndex,this.chain=e.chain,this.distance=e.distance,this.duration=e.duration,this.editionStatus=e.editionStatus,this.hidden=e.hidden,this.chainedDistance=e.chainedDistance,this.#t=b.nextObjId}}class z extends P{static#U=new f("Travel",["editedRoute","routes","notes","layerName","name","readOnly","objId"]);#It=new _;#Nt=new I(_);#Tt=new I(F);#Ct="OSM - Color";#V="";#Dt=!1;#t=p;constructor(){super(),this.#Nt.add(new _),this.#t=b.nextObjId}get editedRoute(){return this.#It}set editedRoute(t){this.#It="Route"===t?.objType?.name?t:new _}get routes(){return this.#Nt}get notes(){return this.#Tt}get layerName(){return this.#Ct}set layerName(t){this.#Ct="string"==typeof t?O.sanitizeToJsString(t):"OSM - Color"}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get readOnly(){return this.#Dt}set readOnly(t){this.#Dt="boolean"!=typeof t||t}get objId(){return this.#t}get objType(){return z.#U}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName,this.name=e.name,this.readOnly=e.readOnly,this.routes.jsonObject=e.routes,this.notes.jsonObject=e.notes,this.#t=b.nextObjId}}class K{#st="";#it="";constructor(){Object.freeze(this)}get provider(){return this.#st}set provider(t){this.#st="string"==typeof t?t:""}get transitMode(){return this.#it}set transitMode(t){this.#it="string"==typeof t?t:""}}const U=new class{#xt;#Ot;#jt;#St;#Ht;#Pt;#Rt;#At;constructor(){Object.freeze(this),this.#xt=new Map,this.#Ot=new Map,this.#jt=new K,this.#St=S.UUID,this.#Ht=null,this.#Pt=new z,this.#Rt=p,this.#At=[]}get map(){return this.#Ht}set map(t){this.#Ht||(this.#Ht=t)}get travel(){return this.#Pt}get editedRouteObjId(){return this.#Rt}set editedRouteObjId(t){this.#Rt="number"==typeof t?t:p}get searchData(){return this.#At}get providers(){return this.#xt}get mapObjects(){return this.#Ot}get routing(){return this.#jt}get UUID(){return this.#St}};class V{#kt;#Bt;constructor(t,e){Object.freeze(this),this.#kt="string"==typeof t?t:"",this.#Bt="string"==typeof e?e:""}get providerName(){return this.#kt}get providerKey(){return this.#Bt}get jsonObject(){return{providerName:this.providerName,providerKey:this.providerKey}}}const W=new class{#Ft(t,e){for(const o in e)try{if("dataset"===o){const o=e.dataset;for(const e in o)t.dataset["tan"+e]=o[e]}else t[o]=e[o]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){Object.freeze(this)}create(t,e,o){let s=null;return"text"===t.toLowerCase()?s=document.createTextNode(e.value||""):(s="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.#Ft(s,e)),o&&o.appendChild(s),s}};class X{#_t;constructor(t){Object.freeze(this),this.#_t=t}handleEvent(){this.#_t.onCancel()}}class Y{#zt;constructor(t){Object.freeze(this),this.#zt=t}handleEvent(t){this.#zt.keyboardELEnabled&&("Escape"===t.key||"Esc"===t.key?this.#zt.onCancel():"Enter"===t.key&&this.#zt.onOk())}}class G{#zt;constructor(t){Object.freeze(this),this.#zt=t}handleEvent(){this.#zt.onOk()}}class Z{constructor(){Object.freeze(this)}handleEvent(t){if(!t.target.classList.contains("TravelNotes-Background"))return;let e=U.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(U.map.getMaxZoom(),e),e=Math.max(U.map.getMinZoom(),e),U.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class J{constructor(){Object.freeze(this)}handleEvent(t){t.preventDefault()}}class q{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){t.preventDefault(),Number.parseInt(t.dataTransfer.getData("ObjId"))===this.#Kt.objId&&(t.stopPropagation(),this.#Kt.moveDialog(t))}}class ${#X;#Y;constructor(t,e){Object.freeze(this),this.#X=t,this.#Y=e}static clone(t){return new $(t.lat,t.lng)}get latLng(){return[this.#X,this.#Y]}get lat(){return this.#X}get lng(){return this.#Y}}class Q extends ${#G;constructor(t,e,o){super(t,e),this.#G=o}get distance(){return this.#G}}class tt extends Q{#Z;#et;constructor(t,e,o,s,i){super(t,e,o),this.#Z=s,this.#et=i}get elev(){return this.#Z}get ascent(){return this.#et}}class et{static get#Ut(){return 100}constructor(){Object.freeze(this)}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let o=0;const s=t.itinerary.itineraryPoints.iterator;for(;o<e&&!s.done;)o+=s.value.distance;const i=s.value;s.done;const n=(i.distance-o+e)/i.distance;return new tt(i.lat+(s.value.lat-i.lat)*n,i.lng+(s.value.lng-i.lng)*n,e,i.elev+(s.value.elev-i.elev)*n,et.#Ut*(s.value.elev-i.elev)/i.distance)}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;const s=t.itinerary.itineraryPoints.iterator;s.done;let i=Number.MAX_VALUE;const n=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1]));let r=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng)),a=null,l=o.defaultValue,d=s.value.distance;for(;!s.done;){const t=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng));let e=window.L.LineUtil.pointToSegmentDistance(n,r,t);e<i&&(i=e,a=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(n,r,t)),l=d-a.distanceTo(window.L.latLng(s.value.lat,s.value.lng))),d+=s.value.distance,r=t}return new Q(a.lat,a.lng,l)}getLatLngBounds(t){const e=window.L.latLng([a.maxLat,a.maxLng]),o=window.L.latLng([a.minLat,a.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),o.lat=Math.max(o.lat,t[0]),o.lng=Math.max(o.lng,t[1])})),window.L.latLngBounds(e,o)}getSquareBoundingBox(t,o){const s=t[0]*e.toRadians,i=o/u*e.fromRadians,n=Math.acos((Math.cos(o/u)-Math.sin(s)**2)/Math.cos(s)**2)*e.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-i,t[1]-n]),window.L.latLng([t[0]+i,t[1]+n]))}project(t,e){const o=U.map.project(window.L.latLng(t),e);return[o.x,o.y]}screenCoordToLatLng(t,e){const o=U.map.containerPointToLatLng(window.L.point(t,e));return[o.lat,o.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}}const ot=new et;class st{#_t;#Vt=!1;#Wt=!1;#Xt=0;#Yt=0;#Gt;#Zt;#Jt;#qt;#$t(e){if(this.#Vt&&(this.#Xt!==e.screenX||this.#Yt!==e.screenY)){t.baseDialog.cancelTouchY>this.#Yt&&e.screenY<this.#Yt&&t.baseDialog.cancelTouchX>this.#Xt&&this.#_t.onCancel();const o=ot.screenCoordToLatLng(this.#Xt,this.#Yt),s=ot.screenCoordToLatLng(e.screenX,e.screenY);U.map.panTo([this.#Gt.lat+o[0]-s[0],this.#Gt.lng+o[1]-s[1]])}}#Qt(e){let o=Math.sqrt((e.item(0).clientX-e.item(1).clientX)**2+(e.item(0).clientY-e.item(1).clientY)**2),s=this.#Zt,i=o-this.#Jt;t.baseDialog.deltaZoomDistance<i?s++:-t.baseDialog.deltaZoomDistance>i&&s--,s=Math.min(U.map.getMaxZoom(),s),s=Math.max(U.map.getMinZoom(),s),s!==this.#Zt&&(U.map.setZoomAround(this.#qt,s),this.#Zt=s,this.#Jt=o)}#te(t){this.#Vt&&1===t.changedTouches.length&&(this.#$t(t.changedTouches.item(0)),this.#Vt=!1)}#ee(t){this.#Vt&&1===t.changedTouches.length?this.#$t(t.changedTouches.item(0)):this.#Wt&&2===t.targetTouches.length&&this.#Qt(t.targetTouches)}#oe(t){if(1===t.targetTouches.length){const e=t.changedTouches.item(0);this.#Xt=e.screenX,this.#Yt=e.screenY,this.#Gt=U.map.getCenter(),this.#Vt=!0,this.#Wt=!1}2===t.targetTouches.length&&(this.#Zt=U.map.getZoom(),this.#qt=window.L.point((t.targetTouches.item(0).clientX+t.targetTouches.item(1).clientX)/2,(t.targetTouches.item(0).clientY+t.targetTouches.item(1).clientY)/2),this.#Jt=Math.sqrt((t.targetTouches.item(0).clientX-t.targetTouches.item(1).clientX)**2+(t.targetTouches.item(0).clientY-t.targetTouches.item(1).clientY)**2),this.#Vt=!1,this.#Wt=!0)}constructor(t){Object.freeze(this),this.#_t=t}handleEvent(t){switch(t.currentTarget===t.target&&t.preventDefault(),t.type){case"touchstart":t.currentTarget===t.target&&this.#oe(t);break;case"touchmove":this.#ee(t);break;case"touchend":this.#te(t)}}}class it{static get LEFT_BUTTON(){return 0}#Vt=!1;#Xt=0;#Yt=0;#Gt;#$t(t){const e=ot.screenCoordToLatLng(this.#Xt,this.#Yt),o=ot.screenCoordToLatLng(t.screenX,t.screenY);U.map.panTo([this.#Gt.lat+e[0]-o[0],this.#Gt.lng+e[1]-o[1]])}constructor(){Object.freeze(this)}handleEvent(t){switch(t.type){case"mousedown":t.button===it.LEFT_BUTTON&&t.target===t.currentTarget&&(this.#Xt=t.screenX,this.#Yt=t.screenY,this.#Gt=U.map.getCenter(),this.#Vt=!0);break;case"mousemove":t.button===it.LEFT_BUTTON&&this.#Vt&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.#$t(t));break;case"mouseup":t.button!==it.LEFT_BUTTON||!this.#Vt||this.#Xt===t.screenX&&this.#Yt===t.screenY||this.#$t(t),this.#Vt=!1}}}class nt{#se=null;#ie=null;#ne=null;#re=null;#ae=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.#se=t.firstButtonText;break;case"secondButtonText":this.#ie=t.secondButtonText;break;case"selectOptionsData":this.#ne=t.selectOptionsData;break;case"title":this.#re=t.title;break;case"text":this.#ae=t.text}}get firstButtonText(){return this.#se}get secondButtonText(){return this.#ie}get selectOptionsData(){return this.#ne}get title(){return this.#re}get text(){return this.#ae}}class rt{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.setDragStartPoint(t),t.dataTransfer.setData("ObjId",this.#Kt.objId)}}class at{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.moveDialog(t)}}class lt{#Kt;#le;constructor(t){Object.freeze(this),this.#Kt=t,this.#le=!1}handleEvent(t){t.stopPropagation();let e=t.type;if(1===t.changedTouches.length){const o=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#le=!0,this.#Kt.setDragStartPoint(o);break;case"touchmove":this.#le=!1,t.preventDefault(),this.#Kt.moveDialog(o,e);break;case"touchend":this.#le||this.#Kt.moveDialog(o,e)}}}}class dt{#t;#de;#ce;#he;#ue;#me(t,e){const o=this.backgroundHTMLElement.offsetWidth-this.dialogHTMLElement.offsetWidth-h,s=this.backgroundHTMLElement.offsetHeight-this.dialogHTMLElement.offsetHeight-h;this.#he=Math.max(Math.min(t,o),h),this.#ue=Math.max(Math.min(e,s),h)}#ge(){this.dialogHTMLElement.style.left=String(this.#he)+"px",this.dialogHTMLElement.style.top=String(this.#ue)+"px"}backgroundHTMLElement=null;dialogHTMLElement=null;topBarHTMLElement=null;constructor(){Object.seal(this),this.#he=h,this.#ue=h,this.#de=0,this.#ce=0,this.#t=b.nextObjId}get onTop(){return 42>this.#ue}get objId(){return this.#t}centerDialog(){this.#he=(this.backgroundHTMLElement.clientWidth-this.dialogHTMLElement.clientWidth)/2,this.#ue=(this.backgroundHTMLElement.clientHeight-this.dialogHTMLElement.clientHeight)/2,this.#ge()}moveDialog(t,e){const o=this.#he+t.screenX-this.#de,s=this.#ue+t.screenY-this.#ce;this.moveDialogTo(o,s,e),this.setDragStartPoint(t)}moveDialogTo(t,e){this.#me(t,e),this.#ge()}moveDialogToLastPosition(){this.moveDialogTo(this.#he,this.#ue)}moveDialogToTopLeft(){this.#he=h,this.#ue=h,this.#ge()}setDragStartPoint(t){this.#de=t.screenX,this.#ce=t.screenY}}class ct extends class{#pe;#ve;#Te;#Le;#Ee;#be;#ye;#we;#fe;#Me=null;#Ie(){this.#pe=W.create("div",{className:"TravelNotes-BaseDialog-DialogHTMLElement"}),this.mover.dialogHTMLElement=this.#pe}#Ne(){this.#ve=W.create("div",{className:"TravelNotes-BaseDialog-TopBarHTMLElement",draggable:!0},this.#pe),this.#we=new lt(this.mover),this.#ve.addEventListener("touchstart",this.#we,!1),this.#ve.addEventListener("touchmove",this.#we,!1),this.#ve.addEventListener("touchend",this.#we,!1),this.#ve.addEventListener("touchcancel",this.#we,!1),this.#be=new rt(this.mover),this.#ve.addEventListener("dragstart",this.#be,!1),this.#ye=new at(this.mover),this.#ve.addEventListener("dragend",this.#ye,!1),this.#Te=W.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:j.getText("BaseDialog - Cancel")},this.#ve),W.create("div",{textContent:this.title,className:"TravelNotes-BaseDialog-Title"},this.#ve),this.#fe=new X(this),this.#Te.addEventListener("click",this.#fe,!1),this.mover.topBarHTMLElement=this.#ve}#Ce(){this.toolbarHTMLElement&&W.create("div",{className:"TravelNotes-BaseDialog-ToolbarHTMLElement"},this.#pe).appendChild(this.toolbarHTMLElement)}#De(){this.#Le=W.create("div",{className:"TravelNotes-BaseDialog-ContentHTMLElement"},this.#pe),this.contentHTMLElements.forEach((t=>this.#Le.appendChild(t)))}#xe(){this.#Ie(),this.#Ne(),this.#Ce(),this.#De()}constructor(t){Object.freeze(this),this.#Me=new nt(t)}#Oe(){this.#ve.removeEventListener("dragstart",this.#be,!1),this.#be=null,this.#ve.removeEventListener("dragend",this.#ye,!1),this.#ye=null,this.#ve.removeEventListener("touchstart",this.#we,!1),this.#ve.removeEventListener("touchmove",this.#we,!1),this.#ve.removeEventListener("touchend",this.#we,!1),this.#ve.removeEventListener("touchcancel",this.#we,!1),this.#we=null,this.#Te.removeEventListener("click",this.#fe,!1),this.#fe=null,this.#Ee&&(this.#Ee=null)}get mover(){return this.#Ee?this.#Ee:this.#Ee=new dt}onCancel(){this.#Oe()}onOk(){this.#Oe()}get title(){return""}get toolbarHTMLElement(){return null}get contentHTMLElements(){return[]}show(){this.createContentHTML(),this.#xe()}removeFromBackground(t){t.removeChild(this.#pe)}addToBackground(t){t.appendChild(this.#pe)}addToDialog(t){this.#pe.appendChild(t)}get options(){return this.#Me}addCssClass(t){this.#pe.classList.add(t)}}{#je;#Se;#He;#Pe;#Re;#Ae;#ke;#fe;#Be;#Fe;#_e;#ze;#Ke;#Ue;#Ve;#We;#Xe(){this.#je=W.create("div",{className:"TravelNotes-Background"}),this.mover.backgroundHTMLElement=this.#je}#Ye(){this.#ze=new q(this.mover),this.#je.addEventListener("dragover",this.#ze,!1),this.#Ve=new Z,this.#je.addEventListener("wheel",this.#Ve,{passive:!0}),this.#We=new J,this.#je.addEventListener("contextmenu",this.#We,!1),this.#Ke=new st(this),this.#je.addEventListener("touchstart",this.#Ke,!1),this.#je.addEventListener("touchmove",this.#Ke,!1),this.#je.addEventListener("touchend",this.#Ke,!1),this.#je.addEventListener("touchcancel",this.#Ke,!1),this.#Ue=new it,this.#je.addEventListener("mouseup",this.#Ue,!1),this.#je.addEventListener("mousemove",this.#Ue,!1),this.#je.addEventListener("mousedown",this.#Ue,!1)}#Ge(){this.#Se=W.create("div",{className:"TravelNotes-ModalBaseDialog-ErrorHTMLElement TravelNotes-Hidden"}),this.addToDialog(this.#Se)}#Ze(){W.create("div",{className:"TravelNotes-WaitAnimationBullet"},W.create("div",{className:"TravelNotes-WaitAnimation"},this.#He=W.create("div",{className:"TravelNotes-ModalBaseDialog-WaitHTMLElement  TravelNotes-Hidden"}))),this.addToDialog(this.#He)}#Je(){const t=W.create("div",{className:"TravelNotes-ModalBaseDialog-FooterHTMLElement"});this.addToDialog(t),this.#Re=W.create("div",{textContent:this.options.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},t),this.#ke=new G(this),this.#Re.addEventListener("click",this.#ke,!1),this.options.secondButtonText?(this.#Ae=W.create("div",{textContent:this.options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.#fe=new X(this),this.#Ae.addEventListener("click",this.#fe,!1)):this.#Ae=null,this.footerHTMLElements.forEach((e=>t.appendChild(e)))}#xe(){this.#Xe(),this.#Ye(),this.#Ge(),this.#Ze(),this.#Je()}#Oe(){this.#je.removeEventListener("wheel",this.#Ve,{passive:!0}),this.#Ve=null,this.#je.removeEventListener("contextmenu",this.#We,!1),this.#We=null,this.#je.removeEventListener("dragover",this.#ze,!1),this.#ze=null,this.#je.removeEventListener("touchstart",this.#Ke,!1),this.#je.removeEventListener("touchmove",this.#Ke,!1),this.#je.removeEventListener("touchend",this.#Ke,!1),this.#je.removeEventListener("touchcancel",this.#Ke,!1),this.#Ke=null,this.#je.removeEventListener("mouseup",this.#Ue,!1),this.#je.removeEventListener("mousemove",this.#Ue,!1),this.#je.removeEventListener("mousedown",this.#Ue,!1),this.#Ue=null,document.removeEventListener("keydown",this.#_e,{capture:!0}),this.#_e=null,this.#Re.removeEventListener("click",this.#ke,!1),this.#ke=null,this.options.secondButtonText&&(this.#Ae.removeEventListener("click",this.#fe,!1),this.#fe=null),document.body.removeChild(this.#je)}#qe(t,e){this.#Be=t,this.#Fe=e}constructor(t){super(t),this.#Pe=!0}show(){return super.show(),this.#xe(),document.body.appendChild(this.#je),this.addToBackground(this.#je),this.#_e=new Y(this),document.addEventListener("keydown",this.#_e,{capture:!0}),this.mover.centerDialog(),new Promise(((t,e)=>this.#qe(t,e)))}onCancel(){this.#Oe(),super.onCancel(),this.#Fe("Canceled by user")}canClose(){return!0}onOk(t){return!!this.canClose()&&(this.#Be(t),this.#Oe(),super.onOk(),!0)}showWait(){this.#He.classList.remove("TravelNotes-Hidden"),this.#Re.classList.add("TravelNotes-Hidden")}hideWait(){this.#He.classList.add("TravelNotes-Hidden"),this.#Re.classList.remove("TravelNotes-Hidden")}showError(t){this.#Se.textContent="",O.sanitizeToHtmlElement(t,this.#Se),this.#Se.classList.remove("TravelNotes-Hidden")}hideError(){this.#Se.textContent="",this.#Se.classList.add("TravelNotes-Hidden")}get footerHTMLElements(){return[]}get keyboardELEnabled(){return this.#Pe}set keyboardELEnabled(t){this.#Pe=t}}class ht{#$e;constructor(t){Object.freeze(this),this.#$e=t}destructor(){this.#$e=null}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{this.#$e.addApiKeys(JSON.parse(e.result))}catch(t){this.#$e.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class ut{#$e;#Qe;constructor(t){Object.freeze(this),this.#$e=t,this.#Qe=new ht(this.#$e)}destructor(){this.#$e=null,this.#Qe.destructor()}handleEvent(t){t.stopPropagation(),this.#$e.hideError(),S.openFile(this.#Qe,".json")}}class mt{#to;constructor(){Object.freeze(this),this.#to=W.create("div",{className:"TravelNotes-BaseDialog-DataDiv"})}get controlHTMLElement(){return this.#to}}class gt{#eo=null;constructor(t){Object.freeze(this),this.#eo=t}handleEvent(t){t.currentTarget.textContent="👀",t.preventDefault(),t.stopPropagation(),this.#eo.type="text"}}class pt{#eo;constructor(t){Object.freeze(this),this.#eo=t}handleEvent(t){t.currentTarget.textContent="👁️",t.preventDefault(),t.stopPropagation(),this.#eo.type="password",this.#eo.focus()}}class vt extends mt{#eo;#oo;#so;#io;constructor(t){super(),this.#eo=W.create("input",{type:"password",dataset:{Name:t?.datasetName||"PasswordControl"}},this.controlHTMLElement),this.#oo=W.create("span",{id:"TravelNotes-PasswordControl-EyeSpan",textContent:"👁️"},this.controlHTMLElement),this.#so=new gt(this.#eo),this.#io=new pt(this.#eo),this.#oo.addEventListener("mousedown",this.#so,!1),this.#oo.addEventListener("touchstart",this.#so,!1),this.#oo.addEventListener("mouseup",this.#io,!1),this.#oo.addEventListener("touchend",this.#io,!1),this.#eo.focus()}destructor(){this.#oo.removeEventListener("mousedown",this.#so,!1),this.#oo.removeEventListener("touchstart",this.#so,!1),this.#oo.removeEventListener("mouseup",this.#io,!1),this.#oo.removeEventListener("touchend",this.#io,!1),this.#so=null,this.#io=null}get value(){return this.#eo.value}focus(){this.#eo.focus()}}class Tt extends ct{#no;#ro;static get#ao(){return 12}constructor(t){super(),this.#ro=t}#Oe(){this.#no.destructor()}createContentHTML(){this.#no=new vt}show(){const t=super.show();return this.#no.focus(),t}canClose(){return this.hideError(),!(this.#ro&&(this.#no.value.length<Tt.#ao||!this.#no.value.match(/[0-9]+/)||!this.#no.value.match(/[a-z]+/)||!this.#no.value.match(/[A-Z]+/)||!this.#no.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+j.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+j.getText("PasswordDialog - Password rules2")+"</li><li>"+j.getText("PasswordDialog - Password rules3")+"</li><li>"+j.getText("PasswordDialog - Password rules4")+"</li><li>"+j.getText("PasswordDialog - Password rules5")+"</li><li>"+j.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.#no.focus(),!1)}onCancel(){this.#Oe(),super.onCancel()}onOk(){this.#Oe(),super.onOk((new window.TextEncoder).encode(this.#no.value))}get contentHTMLElements(){return[this.#no.controlHTMLElement]}get title(){return j.getText("PasswordDialog - password")}}class Lt{#lo;#do(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}#co(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}#ho(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}#uo(t,e,o){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,o)}constructor(t){this.#lo=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette.",Object.freeze(this)}encryptData(t,e,o,s){let i=window.crypto.getRandomValues(new Uint8Array(16));s.then((t=>this.#do(t))).then((t=>this.#co(t,this.#lo))).then((e=>this.#uo(e,i,t))).then((t=>{e(new Blob([i,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(o)}decryptData(t,e,o,s){s.then((t=>this.#do(t))).then((t=>this.#co(t,this.#lo))).then((e=>this.#ho(e,t))).then(e).catch(o)}}class Et{#mo;constructor(t){this.#mo=t,Object.freeze(this)}destructor(){this.#mo=null}onErrorDecrypt(t){this.#mo.hideWait(),this.#mo.keyboardELEnabled=!0,t&&"Canceled by user"!==t&&this.#mo.showError(j.getText("DataEncryptorHandlers - An error occurs when reading the file"))}onOkDecrypt(t){try{this.#mo.addApiKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.#mo.hideWait(),this.#mo.hideError(),this.#mo.keyboardELEnabled=!0}onOkEncrypt(t){this.#mo.hideError(),this.#mo.hideWait(),S.saveFile("ApiKeys",t),this.#mo.keyboardELEnabled=!0}onErrorEncrypt(){this.#mo.showError(j.getText("DataEncryptorHandlers - An error occurs when saving the keys")),this.#mo.hideWait(),this.#mo.keyboardELEnabled=!0}}class bt{#$e;#go;constructor(t){Object.freeze(this),this.#$e=t,this.#go=new Et(this.#$e)}destructor(){this.#go.destructor(),this.#$e=null}handleEvent(t){t.stopPropagation(),this.#$e.hideError(),this.#$e.showWait(),this.#$e.keyboardELEnabled=!1,fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"ApiKeys").then((t=>{g===t.status&&t.ok?t.arrayBuffer().then((t=>{(new Lt).decryptData(t,(t=>{this.#go.onOkDecrypt(t)}),(t=>{this.#go.onErrorDecrypt(t)}),new Tt(!1).show())})):this.#go.onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{this.#go.onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class yt{#$e;#go;constructor(t){Object.freeze(this),this.#$e=t,this.#go=new Et(this.#$e)}destructor(){this.#go.destructor(),this.#$e=null}handleEvent(t){t.stopPropagation(),this.#$e.showWait(),this.#$e.keyboardELEnabled=!1;const e=new FileReader;e.onload=()=>{(new Lt).decryptData(e.result,(t=>{this.#go.onOkDecrypt(t)}),(t=>{this.#go.onErrorDecrypt(t)}),new Tt(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class wt{#$e;#po;constructor(t){Object.freeze(this),this.#$e=t,this.#po=new yt(this.#$e)}destructor(){this.#$e=null,this.#po.destructor()}handleEvent(t){t.stopPropagation(),this.#$e.hideError(),S.openFile(this.#po)}}class ft{#$e;#go;constructor(t){Object.freeze(this),this.#$e=t,this.#go=new Et(this.#$e)}destructor(){this.#go.destructor(),this.#$e=null}handleEvent(t){t.stopPropagation(),this.#$e.validateApiKeys()&&(this.#$e.showWait(),this.#$e.keyboardELEnabled=!1,(new Lt).encryptData((new window.TextEncoder).encode(this.#$e.apiKeysJSON),(t=>this.#go.onOkEncrypt(t)),(()=>this.#go.onErrorEncrypt()),new Tt(!0).show()))}}class Mt{#$e;constructor(t){Object.freeze(this),this.#$e=t}destructor(){this.#$e=null}handleEvent(t){t.stopPropagation(),this.#$e.validateApiKeys()&&S.saveFile("ApiKeys.json",this.#$e.apiKeysJSON,"application/json")}}class It{#vo;constructor(t){Object.freeze(this),this.#vo=t}destructor(){this.#vo=null}handleEvent(t){t.stopPropagation(),this.#vo.newApiKey()}}class Nt{#$e;#vo;#To;#Lo;#Eo;#bo;#yo;#wo;#fo;#Mo;#Io;#No;#Co;#Do;#xo;#Oo;#jo(){this.#Lo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Reload from server"),textContent:"🔄"},this.#To),this.#Io=new bt(this.#$e),this.#Lo.addEventListener("click",this.#Io,!1)}#So(){this.#Eo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Save to file"),textContent:"💾"},this.#To),this.#No=new ft(this.#$e),this.#Eo.addEventListener("click",this.#No,!1)}#Ho(){this.#bo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Open file"),textContent:"📂"},this.#To),this.#Co=new wt(this.#$e),this.#bo.addEventListener("click",this.#Co,!1)}#Po(){this.#yo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - new api key"),textContent:"+"},this.#To),this.#Do=new It(this.#vo),this.#yo.addEventListener("click",this.#Do,!1)}#Ro(){this.#wo=W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-ApiKeysDialog-AtRightButton",title:j.getText("ApiKeysDialogToolbar - Save to json file"),textContent:"💾"},this.#To),this.#xo=new Mt(this.#$e),this.#wo.addEventListener("click",this.#xo,!1)}#Ao(){this.#fo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Open json file"),textContent:"📂"},this.#To),this.#Oo=new ut(this.#$e),this.#fo.addEventListener("click",this.#Oo,!1)}#ko(){window?.crypto?.subtle?.importKey&&window.isSecureContext&&(this.#Mo&&this.#jo(),this.#So(),this.#Ho()),this.#Po(),t.ApiKeysDialog.haveUnsecureButtons&&(this.#Ro(),this.#Ao())}constructor(t,e,o){this.#$e=t,this.#vo=e,this.#Mo=o,this.#To=W.create("div",{id:"TravelNotes-ApiKeysDialog-ToolbarDiv"}),this.#ko(),Object.freeze(this)}destructor(){this.#Lo&&(this.#Lo.removeEventListener("click",this.#Io,!1),this.#Io.destructor(),this.#Io=null),this.#Eo&&(this.#Eo.removeEventListener("click",this.#No,!1),this.#No.destructor(),this.#No=null),this.#bo&&(this.#bo.removeEventListener("click",this.#Co,!1),this.#Co.destructor(),this.#Co=null),this.#yo&&(this.#yo.removeEventListener("click",this.#Do,!1),this.#Do.destructor(),this.#Do=null),this.#wo&&(this.#wo.removeEventListener("click",this.#xo,!1),this.#xo.destructor(),this.#xo=null),this.#fo&&(this.#fo.removeEventListener("click",this.#Oo,!1),this.#Oo.destructor(),this.#Oo=null)}get toolbarHTMLElement(){return this.#To}}class Ct{#Bo;#Fo;#_o;#t;#zo;#Ko;constructor(e,o){Object.freeze(this),this.#zo=o,this.#t=b.nextObjId,this.#Bo=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"}),this.#Fo=W.create("input",{className:"TravelNotes-ApiKeysDialog-ApiKeyName TravelNotes-ApiKeysDialog-Input",value:e.providerName,placeholder:j.getText("ApiKeyControlRow - provider name")},this.#Bo),this.#_o=W.create("input",{className:"TravelNotes-ApiKeysDialog-ApiKeyValue TravelNotes-ApiKeysDialog-Input",value:e.providerKey,placeholder:j.getText("ApiKeyControlRow - api key"),type:t.ApiKeysDialog.showApiKeys?"text":"password"},this.#Bo),this.#Ko=W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-ApiKeysDialog-AtRightButton",title:j.getText("ApiKeyControlRow - delete api key"),textContent:"❌",dataset:{ObjId:this.#t}},this.#Bo),this.#Ko.addEventListener("click",this.#zo,!1)}destructor(){this.#Ko.removeEventListener("click",this.#zo,!1)}get objId(){return this.#t}get HTMLElement(){return this.#Bo}get providerName(){return this.#Fo.value}get providerKey(){return this.#_o.value}get apiKey(){return new V(this.#Fo.value,this.#_o.value)}}class Dt{#vo;constructor(t){Object.freeze(this),this.#vo=t}destructor(){this.#vo=null}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.#vo.deleteApiKey(Number.parseInt(t.target.dataset.tanObjId))}}class xt extends mt{#Uo;#zo;constructor(){super(),this.#Uo=new Map,this.#zo=new Dt(this)}destructor(){this.#Uo.forEach((t=>t.destructor())),this.#Uo.clear(),this.#zo.destructor(),this.#zo=null}haveEmptyOrDuplicateValues(){let t=!1;const e=[];this.#Uo.forEach((o=>{t=t||""===o.providerName||""===o.providerKey,e.push(o.providerName)}));let o=!1;return e.forEach((t=>{o=o||e.indexOf(t)!==e.lastIndexOf(t)})),{haveEmpty:t,haveDuplicate:o}}addApiKeys(t){this.#Uo.clear(),t.forEach((t=>{const e=new Ct(t,this.#zo);this.#Uo.set(e.objId,e)})),this.refreshApiKeys()}newApiKey(){const t=new V,e=new Ct(t,this.#zo);this.#Uo.set(e.objId,e),this.refreshApiKeys()}deleteApiKey(t){this.#Uo.get(t).destructor(),this.#Uo.delete(t),this.refreshApiKeys()}refreshApiKeys(){for(;this.controlHTMLElement.firstChild;)this.controlHTMLElement.removeChild(this.controlHTMLElement.firstChild);this.#Uo.forEach((t=>{this.controlHTMLElement.appendChild(t.HTMLElement)}))}get apiKeys(){const t=[];return this.#Uo.forEach((e=>t.push(e.apiKey))),t}get apiKeysJSON(){const t=[];return this.#Uo.forEach((e=>t.push(e.apiKey.jsonObject))),JSON.stringify(t)}}const Ot=new class{#Vo;#Wo;#Xo;#Yo;#Go;#Zo;#Jo(){this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null),this.#Vo.classList.remove("TravelNotes-ErrorsUI-"+this.#Zo),this.#Vo.classList.add("TravelNotes-Hidden"),this.#Go.classList.add("TravelNotes-Hidden"),this.#Wo.textContent=""}#qe(e,o){if(this.#Zo=o,!t.errorsUI["show"+this.#Zo]||"Help"===o&&this.#Yo.checked)return;this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null),this.#Wo.textContent="",O.sanitizeToHtmlElement(e,this.#Wo),this.#Vo.classList.add("TravelNotes-ErrorsUI-"+this.#Zo),this.#Vo.classList.remove("TravelNotes-Hidden");let s=t.errorsUI.timeOut;"Help"===this.#Zo&&(this.#Go.classList.remove("TravelNotes-Hidden"),s=t.errorsUI.helpTimeOut),this.#Xo=setTimeout((()=>this.#Jo()),s)}constructor(){Object.freeze(this)}createUI(){if(this.#Vo)return;this.#Vo=W.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);const e=W.create("div",null,this.#Vo);W.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this.#Jo()),!1),this.#Wo=W.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.#Vo),this.#Go=W.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.#Vo),this.#Yo=W.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox",checked:!t.errorsUI.showHelp},this.#Go),W.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:"Don't show help again"},this.#Go)}showError(t){this.#qe(t,"Error")}showWarning(t){this.#qe(t,"Warning")}showInfo(t){this.#qe(t,"Info")}showHelp(t){this.#qe(t,"Help")}};class jt extends ct{#qo;#vo;#$o;#Mo;constructor(t,e){super(),this.#$o=t,this.#Mo=e}createContentHTML(){this.#vo=new xt,this.#qo=new Nt(this,this.#vo,this.#Mo),this.#vo.addApiKeys(this.#$o)}#Oe(){this.#vo.destructor(),this.#qo.destructor(),this.#qo=null}validateApiKeys(){this.hideError();const t=this.#vo.haveEmptyOrDuplicateValues();return t.haveEmpty?(this.showError(j.getText("ApiKeysDialog - empty api key name or value")),!1):!t.haveDuplicate||(this.showError(j.getText("ApiKeysDialog - duplicate api key name found")),!1)}show(){return Ot.showHelp("<p>"+j.getText("Help - Complete the ApiKeys1")+"</p><p>"+j.getText("Help - Complete the ApiKeys2")+"</p><p>"+j.getText("Help - Complete the ApiKeys3")+"</p>"),super.show()}canClose(){return this.validateApiKeys()}onCancel(){this.#Oe(),super.onCancel()}onOk(){super.onOk(this.#vo.apiKeys)&&this.#Oe()}get title(){return j.getText("ApiKeysDialog - api keys")}get toolbarHTMLElement(){return this.#qo.toolbarHTMLElement}get contentHTMLElements(){return[this.#vo.controlHTMLElement]}get apiKeysJSON(){return this.#vo.apiKeysJSON}addApiKeys(t){this.#vo.addApiKeys(t)}}const St=new class{constructor(){Object.freeze(this)}dispatch(t,e){const o=new Event(t);e&&(o.data=e),document.dispatchEvent(o)}};const Ht=new class{#Mo=!1;#Qo=new Map;#ts(t){this.#es(JSON.parse((new TextDecoder).decode(t)))}#os(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&Ot.showError(j.getText("ApiKeysManager - An error occurs when reading the ApiKeys file"))}#ss(t){window.isSecureContext&&window?.crypto?.subtle?.importKey&&(new Lt).decryptData(t,(t=>this.#ts(t)),(t=>this.#os(t)),new Tt(!1).show())}#is(t){return this.#Qo.get(t.toLowerCase())}#ns(t,e){this.#Qo.set(t.toLowerCase(),e)}#rs(){if(!S.storageAvailable("sessionStorage"))return 0;let t=0;for(let e=0;e<sessionStorage.length;e++){const o=sessionStorage.key(e);o.match(/^\w*ProviderKey$/)&&(this.#ns(o.replace("ProviderKey",""),atob(sessionStorage.getItem(o))),t++)}return U.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.#is(t.name)||"")})),t}#es(e){this.#Qo.clear();const o=S.storageAvailable("sessionStorage")&&t.ApiKeys.saveToSessionStorage;o&&sessionStorage.clear(),e.forEach((t=>{o&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.#ns(t.providerName,t.providerKey)})),U.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.#is(t.name)||"")})),St.dispatch("providersadded")}constructor(){Object.freeze(this)}hasKey(t){return this.#Qo.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){const e=this.#Qo.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.#rs()&&(St.dispatch("providersadded"),t=!0),fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"ApiKeys").then((e=>{g===e.status&&e.ok&&(this.#Mo=!0,t||e.arrayBuffer().then((t=>this.#ss(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){const t=[];this.#Qo.forEach(((e,o)=>{t.push(new V(o,e))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new jt(t,this.#Mo).show().then((t=>this.#es(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){const e=new t,o=e.name.toLowerCase();let s=this.#is(o);e.providerKeyNeeded&&!s&&S.storageAvailable("sessionStorage")&&(s=sessionStorage.getItem(o),s&&(s=atob(s))),e.providerKeyNeeded&&s&&(e.providerKey=s),U.providers.set(e.name.toLowerCase(),e)}};const Pt=new class{#as(t){return(t+e.d540)%e.d360-e.d180}constructor(){Object.freeze(this)}arcFromSummitArcArc(t,e,o){return Math.acos(Math.cos(e)*Math.cos(o)+Math.sin(e)*Math.sin(o)*Math.cos(t))}summitFromArcArcArc(t,e,o){return Math.acos((Math.cos(o)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,o){if(t[0]===o[0]&&t[1]===o[1])return 0;const s=t[0]*e.toRadians,i=o[0]*e.toRadians,n=(this.#as(o[1])-this.#as(t[1]))*e.toRadians;return Math.acos(Math.sin(s)*Math.sin(i)+Math.cos(s)*Math.cos(i)*Math.cos(n))*u}};class Rt{#ls;#ds;constructor(t,e){Object.freeze(this),this.#ls=t,this.#ds=e}get note(){return this.#ls}get route(){return this.#ds}}class At{constructor(){Object.seal(this)}distance=Number.MAX_VALUE;route=null;distanceOnRoute=0;latLngOnRoute=[a.defaultValue,a.defaultValue]}const kt=new class{#cs(t,e,o){if(t.objId!==U.editedRouteObjId){const s=ot.getClosestLatLngDistance(t,e);if(s){const i=Pt.pointsDistance(e,s.latLng);i<o.distance&&(o.route=t,o.distance=i,o.latLngOnRoute=s.latLng,o.distanceOnRoute=s.distance)}}}constructor(){Object.freeze(this)}getNearestRouteData(t){const e=new At;return U.travel.routes.forEach((o=>this.#cs(o,t,e))),p!==U.editedRouteObjId&&this.#cs(U.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=U.travel.routes.getAt(t),e||t===U.travel.editedRoute.objId&&(e=U.travel.editedRoute),e}getNoteAndRoute(t){let e=null,o=null;if(e=U.travel.notes.getAt(t),!e){const s=U.travel.routes.iterator;for(;!s.done&&!e;)e=s.value.notes.getAt(t),e&&(o=s.value);e||(e=U.travel.editedRoute.notes.getAt(t),e&&(o=U.travel.editedRoute))}return new Rt(e,o)}getWayPoint(t){let e=U.travel.editedRoute.wayPoints.getAt(t);if(!e){const o=U.travel.routes.iterator;for(;!o.done&&!e;)e=o.value.wayPoints.getAt(t)}return e}};class Bt{#hs;#us;#ds;static get#ms(){return"\n"}static get#gs(){return"\n\t"}static get#ps(){return"\n\t\t"}static get#vs(){return"\n\t\t\t"}static get#Ts(){return"\n\t\t\t\t"}#Ls(){this.#hs='<?xml version="1.0"?>'+Bt.#ms,this.#hs+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}#Es(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}#bs(){const t=this.#ds.wayPoints.iterator;for(;!t.done;)this.#hs+=Bt.#gs+'<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Bt.#ps+this.#us+Bt.#ps+"<name>"+this.#Es(t.value.fullName)+"</name>"+Bt.#gs+"</wpt>"}#ys(){this.#hs+=Bt.#gs+"<rte>",this.#hs+=Bt.#ps+"<name>"+this.#Es(this.#ds.computedName)+"</name>";const t=this.#ds.itinerary.maneuvers.iterator;for(;!t.done;){const e=this.#ds.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId);this.#hs+=Bt.#ps+'<rtept lat="'+e.lat+'" lon="'+e.lng+'">'+Bt.#vs+this.#us+Bt.#vs+"<desc>"+this.#Es(t.value.instruction)+"</desc>"+Bt.#ps+"</rtept>"}this.#hs+=Bt.#gs+"</rte>"}#ws(){this.#hs+=Bt.#gs+"<trk>",this.#hs+=Bt.#ps+"<name>"+this.#Es(this.#ds.computedName)+"</name>",this.#hs+=Bt.#ps+"<trkseg>";const t=this.#ds.itinerary.itineraryPoints.iterator;for(;!t.done;)this.#hs+=Bt.#vs+'<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+Bt.#Ts+this.#us+Bt.#Ts+"<ele>"+t.value.elev+"</ele>"+Bt.#vs+"</trkpt>";this.#hs+=Bt.#ps+"</trkseg>",this.#hs+=Bt.#gs+"</trk>"}#fs(){this.#hs+=Bt.#ms+"</gpx>"}#Ms(){let t=(""===U.travel.name?"":U.travel.name+" - ")+this.#ds.computedName;""===t&&(t="TravelNote"),t+=".gpx",S.saveFile(t,this.#hs,"application/xml")}constructor(){Object.freeze(this)}routeToGpx(t){this.#ds=kt.getRoute(t),this.#ds&&(this.#us="<time>"+(new Date).toISOString()+"</time>",this.#Ls(),this.#bs(),this.#ys(),this.#ws(),this.#fs(),this.#Ms())}}class Ft extends mt{#Is;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#Is=W.create("input",{type:"checkbox",className:"TravelNotes-CheckboxInputControl-Checkbox",checked:t?.checked,dataset:{Name:t?.datasetName||"CheckboxInputControl"}},this.controlHTMLElement),W.create("text",{value:t?.afterText||""},this.controlHTMLElement)}get checked(){return this.#Is.checked}set checked(t){this.#Is.checked=t}}class _t{#Ns;#Cs;#Ds;constructor(t,e,o){Object.freeze(this),this.#Ns="number"==typeof t&&_t.MAX_COLOR>=t&&_t.MIN_COLOR<=t?t:_t.MAX_COLOR,this.#Cs="number"==typeof e&&_t.MAX_COLOR>=e&&_t.MIN_COLOR<=e?e:_t.MAX_COLOR,this.#Ds="number"==typeof o&&_t.MAX_COLOR>=o&&_t.MIN_COLOR<=o?o:_t.MAX_COLOR}static get MIN_COLOR(){return 0}static get MAX_COLOR(){return 255}static fromCss(t){let e=new _t;return e.cssColor=t,e}get red(){return this.#Ns}set red(t){"number"==typeof t&&_t.MAX_COLOR>=t&&_t.MIN_COLOR<=t&&(this.#Ns=t)}get green(){return this.#Cs}set green(t){"number"==typeof t&&_t.MAX_COLOR>=t&&_t.MIN_COLOR<=t&&(this.#Cs=t)}get blue(){return this.#Ds}set blue(t){"number"==typeof t&&_t.MAX_COLOR>=t&&_t.MIN_COLOR<=t&&(this.#Ds=t)}get cssColor(){return"#"+this.#Ns.toString(m).padStart(2,"0")+this.#Cs.toString(m).padStart(2,"0")+this.#Ds.toString(m).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.#Ns=Number.parseInt(t.substring(1,3),m),this.#Cs=Number.parseInt(t.substring(3,5),m),this.#Ds=Number.parseInt(t.substring(5,7),m)):"rgb"===t.substring(0,3)&&([this.#Ns,this.#Cs,this.#Ds]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}}class zt{#xs=null;constructor(t){Object.freeze(this),this.#xs=t}handleEvent(t){t.stopPropagation(),this.#xs.onColorButtonClick(t.target.style["background-color"])}}class Kt{#Os;#js;#Ss;static get#Hs(){return 6}static get#Ps(){return 6}static get#Rs(){return 51}constructor(t){Object.freeze(this),this.#js=[],this.#Ss=new zt(t),this.#Os=W.create("div",null,t.controlHTMLElement);for(let t=0;t<Kt.#Hs;++t){const t=W.create("div",null,this.#Os);for(let e=0;e<Kt.#Ps;++e){let e=W.create("div",{className:"TravelNotes-ColorControl-CellColorHTMLElement"},t);e.addEventListener("click",this.#Ss,!1),this.#js.push(e)}}}destructor(){this.#js.forEach((t=>{t.removeEventListener("click",this.#Ss,!1)})),this.#Ss=null}set red(t){let e=new _t(t,_t.MIN_COLOR,_t.MIN_COLOR);this.#js.forEach((t=>{t.style["background-color"]=e.cssColor,_t.MAX_COLOR<=e.green?(e.green=_t.MIN_COLOR,e.blue+=Kt.#Rs):e.green+=Kt.#Rs}))}}class Ut{#xs;#As;constructor(t,e){Object.freeze(this),this.#xs=t,this.#As=e}handleEvent(t){t.stopPropagation(),this.#xs.onRedSliderInput(t.target.valueAsNumber*(this.#As-Math.floor(this.#As)<Math.ceil(this.#As)-this.#As?Math.floor(this.#As):Math.ceil(this.#As)))}}class Vt{#ks;#Bs;static get#Fs(){return 100}static get#_s(){return 20}constructor(t){this.#Bs=new Ut(t,_t.MAX_COLOR/Vt.#Fs),this.#ks=W.create("input",{type:"range",value:0,min:0,max:Vt.#Fs,step:Vt.#_s},W.create("div",null,t.controlHTMLElement)),this.#ks.addEventListener("input",this.#Bs,!1),this.#ks.focus()}destructor(){this.#ks.removeEventListener("input",this.#Bs,!1),this.#Bs=null}}class Wt{#xs;#zs;constructor(t,e){Object.freeze(this),this.#xs=t,this.#zs=e}handleEvent(t){t.stopPropagation(),this.#xs.onRgbInput(this.#zs.cssColor)}}class Xt{#Ks;#Us;#Vs;#Ws;#Xs;#Ys(t){W.create("text",{value:t},this.#Ks);const e=W.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",min:_t.MIN_COLOR,max:_t.MAX_COLOR},this.#Ks);return e.addEventListener("input",this.#Xs,!1),e}constructor(t){Object.freeze(this),this.#Xs=new Wt(t,this),this.#Ks=W.create("div",null,t.controlHTMLElement),this.#Us=this.#Ys(j.getText("ColorControl - Red")),this.#Vs=this.#Ys(j.getText("ColorControl - Green")),this.#Ws=this.#Ys(j.getText("ColorControl - Blue"))}destructor(){this.#Us.removeEventListener("input",this.#Xs,!1),this.#Vs.removeEventListener("input",this.#Xs,!1),this.#Ws.removeEventListener("input",this.#Xs,!1),this.#Xs=null}get cssColor(){return new _t(Number.parseInt(this.#Us.value),Number.parseInt(this.#Vs.value),Number.parseInt(this.#Ws.value)).cssColor}set cssColor(t){let e=_t.fromCss(t);this.#Us.value=e.red,this.#Vs.value=e.green,this.#Ws.value=e.blue}}class Yt{#Gs;constructor(t){Object.freeze(this),this.#Gs=W.create("div",{id:"TravelNotes-ColorControl-ColorSampleHTMLElement"},t.controlHTMLElement)}get cssColor(){return this.#Gs.style["background-color"]}set cssColor(t){this.#Gs.style["background-color"]=t}}class Gt extends mt{#Zs;#Js;#zs;#qs;constructor(t){super(),t?.headerText&&""!==t.headerText&&W.create("div",{textContent:t.headerText},this.controlHTMLElement),this.controlHTMLElement.classList.add("TravelNotes-ColorControl-ColorHTMLElement"),this.#Zs=new Kt(this),this.#Zs.red=0,this.#Js=new Vt(this),this.#zs=new Xt(this),this.#zs.cssColor=t?.cssColor||"#ff0000",this.#qs=new Yt(this),this.#qs.cssColor=t?.cssColor||"#ff0000"}destructor(){this.#Zs.destructor(),this.#Js.destructor(),this.#zs.destructor()}get cssColor(){return _t.fromCss(this.#qs.cssColor).cssColor}onRedSliderInput(t){this.#Zs.red=t}onColorButtonClick(t){this.#zs.cssColor=t,this.#qs.cssColor=t}onRgbInput(t){this.#qs.cssColor=t}}class Zt extends mt{#Is;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#Is=W.create("input",{type:"number",className:"TravelNotes-NumberInputControl-NumberInput",value:t?.value||0,min:t?.min||0,max:t?.max||Number.MAX_VALUE,dataset:{Name:t?.datasetName||"NumberInputControl"}},this.controlHTMLElement),W.create("text",{value:t?.afterText||""},this.controlHTMLElement)}get value(){return Number.parseInt(this.#Is.value)}set value(t){this.#Is.value=t}}class Jt extends mt{#Is;constructor(t,e){super(),W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:t?.headerText||""},this.controlHTMLElement),this.#Is=W.create("input",{className:"TravelNotes-TextInputControl-TextInput",type:"text",dataset:{Name:t?.datasetName||"TextInputControl"},value:t?.value||""},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),e?.controlFocus&&this.#Is.addEventListener("focus",e.controlFocus),e?.controlInput&&this.#Is.addEventListener("input",e.controlInput)}destructor(t){t?.controlFocus&&this.#Is.removeEventListener("focus",t.controlFocus),t?.controlInput&&this.#Is.removeEventListener("input",t.controlInput)}get value(){return this.#Is.value}set value(t){this.#Is.value=t}}class qt extends mt{#$s;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#$s=W.create("select",null,this.controlHTMLElement),t?.elements.forEach((t=>{this.#$s.add(W.create("option",{text:t}))}))}get selectedIndex(){return this.#$s.selectedIndex}set selectedIndex(t){this.#$s.selectedIndex=t}}class $t extends ct{#ds;#xs;#Qs;#ti;#ei;#oi;static get#si(){return 1}static get#ii(){return 40}constructor(t){super(),this.#ds=t}createContentHTML(){this.#Qs=new Jt({headerText:j.getText("RoutePropertiesDialog - Name"),value:this.#ds.computedName}),this.#ti=new Zt({beforeText:j.getText("RoutePropertiesDialog - Width"),value:this.#ds.width,min:$t.#si,max:$t.#ii}),this.#ei=new qt({beforeText:j.getText("RoutePropertiesDialog - Linetype"),elements:Array.from(t.route.dashChoices,(t=>t.text))}),this.#ei.selectedIndex=this.#ds.dashIndex<t.route.dashChoices.length?this.#ds.dashIndex:0,this.#oi=new Ft({beforeText:j.getText("RoutePropertiesDialog - Chained route"),checked:this.#ds.chain}),this.#xs=new Gt({cssColor:this.#ds.color,headerText:j.getText("RoutePropertiesDialog - Color")})}show(){let t=super.show();return this.addCssClass("TravelNotes-RoutePropertiesDialog"),t}onCancel(){this.#xs.destructor(),super.onCancel()}onOk(){this.#ds.color=this.#xs.cssColor,this.#ds.computedName!==this.#Qs.value&&(this.#ds.name=this.#Qs.value),this.#ds.width=this.#ti.value,this.#ds.chain=this.#oi.checked,this.#ds.dashIndex=this.#ei.selectedIndex,this.#xs.destructor(),super.onOk()}get title(){return j.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[this.#Qs.controlHTMLElement,this.#ti.controlHTMLElement,this.#ei.controlHTMLElement,this.#oi.controlHTMLElement,this.#xs.controlHTMLElement]}}class Qt extends mt{static#t=0;#ni;constructor(t){super(),this.#ni=[],W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:t?.headerText||""},this.controlHTMLElement);let e="controlName"+ ++Qt.#t,o=0;t.buttons.forEach((s=>{let i="buttonId"+ ++Qt.#t,n=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#ni.push(W.create("input",{type:"radio",className:"TravelNotes-RadioInputControl-Radio",checked:s.checked,id:i,name:e,value:String(o++),dataset:{Name:t?.datasetName||"RadioInputControl"}},n)),W.create("label",{htmlFor:i,innerText:s.label},n)}))}get value(){let t=T;return this.#ni.forEach((e=>{t=e.checked?Number.parseInt(e.value):t})),t}}class te{constructor(){Object.seal(this)}paperWidth=0;paperHeight=0;borderWidth=0;zoomFactor=0;printNotes=!1;firefoxBrowser=!0}class ee extends ct{#ri;#ai;#li;#di;#ci;#hi;static get#ui(){return 15}constructor(){super()}createContentHTML(){this.#ri=new Zt({beforeText:j.getText("PrintRouteMapDialog - Paper width"),afterText:j.getText("PrintRouteMapDialog - Paper width units"),value:t.printRouteMap.paperWidth}),this.#ai=new Zt({beforeText:j.getText("PrintRouteMapDialog - Paper height"),afterText:j.getText("PrintRouteMapDialog - Paper height units"),value:t.printRouteMap.paperHeight}),this.#li=new Zt({beforeText:j.getText("PrintRouteMapDialog - Border width"),afterText:j.getText("PrintRouteMapDialog - Border width units"),value:t.printRouteMap.borderWidth}),this.#di=new Zt({beforeText:j.getText("PrintRouteMapDialog - Zoom factor"),value:Math.min(t.printRouteMap.zoomFactor,ee.#ui),min:U.map.getMinZoom(),max:Math.min(U.map.getMaxZoom(),ee.#ui)}),this.#ci=new Ft({afterText:j.getText("PrintRouteMapDialog - Print notes"),checked:t.printRouteMap.printNotes}),this.#hi=new Qt({headerText:j.getText("PrintRouteMapDialog - Print with"),buttons:[{label:"Firefox",checked:t.printRouteMap.firefoxBrowser},{label:j.getText("PrintRouteMapDialog - Another browser"),checked:!t.printRouteMap.firefoxBrowser}]})}show(){let t=super.show();return this.addCssClass("TravelNotes-PrintRouteMapDialog"),t}onOk(){const t=new te;t.paperWidth=this.#ri.value,t.paperHeight=this.#ai.value,t.borderWidth=this.#li.value,t.zoomFactor=this.#di.value,t.printNotes=this.#ci.checked,t.firefoxBrowser=0===this.#hi.value,Object.freeze(t),super.onOk(t)}get contentHTMLElements(){return[this.#ri.controlHTMLElement,this.#ai.controlHTMLElement,this.#li.controlHTMLElement,this.#di.controlHTMLElement,this.#ci.controlHTMLElement,this.#hi.controlHTMLElement]}get title(){return j.getText("PrintRouteMapDialog - Print")}}class oe{#se=null;#ie=null;#ne=null;#re=null;#ae=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.#se=t.firstButtonText;break;case"secondButtonText":this.#ie=t.secondButtonText;break;case"selectOptionsData":this.#ne=t.selectOptionsData;break;case"title":this.#re=t.title;break;case"text":this.#ae=t.text}}get firstButtonText(){return this.#se}get secondButtonText(){return this.#ie}get selectOptionsData(){return this.#ne}get title(){return this.#re}get text(){return this.#ae}}class se{#_t;constructor(t){Object.freeze(this),this.#_t=t}handleEvent(){this.#_t.onCancel()}}class ie{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.setDragStartPoint(t),t.dataTransfer.setData("ObjId",this.#Kt.objId)}}class ne{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.moveDialog(t)}}class re{#Kt;#le;constructor(t){Object.freeze(this),this.#Kt=t,this.#le=!1}handleEvent(t){t.stopPropagation();let e=t.type;if(1===t.changedTouches.length){const o=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#le=!0,this.#Kt.setDragStartPoint(o);break;case"touchmove":this.#le=!1,t.preventDefault(),this.#Kt.moveDialog(o,e);break;case"touchend":this.#le||this.#Kt.moveDialog(o,e)}}}}class ae{#t;#de;#ce;#he;#ue;#me(t,e){const o=this.backgroundHTMLElement.offsetWidth-this.dialogHTMLElement.offsetWidth-h,s=this.backgroundHTMLElement.offsetHeight-this.dialogHTMLElement.offsetHeight-h;this.#he=Math.max(Math.min(t,o),h),this.#ue=Math.max(Math.min(e,s),h)}#ge(){this.dialogHTMLElement.style.left=String(this.#he)+"px",this.dialogHTMLElement.style.top=String(this.#ue)+"px"}backgroundHTMLElement=null;dialogHTMLElement=null;topBarHTMLElement=null;constructor(){Object.seal(this),this.#he=h,this.#ue=h,this.#de=0,this.#ce=0,this.#t=b.nextObjId}get onTop(){return 42>this.#ue}get objId(){return this.#t}centerDialog(){this.#he=(this.backgroundHTMLElement.clientWidth-this.dialogHTMLElement.clientWidth)/2,this.#ue=(this.backgroundHTMLElement.clientHeight-this.dialogHTMLElement.clientHeight)/2,this.#ge()}moveDialog(t,e){const o=this.#he+t.screenX-this.#de,s=this.#ue+t.screenY-this.#ce;this.moveDialogTo(o,s,e),this.setDragStartPoint(t)}moveDialogTo(t,e){this.#me(t,e),this.#ge()}moveDialogToLastPosition(){this.moveDialogTo(this.#he,this.#ue)}moveDialogToTopLeft(){this.#he=h,this.#ue=h,this.#ge()}setDragStartPoint(t){this.#de=t.screenX,this.#ce=t.screenY}}class le extends class{#pe;#ve;#Te;#Le;#Ee;#be;#ye;#we;#fe;#Me=null;#Ie(){this.#pe=W.create("div",{className:"TravelNotes-BaseDialog-DialogHTMLElement"}),this.mover.dialogHTMLElement=this.#pe}#Ne(){this.#ve=W.create("div",{className:"TravelNotes-BaseDialog-TopBarHTMLElement",draggable:!0},this.#pe),this.#we=new re(this.mover),this.#ve.addEventListener("touchstart",this.#we,!1),this.#ve.addEventListener("touchmove",this.#we,!1),this.#ve.addEventListener("touchend",this.#we,!1),this.#ve.addEventListener("touchcancel",this.#we,!1),this.#be=new ie(this.mover),this.#ve.addEventListener("dragstart",this.#be,!1),this.#ye=new ne(this.mover),this.#ve.addEventListener("dragend",this.#ye,!1),this.#Te=W.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:j.getText("BaseDialog - Cancel")},this.#ve),W.create("div",{textContent:this.title,className:"TravelNotes-BaseDialog-Title"},this.#ve),this.#fe=new se(this),this.#Te.addEventListener("click",this.#fe,!1),this.mover.topBarHTMLElement=this.#ve}#Ce(){this.toolbarHTMLElement&&W.create("div",{className:"TravelNotes-BaseDialog-ToolbarHTMLElement"},this.#pe).appendChild(this.toolbarHTMLElement)}#De(){this.#Le=W.create("div",{className:"TravelNotes-BaseDialog-ContentHTMLElement"},this.#pe),this.contentHTMLElements.forEach((t=>this.#Le.appendChild(t)))}#xe(){this.#Ie(),this.#Ne(),this.#Ce(),this.#De()}constructor(t){Object.freeze(this),this.#Me=new oe(t)}#Oe(){this.#ve.removeEventListener("dragstart",this.#be,!1),this.#be=null,this.#ve.removeEventListener("dragend",this.#ye,!1),this.#ye=null,this.#ve.removeEventListener("touchstart",this.#we,!1),this.#ve.removeEventListener("touchmove",this.#we,!1),this.#ve.removeEventListener("touchend",this.#we,!1),this.#ve.removeEventListener("touchcancel",this.#we,!1),this.#we=null,this.#Te.removeEventListener("click",this.#fe,!1),this.#fe=null,this.#Ee&&(this.#Ee=null)}get mover(){return this.#Ee?this.#Ee:this.#Ee=new ae}onCancel(){this.#Oe()}onOk(){this.#Oe()}get title(){return""}get toolbarHTMLElement(){return null}get contentHTMLElements(){return[]}show(){this.createContentHTML(),this.#xe()}removeFromBackground(t){t.removeChild(this.#pe)}addToBackground(t){t.appendChild(this.#pe)}addToDialog(t){this.#pe.appendChild(t)}get options(){return this.#Me}addCssClass(t){this.#pe.classList.add(t)}}{#ze;#Ye(){this.#ze=new q(this.mover),document.body.addEventListener("dragover",this.#ze,!1)}constructor(){super()}onCancel(){document.body.removeEventListener("dragover",this.#ze,!1),this.#ze=null,super.onCancel(),this.removeFromBackground(document.body)}show(){super.show(),this.mover.backgroundHTMLElement=U.map.getContainer(),this.#Ye(),this.addToBackground(document.body)}}class de{#ds;#mi;#gi;#pi;#vi;#Ti;#Li;static get PROFILE_MARGIN(){return 100}static get PROFILE_HEIGHT(){return 500}static get PROFILE_WIDTH(){return 1e3}static get X_DELTA_TEXT(){return 10}static get Y_DELTA_TEXT(){return 30}static get#Ei(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}static get#bi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3]}static get#yi(){return 8}static get#wi(){return 4}static get#fi(){return de.PROFILE_MARGIN.toFixed(0)}static get#Mi(){return(de.PROFILE_MARGIN+de.PROFILE_WIDTH).toFixed(0)}static get#Ii(){return de.PROFILE_MARGIN.toFixed(0)}static get#Ni(){return(de.PROFILE_MARGIN+de.PROFILE_HEIGHT).toFixed(0)}static get#Ci(){return(de.PROFILE_MARGIN-de.X_DELTA_TEXT).toFixed(0)}static get#Di(){return(de.PROFILE_MARGIN+de.PROFILE_WIDTH+de.X_DELTA_TEXT).toFixed(0)}static get#xi(){return de.PROFILE_MARGIN+de.PROFILE_HEIGHT+de.PROFILE_MARGIN/2}#Oi(){let t="",e=0,o=0,s=0;this.#ds.itinerary.itineraryPoints.forEach((i=>{o=(de.PROFILE_MARGIN+this.#pi*e).toFixed(0),s=(de.PROFILE_MARGIN+this.#gi*(this.#Ti-i.elev)).toFixed(0),t+=o+","+s+" ",e+=i.distance}));const i=document.createElementNS(L,"polyline");i.setAttributeNS(null,"points",t),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.#mi.appendChild(i)}#ji(){const t=de.#fi+","+de.#Ii+" "+de.#fi+","+de.#Ni+" "+de.#Mi+","+de.#Ni+" "+de.#Mi+","+de.#Ii,e=document.createElementNS(L,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.#mi.appendChild(e)}#Si(){let t=Number.MAX_VALUE,e=0;de.#Ei.forEach((o=>{const s=Math.abs(this.#ds.distance/de.#yi-o);s<t&&(t=s,e=o)}));let s=Math.ceil(this.#ds.chainedDistance/e)*e;for(;s<this.#ds.distance+this.#ds.chainedDistance;){const t=document.createElementNS(L,"text");t.appendChild(document.createTextNode(o.metersInKm<e||0<this.#ds.chainedDistance?s/o.metersInKm+" km":s+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",de.PROFILE_MARGIN+(s-this.#ds.chainedDistance)*this.#pi),t.setAttributeNS(null,"y",de.#xi),t.setAttributeNS(null,"text-anchor","start"),this.#mi.appendChild(t),s+=e}}#Hi(){let t=Number.MAX_VALUE,e=0;de.#bi.forEach((o=>{const s=Math.abs(this.#Li/de.#wi-o);s<t&&(t=s,e=o)}));let o=Math.ceil(this.#vi/e)*e;for(;o<this.#Ti;){const t=de.PROFILE_MARGIN+(this.#Ti-o)*this.#gi,s=document.createElementNS(L,"text");s.appendChild(document.createTextNode(o.toFixed(0))),s.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),s.setAttributeNS(null,"x",de.#Di),s.setAttributeNS(null,"y",t),s.setAttributeNS(null,"text-anchor","start"),this.#mi.appendChild(s);const i=document.createElementNS(L,"text");i.appendChild(document.createTextNode(o.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",de.#Ci),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","end"),this.#mi.appendChild(i),o+=e}}#Pi(){this.#mi=document.createElementNS(L,"svg"),this.#mi.setAttributeNS(null,"viewBox","0 0 "+(de.PROFILE_WIDTH+2*de.PROFILE_MARGIN)+" "+(de.PROFILE_HEIGHT+2*de.PROFILE_MARGIN)),this.#mi.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){Object.freeze(this)}createSvg(t){return this.#ds=t,this.#vi=Number.MAX_VALUE,this.#Ti=0,this.#ds.itinerary.itineraryPoints.forEach((t=>{this.#Ti=Math.max(this.#Ti,t.elev),this.#vi=Math.min(this.#vi,t.elev)})),this.#Li=this.#Ti-this.#vi,this.#gi=de.PROFILE_HEIGHT/this.#Li,this.#pi=de.PROFILE_WIDTH/this.#ds.distance,this.#Pi(),this.#Oi(),this.#ji(),this.#Hi(),this.#Si(),this.#mi}}class ce{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onKeydownKeyboard(t.key)}}class he{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onCancelMenu()}}class ue{#Ai=null;#ki=null;static get#Bi(){return 100}static get#Fi(){return 30}#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){if(1===t.changedTouches.length){const e=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#Ai=e.clientX,this.#ki=e.clientY;break;case"touchend":this.#Ai&&this.#ki&&ue.#Bi<this.#ki-e.clientY&&ue.#Fi>Math.abs(this.#Ai-e.clientX)&&this.#Ri.onCancelMenu(),this.#Ai=null,this.#ki=null;break;case"touchcancel":this.#Ai=null,this.#ki=null}}}}class me{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onMouseLeaveMenuItem(t.currentTarget)}}class ge{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onMouseEnterMenuItem(t.currentTarget)}}class pe{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.selectItem(Number.parseInt(t.currentTarget.dataset.tanObjId))}}class ve{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onMouseLeaveContainer()}}class Te{#Ri=null;constructor(t){Object.freeze(this),this.#Ri=t}handleEvent(t){t.stopPropagation(),this.#Ri.onMouseEnterContainer()}}class Le{static#_i=Object.freeze({get previousItem(){return-1},get firstItem(){return 0},get nextItem(){return 1},get lastItem(){return 2}});#zi=null;#Ki;#Ui;#Vi;#Wi;#Xi;#Yi;#Gi;#Zi;#Ji=T;#Xo=null;#qi(){this.#zi.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-MenuItemSelected")}))}#$i(t){switch(this.#qi(),t){case Le.#_i.previousItem:case Le.#_i.nextItem:this.#Ji+=t,T===this.#Ji&&(this.#Ji=this.#zi.menuItemHTMLElements.length-1),this.#zi.menuItemHTMLElements.length===this.#Ji&&(this.#Ji=0);break;case Le.#_i.firstItem:this.#Ji=0;break;case Le.#_i.lastItem:this.#Ji=this.#zi.menuItemHTMLElements.length-1}this.#zi.menuItemHTMLElements[this.#Ji].classList.add("TravelNotes-ContextMenu-MenuItemSelected")}constructor(t){Object.freeze(this),this.#zi=t,this.#Ki=new ce(this),this.#Ui=new ve(this),this.#Vi=new Te(this),this.#Wi=new he(this),this.#Xi=new ue(this),this.#Yi=new pe(this),this.#Gi=new me(this),this.#Zi=new ge(this),document.addEventListener("keydown",this.#Ki,!0),this.#zi.contextMenuHTMLElement.addEventListener("mouseleave",this.#Ui),this.#zi.contextMenuHTMLElement.addEventListener("mouseenter",this.#Vi),this.#zi.contextMenuHTMLElement.addEventListener("touchstart",this.#Xi),this.#zi.contextMenuHTMLElement.addEventListener("touchend",this.#Xi),this.#zi.contextMenuHTMLElement.addEventListener("touchcancel",this.#Xi),this.#zi.cancelButton.addEventListener("click",this.#Wi),this.#zi.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.#Yi),t.addEventListener("mouseleave",this.#Gi),t.addEventListener("mouseenter",this.#Zi)}))}destructor(){this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null),document.removeEventListener("keydown",this.#Ki,!0),this.#zi.contextMenuHTMLElement.removeEventListener("mouseleave",this.#Ui),this.#zi.contextMenuHTMLElement.removeEventListener("mouseenter",this.#Vi),this.#zi.contextMenuHTMLElement.removeEventListener("touchstart",this.#Xi),this.#zi.contextMenuHTMLElement.removeEventListener("touchend",this.#Xi),this.#zi.contextMenuHTMLElement.removeEventListener("touchcancel",this.#Xi),this.#zi.cancelButton.removeEventListener("click",this.#Wi),this.#zi.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.#Yi),t.removeEventListener("mouseleave",this.#Gi),t.removeEventListener("mouseenter",this.#Zi)})),this.#Ki=null,this.#Ui=null,this.#Vi=null,this.#Wi=null,this.#Xi=null,this.#Yi=null,this.#Gi=null,this.#Zi=null,document.body.removeChild(this.#zi.contextMenuHTMLElement),this.#zi=null}onMouseLeaveContainer(){this.#Xo=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.#$i(Le.#_i.nextItem);break;case"ArrowUp":case"ArrowLeft":this.#$i(Le.#_i.previousItem);break;case"Home":this.#$i(Le.#_i.firstItem);break;case"End":this.#$i(Le.#_i.lastItem);break;case"Enter":if(T===this.#Ji||this.#zi.menuItemHTMLElements[this.#Ji].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.#zi.onOk(this.#Ji)}}onCancelMenu(){this.#zi.onCancel("Canceled by user")}selectItem(t){this.#zi.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.#zi.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-MenuItemSelected")}onMouseEnterMenuItem(t){this.#qi(),this.#Ji=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-MenuItemSelected")}}class Ee{#Ai;#ki;#Qi;#tn;#en;static#on=null;#sn;#in;#nn;#Te;#rn;#Ri;static get#an(){return 20}static get isActive(){return Boolean(Ee.#on)}#ln(){this.#nn=W.create("div",{className:"TravelNotes-ContextMenu-ContextMenuHTMLElement"},document.body)}#dn(){this.#Te=W.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CancelButton",title:j.getText("BaseContextMenu - Close")},this.#nn)}#cn(){this.#rn=[],this.menuItems.forEach(((t,e)=>{const o=W.create("div",{textContent:t.itemText,className:"TravelNotes-ContextMenu-MenuItem",dataset:{ObjId:String(e)}},this.#nn);t.isActive||o.classList.add("TravelNotes-ContextMenu-MenuItemDisabled"),this.#rn.push(o)}))}#hn(){const t=Math.min(this.#ki,U.map.getContainer().clientHeight-this.#nn.clientHeight-Ee.#an);this.#nn.style.top=String(t)+"px";const e=Math.min(this.#Ai,U.map.getContainer().clientWidth-this.#nn.clientWidth-Ee.#an);this.#nn.style.left=String(e)+"px"}#un(t,e){this.#sn=t,this.#in=e,this.#ln(),this.#dn(),this.#cn(),this.#hn(),this.#Ri=new Le(this)}constructor(t,e){Object.freeze(this),Ee.#on?Ee.#on.onCancel():(this.#Ai=t.clientX||t.originalEvent.clientX||0,this.#ki=t.clientY||t.originalEvent.clientY||0,this.#Qi=[t.latlng?t.latlng.lat:a.defaultValue,t.latlng?t.latlng.lng:a.defaultValue],this.#tn=t.target?.objId??(Number.parseInt(t?.currentTarget?.dataset?.tanObjId)||p),this.#en=Boolean(e),Ee.#on=this)}onOk(t){this.#Ri.destructor(),Ee.#on=null,this.#sn(t)}onCancel(){this.#Ri.destructor(),Ee.#on=null,this.#in()}show(){Ee.#on&&new Promise(((t,e)=>{this.#un(t,e)})).then((t=>this.menuItems[t].action())).catch((t=>{t&&console.error(t)}))}get menuItems(){return[]}get contextMenuHTMLElement(){return this.#nn}get cancelButton(){return this.#Te}get menuItemHTMLElements(){return this.#rn}get clientX(){return this.#Ai}get clientY(){return this.#ki}get latLng(){return this.#Qi}get targetObjId(){return this.#tn}get haveParentNode(){return this.#en}}class be{#mn;#gn;#pn;constructor(t,e,o){Object.freeze(this),this.#mn=t,this.#gn=e,this.#pn=o}get itemText(){return this.#mn}get isActive(){return this.#gn}get action(){return this.#pn}}class ye{#V;#vn;#Tn;#Et;#Ln;constructor(t){this.#V="string"==typeof t?.name?O.sanitizeToJsString(t.name):"?",this.#vn="string"==typeof t.icon?O.sanitizeToHtmlString(t?.icon).htmlString:"?",this.#Tn="string"==typeof t?.tooltip?O.sanitizeToHtmlString(t.tooltip).htmlString:"?",this.#Et="number"==typeof t?.width?t.width:n.width,this.#Ln="number"==typeof t?.height?t.height:n.height}get name(){return this.#V}get icon(){return this.#vn}get tooltip(){return this.#Tn}get width(){return this.#Et}get height(){return this.#Ln}}class we{#re;#En;#bn;constructor(t){if(Object.freeze(this),"string"!=typeof t?.title||"string"!=typeof t?.htmlBefore||t.htmlAfter&&"string"!=typeof t.htmlAfter)throw new Error("Invalid toolbar button");let e=(t.htmlBefore||"")+(t.htmlAfter||""),o=O.sanitizeToHtmlString(e).errorsString;if(""!==o)throw new Error("Invalid toolbar button : "+e+o);this.#re=O.sanitizeToHtmlString(t.title).htmlString,""===this.title&&(this.title="?"),this.#En=t.htmlBefore||"",this.#bn=t.htmlAfter||""}get title(){return this.#re}get htmlBefore(){return this.#En}get htmlAfter(){return this.#bn}}const fe=new class{#yn;#wn;#fn;constructor(){Object.freeze(this),this.#yn=[],this.#wn=new Map,this.#fn=[]}get editionButtonsData(){return this.#yn}get preDefinedIconsData(){return this.#fn}preDefinedIconDataAt(t){return this.#fn[t]}preDefinedIconDataFromName(t){const e=this.#wn.get(t);return e?e.icon:""}loadJson(t){if(t.editionButtons&&t.editionButtons.forEach((t=>{try{let e=new we(t);this.#yn.push(e)}catch(t){console.error(t.message)}})),t.preDefinedIconsList){t.preDefinedIconsList.forEach((t=>{const e=new ye(t);this.#wn.set(e.name,e)})),this.#fn.length=0;for(const t of this.#wn)this.#fn.push(t[1]);this.#fn=this.#fn.sort(((t,e)=>t.name.localeCompare(e.name)))}}};class Me{#Mn;#In;#Nn;#Cn;#Dn(){this.#In=W.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.#Mn),fe.preDefinedIconsData.forEach((t=>{this.#In.add(W.create("option",{text:t.name}))})),this.#In.selectedIndex=T}#ko(){this.#Nn=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("NoteDialogToolbar - Open a configuration file"),textContent:"📂"},this.#Mn)}#xn(){fe.editionButtonsData.forEach((t=>{const e=W.create("div",{dataset:{HtmlBefore:t.htmlBefore,HtmlAfter:t.htmlAfter},className:"TravelNotes-NoteDialog-EditorButton"},this.#Mn);O.sanitizeToHtmlElement(t.title,e),this.#Cn.push(e)}))}#On(){this.#Dn(),this.#ko(),this.#xn()}#jn(t){this.#In.addEventListener("change",t.iconSelectorChange),this.#Cn.forEach((e=>{e.addEventListener("click",t.editionButtonsClick)})),this.#Nn.addEventListener("click",t.openCfgFileButtonClick,!1)}#Sn(t){this.#In.removeEventListener("change",t.iconSelectorChange),this.#Cn.forEach((e=>{e.removeEventListener("click",t.editionButtonsClick)})),this.#Nn.removeEventListener("click",t.openCfgFileButtonClick,!1)}constructor(t){Object.freeze(this),this.#Cn=[],this.#Mn=W.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.#On(),this.#jn(t)}destructor(t){this.#Sn(t)}update(t){this.#Sn(t),this.#Mn.textContent="",this.#Cn=[],this.#On(),this.#jn(t)}get rootHTMLElement(){return this.#Mn}}class Ie{#Qi;#ds;constructor(t,e){Object.freeze(this),this.#Qi=t,this.#ds=e}get latLng(){return this.#Qi}get route(){return this.#ds}}class Ne extends mt{#Hn;constructor(t,e){super(),W.create("div",{textContent:t?.headerText||"",className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement),this.#Hn=W.create("textarea",{className:"TravelNotes-TextAreaControl-TextArea",placeholder:t?.placeholder||"",rows:t.rows||2,dataset:{Name:t?.datasetName||"TextAreaControl"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),e.controlFocus&&this.#Hn.addEventListener("focus",e.controlFocus),e.controlInput&&this.#Hn.addEventListener("input",e.controlInput)}destructor(t){t.controlFocus&&this.#Hn.removeEventListener("focus",t.controlFocus),t.controlInput&&this.#Hn.removeEventListener("input",t.controlInput)}get value(){return this.#Hn.value}set value(t){this.#Hn.value=t}}class Ce extends mt{#Pn;#Rn;constructor(t){super();const e=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#Rn=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("AddressControl - Reset address"),textContent:"🔄"},e),W.create("text",{value:j.getText("AddressControl - Address")},e),this.#Pn=W.create("input",{type:"text",className:"TravelNotes-AdressControl-InputText",dataset:{Name:"address"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),t.controlFocus&&this.#Pn.addEventListener("focus",t.controlFocus),t.controlInput&&this.#Pn.addEventListener("input",t.controlInput),t.addressButtonClick&&this.#Rn.addEventListener("click",t.addressButtonClick)}destructor(t){t.controlFocus&&this.#Pn.removeEventListener("focus",t.controlFocus),t.controlInput&&this.#Pn.removeEventListener("input",t.controlInput),t.addressButtonClick&&this.#Rn.removeEventListener("click",t.addressButtonClick)}get address(){return this.#Pn.value}set address(t){this.#Pn.value=t}}class De{searchPlaces=!0;searchWays=!0;searchRelations=!0;setGeometry=!0;constructor(){Object.seal(this)}}class xe{#Me;#An;#kn;#Bn;#Fn;#_n;#zn;#Qi;#Kn;#Un;#Vn;#Wn(){this.#kn.forEach((t=>{t.geometry=[[]],t.lat=a.defaultValue,t.lon=a.defaultValue;let e=0;t.nodes.forEach((o=>{const s=this.#An.get(o);t.geometry[0].push([s.lat,s.lon]),t.lat+=s.lat,t.lon+=s.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.#Bn.forEach((t=>{t.geometry=[[]],t.lat=a.defaultValue,t.lon=a.defaultValue;let e=0;t.members.forEach((o=>{if("way"===o.type){const s=this.#kn.get(o.ref);t.geometry.push(s.geometry[0]),t.lat+=s.lat,t.lon+=s.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}#Xn(e){e.forEach((e=>{switch(e.type){case"node":if(this.#An.set(e.id,e),e?.tags?.place&&this.#Me.searchPlaces&&this.#zn[e.tags.place]&&e?.tags?.name){const t=Pt.pointsDistance(this.#Qi,[e.lat,e.lon]),o=this.#zn[e.tags.place];o.maxDistance>t&&o.distance>t&&(o.distance=t,o.name=e.tags.name)}break;case"way":this.#Me.searchWays&&this.#kn.set(e.id,e);break;case"relation":this.#Me.searchRelations&&this.#Bn.set(e.id,e);break;case"area":if(this.#Me.searchPlaces){let o=e.tags.name;"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(o=e.tags["name:"+t.nominatim.language]),this.#Fn[Number.parseInt(e.tags.admin_level)]=o,"2"===e.tags.admin_level&&(this.#_n=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.#_n)}}})),this.#Me.setGeometry&&this.#Wn(),this.#Me.searchPlaces&&this.#Yn()}#Yn(){let t=null;for(let e=2;e<this.#Fn.length;e++)void 0!==this.#Fn[e]&&(this.#_n>=e?this.#Un=this.#Fn[e]:t=this.#Fn[e]);let e=Number.MAX_VALUE;Object.values(this.#zn).forEach((t=>{t.distance<e&&(e=t.distance,this.#Kn=t.name)})),this.#Kn=t||this.#Kn,this.#Kn===this.#Un&&(this.#Kn=null)}async#Gn(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&g===t[e].value.status&&t[e].value.ok){const o=await t[e].value.json();this.#Xn(o.elements)}else this.#Vn=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(Object.freeze(this),this.#Me=new De,t)for(const[e,o]of Object.entries(t))this.#Me[e]&&(this.#Me[e]=o);this.#An=new Map,this.#kn=new Map,this.#Bn=new Map}async loadData(e,o){this.#Qi=o,this.#Vn=!0,this.#Fn=[],this.#_n=t.geoCoder.osmCityAdminLevel.DEFAULT,this.#zn=Object.freeze({hamlet:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet}),village:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village}),city:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city}),town:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town})}),this.#Kn=null,this.#Un=null,this.#An.clear(),this.#kn.clear(),this.#Bn.clear();const s=[];e.forEach((e=>{s.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(s).then((t=>this.#Gn(t)))}get nodes(){return this.#An}get ways(){return this.#kn}get relations(){return this.#Bn}get place(){return this.#Kn}get city(){return this.#Un}get country(){return this.#Fn[2]}get statusOk(){return this.#Vn}}class Oe{#Zn=!1;#V="";#Jn="";#Un="";#qn="";#$n(t,e){t.error||e.error?this.#Zn=!1:(this.#V=e.namedetails.name,e.address.house_number&&(this.#Jn=e.address.house_number+" "),e.address.road?this.#Jn+=e.address.road+" ":e.address.pedestrian&&(this.#Jn+=e.address.pedestrian+" "),this.#Un=t.address.city||t.address.town||t.address.municipality||t.address.village||"",this.#qn=e.address.country,this.#Zn=!0)}constructor(){Object.freeze(this)}async loadData(e){this.#Zn=!1;const o=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1];let s=o+"&zoom=10&addressdetails=1&namedetails=0",i=o+"&zoom=18&addressdetails=1&namedetails=1";const n=t.nominatim.language;n&&"*"!==n&&(s+="&accept-language="+n,i+="&accept-language="+n);const r=new Headers;n&&"*"===n&&r.append("accept-language","");const a=await fetch(s,{headers:r}),l=await fetch(i,{headers:r});g===a.status&&a.ok&&g===l.status&&l.ok?this.#$n(await a.json(),await l.json()):this.#Zn=!1}get name(){return this.#Zn?this.#V:null}get street(){return this.#Zn?this.#Jn:null}get city(){return this.#Zn?this.#Un:null}get country(){return this.#Zn?this.#qn:null}}class je{#V;#Jn;#Un;constructor(t,e,o){Object.freeze(this),this.#V=O.sanitizeToJsString(t),this.#Jn=O.sanitizeToJsString(e),this.#Un=O.sanitizeToJsString(o)}get name(){return this.#V}get street(){return this.#Jn}get city(){return this.#Un}}class Se{static get#Qn(){return Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town)}#Qi;#tr;#er;#or(){let t=this.#er.city||this.#er.country||"";const e=this.#tr.place;e&&e!==t&&(t+=" ("+e+")");let o=(this.#er.street||"").replaceAll(";"," "),s=this.#er.name||"";return(o.includes(s)||t.includes(s))&&(s=""),new je(s,o,t)}#sr(){return["node(around:"+Se.#Qn+","+this.#Qi[0]+","+this.#Qi[1]+")[place];out;"]}async#ir(){return await this.#tr.loadData(this.#sr(),this.#Qi),await this.#er.loadData(this.#Qi),this.#or()}async#nr(t,e){t(await this.#ir())}constructor(){Object.freeze(this),this.#tr=new xe({searchWays:!1,searchRelations:!1,setGeometry:!0}),this.#er=new Oe({searchPlaces:!0,searchWays:!1,searchRelations:!1,setGeometry:!1})}async getAddressAsync(t){return this.#Qi=t,this.#ir()}getAddressWithPromise(t){return this.#Qi=t,new Promise(((t,e)=>this.#nr(t,e)))}}class He{#rr;#ar(t){this.#rr.hideWait();let e=t.street;""!==t.city&&(e+=" "+t.city),this.#rr.setControlsValues({address:e,name:t.name}),this.#rr.updatePreview&&this.#rr.updatePreview({address:e})}constructor(t){Object.freeze(this),this.#rr=t}setAddressWithGeoCoder(t){this.#rr.showWait(),this.#rr.hideError(),(new Se).getAddressWithPromise(t).then((t=>{this.#ar(t)})).catch((t=>{t&&console.error(t),this.#rr.hideWait(),this.#rr.showError(j.getText("NoteDialogGeoCoderHelper - an error occurs when searching the adress"))}))}}class Pe extends mt{#lr=null;#dr=null;constructor(t){super(),W.create("text",{value:j.getText("NoteDialogIconDimsControl - Icon width")},this.controlHTMLElement),this.#lr=W.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:n.width,dataset:{Name:"iconWidth"}},this.controlHTMLElement),W.create("text",{value:j.getText("NoteDialogIconDimsControl - Icon height")},this.controlHTMLElement),this.#dr=W.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:n.height,dataset:{Name:"iconHeight"}},this.controlHTMLElement),this.#lr.addEventListener("input",t.controlInput),this.#dr.addEventListener("input",t.controlInput)}destructor(t){this.#lr.removeEventListener("input",t.controlInput),this.#dr.removeEventListener("input",t.controlInput)}get iconWidth(){return Number.parseInt(this.#lr.value)}set iconWidth(t){this.#lr.value=t}get iconHeight(){return Number.parseInt(this.#dr.value)}set iconHeight(t){this.#dr.value=t}}class Re extends mt{#cr;#hr(e,o){t.noteDialog.theDevil.addButton&&W.create("text",{value:"👿"},W.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(a.fixed)+","+e[1].toFixed(a.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},W.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},o)))}constructor(t,e){super();const o=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#hr(e,o),W.create("text",{value:j.getText("NoteDialogLinkControl - Link")},o),this.#cr=W.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),this.#cr.addEventListener("focus",t.controlFocus),this.#cr.addEventListener("input",t.controlInput),this.#cr.addEventListener("blur",t.urlInputBlur)}destructor(t){this.#cr.removeEventListener("focus",t.controlFocus),this.#cr.removeEventListener("input",t.controlInput),this.#cr.removeEventListener("blur",t.urlInputBlur)}get url(){return this.#cr.value}set url(t){this.#cr.value=t}}class Ae{static get#ur(){return 40}static get#mr(){return 40}constructor(){Object.freeze(this)}getNoteTextAndIconHTML(e,o){const s=W.create("div",{dataset:{ObjId:o.note.objId}}),i=W.create("div",{className:e+(o.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},s);let r=1;O.sanitizeToHtmlElement(o.note.iconContent,i),"TravelNotes-Roadbook-"===e&&i.firstChild&&("svg"===i.firstChild.tagName?(i.firstChild.setAttributeNS(null,"viewBox","0 0 "+n.svgViewboxDim+" "+n.svgViewboxDim),r=t.note.svgIcon.roadbookFactor):i?.firstChild?.classList?.contains("TravelNotes-MapNoteCategory-0073")&&(r=t.note.svgIcon.roadbookFactor)),i.dataset.tanWidth=String(o.note.iconWidth*r)+"px",i.dataset.tanHeight=String(o.note.iconHeight*r)+"px",i.style.width=String(o.note.iconWidth*r)+"px",i.style.height=String(o.note.iconHeight*r)+"px";const a=this.getNoteTextHTML(e,o);return a.className=e+(o.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),s.appendChild(a),s}getNoteTextHTML(t,e){const o=e.note,s=W.create("div");if(0!==o.tooltipContent.length&&O.sanitizeToHtmlElement(o.tooltipContent,W.create("div",{className:t+"NoteHtml-TooltipContent"},s)),0!==o.popupContent.length&&O.sanitizeToHtmlElement(o.popupContent,W.create("div",{className:t+"NoteHtml-PopupContent"},s)),0!==o.address.length&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Address")+"</span> : "+o.address,W.create("div",{className:t+"NoteHtml-Address"},s)),0!==o.url.length&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substring(0,Ae.#ur)+"...</a>",W.create("div",{className:t+"NoteHtml-Url"},s)),0!==o.phone.length){let e=o.phone;if(o.phone.match(/^\+[0-9, ,*,\u0023]*$/)){const t=o.phone.replaceAll(/\u0020/g,""),s=o.phone.replaceAll(/\u0020/g," ");e=j.getText("NoteHTMLViewsFactory - Phone")+" : "+j.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+s+"</a>"+j.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+s+"</a>"}else e=j.getText("NoteHTMLViewsFactory - Phone")+" : "+o.phone;O.sanitizeToHtmlElement(e,W.create("div",{className:t+"NoteHtml-Phone"},s))}if(O.sanitizeToHtmlElement(S.formatLatLng(o.latLng),W.create("div",{className:t+"NoteHtml-LatLng"},s)),e.route){e.route.chain&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+S.formatDistance(o.chainedDistance+o.distance),W.create("div",{className:t+"NoteHtml-TravelDistance"},s)),O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+S.formatDistance(o.distance),W.create("div",{className:t+"NoteHtml-RouteDistance"},s));const i=e.route.notes.next(o.objId);if(i){const e=i.distance-o.distance;Ae.#mr<e&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+S.formatDistance(e),W.create("div",{className:t+"NoteHtml-NextDistance"},s))}}return s}getTravelNotesHTML(t){const e=W.create("div",{className:t+"Travel-Notes"}),o=U.travel.notes.iterator;for(;!o.done;){const s=this.getNoteTextAndIconHTML(t,{note:o.value,route:null});s.className=t+"Travel-Notes-Row",e.appendChild(s)}return e}}const ke=new Ae;class Be{#gr;#pr;constructor(t){Object.freeze(this),this.#pr=t,this.#gr=W.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.#gr.appendChild(ke.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",new Rt(this.#pr,null)))}update(){this.#gr.textContent="",this.#gr.appendChild(ke.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#pr,route:null}))}get HTMLElements(){return[this.#gr]}}class Fe{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){t.stopPropagation(),"url"===t.target.dataset.tanName?this.#vr.focusControl=null:this.#vr.focusControl=t.target}}class _e{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){t.stopPropagation();const e={};"iconWidth"===t.target.dataset.tanName||"iconHeight"===t.target.dataset.tanName?e[t.target.dataset.tanName]=Number.parseInt(t.target.value):e[t.target.dataset.tanName]=t.target.value,this.#vr.updatePreview(e)}}class ze{#rr;#Qi;constructor(t,e){Object.freeze(this),this.#rr=t,this.#Qi=e}handleEvent(t){t.stopPropagation(),new He(this.#rr).setAddressWithGeoCoder(this.#Qi)}}class Ke{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return void this.#vr.hideError();""===O.sanitizeToUrl(t.target.value).errorsString?this.#vr.hideError():this.#vr.showError(j.getText("UrlInputBlurEL - invalidUrl"))}}class Ue{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){if(!this.#vr.focusControl)return;const e=t.currentTarget;let o=this.#vr.focusControl.selectionStart,s=this.#vr.focusControl.selectionEnd;this.#vr.focusControl.value=this.#vr.focusControl.value.slice(0,o)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.#vr.focusControl.value.slice(o,s))+e.dataset.tanHtmlAfter+this.#vr.focusControl.value.slice(s),o===s||0===e.dataset.tanHtmlAfter.length?(o+=e.dataset.tanHtmlBefore.length,s=o):s+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.#vr.focusControl.setSelectionRange(o,s),this.#vr.focusControl.focus();const i={};i[this.#vr.focusControl.dataset.tanName]=this.#vr.focusControl.value,this.#vr.updatePreview(i)}}class Ve{#Tr;#tr;#Lr;#Er(){this.#Lr=document.createElementNS(L,"svg"),this.#Lr.setAttributeNS(null,"viewBox",String(n.svgViewboxDim/4)+" "+n.svgViewboxDim/4+" "+n.svgViewboxDim/2+" "+n.svgViewboxDim/2),this.#Lr.setAttributeNS(null,"class","TravelNotes-SvgIcon")}#br(){let e=-1,o=T,s=T;const i=[];if(this.#Tr.route.itinerary.itineraryPoints.forEach((r=>{e++;const a=ot.addPoints(ot.project(r.latLng,t.note.svgIcon.zoom),this.#Tr.translation);i.push(a);a[0]>=0&&a[1]>=0&&a[0]<=n.svgViewboxDim&&a[1]<=n.svgViewboxDim&&(T===o&&(o=e),s=e)})),T!==o&&T!==s){0<o&&o--,this.#Tr.route.itinerary.itineraryPoints.length-1>s&&s++;let t="";for(e=o;e<=s;e++)t+=i[e][0].toFixed(0)+","+i[e][1].toFixed(0)+" ";const r=document.createElementNS(L,"polyline");r.setAttributeNS(null,"points",t),r.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),r.setAttributeNS(null,"transform","rotate("+this.#Tr.rotation+","+n.svgViewboxDim/2+","+n.svgViewboxDim/2+")"),this.#Lr.appendChild(r)}}#yr(){this.#tr.ways.forEach((e=>{let o=T,s=T,i=-1;const r=[];if(e.nodes.forEach((e=>{i++;const a=this.#tr.nodes.get(e),l=ot.addPoints(ot.project([a.lat,a.lon],t.note.svgIcon.zoom),this.#Tr.translation);r.push(l);l[0]>=0&&l[1]>=0&&l[0]<=n.svgViewboxDim&&l[1]<=n.svgViewboxDim&&(T===o&&(o=i),s=i)})),T!==o&&T!==s){0<o&&o--,e.nodes.length-1>s&&s++;let t="";for(i=o;i<=s;i++)t+=r[i][0].toFixed(0)+","+r[i][1].toFixed(0)+" ";const a=document.createElementNS(L,"polyline");a.setAttributeNS(null,"points",t),a.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),a.setAttributeNS(null,"transform","rotate("+this.#Tr.rotation+","+n.svgViewboxDim/2+","+n.svgViewboxDim/2+")"),this.#Lr.appendChild(a)}}))}#wr(){if(""===this.#Tr.rcnRef)return;const t=document.createElementNS(L,"text");t.textContent=this.#Tr.rcnRef,t.setAttributeNS(null,"x",String(n.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(n.svgViewboxDim/2)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.#Lr.appendChild(t)}constructor(){Object.freeze(this)}buildSvg(t,e,o){this.#Tr=t,this.#tr=o,this.#Er(),this.#br(),this.#yr(),this.#wr(),e.iconContent=this.#Lr.outerHTML}}class We{isMini;isEntry;isExit;constructor(){Object.seal(this),this.isMini=!1,this.isEntry=!1,this.isExit=!1}}class Xe{#Tr;#fr;#tr;#Mr;#Ir;#Nr;#Cr;#Dr;#xr;#Or;#jr;#Sr(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}#Hr(t){const e=5e-6;let o=!1;return this.#Tr.route.wayPoints.forEach((s=>{Math.abs(t.lat-s.lat)<e&&Math.abs(t.lng-s.lng)<e&&(o=!0)})),!o&&(this.#fr.latLng[0]!==t.lat||this.#fr.latLng[1]!==t.lng)}#Pr(){const e=this.#Tr.route.itinerary.itineraryPoints.previous(this.#Tr.nearestItineraryPointObjId,(t=>this.#Hr(t))),s=this.#Tr.route.itinerary.itineraryPoints.next(this.#Tr.nearestItineraryPointObjId,(t=>this.#Hr(t)));let i=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MAX_VALUE,a=Number.MAX_VALUE,l=o.defaultValue;this.#tr.nodes.forEach((o=>{l=Pt.pointsDistance([o.lat,o.lon],this.#fr.latLng),"bike"===this.#Tr.route.itinerary.transitMode&&o?.tags?.rcn_ref&&o.tags["network:type"]&&"node_network"===o.tags["network:type"]&&l<t.note.svgIcon.rcnRefDistance&&l<n&&(this.#Mr=o,n=l),l<i&&(this.#Nr=o.id,i=l),e&&(l=Pt.pointsDistance([o.lat,o.lon],e.latLng),l<r&&(this.#Cr=o.id,r=l)),s&&(l=Pt.pointsDistance([o.lat,o.lon],s.latLng),l<a&&(this.#Dr=o.id,a=l))})),this.#Ir=this.#tr.nodes.get(this.#Nr)}#Rr(){this.#jr.isMini="mini_roundabout"===this?.#Ir?.tags?.highway}#Ar(){this.#Mr&&(this.#Tr.rcnRef=this.#Mr.tags.rcn_ref,this.#fr.tooltipContent+=j.getText("StreetFinder - rcnRef",{rcnRef:this.#Tr.rcnRef}))}#kr(){this.#tr.ways.forEach((t=>{if(!t.nodes.includes(this.#Nr))return;const e=this.#Sr(t),o=""!==e,s=t.nodes.includes(this.#Cr),i=t.nodes.includes(this.#Dr);let n=2*t.nodes.filter((t=>t===this.#Nr)).length;if(t.nodes[0]===this.#Nr&&n--,t.nodes[t.nodes.length-1]===this.#Nr&&n--,s&&(this.#xr=o?e:"???",n--,"roundabout"===t?.tags?.junction&&(this.#jr.isExit=!0)),0!==n&&(i&&(this.#Or=o?e:"???",n--,"roundabout"===t?.tags?.junction&&(this.#jr.isEntry=!0)),0!==n&&o))for(;0!==n;)this.#fr.address=""===this.#fr.address?e:this.#fr.address+" ⪥  "+e,n--}))}#Br(){""!==this.#tr.city&&(this.#fr.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.#tr.city+"</span>"),this.#tr.place&&this.#tr.place!==this.#tr.city&&(this.#fr.address+=" ("+this.#tr.place+")")}#Fr(){r.atStart===this.#Tr.positionOnRoute?(this.#fr.address="🟢 "+this.#Or,this.#Br()):r.atEnd===this.#Tr.positionOnRoute?(this.#Br(),this.#fr.address=this.#xr,this.#Br(),this.#fr.address+=" 🔴 "):(this.#fr.address=this.#xr+(""===this.#fr.address?"":" ⪥  "+this.#fr.address)+" "+this.#Tr.directionArrow+" "+this.#Or,this.#Br())}#_r(){this.#jr.isEntry&&!this.#jr.isExit?this.#fr.tooltipContent+=j.getText("StreetFinder - entry roundabout"):!this.#jr.isEntry&&this.#jr.isExit?this.#fr.tooltipContent+=j.getText("StreetFinder - exit roundabout"):this.#jr.isEntry&&this.#jr.isExit&&(this.#fr.tooltipContent+=j.getText("StreetFinder - continue roundabout")),this.#jr.isMini&&(this.#fr.tooltipContent+=j.getText("StreetFinder - at the small roundabout on the ground"))}constructor(){Object.freeze(this)}findData(t,e,o){this.#Tr=t,this.#fr=e,this.#tr=o,this.#Nr=T,this.#Cr=T,this.#Dr=T,this.#xr="",this.#Or="",this.#jr=new We,this.#Pr(),this.#Rr(),this.#Ar(),this.#kr(),this.#Fr(),this.#_r()}}class Ye{constructor(){Object.freeze(this)}findData(e,o){null!==e.direction&&(e.direction<t.note.svgIcon.angleDirection.right?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂"):e.direction<t.note.svgIcon.angleDirection.slightRight?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn slight right"),e.directionArrow="🢅"):e.direction<t.note.svgIcon.angleDirection.continue?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Continue"),e.directionArrow="🢁"):e.direction<t.note.svgIcon.angleDirection.slightLeft?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn slight left"),e.directionArrow="🢄"):e.direction<t.note.svgIcon.angleDirection.left?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn left"),e.directionArrow="🢀"):e.direction<t.note.svgIcon.angleDirection.sharpLeft?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn sharp left"),e.directionArrow="🢇"):e.direction<t.note.svgIcon.angleDirection.sharpRight?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn sharp right"),e.directionArrow="🢆"):(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂")),r.atStart===e.positionOnRoute?o.tooltipContent=j.getText("ArrowAndTooltipFinder - Start"):r.atEnd===e.positionOnRoute&&(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Stop"))}}class Ge{#Tr;#fr;#zr;#Kr;#Ur;#Vr(){this.#Tr.translation=ot.subtrackPoints([n.svgViewboxDim/2,n.svgViewboxDim/2],ot.project(this.#fr.latLng,t.note.svgIcon.zoom))}#Wr(){this.#zr=this.#Tr.route.itinerary.itineraryPoints.previous(this.#Tr.nearestItineraryPointObjId,(e=>Pt.pointsDistance(e.latLng,this.#fr.latLng)>t.note.svgIcon.angleDistance))||this.#Tr.route.itinerary.itineraryPoints.first}#Xr(){this.#Kr=this.#Tr.route.itinerary.itineraryPoints.next(this.#Tr.nearestItineraryPointObjId,(e=>Pt.pointsDistance(e.latLng,this.#fr.latLng)>t.note.svgIcon.angleDistance))||this.#Tr.route.itinerary.itineraryPoints.last}#Yr(){this.#Ur=ot.addPoints(ot.project(this.#fr.latLng,t.note.svgIcon.zoom),this.#Tr.translation)}#Gr(){if(this.#Tr.nearestItineraryPointObjId!==this.#Tr.route.itinerary.itineraryPoints.first.objId){const o=ot.addPoints(ot.project(this.#zr.latLng,t.note.svgIcon.zoom),this.#Tr.translation);this.#Tr.rotation=Math.atan((this.#Ur[1]-o[1])/(o[0]-this.#Ur[0]))*e.d180/Math.PI,0>this.#Tr.rotation&&(this.#Tr.rotation+=e.d360),this.#Tr.rotation-=e.d270,0>o[0]-this.#Ur[0]&&(this.#Tr.rotation+=e.d180)}}#Zr(){if(this.#Tr.nearestItineraryPointObjId!==this.#Tr.route.itinerary.itineraryPoints.last.objId){const o=ot.addPoints(ot.project(this.#Kr.latLng,t.note.svgIcon.zoom),this.#Tr.translation);for(this.#Tr.direction=Math.atan((this.#Ur[1]-o[1])/(o[0]-this.#Ur[0]))*e.d180/Math.PI,0>o[0]-this.#Ur[0]&&(this.#Tr.direction+=e.d180),this.#Tr.direction-=this.#Tr.rotation;e.d0>this.#Tr.direction;)this.#Tr.direction+=e.d360;for(;e.d360<this.#Tr.direction;)this.#Tr.direction-=e.d360}}#Jr(){this.#Tr.nearestItineraryPointObjId===this.#Tr.route.itinerary.itineraryPoints.first.objId&&(this.#Tr.rotation=-this.#Tr.direction-e.d90,this.#Tr.direction=null,this.#Tr.positionOnRoute=r.atStart),this.#fr.latLng[0]===this.#Tr.route.itinerary.itineraryPoints.last.lat&&this.#fr.latLng[1]===this.#Tr.route.itinerary.itineraryPoints.last.lng&&(this.#Tr.direction=null,this.#Tr.positionOnRoute=r.atEnd)}constructor(){Object.freeze(this)}findData(t,e){this.#Tr=t,this.#fr=e,this.#Vr(),this.#Wr(),this.#Xr(),this.#Yr(),this.#Gr(),this.#Zr(),this.#Jr()}}class Ze{constructor(){Object.seal(this)}iconContent="";tooltipContent="";address="";latLng=[a.defaultValue,a.defaultValue]}class Je{constructor(){Object.seal(this)}nearestItineraryPointObjId=p;route=null;positionOnRoute=r.onRoute;direction=null;directionArrow=" ";rcnRef="";rotation=0;translation=[0,0]}class qe{#fr;#Tr;#tr;#Qn;#qr;static get#$r(){return 1.5}#Qr(){let t=null,e=Number.MAX_VALUE;this.#Tr.route.itinerary.itineraryPoints.forEach((o=>{const s=Pt.pointsDistance(this.#fr.latLng,o.latLng);e>s&&(e=s,t=o)})),this.#fr.latLng=t.latLng,this.#Tr.nearestItineraryPointObjId=t.objId}#ta(){return(new Ge).findData(this.#Tr,this.#fr),(new Ye).findData(this.#Tr,this.#fr),(new Xe).findData(this.#Tr,this.#fr,this.#tr),(new Ve).buildSvg(this.#Tr,this.#fr,this.#tr),this.#qr=!1,this.#fr}async#ea(){if(this.#qr)return null;this.#qr=!0,this.#Tr.nearestItineraryPointObjId=p,this.#Tr.positionOnRoute=r.onRoute,this.#Tr.direction=null,this.#Tr.directionArrow=" ",this.#Tr.translation=[0,0],this.#Tr.rotation=0,this.#Tr.rcnRef="",this.#fr.iconContent="",this.#fr.tooltipContent="",this.#fr.address="",this.#Qr();const t=this.#fr.latLng[0].toFixed(a.fixed)+","+this.#fr.latLng[1].toFixed(a.fixed),e=["way[highway](around:"+(n.svgViewboxDim*qe.#$r).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#Qn+","+t+")[place];out;"];return await this.#tr.loadData(e,this.#fr.latLng),this.#tr.statusOk?this.#ta():null}async#oa(t,e){const o=await this.#ea();o?t(o):e("An error occurs...")}constructor(){Object.freeze(this),this.#fr=new Ze,this.#Tr=new Je,this.#tr=new xe({searchRelations:!1,setGeometry:!1}),this.#Qn=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town),this.#qr=!1}async getIconAndAdressAsync(t,e){return this.#fr.latLng=t,this.#Tr.route=e,this.#ea()}getIconAndAdressWithPromise(t){return this.#fr.latLng=t.latLng,this.#Tr.route=t.route,new Promise(((t,e)=>this.#oa(t,e)))}}class $e{#vr;#sa(t){this.#vr.setControlsValues(t),this.#vr.updatePreview(t)}#ia(){const t=this.#vr.mapIconData;t.route?(this.#vr.showWait(),(new qe).getIconAndAdressWithPromise(t).then((t=>{this.#vr.hideWait(),this.#sa(t)})).catch((t=>{t instanceof Error&&console.error(t),this.#vr.hideWait(),this.#vr.showError(j.getText("IconSelectorChangeEL - an error occurs when creating the SVG icon"))}))):this.#vr.showError(j.getText("IconSelectorChangeEL - not possible to create a SVG icon for a travel note"))}constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){t.stopPropagation();const e=fe.preDefinedIconDataAt(t.target.selectedIndex);"SvgIcon"!==e.icon?this.#sa({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.#ia()}}class Qe{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{fe.loadJson(JSON.parse(e.result)),this.#vr.updateToolbar()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class to{#vr;constructor(t){Object.freeze(this),this.#vr=t}handleEvent(t){t.stopPropagation(),S.openFile(new Qe(this.#vr),".json")}}class eo{#na;#ra;#aa;#la;#da;#ca;#ha;constructor(t,e){Object.freeze(this),this.#na=new Fe(t),this.#ra=new _e(t),this.#aa=new ze(t,e),this.#la=new Ke(t),this.#da=new Ue(t),this.#ca=new $e(t),this.#ha=new to(t)}destructor(){this.#na=null,this.#ra=null,this.#aa=null,this.#la=null,this.#da=null,this.#ca=null,this.#ha=null}get controlFocus(){return this.#na}get controlInput(){return this.#ra}get addressButtonClick(){return this.#aa}get urlInputBlur(){return this.#la}get editionButtonsClick(){return this.#da}get iconSelectorChange(){return this.#ca}get openCfgFileButtonClick(){return this.#ha}}class oo extends ct{#ls;#ds;#pr;#ua;#ma;#ga;#pa;#va;#Ta;#La;#Ea;#qo;#ba;#ya;#Oe(){this.#qo.destructor(this.#ya),this.#ua.destructor(this.#ya),this.#ma.destructor(this.#ya),this.#ga.destructor(this.#ya),this.#pa.destructor(this.#ya),this.#va.destructor(this.#ya),this.#Ta.destructor(this.#ya),this.#La.destructor(this.#ya),this.#ya.destructor()}constructor(t,e){super(),this.#ba=null,this.#ls=t,this.#ds=e,this.#pr=new F,this.#pr.jsonObject=t.jsonObject}createContentHTML(){this.#ya=new eo(this,this.#pr.latLng),this.#qo=new Me(this.#ya),this.#ua=new Pe(this.#ya),this.#ma=new Ne({placeholder:"?????",datasetName:"iconContent",headerText:j.getText("NoteDialogIconControl - Icon content")},this.#ya),this.#ga=new Jt({headerText:j.getText("NoteDialogTooltipControl - Tooltip content"),datasetName:"tooltipContent"},this.#ya),this.#pa=new Ne({rows:t.noteDialog.areaHeight.popupContent,datasetName:"popupContent",headerText:j.getText("NoteDialogPopupControl - Text")},this.#ya),this.#va=new Ce(this.#ya),this.#Ta=new Re(this.#ya,this.#pr.latLng),this.#La=new Jt({headerText:j.getText("NoteDialogPhoneControl - Phone"),datasetName:"phone"},this.#ya),this.#Ea=new Be(this.#pr),this.setControlsValues(this.#pr)}get focusControl(){return this.#ba}set focusControl(t){this.#ba=t}get mapIconData(){return new Ie(this.#pr.latLng,this.#ds)}updatePreview(t){for(const e in t)this.#pr[e]=t[e];this.#Ea.update()}show(){const t=super.show();return""===this.#ls.address&&new He(this).setAddressWithGeoCoder(this.#pr.latLng),t}canClose(){return""===this.#ma.value?(this.showError(j.getText("Notedialog - The icon content cannot be empty")),!1):""===this.#Ta.url||""!==O.sanitizeToUrl(this.#Ta.url).url||(this.showError(j.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this.#Oe(),super.onCancel()}onOk(){super.onOk()&&(this.#ls.iconWidth=this.#ua.iconWidth,this.#ls.iconHeight=this.#ua.iconHeight,this.#ls.iconContent=this.#ma.value,this.#ls.tooltipContent=this.#ga.value,this.#ls.popupContent=this.#pa.value,this.#ls.address=this.#va.address,this.#ls.url=this.#Ta.url,this.#ls.phone=this.#La.value,this.#ls.latLng=this.#pr.latLng,this.#Oe())}get title(){return j.getText("NoteDialog - Note")}get toolbarHTMLElement(){return this.#qo.rootHTMLElement}get contentHTMLElements(){return[this.#ua.controlHTMLElement,this.#ma.controlHTMLElement,this.#ga.controlHTMLElement,this.#pa.controlHTMLElement,this.#va.controlHTMLElement,this.#Ta.controlHTMLElement,this.#La.controlHTMLElement]}get footerHTMLElements(){return this.#Ea.HTMLElements}setControlsValues(t){this.#ua.iconHeight=t.iconHeight||this.#ua.iconHeight,this.#ua.iconWidth=t.iconWidth||this.#ua.iconWidth,this.#ma.value=t.iconContent||this.#ma.value,this.#ga.value=t.tooltipContent||this.#ga.value,this.#pa.value=t.popupContent||this.#pa.value,this.#va.address=t.address||this.#va.address,this.#Ta.url=t.url||this.#Ta.url,this.#La.value=t.phone||this.#La.value}updateToolbar(){this.#qo.update(this.#ya)}}class so{#wa;#fa;constructor(){Object.freeze(this)}createUI(){if(this.#wa)return;this.#wa=W.create("div",{className:"TravelNotes-Background"},document.body);const t=W.create("div",{id:"TravelNotes-WaitUI"},this.#wa);this.#fa=W.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),W.create("div",{className:"TravelNotes-WaitAnimationBullet"},W.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.#fa.textContent=t}close(){document.body.removeChild(this.#wa),this.#wa=null}}const io=new class{#ls=null;#ds=null;#Ma=!0;#Ia=null;#Na(){this.#Ma?this.#ds?(this.#ds.notes.add(this.#ls),this.#ls.chainedDistance=this.#ds.chainedDistance,this.#ds.notes.sort(((t,e)=>t.distance-e.distance)),St.dispatch("showitinerary")):(U.travel.notes.add(this.#ls),St.dispatch("updatetravelnotes")):St.dispatch(this.#ds?"updateitinerary":"updatetravelnotes"),St.dispatch("noteupdated",{removedNoteObjId:this.#ls.objId,addedNoteObjId:this.#ls.objId}),St.dispatch("roadbookupdate")}#vr(){new oo(this.#ls,this.#ds).show().then((()=>this.#Na())).catch((t=>{console.error(t)}))}#Ca(t){this.#Ma=!0,this.#ls=new F,this.#ls.latLng=t,this.#ls.iconLatLng=t}async#Da(t){if(t.tags.rcn_ref?this.#ls.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":this.#ls.iconContent=fe.preDefinedIconDataFromName(t.description),this.#ls.url=t.tags.website||"",this.#ls.phone=t.tags.phone||"",this.#ls.tooltipContent=t.description||"",this.#ls.popupContent=t.tags.name||"",t.tags["addr:street"]&&t.tags["addr:city"])this.#ls.address=(t.tags["addr:housenumber"]?t.tags["addr:housenumber"]+" ":"")+t.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.tags["addr:city"]+"</span>";else{const e=new so;e.createUI(),e.showInfo("Creating address");let o=null;try{o=await(new Se).getAddressAsync([t.lat,t.lon])}catch(t){console.error(t)}e.close(),this.#ls.address=o.street,""!==o.city&&(this.#ls.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+o.city+"</span>")}this.osmSearchNoteDialog||""===this.#ls.iconContent?this.#vr():this.#Na()}constructor(){Object.freeze(this)}get osmSearchNoteDialog(){return null===this.#Ia&&(this.#Ia=t.osmSearch.showSearchNoteDialog),this.#Ia}changeOsmSearchNoteDialog(){this.#Ia=!this.osmSearchNoteDialog}newRouteNote(t,e){this.#ds=kt.getRoute(t);const o=ot.getClosestLatLngDistance(this.#ds,e);this.#Ca(o.latLng),this.#ls.distance=o.distance,this.#vr()}newSearchRouteNote(t){const e=kt.getNearestRouteData([t.lat,t.lon]);e.route?(this.#Ca(e.latLngOnRoute),this.#ls.iconLatLng=[t.lat,t.lon],this.#ls.distance=e.distanceOnRoute,this.#ds=e.route,this.#Da(t)):Ot.showError(j.getText("NoteEditor - No route was found"))}newSearchTravelNote(t){this.#ds=null,this.#Ca([t.lat,t.lon]),this.#Da(t)}newTravelNote(t){this.#ds=null,this.#Ca(t),this.#vr()}editNote(t){this.#Ma=!1;const e=kt.getNoteAndRoute(t);this.#ds=e.route,this.#ls=e.note,this.#vr()}removeNote(t){const e=kt.getNoteAndRoute(t);e.route?(e.route.notes.remove(t),St.dispatch("updateitinerary")):(U.travel.notes.remove(t),St.dispatch("updatetravelnotes")),St.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:p}),St.dispatch("roadbookupdate")}hideNotes(){let t=U.travel.notes.iterator;for(;!t.done;)St.dispatch("removeobject",{objId:t.value.objId});const e=U.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)St.dispatch("removeobject",{objId:t.value.objId});if(p!==U.editedRouteObjId)for(t=U.travel.editedRoute.notes.iterator;!t.done;)St.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();const t=U.travel.notes.iterator;for(;!t.done;)St.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:t.value.objId});const e=U.travel.routes.iterator;for(;!e.done;)e.value.hidden||St.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){const e=kt.getNoteAndRoute(t).note,o=kt.getNearestRouteData(e.latLng);o.route&&(U.travel.notes.remove(t),e.distance=o.distance,e.latLng=o.latLngOnRoute,e.chainedDistance=o.route.chainedDistance,o.route.notes.add(e),o.route.notes.sort(((t,e)=>t.distance-e.distance)),St.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),St.dispatch("updateitinerary"),St.dispatch("updatetravelnotes"),St.dispatch("roadbookupdate"))}detachNoteFromRoute(t){const e=kt.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=o.invalid,e.note.chainedDistance=o.defaultValue,U.travel.notes.add(e.note),St.dispatch("updateitinerary"),St.dispatch("updatetravelnotes"),St.dispatch("roadbookupdate")}travelNoteDropped(t,e,o){U.travel.notes.moveTo(t,e,o),St.dispatch("updatetravelnotes"),St.dispatch("roadbookupdate")}};class no{#xa=[];#Oa(t){this.#xa.push(t.latLng),this.#xa.push(t.iconLatLng)}#ja(t){t.itinerary.itineraryPoints.forEach((t=>this.#xa.push(t.latLng))),t.notes.forEach((t=>this.#Oa(t)))}constructor(){Object.freeze(this)}zoomToLatLng(t){St.dispatch("zoomto",{latLng:t})}zoomToNote(t){this.#xa=[],this.#Oa(kt.getNoteAndRoute(t).note),St.dispatch("zoomto",{geometry:[this.#xa]})}zoomToRoute(t){this.#xa=[],this.#ja(kt.getRoute(t)),St.dispatch("zoomto",{geometry:[this.#xa]})}zoomToTravel(){this.#xa=[],U.travel.routes.forEach((t=>this.#ja(t))),p!==U.travel.editedRouteObjId&&this.#ja(U.travel.editedRoute),U.travel.notes.forEach((t=>this.#Oa(t))),St.dispatch("zoomto",{geometry:[this.#xa]})}zoomToPoi(t){St.dispatch("zoomto",t)}}class ro extends Ee{constructor(t,e){super(t,e)}get menuItems(){return[new be(j.getText("ProfileContextMenu - Add a note to the route at this point"),!0,(()=>io.newRouteNote(this.targetObjId,this.latLng))),new be(j.getText("ProfileContextMenu - Zoom to this point"),!0,(()=>(new no).zoomToLatLng(this.latLng)))]}}class ao{constructor(){Object.freeze(this)}getlatLngElevOnRouteAtMousePosition(t){const e=kt.getRoute(Number.parseInt(t.currentTarget.dataset.tanObjId)),o=t.currentTarget.getBoundingClientRect(),s=(t.clientX-o.x-de.PROFILE_MARGIN/(2*de.PROFILE_MARGIN+de.PROFILE_WIDTH)*o.width)/(de.PROFILE_WIDTH/(2*de.PROFILE_MARGIN+de.PROFILE_WIDTH)*o.width)*e.distance;return 0<s&&s<e.distance?ot.getLatLngElevAtDist(e,s):null}}class lo extends ao{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();const e=this.getlatLngElevOnRouteAtMousePosition(t);e&&(t.latlng={lat:e.latLng[0],lng:e.latLng[1]},new ro(t).show())}}class co{constructor(){Object.freeze(this)}handleEvent(t){t.preventDefault(),t.stopPropagation(),St.dispatch("removeobject",{objId:Number.parseInt(t.currentTarget.dataset.tanMarkerObjId)})}}class ho extends ao{#Sa;#Ha;#Pa;#Ra;#Aa;#ka;#Ba;#Fa(t,e){const o=document.createElementNS(L,"text");return o.appendChild(document.createTextNode(t)),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),o.setAttributeNS(null,"x",this.#ka),o.setAttributeNS(null,"y",e),o.setAttributeNS(null,"text-anchor",this.#Aa),this.#Ba.appendChild(o),o}constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.#Ba=t.currentTarget;const e=this.getlatLngElevOnRouteAtMousePosition(t);if(e){const o=Number.parseInt(this.#Ba.dataset.tanMarkerObjId);St.dispatch("removeobject",{objId:o}),St.dispatch("additinerarypointmarker",{objId:o,latLng:e.latLng}),this.#Sa&&this.#Ba.contains(this.#Sa)?(this.#Ba.removeChild(this.#Sa),this.#Ba.removeChild(this.#Ha),this.#Ba.removeChild(this.#Pa),this.#Ba.removeChild(this.#Ra)):(this.#Sa=null,this.#Ha=null,this.#Pa=null,this.#Ra=null);const s=this.#Ba.getBoundingClientRect();this.#ka=(2*de.PROFILE_MARGIN+de.PROFILE_WIDTH)*(t.clientX-s.x)/s.width;const i=de.PROFILE_MARGIN+de.PROFILE_HEIGHT;this.#Sa=document.createElementNS(L,"polyline"),this.#Sa.setAttributeNS(null,"points",String(this.#ka)+","+de.PROFILE_MARGIN+" "+this.#ka+","+i),this.#Sa.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.#Ba.appendChild(this.#Sa);const n=kt.getRoute(Number.parseInt(this.#Ba.dataset.tanObjId));this.#Aa=e.distance>n.distance/2?"end":"start",this.#ka+=e.distance>n.distance/2?-de.X_DELTA_TEXT:de.X_DELTA_TEXT,this.#Ha=this.#Fa(S.formatDistance(e.distance),de.PROFILE_MARGIN+de.Y_DELTA_TEXT),this.#Pa=this.#Fa("Alt. "+e.elev.toFixed(0)+" m.",de.PROFILE_MARGIN+2*de.Y_DELTA_TEXT),this.#Ra=this.#Fa("Pente "+e.ascent.toFixed(0)+" % ",de.PROFILE_MARGIN+3*de.Y_DELTA_TEXT)}}}class uo extends le{#mi=null;#_a;#za;#Ka=null;#Ua=null;#Va=null;#Wa=b.nextObjId;#Xa;#Ya(){this.#mi&&(this.#mi.removeEventListener("contextmenu",this.#Ka,!1),this.#mi.removeEventListener("mousemove",this.#Ua,!1),this.#mi.removeEventListener("mouseleave",this.#Va,!1),this.#mi=null,St.dispatch("removeobject",{objId:this.#Wa}),this.#za.textContent="")}setContent(t){this.#Xa=t.objId,this.#Ya(),this.#mi=(new de).createSvg(t),this.#mi.dataset.tanObjId=t.objId,this.#mi.dataset.tanMarkerObjId=this.#Wa,this.#mi.addEventListener("contextmenu",this.#Ka,!1),this.#mi.addEventListener("mousemove",this.#Ua,!1),this.#mi.addEventListener("mouseleave",this.#Va,!1),this.#_a.appendChild(this.#mi),this.#za.textContent=j.getText("ProfileWindow - Route {name} : Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{name:t.computedName,ascent:t.itinerary.ascent.toFixed(0),descent:t.itinerary.descent.toFixed(0),distance:S.formatDistance(t.distance)})}constructor(){super(),this.#Ka=new lo,this.#Ua=new ho,this.#Va=new co,this.#_a=W.create("div",{className:"TravelNotes-ProfileDialog-SvgContainer"}),this.#za=W.create("div")}createContentHTML(){}onCancel(){this.#Ya(),super.onCancel(),St.dispatch("profileclosed",{objId:this.#Xa})}show(){super.show(),this.mover.moveDialogToTopLeft()}get contentHTMLElements(){return[this.#_a,this.#za]}get title(){return j.getText("ProfileWindow - Profile")}}class mo{#ds;#Ga;#Za;get#Ja(){return t.route.elev.smoothPoints}#qa(){this.#Za=[],this.#Za.push({distance:0,elev:this.#ds.itinerary.itineraryPoints.first.elev,smoothElev:this.#ds.itinerary.itineraryPoints.first.elev});const t=this.#ds.itinerary.itineraryPoints.iterator;t.done;let e=0,o=t.value.distance,s=t.value.elev;t.done;let i=this.#Ga;for(;i<this.#ds.distance;){if(o<i)for(e=o,s=t.value.elev;o<i;)o+=t.value.distance,t.done;const n=s+(i-e)*((t.value.elev-s)/(o-e));this.#Za.push({distance:i,elev:n,smoothElev:0}),i+=this.#Ga}this.#Za.push({distance:this.#ds.distance,elev:this.#ds.itinerary.itineraryPoints.last.elev,smoothElev:this.#ds.itinerary.itineraryPoints.last.elev})}#$a(){let t=(this.#Za[this.#Ja-1].elev-this.#Za[0].elev)/(this.#Ja-1),e=0;for(e=0;e<this.#Ja;e++)this.#Za[e].smoothElev=this.#Za[0].elev+t*e;for(e=this.#Ja;e<this.#Za.length-this.#Ja;e++){let t=0;for(let o=e-this.#Ja;o<=e+this.#Ja;o++)t+=this.#Za[o].elev;this.#Za[e].smoothElev=t/(2*this.#Ja+1)}e--;const o=(this.#Za[e+this.#Ja].smoothElev-this.#Za[e].smoothElev)/this.#Ja;let s=this.#Za[e].smoothElev,i=1;for(e++;e<this.#Za.length-1;i++,e++)this.#Za[e].smoothElev=s+o*i}#Qa(){const e=this.#ds.itinerary.itineraryPoints.iterator;let o=0;for(;!e.done;)o+=e.next?Math.abs(e.value.elev-e.next.elev):0;this.#Ga=Math.floor(Math.min(t.route.elev.smoothCoefficient*this.#ds.distance/o,this.#ds.distance/(3*this.#Ja)))}#tl(){const t=this.#ds.itinerary.itineraryPoints.iterator;t.done;let e=t.value.distance;for(;!t.done;){const o=this.#Za[Math.floor(e/this.#Ga)],s=this.#Za[Math.ceil(e/this.#Ga)];if(o&&s){const i=e-o.distance,n=(s.elev-o.elev)/(s.distance-o.distance);t.value.elev=o.elev+i*n}e+=t.value.distance}}constructor(){Object.freeze(this)}smooth(t){this.#ds=t,this.#Qa(),this.#qa(),this.#$a(),this.#tl()}}const go=new class{#el=new Map;constructor(){Object.freeze(this)}createProfile(e){const o=this.#el.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new mo).smooth(e);let s=0,i=0,n=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let e=t.elev-n;0>e?i-=e:s+=e,n=t.elev})),e.itinerary.ascent=s,e.itinerary.descent=i,o&&o.setContent(e)}else o&&o.onCancel()}updateProfile(t,e){const o=this.#el.get(t);o&&(this.#el.delete(t),e&&e.itinerary.hasProfile?(o.setContent(e),this.#el.set(e.objId,o)):o.onCancel())}deleteProfile(t){const e=this.#el.get(t);e&&e.onCancel()}deleteAllProfiles(){this.#el.forEach((t=>t.onCancel()))}showProfile(t){const e=kt.getRoute(t);let o=this.#el.get(t);o||(o=new uo),o.setContent(e),o.show(),this.#el.set(t,o)}onProfileClosed(t){this.#el.delete(t)}};class po{constructor(){Object.seal(this)}bottomLeft;upperRight;entryPoint;exitPoint}class vo{#ol;#ds;#sl;#il(t,e,o){return e.lng===o.lng?new $(e.lat>o.lat?t.bottomLeft.lat:t.upperRight.lat,e.lng):e.lat===o.lat?new $(e.lat,e.lng<o.lng?t.upperRight.lng:t.bottomLeft.lng):null}#nl(t,e){const o=1e-6;return e.lat-t.bottomLeft.lat<o||t.upperRight.lat-e.lat<o||e.lng-t.bottomLeft.lng<o||t.upperRight.lng-e.lng<o?$.clone(e):null}#rl(t,e,o){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){const t=Math.min(Math.abs(this.#sl.height/(o.lat-e.lat)),Math.abs(this.#sl.width/(o.lng-e.lng)));return new $(e.lat+t*(o.lat-e.lat),e.lng+t*(o.lng-e.lng))}return null}#al(t,e,o){let s=this.#rl(t,e,o);if(s)return s;if(s=this.#nl(t,e),s)return s;if(s=this.#il(t,e,o),s)return s;const i=(e.lat-o.lat)/(e.lng-o.lng),n=e.lat-i*e.lng;if(s=new $(i*t.upperRight.lng+n,t.upperRight.lng),s.lat<=t.upperRight.lat&&s.lat>=t.bottomLeft.lat&&s.lng<o.lng)return s;if(s=new $(t.upperRight.lat,(t.upperRight.lat-n)/i),s.lng>=t.bottomLeft.lng&&s.lng<=t.upperRight.lng&&s.lat<o.lat)return s;if(s=new $(i*t.bottomLeft.lng+n,t.bottomLeft.lng),s.lat<=t.upperRight.lat&&s.lat>=t.bottomLeft.lat&&s.lng>o.lng)return s;if(s=new $(t.bottomLeft.lat,(t.bottomLeft.lat-n)/i),s.lng>=t.bottomLeft.lng&&s.lng<=t.upperRight.lng&&s.lat>o.lat)return s;throw new Error("intermediate point not found")}#ll(){this.#ol=[];const t=this.#ds.itinerary.itineraryPoints.iterator;let e=t.done,o=new po;o.bottomLeft=$.clone(t.value),o.upperRight=$.clone(t.value),o.entryPoint=$.clone(t.value);let s=t.value,i=$.clone(t.value);e=t.done;let n=t.value;for(;!e;){const r=new po;r.bottomLeft=new $(Math.min(o.bottomLeft.lat,n.lat),Math.min(o.bottomLeft.lng,n.lng)),r.upperRight=new $(Math.max(o.upperRight.lat,n.lat),Math.max(o.upperRight.lng,n.lng)),r.entryPoint=$.clone(o.entryPoint),this.#sl.height>r.upperRight.lat-r.bottomLeft.lat&&this.#sl.width>r.upperRight.lng-r.bottomLeft.lng?(o=r,s=t.value,i=$.clone(t.value),e=t.done,n=t.value,e&&(o.exitPoint=i,this.#ol.push(Object.freeze(o)))):(i=this.#al(o,s,n),o.bottomLeft=new $(Math.min(o.bottomLeft.lat,i.lat),Math.min(o.bottomLeft.lng,i.lng)),o.upperRight=new $(Math.max(o.upperRight.lat,i.lat),Math.max(o.upperRight.lng,i.lng)),o.exitPoint=i,this.#ol.push(Object.freeze(o)),o=new po,o.bottomLeft=$.clone(i),o.upperRight=$.clone(i),o.entryPoint=$.clone(i))}}constructor(t,e){Object.freeze(this),this.#ds=t,this.#sl=e,this.#ll()}get printViews(){return this.#ol}}class To{#Et;#Ln;constructor(t,e){Object.freeze(this),this.#Et=t,this.#Ln=e}get width(){return this.#Et}get height(){return this.#Ln}}class Lo{#ae;#bt;#dl;constructor(t){if("string"!=typeof t?.text||"string"!=typeof t?.color||"string"!=typeof t?.backgroundColor)throw new Error("invalid toolbar for layer");Object.freeze(this),this.#ae=O.sanitizeToJsString(t.text),this.#bt=O.sanitizeToColor(t.color),this.#dl=O.sanitizeToColor(t.backgroundColor)}get text(){return this.#ae}get color(){return this.#bt}get backgroundColor(){return this.#dl}}class Eo{#V=null;#cl=null;#g=null;#hl=null;#ul=null;#ml=null;#gl=null;#pl=null;#kt=null;#vl=!1;#Tl=null;#Ll=null;#El(){if("string"!=typeof this.#Ll?.name)throw new Error("invalid name for layer");this.#V=O.sanitizeToJsString(this.#Ll.name)}#bl(){if("wms"!==this.#Ll?.service&&"wmts"!==this.#Ll?.service)throw new Error("invalid service for layer "+this.#V);this.#cl=this.#Ll.service}#yl(){if("string"!=typeof this.#Ll?.url)throw new Error("invalid url for layer "+this.#V);this.#g=this.#Ll.url}#wl(){if("wms"===this.#cl){if("string"!=typeof this.#Ll?.wmsOptions?.layers||"string"!=typeof this.#Ll?.wmsOptions?.format||"boolean"!=typeof this.#Ll?.wmsOptions?.transparent)throw new Error("invalid wmsOptions for layer "+this.#V);this.#hl=this.#Ll.wmsOptions,this.#hl.layers=O.sanitizeToJsString(this.#hl.layers),this.#hl.format=O.sanitizeToJsString(this.#hl.format)}}#fl(){try{this.#Ll.bounds&&"number"==typeof this.#Ll.bounds[0][0]&&"number"==typeof this.#Ll.bounds[0][1]&&"number"==typeof this.#Ll.bounds[1][0]&&"number"==typeof this.#Ll.bounds[1][1]&&(this.#ul=this.#Ll.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.#V)}}#Ml(){if(this.#Ll.minZoom){if("number"!=typeof this.#Ll.minZoom)throw new Error("invalid minZoom for layer "+this.#V);this.#ml=this.#Ll.minZoom}if(this.#Ll.maxZoom){if("number"!=typeof this.#Ll.maxZoom)throw new Error("invalid maxZoom for layer "+this.#V);this.#gl=this.#Ll.maxZoom}}#Il(){this.#pl=new Lo(this.#Ll.toolbar)}#Nl(){if("string"!=typeof this.#Ll?.providerName)throw new Error("invalid providerName for layer "+this.#V);this.#kt=O.sanitizeToJsString(this.#Ll.providerName)}#Cl(){if("boolean"!=typeof this.#Ll.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.#V);this.#vl=this.#Ll.providerKeyNeeded}#Dl(){if(""===this.#Ll.attribution)this.#Tl="";else{if("string"!=typeof this.#Ll?.attribution)throw new Error("invalid attribution for map layer "+this.#V);this.#Tl=O.sanitizeToHtmlString(this.#Ll.attribution).htmlString}}constructor(t){Object.freeze(this),this.#Ll=t,this.#El(),this.#bl(),this.#yl(),this.#wl(),this.#fl(),this.#Ml(),this.#Il(),this.#Nl(),this.#Cl(),this.#Dl(),this.#Ll=null}get name(){return this.#V}get service(){return this.#cl}get url(){return this.#g}get wmsOptions(){return this.#hl}get bounds(){return this.#ul}get minZoom(){return this.#ml}get maxZoom(){return this.#gl}get toolbarButtonData(){return this.#pl}get providerName(){return this.#kt}get providerKeyNeeded(){return this.#vl}get attribution(){return this.#Tl}}const bo=new class{#xl;#Ol;#jl;constructor(){Object.freeze(this),this.#xl=new Map,this.#jl=!1,this.#Ol=new Eo({service:"wmts",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.#xl.set(this.#Ol.name,this.#Ol)}getMapLayer(t){let e=this.#xl.get(t)||this.#Ol;return e.providerKeyNeeded&&(Ht.hasKey(e.providerName.toLowerCase())||(e=this.#Ol)),e}forEach(t){this.#xl.forEach(t)}addMapLayers(t){this.#jl||(t.forEach((t=>{const e=new Eo(t);this.#xl.get(e.name)||this.#xl.set(e.name,e)})),this.#jl=!0)}get defaultMapLayer(){return this.#Ol}};class yo{constructor(){Object.freeze(this)}handleEvent(){window.print()}}class wo{#Sl=null;constructor(t){Object.freeze(this),this.#Sl=t}handleEvent(){this.#Sl.onAfterPrint(),this.#Sl=null}}class fo{#Hl;#ds;#ol;#Pl;#Rl;#Te;#Al;#kl;#Bl;#Fl;#_l;onAfterPrint(){this.#kl.forEach((t=>document.body.removeChild(t))),this.#kl.length=0,this.#Rl.removeEventListener("click",this.#Fl,!1),this.#Te.removeEventListener("click",this.#_l,!1),document.body.removeChild(this.#Pl);const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");U.map.invalidateSize(!1),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name),window.removeEventListener("afterprint",this.#_l,!0),this.#_l=null,this.#Fl=null}#zl(){const t=bo.getMapLayer(U.travel.layerName),e=Ht.getUrl(t),o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);return o.options.attribution=O.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,o}#Kl(){const t=[];return this.#ds.notes.forEach((e=>{const o=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),s=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});t.push(s)})),t}#Ul(e){this.#Al++;const o="TravelNotes-RouteViewDiv"+this.#Al,s=document.createElement("div");s.className="TravelNotes-routeViewDiv",s.id=o,document.body.appendChild(s),this.#kl.push(s),s.style.width=String(this.#Hl.paperWidth)+"mm",s.style.height=String(this.#Hl.paperHeight)+"mm";const i=this.#Hl.printNotes?this.#Kl():[];i.push(this.#zl()),i.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),i.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),i.push(this.#Bl),window.L.map(o,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.#Hl.zoomFactor,minZoom:this.#Hl.zoomFactor,maxZoom:this.#Hl.zoomFactor,layers:i})}#Vl(){this.#Pl=W.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.#Rl=W.create("div",{className:"TravelNotes-UI-Button",title:j.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.#Pl),this.#Rl.addEventListener("click",this.#Fl,!1),this.#Te=W.create("div",{className:"TravelNotes-UI-Button",title:j.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.#Pl),this.#Te.addEventListener("click",this.#_l,!1)}constructor(t,e,o){Object.freeze(this),this.#ds=t,this.#ol=e,this.#Hl=o,this.#Al=0,this.#kl=[],this.#Fl=new yo,this.#_l=new wo(this)}preparePage(){this.#Hl.firefoxBrowser?document.body.classList.add("TravelNotes-Maps-FirefoxBrowser"):document.body.classList.remove("TravelNotes-Maps-FirefoxBrowser");const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===U.travel.name?"maps":U.travel.name+" - "+this.#ds.computedName+" - maps",this.#Vl(),window.addEventListener("afterprint",this.#_l,!0);const e=[],o=this.#ds.itinerary.itineraryPoints.iterator;for(;!o.done;)e.push(o.value.latLng);this.#Bl=window.L.polyline(e,{color:this.#ds.color,weight:this.#ds.width,dashArray:this.#ds.dashString}),this.#Al=0,this.#ol.forEach((t=>this.#Ul(t)))}}class Mo{#Wl=0;static get#Xl(){return 256}#Yl(t){const e=W.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm";const o=ot.screenCoordToLatLng(0,0),s=ot.screenCoordToLatLng(e.clientWidth,e.clientHeight);this.#Wl=Math.ceil(e.clientWidth/Mo.#Xl)*Math.ceil(e.clientHeight/Mo.#Xl),document.body.removeChild(e);const i=U.map.getZoomScale(U.map.getZoom(),t.zoomFactor);return new To(Math.abs(o[1]-s[1])*i,Math.abs(o[0]-s[0])*i)}constructor(){Object.freeze(this)}print(e,o){const s=kt.getRoute(o);if(!s)return;const i=new vo(s,this.#Yl(e));if(t.printRouteMap.maxTiles<i.printViews.length*this.#Wl)return void Ot.showError(j.getText("RoutePrinter - The maximum of allowed pages is reached."));new fo(s,i.printViews,e).preparePage()}}class Io{static marker=null;static initialLatLng=null}class No{static handleEvent(){Io.marker&&(window.L.DomEvent.off(Io.marker),U.map.removeLayer(Io.marker),Io.marker=null)}}const Co=new class{constructor(){Object.freeze(this)}addRoute(){const t=new _;U.travel.routes.add(t),this.chainRoutes(),l.editedChanged===U.travel.editedRoute.editionStatus?(St.dispatch("setrouteslist"),St.dispatch("roadbookupdate")):this.editRoute(t.objId)}editRoute(t){const e=kt.getRoute(t),o=e.itinerary.provider,s=U.providers.get(o.toLowerCase());if(o&&""!==o&&(!s||s.providerKeyNeeded&&!Ht.hasKey(o)))return void Ot.showError(j.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));p!==U.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&St.dispatch("setprovider",{provider:o});const i=e.itinerary.transitMode;i&&""!==i&&St.dispatch("settransitmode",{transitMode:i}),U.travel.editedRoute=new _,e.editionStatus=l.editedNoChange,U.travel.editedRoute.jsonObject=e.jsonObject,U.editedRouteObjId=e.objId,U.travel.editedRoute.hidden=!1,e.hidden=!1,go.updateProfile(U.editedRouteObjId,U.travel.editedRoute),this.chainRoutes(),St.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:U.travel.editedRoute.objId}),St.dispatch("roadbookupdate"),St.dispatch("showitinerary"),St.dispatch("setrouteslist")}removeRoute(t){let e=t;e!==U.editedRouteObjId&&e!==U.travel.editedRoute.objId||(e=U.editedRouteObjId,this.cancelEdition()),St.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:p}),U.travel.routes.remove(e),go.deleteProfile(e),this.chainRoutes(),St.dispatch("roadbookupdate"),St.dispatch("setrouteslist")}saveGpx(t){(new Bt).routeToGpx(t)}chainRoutes(){const t=U.travel.routes.iterator;let e=o.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=o.defaultValue;const s=t.value.notes.iterator;for(;!s.done;)s.value.chainedDistance=t.value.chainedDistance;if(t.value.objId===U.editedRouteObjId){U.travel.editedRoute.chainedDistance=U.travel.editedRoute.chain?t.value.chainedDistance:o.defaultValue;const e=U.travel.editedRoute.notes.iterator;for(;!e.done;)e.value.chainedDistance=U.travel.editedRoute.chainedDistance}}}saveEdition(){const t=new _;t.jsonObject=U.travel.editedRoute.jsonObject,U.travel.routes.replace(U.editedRouteObjId,t),U.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){No.handleEvent();const t=kt.getRoute(U.editedRouteObjId);t.editionStatus=l.notEdited,go.updateProfile(U.travel.editedRoute.objId,t),St.dispatch("routeupdated",{removedRouteObjId:U.travel.editedRoute.objId,addedRouteObjId:U.editedRouteObjId}),U.editedRouteObjId=p,U.travel.editedRoute=new _,this.chainRoutes(),St.dispatch("roadbookupdate"),St.dispatch("setrouteslist"),St.dispatch("showitinerary")}routeProperties(t){const e=kt.getRoute(t);new $t(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&St.dispatch("routepropertiesupdated",{routeObjId:e.objId}),St.dispatch("roadbookupdate"),St.dispatch("setrouteslist"),St.dispatch("updateitinerary")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new ee).show().then((e=>(new Mo).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){kt.getRoute(t).hidden=!1,St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:t}),St.dispatch("setrouteslist")}hideRoute(t){kt.getRoute(t).hidden=!0,St.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:p}),St.dispatch("setrouteslist")}showRoutes(){const t=U.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:t.value.objId}));St.dispatch("setrouteslist")}hideRoutes(){const t=U.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===U.editedRouteObjId||(t.value.hidden=!0,St.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:p}));St.dispatch("setrouteslist")}};class Do{static get#Gl(){return.5}static get#Zl(){return 5}static get#Jl(){return 10}static get#ql(){return 31}static get#$l(){return 32}static get#Ql(){return 63}#td(t){return Math.floor(Math.abs(t)+Do.#Gl)*(0<=t?1:-1)}#ed(t,e,o){const s=this.#td(t*o),i=this.#td(e*o);let n=s-i;n<<=1,0>s-i&&(n=~n);let r="";for(;Do.#$l<=n;)r+=String.fromCharCode((Do.#$l|n&Do.#ql)+Do.#Ql),n>>=Do.#Zl;return r+=String.fromCharCode(n+Do.#Ql),r}#n;#od(t){let e=null,o=0,s=0;do{e=t.charCodeAt(this.#n++)-Do.#Ql,s|=(e&Do.#ql)<<o,o+=Do.#Zl}while(Do.#$l<=e);return 1&s?~(s>>1):s>>1}constructor(){Object.freeze(this)}encode(t,e){if(!t.length)return"";const o=e.length,s=Array.from(e,(t=>Math.pow(Do.#Jl,t)));let i="";for(let e=0;e<o;e++)i+=this.#ed(t[0][e],0,s[e]);for(let e=1;e<t.length;e++){const n=t[e],r=t[e-1];for(let t=0;t<o;t++)i+=this.#ed(n[t],r[t],s[t])}return i}decode(t,e){const o=e.length;if(!t||0===t.length)return[];this.#n=0;const s=[],i=Array.from(e,(t=>Math.pow(Do.#Jl,t))),n=new Array(o).fill(0);for(;this.#n<t.length;){const e=new Array(o).fill(0);for(let s=0;s<o;s++)n[s]+=this.#od(t),e[s]=n[s]/i[s];s.push(e)}return s}}class xo{#sd(t){const e={values:"",objType:(new A).objType.jsonObject},o=[];t.itinerary.itineraryPoints.forEach((t=>{o.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),e.values=(new Do).encode(o,[a.fixed,a.fixed,2,2,0]),t.itinerary.itineraryPoints=e}#id(t){const e=[];if(t.itinerary.itineraryPoints.values)(new Do).decode(t.itinerary.itineraryPoints.values,[a.fixed,a.fixed,2,2,0]).forEach((i=>{const n={lat:a.defaultValue,lng:a.defaultValue,distance:o.defaultValue,elev:s.defaultValue,objId:p};[n.lat,n.lng,n.distance,n.elev,n.objId]=i,n.objType=t.itinerary.itineraryPoints.objType,e.push(n)}));else{t.itinerary.itineraryPoints.latLngs=(new Do).decode(t.itinerary.itineraryPoints.latLngs,[a.fixed,a.fixed]);let o=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{const n={};n.lat=i[0],n.lng=i[1],n.distance=t.itinerary.itineraryPoints.distances[o],t.itinerary.itineraryPoints.elevs?n.elev=t.itinerary.itineraryPoints.elevs[o]:n.elev=s.defaultValue,n.objId=t.itinerary.itineraryPoints.objIds[o],n.objType=t.itinerary.itineraryPoints.objType,e.push(n),o++}))}t.itinerary.itineraryPoints=e}constructor(){Object.freeze(this)}decompress(t){t.routes.forEach(this.#id),t.editedRoute&&this.#id(t.editedRoute)}compress(t){const e=t.jsonObject;return e.routes.forEach((t=>this.#sd(t))),this.#sd(e.editedRoute),e}}class Oo{constructor(){Object.freeze(this)}openDistantFile(t){(new xo).decompress(t),U.travel.jsonObject=t,U.travel.readOnly=!0,document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name);const e=U.travel.routes.iterator;for(;!e.done;)l.notEdited===e.value.editionStatus?St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:e.value.objId}):U.editedRouteObjId=e.value.objId;p!==U.editedRouteObjId&&St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:U.travel.editedRoute.objId});const o=U.travel.notes.iterator;for(;!o.done;)St.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:o.value.objId});(new no).zoomToTravel()}}const jo=new class{#Vo=null;constructor(){Object.freeze(this)}createUI(){this.#Vo=W.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){const e='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.#Vo.firstChild;)this.#Vo.removeChild(this.#Vo.firstChild);O.sanitizeToHtmlElement(e,this.#Vo)}};const So=new class{constructor(){Object.freeze(this)}setMapLayer(t){const e=bo.getMapLayer(t);St.dispatch("layerchange",{layer:e}),jo.attributions=e.attribution,U.travel.layerName=e.name}};class Ho{toolbarItemsArray;constructor(){Object.seal(this),this.toolbarItemsArray=[]}}class Po{#nd;constructor(t){Object.freeze(this),this.#nd=t}handleEvent(t){this.#nd.toolbarItemsArray[Number.parseInt(t.target.dataset.tanItemId)].action()}}class Ro{#rd;#nd;#ad;static get#ld(){return 5}constructor(t,e){Object.freeze(this),this.#rd=t,this.#nd=e}handleEvent(t){switch(t.type){case"touchstart":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);this.#ad=e.screenY}break;case"touchend":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);Ro.#ld>Math.abs(e.screenY-this.#ad)&&(t.stopPropagation(),this.#nd.toolbarItemsArray[Number.parseInt(t.target.dataset.tanItemId)].action(),this.#rd.hide())}}}}class Ao{#dd;constructor(){Object.freeze(this),this.#dd=Number.MAX_VALUE}handleEvent(t){switch(t.type){case"touchstart":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);this.#dd=e.screenY}break;case"touchmove":case"touchend":if(1===t.changedTouches.length){const e=t.changedTouches.item(0),o=this.#dd-e.screenY;t.currentTarget.scrollTop+=o,this.#dd=e.screenY}break;default:this.#dd=Number.MAX_VALUE}"touchend"===t.type&&(this.#dd=Number.MAX_VALUE)}}class ko{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.currentTarget.scrollTop+=t.deltaY*v[t.deltaMode])}}class Bo{#To;#cd;#Xo;#hd;#ud;#md;#gd;#pd;#nd;static get#vd(){return 100}#Td;#Ld(t,e){const o=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonHTMLElement",textContent:t.textContent,title:t.title,dataset:{ItemId:e}},this.#cd);o.addEventListener("click",this.#md,!1),o.addEventListener("touchstart",this.#gd,!1),o.addEventListener("touchend",this.#gd,!1)}#Ed(t){const e=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonHTMLElement",title:t.title},this.#cd);W.create("text",{value:t.textContent},W.create("a",{className:"TravelNotes-BaseToolbar-ButtonLinkHTMLElement",href:t.action,target:"_blank"},e))}#qe(){this.#cd=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonsHTMLElement"},this.#To),this.#nd.toolbarItemsArray=[],this.addToolbarItems(),this.#nd.toolbarItemsArray.forEach(((t,e)=>{t.isCommand()?this.#Ld(t,e):this.#Ed(t)})),this.#cd.addEventListener("wheel",this.#hd,{passive:!0}),this.#cd.addEventListener("touchstart",this.#ud,!1),this.#cd.addEventListener("touchmove",this.#ud,!1),this.#cd.addEventListener("touchend",this.#ud,!1),this.#pd=!0}#bd(t){Bo.#vd>t.timeStamp-this.#Td||this.#yd(t)}#yd(t){if(this.#Td=t.timeStamp,this.#pd){if(this.#Xo)return clearTimeout(this.#Xo),void(this.#Xo=null);this.hide()}else this.#qe()}#wd(){this.#pd&&(this.#Xo=setTimeout((()=>this.hide()),t.toolbars.timeOut))}constructor(){Object.freeze(this)}hide(){for(this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null);this.#cd.firstChild;){const t=this.#cd.firstChild;t.removeEventListener("click",this.#md,!1),t.removeEventListener("touchstart",this.#gd,!1),t.removeEventListener("touchend",this.#gd,!1),this.#cd.removeChild(t)}this.#cd.removeEventListener("wheel",this.#hd,{passive:!0}),this.#cd.removeEventListener("touchstart",this.#ud,!1),this.#cd.removeEventListener("touchmove",this.#ud,!1),this.#cd.removeEventListener("touchend",this.#ud,!1),this.#To.removeChild(this.#cd),this.#cd=null,this.#pd=!1}createUI(t,e){if(this.#To)return!1;this.#Xo=null,this.#pd=!1,this.#Td=0,this.#nd=new Ho,this.#hd=new ko,this.#ud=new Ao,this.#md=new Po(this.#nd),this.#gd=new Ro(this,this.#nd),this.#To=W.create("div",{className:"TravelNotes-BaseToolbar-ToolbarHTMLElement "+e},document.body),this.#To.addEventListener("click",(t=>this.#bd(t)),!1),this.#To.addEventListener("mouseenter",(t=>this.#yd(t)),!1),this.#To.addEventListener("mouseleave",(t=>this.#wd(t)),!1),W.create("div",{className:"TravelNotes-BaseToolbar-HeaderTextHTMLElement",textContent:t},W.create("div",{className:"TravelNotes-BaseToolbar-HeaderHTMLElement"},this.#To))}addToolbarItem(t){this.#nd.toolbarItemsArray.push(t)}addCssClass(t){this.#To.classList.add(t)}}class Fo{#fd;#re;#pn;constructor(t,e,o){this.#fd=t,this.#fd="function"==typeof t?t():t,this.#re=e,this.#pn=o}get textContent(){return this.#fd}get title(){return this.#re}get action(){return this.#pn}isLink(){return"string"==typeof this.#pn}isCommand(){return"function"==typeof this.#pn}}const _o=new class extends Bo{constructor(){super()}createUI(){super.createUI(j.getText("MapLayersToolbar - Layers"),c.topLeft),this.addCssClass("TravelNotes-MapLayersToolbar-ToolbarHTMLElement")}addToolbarItems(){bo.forEach((t=>{(t.providerKeyNeeded&&Ht.hasKey(t.providerName.toLowerCase())||!t.providerKeyNeeded)&&this.addToolbarItem(new Fo(t.toolbarButtonData.text,t.name,(()=>{So.setMapLayer(t.name)})))})),t.mapLayersToolbar?.theDevil?.addButton&&this.addToolbarItem(new Fo("👿","Reminder! The devil will know everything about you","https://www.google.com/maps/@"+U.map.getCenter().lat+","+U.map.getCenter().lng+","+U.map.getZoom()+"z"))}};class zo{#Md;#Id;#Nd;#Cd;#Dd;#xd;#Od;static get#jd(){return 3e5}#Sd(t){U.map.setZoom(U.map.getZoom()+t)}#Hd(){this.#Md&&(this.#Md.textContent=" "+this.#Cd+" "+this.#Dd+" - Zoom : "+String(this.#xd)+" ");const t=U.map;t.getMaxZoom()===this.#xd?this.#Id.classList.add("TravelNotes-MouseUI-Disabled"):this.#Id.classList.remove("TravelNotes-MouseUI-Disabled"),t.getMinZoom()===this.#xd?this.#Nd.classList.add("TravelNotes-MouseUI-Disabled"):this.#Nd.classList.remove("TravelNotes-MouseUI-Disabled")}constructor(){Object.freeze(this),this.#Cd=d.saved,this.#Dd="",this.#xd=0,this.#Od=null}set saveStatus(t){d.modified===t&&d.notSaved===this.#Cd||(this.#Cd=t,d.modified!==t||this.#Od?d.saved===t&&this.#Od&&(clearTimeout(this.#Od),this.#Od=null):this.#Od=setTimeout((()=>this.#Cd=d.notSaved),zo.#jd),this.#Hd())}createUI(){const e=W.create("div",{id:"TravelNotes-MouseUI"},document.body);this.#Nd=W.create("span",{id:"TravelNotes-MouseUI-ZoomMinus",textContent:"▼"},e),this.#Nd.addEventListener("click",(()=>this.#Sd(-1))),this.#Md=W.create("span",null,e),this.#Id=W.create("span",{id:"TravelNotes-MouseUI-ZoomPlus",textContent:"▲"},e),this.#Id.addEventListener("click",(()=>this.#Sd(1))),this.#xd=U.map.getZoom(),this.#Dd=S.formatLat(t.map.center.lat)+" - "+S.formatLng(t.map.center.lng),U.map.on("mousemove",(t=>{this.#Dd=S.formatLatLng([t.latlng.lat,t.latlng.lng]),this.#Hd()})),U.map.on("zoomend",(()=>{this.#xd=U.map.getZoom(),this.#Hd()}))}}const Ko=new zo;class Uo extends le{#Pd=null;constructor(){super()}createContentHTML(){this.#Pd=W.create("div",{id:"TravelNotes-AboutDialog-About"}),O.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2022 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank">https://github.com/wwwouaiebe/TravelNotes</a></p><p>Version : v4.0.0-beta.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.#Pd)}show(){super.show(),this.mover.centerDialog()}get contentHTMLElements(){return[this.#Pd]}get title(){return j.getText("AboutDialog - About Travel & Notes")}}const Vo=new class{#Rd=navigator.geolocation?i.inactive:i.disabled;#Ad=null;#kd(t){St.dispatch("geolocationpositionchanged",{position:t})}#Bd(){i.active===this.#Rd&&(this.#Rd=i.inactive),St.dispatch("geolocationstatuschanged",{status:this.#Rd}),this.#Ad&&(navigator.geolocation.clearWatch(this.#Ad),this.#Ad=null)}#Fd(t){1===t.code&&(this.#Rd=i.refusedByUser),2===t.code&&Ot.showError(j.getText("GeoLocator - Geolocation disabled on the device")),this.#Bd()}#_d(){this.#Rd=i.active,St.dispatch("geolocationstatuschanged",{status:this.#Rd}),t.geoLocation.watch?this.#Ad=navigator.geolocation.watchPosition((t=>this.#kd(t)),(t=>this.#Fd(t)),t.geoLocation.options):navigator.geolocation.getCurrentPosition((t=>this.#kd(t)),(t=>this.#Fd(t)),t.geoLocation.options)}constructor(){Object.freeze(this)}get status(){return this.#Rd}switch(){switch(this.#Rd){case i.inactive:this.#_d();break;case i.active:this.#Bd()}return this.#Rd}};class Wo{#zd;#Kd;#Ud;constructor(t,e,o){Object.freeze(this),this.#zd=t,this.#Kd=e,this.#Ud=o}get removeTravelNotes(){return this.#zd}get removeRoutesNotes(){return this.#Kd}get removeManeuvers(){return this.#Ud}}class Xo extends ct{#Vd;#Wd;#Xd;constructor(t){super(t)}createContentHTML(){this.#Vd=new Ft({afterText:j.getText("SaveAsDialog - Remove Travel Notes"),checked:!1}),this.#Wd=new Ft({afterText:j.getText("SaveAsDialog - Remove Routes Notes"),checked:!1}),this.#Xd=new Ft({afterText:j.getText("SaveAsDialog - Remove Maneuvers"),checked:!1})}onOk(){super.onOk(new Wo(this.#Vd.checked,this.#Wd.checked,this.#Xd.checked))}get contentHTMLElements(){return[this.#Vd.controlHTMLElement,this.#Wd.controlHTMLElement,this.#Xd.controlHTMLElement]}get title(){return j.getText("SaveAsDialog - SaveAs")}}const Yo=new class{#Yd(t){const e=new z;e.jsonObject=U.travel.jsonObject,e.name+="-partial";let o=e.routes.iterator;for(;!o.done;)o.value.hidden=!1;if(t.removeTravelNotes&&e.notes.removeAll(),t.removeRoutesNotes)for(o=e.routes.iterator;!o.done;)o.value.notes.removeAll();if(t.removeManeuvers)for(o=e.routes.iterator;!o.done;)o.value.itinerary.maneuvers.removeAll();const s=(new xo).compress(e);S.saveFile(s.name+".trv",JSON.stringify(s),"application/json")}#Gd(){return""!==U.travel.name||(Ot.showError(j.getText("TravelEditor - Gives a name to the travel")),St.dispatch("showtravelproperties"),!1)}constructor(){Object.freeze(this)}routeDropped(t,e,o){const s=t===U.travel.editedRoute.objId?U.editedRouteObjId:t,i=e===U.travel.editedRoute.objId?U.editedRouteObjId:e;U.travel.routes.moveTo(s,i,o),Co.chainRoutes(),St.dispatch("setrouteslist"),St.dispatch("roadbookupdate")}saveAsTravel(){if(this.#Gd())return p!==U.editedRouteObjId?(Ot.showError(j.getText("TravelEditor - Not possible to partial save when a route is edited.")),void St.dispatch("showtravelproperties")):void(new Xo).show().then((t=>{this.#Yd(t)})).catch((t=>{t instanceof Error&&console.error(t)}))}saveTravel(){if(!this.#Gd())return;const t=U.travel.routes.iterator;for(;!t.done;)t.value.hidden=!1;const e=(new xo).compress(U.travel);S.saveFile(e.name+".trv",JSON.stringify(e),"application/json"),Ko.saveStatus=d.saved}newTravel(){t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(j.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(go.deleteAllProfiles(),St.dispatch("removeallobjects"),U.editedRouteObjId=p,U.travel.jsonObject=(new z).jsonObject,St.dispatch("setrouteslist"),St.dispatch("showitinerary"),St.dispatch("roadbookupdate"),St.dispatch("updatetravelnotes"),t.travelNotes.startupRouteEdition&&Co.editRoute(U.travel.routes.first.objId),Ko.saveStatus=d.saved)}};class Go extends dt{#Zd;#Jd(){this.onTop?(this.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"),this.dialogHTMLElement.style.top="0px",this.#Zd=!0):(this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent"),this.#Zd=!1)}constructor(){super(),this.#Zd=!1}get dialogDocked(){return this.#Zd}centerDialog(){this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent"),super.centerDialog()}moveDialogTo(t,e,o){super.moveDialogTo(t,e,o),o&&"touchmove"===o||this.#Jd()}}class Zo extends le{#he;#ue;#qd;#$d;#Td;#pd;static get#vd(){return 100}static get#Qd(){return 1500}#tc(){this.mover.dialogDocked&&(Ee.isActive?this.#qd=setTimeout((()=>{this.#tc()}),Math.max(Zo.#Qd,t.dockableBaseDialog.timeout)):this.mover.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"))}#ec(t){this.#Td=t.timeStamp,this.#qd&&(clearTimeout(this.#qd),this.#qd=null),this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent")}#oc(){this.mover.dialogDocked&&(this.#qd=setTimeout((()=>{this.#tc()}),Math.max(Zo.#Qd,t.dockableBaseDialog.timeout)))}#sc(t){t.preventDefault(),Zo.#vd>t.timeStamp-this.#Td||this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.toggle("TravelNotes-DockableBaseDialog-HiddenContent")}constructor(t,e){super(),this.#he=t,this.#ue=e,this.#qd=null,this.#$d=null,this.#Td=0,this.#pd=!1}get mover(){return this.#$d?this.#$d:this.#$d=new Go}onCancel(){super.onCancel(),this.#pd=!1,this.#$d&&(this.#$d=null)}show(){this.#pd||(super.show(),this.addCssClass("TravelNotes-DockableBaseDialog"),this.updateContent(),null!==this.#he&&null!==this.#ue?(this.mover.moveDialogTo(this.#he,this.#ue),this.#he=null,this.#ue=null):this.mover.moveDialogToLastPosition(),this.mover.dialogHTMLElement.addEventListener("mouseenter",(t=>this.#ec(t)),!1),this.mover.dialogHTMLElement.addEventListener("mouseleave",(()=>this.#oc()),!1),this.mover.topBarHTMLElement.addEventListener("click",(t=>this.#sc(t)),!1),this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"),this.#pd=!0)}}class Jo{#V="";#ic=!1;#nc=[];#rc=["node","way","relation"];#ac=[];#lc=!1;#dc=!1;#t=p;constructor(t,e){this.#V=O.sanitizeToJsString(t),e&&(this.#dc=!0,this.#ic=!0),this.#t=b.nextObjId,Object.freeze(this)}get name(){return this.#V}get isRoot(){return this.#ic}get items(){return this.#nc}get elementTypes(){return this.#rc}setElementType(t){T!==["node","way","relation"].indexOf(t)&&(this.#rc=[t])}get filterTagsArray(){return this.#ac}get isSelected(){return this.#lc}set isSelected(t){this.#lc=t,this.items.forEach((e=>{e.isSelected=t}))}get isExpanded(){return this.#dc}set isExpanded(t){this.#dc=t}get objId(){return this.#t}}const qo=new class{#cc;#hc;#uc;#mc;#gc(t){const e=t.split(";");for(;""===e[e.length-1];)e.pop();let o=0;const s=[];e.forEach((t=>{if(""!==t)if(T===t.indexOf("="))this.#uc=new Jo(t),this.#hc.set(this.#uc.objId,this.#uc),this.#mc[o].push(this.#uc),this.#mc[o+1]=this.#uc.items;else{let e=t.split("=");if("element"===e[0])this.#uc.setElementType(e[1]);else{let t={};t[e[0]]="*"===e[1]?null:e[1],s.push(t)}}o++})),0!==s.length&&this.#uc.filterTagsArray.push(s)}#pc(t){t.items.forEach((t=>{this.#pc(t)})),t.isExpanded=!0}#vc(t){t.items.forEach((t=>{this.#vc(t)})),t.isExpanded=!1}constructor(){this.#cc=new Jo("",!0),this.#hc=new Map,this.#hc.set(this.#cc.objId,this.#cc),this.#mc=[this.#cc.items],Object.freeze(this)}get dictionary(){return this.#cc}parseDictionary(t){t.split(/\r\n|\r|\n/).forEach((t=>{""!==t&&this.#gc(t)}))}selectItem(t,e){this.#hc.get(t).isSelected=e}unselectAll(){this.#cc.isSelected=!1}expandItem(t){let e=this.#hc.get(t);e.isExpanded=!e.isExpanded}expand(){this.#pc(this.#cc)}collapse(){this.#cc.items.forEach((t=>this.#vc(t)))}};class $o{#Tc;constructor(t){Object.freeze(this),this.#Tc=t}handleEvent(t){t.stopPropagation(),qo.unselectAll(),this.#Tc.redraw()}}class Qo{#Tc;constructor(t){Object.freeze(this),this.#Tc=t}handleEvent(t){t.stopPropagation(),qo.collapse(),this.#Tc.redraw()}}class ts{#Tc;constructor(t){Object.freeze(this),this.#Tc=t}handleEvent(t){t.stopPropagation(),qo.expand(),this.#Tc.redraw()}}class es{#Lc;#Ec;#bc;static get#yc(){return 5e3}#wc(t,e){let o=!0;return e.forEach((e=>{const[s,i]=Object.entries(e)[0];o=o&&t.tags[s]&&(!i||t.tags[s]===i)})),o}#fc(t,e){this.#Ec.forEach((o=>{o.filterTagsArray.forEach((s=>{this.#wc(t,s)&&(t.description=o.name,e.set(t.id,t))}))}))}#Mc(){const e=[],o=new Map;this.#Ec.forEach((t=>{t.filterTagsArray.forEach((e=>{const[s,i]=Object.entries(e[0])[0];let n=o.get(s);n||(n={values:new Map,elements:new Map},o.set(s,n)),n.values.set(i,i),t.elementTypes.forEach((t=>{n.elements.set(t,t)}))}))}));const s=this.#Ic();this.#bc=s;const i="("+s.getSouthWest().lat.toFixed(a.fixed)+","+s.getSouthWest().lng.toFixed(a.fixed)+","+s.getNorthEast().lat.toFixed(a.fixed)+","+s.getNorthEast().lng.toFixed(a.fixed)+")";return o.forEach(((o,s)=>{let n='"'+s+'"';if(1===o.values.size){const t=o.values.values().next().value;t&&(n+='="'+t+'"')}else 1<o.values.size&&(n+='~"',o.values.forEach((t=>{n+=t+"|"})),n=n.substring(0,n.length-1)+'"');if(t.overpassApi.useNwr){const t=1===o.elements.size?o.elements.values().next().value:"nwr";e.push(t+"["+n+"]"+i+";"+("node"===t?"":"(._;>;);")+"out;")}else{let t=[];1===o.elements.size?t.push(o.elements.values().next().value):t=["node","way","rel"],t.forEach((t=>{e.push(t+"["+n+"]"+i+";"+("node"===t?"":"(._;>;);")+"out;")}))}})),e}#Nc(t){t.isSelected&&0<t.filterTagsArray.length&&this.#Ec.push(t),t.items.forEach((t=>this.#Nc(t)))}#Ic(){const t=U.map.getCenter(),e=U.map.getBounds(),o=ot.getSquareBoundingBox([t.lat,t.lng],es.#yc);return e.getSouthWest().lat=Math.max(e.getSouthWest().lat,o.getSouthWest().lat),e.getSouthWest().lng=Math.max(e.getSouthWest().lng,o.getSouthWest().lng),e.getNorthEast().lat=Math.min(e.getNorthEast().lat,o.getNorthEast().lat),e.getNorthEast().lng=Math.min(e.getNorthEast().lng,o.getNorthEast().lng),e}constructor(){Object.freeze(this),this.#Lc=!1,this.#Ec=[],this.#bc=null}async search(){if(this.#Lc)return;this.#Lc=!0,this.#Ec=[],this.#Nc(qo.dictionary);const t=new xe({searchPlaces:!1});await t.loadData(this.#Mc());const e=new Map;[t.nodes,t.ways,t.relations].forEach((t=>{t.forEach((t=>{t.tags&&this.#fc(t,e)}))})),U.searchData.length=0,Array.from(e.values()).sort(((t,e)=>t.description>e.description)).forEach((t=>U.searchData.push(t))),this.#Lc=!1,St.dispatch("showsearch")}get searchBounds(){return this.#Ic()}get previousSearchBounds(){return this.#bc}}const os=new es;class ss{#Tc;#Cc;constructor(t,e){Object.freeze(this),this.#Tc=t,this.#Cc=e}handleEvent(t){t.stopPropagation(),qo.dictionary.isExpanded=!1,this.#Tc.redraw(),U.searchData.length=0,St.dispatch("showsearch"),this.#Cc.showWait(),os.search()}}class is{#Dc;constructor(t,e){Object.freeze(this),this.#Dc=W.create("div"),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Start the search"),textContent:"🔎"},this.#Dc).addEventListener("click",new ss(t,e),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Expand the tree"),textContent:"▼"},this.#Dc).addEventListener("click",new ts(t),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Collapse the tree"),textContent:"▶"},this.#Dc).addEventListener("click",new Qo(t),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Clear the tree"),textContent:"❌"},this.#Dc).addEventListener("click",new $o(t),!1)}get toolbarButtonsHTMLElement(){return this.#Dc}}class ns{#Tc=null;constructor(t){Object.freeze(this),this.#Tc=t}handleEvent(t){t.stopPropagation(),qo.expandItem(Number.parseInt(t.target.parentNode.dataset.tanObjId)),this.#Tc.redraw()}}class rs{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*v[t.deltaMode]),t.stopPropagation()}}class as{#Tc=null;constructor(t){Object.freeze(this),this.#Tc=t}handleEvent(t){t.stopPropagation(),qo.selectItem(Number.parseInt(t.target.parentNode.dataset.tanObjId),t.target.checked),this.#Tc.redraw()}}class ls{#xc;#Oc;#jc;#Sc;#Hc(t){this.#Sc++;const e=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchItemMargin"+this.#Sc,dataset:{ObjId:t.objId}},this.#xc);if(!t.isRoot){W.create("input",{type:"checkbox",checked:t.isSelected},e).addEventListener("change",this.#jc,!1)}if(0===t.filterTagsArray.length){W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-OsmSearchDialog-TreeArrow",textContent:t.isExpanded?"▼":"▶"},e).addEventListener("click",this.#Oc,!1)}W.create("text",{value:t.name},e),t.isExpanded&&t.items.forEach((t=>this.#Hc(t))),this.#Sc--}constructor(){Object.freeze(this),this.#Sc=0,this.#xc=W.create("div",{id:"TravelNotes-OsmSearchDialog-SearchTree"}),this.#xc.addEventListener("wheel",new rs,{passive:!0}),this.#jc=new as(this),this.#Oc=new ns(this),this.#Hc(qo.dictionary)}redraw(){this.#xc.textContent="",this.#Hc(qo.dictionary)}get treeHTMLElement(){return this.#xc}}class ds{#He;constructor(){this.#He=W.create("div",{className:"TravelNotes-WaitAnimation"}),W.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.#He),this.#He.classList.add("TravelNotes-Hidden")}showWait(){this.#He.classList.remove("TravelNotes-Hidden")}hideWait(){this.#He.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.#He}}class cs{#aa;constructor(t,e){Object.freeze(this),this.#aa=new ze(t,e)}destructor(){this.#aa=null}get addressButtonClick(){return this.#aa}}class hs extends ct{#Pc;#Rc;#va;#ya;constructor(t){super(),this.#Pc=t,this.#ya=new cs(this,this.#Pc.latLng)}createContentHTML(){this.#Rc=new Jt({headerText:j.getText("WayPointPropertiesDialog - Name")},this.#ya),this.#Rc.value=this.#Pc.name,this.#va=new Ce(this.#ya),this.#va.address=this.#Pc.address}onCancel(){this.#ya.destructor(),super.onCancel()}onOk(){this.#Pc.address=this.#va.address,this.#Pc.name=this.#Rc.value,this.#ya.destructor(),super.onOk()}get contentHTMLElements(){return[this.#Rc.controlHTMLElement,this.#va.controlHTMLElement]}set name(t){this.#Rc.name=t}set address(t){this.#va.address=t}get title(){return j.getText("WayPointPropertiesDialog - Waypoint properties")}get wayPoint(){return this.#Pc}setControlsValues(t){this.#va.address=t.address,this.#Rc.value=t.name}}const us=new class{#Ac;#kc;#Bc(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;for(e.done,s.done,s.value.distance=o.defaultValue,s.done,t.distance=o.defaultValue,t.duration=o.defaultValue;!e.done;)e.previous.distance=Pt.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=o.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=o.defaultValue),s.done)}#Fc(t){this.#Ac=!1,t instanceof Error?(console.error(t),Ot.showError(t.message)):Ot.showError("A network error occurs when calling the provider")}#_c(){if(this.#Ac=!1,this.#Bc(U.travel.editedRoute),"circle"!==U.travel.editedRoute.itinerary.transitMode){const t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=U.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=U.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=ot.getClosestLatLngDistance(U.travel.editedRoute,t.value.latLng).latLng}const t=U.travel.editedRoute.notes.iterator;for(;!t.done;){const e=ot.getClosestLatLngDistance(U.travel.editedRoute,t.value.latLng);t.value.latLng=e.latLng,t.value.distance=e.distance}Co.chainRoutes(),U.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.#kc&&(new no).zoomToRoute(U.travel.editedRoute.objId),go.createProfile(U.travel.editedRoute),St.dispatch("routeupdated",{removedRouteObjId:U.travel.editedRoute.objId,addedRouteObjId:U.travel.editedRoute.objId}),St.dispatch("roadbookupdate"),St.dispatch("showitinerary"),St.dispatch("setrouteslist")}constructor(){Object.freeze(this)}startRouting(){if(!this.#Ac&&U.travel.editedRoute.haveValidWayPoints()){this.#kc=0===U.travel.editedRoute.itinerary.itineraryPoints.length,this.#Ac=!0;const t=U.providers.get(U.routing.provider.toLowerCase());U.travel.editedRoute.itinerary.provider=t.name,U.travel.editedRoute.itinerary.transitMode=U.routing.transitMode,t.getPromiseRoute(U.travel.editedRoute).then((()=>this.#_c())).catch((()=>this.#Fc()))}}};const ms=new class{async#zc(e){if(!t.wayPoint.reverseGeocoding)return St.dispatch("setrouteslist"),St.dispatch("showitinerary"),void St.dispatch("roadbookupdate");const o=await(new Se).getAddressAsync(e.latLng);U.editedRouteObjId===U.travel.editedRoute.objId&&(U.travel.editedRoute.editionStatus=l.editedChanged),e.address=o.street,""!==o.city&&(e.address+=" "+o.city),e.name="",t.wayPoint.geocodingIncludeName&&(e.name=o.name),St.dispatch("setrouteslist"),St.dispatch("updateitinerary"),St.dispatch("roadbookupdate")}#Kc(t){const e=U.travel.editedRoute.wayPoints.first;e.latLng=t,this.#zc(e),St.dispatch("addwaypoint",{wayPoint:e,letter:"A"})}#Uc(t){const e=U.travel.editedRoute.wayPoints.last;e.latLng=t,this.#zc(e),St.dispatch("addwaypoint",{wayPoint:e,letter:"B"})}constructor(){Object.freeze(this)}addWayPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged;const e=new R;e.latLng=t,U.travel.editedRoute.wayPoints.add(e),this.#zc(e),St.dispatch("addwaypoint",{wayPoint:U.travel.editedRoute.wayPoints.last,letter:U.travel.editedRoute.wayPoints.length-2}),U.travel.editedRoute.wayPoints.swap(e.objId,!0),us.startRouting()}addWayPointOnRoute(t,e){const o=ot.getClosestLatLngDistance(U.travel.editedRoute,t).distance;U.travel.editedRoute.editionStatus=l.editedChanged;const s=new R;s.latLng=e;let i="";const n=U.travel.editedRoute.wayPoints.iterator;for(;!n.done;){if(o<ot.getClosestLatLngDistance(U.travel.editedRoute,n.value.latLng).distance){i=String(n.index),U.travel.editedRoute.wayPoints.add(s),U.travel.editedRoute.wayPoints.moveTo(s.objId,n.value.objId,!0),this.#zc(s),St.dispatch("addwaypoint",{wayPoint:s,letter:i}),us.startRouting();break}}}reverseWayPoints(){U.travel.editedRoute.editionStatus=l.editedChanged;let t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)St.dispatch("removeobject",{objId:t.value.objId});for(U.travel.editedRoute.wayPoints.reverse(),t=U.travel.editedRoute.wayPoints.iterator;!t.done;)St.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":String(t.index)});St.dispatch("setrouteslist"),St.dispatch("showitinerary"),St.dispatch("roadbookupdate"),us.startRouting()}removeWayPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,St.dispatch("removeobject",{objId:t}),U.travel.editedRoute.wayPoints.remove(t),us.startRouting()}setStartPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Kc(t),us.startRouting()}setEndPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Uc(t),us.startRouting()}setStartAndEndPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Kc(t),this.#Uc(t),2<U.travel.editedRoute.wayPoints.length&&us.startRouting()}wayPointDragEnd(t){U.travel.editedRoute.editionStatus=l.editedChanged;const e=U.travel.editedRoute.wayPoints.getAt(t.target.objId),o=t.target.getLatLng();e.latLng=[o.lat,o.lng],this.#zc(e),us.startRouting()}wayPointProperties(t){const e=U.travel.editedRoute.wayPoints.getAt(t);new hs(e).show().then((()=>{St.dispatch("setrouteslist"),St.dispatch("showitinerary"),St.dispatch("roadbookupdate")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class gs{#Qi;#xa;constructor(t,e){this.#Qi=t,this.#xa=e}get latLng(){return this.#Qi}get geometry(){return this.#xa}}class ps extends Ee{#Vc;#Qi;constructor(t,e){super(t,e),this.#Vc=U.searchData[Number.parseInt(t.currentTarget.dataset.tanElementIndex)],this.#Qi=[this.#Vc.lat,this.#Vc.lon],St.dispatch("removeobject",{objId:this.targetObjId})}get menuItems(){return[new be(j.getText("OsmSearchContextMenu - Select this point as start point"),p!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat,(()=>ms.setStartPoint(this.#Qi))),new be(j.getText("OsmSearchContextMenu - Select this point as way point"),p!==U.editedRouteObjId,(()=>ms.addWayPoint(this.#Qi))),new be(j.getText("OsmSearchContextMenu - Select this point as end point"),p!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>ms.setEndPoint(this.#Qi))),new be(j.getText("OsmSearchContextMenu - Create a route note with this result"),!0,(()=>io.newSearchRouteNote(this.#Vc))),new be(j.getText("OsmSearchContextMenu - Create a travel note with this result"),!0,(()=>io.newSearchTravelNote(this.#Vc))),new be(j.getText(io.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),!0,(()=>io.changeOsmSearchNoteDialog())),new be(j.getText("OsmSearchContextMenu - Zoom to this result"),!0,(()=>(new no).zoomToPoi(new gs(this.#Qi,this.#Vc.geometry))))]}}class vs{#Wc;#Xc;#Yc;#Gc;#Zc;#Jc;#qc;#$c;#Qc;#th;#eh;#oh;static get#sh(){return 1e3}static get#ih(){return 40}static get#nh(){return 5}static get#rh(){return 200}static get#ah(){return 100}#lh(t){t!==this.#Gc&&vs.#ih<t-this.#Gc&&(this.#qc.scrollTop-=vs.#nh,this.#Gc=t),this.#$c>this.#th&&0<this.#qc.scrollTop&&window.requestAnimationFrame((t=>{this.#lh(t)}))}#dh(t){t!==this.#Gc&&vs.#ih<t-this.#Gc&&(this.#qc.scrollTop+=vs.#nh,this.#Gc=t);let e=1>Math.abs(this.#qc.scrollHeight-this.#qc.clientHeight-this.#qc.scrollTop);this.#Qc<this.#th&&!e&&window.requestAnimationFrame((t=>{this.#dh(t)}))}#oe(t){const e=t.changedTouches.item(0);if(1===t.touches.length){if(vs.#sh<t.timeStamp-this.#Yc||0===this.#Yc)return void(this.#Yc=t.timeStamp);t.preventDefault(),this.#Xc=!0,this.#Jc=t.currentTarget.parentNode,this.#qc=t.currentTarget.parentNode.parentNode.parentNode,this.#th=e.screenY,this.#Zc=t.currentTarget.cloneNode(!0),this.#Zc.classList.add("TravelNotes-SortableList-DraggedListItemHTMLElement"),document.body.appendChild(this.#Zc),this.#Zc.style.left=e.screenX+"px",this.#Zc.style.top=e.screenY+"px",this.#$c=this.#Jc.getBoundingClientRect().y-this.#qc.getBoundingClientRect().y+this.#qc.scrollTop+vs.#rh,this.#Qc=this.#qc.getBoundingClientRect().bottom-vs.#ah}}#ee(t){if(!this.#Xc)return;const e=t.changedTouches.item(0);if(1===t.touches.length&&this.#Zc){this.#Zc.style.left=e.screenX+"px",this.#Zc.style.top=e.screenY+"px",this.#th=e.screenY,this.#$c>this.#th&&0<this.#qc.scrollTop&&window.requestAnimationFrame((t=>{this.#lh(t)}));let t=1>Math.abs(this.#qc.scrollHeight-this.#qc.clientHeight-this.#qc.scrollTop);this.#Qc<this.#th&&!t&&window.requestAnimationFrame((t=>{this.#dh(t)}))}}#ch(t){this.#Jc.childNodes.forEach((e=>{let o=e.getBoundingClientRect();o.left<t.clientX&&o.right>t.clientX&&o.top<t.clientY&&o.bottom>t.clientY&&(this.#eh=e,this.#oh=t.clientY-o.top<o.height/2)}))}#te(t){if(this.#Xc){let e=t.changedTouches.item(0);if(this.#ch(e),this.#eh)try{this.#Wc(Number.parseInt(t.currentTarget.dataset.tanObjId),Number.parseInt(this.#eh.dataset.tanObjId),this.#oh)}catch{}}this.#hh()}#hh(){this.#Zc&&document.body.removeChild(this.#Zc),this.#Zc=null,this.#qc=null,this.#Xc=!1,this.#Gc=0,this.#Jc=null,this.#$c=0,this.#Qc=0,this.#th=0,this.#eh=null,this.#oh=!0}constructor(t){Object.freeze(this),this.#Wc=t,this.#Zc=null,this.#Yc=0,this.#hh()}handleEvent(t){switch(t.type){case"touchstart":this.#oe(t);break;case"touchmove":this.#ee(t);break;case"touchend":this.#te(t);break;case"touchcancel":this.#hh()}}}class Ts{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class Ls{#Wc;constructor(t){Object.freeze(this),this.#Wc=t}handleEvent(t){t.preventDefault();const e=t.currentTarget.getBoundingClientRect();try{this.#Wc(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(t.currentTarget.dataset.tanObjId),t.clientY-e.top<e.bottom-t.clientY)}catch{}}}class Es{#uh;constructor(t){Object.freeze(this),this.#uh=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new this.#uh(t,t.target.parentNode).show()}}class bs extends mt{#mh;#gh;#ph;#vh;#Jc;constructor(t,e,o){super(),this.#mh=new Ts,this.#gh=new Ls(t),this.#ph=new Es(e),this.#vh=new vs(t),o&&W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:o},this.controlHTMLElement),this.#Jc=W.create("div",{className:"TravelNotes-SortableList-ListHTMLElement"},this.controlHTMLElement)}updateContent(t){for(;this.#Jc.firstChild;)this.#Jc.firstChild.removeEventListener("dragstart",this.#mh,!1),this.#Jc.firstChild.removeEventListener("drop",this.#gh,!1),this.#Jc.firstChild.removeEventListener("contextmenu",this.#ph,!1),this.#Jc.firstChild.removeEventListener("touchstart",this.#vh,!1),this.#Jc.firstChild.removeEventListener("touchmove",this.#vh,!1),this.#Jc.firstChild.removeEventListener("touchend",this.#vh,!1),this.#Jc.removeChild(this.#Jc.firstChild);t.forEach((t=>{t.draggable=!0,t.addEventListener("dragstart",this.#mh,!1),t.addEventListener("drop",this.#gh,!1),t.addEventListener("contextmenu",this.#ph,!1),t.addEventListener("touchstart",this.#vh,!1),t.addEventListener("touchmove",this.#vh,!1),t.addEventListener("touchend",this.#vh,!1),this.#Jc.appendChild(t),t.classList.add("TravelNotes-SortableList-ListItemHTMLElement")}))}}class ys{#Th;#Vc;#Lh;static get#ur(){return 40}#Eh(){let t="";t=this.#Vc.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.#Vc.tags.rcn_ref+"</text></svg></div>":fe.preDefinedIconDataFromName(this.#Vc.description)||"";const e=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResult-IconCell"},this.#Th);O.sanitizeToHtmlElement(t,e)}#bh(t){t&&W.create("div",{textContent:t},this.#Lh)}#Fr(){const t=(this.#Vc.tags["addr:street"]?(this.#Vc.tags["addr:housenumber"]?this.#Vc.tags["addr:housenumber"]+" ":"")+this.#Vc.tags["addr:street"]+" ":"")+(this.#Vc.tags["addr:city"]?(this.#Vc.tags["addr:postcode"]?this.#Vc.tags["addr:postcode"]+" ":"")+this.#Vc.tags["addr:city"]:"");""!==t&&this.#bh(t)}#yh(){this.#Vc.tags.phone&&this.#bh("☎️ : "+this.#Vc.tags.phone,this.#Lh)}#wh(){this.#Vc.tags.email&&W.create("a",{href:"mailto:"+this.#Vc.tags.email,textContent:this.#Vc.tags.email},W.create("div",{textContent:"📧 : "},this.#Lh))}#fh(){this.#Vc.tags.website&&W.create("a",{href:this.#Vc.tags.website,target:"_blank",textContent:this.#Vc.tags.website.length>ys.#ur?this.#Vc.tags.website.substring(0,ys.#ur)+"...":this.#Vc.tags.website},W.create("div",null,this.#Lh))}#Mh(){this.#Lh=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResult-Cell"},this.#Th),this.#bh(this.#Vc.description),this.#bh(this.#Vc.tags.name),this.#bh(this.#Vc.tags.rcn_ref),this.#Fr(),this.#yh(),this.#wh(),this.#fh()}#Ih(){for(const[t,e]of Object.entries(this.#Vc.tags))this.#Th.title+=t+"="+e+"\n"}constructor(){Object.freeze(this)}buildHTMLElement(t,e){return this.#Vc=t,this.#Th=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResultHTMLElement",dataset:{ObjId:b.nextObjId,ElementIndex:e}}),this.#Eh(),this.#Mh(),this.#Ih(),this.#Th}}class ws{#Nh;#Ch;#Dh(){p===this.#Ch?this.#Ch=b.nextObjId:St.dispatch("removeobject",{objId:this.#Ch}),St.dispatch("addrectangle",{objId:this.#Ch,bounds:os.searchBounds,properties:t.osmSearch.nextSearchLimit})}#xh(){const e=os.previousSearchBounds;e&&(p===this.#Nh?this.#Nh=b.nextObjId:St.dispatch("removeobject",{objId:this.#Nh}),St.dispatch("addrectangle",{objId:this.#Nh,bounds:[[e.getSouthWest().lat,e.getSouthWest().lng],[e.getNorthEast().lat,e.getNorthEast().lng]],properties:t.osmSearch.previousSearchLimit}))}constructor(){Object.freeze(this),this.#Nh=p,this.#Ch=p}show(){U.map.on("zoom",this.#Dh,this),U.map.on("move",this.#Dh,this),this.#Dh(),this.#xh()}hide(){U.map.off("zoom",this.#Dh,this),U.map.off("move",this.#Dh,this),p!==this.#Ch&&(St.dispatch("removeobject",{objId:this.#Ch}),this.#Ch=p),p!==this.#Nh&&(St.dispatch("removeobject",{objId:this.#Nh}),this.#Nh=p)}}class fs{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();const e=U.searchData[Number.parseInt(t.target.dataset.tanElementIndex)];St.dispatch("addsearchpointmarker",{objId:Number.parseInt(t.target.dataset.tanObjId),latLng:[e.lat,e.lon],geometry:e.geometry})}}class Ms{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),St.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanObjId)})}}class Is extends Zo{#Oh;#To;#jh;#Tc;#Cc;#Sh;#Hh;#Ph;#Vl(){this.#To=W.create("div"),this.#Tc=new ls,this.#Cc=new ds;const t=new is(this.#Tc,this.#Cc);this.#To.appendChild(t.toolbarButtonsHTMLElement),this.#To.appendChild(this.#Tc.treeHTMLElement),this.#To.appendChild(this.#Cc.waitHTMLElement)}constructor(){super(t.osmSearchDialog.dialogX,t.osmSearchDialog.dialogY)}createContentHTML(){this.#Vl(),this.#jh=new bs(null,ps),this.#Sh=new ys,this.#Oh=new ws,this.#Hh=new fs,this.#Ph=new Ms}get contentHTMLElements(){return[].concat(this.#jh.controlHTMLElement)}get title(){return j.getText("OsmSearchDialog - Searching OpenStreetMap")}get toolbarHTMLElement(){return this.#To}onCancel(){this.#Oh.hide(),super.onCancel()}show(){super.show(),this.#Oh.show()}updateContent(){this.#Cc.hideWait(),this.#Oh.hide(),this.#Oh.show();const t=[];U.searchData.forEach(((e,o)=>{const s=this.#Sh.buildHTMLElement(e,o);s.addEventListener("mouseenter",this.#Hh,!1),s.addEventListener("mouseleave",this.#Ph,!1),t.push(s)})),this.#jh.updateContent(t)}}class Ns extends ct{#Rh;constructor(t){super(t)}createContentHTML(){this.#Rh=W.create("div",{textContent:this.options.text||""})}get contentHTMLElements(){return[this.#Rh]}get title(){return this.options.title||""}}class Cs{#ds=null;#Ah=0;#kh(t){const e=new F;for(const o in t)e[o]=t[o];e.iconLatLng=e.latLng,e.distance=ot.getClosestLatLngDistance(this.#ds,e.latLng).distance,e.chainedDistance=this.#ds.chainedDistance,this.#ds.notes.add(e),St.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:e.objId})}async#Bh(){const t=new so;t.createUI();const e=new qe,o=this.#ds.itinerary.maneuvers.iterator;for(;!o.done;){t.showInfo(j.getText("AllManeuverNotesBuilder - Creating note",{noteNumber:o.index+1,notesLength:this.#Ah}));const s=this.#ds.itinerary.itineraryPoints.getAt(o.value.itineraryPointObjId).latLng,i=await e.getIconAndAdressAsync(s,this.#ds);i?this.#kh(i):console.error("An error occurs when creating the svg icon "+o.index)}this.#ds.notes.sort(((t,e)=>t.distance-e.distance)),St.dispatch("updateitinerary"),St.dispatch("roadbookupdate"),t.close()}constructor(){Object.freeze(this)}addAllManeuverNotes(e){this.#ds=kt.getRoute(e),this.#Ah=this.#ds.itinerary.maneuvers.length,t.note.maxManeuversNotes<this.#Ah?Ot.showError(j.getText("AllManeuverNotesBuilder - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:this.#Ah,maxManeuversNotes:t.note.maxManeuversNotes})):new Ns({title:j.getText("AllManeuverNotesBuilder - Add a note for each maneuver"),text:j.getText("AllManeuverNotesBuilder - Add a note for each maneuver. Are you sure?",{noteLength:this.#Ah}),secondButtonText:"❌"}).show().then((()=>this.#Bh())).catch((t=>{t instanceof Error&&console.error(t)}))}}class Ds extends Ee{#ds=null;constructor(t,e){super(t,e),this.#ds=kt.getRoute(this.targetObjId)}get menuItems(){return[new be(j.getText("RouteContextMenu - Edit this route"),this.targetObjId!==U.travel.editedRoute.objId&&l.editedChanged!==U.travel.editedRoute.editionStatus,(()=>Co.editRoute(this.targetObjId))),new be(j.getText("RouteContextMenu - Delete this route"),this.targetObjId!==U.travel.editedRoute.objId||l.editedChanged!==U.travel.editedRoute.editionStatus,(()=>Co.removeRoute(this.targetObjId))),new be(j.getText(this.#ds.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),this.#ds.hidden||U.travel.editedRoute.objId!==this.targetObjId,(()=>{this.#ds.hidden?Co.showRoute(this.targetObjId):Co.hideRoute(this.targetObjId)})),new be(j.getText("RouteContextMenu - Properties"),!this.#ds.hidden,(()=>Co.routeProperties(this.targetObjId))),new be(j.getText("RouteContextMenu - Zoom to route"),!this.#ds.hidden,(()=>(new no).zoomToRoute(this.targetObjId))),new be(j.getText("RouteContextMenu - View the elevation"),this.#ds.itinerary.hasProfile,(()=>go.showProfile(this.targetObjId))),new be(j.getText("RouteContextMenu - Print route map"),t.printRouteMap.isEnabled,(()=>Co.printRouteMap(this.targetObjId))),new be(j.getText("RouteContextMenu - Save this route in a GPX file"),0<this.#ds.itinerary.itineraryPoints.length,(()=>Co.saveGpx(this.targetObjId))),new be(j.getText("RouteContextMenu - Invert waypoints"),U.travel.editedRoute.objId===this.targetObjId,(()=>ms.reverseWayPoints())),new be(j.getText("RouteContextMenu - Add a note on the route"),!this.haveParentNode,(()=>io.newRouteNote(this.targetObjId,this.latLng))),new be(j.getText("RouteContextMenu - Create a note for each route maneuver"),!this.#ds.hidden,(()=>(new Cs).addAllManeuverNotes(this.targetObjId))),new be(j.getText("RouteContextMenu - Save modifications on this route"),U.travel.editedRoute.objId===this.targetObjId,(()=>Co.saveEdition())),new be(j.getText("RouteContextMenu - Cancel modifications on this route"),U.travel.editedRoute.objId===this.targetObjId,(()=>Co.cancelEdition()))]}}class xs{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),U.travel.name=O.sanitizeToJsString(t.target.value),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name),St.dispatch("roadbookupdate")}}class Os extends Zo{#Fh=null;#_h=null;constructor(){super(t.travelPropertiesDialog.dialogX,t.travelPropertiesDialog.dialogY)}createContentHTML(){this.#Fh=new Jt(j.getText("TravelPropertiesDialog - Name"),{controlInput:new xs}),this.#Fh.value=U.travel.name,this.#_h=new bs(Yo.routeDropped,Ds,j.getText("TravelPropertiesDialog - Routes"))}get contentHTMLElements(){return[this.#Fh.controlHTMLElement,this.#_h.controlHTMLElement]}get title(){return j.getText("TravelPropertiesDialog - Travel properties")}#ys(t,e){const o=(t.editionStatus===l.notEdited?"":"🔴 ")+(t.chain?"⛓ ":"")+(t.objId===U.editedRouteObjId?U.travel.editedRoute.computedName:t.computedName);e.push(W.create("div",{textContent:o,dataset:{ObjId:String(t.objId)}}))}updateContent(){if(!this.#_h)return;const t=[];U.travel.routes.forEach((e=>{e.objId===U.editedRouteObjId?this.#ys(U.travel.editedRoute,t):this.#ys(e,t)})),this.#_h.updateContent(t),this.#Fh.value=U.travel.name}}class js extends Ee{#ds;constructor(t,e){super(t,e),this.#ds=kt.getNoteAndRoute(this.targetObjId).route}get menuItems(){return[new be(j.getText("NoteContextMenu - Edit this note"),!0,(()=>io.editNote(this.targetObjId))),new be(j.getText("NoteContextMenu - Delete this note"),!0,(()=>io.removeNote(this.targetObjId))),new be(j.getText("NoteContextMenu - Zoom to note"),!0,(()=>(new no).zoomToNote(this.targetObjId))),new be(j.getText(this.#ds?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),p===U.editedRouteObjId,(()=>{this.#ds?io.detachNoteFromRoute(this.targetObjId):io.attachNoteToRoute(this.targetObjId)}))]}}class Ss extends Zo{#zh;constructor(){super(t.travelNotesDialog.dialogX,t.travelNotesDialog.dialogY)}createContentHTML(){this.#zh=new bs(io.travelNoteDropped,js)}get contentHTMLElements(){return[this.#zh.controlHTMLElement]}get title(){return j.getText("TravelNotesDialog - Travel notes dialog")}updateContent(){if(!this.#zh)return;let t=ke.getTravelNotesHTML("TravelNotes-TravelNotesDialog-");this.#zh.updateContent(Array.from(t.childNodes))}}const Hs=new class{#Kh=null;#Uh=null;#Vh=null;constructor(){Object.freeze(this)}get osmSearchDialog(){return this.#Kh||(this.#Kh=new Is(t.osmSearchDialog.dialogX,t.osmSearchDialog.dialogY)),this.#Kh}get travelPropertiesDialog(){return this.#Uh||(this.#Uh=new Os(t.travelPropertiesDialog.dialogX,t.travelPropertiesDialog.dialogY)),this.#Uh}get travelNotesDialog(){return this.#Vh||(this.#Vh=new Ss(t.travelNotesDialog.dialogX,t.travelNotesDialog.dialogY)),this.#Vh}showTravelProperties(){this.travelPropertiesDialog.show(),this.travelPropertiesDialog.mover.centerDialog()}};const Ps=new class{#Vo;#Xo=null;hide(){this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null),this.#Vo.removeEventListener("click",this.toggle,!1),document.body.removeChild(this.#Vo)}constructor(){Object.freeze(this)}async toggle(){document.fullscreenElement?await document.exitFullscreen():await document.body.requestFullscreen()}show(){const e=t.FullScreenUI.timeOut;0===e||!document.fullscreenEnabled||document.body.clientWidth>t.FullScreenUI.screenMaxWidth||(this.#Vo=W.create("div",{id:"TravelNotes-FullScreenUI",textContent:j.getText("FullScreenUI - start full screen")},document.body),this.#Vo.addEventListener("click",this.toggle,!1),this.#Xo=setTimeout((()=>this.hide()),e))}};const Rs=new class{#Wh;constructor(){Object.freeze(this),this.#Wh=null}increment(){this.#Wh||(this.#Wh=t.fontSize.initialValue),this.#Wh+=t.fontSize.incrementValue,document.body.style["font-size"]=String(this.#Wh)+"mm"}decrement(){this.#Wh||(this.#Wh=t.fontSize.initialValue),this.#Wh-=t.fontSize.incrementValue,document.body.style["font-size"]=String(this.#Wh)+"mm"}};class As{#Xh;#Pt;#ds;#Yh;#Gh(t){let e=new A;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const o=t.childNodes;for(let t=0;t<o.length;t++)if("ele"===o[t].nodeName)e.elev=Number.parseFloat(o[t].textContent),0!==e.elev&&(this.#ds.itinerary.hasProfile=!0);this.#ds.itinerary.itineraryPoints.add(e)}#Zh(t){const e=t.childNodes;for(let t=0;t<e.length;t++)if("trkpt"===e[t].nodeName)this.#Gh(e[t])}#Jh(){let t=0,e=0,o=this.#ds.itinerary.itineraryPoints.iterator;for(o.done;!o.done;){let s=o.value.elev-o.previous.elev;0>s?e-=s:t+=s}this.#ds.itinerary.ascent=t,this.#ds.itinerary.descent=e}#qh(t){this.#ds=new _;const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.#ds.name=e[t].textContent;break;case"trkseg":this.#Zh(e[t])}this.#ds.itinerary.hasProfile&&this.#Jh(),this.#Pt.routes.add(this.#ds)}#$h(t){let e=Number.MAX_VALUE,o=p;return this.#ds.itinerary.itineraryPoints.forEach((s=>{const i=Pt.pointsDistance(t,s.latLng);i<e&&(e=i,o=s.objId)})),o}#Qh(t){const e=new k;e.iconName="kUndefined";const o=Number.parseFloat(t.getAttributeNS(null,"lat")),s=Number.parseFloat(t.getAttributeNS(null,"lon"));e.itineraryPointObjId=this.#$h([o,s]);const i=t.childNodes;for(let t=0;t<i.length;t++)if("desc"===i[t].nodeName)e.instruction=i[t].textContent;this.#ds.itinerary.maneuvers.add(e)}#tu(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.#ds.name=e[t].textContent;break;case"rtept":this.#Qh(e[t])}}#eu(t){const e=new F;e.latLng=t.latLng,e.iconLatLng=t.latLng;const o=t.name.split("+");e.iconContent='<div class="TravelNotes-MapNote TravelNotes-MapNoteCategory-0073"><svg viewBox="0 0 20 20"><text x="10" y="14">'+o[0]+"</text></svg></div>",e.tooltipContent=j.getText("GpxParser - Network node")+o[0],o[1]&&(e.tooltipContent+=j.getText("GpxParser - Go to network node")+o[1]),e.distance=ot.getClosestLatLngDistance(this.#ds,e.latLng).distance,this.#ds.notes.add(e)}#ou(t){let e=new R;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const o=t.childNodes;for(let t=0;t<o.length;t++)if("name"===o[t].nodeName)e.name=o[t].textContent;this.#ds.wayPoints.add(e),this.#Yh&&this.#eu(e)}#su(t){for(let e=0;e<t.length;e++)this.#ou(t[e])}#iu(){this.#Pt.routes.forEach((t=>{t.wayPoints.remove(t.wayPoints.first.objId),t.wayPoints.remove(t.wayPoints.last.objId);const e=new R;e.latLng=t.itinerary.itineraryPoints.first.latLng,t.wayPoints.add(e);const o=new R;o.latLng=t.itinerary.itineraryPoints.last.latLng,t.wayPoints.add(o)}))}#Bc(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;e.done;let i=s.done;for(i||(s.value.distance=o.defaultValue,i=s.done),t.distance=o.defaultValue,t.duration=o.defaultValue;!e.done;)e.previous.distance=Pt.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,i||(s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=o.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(i=s.done,s.value.distance=o.defaultValue),i=s.done))}constructor(){Object.freeze(this)}parse(t){this.#Xh=(new DOMParser).parseFromString(t,"text/xml"),this.#Yh=Boolean(this.#Xh.querySelector("gpx").getAttributeNS(null,"creator").match(/fietsnet|knooppuntnet/g)),this.#Pt=new z,this.#Pt.routes.remove(this.#Pt.routes.first.objId);const e=this.#Xh.querySelectorAll("trk");for(let t=0;t<e.length;t++)this.#qh(e[t]);const o=this.#Xh.querySelectorAll("rte");1===o.length&&1===this.#Pt.routes.length&&this.#tu(o[0]),this.#Pt.routes.forEach((t=>this.#Bc(t)));const s=this.#Xh.querySelectorAll("wpt");return 0<s.length&&1===this.#Pt.routes.length?(this.#ds.wayPoints.remove(this.#ds.wayPoints.first.objId),this.#ds.wayPoints.remove(this.#ds.wayPoints.last.objId),this.#su(s)):this.#iu(),this.#Pt}}class ks{#nu(){St.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name);const t=U.travel.routes.iterator;for(;!t.done;)l.notEdited===t.value.editionStatus&&St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:t.value.objId});p!==U.editedRouteObjId&&St.dispatch("routeupdated",{removedRouteObjId:p,addedRouteObjId:U.travel.editedRoute.objId});const e=U.travel.notes.iterator;for(;!e.done;)St.dispatch("noteupdated",{removedNoteObjId:p,addedNoteObjId:e.value.objId});if(St.dispatch("updatetravelnotes"),(new no).zoomToTravel(),So.setMapLayer(U.travel.layerName),p!==U.editedRouteObjId){const t=U.travel.editedRoute.itinerary.provider;if(""===t||U.providers.get(t.toLowerCase())){St.dispatch("setprovider",{provider:t});const e=U.travel.editedRoute.itinerary.transitMode;""!==e&&St.dispatch("settransitmode",{transitMode:e})}else Ot.showError(j.getText("FileLoader - Not possible to select as provider",{provider:t}))}Co.chainRoutes(),St.dispatch("setrouteslist"),St.dispatch("showitinerary"),St.dispatch("roadbookupdate")}constructor(){Object.freeze(this)}openLocalGpxFile(t){go.deleteAllProfiles(),U.travel.jsonObject=(new As).parse(t).jsonObject,U.editedRouteObjId=p,this.#nu(),Ko.saveStatus=d.saved}openLocalTrvFile(t){go.deleteAllProfiles();const e=JSON.parse(t);(new xo).decompress(e),U.travel.jsonObject=e,U.editedRouteObjId=p,U.travel.routes.forEach((t=>{l.notEdited!==t.editionStatus&&(U.editedRouteObjId=t.objId)})),this.#nu(),Ko.saveStatus=d.saved}#ru(t){const e=t.routes.iterator;for(;!e.done;)U.travel.routes.add(e.value);const o=t.notes.iterator;for(;!o.done;)U.travel.notes.add(o.value);this.#nu(),Ko.saveStatus=d.modified}mergeLocalGpxFile(t){this.#ru((new As).parse(t))}mergeLocalTrvFile(t){const e=JSON.parse(t);(new xo).decompress(e);const o=new z;o.jsonObject=e,this.#ru(o)}}class Bs{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();const e=t.target.files[0].name.split(".").pop().toLowerCase(),o=new FileReader;o.onload=()=>{try{switch(e){case"trv":(new ks).openLocalTrvFile(o.result);break;case"gpx":(new ks).openLocalGpxFile(o.result)}}catch(t){t instanceof Error&&(console.error(t),Ot.showError("An error occurs when reading the file : "+t.message))}},o.readAsText(t.target.files[0])}}class Fs{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{switch(t.target.files[0].name.split(".").pop().toLowerCase()){case"trv":(new ks).mergeLocalTrvFile(e.result);break;case"gpx":(new ks).mergeLocalGpxFile(e.result)}}catch(t){t instanceof Error&&(console.error(t),Ot.showError("An error occurs when reading the file : "+t.message))}},e.readAsText(t.target.files[0])}}const _s=new class extends Bo{constructor(){super()}createUI(){super.createUI("Travel & Notes",c.topRight)}addToolbarItems(){this.addToolbarItem(new Fo("🏠","Home",window.location.origin)),this.addToolbarItem(new Fo("?","Help","https://wwwouaiebe.github.io/TravelNotes/userGuides/README.html#")),this.addToolbarItem(new Fo("@","Contact",t.TravelNotesToolbar.contactMail.url||window.location.origin)),t.ApiKeysDialog.showButton&&this.addToolbarItem(new Fo("🔑",j.getText("TravelNotesToolbar - api keys"),(()=>{Ht.setKeysFromDialog()}))),this.addToolbarItem(Vo.status===i.active?new Fo("🏀",j.getText("TravelNotesToolbar - Stop Geo location"),(()=>{Vo.switch()})):new Fo("🌐",j.getText("TravelNotesToolbar - Start Geo location"),(()=>{Vo.switch()}))),this.addToolbarItem(new Fo("☢️",j.getText("TravelNotesToolbar - Save as travel"),(()=>{Yo.saveAsTravel()}))),this.addToolbarItem(new Fo("❌",j.getText("TravelNotesToolbar - Cancel travel"),(()=>{Yo.newTravel(),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name)}))),this.addToolbarItem(new Fo("💾",j.getText("TravelNotesToolbar - Save travel"),(()=>{Yo.saveTravel()}))),this.addToolbarItem(new Fo("📂",j.getText("TravelNotesToolbar - Open travel"),(()=>{t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(j.getText("TravelNotesToolbar - This page ask to close; data are perhaps not saved."))||S.openFile(new Bs,".trv,.gpx")}))),this.addToolbarItem(new Fo("🌏",j.getText("TravelNotesToolbar - Import travel"),(()=>{p===U.editedRouteObjId?S.openFile(new Fs,".trv,.gpx"):Ot.showError(j.getText("TravelNotesToolbar - Not possible to merge a travel when a route is edited"))}))),this.addToolbarItem(new Fo("📙",j.getText("TravelNotesToolbar - Open travel roadbook"),"TravelNotesRoadbook.html?lng="+t.travelNotes.language+"&page="+U.UUID)),this.addToolbarItem(new Fo("🛄",j.getText("TravelNotesToolbar - Travel properties"),(()=>{Hs.travelPropertiesDialog.show()}))),this.addToolbarItem(new Fo("🗨️",j.getText("TravelNotesToolbar - Travel notes"),(()=>{Hs.travelNotesDialog.show()}))),this.addToolbarItem(new Fo("🔍",j.getText("Search with OpenStreetMap"),(()=>{Hs.osmSearchDialog.show()}))),document.fullscreenEnabled&&this.addToolbarItem(document.fullscreenElement?new Fo("🔻",j.getText("TravelNotesToolbar - disable fullscreen"),(()=>Ps.toggle())):new Fo("🔺",j.getText("TravelNotesToolbar - enable fullscreen"),(()=>Ps.toggle()))),this.addToolbarItem(new Fo("+",j.getText("TravelNotesToolbar - Increment the font size"),(()=>{Rs.increment()}))),this.addToolbarItem(new Fo("-",j.getText("TravelNotesToolbar - Decrement the font size"),(()=>{Rs.decrement()}))),this.addToolbarItem(new Fo("🛠️",j.getText("TravelNotesToolbar - About Travel & Notes"),(()=>(new Uo).show())))}};class zs{#au;#it;#lu;static get#du(){return Object.freeze({bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625 H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /> </svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /> </g> </svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"> <path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"> <rect x="1" y="10" width="2" height="3" /> <rect x="11" y="10" width="2" height="3" /> </g> </g> </svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"> <path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2= "11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1= "16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'})}constructor(t,e){Object.freeze(this),this.#au=t,this.#it=e,this.#lu=W.create("img",{src:zs.#du[e],id:"TravelNotes-ProvidersToolbar-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbar-ImgButton",title:j.getText("ProvidersToolbar - TransitMode "+e)}),this.#lu.addEventListener("click",this),this.visible=!1}handleEvent(t){t.stopPropagation(),this.#au.transitMode=this.#it,this.#au.hide(),us.startRouting()}get buttonHTMLElement(){return this.#lu}get transitMode(){return this.#it}set active(t){t?this.#lu.classList.add("TravelNotes-ProvidersToolbar-ActiveTransitModeImgButton"):this.#lu.classList.remove("TravelNotes-ProvidersToolbar-ActiveTransitModeImgButton")}set visible(t){t?this.#lu.classList.remove("TravelNotes-Hidden"):this.#lu.classList.add("TravelNotes-Hidden")}}class Ks{#au;#st;#lu;constructor(t,e){Object.freeze(this),this.#au=t,this.#st=e,this.#lu=W.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbar-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbar-ImgButton",title:e.title||e.name}),this.#lu.addEventListener("click",this)}handleEvent(t){t.stopPropagation(),this.#au.provider=this.#st.name,us.startRouting()}get buttonHTMLElement(){return this.#lu}get provider(){return this.#st}set active(t){t?this.#lu.classList.add("TravelNotes-ProvidersToolbar-ActiveProviderImgButton"):this.#lu.classList.remove("TravelNotes-ProvidersToolbar-ActiveProviderImgButton")}}class Us{#To;#cu;#cd;#hu;#uu;#mu;#gu;#Xo;#pd;static get#pu(){return 100}static get#vd(){return 100}#vu(){["bike","pedestrian","car","train","line","circle"].forEach((t=>{const e=new zs(this,t);this.#hu.set(t,e),this.#cd.appendChild(e.buttonHTMLElement)}))}#Tu(){U.providers.forEach((t=>{if(!t.providerKeyNeeded||Ht.hasKey(t.name)){const e=new Ks(this,t);this.#uu.set(t.name,e),this.#cd.appendChild(e.buttonHTMLElement)}}))}#qe(){this.#Lu(),this.#pd=!0,setTimeout((()=>this.#Eu()),Us.#pu)}#Eu(){this.#cd.classList.remove("TravelNotes-Hidden")}#Td;#bu(t){Us.#vd>t.timeStamp-this.#Td||this.#yu(t)}#yu(t){if(this.#Td=t.timeStamp,this.#pd){if(this.#Xo)return clearTimeout(this.#Xo),void(this.#Xo=null);this.hide()}else this.#qe()}#wu(){this.#pd&&(this.#Xo=setTimeout((()=>this.hide()),t.toolbars.timeOut))}#Lu(){this.#cu.textContent=j.getText("ProvidersToolbar - Computed by {provider} for {transitMode}",{provider:U.routing.provider,transitMode:j.getText("ProvidersToolbar - TransitMode "+U.routing.transitMode)}),this.#To.style.left=String((U.map.getContainer().clientWidth-this.#To.clientWidth)/2)+"px"}constructor(){Object.freeze(this),this.#hu=new Map,this.#uu=new Map}hide(){this.#Xo&&(clearTimeout(this.#Xo),this.#Xo=null),this.#cd.classList.add("TravelNotes-Hidden"),this.#Lu(),this.#pd=!1}createUI(){this.#To=W.create("div",{className:"TravelNotes-ProvidersToolbar-Container"},document.body),this.#To.addEventListener("mouseenter",(t=>this.#yu(t)),!1),this.#To.addEventListener("mouseleave",(t=>this.#wu(t)),!1),this.#cu=W.create("div",{className:"TravelNotes-ProvidersToolbar-TopBar",textContent:j.getText("TravelNotes-ProvidersToolbar - Providers")},this.#To),this.#cu.addEventListener("click",(t=>this.#bu(t)),!1),this.#cd=W.create("div",{className:"TravelNotes-ProvidersToolbar-ImgButtonsDiv TravelNotes-Hidden"},this.#To),this.#vu(),this.#Tu(),this.provider=this.#uu.keys().next().value,this.#Lu()}set provider(t){U.routing.provider=t,this.#gu&&(this.#gu.active=!1),this.#gu=this.#uu.get(t),this.#gu.active=!0;const e=U.providers.get(t.toLowerCase());this.#hu.forEach((t=>{t.visible=T!==e.transitModes.indexOf(t.transitMode)})),this.#mu&&T!==e.transitModes.indexOf(this.#mu.transitMode)||(this.#mu=null,this.#hu.forEach((t=>{this.#mu||T===e.transitModes.indexOf(t.transitMode)?t.active=!1:(this.#mu=t,t.active=!0,U.routing.transitMode=t.transitMode)}))),this.#Lu()}set transitMode(t){U.routing.transitMode=t,this.#mu&&(this.#mu.active=!1),this.#mu=this.#hu.get(t),this.#mu.active=!0,this.#Lu()}providersAdded(){for(;this.#cd.firstChild;)this.#cd.removeChild(this.#cd.firstChild);this.#hu.clear(),this.#uu.clear(),this.#vu(),this.#Tu(),this.provider=this.#uu.keys().next().value;const t=this.#uu.keys().next().value;this.provider=t,this.transitMode=U.providers.get(t.toLowerCase()).transitModes[0],this.#Lu()}}const Vs=new Us;class Ws{static#fu;static#Mu(){Ws.#fu=!0,document.removeEventListener("touchstart",Ws.#Mu,!0)}constructor(){Object.freeze(this),Ws.#fu=!1,document.addEventListener("touchstart",Ws.#Mu,!0)}get isTouch(){return Ws.#fu}}const Xs=new Ws;class Ys extends Ee{constructor(t,e){super(t,e)}get menuItems(){return[new be(j.getText("MapContextMenu - Select this point as start point"),p!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat,(()=>ms.setStartPoint(this.latLng))),new be(j.getText("MapContextMenu - Select this point as way point"),p!==U.editedRouteObjId,(()=>ms.addWayPoint(this.latLng))),new be(j.getText("MapContextMenu - Select this point as end point"),p!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>ms.setEndPoint(this.latLng))),new be(j.getText("MapContextMenu - Select this point as start and end point"),p!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>ms.setStartAndEndPoint(this.latLng))),new be(j.getText("MapContextMenu - Add a route"),!0,(()=>Co.addRoute())),new be(j.getText("MapContextMenu - Hide all routes"),!0,(()=>Co.hideRoutes())),new be(j.getText("MapContextMenu - Show all routes"),!0,(()=>Co.showRoutes())),new be(j.getText("MapContextMenu - New travel note"),!0,(()=>io.newTravelNote(this.latLng))),new be(j.getText("MapContextMenu - Hide all notes"),!0,(()=>io.hideNotes())),new be(j.getText("MapContextMenu - Show all notes"),!0,(()=>io.showNotes())),new be(j.getText("MapContextMenu - Zoom to travel"),!0,(()=>(new no).zoomToTravel()))]}}class Gs{static handleEvent(){window.L.DomEvent.off(Io.marker,"mouseout",No.handleEvent)}}class Zs{static handleEvent(t){t.latlng.lat=Io.initialLatLng[0],t.latlng.lng=Io.initialLatLng[1],t.target.objId=U.travel.editedRoute.objId,new Ds(t).show()}}class Js{static handleEvent(t){U.mapObjects.get(U.travel.editedRoute.objId).openPopup(t.latlng)}}class qs{static handleEvent(t){ms.addWayPointOnRoute(Io.initialLatLng,[t.target.getLatLng().lat,t.target.getLatLng().lng]),Io.marker&&(window.L.DomEvent.off(Io.marker,"dragstart",Gs.handleEvent),window.L.DomEvent.off(Io.marker,"dragend",qs.handleEvent),window.L.DomEvent.off(Io.marker,"contextmenu",Zs.handleEvent),U.map.removeLayer(Io.marker),Io.marker=null)}}class $s{static#Iu=1;static handleEvent(e){const o=kt.getRoute(e.target.objId);if(Io.initialLatLng=[e.latlng.lat,e.latlng.lng],Io.marker)Io.marker.setLatLng(e.latlng);else{Io.marker=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[E,E],iconAnchor:[10,E],html:'<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>',className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});let s="";(T===t.route.showDragTooltip||$s.#Iu<=t.route.showDragTooltip)&&($s.#Iu++,s=j.getText("EditedRouteMouseOverEL - Drag and drop to add a waypoint")+" - "),s+=o.computedName+" - ";let i=ot.getClosestLatLngDistance(o,[e.latlng.lat,e.latlng.lng]).distance;i+=o.chainedDistance,s+=S.formatDistance(i),Io.marker.bindTooltip(s),Io.marker.getTooltip().options.offset=[0,0],Io.marker.addTo(U.map),window.L.DomEvent.on(Io.marker,"mouseout",No.handleEvent),window.L.DomEvent.on(Io.marker,"dragstart",Gs.handleEvent),window.L.DomEvent.on(Io.marker,"dragend",qs.handleEvent),window.L.DomEvent.on(Io.marker,"contextmenu",Zs.handleEvent),window.L.DomEvent.on(Io.marker,"click",Js.handleEvent)}}}class Qs{static createFakeEvent(e){const o=kt.getNearestRouteData([e.latlng.lat,e.latlng.lng]);if(!o.route)return;const s=window.L.latLng(o.latLngOnRoute[0],o.latLngOnRoute[1]),i=U.map.latLngToContainerPoint(s);return i.distanceTo(e.containerPoint)>(Xs.isTouch?t.mapContextMenu.touchMaxRouteDistance:t.mapContextMenu.mouseMaxRouteDistance)?void 0:Object.freeze({clientX:i.x,clientY:i.y,latlng:s,target:o.route})}static handleClickEvent(t){const e=Qs.createFakeEvent(t);e&&Xs.isTouch&&e.target.editionStatus!==l.notEdited&&$s.handleEvent(e)}static handleContextMenuEvent(t){const e=Qs.createFakeEvent(t);e?new Ds(e).show():new Ys(t).show()}}const ti=new class{#Nu=!1;constructor(){Object.freeze(this)}async addReadOnlyTravel(t){if(this.#Nu)return;this.#Nu=!0,jo.createUI(),So.setMapLayer("OSM - Color");const e=await fetch(t);g===e.status&&e.ok?(new Oo).openDistantFile(await e.json()):(U.map.setView([a.defaultValue,a.defaultValue],2),document.title="Travel & Notes")}addToolbarsMenusUIs(){this.#Nu||(this.#Nu=!0,document.title="Travel & Notes",U.map.on("contextmenu",Qs.handleContextMenuEvent),U.map.on("click",Qs.handleClickEvent),U.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),jo.createUI(),Ko.createUI(),Ko.saveStatus=d.saved,Ot.showHelp("<p>"+j.getText("Help - Continue with interface1")+"</p><p>"+j.getText("Help - Continue with interface2")+"</p>"),_o.createUI(),So.setMapLayer("OSM - Color"),_s.createUI(),Vs.createUI(),Ht.setKeysFromServerFile(),U.travel.jsonObject=(new z).jsonObject,t.travelNotes.startupRouteEdition&&Co.editRoute(U.travel.routes.first.objId),St.dispatch("setrouteslist"),St.dispatch("roadbookupdate"),Ps.show())}addProvider(t){Ht.addProvider(t)}showInfo(t){Ot.showInfo(t)}get overpassApiUrl(){return t.overpassApi.url}get map(){return U.map}get version(){return w}};class ei{#Cu(t,e){if("object"==typeof t&&"object"==typeof e){for(const o in e)"object"==typeof e[o]?this.#Cu(t[o],e[o]):typeof t[o]==typeof e[o]&&("string"==typeof e[o]?e[o]="color"===o?O.sanitizeToColor(t[o])||e[o]:"url"===o?O.sanitizeToUrl(t[o]).url:O.sanitizeToJsString(t[o]):e[o]=t[o]||e[o]);for(const o in t)"object"==typeof t[o]?("[object Array]"===Object.prototype.toString.call(t[o])?e[o]=e[o]||[]:e[o]=e[o]||{},this.#Cu(t[o],e[o])):"string"==typeof e.property?e[o]=O.sanitizeToHtmlString(t[o],[]).htmlString:e[o]=t[o]}}#Du(t){for(const e in t)"object"==typeof t[e]&&this.#Du(t[e]);Object.freeze(t)}constructor(){Object.freeze(this)}overload(e){this.#Cu(e,t),this.#Du(t)}}const oi=new class{#xu(t,e){const s=W.create("div"),i=W.create("div",{className:t+"Route-ManeuversAndNotes-IconCell"},s);W.create("div",{className:"TravelNotes-ManeuverNote TravelNotes-ManeuverNote-"+e.maneuver.iconName},i),i.dataset.tanWidth=String(n.width)+"px",i.dataset.tanHeight=String(n.height)+"px";const r=W.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},s);return W.create("div",{className:t+"Route-Maneuver-TooltipContent",textContent:j.getText("RouteHTMLViewsFactory - "+e.maneuver.iconName)},r),O.sanitizeToHtmlElement(e.maneuver.instruction,W.create("div",{className:t+"Route-Maneuver-Instruction"},r)),e.route.chain&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+S.formatDistance(e.route.chainedDistance+e.maneuverDistance),W.create("div",{className:t+"Route-Maneuver-TravelDistance"},r)),O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+S.formatDistance(e.maneuverDistance),W.create("div",{className:t+"Route-Maneuver-RouteDistance"},r)),o.defaultValue<e.maneuver.distance&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+S.formatDistance(e.maneuver.distance),W.create("div",{className:t+"Route-Maneuver-NextDistance"},r)),s}constructor(){Object.freeze(this)}getRouteProfileHTML(t,e){const o=W.create("div",{className:t+"RouteProfile"});return O.sanitizeToHtmlElement(j.getText("RouteHTMLViewsFactory - Profile"),o),o.appendChild((new de).createSvg(e)),o}getRouteManeuversAndNotesHTML(t,e,o){const s=[],i=e.notes.iterator;for(;!i.done;)s.push({data:i.value,distance:i.value.distance});const n=e.itinerary.maneuvers.iterator;let r=0;for(;!n.done;)s.push({data:n.value,distance:r}),r+=n.value.distance;s.sort(((t,e)=>t.distance-e.distance));const a=W.create("div",{className:t+"Route-ManeuversAndNotes"});return s.forEach((s=>{let i=null;"Note"===s.data.objType.name?(i=ke.getNoteTextAndIconHTML(t,{note:s.data,route:e}),i.className=t+"Route-Notes-Row"):(i=this.#xu(t,{route:e,maneuver:s.data,maneuverDistance:s.distance}),i.className=t+"Route-Maneuvers-Row"),o&&(i.dataset.tanObjId=s.data.objId,i.dataset.tanMarkerObjId=b.nextObjId,i.dataset.tanObjType=s.data.objType.name),a.appendChild(i)})),a}getRouteHeaderHTML(t,e){const o=W.create("div",{className:t+"Route-Header",id:"route"+e.objId});return O.sanitizeToHtmlElement(e.computedName,W.create("div",{className:t+"Route-Header-Name"},o)),0!==e.distance&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+S.formatDistance(e.distance),W.create("div",{className:t+"Route-Header-Distance"},o)),U.travel.readOnly||"bike"===e.itinerary.transitMode||O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+S.formatTime(e.duration),W.create("div",{className:t+"Route-Header-Duration"},o)),e.itinerary.hasProfile&&(O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(e.itinerary.ascent.toFixed(0))+" m.",W.create("div",{className:t+"Route-Header-Ascent"},o)),O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(e.itinerary.descent.toFixed(0))+" m.",W.create("div",{className:t+"Route-Header-Descent"},o))),o}getRouteFooterHTML(t,e){let o=""!==e.itinerary.provider&&""!==e.itinerary.transitMode?j.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:j.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}):"";const s=W.create("div",{className:t+"RouteFooter"});return O.sanitizeToHtmlElement(o,s),s}};class si{static handleEvent(t){const e=kt.getRoute(t.target.objId);let o=ot.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;o+=e.chainedDistance,o=S.formatDistance(o);const s=U.mapObjects.get(t.target.objId);s.closeTooltip();let i=e.computedName;U.travel.readOnly||(i+=0===i.length?"":" - ",i+=o),s.setTooltipContent(i),s.openTooltip(t.latlng)}}class ii{#Sa;#Ou;#ju;constructor(t,e,o){Object.freeze(this),this.#Sa=t,this.#Ou=e,this.#ju=o}get marker(){return this.#Sa}get polyline(){return this.#Ou}get bullet(){return this.#ju}}class ni{#Su;#Hu;static get#Pu(){return 18}static get#Ru(){return 0}static get#Au(){return 100}constructor(){Object.freeze(this),this.#Su=null,this.#Hu=null}addToMap(t,e){e.objId=t,e.addTo(U.map),U.mapObjects.set(t,e)}addRoute(t){const e=kt.getRoute(t),o=[],s=e.itinerary.itineraryPoints.iterator;for(;!s.done;)o.push(s.value.latLng);const i=window.L.polyline(o,{color:e.color,weight:e.width,dashArray:e.dashString});this.addToMap(e.objId,i),l.notEdited===e.editionStatus&&(i.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),Xs.isTouch||(window.L.DomEvent.on(i,"mouseover",si.handleEvent),window.L.DomEvent.on(i,"mousemove",si.handleEvent),i.bindPopup((t=>O.clone(oi.getRouteHeaderHTML("TravelNotes-Map-",kt.getRoute(t.objId))))),window.L.DomEvent.on(i,"click",(t=>t.target.openPopup(t.latlng)))));const n=e.notes.iterator;for(;!n.done;)this.addNote(n.value.objId);return e}addNote(e){const o=kt.getNoteAndRoute(e).note,s=window.L.marker(o.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!U.travel.readOnly});s.objId=o.objId;const i=window.L.marker(o.iconLatLng,{zIndexOffset:ni.#Au,icon:window.L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:"TravelNotes-Map-AllNotes "}),draggable:!U.travel.readOnly});i.objId=o.objId,i.bindPopup((t=>O.clone(ke.getNoteTextHTML("TravelNotes-Map-",kt.getNoteAndRoute(t.objId))))),0!==o.tooltipContent.length&&(i.bindTooltip((t=>kt.getNoteAndRoute(t.objId).note.tooltipContent)),i.getTooltip().options.offset[0]=o.iconWidth/2);const n=window.L.polyline([o.latLng,o.iconLatLng],t.note.polyline);n.objId=o.objId;const r=window.L.layerGroup([i,n,s]);return r.markerId=window.L.Util.stamp(i),r.polylineId=window.L.Util.stamp(n),r.bulletId=window.L.Util.stamp(s),this.addToMap(o.objId,r),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),new ii(i,n,s)}zoomTo(e,o){if(o){let t=[];o.forEach((e=>t=t.concat(e))),U.map.fitBounds(ot.getLatLngBounds(t))}else U.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){const o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);this.#Su&&U.map.removeLayer(this.#Su),U.map.addLayer(o),this.#Su=o,U.travel.readOnly||(U.map.getZoom()<(t.minZoom||ni.#Ru)&&U.map.setZoom(t.minZoom||ni.#Ru),U.map.setMinZoom(t.minZoom||ni.#Ru),U.map.getZoom()>(t.maxZoom||ni.#Pu)&&U.map.setZoom(t.maxZoom||ni.#Pu),U.map.setMaxZoom(t.maxZoom||ni.#Pu),t.bounds?(U.map.getBounds().intersects(t.bounds)&&!U.map.getBounds().contains(t.bounds)||(U.map.setMaxBounds(null),U.map.fitBounds(t.bounds),U.map.setZoom(t.minZoom||ni.#Ru)),U.map.setMaxBounds(t.bounds)):U.map.setMaxBounds(null)),U.map.fire("baselayerchange",o)}onGeolocationStatusChanged(t){i.active!==t&&this.#Hu&&(U.map.removeLayer(this.#Hu),this.#Hu=null)}onGeolocationPositionChanged(e){let o=t.geoLocation.zoomToPosition;this.#Hu&&(U.map.removeLayer(this.#Hu),o=!1);let s="Position (+/- "+e.coords.accuracy.toFixed(0)+" m) : <br/>"+S.formatLatLngDMS([e.coords.latitude,e.coords.longitude])+"<br/>"+S.formatLatLng([e.coords.latitude,e.coords.longitude])+"<br/>";e.coords.altitude&&(s+="<br/> Altitude  :<br/>"+e.coords.altitude.toFixed(0)+" m",e.coords.altitudeAccuracy&&(s+="(+/- "+e.coords.altitudeAccuracy.toFixed(0)+" m)")),0===t.geoLocation.marker.radius?this.#Hu=window.L.circle(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).setRadius(e.coords.accuracy.toFixed(0)):this.#Hu=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker),this.#Hu.bindTooltip(s).addTo(U.map),t.geoLocation.watch||this.#Hu.bindPopup(s).openPopup(),this.#Hu.on("click",(t=>{const e=t.target.getTooltip().getContent();t.target.getTooltip().setContent(e+"Copied"),navigator.clipboard.writeText(e.replaceAll("<br/>","\n")).then((()=>{t.target.getTooltip().setContent(e+"<br/><br/>"+j.getText("MapEditorViewer -Copied to clipboard"))})).catch((()=>console.error("Failed to copy to clipboard ")))})),o&&U.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class ri{static handleEvent(t){const e=kt.getNoteAndRoute(t.target.objId),o=e.note,s=e.route,i=U.mapObjects.get(t.target.objId);if(null===s)o.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],St.dispatch("updatetravelnotes");else{const e=ot.getClosestLatLngDistance(s,[t.target.getLatLng().lat,t.target.getLatLng().lng]);o.latLng=e.latLng,o.distance=e.distance,s.notes.sort(((t,e)=>t.distance-e.distance)),i.getLayer(i.bulletId).setLatLng(e.latLng),St.dispatch("updateitinerary")}i.getLayer(i.polylineId).setLatLngs([o.latLng,o.iconLatLng]),St.dispatch("roadbookupdate")}}class ai{static handleEvent(t){const e=kt.getNoteAndRoute(t.target.objId).note,o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],e.iconLatLng])}}class li{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}}class di{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}}class ci{static handleEvent(t){new js(t).show()}}class hi{static handleEvent(t){const e=kt.getNoteAndRoute(t.target.objId).note;e.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];const o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([e.latLng,e.iconLatLng])}}class ui{static handleEvent(t){const e=kt.getNoteAndRoute(t.target.objId).note,o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([e.latLng,[t.latlng.lat,t.latlng.lng]])}}class mi extends Ee{constructor(t,e){super(t,e)}get menuItems(){return[new be(j.getText("WayPointContextMenu - Delete this waypoint"),U.travel.editedRoute.wayPoints.first.objId!==this.targetObjId&&U.travel.editedRoute.wayPoints.last.objId!==this.targetObjId,(()=>ms.removeWayPoint(this.targetObjId))),new be(j.getText("WayPointContextMenu - Modify properties"),!0,(()=>ms.wayPointProperties(this.targetObjId)))]}}class gi{static handleEvent(t){new mi(t).show()}}class pi{static handleEvent(t){ms.wayPointDragEnd(t)}}class vi{static handleEvent(t){window.L.DomEvent.stopPropagation(t),new Ds(t).show()}}class Ti extends ni{static get#ku(){return.01}#Bu(t){const e=U.mapObjects.get(t);e&&(window.L.DomEvent.off(e),U.map.removeLayer(e),U.mapObjects.delete(t))}constructor(){super()}updateRoute(t,e){if(p!==t){const e=kt.getRoute(t);this.#Bu(e.objId);const o=e.notes.iterator;for(;!o.done;)this.#Bu(o.value.objId);const s=e.wayPoints.iterator;for(;!s.done;)this.#Bu(s.value.objId)}if(p!==e){const t=this.addRoute(e),o=U.mapObjects.get(e);if(!U.travel.readOnly){window.L.DomEvent.on(o,"contextmenu",vi.handleEvent),l.notEdited===t.editionStatus||Xs.isTouch||window.L.DomEvent.on(o,"mouseover",$s.handleEvent);const e=t.notes.iterator;for(;!e.done;){const t=U.mapObjects.get(e.value.objId),o=t.getLayer(t.markerId),s=t.getLayer(t.bulletId);window.L.DomEvent.on(s,"dragend",ri.handleEvent),window.L.DomEvent.on(s,"drag",ai.handleEvent),window.L.DomEvent.on(s,"mouseenter",li.handleEvent),window.L.DomEvent.on(s,"mouseleave",di.handleEvent),window.L.DomEvent.on(o,"contextmenu",ci.handleEvent),window.L.DomEvent.on(o,"dragend",hi.handleEvent),window.L.DomEvent.on(o,"drag",ui.handleEvent)}}if(!U.travel.readOnly&&l.notEdited!==t.editionStatus){const t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)this.addWayPoint(t.value,t.first?"A":t.last?"B":t.index)}}}updateRouteProperties(t){const e=U.mapObjects.get(t),o=kt.getRoute(t);e.setStyle({color:o.color,weight:o.width,dashArray:o.dashString})}updateNote(t,e){let o=!1;if(p!==t){const e=U.mapObjects.get(t);e&&(o=e.getLayer(e.markerId).isPopupOpen()),this.#Bu(t)}if(p!==e){const t=this.addNote(e);o&&t.marker.openPopup(),U.travel.readOnly||(window.L.DomEvent.on(t.bullet,"dragend",ri.handleEvent),window.L.DomEvent.on(t.bullet,"drag",ai.handleEvent),window.L.DomEvent.on(t.bullet,"mouseenter",li.handleEvent),window.L.DomEvent.on(t.bullet,"mouseleave",di.handleEvent),window.L.DomEvent.on(t.marker,"contextmenu",ci.handleEvent),window.L.DomEvent.on(t.marker,"dragend",hi.handleEvent),window.L.DomEvent.on(t.marker,"drag",ui.handleEvent))}}removeObject(t){this.#Bu(t)}removeAllObjects(){U.mapObjects.forEach((t=>{window.L.DomEvent.off(t),U.map.removeLayer(t)})),U.mapObjects.clear()}addWayPoint(t,e){if(a.defaultValue===t.lat&&a.defaultValue===t.lng)return;const o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===e?"Start":"B"===e?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+e+"</div>",s=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[E,E],iconAnchor:[10,E],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});s.bindTooltip((t=>kt.getWayPoint(t.objId).fullName)),s.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(s,"contextmenu",gi.handleEvent),s.objId=t.objId,this.addToMap(t.objId,s),window.L.DomEvent.on(s,"dragend",pi.handleEvent)}addItineraryPointMarker(e,o){this.addToMap(e,window.L.circleMarker(o,t.itineraryPoint.marker))}addSearchPointMarker(e,o,s){let i=!1;if(s){let t=[];s.forEach((e=>{t=t.concat(e)}));const e=ot.getLatLngBounds(t),o=U.map.getBounds();i=(e.getEast()-e.getWest())/(o.getEast()-o.getWest())>Ti.#ku&&(e.getNorth()-e.getSouth())/(o.getNorth()-o.getSouth())>Ti.#ku}i?this.addToMap(e,window.L.polyline(s,t.osmSearch.searchPointPolyline)):this.addToMap(e,window.L.circleMarker(o,t.osmSearch.searchPointMarker))}addRectangle(t,e,o){this.addToMap(t,window.L.rectangle(e,o))}setLayer(t){const e=Ht.getUrl(t);e&&super.setLayer(t,e)}}const Li=new Ti;class Ei{#Fu;#St;#_u;static get#zu(){return 1}#Ku(t,e){if(this.#Fu)return void t();const o=window.indexedDB.open("TravelNotesDb",Ei.#zu);o.onerror=()=>{this.#Fu=null,e(new Error("Not possible to open the db"))},o.onsuccess=e=>{this.#Fu=e.target.result,t()},o.onupgradeneeded=t=>{this.#Fu=t.target.result,this.#Fu.createObjectStore("Travels",{keyPath:"UUID"})}}#Uu(t,e){if(!this.#Fu)return void e(new Error("Database not opened"));const o=this.#Fu.transaction(["Travels"],"readonly");o.onerror=()=>e(new Error("Transaction error"));o.objectStore("Travels").get(this.#St).onsuccess=e=>t(e.target.result?e.target.result.data:null)}#Vu(t,e){if(!this.#Fu)return void e(new Error("Database not opened"));const o=this.#Fu.transaction(["Travels"],"readwrite");o.onerror=()=>e(new Error("Transaction error"));o.objectStore("Travels").put({UUID:this.#St,data:this.#_u}).onsuccess=()=>t()}#Wu(){this.#Fu.close(),this.#Fu=null}constructor(){Object.freeze(this)}getOpenPromise(){return new Promise(((t,e)=>this.#Ku(t,e)))}getReadPromise(t){return this.#St=t,new Promise(((t,e)=>this.#Uu(t,e)))}getWritePromise(t,e){return this.#St=t,this.#_u=e,new Promise(((t,e)=>this.#Vu(t,e)))}closeDb(t){if(!this.#Fu)return;if(!t)return void this.#Wu();const e=this.#Fu.transaction(["Travels"],"readwrite");e.onerror=()=>{};const o=e.objectStore("Travels").delete(t);o.onerror=()=>this.#Wu(),o.onsuccess=()=>this.#Wu()}}const bi=new Ei;const yi=new class{#Xu(e){const s=W.create("div",{className:e+"Travel-Header"});O.sanitizeToHtmlElement(U.travel.name,W.create("div",{className:e+"Travel-Header-Name"},s));let i=o.defaultValue,n=0,r=0;const a=U.travel.routes.iterator;for(;!a.done;){const o=a.value.objId===U.editedRouteObjId&&t.routeEditor.showEditedRouteInRoadbook?U.travel.editedRoute:a.value;O.sanitizeToHtmlElement('<a href="#route'+o.objId+'" >'+o.computedName+"</a> : "+S.formatDistance(o.distance)+".",W.create("div",{className:e+"Travel-Header-RouteName"},s)),o.chain&&(i+=o.distance,n+=o.itinerary.ascent,r+=o.itinerary.descent)}return O.sanitizeToHtmlElement("<span>"+j.getText("TravelHTMLViewsFactory - Travel distance")+"</span> : "+S.formatDistance(i),W.create("div",{className:e+"Travel-Header-TravelDistance"},s)),0!==n&&O.sanitizeToHtmlElement("<span>"+j.getText("travelHTMLViewsFactory - Travel ascent")+"</span> : "+String(n.toFixed(0))+" m.",W.create("div",{className:e+"Travel-Header-TravelAscent"},s)),0!==r&&O.sanitizeToHtmlElement("<span>"+j.getText("TravelHTMLViewsFactory - Travel descent")+"</span> : "+String(r.toFixed(0))+" m.",W.create("div",{className:e+"Travel-Header-TravelDescent"},s)),s}#Yu(t){const e=j.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 '+new Date(Date.now()).getFullYear()+'</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+j.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",o=W.create("div",{className:t+"TravelFooter"});return O.sanitizeToHtmlElement(e,o),o}constructor(){Object.freeze(this)}getTravelHTML(e){const o=W.create("div",{className:e+"Travel"});o.appendChild(this.#Xu(e)),o.appendChild(ke.getTravelNotesHTML(e));const s=U.travel.routes.iterator;for(;!s.done;){const i=t.routeEditor.showEditedRouteInRoadbook&&s.value.objId===U.editedRouteObjId?U.travel.editedRoute:s.value;o.appendChild(oi.getRouteHeaderHTML(e,i)),i.itinerary.hasProfile&&o.appendChild(oi.getRouteProfileHTML(e,i)),o.appendChild(oi.getRouteManeuversAndNotesHTML(e,i,!1)),o.appendChild(oi.getRouteFooterHTML(e,i))}return o.appendChild(this.#Yu(e)),o}};class wi{#Gu;constructor(){Object.freeze(this),this.#Gu=S.storageAvailable("localStorage")}handleEvent(){Ko.saveStatus=d.modified,this.#Gu&&bi.getOpenPromise().then((()=>{bi.getWritePromise(U.UUID,yi.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(U.UUID,Date.now()))).catch((t=>{t instanceof Error&&console.error(t)}))}}class fi{static addEventsListeners(){document.addEventListener("routeupdated",(t=>{t.data&&Li.updateRoute(t.data.removedRouteObjId,t.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(t=>{t.data&&Li.updateRouteProperties(t.data.routeObjId)}),!1),document.addEventListener("noteupdated",(t=>{t.data&&Li.updateNote(t.data.removedNoteObjId,t.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(t=>{t.data&&Li.removeObject(t.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>Li.removeAllObjects()),!1),document.addEventListener("zoomto",(t=>{t.data&&Li.zoomTo(t.data.latLng,t.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(t=>{t.data&&Li.addItineraryPointMarker(t.data.objId,t.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(t=>{t.data&&Li.addSearchPointMarker(t.data.objId,t.data.latLng,t.data.geometry)}),!1),document.addEventListener("addrectangle",(t=>{t.data&&Li.addRectangle(t.data.objId,t.data.bounds,t.data.properties)}),!1),document.addEventListener("addwaypoint",(t=>{t.data&&Li.addWayPoint(t.data.wayPoint,t.data.letter)}),!1),document.addEventListener("layerchange",(t=>{t.data&&Li.setLayer(t.data.layer)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&Li.onGeolocationPositionChanged(t.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&Li.onGeolocationStatusChanged(t.data.status)}),!1),document.addEventListener("roadbookupdate",new wi,!1),document.addEventListener("profileclosed",(t=>{t.data&&go.onProfileClosed(t.data.objId)}),!1),document.addEventListener("setrouteslist",(()=>Hs.travelPropertiesDialog.updateContent()),!1),document.addEventListener("updatetravelnotes",(()=>Hs.travelNotesDialog.updateContent()),!1),document.addEventListener("showsearch",(()=>Hs.osmSearchDialog.updateContent()),!1),document.addEventListener("showtravelproperties",(()=>Hs.showTravelProperties()),!1),document.addEventListener("providersadded",(()=>Vs.providersAdded()),!1),document.addEventListener("setprovider",(t=>{t?.data?.provider&&(Vs.provider=t.data.provider)}),!1),document.addEventListener("settransitmode",(t=>{t?.data?.transitMode&&(Vs.transitMode=t.data.transitMode)}),!1)}static addUnloadEventsListeners(){window.addEventListener("unload",(()=>localStorage.removeItem(U.UUID))),window.addEventListener("beforeunload",(e=>{if(bi.closeDb(U.UUID),t.travelNotes.haveBeforeUnloadWarning)return e.returnValue="x","x"}))}}(new class{#Zu;#Ju;#qu;#$u;#Qu(){const t=new URL(window.location);let e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");const o=new URL(e);if(!(t.protocol&&o.protocol&&t.protocol===o.protocol&&t.hostname&&o.hostname&&t.hostname===o.hostname))throw new Error("The distant file is not on the same site than the app");this.#Zu=encodeURI(o.href)}catch(t){t instanceof Error&&console.error(t)}const o=t.searchParams.get("lng");o&&o.match(/^[A-Z,a-z]{2}$/)&&(this.#Ju=o.toLowerCase())}async#tm(){const e=await fetch(this.#qu+"Config.json");if(g===e.status&&e.ok){const o=await e.json();return o.travelNotes.language=this.#Ju||o.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(o.ApiKeysDialog.haveUnsecureButtons=!0,o.errorsUI.showHelp=!0,o.mapLayersToolbar.theDevil.addButton=!1,o.note.maxManeuversNotes=12,o.note.haveBackground=!0,o.noteDialog.theDevil.addButton=!1,o.printRouteMap.maxTiles=10,o.route.showDragTooltip=T),(new ei).overload(o),U.providers.forEach((e=>{e.userLanguage=t.travelNotes.language})),!0}return!1}async#em(t,e){return"fulfilled"===t.status&&g===t.value.status&&t.value.ok?(j.setTranslations(await t.value.json()),!0):"fulfilled"===e.status&&g===e.value.status&&e.value.ok?(j.setTranslations(await e.value.json()),this.#$u+="Not possible to load the TravelNotes"+this.#Ju.toUpperCase()+".json file. English will be used. ",!0):(this.#$u+="Not possible to load the translations. ",!1)}async#om(t,e){if("fulfilled"===t.status&&g===t.value.status&&t.value.ok){const e=await t.value.json();return fe.loadJson(e),!0}if("fulfilled"===e.status&&g===e.value.status&&e.value.ok){const t=await e.value.json();return fe.loadJson(t),this.#$u+="Not possible to load the TravelNotesNoteDialog"+this.#Ju.toUpperCase()+".json file. English will be used. ",!0}return this.#$u+="Not possible to load the translations for the note dialog. ",!1}async#sm(t,e){return"fulfilled"===t.status&&g===t.value.status&&t.value.ok?(qo.parseDictionary(await t.value.text()),!0):"fulfilled"===e.status&&g===e.value.status&&e.value.ok?(qo.parseDictionary(await e.value.text()),this.#$u+="Not possible to load the TravelNotesSearchDictionary"+this.#Ju.toUpperCase()+".csv file. English will be used. ",!0):(this.#$u+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async#im(t){return"fulfilled"===t.status&&g===t.value.status&&t.value.ok?(bo.addMapLayers(await t.value.json()),!0):(this.#$u+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async#nm(){const t=await Promise.allSettled([fetch(this.#qu+this.#Ju.toUpperCase()+".json"),fetch(this.#qu+"EN.json"),fetch(this.#qu+"NoteDialog"+this.#Ju.toUpperCase()+".json"),fetch(this.#qu+"NoteDialogEN.json"),fetch(this.#qu+"SearchDictionary"+this.#Ju.toUpperCase()+".csv"),fetch(this.#qu+"SearchDictionaryEN.csv"),fetch(this.#qu+"Layers.json")]),e=await this.#em(t[0],t[1])&&await this.#om(t[2],t[3])&&await this.#sm(t[4],t[5])&&await this.#im(t[6]);return""!==this.#$u&&e?Ot.showError(this.#$u):""!==this.#$u&&(document.body.textContent=this.#$u),e}#rm(){document.body.style["font-size"]=String(t.fontSize.initialValue)+"mm";const e=document.createElement("div");e.id="TravelNotes-Map",document.body.appendChild(e),U.map=window.L.map(e.id,{attributionControl:!1,zoomControl:!1}).setView([a.defaultValue,a.defaultValue],0),this.#Zu?ti.addReadOnlyTravel(this.#Zu):(fi.addUnloadEventsListeners(),ti.addToolbarsMenusUIs())}constructor(){Object.freeze(this),this.#qu=window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",this.#$u=""}async loadApp(){fi.addEventsListeners(),window.TaN=ti,this.#Qu(),await this.#tm()?(this.#Ju=this.#Ju||t.travelNotes.language||"fr",Ot.createUI(),await this.#nm()&&this.#rm()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();