/**
 * 
 * @source: https://github.com/wwwouaiebe/TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * travelnotes - version 4.0.0-beta
 * Build 02351 - 2022-09-16T14:58:43+0200 
 * Copyright 2017 2022 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";const t={ApiKeys:{saveToSessionStorage:!0},ApiKeysDialog:{haveUnsecureButtons:!0,showApiKeys:!1,showButton:!0},baseDialog:{cancelTouchX:100,cancelTouchY:150,deltaZoomDistance:75,touchTopScreen:!0},contextMenu:{timeout:1500},dockableBaseDialog:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!1,showInfo:!0,showWarning:!0,timeOut:1e4},files:{openGpx:["gpx"],openTaN:["json","trv"],writeTouch:"trv",writeOthers:"trv"},fontSize:{initialValue:3.5,incrementValue:.5},FullScreenUI:{timeOut:5e3,screenMaxWidth:1200},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:0},options:{enableHighAccuracy:!0,maximumAge:0,timeout:36e5},watch:!0,zoomFactor:17,zoomToPosition:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},mapContextMenu:{mouseMaxRouteDistance:10,touchMaxRouteDistance:10},mapLayersToolbar:{theDevil:{addButton:!0}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:6,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},theDevil:{addButton:!0,zoomFactor:17}},osmSearchDialog:{dialogX:50,dialogY:0},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},printRouteMap:{firefoxBrowser:!0,isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,printNotes:!0,borderWidth:10,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashIndex:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:2.5,smoothPoints:3},showDragTooltip:0,width:5},routeEditor:{showEditedRouteInRoadbook:!0},toolbars:{timeOut:1500},travelNotes:{haveBeforeUnloadWarning:!0,language:"fr",startupRouteEdition:!0},TravelNotesToolbar:{contactMail:{url:"https://github.com/wwwouaiebe/TravelNotes/issues"}},travelNotesDialog:{dialogX:250,dialogY:0},travelPropertiesDialog:{dialogX:50,dialogY:0},wayPoint:{reverseGeocoding:!0,geocodingIncludeName:!0}};class e{static get d0(){return 0}static get d90(){return 90}static get d180(){return 180}static get d270(){return 270}static get d360(){return 360}static get d540(){return 540}static get toRadians(){return Math.PI/180}static get fromRadians(){return 180/Math.PI}}class o{static get fixed(){return 2}static get invalid(){return-1}static get defaultValue(){return 0}static get metersInKm(){return 1e3}}class s{static get fixed(){return 2}static get defaultValue(){return 0}}class i{static get refusedByUser(){return-1}static get disabled(){return 0}static get inactive(){return 1}static get active(){return 2}}class n{static get width(){return 40}static get height(){return 40}static get svgViewboxDim(){return 200}}class r{static get atStart(){return-1}static get onRoute(){return 0}static get atEnd(){return 1}}class a{static get defaultValue(){return 0}static get fixed(){return 6}static get maxLat(){return 90}static get minLat(){return-90}static get maxLng(){return 180}static get minLng(){return-180}}class l{static get notEdited(){return 0}static get editedNoChange(){return 1}static get editedChanged(){return 2}}class d{static get notSaved(){return"🔴"}static get modified(){return"🟡"}static get saved(){return"🟢"}}class c{static get topLeft(){return"TravelNotes-BaseToolbar-TopLeft"}static get topRight(){return"TravelNotes-BaseToolbar-TopRight"}static get bottomLeft(){return"TravelNotes-BaseToolbar-BottomLeft"}static get bottomRight(){return"TravelNotes-BaseToolbar-BottomRight"}}const h=40,u=6371e3,m=16,p=200,g=-1,v=[.3,10,1],T=-1,L="http://www.w3.org/2000/svg",E=20;class b{static#t=0;static get nextObjId(){return++b.#t}}const y="2.4.0",w="v4.0.0-RC1";class f{#e="";#o=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];#s=[];constructor(t,e){if(Object.freeze(this),T===this.#o.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.#e=t,this.#s=e,Object.freeze(this.#s)}get name(){return this.#e}get version(){return y}get properties(){return this.#s}get jsonObject(){return{name:this.#e,version:y}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.#e);if(this.#e!==t.name)throw new Error("Invalid name for "+this.#e);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.#e)}}class M{#i=null;#n=T;constructor(t){Object.freeze(this),this.#i=t}get value(){return this.#n<this.#i.length?this.#i.at(this.#n):null}get previous(){return 0>=this.#n?null:this.#i.at(this.#n-1)}get next(){return this.#n<this.#i.length-1?this.#i.at(this.#n+1):null}get done(){return++this.#n>=this.#i.length}get first(){return 0===this.#n}get last(){return this.#n>=this.#i.length-1}get index(){return this.#n}}class I{#r;#a;#l;#d(t){return this.#r.findIndex((e=>e.objId===t))}#c(t,e,o){let s=this.#d(t);if(T===s)throw new Error("invalid objId for next or previous function");if(1!==o&&-1!==o)throw new Error("invalid direction");let i=e;for(i||(i=()=>!0),s+=o;T<s&&s<this.#r.length&&!i(this.#r[s]);)s+=o;return T===s||this.#r.length===s?null:this.#r[s]}constructor(t){Object.freeze(this),this.#r=[],this.#l=t;const e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.#a=e.objType.name}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.#a)throw new Error("invalid object name for add function");this.#r.push(t)}at(t){return t<this.#r.length&&t>T?this.#r[t]:null}forEach(t){let e=null;const o=this.iterator;for(;!o.done;)e=t(o.value,e);return e}getAt(t){const e=this.#d(t);return T===e?null:this.#r[e]}moveTo(t,e,o){let s=this.#d(t),i=this.#d(e);if(T===s||T===i)throw new Error("invalid objId for function  myMoveTo");o||i++,this.#r.splice(i,0,this.#r[s]),i<s&&s++,this.#r.splice(s,1)}next(t,e){return this.#c(t,e,1)}previous(t,e){return this.#c(t,e,-1)}remove(t){const e=this.#d(t);if(T===e)throw new Error("invalid objId for remove function");this.#r.splice(e,1)}removeAll(t){t?this.#r.splice(1,this.#r.length-2):this.#r.length=0}replace(t,e){const o=this.#d(t);if(T===o)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.#a)throw new Error("invalid object name for replace function");this.#r[o]=e}reverse(){this.#r.reverse()}sort(t){this.#r.sort(t)}swap(t,e){const o=this.#d(t);if(T===o||0===o&&e||this.#r.length-1===o&&!e)throw new Error("invalid objId for swap function");const s=e?-1:1,i=this.#r[o];this.#r[o]=this.#r[o+s],this.#r[o+s]=i}get first(){return this.#r[0]}get iterator(){return new M(this)}get last(){return this.#r[this.#r.length-1]}get length(){return this.#r.length}get jsonObject(){const t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.#r.length=0,Array.isArray(t)&&t.forEach((t=>{const e=new this.#l;e.jsonObject=t,this.add(e)}))}}class N{#h=new Map;constructor(){Object.freeze(this),this.#h.set("a",["href","target"]),this.#h.set("div",[]),this.#h.set("del",[]),this.#h.set("em",[]),this.#h.set("figcaption",[]),this.#h.set("figure",[]),this.#h.set("h1",[]),this.#h.set("h2",[]),this.#h.set("h3",[]),this.#h.set("h4",[]),this.#h.set("h5",[]),this.#h.set("h6",[]),this.#h.set("hr",[]),this.#h.set("img",["src","alt","width","height"]),this.#h.set("ins",[]),this.#h.set("li",[]),this.#h.set("mark",[]),this.#h.set("ol",[]),this.#h.set("p",[]),this.#h.set("s",[]),this.#h.set("small",[]),this.#h.set("strong",[]),this.#h.set("span",[]),this.#h.set("sub",[]),this.#h.set("sup",[]),this.#h.set("ul",[]),this.#h.set("svg",["xmlns","viewBox","class"]),this.#h.set("text",["x","y","text-anchor"]),this.#h.set("polyline",["points","class","transform"]),this.#h.set("#text",[])}getValidAttributesNames(t){return this.#h.get(t).concat(["id","class","dir","title"])}getValidNodeName(t){const e=t.toLowerCase();return this.#h.get(e)?e:""}}class C{#u;#m;constructor(t,e){Object.freeze(this),this.#u=t,this.#m=e}get htmlString(){return this.#u}get errorsString(){return this.#m}}class D{#p;#m;constructor(t,e){Object.freeze(this),this.#p=t,this.#m=e}get url(){return this.#p}get errorsString(){return this.#m}}class x{#g="";#v="";static#T=new N;#L(t){return t.replaceAll(/\u003c/g,"&lt;").replaceAll(/\u003e/g,"&gt;").replaceAll(/\u0022/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}#E(t,e){const o=this.sanitizeToUrl(t,e).url;""===o&&""!==t?this.#v+="\nAn invalid url ("+t+") was removed from a "+e+" attribute":this.#g+=" "+e+'="'+o+'"'}#b(t,e){x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(this.#g+=" "+e+'="'+this.#L(t.getAttributeNS(null,e))+'"',t.removeAttributeNS(null,e))}))}#y(t,e){t.hasAttribute("target")&&(this.#g+=' rel="noopener noreferrer"'),x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttribute(e)&&("href"===e||"src"===e?this.#E(t.getAttribute(e),e):this.#g+=" "+e+'="'+this.#L(t.getAttribute(e))+'"',t.removeAttribute(e))}))}#w(t){for(let e=0;e<t.attributes.length;e++)"rel"!==t.attributes[e].name&&(this.#v+="\nAn unsecure attribute "+t.attributes[e].name+'="'+t.attributes[e].value+'" was removed.')}#f(t){const e=t.childNodes;for(let o=0;o<e.length;o++){const e=t.childNodes[o],s=x.#T.getValidNodeName(e.nodeName);""===s?this.#v+="\nAn invalid tag "+e.nodeName+" was removed":"#text"===s?this.#g+=this.#L(e.nodeValue):(this.#g+="<"+s,"svg"===s||"text"===s||"polyline"===s?this.#b(e,s):this.#y(e,s),this.#g+=">",this.#f(e),this.#g+="</"+s+">",e.attributes&&this.#w(e))}}#M(t,e){const o=document.createElementNS(L,e);return x.#T.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(o.setAttributeNS(null,e,t.getAttributeNS(null,e)),t.removeAttributeNS(null,e))})),o}#I(t,e){const o=document.createElement(e);return x.#T.getValidAttributesNames(e).forEach((e=>{if(t.hasAttribute(e))if("href"===e||"src"===e){const s=this.sanitizeToUrl(t.getAttribute(e),e).url;""!==s&&o.setAttribute(e,s)}else o.setAttribute(e,t.getAttribute(e))})),t.hasAttribute("target")&&o.setAttribute("rel","noopener noreferrer"),o}#N(t,e){const o=t.childNodes;for(let s=0;s<o.length;s++){const o=t.childNodes[s],i=x.#T.getValidNodeName(o.nodeName);if("#text"===i)e.appendChild(document.createTextNode(o.nodeValue));else if(""!==i){const t="svg"===i||"text"===i||"polyline"===i?this.#M(o,i):this.#I(o,i);e.appendChild(t),this.#N(o,t)}}}constructor(){Object.freeze(this)}sanitizeToHtmlElement(t,e){const o=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html"),s=new DocumentFragment;o&&"#document"===o.nodeName?(this.#N(o.body.firstChild,s),e.appendChild(s)):e.textContent=""}clone(t){const e=document.createElement(t.tagName);return this.#N(t,e),e}sanitizeToHtmlString(t){this.#g="",this.#v="";const e=(new DOMParser).parseFromString("<div>"+t.replace("&nbsp;","਀")+"</div>","text/html");return e&&"#document"===e.nodeName?(this.#f(e.body.firstChild),new C(this.#g,this.#v)):new C("","Parsing error")}sanitizeToUrl(t,e){const o=e||"href",s=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!s||"#document"!==s.nodeName)return new D("","Parsing error");const i=s.body.firstChild;let n="";for(let t=0;t<i.childNodes.length;t++){if("#text"!==i.childNodes[t].nodeName)return new D("","Invalid characters found in the url");n+=i.childNodes[t].nodeValue}if(n=n.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),n!==t)return new D("","Invalid characters found in the url");const r=["https:"];if("http:"!==window.location.protocol&&"href"!==o||r.push("http:"),"href"===o){r.push("mailto:"),r.push("sms:"),r.push("tel:");const t=n.match(/^\u0023\w*/);if(t&&n===t[0])return new D(n,"")}"src"===o&&r.push("data:");let a=null;try{a=new URL(n)}catch(t){return new D("","Invalid url string")}if(T===r.indexOf(a.protocol))return new D("","Invalid protocol "+a.protocol);if(T!==["sms:","tel:"].indexOf(a.protocol))return a.pathname.match(/^\+[0-9,*,\u0023]*$/)?new D(n,""):new D("","Invalid sms: or tel: url");try{encodeURIComponent(a.href)}catch(t){return new D("","Invalid character in url")}return new D(n,"")}sanitizeToJsString(t){const e=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";const o=e.body.firstChild;let s="";for(let t=0;t<o.childNodes.length;t++){if("#text"!==o.childNodes[t].nodeName)return"";s+=o.childNodes[t].nodeValue}return s=s.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),s}sanitizeToColor(t){const e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}}const O=new x;const j=new class{#C=new Map;constructor(){Object.freeze(this)}setTranslations(t){t.forEach((t=>this.#C.set(t.msgid,O.sanitizeToJsString(t.msgstr))))}getText(t,e){let o=this.#C.get(t);return e&&o&&Object.getOwnPropertyNames(e).forEach((t=>o=o.replace("{"+t+"}",e[t]))),o||t}};const S=new class{constructor(){Object.freeze(this)}get UUID(){const t=["","","","-","","-","","-","","-","","","","","",""],e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let o="";for(let s=0;s<16;s++)o+=e[s].toString(m).padStart(2,"0")+t[s];return o}storageAvailable(t){try{const e=window[t],o="__storage_test__";return e.setItem(o,o),e.removeItem(o),!0}catch(t){return!1}}openFile(t,e){const o=document.createElement("input");o.type="file",e&&(o.accept=e),o.addEventListener("change",t,!1),o.click()}saveFile(t,e,o){try{const s=o?window.URL.createObjectURL(new File([e],t,{type:o})):URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",t),i.click(),window.URL.revokeObjectURL(s)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){const e=Math.floor(t);if(0===e)return"";const o=Math.floor(e/86400),s=Math.floor(e%86400/3600),i=Math.floor(e%3600/60),n=Math.floor(e%60);return 0<o?o+" "+j.getText("Utilities - Day")+" "+s+" "+j.getText("Utilities - Hour"):0<s?s+" "+j.getText("Utilities - Hour")+" "+i+" "+j.getText("Utilities - Minute"):0<i?i+" "+j.getText("Utilities - Minute"):n+" "+j.getText("Utilities - Second")}formatDistance(t){const e=Math.floor(t);return 0>=e?"0 km":Math.floor(e/o.metersInKm)+","+Math.floor(e%o.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}numberToDMS(t){let e=t,o=Math.floor(t);e-=o;let s=Math.floor(60*e);e-=s/60,e*=3600;let i=Math.floor(e);return e-=i,e=Math.floor(100*e),o.toString()+"° "+s.toString()+"' "+i+'" '+e}formatLatDMS(t){return t>0?this.numberToDMS(t)+" N":this.numberToDMS(-t)+" S"}formatLngDMS(t){return t>0?this.numberToDMS(t)+" E":this.numberToDMS(-t)+" W"}formatLatLngDMS(t){return 0===t[0]&&0===t[1]?"":this.formatLatDMS(t[0])+" - "+this.formatLngDMS(t[1])}formatLat(t){return t>0?t.toFixed(a.fixed)+" N":(-t).toFixed(a.fixed)+" S"}formatLng(t){return t>0?t.toFixed(a.fixed)+" E":(-t).toFixed(a.fixed)+" W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+" - "+this.formatLng(t[1])}};class H{#D;#x(){this.#D.routes.forEach((t=>{t.dashArray=0,t.hidden=!1}))}#O(){this.#D.routes.forEach((t=>{t.edited=l.notEdited}))}#j(){this.#O(),this.#D.editedRoute={name:"",wayPoints:[{name:"",lat:0,lng:0,objId:2,objType:{name:"WayPoint",version:"1.4.0"}},{name:"",lat:0,lng:0,objId:3,objType:{name:"WayPoint",version:"1.4.0"}}],notes:[],itinerary:{itineraryPoints:[],maneuvers:[],provider:"",transitMode:"",objId:1,objType:{name:"Itinerary",version:"1.4.0"}},width:3,color:"#ff0000",dashArray:0,chain:!0,distance:0,duration:0,edited:l.notEdited,hidden:!1,chainedDistance:0,objId:4,objType:{name:"Route",version:"1.4.0"}}}#S(){if(this.#D.userData.layerId){const t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===this.#D.userData.layerId));this.#D.layerName=t?t.layerName:"OSM - Color"}else this.#D.layerName="OSM - Color"}#H(t){t.forEach((t=>{t.elev=s.defaultValue}))}#P(){this.#D.routes.forEach((t=>{t.itinerary.hasProfile=!1,t.itinerary.ascent=0,t.itinerary.descent=0,this.#H(t.itinerary.itineraryPoints)})),this.#D.editedRoute.itinerary.hasProfile=!1,this.#D.editedRoute.itinerary.ascent=0,this.#D.editedRoute.itinerary.descent=0,this.#H(this.#D.editedRoute.itinerary.itineraryPoints)}#R(t){t.itinerary.maneuvers.forEach((t=>{"kArriveDefault"===t.iconName&&(t.distance=o.defaultValue)}))}#A(t){t.wayPoints.forEach((t=>{t.address=t.name,t.name=""}))}#B(){this.#D.routes.forEach((t=>{t.editionStatus=t.edited,this.#R(t),this.#A(t)})),this.#D.editedRoute.editionStatus=this.#D.editedRoute.edited,this.#R(this.#D.editedRoute),this.#A(this.#D.editedRoute)}#k(){this.#D.routes.forEach((t=>{t.dashIndex=t.dashArray})),this.#D.editedRoute.dashIndex=this.#D.editedRoute.dashArray}#F(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}#_(t){"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.#F(t.iconContent),t.popupContent=this.#F(t.popupContent),t.tooltipContent=this.#F(t.tooltipContent),t.phone=this.#F(t.phone),t.address=this.#F(t.address)}#z(){this.#D.notes.forEach((t=>{this.#_(t)})),this.jsonTravel.routes.forEach((t=>{t.notes.forEach((t=>{this.#_(t)}))}))}#K(){switch(this.#D.objType.version){case"1.0.0":this.#x();case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":this.#j();case"1.5.0":this.#S();case"1.6.0":this.#P();case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":this.#B();case"1.12.0":case"1.13.0":this.#z();case"2.0.0":case"2.1.0":case"2.2.0":case"2.3.0":this.#k(),this.#D.objType.version="2.4.0";break;default:throw new Error("invalid version for travel")}}constructor(){Object.freeze(this)}update(t){t.objType.version!==y&&(this.#D=t,this.#K())}}class P{constructor(){Object.freeze(this)}validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+this.objType.name);this.objType.validate(t.objType),"Travel"===this.objType.name&&this.objType.version!==t.objType.version&&(new H).update(t);const e=Object.getOwnPropertyNames(t);return this.objType.properties.forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+this.objType.name)})),t}}class R extends P{static#U=new f("WayPoint",["address","name","lat","lng","objId"]);#V="";#W="";#X=a.defaultValue;#Y=a.defaultValue;#t=g;constructor(){super(),this.#t=b.nextObjId}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get address(){return this.#W}set address(t){this.#W="string"==typeof t?O.sanitizeToJsString(t):""}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=S.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objId(){return this.#t}get objType(){return R.#U}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.address=e.address,this.name=e.name,this.lat=e.lat,this.lng=e.lng,this.#t=b.nextObjId}}class A extends P{static#U=new f("ItineraryPoint",["lat","lng","distance","elev","objId"]);#X=a.defaultValue;#Y=a.defaultValue;#G=o.defaultValue;#Z=s.defaultValue;#t=g;constructor(){super(),this.#t=b.nextObjId}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get elev(){return this.#Z}set elev(t){this.#Z="number"==typeof t?t:a.defaultValue}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objType(){return A.#U}get objId(){return this.#t}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),elev:parseFloat(this.elev.toFixed(s.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.elev=e.elev,this.#t=b.nextObjId}}class B extends P{static#U=new f("Maneuver",["iconName","instruction","distance","duration","itineraryPointObjId","objId"]);#J="";#q="";#$=g;#G=o.defaultValue;#Q=o.defaultValue;#t=g;constructor(){super(),this.#t=b.nextObjId}get iconName(){return this.#J}set iconName(t){this.#J="string"==typeof t?O.sanitizeToJsString(t):""}get instruction(){return this.#q}set instruction(t){this.#q="string"==typeof t?O.sanitizeToJsString(t):""}get itineraryPointObjId(){return this.#$}set itineraryPointObjId(t){this.#$="number"==typeof t?t:g}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get duration(){return this.#Q}set duration(t){this.#Q="number"==typeof t?t:o.defaultValue}get objType(){return B.#U}get objId(){return this.#t}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconName=e.iconName,this.instruction=e.instruction,this.distance=e.distance,this.duration=e.duration,this.itineraryPointObjId=e.itineraryPointObjId,this.#t=b.nextObjId}}class k extends P{static#U=new f("Itinerary",["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"]);#t=g;#tt=!1;#et=0;#ot=0;#st="";#it="";#nt=new I(A);#rt=new I(B);constructor(){super(),this.#t=b.nextObjId}get hasProfile(){return this.#tt}set hasProfile(t){this.#tt="boolean"==typeof t&&t}get ascent(){return this.#et}set ascent(t){this.#et="number"==typeof t?Number.parseInt(t):0}get descent(){return this.#ot}set descent(t){this.#ot="number"==typeof t?Number.parseInt(t):0}get provider(){return this.#st}set provider(t){this.#st="string"==typeof t?O.sanitizeToJsString(t):""}get transitMode(){return this.#it}set transitMode(t){this.#it="string"==typeof t?O.sanitizeToJsString(t):""}get itineraryPoints(){return this.#nt}get maneuvers(){return this.#rt}get objType(){return k.#U}get objId(){return this.#t}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.hasProfile=e.hasProfile,this.ascent=e.ascent,this.descent=e.descent,this.itineraryPoints.jsonObject=e.itineraryPoints,this.maneuvers.jsonObject=e.maneuvers,this.provider=e.provider,this.transitMode=e.transitMode,this.#t=b.nextObjId;const o=new Map;let s=0;const i=this.itineraryPoints.iterator;for(;!i.done;)o.set(e.itineraryPoints[s].objId,i.value.objId),s++;const n=this.maneuvers.iterator;for(;!n.done;)n.value.itineraryPointObjId=o.get(n.value.itineraryPointObjId)}}class F extends P{static#U=new f("Note",["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"]);#at=n.height;#lt=n.width;#dt="";#ct="";#ht="";#ut="";#p="";#W="";#mt=a.defaultValue;#pt=a.defaultValue;#X=a.defaultValue;#Y=a.defaultValue;#G=o.invalid;#gt=o.defaultValue;#t=g;constructor(){super(),this.#t=b.nextObjId}get iconHeight(){return this.#at}set iconHeight(t){this.#at="number"==typeof t?t:n.height}get iconWidth(){return this.#lt}set iconWidth(t){this.#lt="number"==typeof t?t:n.width}get iconContent(){return this.#dt}set iconContent(t){this.#dt="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get popupContent(){return this.#ct}set popupContent(t){this.#ct="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get tooltipContent(){return this.#ht}set tooltipContent(t){this.#ht="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get phone(){return this.#ut}set phone(t){this.#ut="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get url(){return this.#p}set url(t){this.#p="string"==typeof t?encodeURI(O.sanitizeToUrl(t).url):""}get address(){return this.#W}set address(t){this.#W="string"==typeof t?O.sanitizeToHtmlString(t).htmlString:""}get iconLat(){return this.#mt}set iconLat(t){this.#mt="number"==typeof t?t:a.defaultValue}get iconLng(){return this.#pt}set iconLng(t){this.#pt="number"==typeof t?t:a.defaultValue}get lat(){return this.#X}set lat(t){this.#X="number"==typeof t?t:a.defaultValue}get lng(){return this.#Y}set lng(t){this.#Y="number"==typeof t?t:a.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.invalid}get chainedDistance(){return this.#gt}set chainedDistance(t){this.#gt="number"==typeof t?t:o.defaultValue}get isRouteNote(){return this.#G!==o.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#mt=t[0],this.#pt=t[1]):(this.#mt=a.defaultValue,this.#pt=a.defaultValue)}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.#X=t[0],this.#Y=t[1]):(this.#X=a.defaultValue,this.#Y=a.defaultValue)}get objType(){return F.#U}get objId(){return this.#t}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(a.fixed)),iconLng:parseFloat(this.iconLng.toFixed(a.fixed)),lat:parseFloat(this.lat.toFixed(a.fixed)),lng:parseFloat(this.lng.toFixed(a.fixed)),distance:parseFloat(this.distance.toFixed(o.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconHeight=e.iconHeight,this.iconWidth=e.iconWidth,this.iconContent=e.iconContent,this.popupContent=e.popupContent,this.tooltipContent=e.tooltipContent,this.phone=e.phone,this.url=e.url,this.address=e.address,this.iconLat=e.iconLat,this.iconLng=e.iconLng,this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.chainedDistance=e.chainedDistance,this.#t=b.nextObjId}}class _ extends P{static#U=new f("Route",["name","wayPoints","notes","itinerary","width","color","dashIndex","chain","chainedDistance","distance","duration","editionStatus","hidden","objId"]);#V="";#vt=new I(R);#Tt=new I(F);#Lt=new k;#Et=t.route.width;#bt=t.route.color;#yt=t.route.dashIndex;#wt=!0;#gt=o.defaultValue;#G=o.defaultValue;#Q=o.defaultValue;#ft=l.notEdited;#Mt=!1;#t=g;constructor(){super(),this.#vt.add(new R),this.#vt.add(new R),this.#t=b.nextObjId}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get wayPoints(){return this.#vt}get notes(){return this.#Tt}get itinerary(){return this.#Lt}get width(){return this.#Et}set width(e){this.#Et="number"==typeof e?e:t.route.width}get color(){return this.#bt}set color(e){this.#bt="string"==typeof e&&O.sanitizeToColor(e)||t.route.color}get dashIndex(){return this.#yt}set dashIndex(e){this.#yt="number"==typeof e&&t.route.dashChoices[e]?e:0}get dashString(){let e="";return t.route.dashChoices[this.#yt].iDashArray.forEach((t=>e+=String(t*this.#Et)+",")),e.substring(0,e.length-1)}get chain(){return this.#wt}set chain(t){this.#wt="boolean"==typeof t&&t}get chainedDistance(){return this.#gt}set chainedDistance(t){this.#gt="number"==typeof t?t:o.defaultValue}get distance(){return this.#G}set distance(t){this.#G="number"==typeof t?t:o.defaultValue}get duration(){return this.#Q}set duration(t){this.#Q="number"==typeof t?t:o.defaultValue}get editionStatus(){return this.#ft}set editionStatus(t){this.#ft="number"==typeof t?t:l.notEdited}get hidden(){return this.#Mt}set hidden(t){this.#Mt="boolean"==typeof t&&t}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.#t}get objType(){return _.#U}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&a.defaultValue!==e.lat&&a.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashIndex:this.dashIndex,chain:this.chain,distance:parseFloat(this.distance.toFixed(o.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(o.fixed)),objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.name=e.name,this.wayPoints.jsonObject=e.wayPoints,this.notes.jsonObject=e.notes,this.itinerary.jsonObject=e.itinerary,this.width=e.width,this.color=e.color,this.dashIndex=e.dashIndex,this.chain=e.chain,this.distance=e.distance,this.duration=e.duration,this.editionStatus=e.editionStatus,this.hidden=e.hidden,this.chainedDistance=e.chainedDistance,this.#t=b.nextObjId}}class z extends P{static#U=new f("Travel",["editedRoute","routes","notes","layerName","name","readOnly","objId"]);#It=new _;#Nt=new I(_);#Tt=new I(F);#Ct="OSM - Color";#V="";#Dt=!1;#t=g;constructor(){super(),this.#Nt.add(new _),this.#t=b.nextObjId}get editedRoute(){return this.#It}set editedRoute(t){this.#It="Route"===t?.objType?.name?t:new _}get routes(){return this.#Nt}get notes(){return this.#Tt}get layerName(){return this.#Ct}set layerName(t){this.#Ct="string"==typeof t?O.sanitizeToJsString(t):"OSM - Color"}get name(){return this.#V}set name(t){this.#V="string"==typeof t?O.sanitizeToJsString(t):""}get readOnly(){return this.#Dt}set readOnly(t){this.#Dt="boolean"!=typeof t||t}get objId(){return this.#t}get objType(){return z.#U}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.#t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName,this.name=e.name,this.readOnly=e.readOnly,this.routes.jsonObject=e.routes,this.notes.jsonObject=e.notes,this.#t=b.nextObjId}}class K{#st="";#it="";constructor(){Object.freeze(this)}get provider(){return this.#st}set provider(t){this.#st="string"==typeof t?t:""}get transitMode(){return this.#it}set transitMode(t){this.#it="string"==typeof t?t:""}}const U=new class{#xt;#Ot;#jt;#St;#Ht;#Pt;#Rt;#At;constructor(){Object.freeze(this),this.#xt=new Map,this.#Ot=new Map,this.#jt=new K,this.#St=S.UUID,this.#Ht=null,this.#Pt=new z,this.#Rt=g,this.#At=[]}get map(){return this.#Ht}set map(t){this.#Ht||(this.#Ht=t)}get travel(){return this.#Pt}get editedRouteObjId(){return this.#Rt}set editedRouteObjId(t){this.#Rt="number"==typeof t?t:g}get searchData(){return this.#At}get providers(){return this.#xt}get mapObjects(){return this.#Ot}get routing(){return this.#jt}get UUID(){return this.#St}};class V{#Bt;#kt;constructor(t,e){Object.freeze(this),this.#Bt="string"==typeof t?t:"",this.#kt="string"==typeof e?e:""}get providerName(){return this.#Bt}get providerKey(){return this.#kt}get jsonObject(){return{providerName:this.providerName,providerKey:this.providerKey}}}const W=new class{#Ft(t,e){for(const o in e)try{if("dataset"===o){const o=e.dataset;for(const e in o)t.dataset["tan"+e]=o[e]}else t[o]=e[o]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){Object.freeze(this)}create(t,e,o){let s=null;return"text"===t.toLowerCase()?s=document.createTextNode(e.value||""):(s="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.#Ft(s,e)),o&&o.appendChild(s),s}};class X{#_t;constructor(t){Object.freeze(this),this.#_t=t}handleEvent(){this.#_t.onCancel()}}class Y{#zt;constructor(t){Object.freeze(this),this.#zt=t}handleEvent(t){this.#zt.keyboardELEnabled&&("Escape"===t.key||"Esc"===t.key?this.#zt.onCancel():"Enter"===t.key&&this.#zt.onOk())}}class G{#zt;constructor(t){Object.freeze(this),this.#zt=t}handleEvent(){this.#zt.onOk()}}class Z{constructor(){Object.freeze(this)}handleEvent(t){if(!t.target.classList.contains("TravelNotes-Background"))return;let e=U.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(U.map.getMaxZoom(),e),e=Math.max(U.map.getMinZoom(),e),U.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class J{constructor(){Object.freeze(this)}handleEvent(t){t.preventDefault()}}class q{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){t.preventDefault(),Number.parseInt(t.dataTransfer.getData("ObjId"))===this.#Kt.objId&&(t.stopPropagation(),this.#Kt.moveDialog(t))}}class ${#X;#Y;constructor(t,e){Object.freeze(this),this.#X=t,this.#Y=e}static clone(t){return new $(t.lat,t.lng)}get latLng(){return[this.#X,this.#Y]}get lat(){return this.#X}get lng(){return this.#Y}}class Q extends ${#G;constructor(t,e,o){super(t,e),this.#G=o}get distance(){return this.#G}}class tt extends Q{#Z;#et;constructor(t,e,o,s,i){super(t,e,o),this.#Z=s,this.#et=i}get elev(){return this.#Z}get ascent(){return this.#et}}class et{static get#Ut(){return 100}constructor(){Object.freeze(this)}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let o=0;const s=t.itinerary.itineraryPoints.iterator;for(;o<e&&!s.done;)o+=s.value.distance;const i=s.value;s.done;const n=(i.distance-o+e)/i.distance;return new tt(i.lat+(s.value.lat-i.lat)*n,i.lng+(s.value.lng-i.lng)*n,e,i.elev+(s.value.elev-i.elev)*n,et.#Ut*(s.value.elev-i.elev)/i.distance)}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;const s=t.itinerary.itineraryPoints.iterator;s.done;let i=Number.MAX_VALUE;const n=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1]));let r=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng)),a=null,l=o.defaultValue,d=s.value.distance;for(;!s.done;){const t=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng));let e=window.L.LineUtil.pointToSegmentDistance(n,r,t);e<i&&(i=e,a=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(n,r,t)),l=d-a.distanceTo(window.L.latLng(s.value.lat,s.value.lng))),d+=s.value.distance,r=t}return new Q(a.lat,a.lng,l)}getLatLngBounds(t){const e=window.L.latLng([a.maxLat,a.maxLng]),o=window.L.latLng([a.minLat,a.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),o.lat=Math.max(o.lat,t[0]),o.lng=Math.max(o.lng,t[1])})),window.L.latLngBounds(e,o)}getSquareBoundingBox(t,o){const s=t[0]*e.toRadians,i=o/u*e.fromRadians,n=Math.acos((Math.cos(o/u)-Math.sin(s)**2)/Math.cos(s)**2)*e.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-i,t[1]-n]),window.L.latLng([t[0]+i,t[1]+n]))}project(t,e){const o=U.map.project(window.L.latLng(t),e);return[o.x,o.y]}screenCoordToLatLng(t,e){const o=U.map.containerPointToLatLng(window.L.point(t,e));return[o.lat,o.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}}const ot=new et;class st{#_t;#Vt=!1;#Wt=!1;#Xt=0;#Yt=0;#Gt;#Zt;#Jt;#qt;#$t(e){if(this.#Vt&&(this.#Xt!==e.screenX||this.#Yt!==e.screenY)){t.baseDialog.cancelTouchY>this.#Yt&&e.screenY<this.#Yt&&t.baseDialog.cancelTouchX>this.#Xt&&this.#_t.onCancel();const o=ot.screenCoordToLatLng(this.#Xt,this.#Yt),s=ot.screenCoordToLatLng(e.screenX,e.screenY);U.map.panTo([this.#Gt.lat+o[0]-s[0],this.#Gt.lng+o[1]-s[1]])}}#Qt(e){let o=Math.sqrt((e.item(0).clientX-e.item(1).clientX)**2+(e.item(0).clientY-e.item(1).clientY)**2),s=this.#Zt,i=o-this.#Jt;t.baseDialog.deltaZoomDistance<i?s++:-t.baseDialog.deltaZoomDistance>i&&s--,s=Math.min(U.map.getMaxZoom(),s),s=Math.max(U.map.getMinZoom(),s),s!==this.#Zt&&(U.map.setZoomAround(this.#qt,s),this.#Zt=s,this.#Jt=o)}#te(t){this.#Vt&&1===t.changedTouches.length&&(this.#$t(t.changedTouches.item(0)),this.#Vt=!1)}#ee(t){this.#Vt&&1===t.changedTouches.length?this.#$t(t.changedTouches.item(0)):this.#Wt&&2===t.targetTouches.length&&this.#Qt(t.targetTouches)}#oe(t){if(1===t.targetTouches.length){const e=t.changedTouches.item(0);this.#Xt=e.screenX,this.#Yt=e.screenY,this.#Gt=U.map.getCenter(),this.#Vt=!0,this.#Wt=!1}2===t.targetTouches.length&&(this.#Zt=U.map.getZoom(),this.#qt=window.L.point((t.targetTouches.item(0).clientX+t.targetTouches.item(1).clientX)/2,(t.targetTouches.item(0).clientY+t.targetTouches.item(1).clientY)/2),this.#Jt=Math.sqrt((t.targetTouches.item(0).clientX-t.targetTouches.item(1).clientX)**2+(t.targetTouches.item(0).clientY-t.targetTouches.item(1).clientY)**2),this.#Vt=!1,this.#Wt=!0)}constructor(t){Object.freeze(this),this.#_t=t}handleEvent(t){switch(t.currentTarget===t.target&&t.preventDefault(),t.type){case"touchstart":t.currentTarget===t.target&&this.#oe(t);break;case"touchmove":this.#ee(t);break;case"touchend":this.#te(t)}}}class it{static get LEFT_BUTTON(){return 0}#Vt=!1;#Xt=0;#Yt=0;#Gt;#$t(t){const e=ot.screenCoordToLatLng(this.#Xt,this.#Yt),o=ot.screenCoordToLatLng(t.screenX,t.screenY);U.map.panTo([this.#Gt.lat+e[0]-o[0],this.#Gt.lng+e[1]-o[1]])}constructor(){Object.freeze(this)}handleEvent(t){switch(t.type){case"mousedown":t.button===it.LEFT_BUTTON&&t.target===t.currentTarget&&(this.#Xt=t.screenX,this.#Yt=t.screenY,this.#Gt=U.map.getCenter(),this.#Vt=!0);break;case"mousemove":t.button===it.LEFT_BUTTON&&this.#Vt&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.#$t(t));break;case"mouseup":t.button!==it.LEFT_BUTTON||!this.#Vt||this.#Xt===t.screenX&&this.#Yt===t.screenY||this.#$t(t),this.#Vt=!1}}}class nt{#se=null;#ie=null;#ne=null;#re=null;#ae=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.#se=t.firstButtonText;break;case"secondButtonText":this.#ie=t.secondButtonText;break;case"selectOptionsData":this.#ne=t.selectOptionsData;break;case"title":this.#re=t.title;break;case"text":this.#ae=t.text}}get firstButtonText(){return this.#se}get secondButtonText(){return this.#ie}get selectOptionsData(){return this.#ne}get title(){return this.#re}get text(){return this.#ae}}class rt{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.setDragStartPoint(t),t.dataTransfer.setData("ObjId",this.#Kt.objId)}}class at{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.moveDialog(t)}}class lt{#Kt;#le;constructor(t){Object.freeze(this),this.#Kt=t,this.#le=!1}handleEvent(t){t.stopPropagation();let e=t.type;if(1===t.changedTouches.length){const o=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#le=!0,this.#Kt.setDragStartPoint(o);break;case"touchmove":this.#le=!1,t.preventDefault(),this.#Kt.moveDialog(o,e);break;case"touchend":this.#le||this.#Kt.moveDialog(o,e)}}}}class dt{static#de;static#ce(){dt.#de=!0,document.removeEventListener("touchstart",dt.#ce,!0)}constructor(){Object.freeze(this),dt.#de=!1,document.addEventListener("touchstart",dt.#ce,!0)}get isTouch(){return dt.#de}get screenAvailable(){const t=document.createElement("div");t.style.position="absolute",t.style.bottom=0,t.style.right=0,t.style.height=1,t.style.width=1,document.body.appendChild(t);const e=t.getBoundingClientRect(),o=e.bottom,s=e.right;return document.body.removeChild(t),Object.freeze({height:o,width:s})}}const ct=new dt;class ht{#t;#he;#ue;#me;#pe;#ge(t,e){const o=ct.screenAvailable,s=o.width-this.dialogHTMLElement.offsetWidth-h,i=o.height-this.dialogHTMLElement.offsetHeight-h;this.#me=Math.max(Math.min(t,s),h),this.#pe=Math.max(Math.min(e,i),h)}#ve(){this.dialogHTMLElement.style.left=String(this.#me)+"px",this.dialogHTMLElement.style.top=String(this.#pe)+"px"}dialogHTMLElement=null;topBarHTMLElement=null;constructor(){Object.seal(this),this.#me=h,this.#pe=h,this.#he=0,this.#ue=0,this.#t=b.nextObjId}get onTop(){return 42>this.#pe}get objId(){return this.#t}centerDialog(){const e=ct.screenAvailable;this.dialogHTMLElement.style["max-height"]=String(e.height-80)+"px",this.dialogHTMLElement.style["max-width"]=String(e.width-80)+"px",this.#me=(e.width-this.dialogHTMLElement.clientWidth)/2,t.baseDialog.touchTopScreen&&ct.isTouch?this.#pe=h:this.#pe=(e.height-this.dialogHTMLElement.clientHeight)/2,this.#ve()}moveDialog(t,e){const o=this.#me+t.screenX-this.#he,s=this.#pe+t.screenY-this.#ue;this.moveDialogTo(o,s,e),this.setDragStartPoint(t)}moveDialogTo(t,e){this.#ge(t,e),this.#ve()}moveDialogToLastPosition(){this.moveDialogTo(this.#me,this.#pe)}moveDialogToTopLeft(){this.#me=h,this.#pe=h,this.#ve()}setDragStartPoint(t){this.#he=t.screenX,this.#ue=t.screenY}}class ut extends class{#Te;#Le;#Ee;#be;#ye;#we;#fe;#Me;#Ie;#Ne=null;#Ce(){this.#Te=W.create("div",{className:"TravelNotes-BaseDialog-DialogHTMLElement"}),this.mover.dialogHTMLElement=this.#Te}#De(){this.#Le=W.create("div",{className:"TravelNotes-BaseDialog-TopBarHTMLElement",draggable:!0},this.#Te),this.#Me=new lt(this.mover),this.#Le.addEventListener("touchstart",this.#Me,!1),this.#Le.addEventListener("touchmove",this.#Me,!1),this.#Le.addEventListener("touchend",this.#Me,!1),this.#Le.addEventListener("touchcancel",this.#Me,!1),this.#we=new rt(this.mover),this.#Le.addEventListener("dragstart",this.#we,!1),this.#fe=new at(this.mover),this.#Le.addEventListener("dragend",this.#fe,!1),this.#Ee=W.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:j.getText("BaseDialog - Cancel")},this.#Le),W.create("div",{textContent:this.title,className:"TravelNotes-BaseDialog-Title"},this.#Le),this.#Ie=new X(this),this.#Ee.addEventListener("click",this.#Ie,!1),this.mover.topBarHTMLElement=this.#Le}#xe(){this.toolbarHTMLElement&&W.create("div",{className:"TravelNotes-BaseDialog-ToolbarHTMLElement"},this.#Te).appendChild(this.toolbarHTMLElement)}#Oe(){this.#be=W.create("div",{className:"TravelNotes-BaseDialog-ContentHTMLElement"},this.#Te),this.contentHTMLElements.forEach((t=>this.#be.appendChild(t)))}#je(){this.#Ce(),this.#De(),this.#xe(),this.#Oe()}constructor(t){Object.freeze(this),this.#Ne=new nt(t)}#Se(){this.#Le.removeEventListener("dragstart",this.#we,!1),this.#we=null,this.#Le.removeEventListener("dragend",this.#fe,!1),this.#fe=null,this.#Le.removeEventListener("touchstart",this.#Me,!1),this.#Le.removeEventListener("touchmove",this.#Me,!1),this.#Le.removeEventListener("touchend",this.#Me,!1),this.#Le.removeEventListener("touchcancel",this.#Me,!1),this.#Me=null,this.#Ee.removeEventListener("click",this.#Ie,!1),this.#Ie=null,this.#ye&&(this.#ye=null)}get mover(){return this.#ye?this.#ye:this.#ye=new ht}onCancel(){this.#Se()}onOk(){this.#Se()}get title(){return""}get toolbarHTMLElement(){return null}get contentHTMLElements(){return[]}show(){this.createContentHTML(),this.#je()}removeFromBackground(t){t.removeChild(this.#Te)}addToBackground(t){t.appendChild(this.#Te)}addToDialog(t){this.#Te.appendChild(t)}get options(){return this.#Ne}addCssClass(t){this.#Te.classList.add(t)}}{#He;#Pe;#Re;#Ae;#Be;#ke;#Fe;#Ie;#_e;#ze;#Ke;#Ue;#Ve;#We;#Xe;#Ye;#Ge(){this.#He=W.create("div",{className:"TravelNotes-Background"})}#Ze(){this.#Ue=new q(this.mover),this.#He.addEventListener("dragover",this.#Ue,!1),this.#Xe=new Z,this.#He.addEventListener("wheel",this.#Xe,{passive:!0}),this.#Ye=new J,this.#He.addEventListener("contextmenu",this.#Ye,!1),this.#Ve=new st(this),this.#He.addEventListener("touchstart",this.#Ve,!1),this.#He.addEventListener("touchmove",this.#Ve,!1),this.#He.addEventListener("touchend",this.#Ve,!1),this.#He.addEventListener("touchcancel",this.#Ve,!1),this.#We=new it,this.#He.addEventListener("mouseup",this.#We,!1),this.#He.addEventListener("mousemove",this.#We,!1),this.#He.addEventListener("mousedown",this.#We,!1)}#Je(){this.#Pe=W.create("div",{className:"TravelNotes-ModalBaseDialog-ErrorHTMLElement TravelNotes-Hidden"}),this.addToDialog(this.#Pe)}#qe(){W.create("div",{className:"TravelNotes-WaitAnimationBullet"},W.create("div",{className:"TravelNotes-WaitAnimation"},this.#Re=W.create("div",{className:"TravelNotes-ModalBaseDialog-WaitHTMLElement  TravelNotes-Hidden"}))),this.addToDialog(this.#Re)}#$e(){const t=W.create("div",{className:"TravelNotes-ModalBaseDialog-FooterHTMLElement"});this.addToDialog(t),this.#Be=W.create("div",{textContent:this.options.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},t),this.#Fe=new G(this),this.#Be.addEventListener("click",this.#Fe,!1),this.options.secondButtonText?(this.#ke=W.create("div",{textContent:this.options.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.#Ie=new X(this),this.#ke.addEventListener("click",this.#Ie,!1)):this.#ke=null,this.footerHTMLElements.forEach((e=>t.appendChild(e)))}#je(){this.#Ge(),this.#Ze(),this.#Je(),this.#qe(),this.#$e()}#Se(){this.#He.removeEventListener("wheel",this.#Xe,{passive:!0}),this.#Xe=null,this.#He.removeEventListener("contextmenu",this.#Ye,!1),this.#Ye=null,this.#He.removeEventListener("dragover",this.#Ue,!1),this.#Ue=null,this.#He.removeEventListener("touchstart",this.#Ve,!1),this.#He.removeEventListener("touchmove",this.#Ve,!1),this.#He.removeEventListener("touchend",this.#Ve,!1),this.#He.removeEventListener("touchcancel",this.#Ve,!1),this.#Ve=null,this.#He.removeEventListener("mouseup",this.#We,!1),this.#He.removeEventListener("mousemove",this.#We,!1),this.#He.removeEventListener("mousedown",this.#We,!1),this.#We=null,document.removeEventListener("keydown",this.#Ke,{capture:!0}),this.#Ke=null,this.#Be.removeEventListener("click",this.#Fe,!1),this.#Fe=null,this.options.secondButtonText&&(this.#ke.removeEventListener("click",this.#Ie,!1),this.#Ie=null),document.body.removeChild(this.#He)}#Qe(t,e){this.#_e=t,this.#ze=e}constructor(t){super(t),this.#Ae=!0}show(){return super.show(),this.#je(),document.body.appendChild(this.#He),this.addToBackground(this.#He),this.#Ke=new Y(this),document.addEventListener("keydown",this.#Ke,{capture:!0}),this.mover.centerDialog(),new Promise(((t,e)=>this.#Qe(t,e)))}onCancel(){this.#Se(),super.onCancel(),this.#ze("Canceled by user")}canClose(){return!0}onOk(t){return!!this.canClose()&&(this.#_e(t),this.#Se(),super.onOk(),!0)}showWait(){this.#Re.classList.remove("TravelNotes-Hidden"),this.#Be.classList.add("TravelNotes-Hidden")}hideWait(){this.#Re.classList.add("TravelNotes-Hidden"),this.#Be.classList.remove("TravelNotes-Hidden")}showError(t){this.#Pe.textContent="",O.sanitizeToHtmlElement(t,this.#Pe),this.#Pe.classList.remove("TravelNotes-Hidden")}hideError(){this.#Pe.textContent="",this.#Pe.classList.add("TravelNotes-Hidden")}get footerHTMLElements(){return[]}get keyboardELEnabled(){return this.#Ae}set keyboardELEnabled(t){this.#Ae=t}}class mt{#to;constructor(t){Object.freeze(this),this.#to=t}destructor(){this.#to=null}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{this.#to.addApiKeys(JSON.parse(e.result))}catch(t){this.#to.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class pt{#to;#eo;constructor(t){Object.freeze(this),this.#to=t,this.#eo=new mt(this.#to)}destructor(){this.#to=null,this.#eo.destructor()}handleEvent(t){t.stopPropagation(),this.#to.hideError(),S.openFile(this.#eo,".json")}}class gt{#oo;constructor(){Object.freeze(this),this.#oo=W.create("div",{className:"TravelNotes-BaseDialog-DataDiv"})}get controlHTMLElement(){return this.#oo}}class vt{#so=null;constructor(t){Object.freeze(this),this.#so=t}handleEvent(t){t.currentTarget.textContent="👀",t.preventDefault(),t.stopPropagation(),this.#so.type="text"}}class Tt{#so;constructor(t){Object.freeze(this),this.#so=t}handleEvent(t){t.currentTarget.textContent="👁️",t.preventDefault(),t.stopPropagation(),this.#so.type="password",this.#so.focus()}}class Lt extends gt{#so;#io;#no;#ro;constructor(t){super(),this.#so=W.create("input",{type:"password",dataset:{Name:t?.datasetName||"PasswordControl"}},this.controlHTMLElement),this.#io=W.create("span",{id:"TravelNotes-PasswordControl-EyeSpan",textContent:"👁️"},this.controlHTMLElement),this.#no=new vt(this.#so),this.#ro=new Tt(this.#so),this.#io.addEventListener("mousedown",this.#no,!1),this.#io.addEventListener("touchstart",this.#no,!1),this.#io.addEventListener("mouseup",this.#ro,!1),this.#io.addEventListener("touchend",this.#ro,!1),this.#so.focus()}destructor(){this.#io.removeEventListener("mousedown",this.#no,!1),this.#io.removeEventListener("touchstart",this.#no,!1),this.#io.removeEventListener("mouseup",this.#ro,!1),this.#io.removeEventListener("touchend",this.#ro,!1),this.#no=null,this.#ro=null}get value(){return this.#so.value}focus(){this.#so.focus()}}class Et extends ut{#ao;#lo;static get#do(){return 12}constructor(t){super(),this.#lo=t}#Se(){this.#ao.destructor()}createContentHTML(){this.#ao=new Lt}show(){const t=super.show();return this.#ao.focus(),t}canClose(){return this.hideError(),!(this.#lo&&(this.#ao.value.length<Et.#do||!this.#ao.value.match(/[0-9]+/)||!this.#ao.value.match(/[a-z]+/)||!this.#ao.value.match(/[A-Z]+/)||!this.#ao.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+j.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+j.getText("PasswordDialog - Password rules2")+"</li><li>"+j.getText("PasswordDialog - Password rules3")+"</li><li>"+j.getText("PasswordDialog - Password rules4")+"</li><li>"+j.getText("PasswordDialog - Password rules5")+"</li><li>"+j.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.#ao.focus(),!1)}onCancel(){this.#Se(),super.onCancel()}onOk(){super.onOk((new window.TextEncoder).encode(this.#ao.value))&&this.#Se()}get contentHTMLElements(){return[this.#ao.controlHTMLElement]}get title(){return j.getText("PasswordDialog - password")}}class bt{#co;#ho(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}#uo(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}#mo(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}#po(t,e,o){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,o)}constructor(t){this.#co=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette.",Object.freeze(this)}encryptData(t,e,o,s){let i=window.crypto.getRandomValues(new Uint8Array(16));s.then((t=>this.#ho(t))).then((t=>this.#uo(t,this.#co))).then((e=>this.#po(e,i,t))).then((t=>{e(new Blob([i,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(o)}decryptData(t,e,o,s){s.then((t=>this.#ho(t))).then((t=>this.#uo(t,this.#co))).then((e=>this.#mo(e,t))).then(e).catch(o)}}class yt{#go;constructor(t){this.#go=t,Object.freeze(this)}destructor(){this.#go=null}onErrorDecrypt(t){this.#go.hideWait(),this.#go.keyboardELEnabled=!0,t&&"Canceled by user"!==t&&this.#go.showError(j.getText("DataEncryptorHandlers - An error occurs when reading the file"))}onOkDecrypt(t){try{this.#go.addApiKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.#go.hideWait(),this.#go.hideError(),this.#go.keyboardELEnabled=!0}onOkEncrypt(t){this.#go.hideError(),this.#go.hideWait(),S.saveFile("ApiKeys",t),this.#go.keyboardELEnabled=!0}onErrorEncrypt(){this.#go.showError(j.getText("DataEncryptorHandlers - An error occurs when saving the keys")),this.#go.hideWait(),this.#go.keyboardELEnabled=!0}}class wt{#to;#vo;constructor(t){Object.freeze(this),this.#to=t,this.#vo=new yt(this.#to)}destructor(){this.#vo.destructor(),this.#to=null}handleEvent(t){t.stopPropagation(),this.#to.hideError(),this.#to.showWait(),this.#to.keyboardELEnabled=!1,fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"ApiKeys").then((t=>{p===t.status&&t.ok?t.arrayBuffer().then((t=>{(new bt).decryptData(t,(t=>{this.#vo.onOkDecrypt(t)}),(t=>{this.#vo.onErrorDecrypt(t)}),new Et(!1).show())})):this.#vo.onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{this.#vo.onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class ft{#to;#vo;constructor(t){Object.freeze(this),this.#to=t,this.#vo=new yt(this.#to)}destructor(){this.#vo.destructor(),this.#to=null}handleEvent(t){t.stopPropagation(),this.#to.showWait(),this.#to.keyboardELEnabled=!1;const e=new FileReader;e.onload=()=>{(new bt).decryptData(e.result,(t=>{this.#vo.onOkDecrypt(t)}),(t=>{this.#vo.onErrorDecrypt(t)}),new Et(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class Mt{#to;#To;constructor(t){Object.freeze(this),this.#to=t,this.#To=new ft(this.#to)}destructor(){this.#to=null,this.#To.destructor()}handleEvent(t){t.stopPropagation(),this.#to.hideError(),S.openFile(this.#To)}}class It{#to;#vo;constructor(t){Object.freeze(this),this.#to=t,this.#vo=new yt(this.#to)}destructor(){this.#vo.destructor(),this.#to=null}handleEvent(t){t.stopPropagation(),this.#to.validateApiKeys()&&(this.#to.showWait(),this.#to.keyboardELEnabled=!1,(new bt).encryptData((new window.TextEncoder).encode(this.#to.apiKeysJSON),(t=>this.#vo.onOkEncrypt(t)),(()=>this.#vo.onErrorEncrypt()),new Et(!0).show()))}}class Nt{#to;constructor(t){Object.freeze(this),this.#to=t}destructor(){this.#to=null}handleEvent(t){t.stopPropagation(),this.#to.validateApiKeys()&&S.saveFile("ApiKeys.json",this.#to.apiKeysJSON,"application/json")}}class Ct{#Lo;constructor(t){Object.freeze(this),this.#Lo=t}destructor(){this.#Lo=null}handleEvent(t){t.stopPropagation(),this.#Lo.newApiKey()}}class Dt{#to;#Lo;#Eo;#bo;#yo;#wo;#fo;#Mo;#Io;#No;#Co;#Do;#xo;#Oo;#jo;#So;#Ho(){this.#bo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Reload from server"),textContent:"🔄"},this.#Eo),this.#Co=new wt(this.#to),this.#bo.addEventListener("click",this.#Co,!1)}#Po(){this.#yo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Save to file"),textContent:"💾"},this.#Eo),this.#Do=new It(this.#to),this.#yo.addEventListener("click",this.#Do,!1)}#Ro(){this.#wo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Open file"),textContent:"📂"},this.#Eo),this.#xo=new Mt(this.#to),this.#wo.addEventListener("click",this.#xo,!1)}#Ao(){this.#fo=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - new api key"),textContent:"+"},this.#Eo),this.#Oo=new Ct(this.#Lo),this.#fo.addEventListener("click",this.#Oo,!1)}#Bo(){this.#Mo=W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-ApiKeysDialog-AtRightButton",title:j.getText("ApiKeysDialogToolbar - Save to json file"),textContent:"💾"},this.#Eo),this.#jo=new Nt(this.#to),this.#Mo.addEventListener("click",this.#jo,!1)}#ko(){this.#Io=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("ApiKeysDialogToolbar - Open json file"),textContent:"📂"},this.#Eo),this.#So=new pt(this.#to),this.#Io.addEventListener("click",this.#So,!1)}#Fo(){window?.crypto?.subtle?.importKey&&window.isSecureContext&&(this.#No&&this.#Ho(),this.#Po(),this.#Ro()),this.#Ao(),t.ApiKeysDialog.haveUnsecureButtons&&(this.#Bo(),this.#ko())}constructor(t,e,o){this.#to=t,this.#Lo=e,this.#No=o,this.#Eo=W.create("div",{id:"TravelNotes-ApiKeysDialog-ToolbarDiv"}),this.#Fo(),Object.freeze(this)}destructor(){this.#bo&&(this.#bo.removeEventListener("click",this.#Co,!1),this.#Co.destructor(),this.#Co=null),this.#yo&&(this.#yo.removeEventListener("click",this.#Do,!1),this.#Do.destructor(),this.#Do=null),this.#wo&&(this.#wo.removeEventListener("click",this.#xo,!1),this.#xo.destructor(),this.#xo=null),this.#fo&&(this.#fo.removeEventListener("click",this.#Oo,!1),this.#Oo.destructor(),this.#Oo=null),this.#Mo&&(this.#Mo.removeEventListener("click",this.#jo,!1),this.#jo.destructor(),this.#jo=null),this.#Io&&(this.#Io.removeEventListener("click",this.#So,!1),this.#So.destructor(),this.#So=null)}get toolbarHTMLElement(){return this.#Eo}}class xt{#_o;#zo;#Ko;#t;#Uo;#Vo;constructor(e,o){Object.freeze(this),this.#Uo=o,this.#t=b.nextObjId,this.#_o=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"}),this.#zo=W.create("input",{className:"TravelNotes-ApiKeysDialog-ApiKeyName TravelNotes-ApiKeysDialog-Input",value:e.providerName,placeholder:j.getText("ApiKeyControlRow - provider name")},this.#_o),this.#Ko=W.create("input",{className:"TravelNotes-ApiKeysDialog-ApiKeyValue TravelNotes-ApiKeysDialog-Input",value:e.providerKey,placeholder:j.getText("ApiKeyControlRow - api key"),type:t.ApiKeysDialog.showApiKeys?"text":"password"},this.#_o),this.#Vo=W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-ApiKeysDialog-AtRightButton",title:j.getText("ApiKeyControlRow - delete api key"),textContent:"❌",dataset:{ObjId:this.#t}},this.#_o),this.#Vo.addEventListener("click",this.#Uo,!1)}destructor(){this.#Vo.removeEventListener("click",this.#Uo,!1)}get objId(){return this.#t}get HTMLElement(){return this.#_o}get providerName(){return this.#zo.value}get providerKey(){return this.#Ko.value}get apiKey(){return new V(this.#zo.value,this.#Ko.value)}}class Ot{#Lo;constructor(t){Object.freeze(this),this.#Lo=t}destructor(){this.#Lo=null}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.#Lo.deleteApiKey(Number.parseInt(t.target.dataset.tanObjId))}}class jt extends gt{#Wo;#Uo;constructor(){super(),this.#Wo=new Map,this.#Uo=new Ot(this)}destructor(){this.#Wo.forEach((t=>t.destructor())),this.#Wo.clear(),this.#Uo.destructor(),this.#Uo=null}haveEmptyOrDuplicateValues(){let t=!1;const e=[];this.#Wo.forEach((o=>{t=t||""===o.providerName||""===o.providerKey,e.push(o.providerName)}));let o=!1;return e.forEach((t=>{o=o||e.indexOf(t)!==e.lastIndexOf(t)})),{haveEmpty:t,haveDuplicate:o}}addApiKeys(t){this.#Wo.clear(),t.forEach((t=>{const e=new xt(t,this.#Uo);this.#Wo.set(e.objId,e)})),this.refreshApiKeys()}newApiKey(){const t=new V,e=new xt(t,this.#Uo);this.#Wo.set(e.objId,e),this.refreshApiKeys()}deleteApiKey(t){this.#Wo.get(t).destructor(),this.#Wo.delete(t),this.refreshApiKeys()}refreshApiKeys(){for(;this.controlHTMLElement.firstChild;)this.controlHTMLElement.removeChild(this.controlHTMLElement.firstChild);this.#Wo.forEach((t=>{this.controlHTMLElement.appendChild(t.HTMLElement)}))}get apiKeys(){const t=[];return this.#Wo.forEach((e=>t.push(e.apiKey))),t}get apiKeysJSON(){const t=[];return this.#Wo.forEach((e=>t.push(e.apiKey.jsonObject))),JSON.stringify(t)}}const St=new class{#Xo;#Yo;#Go;#Zo;#Jo;#qo;#$o(){this.#Go&&(clearTimeout(this.#Go),this.#Go=null),this.#Xo.classList.remove("TravelNotes-ErrorsUI-"+this.#qo),this.#Xo.classList.add("TravelNotes-Hidden"),this.#Jo.classList.add("TravelNotes-Hidden"),this.#Yo.textContent=""}#Qe(e,o){if(this.#qo=o,!t.errorsUI["show"+this.#qo]||"Help"===o&&this.#Zo.checked)return;this.#Go&&(clearTimeout(this.#Go),this.#Go=null),this.#Yo.textContent="",O.sanitizeToHtmlElement(e,this.#Yo),this.#Xo.classList.add("TravelNotes-ErrorsUI-"+this.#qo),this.#Xo.classList.remove("TravelNotes-Hidden");let s=t.errorsUI.timeOut;"Help"===this.#qo&&(this.#Jo.classList.remove("TravelNotes-Hidden"),s=t.errorsUI.helpTimeOut),this.#Go=setTimeout((()=>this.#$o()),s)}constructor(){Object.freeze(this)}createUI(){if(this.#Xo)return;this.#Xo=W.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);const e=W.create("div",null,this.#Xo);W.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this.#$o()),!1),this.#Yo=W.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.#Xo),this.#Jo=W.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.#Xo),this.#Zo=W.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox",checked:!t.errorsUI.showHelp},this.#Jo),W.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:"Don't show help again"},this.#Jo)}showError(t){this.#Qe(t,"Error")}showWarning(t){this.#Qe(t,"Warning")}showInfo(t){this.#Qe(t,"Info")}showHelp(t){this.#Qe(t,"Help")}};class Ht extends ut{#Qo;#Lo;#ts;#No;constructor(t,e){super(),this.#ts=t,this.#No=e}createContentHTML(){this.#Lo=new jt,this.#Qo=new Dt(this,this.#Lo,this.#No),this.#Lo.addApiKeys(this.#ts)}#Se(){this.#Lo.destructor(),this.#Qo.destructor(),this.#Qo=null}validateApiKeys(){this.hideError();const t=this.#Lo.haveEmptyOrDuplicateValues();return t.haveEmpty?(this.showError(j.getText("ApiKeysDialog - empty api key name or value")),!1):!t.haveDuplicate||(this.showError(j.getText("ApiKeysDialog - duplicate api key name found")),!1)}show(){return St.showHelp("<p>"+j.getText("Help - Complete the ApiKeys1")+"</p><p>"+j.getText("Help - Complete the ApiKeys2")+"</p><p>"+j.getText("Help - Complete the ApiKeys3")+"</p>"),super.show()}canClose(){return this.validateApiKeys()}onCancel(){this.#Se(),super.onCancel()}onOk(){super.onOk(this.#Lo.apiKeys)&&this.#Se()}get title(){return j.getText("ApiKeysDialog - api keys")}get toolbarHTMLElement(){return this.#Qo.toolbarHTMLElement}get contentHTMLElements(){return[this.#Lo.controlHTMLElement]}get apiKeysJSON(){return this.#Lo.apiKeysJSON}addApiKeys(t){this.#Lo.addApiKeys(t)}}const Pt=new class{constructor(){Object.freeze(this)}dispatch(t,e){const o=new Event(t);e&&(o.data=e),document.dispatchEvent(o)}};const Rt=new class{#No=!1;#es=new Map;#os(t){this.#ss(JSON.parse((new TextDecoder).decode(t)))}#is(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&St.showError(j.getText("ApiKeysManager - An error occurs when reading the ApiKeys file"))}#ns(t){window.isSecureContext&&window?.crypto?.subtle?.importKey&&(new bt).decryptData(t,(t=>this.#os(t)),(t=>this.#is(t)),new Et(!1).show())}#rs(t){return this.#es.get(t.toLowerCase())}#as(t,e){this.#es.set(t.toLowerCase(),e)}#ls(){if(!S.storageAvailable("sessionStorage"))return 0;let t=0;for(let e=0;e<sessionStorage.length;e++){const o=sessionStorage.key(e);o.match(/^\w*ProviderKey$/)&&(this.#as(o.replace("ProviderKey",""),atob(sessionStorage.getItem(o))),t++)}return U.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.#rs(t.name)||"")})),t}#ss(e){this.#es.clear();const o=S.storageAvailable("sessionStorage")&&t.ApiKeys.saveToSessionStorage;o&&sessionStorage.clear(),e.forEach((t=>{o&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.#as(t.providerName,t.providerKey)})),U.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.#rs(t.name)||"")})),Pt.dispatch("providersadded")}constructor(){Object.freeze(this)}hasKey(t){return this.#es.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){const e=this.#es.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.#ls()&&(Pt.dispatch("providersadded"),t=!0),fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"ApiKeys").then((e=>{p===e.status&&e.ok&&(this.#No=!0,t||e.arrayBuffer().then((t=>this.#ns(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){const t=[];this.#es.forEach(((e,o)=>{t.push(new V(o,e))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new Ht(t,this.#No).show().then((t=>this.#ss(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){const e=new t,o=e.name.toLowerCase();let s=this.#rs(o);e.providerKeyNeeded&&!s&&S.storageAvailable("sessionStorage")&&(s=sessionStorage.getItem(o),s&&(s=atob(s))),e.providerKeyNeeded&&s&&(e.providerKey=s),U.providers.set(e.name.toLowerCase(),e)}};const At=new class{#ds(t){return(t+e.d540)%e.d360-e.d180}constructor(){Object.freeze(this)}arcFromSummitArcArc(t,e,o){return Math.acos(Math.cos(e)*Math.cos(o)+Math.sin(e)*Math.sin(o)*Math.cos(t))}summitFromArcArcArc(t,e,o){return Math.acos((Math.cos(o)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,o){if(t[0]===o[0]&&t[1]===o[1])return 0;const s=t[0]*e.toRadians,i=o[0]*e.toRadians,n=(this.#ds(o[1])-this.#ds(t[1]))*e.toRadians;return Math.acos(Math.sin(s)*Math.sin(i)+Math.cos(s)*Math.cos(i)*Math.cos(n))*u}};class Bt{#cs;#hs;constructor(t,e){Object.freeze(this),this.#cs=t,this.#hs=e}get note(){return this.#cs}get route(){return this.#hs}}class kt{constructor(){Object.seal(this)}distance=Number.MAX_VALUE;route=null;distanceOnRoute=0;latLngOnRoute=[a.defaultValue,a.defaultValue]}const Ft=new class{#us(t,e,o){if(t.objId!==U.editedRouteObjId){const s=ot.getClosestLatLngDistance(t,e);if(s){const i=At.pointsDistance(e,s.latLng);i<o.distance&&(o.route=t,o.distance=i,o.latLngOnRoute=s.latLng,o.distanceOnRoute=s.distance)}}}constructor(){Object.freeze(this)}getNearestRouteData(t){const e=new kt;return U.travel.routes.forEach((o=>this.#us(o,t,e))),g!==U.editedRouteObjId&&this.#us(U.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=U.travel.routes.getAt(t),e||t===U.travel.editedRoute.objId&&(e=U.travel.editedRoute),e}getNoteAndRoute(t){let e=null,o=null;if(e=U.travel.notes.getAt(t),!e){const s=U.travel.routes.iterator;for(;!s.done&&!e;)e=s.value.notes.getAt(t),e&&(o=s.value);e||(e=U.travel.editedRoute.notes.getAt(t),e&&(o=U.travel.editedRoute))}return new Bt(e,o)}getWayPoint(t){let e=U.travel.editedRoute.wayPoints.getAt(t);if(!e){const o=U.travel.routes.iterator;for(;!o.done&&!e;)e=o.value.wayPoints.getAt(t)}return e}};class _t{#ms;#ps;#hs;static get#gs(){return"\n"}static get#vs(){return"\n\t"}static get#Ts(){return"\n\t\t"}static get#Ls(){return"\n\t\t\t"}static get#Es(){return"\n\t\t\t\t"}#bs(){this.#ms='<?xml version="1.0"?>'+_t.#gs,this.#ms+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}#ys(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}#ws(){const t=this.#hs.wayPoints.iterator;for(;!t.done;)this.#ms+=_t.#vs+'<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+_t.#Ts+this.#ps+_t.#Ts+"<name>"+this.#ys(t.value.fullName)+"</name>"+_t.#vs+"</wpt>"}#fs(){this.#ms+=_t.#vs+"<rte>",this.#ms+=_t.#Ts+"<name>"+this.#ys(this.#hs.computedName)+"</name>";const t=this.#hs.itinerary.maneuvers.iterator;for(;!t.done;){const e=this.#hs.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId);this.#ms+=_t.#Ts+'<rtept lat="'+e.lat+'" lon="'+e.lng+'">'+_t.#Ls+this.#ps+_t.#Ls+"<desc>"+this.#ys(t.value.instruction)+"</desc>"+_t.#Ts+"</rtept>"}this.#ms+=_t.#vs+"</rte>"}#Ms(){this.#ms+=_t.#vs+"<trk>",this.#ms+=_t.#Ts+"<name>"+this.#ys(this.#hs.computedName)+"</name>",this.#ms+=_t.#Ts+"<trkseg>";const t=this.#hs.itinerary.itineraryPoints.iterator;for(;!t.done;)this.#ms+=_t.#Ls+'<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+_t.#Es+this.#ps+_t.#Es+"<ele>"+t.value.elev+"</ele>"+_t.#Ls+"</trkpt>";this.#ms+=_t.#Ts+"</trkseg>",this.#ms+=_t.#vs+"</trk>"}#Is(){this.#ms+=_t.#gs+"</gpx>"}#Ns(){let t=(""===U.travel.name?"":U.travel.name+" - ")+this.#hs.computedName;""===t&&(t="TravelNote"),t+=".gpx",S.saveFile(t,this.#ms,"application/xml")}constructor(){Object.freeze(this)}routeToGpx(t){this.#hs=Ft.getRoute(t),this.#hs&&(this.#ps="<time>"+(new Date).toISOString()+"</time>",this.#bs(),this.#ws(),this.#fs(),this.#Ms(),this.#Is(),this.#Ns())}}class zt extends gt{#Cs;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#Cs=W.create("input",{type:"checkbox",className:"TravelNotes-CheckboxInputControl-Checkbox",checked:t?.checked,dataset:{Name:t?.datasetName||"CheckboxInputControl"}},this.controlHTMLElement),W.create("text",{value:t?.afterText||""},this.controlHTMLElement)}get checked(){return this.#Cs.checked}set checked(t){this.#Cs.checked=t}}class Kt{#Ds;#xs;#Os;constructor(t,e,o){Object.freeze(this),this.#Ds="number"==typeof t&&Kt.MAX_COLOR>=t&&Kt.MIN_COLOR<=t?t:Kt.MAX_COLOR,this.#xs="number"==typeof e&&Kt.MAX_COLOR>=e&&Kt.MIN_COLOR<=e?e:Kt.MAX_COLOR,this.#Os="number"==typeof o&&Kt.MAX_COLOR>=o&&Kt.MIN_COLOR<=o?o:Kt.MAX_COLOR}static get MIN_COLOR(){return 0}static get MAX_COLOR(){return 255}static fromCss(t){let e=new Kt;return e.cssColor=t,e}get red(){return this.#Ds}set red(t){"number"==typeof t&&Kt.MAX_COLOR>=t&&Kt.MIN_COLOR<=t&&(this.#Ds=t)}get green(){return this.#xs}set green(t){"number"==typeof t&&Kt.MAX_COLOR>=t&&Kt.MIN_COLOR<=t&&(this.#xs=t)}get blue(){return this.#Os}set blue(t){"number"==typeof t&&Kt.MAX_COLOR>=t&&Kt.MIN_COLOR<=t&&(this.#Os=t)}get cssColor(){return"#"+this.#Ds.toString(m).padStart(2,"0")+this.#xs.toString(m).padStart(2,"0")+this.#Os.toString(m).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.#Ds=Number.parseInt(t.substring(1,3),m),this.#xs=Number.parseInt(t.substring(3,5),m),this.#Os=Number.parseInt(t.substring(5,7),m)):"rgb"===t.substring(0,3)&&([this.#Ds,this.#xs,this.#Os]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}}class Ut{#js=null;constructor(t){Object.freeze(this),this.#js=t}handleEvent(t){t.stopPropagation(),this.#js.onColorButtonClick(t.target.style["background-color"])}}class Vt{#Ss;#Hs;#Ps;static get#Rs(){return 6}static get#As(){return 6}static get#Bs(){return 51}constructor(t){Object.freeze(this),this.#Hs=[],this.#Ps=new Ut(t),this.#Ss=W.create("div",null,t.controlHTMLElement);for(let t=0;t<Vt.#Rs;++t){const t=W.create("div",null,this.#Ss);for(let e=0;e<Vt.#As;++e){let e=W.create("div",{className:"TravelNotes-ColorControl-CellColorHTMLElement"},t);e.addEventListener("click",this.#Ps,!1),this.#Hs.push(e)}}}destructor(){this.#Hs.forEach((t=>{t.removeEventListener("click",this.#Ps,!1)})),this.#Ps=null}set red(t){let e=new Kt(t,Kt.MIN_COLOR,Kt.MIN_COLOR);this.#Hs.forEach((t=>{t.style["background-color"]=e.cssColor,Kt.MAX_COLOR<=e.green?(e.green=Kt.MIN_COLOR,e.blue+=Vt.#Bs):e.green+=Vt.#Bs}))}}class Wt{#js;#ks;constructor(t,e){Object.freeze(this),this.#js=t,this.#ks=e}handleEvent(t){t.stopPropagation(),this.#js.onRedSliderInput(t.target.valueAsNumber*(this.#ks-Math.floor(this.#ks)<Math.ceil(this.#ks)-this.#ks?Math.floor(this.#ks):Math.ceil(this.#ks)))}}class Xt{#Fs;#_s;static get#zs(){return 100}static get#Ks(){return 20}constructor(t){this.#_s=new Wt(t,Kt.MAX_COLOR/Xt.#zs),this.#Fs=W.create("input",{type:"range",value:0,min:0,max:Xt.#zs,step:Xt.#Ks},W.create("div",null,t.controlHTMLElement)),this.#Fs.addEventListener("input",this.#_s,!1),this.#Fs.focus()}destructor(){this.#Fs.removeEventListener("input",this.#_s,!1),this.#_s=null}}class Yt{#js;#Us;constructor(t,e){Object.freeze(this),this.#js=t,this.#Us=e}handleEvent(t){t.stopPropagation(),this.#js.onRgbInput(this.#Us.cssColor)}}class Gt{#Vs;#Ws;#Xs;#Ys;#Gs;#Zs(t){W.create("text",{value:t},this.#Vs);const e=W.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",min:Kt.MIN_COLOR,max:Kt.MAX_COLOR},this.#Vs);return e.addEventListener("input",this.#Gs,!1),e}constructor(t){Object.freeze(this),this.#Gs=new Yt(t,this),this.#Vs=W.create("div",null,t.controlHTMLElement),this.#Ws=this.#Zs(j.getText("ColorControl - Red")),this.#Xs=this.#Zs(j.getText("ColorControl - Green")),this.#Ys=this.#Zs(j.getText("ColorControl - Blue"))}destructor(){this.#Ws.removeEventListener("input",this.#Gs,!1),this.#Xs.removeEventListener("input",this.#Gs,!1),this.#Ys.removeEventListener("input",this.#Gs,!1),this.#Gs=null}get cssColor(){return new Kt(Number.parseInt(this.#Ws.value),Number.parseInt(this.#Xs.value),Number.parseInt(this.#Ys.value)).cssColor}set cssColor(t){let e=Kt.fromCss(t);this.#Ws.value=e.red,this.#Xs.value=e.green,this.#Ys.value=e.blue}}class Zt{#Js;constructor(t){Object.freeze(this),this.#Js=W.create("div",{id:"TravelNotes-ColorControl-ColorSampleHTMLElement"},t.controlHTMLElement)}get cssColor(){return this.#Js.style["background-color"]}set cssColor(t){this.#Js.style["background-color"]=t}}class Jt extends gt{#qs;#$s;#Us;#Qs;constructor(t){super(),t?.headerText&&""!==t.headerText&&W.create("div",{textContent:t.headerText},this.controlHTMLElement),this.controlHTMLElement.classList.add("TravelNotes-ColorControl-ColorHTMLElement"),this.#qs=new Vt(this),this.#qs.red=0,this.#$s=new Xt(this),this.#Us=new Gt(this),this.#Us.cssColor=t?.cssColor||"#ff0000",this.#Qs=new Zt(this),this.#Qs.cssColor=t?.cssColor||"#ff0000"}destructor(){this.#qs.destructor(),this.#$s.destructor(),this.#Us.destructor()}get cssColor(){return Kt.fromCss(this.#Qs.cssColor).cssColor}onRedSliderInput(t){this.#qs.red=t}onColorButtonClick(t){this.#Us.cssColor=t,this.#Qs.cssColor=t}onRgbInput(t){this.#Qs.cssColor=t}}class qt extends gt{#Cs;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#Cs=W.create("input",{type:"number",className:"TravelNotes-NumberInputControl-NumberInput",value:t?.value||0,min:t?.min||0,max:t?.max||Number.MAX_VALUE,dataset:{Name:t?.datasetName||"NumberInputControl"}},this.controlHTMLElement),W.create("text",{value:t?.afterText||""},this.controlHTMLElement)}get value(){return Number.parseInt(this.#Cs.value)}set value(t){this.#Cs.value=t}}class $t extends gt{#Cs;constructor(t,e){super(),W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:t?.headerText||""},this.controlHTMLElement),this.#Cs=W.create("input",{className:"TravelNotes-TextInputControl-TextInput",type:"text",dataset:{Name:t?.datasetName||"TextInputControl"},value:t?.value||""},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),e?.controlFocus&&this.#Cs.addEventListener("focus",e.controlFocus),e?.controlInput&&this.#Cs.addEventListener("input",e.controlInput)}destructor(t){t?.controlFocus&&this.#Cs.removeEventListener("focus",t.controlFocus),t?.controlInput&&this.#Cs.removeEventListener("input",t.controlInput)}get value(){return this.#Cs.value}set value(t){this.#Cs.value=t}}class Qt extends gt{#ti;constructor(t){super(),W.create("text",{value:t?.beforeText||""},this.controlHTMLElement),this.#ti=W.create("select",null,this.controlHTMLElement),t?.elements.forEach((t=>{this.#ti.add(W.create("option",{text:t}))}))}get selectedIndex(){return this.#ti.selectedIndex}set selectedIndex(t){this.#ti.selectedIndex=t}}class te extends ut{#hs;#js;#ei;#oi;#si;#ii;static get#ni(){return 1}static get#ri(){return 40}constructor(t){super(),this.#hs=t}createContentHTML(){this.#ei=new $t({headerText:j.getText("RoutePropertiesDialog - Name"),value:this.#hs.computedName}),this.#oi=new qt({beforeText:j.getText("RoutePropertiesDialog - Width"),value:this.#hs.width,min:te.#ni,max:te.#ri}),this.#si=new Qt({beforeText:j.getText("RoutePropertiesDialog - Linetype"),elements:Array.from(t.route.dashChoices,(t=>t.text))}),this.#si.selectedIndex=this.#hs.dashIndex<t.route.dashChoices.length?this.#hs.dashIndex:0,this.#ii=new zt({beforeText:j.getText("RoutePropertiesDialog - Chained route"),checked:this.#hs.chain}),this.#js=new Jt({cssColor:this.#hs.color,headerText:j.getText("RoutePropertiesDialog - Color")})}show(){let t=super.show();return this.addCssClass("TravelNotes-RoutePropertiesDialog"),t}onCancel(){this.#js.destructor(),super.onCancel()}onOk(){this.#hs.color=this.#js.cssColor,this.#hs.computedName!==this.#ei.value&&(this.#hs.name=this.#ei.value),this.#hs.width=this.#oi.value,this.#hs.chain=this.#ii.checked,this.#hs.dashIndex=this.#si.selectedIndex,this.#js.destructor(),super.onOk()}get title(){return j.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[this.#ei.controlHTMLElement,this.#oi.controlHTMLElement,this.#si.controlHTMLElement,this.#ii.controlHTMLElement,this.#js.controlHTMLElement]}}class ee extends gt{static#t=0;#ai;constructor(t){super(),this.#ai=[],W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:t?.headerText||""},this.controlHTMLElement);let e="controlName"+ ++ee.#t,o=0;t.buttons.forEach((s=>{let i="buttonId"+ ++ee.#t,n=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#ai.push(W.create("input",{type:"radio",className:"TravelNotes-RadioInputControl-Radio",checked:s.checked,id:i,name:e,value:String(o++),dataset:{Name:t?.datasetName||"RadioInputControl"}},n)),W.create("label",{htmlFor:i,innerText:s.label},n)}))}get value(){let t=T;return this.#ai.forEach((e=>{t=e.checked?Number.parseInt(e.value):t})),t}}class oe{constructor(){Object.seal(this)}paperWidth=0;paperHeight=0;borderWidth=0;zoomFactor=0;printNotes=!1;firefoxBrowser=!0}class se extends ut{#li;#di;#ci;#hi;#ui;#mi;static get#pi(){return 15}constructor(){super()}createContentHTML(){this.#li=new qt({beforeText:j.getText("PrintRouteMapDialog - Paper width"),afterText:j.getText("PrintRouteMapDialog - Paper width units"),value:t.printRouteMap.paperWidth}),this.#di=new qt({beforeText:j.getText("PrintRouteMapDialog - Paper height"),afterText:j.getText("PrintRouteMapDialog - Paper height units"),value:t.printRouteMap.paperHeight}),this.#ci=new qt({beforeText:j.getText("PrintRouteMapDialog - Border width"),afterText:j.getText("PrintRouteMapDialog - Border width units"),value:t.printRouteMap.borderWidth}),this.#hi=new qt({beforeText:j.getText("PrintRouteMapDialog - Zoom factor"),value:Math.min(t.printRouteMap.zoomFactor,se.#pi),min:U.map.getMinZoom(),max:Math.min(U.map.getMaxZoom(),se.#pi)}),this.#ui=new zt({afterText:j.getText("PrintRouteMapDialog - Print notes"),checked:t.printRouteMap.printNotes}),this.#mi=new ee({headerText:j.getText("PrintRouteMapDialog - Print with"),buttons:[{label:"Firefox",checked:t.printRouteMap.firefoxBrowser},{label:j.getText("PrintRouteMapDialog - Another browser"),checked:!t.printRouteMap.firefoxBrowser}]})}show(){let t=super.show();return this.addCssClass("TravelNotes-PrintRouteMapDialog"),t}onOk(){const t=new oe;t.paperWidth=this.#li.value,t.paperHeight=this.#di.value,t.borderWidth=this.#ci.value,t.zoomFactor=this.#hi.value,t.printNotes=this.#ui.checked,t.firefoxBrowser=0===this.#mi.value,Object.freeze(t),super.onOk(t)}get contentHTMLElements(){return[this.#li.controlHTMLElement,this.#di.controlHTMLElement,this.#ci.controlHTMLElement,this.#hi.controlHTMLElement,this.#ui.controlHTMLElement,this.#mi.controlHTMLElement]}get title(){return j.getText("PrintRouteMapDialog - Print")}}class ie{#se=null;#ie=null;#ne=null;#re=null;#ae=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.#se=t.firstButtonText;break;case"secondButtonText":this.#ie=t.secondButtonText;break;case"selectOptionsData":this.#ne=t.selectOptionsData;break;case"title":this.#re=t.title;break;case"text":this.#ae=t.text}}get firstButtonText(){return this.#se}get secondButtonText(){return this.#ie}get selectOptionsData(){return this.#ne}get title(){return this.#re}get text(){return this.#ae}}class ne{#_t;constructor(t){Object.freeze(this),this.#_t=t}handleEvent(){this.#_t.onCancel()}}class re{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.setDragStartPoint(t),t.dataTransfer.setData("ObjId",this.#Kt.objId)}}class ae{#Kt;constructor(t){Object.freeze(this),this.#Kt=t}handleEvent(t){this.#Kt.moveDialog(t)}}class le{#Kt;#le;constructor(t){Object.freeze(this),this.#Kt=t,this.#le=!1}handleEvent(t){t.stopPropagation();let e=t.type;if(1===t.changedTouches.length){const o=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#le=!0,this.#Kt.setDragStartPoint(o);break;case"touchmove":this.#le=!1,t.preventDefault(),this.#Kt.moveDialog(o,e);break;case"touchend":this.#le||this.#Kt.moveDialog(o,e)}}}}class de{#t;#he;#ue;#me;#pe;#ge(t,e){const o=ct.screenAvailable,s=o.width-this.dialogHTMLElement.offsetWidth-h,i=o.height-this.dialogHTMLElement.offsetHeight-h;this.#me=Math.max(Math.min(t,s),h),this.#pe=Math.max(Math.min(e,i),h)}#ve(){this.dialogHTMLElement.style.left=String(this.#me)+"px",this.dialogHTMLElement.style.top=String(this.#pe)+"px"}dialogHTMLElement=null;topBarHTMLElement=null;constructor(){Object.seal(this),this.#me=h,this.#pe=h,this.#he=0,this.#ue=0,this.#t=b.nextObjId}get onTop(){return 42>this.#pe}get objId(){return this.#t}centerDialog(){const e=ct.screenAvailable;this.dialogHTMLElement.style["max-height"]=String(e.height-80)+"px",this.dialogHTMLElement.style["max-width"]=String(e.width-80)+"px",this.#me=(e.width-this.dialogHTMLElement.clientWidth)/2,t.baseDialog.touchTopScreen&&ct.isTouch?this.#pe=h:this.#pe=(e.height-this.dialogHTMLElement.clientHeight)/2,this.#ve()}moveDialog(t,e){const o=this.#me+t.screenX-this.#he,s=this.#pe+t.screenY-this.#ue;this.moveDialogTo(o,s,e),this.setDragStartPoint(t)}moveDialogTo(t,e){this.#ge(t,e),this.#ve()}moveDialogToLastPosition(){this.moveDialogTo(this.#me,this.#pe)}moveDialogToTopLeft(){this.#me=h,this.#pe=h,this.#ve()}setDragStartPoint(t){this.#he=t.screenX,this.#ue=t.screenY}}class ce extends class{#Te;#Le;#Ee;#be;#ye;#we;#fe;#Me;#Ie;#Ne=null;#Ce(){this.#Te=W.create("div",{className:"TravelNotes-BaseDialog-DialogHTMLElement"}),this.mover.dialogHTMLElement=this.#Te}#De(){this.#Le=W.create("div",{className:"TravelNotes-BaseDialog-TopBarHTMLElement",draggable:!0},this.#Te),this.#Me=new le(this.mover),this.#Le.addEventListener("touchstart",this.#Me,!1),this.#Le.addEventListener("touchmove",this.#Me,!1),this.#Le.addEventListener("touchend",this.#Me,!1),this.#Le.addEventListener("touchcancel",this.#Me,!1),this.#we=new re(this.mover),this.#Le.addEventListener("dragstart",this.#we,!1),this.#fe=new ae(this.mover),this.#Le.addEventListener("dragend",this.#fe,!1),this.#Ee=W.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:j.getText("BaseDialog - Cancel")},this.#Le),W.create("div",{textContent:this.title,className:"TravelNotes-BaseDialog-Title"},this.#Le),this.#Ie=new ne(this),this.#Ee.addEventListener("click",this.#Ie,!1),this.mover.topBarHTMLElement=this.#Le}#xe(){this.toolbarHTMLElement&&W.create("div",{className:"TravelNotes-BaseDialog-ToolbarHTMLElement"},this.#Te).appendChild(this.toolbarHTMLElement)}#Oe(){this.#be=W.create("div",{className:"TravelNotes-BaseDialog-ContentHTMLElement"},this.#Te),this.contentHTMLElements.forEach((t=>this.#be.appendChild(t)))}#je(){this.#Ce(),this.#De(),this.#xe(),this.#Oe()}constructor(t){Object.freeze(this),this.#Ne=new ie(t)}#Se(){this.#Le.removeEventListener("dragstart",this.#we,!1),this.#we=null,this.#Le.removeEventListener("dragend",this.#fe,!1),this.#fe=null,this.#Le.removeEventListener("touchstart",this.#Me,!1),this.#Le.removeEventListener("touchmove",this.#Me,!1),this.#Le.removeEventListener("touchend",this.#Me,!1),this.#Le.removeEventListener("touchcancel",this.#Me,!1),this.#Me=null,this.#Ee.removeEventListener("click",this.#Ie,!1),this.#Ie=null,this.#ye&&(this.#ye=null)}get mover(){return this.#ye?this.#ye:this.#ye=new de}onCancel(){this.#Se()}onOk(){this.#Se()}get title(){return""}get toolbarHTMLElement(){return null}get contentHTMLElements(){return[]}show(){this.createContentHTML(),this.#je()}removeFromBackground(t){t.removeChild(this.#Te)}addToBackground(t){t.appendChild(this.#Te)}addToDialog(t){this.#Te.appendChild(t)}get options(){return this.#Ne}addCssClass(t){this.#Te.classList.add(t)}}{#Ue;#Ze(){this.#Ue=new q(this.mover),document.body.addEventListener("dragover",this.#Ue,!1)}constructor(){super()}onCancel(){document.body.removeEventListener("dragover",this.#Ue,!1),this.#Ue=null,super.onCancel(),this.removeFromBackground(document.body)}show(){super.show(),this.#Ze(),this.addToBackground(document.body)}}class he{#hs;#gi;#vi;#Ti;#Li;#Ei;#bi;static get PROFILE_MARGIN(){return 100}static get PROFILE_HEIGHT(){return 500}static get PROFILE_WIDTH(){return 1e3}static get X_DELTA_TEXT(){return 10}static get Y_DELTA_TEXT(){return 30}static get#yi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}static get#wi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3]}static get#fi(){return 8}static get#Mi(){return 4}static get#Ii(){return he.PROFILE_MARGIN.toFixed(0)}static get#Ni(){return(he.PROFILE_MARGIN+he.PROFILE_WIDTH).toFixed(0)}static get#Ci(){return he.PROFILE_MARGIN.toFixed(0)}static get#Di(){return(he.PROFILE_MARGIN+he.PROFILE_HEIGHT).toFixed(0)}static get#xi(){return(he.PROFILE_MARGIN-he.X_DELTA_TEXT).toFixed(0)}static get#Oi(){return(he.PROFILE_MARGIN+he.PROFILE_WIDTH+he.X_DELTA_TEXT).toFixed(0)}static get#ji(){return he.PROFILE_MARGIN+he.PROFILE_HEIGHT+he.PROFILE_MARGIN/2}#Si(){let t="",e=0,o=0,s=0;this.#hs.itinerary.itineraryPoints.forEach((i=>{o=(he.PROFILE_MARGIN+this.#Ti*e).toFixed(0),s=(he.PROFILE_MARGIN+this.#vi*(this.#Ei-i.elev)).toFixed(0),t+=o+","+s+" ",e+=i.distance}));const i=document.createElementNS(L,"polyline");i.setAttributeNS(null,"points",t),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.#gi.appendChild(i)}#Hi(){const t=he.#Ii+","+he.#Ci+" "+he.#Ii+","+he.#Di+" "+he.#Ni+","+he.#Di+" "+he.#Ni+","+he.#Ci,e=document.createElementNS(L,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.#gi.appendChild(e)}#Pi(){let t=Number.MAX_VALUE,e=0;he.#yi.forEach((o=>{const s=Math.abs(this.#hs.distance/he.#fi-o);s<t&&(t=s,e=o)}));let s=Math.ceil(this.#hs.chainedDistance/e)*e;for(;s<this.#hs.distance+this.#hs.chainedDistance;){const t=document.createElementNS(L,"text");t.appendChild(document.createTextNode(o.metersInKm<e||0<this.#hs.chainedDistance?s/o.metersInKm+" km":s+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",he.PROFILE_MARGIN+(s-this.#hs.chainedDistance)*this.#Ti),t.setAttributeNS(null,"y",he.#ji),t.setAttributeNS(null,"text-anchor","start"),this.#gi.appendChild(t),s+=e}}#Ri(){let t=Number.MAX_VALUE,e=0;he.#wi.forEach((o=>{const s=Math.abs(this.#bi/he.#Mi-o);s<t&&(t=s,e=o)}));let o=Math.ceil(this.#Li/e)*e;for(;o<this.#Ei;){const t=he.PROFILE_MARGIN+(this.#Ei-o)*this.#vi,s=document.createElementNS(L,"text");s.appendChild(document.createTextNode(o.toFixed(0))),s.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),s.setAttributeNS(null,"x",he.#Oi),s.setAttributeNS(null,"y",t),s.setAttributeNS(null,"text-anchor","start"),this.#gi.appendChild(s);const i=document.createElementNS(L,"text");i.appendChild(document.createTextNode(o.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",he.#xi),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","end"),this.#gi.appendChild(i),o+=e}}#Ai(){this.#gi=document.createElementNS(L,"svg"),this.#gi.setAttributeNS(null,"viewBox","0 0 "+(he.PROFILE_WIDTH+2*he.PROFILE_MARGIN)+" "+(he.PROFILE_HEIGHT+2*he.PROFILE_MARGIN)),this.#gi.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){Object.freeze(this)}createSvg(t){return this.#hs=t,this.#Li=Number.MAX_VALUE,this.#Ei=0,this.#hs.itinerary.itineraryPoints.forEach((t=>{this.#Ei=Math.max(this.#Ei,t.elev),this.#Li=Math.min(this.#Li,t.elev)})),this.#bi=this.#Ei-this.#Li,this.#vi=he.PROFILE_HEIGHT/this.#bi,this.#Ti=he.PROFILE_WIDTH/this.#hs.distance,this.#Ai(),this.#Si(),this.#Hi(),this.#Ri(),this.#Pi(),this.#gi}}class ue{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onKeydownKeyboard(t.key)}}class me{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onCancelMenu()}}class pe{#ki=null;#Fi=null;static get#_i(){return 100}static get#zi(){return 30}#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){if(1===t.changedTouches.length){const e=t.changedTouches.item(0);switch(t.type){case"touchstart":this.#ki=e.clientX,this.#Fi=e.clientY;break;case"touchend":this.#ki&&this.#Fi&&pe.#_i<this.#Fi-e.clientY&&pe.#zi>Math.abs(this.#ki-e.clientX)&&this.#Bi.onCancelMenu(),this.#ki=null,this.#Fi=null;break;case"touchcancel":this.#ki=null,this.#Fi=null}}}}class ge{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onMouseLeaveMenuItem(t.currentTarget)}}class ve{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onMouseEnterMenuItem(t.currentTarget)}}class Te{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.selectItem(Number.parseInt(t.currentTarget.dataset.tanObjId))}}class Le{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onMouseLeaveContainer()}}class Ee{#Bi=null;constructor(t){Object.freeze(this),this.#Bi=t}handleEvent(t){t.stopPropagation(),this.#Bi.onMouseEnterContainer()}}class be{static#Ki=Object.freeze({get previousItem(){return-1},get firstItem(){return 0},get nextItem(){return 1},get lastItem(){return 2}});#Ui=null;#Vi;#Wi;#Xi;#Yi;#Gi;#Zi;#Ji;#qi;#$i=T;#Go=null;#Qi(){this.#Ui.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-MenuItemSelected")}))}#tn(t){switch(this.#Qi(),t){case be.#Ki.previousItem:case be.#Ki.nextItem:this.#$i+=t,T===this.#$i&&(this.#$i=this.#Ui.menuItemHTMLElements.length-1),this.#Ui.menuItemHTMLElements.length===this.#$i&&(this.#$i=0);break;case be.#Ki.firstItem:this.#$i=0;break;case be.#Ki.lastItem:this.#$i=this.#Ui.menuItemHTMLElements.length-1}this.#Ui.menuItemHTMLElements[this.#$i].classList.add("TravelNotes-ContextMenu-MenuItemSelected")}constructor(t){Object.freeze(this),this.#Ui=t,this.#Vi=new ue(this),this.#Wi=new Le(this),this.#Xi=new Ee(this),this.#Yi=new me(this),this.#Gi=new pe(this),this.#Zi=new Te(this),this.#Ji=new ge(this),this.#qi=new ve(this),document.addEventListener("keydown",this.#Vi,!0),this.#Ui.contextMenuHTMLElement.addEventListener("mouseleave",this.#Wi),this.#Ui.contextMenuHTMLElement.addEventListener("mouseenter",this.#Xi),this.#Ui.contextMenuHTMLElement.addEventListener("touchstart",this.#Gi),this.#Ui.contextMenuHTMLElement.addEventListener("touchend",this.#Gi),this.#Ui.contextMenuHTMLElement.addEventListener("touchcancel",this.#Gi),this.#Ui.cancelButton.addEventListener("click",this.#Yi),this.#Ui.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.#Zi),t.addEventListener("mouseleave",this.#Ji),t.addEventListener("mouseenter",this.#qi)}))}destructor(){this.#Go&&(clearTimeout(this.#Go),this.#Go=null),document.removeEventListener("keydown",this.#Vi,!0),this.#Ui.contextMenuHTMLElement.removeEventListener("mouseleave",this.#Wi),this.#Ui.contextMenuHTMLElement.removeEventListener("mouseenter",this.#Xi),this.#Ui.contextMenuHTMLElement.removeEventListener("touchstart",this.#Gi),this.#Ui.contextMenuHTMLElement.removeEventListener("touchend",this.#Gi),this.#Ui.contextMenuHTMLElement.removeEventListener("touchcancel",this.#Gi),this.#Ui.cancelButton.removeEventListener("click",this.#Yi),this.#Ui.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.#Zi),t.removeEventListener("mouseleave",this.#Ji),t.removeEventListener("mouseenter",this.#qi)})),this.#Vi=null,this.#Wi=null,this.#Xi=null,this.#Yi=null,this.#Gi=null,this.#Zi=null,this.#Ji=null,this.#qi=null,document.body.removeChild(this.#Ui.contextMenuHTMLElement),this.#Ui=null}onMouseLeaveContainer(){this.#Go=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.#Go&&(clearTimeout(this.#Go),this.#Go=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.#tn(be.#Ki.nextItem);break;case"ArrowUp":case"ArrowLeft":this.#tn(be.#Ki.previousItem);break;case"Home":this.#tn(be.#Ki.firstItem);break;case"End":this.#tn(be.#Ki.lastItem);break;case"Enter":if(T===this.#$i||this.#Ui.menuItemHTMLElements[this.#$i].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.#Ui.onOk(this.#$i)}}onCancelMenu(){this.#Ui.onCancel("Canceled by user")}selectItem(t){this.#Ui.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.#Ui.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-MenuItemSelected")}onMouseEnterMenuItem(t){this.#Qi(),this.#$i=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-MenuItemSelected")}}class ye{#ki;#Fi;#en;#on;#sn;static#in=null;#nn;#rn;#an;#Ee;#ln;#Bi;static get#dn(){return 20}static get isActive(){return Boolean(ye.#in)}#cn(){this.#an=W.create("div",{className:"TravelNotes-ContextMenu-ContextMenuHTMLElement"},document.body)}#hn(){this.#Ee=W.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CancelButton",title:j.getText("BaseContextMenu - Close")},this.#an)}#un(){this.#ln=[],this.menuItems.forEach(((t,e)=>{const o=W.create("div",{textContent:t.itemText,className:"TravelNotes-ContextMenu-MenuItem",dataset:{ObjId:String(e)}},this.#an);t.isActive||o.classList.add("TravelNotes-ContextMenu-MenuItemDisabled"),this.#ln.push(o)}))}#mn(){const t=ct.screenAvailable,e=Math.min(this.#Fi,t.height-this.#an.clientHeight-ye.#dn);this.#an.style.top=String(e)+"px";const o=Math.min(this.#ki,t.width-this.#an.clientWidth-ye.#dn);this.#an.style.left=String(o)+"px"}#pn(t,e){this.#nn=t,this.#rn=e,this.#cn(),this.#hn(),this.#un(),this.#mn(),this.#Bi=new be(this)}constructor(t,e){Object.freeze(this),ye.#in?ye.#in.onCancel():(this.#ki=t.clientX||t.originalEvent.clientX||0,this.#Fi=t.clientY||t.originalEvent.clientY||0,this.#en=[t.latlng?t.latlng.lat:a.defaultValue,t.latlng?t.latlng.lng:a.defaultValue],this.#on=t.target?.objId??(Number.parseInt(t?.currentTarget?.dataset?.tanObjId)||g),this.#sn=Boolean(e),ye.#in=this)}onOk(t){this.#Bi.destructor(),ye.#in=null,this.#nn(t)}onCancel(){this.#Bi.destructor(),ye.#in=null,this.#rn()}show(){ye.#in&&new Promise(((t,e)=>{this.#pn(t,e)})).then((t=>this.menuItems[t].action())).catch((t=>{t&&console.error(t)}))}get menuItems(){return[]}get contextMenuHTMLElement(){return this.#an}get cancelButton(){return this.#Ee}get menuItemHTMLElements(){return this.#ln}get clientX(){return this.#ki}get clientY(){return this.#Fi}get latLng(){return this.#en}get targetObjId(){return this.#on}get haveParentNode(){return this.#sn}}class we{#gn;#vn;#Tn;constructor(t,e,o){Object.freeze(this),this.#gn=t,this.#vn=e,this.#Tn=o}get itemText(){return this.#gn}get isActive(){return this.#vn}get action(){return this.#Tn}}class fe{#V;#Ln;#En;#Et;#bn;constructor(t){this.#V="string"==typeof t?.name?O.sanitizeToJsString(t.name):"?",this.#Ln="string"==typeof t.icon?O.sanitizeToHtmlString(t?.icon).htmlString:"?",this.#En="string"==typeof t?.tooltip?O.sanitizeToHtmlString(t.tooltip).htmlString:"?",this.#Et="number"==typeof t?.width?t.width:n.width,this.#bn="number"==typeof t?.height?t.height:n.height}get name(){return this.#V}get icon(){return this.#Ln}get tooltip(){return this.#En}get width(){return this.#Et}get height(){return this.#bn}}class Me{#re;#yn;#wn;constructor(t){if(Object.freeze(this),"string"!=typeof t?.title||"string"!=typeof t?.htmlBefore||t.htmlAfter&&"string"!=typeof t.htmlAfter)throw new Error("Invalid toolbar button");let e=(t.htmlBefore||"")+(t.htmlAfter||""),o=O.sanitizeToHtmlString(e).errorsString;if(""!==o)throw new Error("Invalid toolbar button : "+e+o);this.#re=O.sanitizeToHtmlString(t.title).htmlString,""===this.title&&(this.title="?"),this.#yn=t.htmlBefore||"",this.#wn=t.htmlAfter||""}get title(){return this.#re}get htmlBefore(){return this.#yn}get htmlAfter(){return this.#wn}}const Ie=new class{#fn;#Mn;#In;constructor(){Object.freeze(this),this.#fn=[],this.#Mn=new Map,this.#In=[]}get editionButtonsData(){return this.#fn}get preDefinedIconsData(){return this.#In}preDefinedIconDataAt(t){return this.#In[t]}preDefinedIconDataFromName(t){const e=this.#Mn.get(t);return e?e.icon:""}loadJson(t){if(t.editionButtons&&t.editionButtons.forEach((t=>{try{let e=new Me(t);this.#fn.push(e)}catch(t){console.error(t.message)}})),t.preDefinedIconsList){t.preDefinedIconsList.forEach((t=>{const e=new fe(t);this.#Mn.set(e.name,e)})),this.#In.length=0;for(const t of this.#Mn)this.#In.push(t[1]);this.#In=this.#In.sort(((t,e)=>t.name.localeCompare(e.name)))}}};class Ne{#Nn;#Cn;#Dn;#xn;#On(){this.#Cn=W.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.#Nn),Ie.preDefinedIconsData.forEach((t=>{this.#Cn.add(W.create("option",{text:t.name}))})),this.#Cn.selectedIndex=T}#Fo(){this.#Dn=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("NoteDialogToolbar - Open a configuration file"),textContent:"📂"},this.#Nn)}#jn(){Ie.editionButtonsData.forEach((t=>{const e=W.create("div",{dataset:{HtmlBefore:t.htmlBefore,HtmlAfter:t.htmlAfter},className:"TravelNotes-NoteDialog-EditorButton"},this.#Nn);O.sanitizeToHtmlElement(t.title,e),this.#xn.push(e)}))}#Sn(){this.#On(),this.#Fo(),this.#jn()}#Hn(t){this.#Cn.addEventListener("change",t.iconSelectorChange),this.#xn.forEach((e=>{e.addEventListener("click",t.editionButtonsClick)})),this.#Dn.addEventListener("click",t.openCfgFileButtonClick,!1)}#Pn(t){this.#Cn.removeEventListener("change",t.iconSelectorChange),this.#xn.forEach((e=>{e.removeEventListener("click",t.editionButtonsClick)})),this.#Dn.removeEventListener("click",t.openCfgFileButtonClick,!1)}constructor(t){Object.freeze(this),this.#xn=[],this.#Nn=W.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.#Sn(),this.#Hn(t)}destructor(t){this.#Pn(t)}update(t){this.#Pn(t),this.#Nn.textContent="",this.#xn=[],this.#Sn(),this.#Hn(t)}get rootHTMLElement(){return this.#Nn}}class Ce{#en;#hs;constructor(t,e){Object.freeze(this),this.#en=t,this.#hs=e}get latLng(){return this.#en}get route(){return this.#hs}}class De extends gt{#Rn;constructor(t,e){super(),W.create("div",{textContent:t?.headerText||"",className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement),this.#Rn=W.create("textarea",{className:"TravelNotes-TextAreaControl-TextArea",placeholder:t?.placeholder||"",rows:t.rows||2,dataset:{Name:t?.datasetName||"TextAreaControl"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),e.controlFocus&&this.#Rn.addEventListener("focus",e.controlFocus),e.controlInput&&this.#Rn.addEventListener("input",e.controlInput)}destructor(t){t.controlFocus&&this.#Rn.removeEventListener("focus",t.controlFocus),t.controlInput&&this.#Rn.removeEventListener("input",t.controlInput)}get value(){return this.#Rn.value}set value(t){this.#Rn.value=t}}class xe extends gt{#An;#Bn;constructor(t){super();const e=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#Bn=W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("AddressControl - Reset address"),textContent:"🔄"},e),W.create("text",{value:j.getText("AddressControl - Address")},e),this.#An=W.create("input",{type:"text",className:"TravelNotes-AdressControl-InputText",dataset:{Name:"address"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),t.controlFocus&&this.#An.addEventListener("focus",t.controlFocus),t.controlInput&&this.#An.addEventListener("input",t.controlInput),t.addressButtonClick&&this.#Bn.addEventListener("click",t.addressButtonClick)}destructor(t){t.controlFocus&&this.#An.removeEventListener("focus",t.controlFocus),t.controlInput&&this.#An.removeEventListener("input",t.controlInput),t.addressButtonClick&&this.#Bn.removeEventListener("click",t.addressButtonClick)}get address(){return this.#An.value}set address(t){this.#An.value=t}}class Oe{searchPlaces=!0;searchWays=!0;searchRelations=!0;setGeometry=!0;constructor(){Object.seal(this)}}class je{#Ne;#kn;#Fn;#_n;#zn;#Kn;#Un;#en;#Vn;#Wn;#Xn;#Yn(){this.#Fn.forEach((t=>{t.geometry=[[]],t.lat=a.defaultValue,t.lon=a.defaultValue;let e=0;t.nodes.forEach((o=>{const s=this.#kn.get(o);t.geometry[0].push([s.lat,s.lon]),t.lat+=s.lat,t.lon+=s.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.#_n.forEach((t=>{t.geometry=[[]],t.lat=a.defaultValue,t.lon=a.defaultValue;let e=0;t.members.forEach((o=>{if("way"===o.type){const s=this.#Fn.get(o.ref);t.geometry.push(s.geometry[0]),t.lat+=s.lat,t.lon+=s.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}#Gn(e){e.forEach((e=>{switch(e.type){case"node":if(this.#kn.set(e.id,e),e?.tags?.place&&this.#Ne.searchPlaces&&this.#Un[e.tags.place]&&e?.tags?.name){const t=At.pointsDistance(this.#en,[e.lat,e.lon]),o=this.#Un[e.tags.place];o.maxDistance>t&&o.distance>t&&(o.distance=t,o.name=e.tags.name)}break;case"way":this.#Ne.searchWays&&this.#Fn.set(e.id,e);break;case"relation":this.#Ne.searchRelations&&this.#_n.set(e.id,e);break;case"area":if(this.#Ne.searchPlaces){let o=e.tags.name;"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(o=e.tags["name:"+t.nominatim.language]),this.#zn[Number.parseInt(e.tags.admin_level)]=o,"2"===e.tags.admin_level&&(this.#Kn=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.#Kn)}}})),this.#Ne.setGeometry&&this.#Yn(),this.#Ne.searchPlaces&&this.#Zn()}#Zn(){let t=null;for(let e=2;e<this.#zn.length;e++)void 0!==this.#zn[e]&&(this.#Kn>=e?this.#Wn=this.#zn[e]:t=this.#zn[e]);let e=Number.MAX_VALUE;Object.values(this.#Un).forEach((t=>{t.distance<e&&(e=t.distance,this.#Vn=t.name)})),this.#Vn=t||this.#Vn,this.#Vn===this.#Wn&&(this.#Vn=null)}async#Jn(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&p===t[e].value.status&&t[e].value.ok){const o=await t[e].value.json();this.#Gn(o.elements)}else this.#Xn=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(Object.freeze(this),this.#Ne=new Oe,t)for(const[e,o]of Object.entries(t))this.#Ne[e]&&(this.#Ne[e]=o);this.#kn=new Map,this.#Fn=new Map,this.#_n=new Map}async loadData(e,o){this.#en=o,this.#Xn=!0,this.#zn=[],this.#Kn=t.geoCoder.osmCityAdminLevel.DEFAULT,this.#Un=Object.freeze({hamlet:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet}),village:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village}),city:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city}),town:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town})}),this.#Vn=null,this.#Wn=null,this.#kn.clear(),this.#Fn.clear(),this.#_n.clear();const s=[];e.forEach((e=>{s.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(s).then((t=>this.#Jn(t)))}get nodes(){return this.#kn}get ways(){return this.#Fn}get relations(){return this.#_n}get place(){return this.#Vn}get city(){return this.#Wn}get country(){return this.#zn[2]}get statusOk(){return this.#Xn}}class Se{#qn=!1;#V="";#$n="";#Wn="";#Qn="";#tr(t,e){t.error||e.error?this.#qn=!1:(this.#V=e.namedetails.name,e.address.house_number&&(this.#$n=e.address.house_number+" "),e.address.road?this.#$n+=e.address.road+" ":e.address.pedestrian&&(this.#$n+=e.address.pedestrian+" "),this.#Wn=t.address.city||t.address.town||t.address.municipality||t.address.village||"",this.#Qn=e.address.country,this.#qn=!0)}constructor(){Object.freeze(this)}async loadData(e){this.#qn=!1;const o=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1];let s=o+"&zoom=10&addressdetails=1&namedetails=0",i=o+"&zoom=18&addressdetails=1&namedetails=1";const n=t.nominatim.language;n&&"*"!==n&&(s+="&accept-language="+n,i+="&accept-language="+n);const r=new Headers;n&&"*"===n&&r.append("accept-language","");const a=await fetch(s,{headers:r}),l=await fetch(i,{headers:r});p===a.status&&a.ok&&p===l.status&&l.ok?this.#tr(await a.json(),await l.json()):this.#qn=!1}get name(){return this.#qn?this.#V:null}get street(){return this.#qn?this.#$n:null}get city(){return this.#qn?this.#Wn:null}get country(){return this.#qn?this.#Qn:null}}class He{#V;#$n;#Wn;constructor(t,e,o){Object.freeze(this),this.#V=O.sanitizeToJsString(t),this.#$n=O.sanitizeToJsString(e),this.#Wn=O.sanitizeToJsString(o)}get name(){return this.#V}get street(){return this.#$n}get city(){return this.#Wn}}class Pe{static get#er(){return Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town)}#en;#or;#sr;#ir(){let t=this.#sr.city||this.#sr.country||"";const e=this.#or.place;e&&e!==t&&(t+=" ("+e+")");let o=(this.#sr.street||"").replaceAll(";"," "),s=this.#sr.name||"";return(o.includes(s)||t.includes(s))&&(s=""),new He(s,o,t)}#nr(){return["node(around:"+Pe.#er+","+this.#en[0]+","+this.#en[1]+")[place];out;"]}async#rr(){return await this.#or.loadData(this.#nr(),this.#en),await this.#sr.loadData(this.#en),this.#ir()}async#ar(t,e){t(await this.#rr())}constructor(){Object.freeze(this),this.#or=new je({searchWays:!1,searchRelations:!1,setGeometry:!0}),this.#sr=new Se({searchPlaces:!0,searchWays:!1,searchRelations:!1,setGeometry:!1})}async getAddressAsync(t){return this.#en=t,this.#rr()}getAddressWithPromise(t){return this.#en=t,new Promise(((t,e)=>this.#ar(t,e)))}}class Re{#lr;#dr(t){this.#lr.hideWait();let e=t.street;""!==t.city&&(e+=" "+t.city),this.#lr.setControlsValues({address:e,name:t.name}),this.#lr.updatePreview&&this.#lr.updatePreview({address:e})}constructor(t){Object.freeze(this),this.#lr=t}setAddressWithGeoCoder(t){this.#lr.showWait(),this.#lr.hideError(),(new Pe).getAddressWithPromise(t).then((t=>{this.#dr(t)})).catch((t=>{t&&console.error(t),this.#lr.hideWait(),this.#lr.showError(j.getText("NoteDialogGeoCoderHelper - an error occurs when searching the adress"))}))}}class Ae extends gt{#cr=null;#hr=null;constructor(t){super(),W.create("text",{value:j.getText("NoteDialogIconDimsControl - Icon width")},this.controlHTMLElement),this.#cr=W.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:n.width,dataset:{Name:"iconWidth"}},this.controlHTMLElement),W.create("text",{value:j.getText("NoteDialogIconDimsControl - Icon height")},this.controlHTMLElement),this.#hr=W.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:n.height,dataset:{Name:"iconHeight"}},this.controlHTMLElement),this.#cr.addEventListener("input",t.controlInput),this.#hr.addEventListener("input",t.controlInput)}destructor(t){this.#cr.removeEventListener("input",t.controlInput),this.#hr.removeEventListener("input",t.controlInput)}get iconWidth(){return Number.parseInt(this.#cr.value)}set iconWidth(t){this.#cr.value=t}get iconHeight(){return Number.parseInt(this.#hr.value)}set iconHeight(t){this.#hr.value=t}}class Be extends gt{#ur;#mr(e,o){t.noteDialog.theDevil.addButton&&W.create("text",{value:"👿"},W.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(a.fixed)+","+e[1].toFixed(a.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},W.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},o)))}constructor(t,e){super();const o=W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement);this.#mr(e,o),W.create("text",{value:j.getText("NoteDialogLinkControl - Link")},o),this.#ur=W.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},W.create("div",{className:"TravelNotes-BaseDialog-FlexRow"},this.controlHTMLElement)),this.#ur.addEventListener("focus",t.controlFocus),this.#ur.addEventListener("input",t.controlInput),this.#ur.addEventListener("blur",t.urlInputBlur)}destructor(t){this.#ur.removeEventListener("focus",t.controlFocus),this.#ur.removeEventListener("input",t.controlInput),this.#ur.removeEventListener("blur",t.urlInputBlur)}get url(){return this.#ur.value}set url(t){this.#ur.value=t}}class ke{static get#pr(){return 40}static get#gr(){return 40}constructor(){Object.freeze(this)}getNoteTextAndIconHTML(e,o){const s=W.create("div",{dataset:{ObjId:o.note.objId}}),i=W.create("div",{className:e+(o.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},s);let r=1;O.sanitizeToHtmlElement(o.note.iconContent,i),"TravelNotes-Roadbook-"===e&&i.firstChild&&("svg"===i.firstChild.tagName?(i.firstChild.setAttributeNS(null,"viewBox","0 0 "+n.svgViewboxDim+" "+n.svgViewboxDim),r=t.note.svgIcon.roadbookFactor):i?.firstChild?.classList?.contains("TravelNotes-MapNoteCategory-0073")&&(r=t.note.svgIcon.roadbookFactor)),i.dataset.tanWidth=String(o.note.iconWidth*r)+"px",i.dataset.tanHeight=String(o.note.iconHeight*r)+"px",i.style.width=String(o.note.iconWidth*r)+"px",i.style.height=String(o.note.iconHeight*r)+"px";const a=this.getNoteTextHTML(e,o);return a.className=e+(o.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),s.appendChild(a),s}getNoteTextHTML(t,e){const o=e.note,s=W.create("div");if(0!==o.tooltipContent.length&&O.sanitizeToHtmlElement(o.tooltipContent,W.create("div",{className:t+"NoteHtml-TooltipContent"},s)),0!==o.popupContent.length&&O.sanitizeToHtmlElement(o.popupContent,W.create("div",{className:t+"NoteHtml-PopupContent"},s)),0!==o.address.length&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Address")+"</span> : "+o.address,W.create("div",{className:t+"NoteHtml-Address"},s)),0!==o.url.length&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+o.url+' target="_blank" >'+o.url.substring(0,ke.#pr)+"...</a>",W.create("div",{className:t+"NoteHtml-Url"},s)),0!==o.phone.length){let e=o.phone;if(o.phone.match(/^\+[0-9, ,*,\u0023]*$/)){const t=o.phone.replaceAll(/\u0020/g,""),s=o.phone.replaceAll(/\u0020/g," ");e=j.getText("NoteHTMLViewsFactory - Phone")+" : "+j.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+s+"</a>"+j.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+s+"</a>"}else e=j.getText("NoteHTMLViewsFactory - Phone")+" : "+o.phone;O.sanitizeToHtmlElement(e,W.create("div",{className:t+"NoteHtml-Phone"},s))}if(O.sanitizeToHtmlElement(S.formatLatLng(o.latLng),W.create("div",{className:t+"NoteHtml-LatLng"},s)),e.route){e.route.chain&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+S.formatDistance(o.chainedDistance+o.distance),W.create("div",{className:t+"NoteHtml-TravelDistance"},s)),O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+S.formatDistance(o.distance),W.create("div",{className:t+"NoteHtml-RouteDistance"},s));const i=e.route.notes.next(o.objId);if(i){const e=i.distance-o.distance;ke.#gr<e&&O.sanitizeToHtmlElement("<span>"+j.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+S.formatDistance(e),W.create("div",{className:t+"NoteHtml-NextDistance"},s))}}return s}getTravelNotesHTML(t){const e=W.create("div",{className:t+"Travel-Notes"}),o=U.travel.notes.iterator;for(;!o.done;){const s=this.getNoteTextAndIconHTML(t,{note:o.value,route:null});s.className=t+"Travel-Notes-Row",e.appendChild(s)}return e}}const Fe=new ke;class _e{#vr;#Tr;constructor(t){Object.freeze(this),this.#Tr=t,this.#vr=W.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.#vr.appendChild(Fe.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",new Bt(this.#Tr,null)))}update(){this.#vr.textContent="",this.#vr.appendChild(Fe.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this.#Tr,route:null}))}get HTMLElements(){return[this.#vr]}}class ze{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){t.stopPropagation(),"url"===t.target.dataset.tanName?this.#Lr.focusControl=null:this.#Lr.focusControl=t.target}}class Ke{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){t.stopPropagation();const e={};"iconWidth"===t.target.dataset.tanName||"iconHeight"===t.target.dataset.tanName?e[t.target.dataset.tanName]=Number.parseInt(t.target.value):e[t.target.dataset.tanName]=t.target.value,this.#Lr.updatePreview(e)}}class Ue{#lr;#en;constructor(t,e){Object.freeze(this),this.#lr=t,this.#en=e}handleEvent(t){t.stopPropagation(),new Re(this.#lr).setAddressWithGeoCoder(this.#en)}}class Ve{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return void this.#Lr.hideError();""===O.sanitizeToUrl(t.target.value).errorsString?this.#Lr.hideError():this.#Lr.showError(j.getText("UrlInputBlurEL - invalidUrl"))}}class We{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){if(!this.#Lr.focusControl)return;const e=t.currentTarget;let o=this.#Lr.focusControl.selectionStart,s=this.#Lr.focusControl.selectionEnd;this.#Lr.focusControl.value=this.#Lr.focusControl.value.slice(0,o)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.#Lr.focusControl.value.slice(o,s))+e.dataset.tanHtmlAfter+this.#Lr.focusControl.value.slice(s),o===s||0===e.dataset.tanHtmlAfter.length?(o+=e.dataset.tanHtmlBefore.length,s=o):s+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.#Lr.focusControl.setSelectionRange(o,s),this.#Lr.focusControl.focus();const i={};i[this.#Lr.focusControl.dataset.tanName]=this.#Lr.focusControl.value,this.#Lr.updatePreview(i)}}class Xe{#Er;#or;#br;#yr(){this.#br=document.createElementNS(L,"svg"),this.#br.setAttributeNS(null,"viewBox",String(n.svgViewboxDim/4)+" "+n.svgViewboxDim/4+" "+n.svgViewboxDim/2+" "+n.svgViewboxDim/2),this.#br.setAttributeNS(null,"class","TravelNotes-SvgIcon")}#wr(){let e=-1,o=T,s=T;const i=[];if(this.#Er.route.itinerary.itineraryPoints.forEach((r=>{e++;const a=ot.addPoints(ot.project(r.latLng,t.note.svgIcon.zoom),this.#Er.translation);i.push(a);a[0]>=0&&a[1]>=0&&a[0]<=n.svgViewboxDim&&a[1]<=n.svgViewboxDim&&(T===o&&(o=e),s=e)})),T!==o&&T!==s){0<o&&o--,this.#Er.route.itinerary.itineraryPoints.length-1>s&&s++;let t="";for(e=o;e<=s;e++)t+=i[e][0].toFixed(0)+","+i[e][1].toFixed(0)+" ";const r=document.createElementNS(L,"polyline");r.setAttributeNS(null,"points",t),r.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),r.setAttributeNS(null,"transform","rotate("+this.#Er.rotation+","+n.svgViewboxDim/2+","+n.svgViewboxDim/2+")"),this.#br.appendChild(r)}}#fr(){this.#or.ways.forEach((e=>{let o=T,s=T,i=-1;const r=[];if(e.nodes.forEach((e=>{i++;const a=this.#or.nodes.get(e),l=ot.addPoints(ot.project([a.lat,a.lon],t.note.svgIcon.zoom),this.#Er.translation);r.push(l);l[0]>=0&&l[1]>=0&&l[0]<=n.svgViewboxDim&&l[1]<=n.svgViewboxDim&&(T===o&&(o=i),s=i)})),T!==o&&T!==s){0<o&&o--,e.nodes.length-1>s&&s++;let t="";for(i=o;i<=s;i++)t+=r[i][0].toFixed(0)+","+r[i][1].toFixed(0)+" ";const a=document.createElementNS(L,"polyline");a.setAttributeNS(null,"points",t),a.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),a.setAttributeNS(null,"transform","rotate("+this.#Er.rotation+","+n.svgViewboxDim/2+","+n.svgViewboxDim/2+")"),this.#br.appendChild(a)}}))}#Mr(){if(""===this.#Er.rcnRef)return;const t=document.createElementNS(L,"text");t.textContent=this.#Er.rcnRef,t.setAttributeNS(null,"x",String(n.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(n.svgViewboxDim/2)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.#br.appendChild(t)}constructor(){Object.freeze(this)}buildSvg(t,e,o){this.#Er=t,this.#or=o,this.#yr(),this.#wr(),this.#fr(),this.#Mr(),e.iconContent=this.#br.outerHTML}}class Ye{isMini;isEntry;isExit;constructor(){Object.seal(this),this.isMini=!1,this.isEntry=!1,this.isExit=!1}}class Ge{#Er;#Ir;#or;#Nr;#Cr;#Dr;#xr;#Or;#jr;#Sr;#Hr;#Pr(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}#Rr(t){const e=5e-6;let o=!1;return this.#Er.route.wayPoints.forEach((s=>{Math.abs(t.lat-s.lat)<e&&Math.abs(t.lng-s.lng)<e&&(o=!0)})),!o&&(this.#Ir.latLng[0]!==t.lat||this.#Ir.latLng[1]!==t.lng)}#Ar(){const e=this.#Er.route.itinerary.itineraryPoints.previous(this.#Er.nearestItineraryPointObjId,(t=>this.#Rr(t))),s=this.#Er.route.itinerary.itineraryPoints.next(this.#Er.nearestItineraryPointObjId,(t=>this.#Rr(t)));let i=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MAX_VALUE,a=Number.MAX_VALUE,l=o.defaultValue;this.#or.nodes.forEach((o=>{l=At.pointsDistance([o.lat,o.lon],this.#Ir.latLng),"bike"===this.#Er.route.itinerary.transitMode&&o?.tags?.rcn_ref&&o.tags["network:type"]&&"node_network"===o.tags["network:type"]&&l<t.note.svgIcon.rcnRefDistance&&l<n&&(this.#Nr=o,n=l),l<i&&(this.#Dr=o.id,i=l),e&&(l=At.pointsDistance([o.lat,o.lon],e.latLng),l<r&&(this.#xr=o.id,r=l)),s&&(l=At.pointsDistance([o.lat,o.lon],s.latLng),l<a&&(this.#Or=o.id,a=l))})),this.#Cr=this.#or.nodes.get(this.#Dr)}#Br(){this.#Hr.isMini="mini_roundabout"===this?.#Cr?.tags?.highway}#kr(){this.#Nr&&(this.#Er.rcnRef=this.#Nr.tags.rcn_ref,this.#Ir.tooltipContent+=j.getText("StreetFinder - rcnRef",{rcnRef:this.#Er.rcnRef}))}#Fr(){this.#or.ways.forEach((t=>{if(!t.nodes.includes(this.#Dr))return;const e=this.#Pr(t),o=""!==e,s=t.nodes.includes(this.#xr),i=t.nodes.includes(this.#Or);let n=2*t.nodes.filter((t=>t===this.#Dr)).length;if(t.nodes[0]===this.#Dr&&n--,t.nodes[t.nodes.length-1]===this.#Dr&&n--,s&&(this.#jr=o?e:"???",n--,"roundabout"===t?.tags?.junction&&(this.#Hr.isExit=!0)),0!==n&&(i&&(this.#Sr=o?e:"???",n--,"roundabout"===t?.tags?.junction&&(this.#Hr.isEntry=!0)),0!==n&&o))for(;0!==n;)this.#Ir.address=""===this.#Ir.address?e:this.#Ir.address+" ⪥  "+e,n--}))}#_r(){""!==this.#or.city&&(this.#Ir.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.#or.city+"</span>"),this.#or.place&&this.#or.place!==this.#or.city&&(this.#Ir.address+=" ("+this.#or.place+")")}#zr(){r.atStart===this.#Er.positionOnRoute?(this.#Ir.address="🟢 "+this.#Sr,this.#_r()):r.atEnd===this.#Er.positionOnRoute?(this.#_r(),this.#Ir.address=this.#jr,this.#_r(),this.#Ir.address+=" 🔴 "):(this.#Ir.address=this.#jr+(""===this.#Ir.address?"":" ⪥  "+this.#Ir.address)+" "+this.#Er.directionArrow+" "+this.#Sr,this.#_r())}#Kr(){this.#Hr.isEntry&&!this.#Hr.isExit?this.#Ir.tooltipContent+=j.getText("StreetFinder - entry roundabout"):!this.#Hr.isEntry&&this.#Hr.isExit?this.#Ir.tooltipContent+=j.getText("StreetFinder - exit roundabout"):this.#Hr.isEntry&&this.#Hr.isExit&&(this.#Ir.tooltipContent+=j.getText("StreetFinder - continue roundabout")),this.#Hr.isMini&&(this.#Ir.tooltipContent+=j.getText("StreetFinder - at the small roundabout on the ground"))}constructor(){Object.freeze(this)}findData(t,e,o){this.#Er=t,this.#Ir=e,this.#or=o,this.#Dr=T,this.#xr=T,this.#Or=T,this.#jr="",this.#Sr="",this.#Hr=new Ye,this.#Ar(),this.#Br(),this.#kr(),this.#Fr(),this.#zr(),this.#Kr()}}class Ze{constructor(){Object.freeze(this)}findData(e,o){null!==e.direction&&(e.direction<t.note.svgIcon.angleDirection.right?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂"):e.direction<t.note.svgIcon.angleDirection.slightRight?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn slight right"),e.directionArrow="🢅"):e.direction<t.note.svgIcon.angleDirection.continue?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Continue"),e.directionArrow="🢁"):e.direction<t.note.svgIcon.angleDirection.slightLeft?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn slight left"),e.directionArrow="🢄"):e.direction<t.note.svgIcon.angleDirection.left?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn left"),e.directionArrow="🢀"):e.direction<t.note.svgIcon.angleDirection.sharpLeft?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn sharp left"),e.directionArrow="🢇"):e.direction<t.note.svgIcon.angleDirection.sharpRight?(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn sharp right"),e.directionArrow="🢆"):(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂")),r.atStart===e.positionOnRoute?o.tooltipContent=j.getText("ArrowAndTooltipFinder - Start"):r.atEnd===e.positionOnRoute&&(o.tooltipContent=j.getText("ArrowAndTooltipFinder - Stop"))}}class Je{#Er;#Ir;#Ur;#Vr;#Wr;#Xr(){this.#Er.translation=ot.subtrackPoints([n.svgViewboxDim/2,n.svgViewboxDim/2],ot.project(this.#Ir.latLng,t.note.svgIcon.zoom))}#Yr(){this.#Ur=this.#Er.route.itinerary.itineraryPoints.previous(this.#Er.nearestItineraryPointObjId,(e=>At.pointsDistance(e.latLng,this.#Ir.latLng)>t.note.svgIcon.angleDistance))||this.#Er.route.itinerary.itineraryPoints.first}#Gr(){this.#Vr=this.#Er.route.itinerary.itineraryPoints.next(this.#Er.nearestItineraryPointObjId,(e=>At.pointsDistance(e.latLng,this.#Ir.latLng)>t.note.svgIcon.angleDistance))||this.#Er.route.itinerary.itineraryPoints.last}#Zr(){this.#Wr=ot.addPoints(ot.project(this.#Ir.latLng,t.note.svgIcon.zoom),this.#Er.translation)}#Jr(){if(this.#Er.nearestItineraryPointObjId!==this.#Er.route.itinerary.itineraryPoints.first.objId){const o=ot.addPoints(ot.project(this.#Ur.latLng,t.note.svgIcon.zoom),this.#Er.translation);this.#Er.rotation=Math.atan((this.#Wr[1]-o[1])/(o[0]-this.#Wr[0]))*e.d180/Math.PI,0>this.#Er.rotation&&(this.#Er.rotation+=e.d360),this.#Er.rotation-=e.d270,0>o[0]-this.#Wr[0]&&(this.#Er.rotation+=e.d180)}}#qr(){if(this.#Er.nearestItineraryPointObjId!==this.#Er.route.itinerary.itineraryPoints.last.objId){const o=ot.addPoints(ot.project(this.#Vr.latLng,t.note.svgIcon.zoom),this.#Er.translation);for(this.#Er.direction=Math.atan((this.#Wr[1]-o[1])/(o[0]-this.#Wr[0]))*e.d180/Math.PI,0>o[0]-this.#Wr[0]&&(this.#Er.direction+=e.d180),this.#Er.direction-=this.#Er.rotation;e.d0>this.#Er.direction;)this.#Er.direction+=e.d360;for(;e.d360<this.#Er.direction;)this.#Er.direction-=e.d360}}#$r(){this.#Er.nearestItineraryPointObjId===this.#Er.route.itinerary.itineraryPoints.first.objId&&(this.#Er.rotation=-this.#Er.direction-e.d90,this.#Er.direction=null,this.#Er.positionOnRoute=r.atStart),this.#Ir.latLng[0]===this.#Er.route.itinerary.itineraryPoints.last.lat&&this.#Ir.latLng[1]===this.#Er.route.itinerary.itineraryPoints.last.lng&&(this.#Er.direction=null,this.#Er.positionOnRoute=r.atEnd)}constructor(){Object.freeze(this)}findData(t,e){this.#Er=t,this.#Ir=e,this.#Xr(),this.#Yr(),this.#Gr(),this.#Zr(),this.#Jr(),this.#qr(),this.#$r()}}class qe{constructor(){Object.seal(this)}iconContent="";tooltipContent="";address="";latLng=[a.defaultValue,a.defaultValue]}class $e{constructor(){Object.seal(this)}nearestItineraryPointObjId=g;route=null;positionOnRoute=r.onRoute;direction=null;directionArrow=" ";rcnRef="";rotation=0;translation=[0,0]}class Qe{#Ir;#Er;#or;#er;#Qr;static get#ta(){return 1.5}#ea(){let t=null,e=Number.MAX_VALUE;this.#Er.route.itinerary.itineraryPoints.forEach((o=>{const s=At.pointsDistance(this.#Ir.latLng,o.latLng);e>s&&(e=s,t=o)})),this.#Ir.latLng=t.latLng,this.#Er.nearestItineraryPointObjId=t.objId}#oa(){return(new Je).findData(this.#Er,this.#Ir),(new Ze).findData(this.#Er,this.#Ir),(new Ge).findData(this.#Er,this.#Ir,this.#or),(new Xe).buildSvg(this.#Er,this.#Ir,this.#or),this.#Qr=!1,this.#Ir}async#sa(){if(this.#Qr)return null;this.#Qr=!0,this.#Er.nearestItineraryPointObjId=g,this.#Er.positionOnRoute=r.onRoute,this.#Er.direction=null,this.#Er.directionArrow=" ",this.#Er.translation=[0,0],this.#Er.rotation=0,this.#Er.rcnRef="",this.#Ir.iconContent="",this.#Ir.tooltipContent="",this.#Ir.address="",this.#ea();const t=this.#Ir.latLng[0].toFixed(a.fixed)+","+this.#Ir.latLng[1].toFixed(a.fixed),e=["way[highway](around:"+(n.svgViewboxDim*Qe.#ta).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.#er+","+t+")[place];out;"];return await this.#or.loadData(e,this.#Ir.latLng),this.#or.statusOk?this.#oa():null}async#ia(t,e){const o=await this.#sa();o?t(o):e("An error occurs...")}constructor(){Object.freeze(this),this.#Ir=new qe,this.#Er=new $e,this.#or=new je({searchRelations:!1,setGeometry:!1}),this.#er=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town),this.#Qr=!1}async getIconAndAdressAsync(t,e){return this.#Ir.latLng=t,this.#Er.route=e,this.#sa()}getIconAndAdressWithPromise(t){return this.#Ir.latLng=t.latLng,this.#Er.route=t.route,new Promise(((t,e)=>this.#ia(t,e)))}}class to{#Lr;#na(t){this.#Lr.setControlsValues(t),this.#Lr.updatePreview(t)}#ra(){const t=this.#Lr.mapIconData;t.route?(this.#Lr.showWait(),(new Qe).getIconAndAdressWithPromise(t).then((t=>{this.#Lr.hideWait(),this.#na(t)})).catch((t=>{t instanceof Error&&console.error(t),this.#Lr.hideWait(),this.#Lr.showError(j.getText("IconSelectorChangeEL - an error occurs when creating the SVG icon"))}))):this.#Lr.showError(j.getText("IconSelectorChangeEL - not possible to create a SVG icon for a travel note"))}constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){t.stopPropagation();const e=Ie.preDefinedIconDataAt(t.target.selectedIndex);"SvgIcon"!==e.icon?this.#na({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.#ra()}}class eo{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{Ie.loadJson(JSON.parse(e.result)),this.#Lr.updateToolbar()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class oo{#Lr;constructor(t){Object.freeze(this),this.#Lr=t}handleEvent(t){t.stopPropagation(),S.openFile(new eo(this.#Lr),".json")}}class so{#aa;#la;#da;#ca;#ha;#ua;#ma;constructor(t,e){Object.freeze(this),this.#aa=new ze(t),this.#la=new Ke(t),this.#da=new Ue(t,e),this.#ca=new Ve(t),this.#ha=new We(t),this.#ua=new to(t),this.#ma=new oo(t)}destructor(){this.#aa=null,this.#la=null,this.#da=null,this.#ca=null,this.#ha=null,this.#ua=null,this.#ma=null}get controlFocus(){return this.#aa}get controlInput(){return this.#la}get addressButtonClick(){return this.#da}get urlInputBlur(){return this.#ca}get editionButtonsClick(){return this.#ha}get iconSelectorChange(){return this.#ua}get openCfgFileButtonClick(){return this.#ma}}class io extends ut{#cs;#hs;#Tr;#pa;#ga;#va;#Ta;#La;#Ea;#ba;#ya;#Qo;#wa;#fa;#Se(){this.#Qo.destructor(this.#fa),this.#pa.destructor(this.#fa),this.#ga.destructor(this.#fa),this.#va.destructor(this.#fa),this.#Ta.destructor(this.#fa),this.#La.destructor(this.#fa),this.#Ea.destructor(this.#fa),this.#ba.destructor(this.#fa),this.#fa.destructor()}constructor(t,e){super(),this.#wa=null,this.#cs=t,this.#hs=e,this.#Tr=new F,this.#Tr.jsonObject=t.jsonObject}createContentHTML(){this.#fa=new so(this,this.#Tr.latLng),this.#Qo=new Ne(this.#fa),this.#pa=new Ae(this.#fa),this.#ga=new De({placeholder:"?????",datasetName:"iconContent",headerText:j.getText("NoteDialogIconControl - Icon content")},this.#fa),this.#va=new $t({headerText:j.getText("NoteDialogTooltipControl - Tooltip content"),datasetName:"tooltipContent"},this.#fa),this.#Ta=new De({rows:t.noteDialog.areaHeight.popupContent,datasetName:"popupContent",headerText:j.getText("NoteDialogPopupControl - Text")},this.#fa),this.#La=new xe(this.#fa),this.#Ea=new Be(this.#fa,this.#Tr.latLng),this.#ba=new $t({headerText:j.getText("NoteDialogPhoneControl - Phone"),datasetName:"phone"},this.#fa),this.#ya=new _e(this.#Tr),this.setControlsValues(this.#Tr)}get focusControl(){return this.#wa}set focusControl(t){this.#wa=t}get mapIconData(){return new Ce(this.#Tr.latLng,this.#hs)}updatePreview(t){for(const e in t)this.#Tr[e]=t[e];this.#ya.update()}show(){const t=super.show();return""===this.#cs.address&&new Re(this).setAddressWithGeoCoder(this.#Tr.latLng),t}canClose(){return""===this.#ga.value?(this.showError(j.getText("Notedialog - The icon content cannot be empty")),!1):""===this.#Ea.url||""!==O.sanitizeToUrl(this.#Ea.url).url||(this.showError(j.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this.#Se(),super.onCancel()}onOk(){super.onOk()&&(this.#cs.iconWidth=this.#pa.iconWidth,this.#cs.iconHeight=this.#pa.iconHeight,this.#cs.iconContent=this.#ga.value,this.#cs.tooltipContent=this.#va.value,this.#cs.popupContent=this.#Ta.value,this.#cs.address=this.#La.address,this.#cs.url=this.#Ea.url,this.#cs.phone=this.#ba.value,this.#cs.latLng=this.#Tr.latLng,this.#Se())}get title(){return j.getText("NoteDialog - Note")}get toolbarHTMLElement(){return this.#Qo.rootHTMLElement}get contentHTMLElements(){return[this.#pa.controlHTMLElement,this.#ga.controlHTMLElement,this.#va.controlHTMLElement,this.#Ta.controlHTMLElement,this.#La.controlHTMLElement,this.#Ea.controlHTMLElement,this.#ba.controlHTMLElement]}get footerHTMLElements(){return this.#ya.HTMLElements}setControlsValues(t){this.#pa.iconHeight=t.iconHeight||this.#pa.iconHeight,this.#pa.iconWidth=t.iconWidth||this.#pa.iconWidth,this.#ga.value=t.iconContent||this.#ga.value,this.#va.value=t.tooltipContent||this.#va.value,this.#Ta.value=t.popupContent||this.#Ta.value,this.#La.address=t.address||this.#La.address,this.#Ea.url=t.url||this.#Ea.url,this.#ba.value=t.phone||this.#ba.value}updateToolbar(){this.#Qo.update(this.#fa)}}class no{#Ma;#Ia;constructor(){Object.freeze(this)}createUI(){if(this.#Ma)return;this.#Ma=W.create("div",{className:"TravelNotes-Background"},document.body);const t=W.create("div",{id:"TravelNotes-WaitUI"},this.#Ma);this.#Ia=W.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),W.create("div",{className:"TravelNotes-WaitAnimationBullet"},W.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.#Ia.textContent=t}close(){document.body.removeChild(this.#Ma),this.#Ma=null}}const ro=new class{#cs=null;#hs=null;#Na=!0;#Ca=null;#Da(){this.#Na?this.#hs?(this.#hs.notes.add(this.#cs),this.#cs.chainedDistance=this.#hs.chainedDistance,this.#hs.notes.sort(((t,e)=>t.distance-e.distance))):(U.travel.notes.add(this.#cs),Pt.dispatch("updatetravelnotes")):this.#hs||Pt.dispatch("updatetravelnotes"),Pt.dispatch("noteupdated",{removedNoteObjId:this.#cs.objId,addedNoteObjId:this.#cs.objId}),Pt.dispatch("updateroadbook")}#Lr(){new io(this.#cs,this.#hs).show().then((()=>this.#Da())).catch((t=>{console.error(t)}))}#xa(t){this.#Na=!0,this.#cs=new F,this.#cs.latLng=t,this.#cs.iconLatLng=t}async#Oa(t){if(t.tags.rcn_ref?this.#cs.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":this.#cs.iconContent=Ie.preDefinedIconDataFromName(t.description),this.#cs.url=t.tags.website||"",this.#cs.phone=t.tags.phone||"",this.#cs.tooltipContent=t.description||"",this.#cs.popupContent=t.tags.name||"",t.tags["addr:street"]&&t.tags["addr:city"])this.#cs.address=(t.tags["addr:housenumber"]?t.tags["addr:housenumber"]+" ":"")+t.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.tags["addr:city"]+"</span>";else{const e=new no;e.createUI(),e.showInfo("Creating address");let o=null;try{o=await(new Pe).getAddressAsync([t.lat,t.lon])}catch(t){console.error(t)}e.close(),this.#cs.address=o.street,""!==o.city&&(this.#cs.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+o.city+"</span>")}this.osmSearchNoteDialog||""===this.#cs.iconContent?this.#Lr():this.#Da()}constructor(){Object.freeze(this)}get osmSearchNoteDialog(){return null===this.#Ca&&(this.#Ca=t.osmSearch.showSearchNoteDialog),this.#Ca}changeOsmSearchNoteDialog(){this.#Ca=!this.osmSearchNoteDialog}newRouteNote(t,e){this.#hs=Ft.getRoute(t);const o=ot.getClosestLatLngDistance(this.#hs,e);this.#xa(o.latLng),this.#cs.distance=o.distance,this.#Lr()}newSearchRouteNote(t){const e=Ft.getNearestRouteData([t.lat,t.lon]);e.route?(this.#xa(e.latLngOnRoute),this.#cs.iconLatLng=[t.lat,t.lon],this.#cs.distance=e.distanceOnRoute,this.#hs=e.route,this.#Oa(t)):St.showError(j.getText("NoteEditor - No route was found"))}newSearchTravelNote(t){this.#hs=null,this.#xa([t.lat,t.lon]),this.#Oa(t)}newTravelNote(t){this.#hs=null,this.#xa(t),this.#Lr()}editNote(t){this.#Na=!1;const e=Ft.getNoteAndRoute(t);this.#hs=e.route,this.#cs=e.note,this.#Lr()}removeNote(t){const e=Ft.getNoteAndRoute(t);e.route?e.route.notes.remove(t):(U.travel.notes.remove(t),Pt.dispatch("updatetravelnotes")),Pt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:g}),Pt.dispatch("updateroadbook")}hideNotes(){let t=U.travel.notes.iterator;for(;!t.done;)Pt.dispatch("removeobject",{objId:t.value.objId});const e=U.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)Pt.dispatch("removeobject",{objId:t.value.objId});if(g!==U.editedRouteObjId)for(t=U.travel.editedRoute.notes.iterator;!t.done;)Pt.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();const t=U.travel.notes.iterator;for(;!t.done;)Pt.dispatch("noteupdated",{removedNoteObjId:g,addedNoteObjId:t.value.objId});const e=U.travel.routes.iterator;for(;!e.done;)e.value.hidden||Pt.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){const e=Ft.getNoteAndRoute(t).note,o=Ft.getNearestRouteData(e.latLng);o.route&&(U.travel.notes.remove(t),e.distance=o.distanceOnRoute,e.latLng=o.latLngOnRoute,e.chainedDistance=o.route.chainedDistance,o.route.notes.add(e),o.route.notes.sort(((t,e)=>t.distance-e.distance)),Pt.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),Pt.dispatch("updatetravelnotes"),Pt.dispatch("updateroadbook"))}detachNoteFromRoute(t){const e=Ft.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=o.invalid,e.note.chainedDistance=o.defaultValue,U.travel.notes.add(e.note),Pt.dispatch("updatetravelnotes"),Pt.dispatch("updateroadbook")}travelNoteDropped(t,e,o){U.travel.notes.moveTo(t,e,o),Pt.dispatch("updatetravelnotes"),Pt.dispatch("updateroadbook")}};class ao{#ja=[];#Sa(t){this.#ja.push(t.latLng),this.#ja.push(t.iconLatLng)}#Ha(t){t.itinerary.itineraryPoints.forEach((t=>this.#ja.push(t.latLng))),t.notes.forEach((t=>this.#Sa(t)))}constructor(){Object.freeze(this)}zoomToLatLng(t){Pt.dispatch("zoomto",{latLng:t})}zoomToNote(t){this.#ja=[],this.#Sa(Ft.getNoteAndRoute(t).note),Pt.dispatch("zoomto",{geometry:[this.#ja]})}zoomToRoute(t){this.#ja=[],this.#Ha(Ft.getRoute(t)),Pt.dispatch("zoomto",{geometry:[this.#ja]})}zoomToTravel(){this.#ja=[],U.travel.routes.forEach((t=>this.#Ha(t))),g!==U.travel.editedRouteObjId&&this.#Ha(U.travel.editedRoute),U.travel.notes.forEach((t=>this.#Sa(t))),Pt.dispatch("zoomto",{geometry:[this.#ja]})}zoomToPoi(t){Pt.dispatch("zoomto",t)}}class lo extends ye{constructor(t,e){super(t,e)}get menuItems(){return[new we(j.getText("ProfileContextMenu - Add a note to the route at this point"),!0,(()=>ro.newRouteNote(this.targetObjId,this.latLng))),new we(j.getText("ProfileContextMenu - Zoom to this point"),!0,(()=>(new ao).zoomToLatLng(this.latLng)))]}}class co{constructor(){Object.freeze(this)}getlatLngElevOnRouteAtMousePosition(t){const e=Ft.getRoute(Number.parseInt(t.currentTarget.dataset.tanObjId)),o=t.currentTarget.getBoundingClientRect(),s=(t.clientX-o.x-he.PROFILE_MARGIN/(2*he.PROFILE_MARGIN+he.PROFILE_WIDTH)*o.width)/(he.PROFILE_WIDTH/(2*he.PROFILE_MARGIN+he.PROFILE_WIDTH)*o.width)*e.distance;return 0<s&&s<e.distance?ot.getLatLngElevAtDist(e,s):null}}class ho extends co{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();const e=this.getlatLngElevOnRouteAtMousePosition(t);e&&(t.latlng={lat:e.latLng[0],lng:e.latLng[1]},new lo(t).show())}}class uo{constructor(){Object.freeze(this)}handleEvent(t){t.preventDefault(),t.stopPropagation(),Pt.dispatch("removeobject",{objId:Number.parseInt(t.currentTarget.dataset.tanMarkerObjId)})}}class mo extends co{#Pa;#Ra;#Aa;#Ba;#ka;#Fa;#_a;#za(t,e){const o=document.createElementNS(L,"text");return o.appendChild(document.createTextNode(t)),o.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),o.setAttributeNS(null,"x",this.#Fa),o.setAttributeNS(null,"y",e),o.setAttributeNS(null,"text-anchor",this.#ka),this.#_a.appendChild(o),o}constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.#_a=t.currentTarget;const e=this.getlatLngElevOnRouteAtMousePosition(t);if(e){const o=Number.parseInt(this.#_a.dataset.tanMarkerObjId);Pt.dispatch("removeobject",{objId:o}),Pt.dispatch("additinerarypointmarker",{objId:o,latLng:e.latLng}),this.#Pa&&this.#_a.contains(this.#Pa)?(this.#_a.removeChild(this.#Pa),this.#_a.removeChild(this.#Ra),this.#_a.removeChild(this.#Aa),this.#_a.removeChild(this.#Ba)):(this.#Pa=null,this.#Ra=null,this.#Aa=null,this.#Ba=null);const s=this.#_a.getBoundingClientRect();this.#Fa=(2*he.PROFILE_MARGIN+he.PROFILE_WIDTH)*(t.clientX-s.x)/s.width;const i=he.PROFILE_MARGIN+he.PROFILE_HEIGHT;this.#Pa=document.createElementNS(L,"polyline"),this.#Pa.setAttributeNS(null,"points",String(this.#Fa)+","+he.PROFILE_MARGIN+" "+this.#Fa+","+i),this.#Pa.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.#_a.appendChild(this.#Pa);const n=Ft.getRoute(Number.parseInt(this.#_a.dataset.tanObjId));this.#ka=e.distance>n.distance/2?"end":"start",this.#Fa+=e.distance>n.distance/2?-he.X_DELTA_TEXT:he.X_DELTA_TEXT,this.#Ra=this.#za(S.formatDistance(e.distance),he.PROFILE_MARGIN+he.Y_DELTA_TEXT),this.#Aa=this.#za("Alt. "+e.elev.toFixed(0)+" m.",he.PROFILE_MARGIN+2*he.Y_DELTA_TEXT),this.#Ba=this.#za("Pente "+e.ascent.toFixed(0)+" % ",he.PROFILE_MARGIN+3*he.Y_DELTA_TEXT)}}}class po extends ce{#gi=null;#Ka;#Ua;#Va=null;#Wa=null;#Xa=null;#Ya=b.nextObjId;#Ga;#Za(){this.#gi&&(this.#gi.removeEventListener("contextmenu",this.#Va,!1),this.#gi.removeEventListener("mousemove",this.#Wa,!1),this.#gi.removeEventListener("mouseleave",this.#Xa,!1),this.#gi=null,Pt.dispatch("removeobject",{objId:this.#Ya}),this.#Ua.textContent="")}setContent(t){this.#Ga=t.objId,this.#Za(),this.#gi=(new he).createSvg(t),this.#gi.dataset.tanObjId=t.objId,this.#gi.dataset.tanMarkerObjId=this.#Ya,this.#gi.addEventListener("contextmenu",this.#Va,!1),this.#gi.addEventListener("mousemove",this.#Wa,!1),this.#gi.addEventListener("mouseleave",this.#Xa,!1),this.#Ka.appendChild(this.#gi),this.#Ua.textContent=j.getText("ProfileWindow - Route {name} : Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{name:t.computedName,ascent:t.itinerary.ascent.toFixed(0),descent:t.itinerary.descent.toFixed(0),distance:S.formatDistance(t.distance)})}constructor(){super(),this.#Va=new ho,this.#Wa=new mo,this.#Xa=new uo,this.#Ka=W.create("div",{className:"TravelNotes-ProfileDialog-SvgContainer"}),this.#Ua=W.create("div")}createContentHTML(){}onCancel(){this.#Za(),super.onCancel(),Pt.dispatch("profileclosed",{objId:this.#Ga})}show(){super.show(),this.mover.moveDialogToTopLeft()}get contentHTMLElements(){return[this.#Ka,this.#Ua]}get title(){return j.getText("ProfileWindow - Profile")}}class go{#hs;#Ja;#qa;get#$a(){return t.route.elev.smoothPoints}#Qa(){this.#qa=[],this.#qa.push({distance:0,elev:this.#hs.itinerary.itineraryPoints.first.elev,smoothElev:this.#hs.itinerary.itineraryPoints.first.elev});const t=this.#hs.itinerary.itineraryPoints.iterator;t.done;let e=0,o=t.value.distance,s=t.value.elev;t.done;let i=this.#Ja;for(;i<this.#hs.distance;){if(o<i)for(e=o,s=t.value.elev;o<i;)o+=t.value.distance,t.done;const n=s+(i-e)*((t.value.elev-s)/(o-e));this.#qa.push({distance:i,elev:n,smoothElev:0}),i+=this.#Ja}this.#qa.push({distance:this.#hs.distance,elev:this.#hs.itinerary.itineraryPoints.last.elev,smoothElev:this.#hs.itinerary.itineraryPoints.last.elev})}#tl(){let t=(this.#qa[this.#$a-1].elev-this.#qa[0].elev)/(this.#$a-1),e=0;for(e=0;e<this.#$a;e++)this.#qa[e].smoothElev=this.#qa[0].elev+t*e;for(e=this.#$a;e<this.#qa.length-this.#$a;e++){let t=0;for(let o=e-this.#$a;o<=e+this.#$a;o++)t+=this.#qa[o].elev;this.#qa[e].smoothElev=t/(2*this.#$a+1)}e--;const o=(this.#qa[e+this.#$a].smoothElev-this.#qa[e].smoothElev)/this.#$a;let s=this.#qa[e].smoothElev,i=1;for(e++;e<this.#qa.length-1;i++,e++)this.#qa[e].smoothElev=s+o*i}#el(){const e=this.#hs.itinerary.itineraryPoints.iterator;let o=0;for(;!e.done;)o+=e.next?Math.abs(e.value.elev-e.next.elev):0;this.#Ja=Math.floor(Math.min(t.route.elev.smoothCoefficient*this.#hs.distance/o,this.#hs.distance/(3*this.#$a)))}#ol(){const t=this.#hs.itinerary.itineraryPoints.iterator;t.done;let e=t.value.distance;for(;!t.done;){const o=this.#qa[Math.floor(e/this.#Ja)],s=this.#qa[Math.ceil(e/this.#Ja)];if(o&&s){const i=e-o.distance,n=(s.elev-o.elev)/(s.distance-o.distance);t.value.elev=o.elev+i*n}e+=t.value.distance}}constructor(){Object.freeze(this)}smooth(t){this.#hs=t,this.#el(),this.#Qa(),this.#tl(),this.#ol()}}const vo=new class{#sl=new Map;constructor(){Object.freeze(this)}createProfile(e){const o=this.#sl.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new go).smooth(e);let s=0,i=0,n=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let e=t.elev-n;0>e?i-=e:s+=e,n=t.elev})),e.itinerary.ascent=s,e.itinerary.descent=i,o&&o.setContent(e)}else o&&o.onCancel()}updateProfile(t,e){const o=this.#sl.get(t);o&&(this.#sl.delete(t),e&&e.itinerary.hasProfile?(o.setContent(e),this.#sl.set(e.objId,o)):o.onCancel())}deleteProfile(t){const e=this.#sl.get(t);e&&e.onCancel()}deleteAllProfiles(){this.#sl.forEach((t=>t.onCancel()))}showProfile(t){const e=Ft.getRoute(t);let o=this.#sl.get(t);o||(o=new po),o.setContent(e),o.show(),this.#sl.set(t,o)}onProfileClosed(t){this.#sl.delete(t)}};class To{constructor(){Object.seal(this)}bottomLeft;upperRight;entryPoint;exitPoint}class Lo{#il;#hs;#nl;#rl(t,e,o){return e.lng===o.lng?new $(e.lat>o.lat?t.bottomLeft.lat:t.upperRight.lat,e.lng):e.lat===o.lat?new $(e.lat,e.lng<o.lng?t.upperRight.lng:t.bottomLeft.lng):null}#al(t,e){const o=1e-6;return e.lat-t.bottomLeft.lat<o||t.upperRight.lat-e.lat<o||e.lng-t.bottomLeft.lng<o||t.upperRight.lng-e.lng<o?$.clone(e):null}#ll(t,e,o){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){const t=Math.min(Math.abs(this.#nl.height/(o.lat-e.lat)),Math.abs(this.#nl.width/(o.lng-e.lng)));return new $(e.lat+t*(o.lat-e.lat),e.lng+t*(o.lng-e.lng))}return null}#dl(t,e,o){let s=this.#ll(t,e,o);if(s)return s;if(s=this.#al(t,e),s)return s;if(s=this.#rl(t,e,o),s)return s;const i=(e.lat-o.lat)/(e.lng-o.lng),n=e.lat-i*e.lng;if(s=new $(i*t.upperRight.lng+n,t.upperRight.lng),s.lat<=t.upperRight.lat&&s.lat>=t.bottomLeft.lat&&s.lng<o.lng)return s;if(s=new $(t.upperRight.lat,(t.upperRight.lat-n)/i),s.lng>=t.bottomLeft.lng&&s.lng<=t.upperRight.lng&&s.lat<o.lat)return s;if(s=new $(i*t.bottomLeft.lng+n,t.bottomLeft.lng),s.lat<=t.upperRight.lat&&s.lat>=t.bottomLeft.lat&&s.lng>o.lng)return s;if(s=new $(t.bottomLeft.lat,(t.bottomLeft.lat-n)/i),s.lng>=t.bottomLeft.lng&&s.lng<=t.upperRight.lng&&s.lat>o.lat)return s;throw new Error("intermediate point not found")}#cl(){this.#il=[];const t=this.#hs.itinerary.itineraryPoints.iterator;let e=t.done,o=new To;o.bottomLeft=$.clone(t.value),o.upperRight=$.clone(t.value),o.entryPoint=$.clone(t.value);let s=t.value,i=$.clone(t.value);e=t.done;let n=t.value;for(;!e;){const r=new To;r.bottomLeft=new $(Math.min(o.bottomLeft.lat,n.lat),Math.min(o.bottomLeft.lng,n.lng)),r.upperRight=new $(Math.max(o.upperRight.lat,n.lat),Math.max(o.upperRight.lng,n.lng)),r.entryPoint=$.clone(o.entryPoint),this.#nl.height>r.upperRight.lat-r.bottomLeft.lat&&this.#nl.width>r.upperRight.lng-r.bottomLeft.lng?(o=r,s=t.value,i=$.clone(t.value),e=t.done,n=t.value,e&&(o.exitPoint=i,this.#il.push(Object.freeze(o)))):(i=this.#dl(o,s,n),o.bottomLeft=new $(Math.min(o.bottomLeft.lat,i.lat),Math.min(o.bottomLeft.lng,i.lng)),o.upperRight=new $(Math.max(o.upperRight.lat,i.lat),Math.max(o.upperRight.lng,i.lng)),o.exitPoint=i,this.#il.push(Object.freeze(o)),o=new To,o.bottomLeft=$.clone(i),o.upperRight=$.clone(i),o.entryPoint=$.clone(i))}}constructor(t,e){Object.freeze(this),this.#hs=t,this.#nl=e,this.#cl()}get printViews(){return this.#il}}class Eo{#Et;#bn;constructor(t,e){Object.freeze(this),this.#Et=t,this.#bn=e}get width(){return this.#Et}get height(){return this.#bn}}class bo{#ae;#bt;#hl;constructor(t){if("string"!=typeof t?.text||"string"!=typeof t?.color||"string"!=typeof t?.backgroundColor)throw new Error("invalid toolbar for layer");Object.freeze(this),this.#ae=O.sanitizeToJsString(t.text),this.#bt=O.sanitizeToColor(t.color),this.#hl=O.sanitizeToColor(t.backgroundColor)}get text(){return this.#ae}get color(){return this.#bt}get backgroundColor(){return this.#hl}}class yo{#V=null;#ul=null;#p=null;#ml=null;#pl=null;#gl=null;#vl=null;#Tl=null;#Bt=null;#Ll=!1;#El=null;#bl=null;#yl(){if("string"!=typeof this.#bl?.name)throw new Error("invalid name for layer");this.#V=O.sanitizeToJsString(this.#bl.name)}#wl(){if("wms"!==this.#bl?.service&&"wmts"!==this.#bl?.service)throw new Error("invalid service for layer "+this.#V);this.#ul=this.#bl.service}#fl(){if("string"!=typeof this.#bl?.url)throw new Error("invalid url for layer "+this.#V);this.#p=this.#bl.url}#Ml(){if("wms"===this.#ul){if("string"!=typeof this.#bl?.wmsOptions?.layers||"string"!=typeof this.#bl?.wmsOptions?.format||"boolean"!=typeof this.#bl?.wmsOptions?.transparent)throw new Error("invalid wmsOptions for layer "+this.#V);this.#ml=this.#bl.wmsOptions,this.#ml.layers=O.sanitizeToJsString(this.#ml.layers),this.#ml.format=O.sanitizeToJsString(this.#ml.format)}}#Il(){try{this.#bl.bounds&&"number"==typeof this.#bl.bounds[0][0]&&"number"==typeof this.#bl.bounds[0][1]&&"number"==typeof this.#bl.bounds[1][0]&&"number"==typeof this.#bl.bounds[1][1]&&(this.#pl=this.#bl.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.#V)}}#Nl(){if(this.#bl.minZoom){if("number"!=typeof this.#bl.minZoom)throw new Error("invalid minZoom for layer "+this.#V);this.#gl=this.#bl.minZoom}if(this.#bl.maxZoom){if("number"!=typeof this.#bl.maxZoom)throw new Error("invalid maxZoom for layer "+this.#V);this.#vl=this.#bl.maxZoom}}#Cl(){this.#Tl=new bo(this.#bl.toolbar)}#Dl(){if("string"!=typeof this.#bl?.providerName)throw new Error("invalid providerName for layer "+this.#V);this.#Bt=O.sanitizeToJsString(this.#bl.providerName)}#xl(){if("boolean"!=typeof this.#bl.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.#V);this.#Ll=this.#bl.providerKeyNeeded}#Ol(){if(""===this.#bl.attribution)this.#El="";else{if("string"!=typeof this.#bl?.attribution)throw new Error("invalid attribution for map layer "+this.#V);this.#El=O.sanitizeToHtmlString(this.#bl.attribution).htmlString}}constructor(t){Object.freeze(this),this.#bl=t,this.#yl(),this.#wl(),this.#fl(),this.#Ml(),this.#Il(),this.#Nl(),this.#Cl(),this.#Dl(),this.#xl(),this.#Ol(),this.#bl=null}get name(){return this.#V}get service(){return this.#ul}get url(){return this.#p}get wmsOptions(){return this.#ml}get bounds(){return this.#pl}get minZoom(){return this.#gl}get maxZoom(){return this.#vl}get toolbarButtonData(){return this.#Tl}get providerName(){return this.#Bt}get providerKeyNeeded(){return this.#Ll}get attribution(){return this.#El}}const wo=new class{#jl;#Sl;#Hl;constructor(){Object.freeze(this),this.#jl=new Map,this.#Hl=!1,this.#Sl=new yo({service:"wmts",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.#jl.set(this.#Sl.name,this.#Sl)}getMapLayer(t){let e=this.#jl.get(t)||this.#Sl;return e.providerKeyNeeded&&(Rt.hasKey(e.providerName.toLowerCase())||(e=this.#Sl)),e}forEach(t){this.#jl.forEach(t)}addMapLayers(t){this.#Hl||(t.forEach((t=>{const e=new yo(t);this.#jl.get(e.name)||this.#jl.set(e.name,e)})),this.#Hl=!0)}get defaultMapLayer(){return this.#Sl}};class fo{constructor(){Object.freeze(this)}handleEvent(){window.print()}}class Mo{#Pl=null;constructor(t){Object.freeze(this),this.#Pl=t}handleEvent(){this.#Pl.onAfterPrint(),this.#Pl=null}}class Io{#Rl;#hs;#il;#Al;#Bl;#Ee;#kl;#Fl;#_l;#zl;#Kl;onAfterPrint(){this.#Fl.forEach((t=>document.body.removeChild(t))),this.#Fl.length=0,this.#Bl.removeEventListener("click",this.#zl,!1),this.#Ee.removeEventListener("click",this.#Kl,!1),document.body.removeChild(this.#Al);const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");U.map.invalidateSize(!1),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name),window.removeEventListener("afterprint",this.#Kl,!0),this.#Kl=null,this.#zl=null}#Ul(){const t=wo.getMapLayer(U.travel.layerName),e=Rt.getUrl(t),o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);return o.options.attribution=O.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,o}#Vl(){const t=[];return this.#hs.notes.forEach((e=>{const o=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),s=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:o,draggable:!0});t.push(s)})),t}#Wl(e){this.#kl++;const o="TravelNotes-RouteViewDiv"+this.#kl,s=document.createElement("div");s.className="TravelNotes-routeViewDiv",s.id=o,document.body.appendChild(s),this.#Fl.push(s),s.style.width=String(this.#Rl.paperWidth)+"mm",s.style.height=String(this.#Rl.paperHeight)+"mm";const i=this.#Rl.printNotes?this.#Vl():[];i.push(this.#Ul()),i.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),i.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),i.push(this.#_l),window.L.map(o,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.#Rl.zoomFactor,minZoom:this.#Rl.zoomFactor,maxZoom:this.#Rl.zoomFactor,layers:i})}#Xl(){this.#Al=W.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this.#Bl=W.create("div",{className:"TravelNotes-UI-Button",title:j.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.#Al),this.#Bl.addEventListener("click",this.#zl,!1),this.#Ee=W.create("div",{className:"TravelNotes-UI-Button",title:j.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.#Al),this.#Ee.addEventListener("click",this.#Kl,!1)}constructor(t,e,o){Object.freeze(this),this.#hs=t,this.#il=e,this.#Rl=o,this.#kl=0,this.#Fl=[],this.#zl=new fo,this.#Kl=new Mo(this)}preparePage(){this.#Rl.firefoxBrowser?document.body.classList.add("TravelNotes-Maps-FirefoxBrowser"):document.body.classList.remove("TravelNotes-Maps-FirefoxBrowser");const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===U.travel.name?"maps":U.travel.name+" - "+this.#hs.computedName+" - maps",this.#Xl(),window.addEventListener("afterprint",this.#Kl,!0);const e=[],o=this.#hs.itinerary.itineraryPoints.iterator;for(;!o.done;)e.push(o.value.latLng);this.#_l=window.L.polyline(e,{color:this.#hs.color,weight:this.#hs.width,dashArray:this.#hs.dashString}),this.#kl=0,this.#il.forEach((t=>this.#Wl(t)))}}class No{#Yl=0;static get#Gl(){return 256}#Zl(t){const e=W.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm";const o=ot.screenCoordToLatLng(0,0),s=ot.screenCoordToLatLng(e.clientWidth,e.clientHeight);this.#Yl=Math.ceil(e.clientWidth/No.#Gl)*Math.ceil(e.clientHeight/No.#Gl),document.body.removeChild(e);const i=U.map.getZoomScale(U.map.getZoom(),t.zoomFactor);return new Eo(Math.abs(o[1]-s[1])*i,Math.abs(o[0]-s[0])*i)}constructor(){Object.freeze(this)}print(e,o){const s=Ft.getRoute(o);if(!s)return;const i=new Lo(s,this.#Zl(e));if(t.printRouteMap.maxTiles<i.printViews.length*this.#Yl)return void St.showError(j.getText("RoutePrinter - The maximum of allowed pages is reached."));new Io(s,i.printViews,e).preparePage()}}class Co{static marker=null;static initialLatLng=null}class Do{static handleEvent(){Co.marker&&(window.L.DomEvent.off(Co.marker),U.map.removeLayer(Co.marker),Co.marker=null)}}const xo=new class{constructor(){Object.freeze(this)}addRoute(){const t=new _;U.travel.routes.add(t),this.chainRoutes(),l.editedChanged===U.travel.editedRoute.editionStatus?(Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook")):this.editRoute(t.objId)}editRoute(t){const e=Ft.getRoute(t),o=e.itinerary.provider,s=U.providers.get(o.toLowerCase());if(o&&""!==o&&(!s||s.providerKeyNeeded&&!Rt.hasKey(o)))return void St.showError(j.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:o}));g!==U.editedRouteObjId&&this.cancelEdition(),o&&""!==o&&Pt.dispatch("setprovider",{provider:o});const i=e.itinerary.transitMode;i&&""!==i&&Pt.dispatch("settransitmode",{transitMode:i}),U.travel.editedRoute=new _,e.editionStatus=l.editedNoChange,U.travel.editedRoute.jsonObject=e.jsonObject,U.editedRouteObjId=e.objId,U.travel.editedRoute.hidden=!1,e.hidden=!1,vo.updateProfile(U.editedRouteObjId,U.travel.editedRoute),this.chainRoutes(),Pt.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:U.travel.editedRoute.objId}),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelproperties")}removeRoute(t){let e=t;e!==U.editedRouteObjId&&e!==U.travel.editedRoute.objId||(e=U.editedRouteObjId,this.cancelEdition()),Pt.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:g}),U.travel.routes.remove(e),vo.deleteProfile(e),this.chainRoutes(),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelproperties")}saveGpx(t){(new _t).routeToGpx(t)}chainRoutes(){const t=U.travel.routes.iterator;let e=o.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=o.defaultValue;const s=t.value.notes.iterator;for(;!s.done;)s.value.chainedDistance=t.value.chainedDistance;if(t.value.objId===U.editedRouteObjId){U.travel.editedRoute.chainedDistance=U.travel.editedRoute.chain?t.value.chainedDistance:o.defaultValue;const e=U.travel.editedRoute.notes.iterator;for(;!e.done;)e.value.chainedDistance=U.travel.editedRoute.chainedDistance}}}saveEdition(){const t=new _;t.jsonObject=U.travel.editedRoute.jsonObject,U.travel.routes.replace(U.editedRouteObjId,t),U.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){Do.handleEvent();const t=Ft.getRoute(U.editedRouteObjId);t.editionStatus=l.notEdited,vo.updateProfile(U.travel.editedRoute.objId,t),Pt.dispatch("routeupdated",{removedRouteObjId:U.travel.editedRoute.objId,addedRouteObjId:U.editedRouteObjId}),U.editedRouteObjId=g,U.travel.editedRoute=new _,this.chainRoutes(),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelproperties")}routeProperties(t){const e=Ft.getRoute(t);new te(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&Pt.dispatch("routepropertiesupdated",{routeObjId:e.objId}),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelproperties")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new se).show().then((e=>(new No).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){Ft.getRoute(t).hidden=!1,Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:t}),Pt.dispatch("updatetravelproperties")}hideRoute(t){Ft.getRoute(t).hidden=!0,Pt.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:g}),Pt.dispatch("updatetravelproperties")}showRoutes(){const t=U.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:t.value.objId}));Pt.dispatch("updatetravelproperties")}hideRoutes(){const t=U.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===U.editedRouteObjId||(t.value.hidden=!0,Pt.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:g}));Pt.dispatch("updatetravelproperties")}};class Oo{static get#Jl(){return.5}static get#ql(){return 5}static get#$l(){return 10}static get#Ql(){return 31}static get#td(){return 32}static get#ed(){return 63}#od(t){return Math.floor(Math.abs(t)+Oo.#Jl)*(0<=t?1:-1)}#sd(t,e,o){const s=this.#od(t*o),i=this.#od(e*o);let n=s-i;n<<=1,0>s-i&&(n=~n);let r="";for(;Oo.#td<=n;)r+=String.fromCharCode((Oo.#td|n&Oo.#Ql)+Oo.#ed),n>>=Oo.#ql;return r+=String.fromCharCode(n+Oo.#ed),r}#n;#id(t){let e=null,o=0,s=0;do{e=t.charCodeAt(this.#n++)-Oo.#ed,s|=(e&Oo.#Ql)<<o,o+=Oo.#ql}while(Oo.#td<=e);return 1&s?~(s>>1):s>>1}constructor(){Object.freeze(this)}encode(t,e){if(!t.length)return"";const o=e.length,s=Array.from(e,(t=>Math.pow(Oo.#$l,t)));let i="";for(let e=0;e<o;e++)i+=this.#sd(t[0][e],0,s[e]);for(let e=1;e<t.length;e++){const n=t[e],r=t[e-1];for(let t=0;t<o;t++)i+=this.#sd(n[t],r[t],s[t])}return i}decode(t,e){const o=e.length;if(!t||0===t.length)return[];this.#n=0;const s=[],i=Array.from(e,(t=>Math.pow(Oo.#$l,t))),n=new Array(o).fill(0);for(;this.#n<t.length;){const e=new Array(o).fill(0);for(let s=0;s<o;s++)n[s]+=this.#id(t),e[s]=n[s]/i[s];s.push(e)}return s}}class jo{#nd(t){const e={values:"",objType:(new A).objType.jsonObject},o=[];t.itinerary.itineraryPoints.forEach((t=>{o.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),e.values=(new Oo).encode(o,[a.fixed,a.fixed,2,2,0]),t.itinerary.itineraryPoints=e}#rd(t){const e=[];if(t.itinerary.itineraryPoints.values)(new Oo).decode(t.itinerary.itineraryPoints.values,[a.fixed,a.fixed,2,2,0]).forEach((i=>{const n={lat:a.defaultValue,lng:a.defaultValue,distance:o.defaultValue,elev:s.defaultValue,objId:g};[n.lat,n.lng,n.distance,n.elev,n.objId]=i,n.objType=t.itinerary.itineraryPoints.objType,e.push(n)}));else{t.itinerary.itineraryPoints.latLngs=(new Oo).decode(t.itinerary.itineraryPoints.latLngs,[a.fixed,a.fixed]);let o=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{const n={};n.lat=i[0],n.lng=i[1],n.distance=t.itinerary.itineraryPoints.distances[o],t.itinerary.itineraryPoints.elevs?n.elev=t.itinerary.itineraryPoints.elevs[o]:n.elev=s.defaultValue,n.objId=t.itinerary.itineraryPoints.objIds[o],n.objType=t.itinerary.itineraryPoints.objType,e.push(n),o++}))}t.itinerary.itineraryPoints=e}constructor(){Object.freeze(this)}decompress(t){t.routes.forEach(this.#rd),t.editedRoute&&this.#rd(t.editedRoute)}compress(t){const e=t.jsonObject;return e.routes.forEach((t=>this.#nd(t))),this.#nd(e.editedRoute),e}}class So{constructor(){Object.freeze(this)}openDistantFile(t){(new jo).decompress(t),U.travel.jsonObject=t,U.travel.readOnly=!0,document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name);const e=U.travel.routes.iterator;for(;!e.done;)l.notEdited===e.value.editionStatus?Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:e.value.objId}):U.editedRouteObjId=e.value.objId;g!==U.editedRouteObjId&&Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:U.travel.editedRoute.objId});const o=U.travel.notes.iterator;for(;!o.done;)Pt.dispatch("noteupdated",{removedNoteObjId:g,addedNoteObjId:o.value.objId});(new ao).zoomToTravel()}}const Ho=new class{#Xo=null;constructor(){Object.freeze(this)}createUI(){this.#Xo=W.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){const e='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.#Xo.firstChild;)this.#Xo.removeChild(this.#Xo.firstChild);O.sanitizeToHtmlElement(e,this.#Xo)}};const Po=new class{constructor(){Object.freeze(this)}setMapLayer(t){const e=wo.getMapLayer(t);Pt.dispatch("layerchange",{layer:e}),Ho.attributions=e.attribution,U.travel.layerName=e.name}};class Ro{toolbarItemsArray;constructor(){Object.seal(this),this.toolbarItemsArray=[]}}class Ao{#ad;constructor(t){Object.freeze(this),this.#ad=t}handleEvent(t){this.#ad.toolbarItemsArray[Number.parseInt(t.target.dataset.tanItemId)].action()}}class Bo{#ld;#ad;#dd;static get#cd(){return 5}constructor(t,e){Object.freeze(this),this.#ld=t,this.#ad=e}handleEvent(t){switch(t.type){case"touchstart":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);this.#dd=e.screenY}break;case"touchend":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);Bo.#cd>Math.abs(e.screenY-this.#dd)&&(t.stopPropagation(),t.preventDefault(),this.#ad.toolbarItemsArray[Number.parseInt(t.target.dataset.tanItemId)].action(),this.#ld.hide())}}}}class ko{#hd;constructor(){Object.freeze(this),this.#hd=Number.MAX_VALUE}handleEvent(t){switch(t.type){case"touchstart":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);this.#hd=e.screenY}break;case"touchmove":case"touchend":if(1===t.changedTouches.length){const e=t.changedTouches.item(0),o=this.#hd-e.screenY;t.currentTarget.scrollTop+=o,this.#hd=e.screenY}break;default:this.#hd=Number.MAX_VALUE}"touchend"===t.type&&(this.#hd=Number.MAX_VALUE)}}class Fo{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.currentTarget.scrollTop+=t.deltaY*v[t.deltaMode])}}class _o{#Eo;#ud;#Go;#md;#pd;#gd;#vd;#Td;#ad;static get#Ld(){return 100}#Ed;#bd(t,e){const o=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonHTMLElement",textContent:t.textContent,title:t.title,dataset:{ItemId:e}},this.#ud);o.addEventListener("click",this.#gd,!1),o.addEventListener("touchstart",this.#vd,!1),o.addEventListener("touchend",this.#vd,!1)}#yd(t){const e=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonHTMLElement",title:t.title},this.#ud);W.create("text",{value:t.textContent},W.create("a",{className:"TravelNotes-BaseToolbar-ButtonLinkHTMLElement",href:t.action,target:"_blank"},e))}#Qe(){this.#ud=W.create("div",{className:"TravelNotes-BaseToolbar-ButtonsHTMLElement"},this.#Eo),this.#ad.toolbarItemsArray=[],this.addToolbarItems(),this.#ad.toolbarItemsArray.forEach(((t,e)=>{t.isCommand()?this.#bd(t,e):this.#yd(t)})),this.#ud.addEventListener("wheel",this.#md,{passive:!0}),this.#ud.addEventListener("touchstart",this.#pd,!1),this.#ud.addEventListener("touchmove",this.#pd,!1),this.#ud.addEventListener("touchend",this.#pd,!1),this.#Td=!0}#wd(t){_o.#Ld>t.timeStamp-this.#Ed||this.#fd(t)}#fd(t){if(this.#Ed=t.timeStamp,this.#Td){if(this.#Go)return clearTimeout(this.#Go),void(this.#Go=null);this.hide()}else this.#Qe()}#Md(){this.#Td&&(this.#Go=setTimeout((()=>this.hide()),t.toolbars.timeOut))}constructor(){Object.freeze(this)}hide(){for(this.#Go&&(clearTimeout(this.#Go),this.#Go=null);this.#ud.firstChild;){const t=this.#ud.firstChild;t.removeEventListener("click",this.#gd,!1),t.removeEventListener("touchstart",this.#vd,!1),t.removeEventListener("touchend",this.#vd,!1),this.#ud.removeChild(t)}this.#ud.removeEventListener("wheel",this.#md,{passive:!0}),this.#ud.removeEventListener("touchstart",this.#pd,!1),this.#ud.removeEventListener("touchmove",this.#pd,!1),this.#ud.removeEventListener("touchend",this.#pd,!1),this.#Eo.removeChild(this.#ud),this.#ud=null,this.#Td=!1}createUI(t,e){if(this.#Eo)return!1;this.#Go=null,this.#Td=!1,this.#Ed=0,this.#ad=new Ro,this.#md=new Fo,this.#pd=new ko,this.#gd=new Ao(this.#ad),this.#vd=new Bo(this,this.#ad),this.#Eo=W.create("div",{className:"TravelNotes-BaseToolbar-ToolbarHTMLElement "+e},document.body),this.#Eo.addEventListener("click",(t=>this.#wd(t)),!1),this.#Eo.addEventListener("mouseenter",(t=>this.#fd(t)),!1),this.#Eo.addEventListener("mouseleave",(t=>this.#Md(t)),!1),W.create("div",{className:"TravelNotes-BaseToolbar-HeaderTextHTMLElement",textContent:t},W.create("div",{className:"TravelNotes-BaseToolbar-HeaderHTMLElement"},this.#Eo))}addToolbarItem(t){this.#ad.toolbarItemsArray.push(t)}addCssClass(t){this.#Eo.classList.add(t)}}class zo{#Id;#re;#Tn;constructor(t,e,o){this.#Id=t,this.#Id="function"==typeof t?t():t,this.#re=e,this.#Tn=o}get textContent(){return this.#Id}get title(){return this.#re}get action(){return this.#Tn}isLink(){return"string"==typeof this.#Tn}isCommand(){return"function"==typeof this.#Tn}}const Ko=new class extends _o{constructor(){super()}createUI(){super.createUI(j.getText("MapLayersToolbar - Layers"),c.topLeft),this.addCssClass("TravelNotes-MapLayersToolbar-ToolbarHTMLElement")}addToolbarItems(){wo.forEach((t=>{(t.providerKeyNeeded&&Rt.hasKey(t.providerName.toLowerCase())||!t.providerKeyNeeded)&&this.addToolbarItem(new zo(t.toolbarButtonData.text,t.name,(()=>{Po.setMapLayer(t.name)})))})),t.mapLayersToolbar?.theDevil?.addButton&&this.addToolbarItem(new zo("👿","Reminder! The devil will know everything about you","https://www.google.com/maps/@"+U.map.getCenter().lat+","+U.map.getCenter().lng+","+U.map.getZoom()+"z"))}};class Uo{#Nd;#Cd;#Dd;#xd;#Od;#jd;#Sd;static get#Hd(){return 3e5}#Pd(t){U.map.setZoom(U.map.getZoom()+t)}#Rd(){this.#Nd&&(this.#Nd.textContent=" "+this.#xd+" "+this.#Od+" - Zoom : "+String(this.#jd)+" ");const t=U.map;t.getMaxZoom()===this.#jd?this.#Cd.classList.add("TravelNotes-MouseUI-Disabled"):this.#Cd.classList.remove("TravelNotes-MouseUI-Disabled"),t.getMinZoom()===this.#jd?this.#Dd.classList.add("TravelNotes-MouseUI-Disabled"):this.#Dd.classList.remove("TravelNotes-MouseUI-Disabled")}constructor(){Object.freeze(this),this.#xd=d.saved,this.#Od="",this.#jd=0,this.#Sd=null}set saveStatus(t){d.modified===t&&d.notSaved===this.#xd||(this.#xd=t,d.modified!==t||this.#Sd?d.saved===t&&this.#Sd&&(clearTimeout(this.#Sd),this.#Sd=null):this.#Sd=setTimeout((()=>this.#xd=d.notSaved),Uo.#Hd),this.#Rd())}createUI(){const e=W.create("div",{id:"TravelNotes-MouseUI"},document.body);this.#Dd=W.create("span",{id:"TravelNotes-MouseUI-ZoomMinus",textContent:"▼"},e),this.#Dd.addEventListener("click",(()=>this.#Pd(-1))),this.#Nd=W.create("span",null,e),this.#Cd=W.create("span",{id:"TravelNotes-MouseUI-ZoomPlus",textContent:"▲"},e),this.#Cd.addEventListener("click",(()=>this.#Pd(1))),this.#jd=U.map.getZoom(),this.#Od=S.formatLat(t.map.center.lat)+" - "+S.formatLng(t.map.center.lng),U.map.on("mousemove",(t=>{this.#Od=S.formatLatLng([t.latlng.lat,t.latlng.lng]),this.#Rd()})),U.map.on("zoomend",(()=>{this.#jd=U.map.getZoom(),this.#Rd()}))}}const Vo=new Uo;class Wo extends ce{#Ad=null;constructor(){super()}createContentHTML(){this.#Ad=W.create("div",{id:"TravelNotes-AboutDialog-About"}),O.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2022 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank">https://github.com/wwwouaiebe/TravelNotes</a></p><p>Version : v4.0.0-RC1.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.#Ad)}show(){super.show(),this.mover.centerDialog()}get contentHTMLElements(){return[this.#Ad]}get title(){return j.getText("AboutDialog - About Travel & Notes")}}const Xo=new class{#Bd=navigator.geolocation?i.inactive:i.disabled;#kd=null;#Fd(t){Pt.dispatch("geolocationpositionchanged",{position:t})}#_d(){i.active===this.#Bd&&(this.#Bd=i.inactive),Pt.dispatch("geolocationstatuschanged",{status:this.#Bd}),this.#kd&&(navigator.geolocation.clearWatch(this.#kd),this.#kd=null)}#zd(t){1===t.code&&(this.#Bd=i.refusedByUser),2===t.code&&St.showError(j.getText("GeoLocator - Geolocation disabled on the device")),this.#_d()}#Kd(){this.#Bd=i.active,Pt.dispatch("geolocationstatuschanged",{status:this.#Bd}),t.geoLocation.watch?this.#kd=navigator.geolocation.watchPosition((t=>this.#Fd(t)),(t=>this.#zd(t)),t.geoLocation.options):navigator.geolocation.getCurrentPosition((t=>this.#Fd(t)),(t=>this.#zd(t)),t.geoLocation.options)}constructor(){Object.freeze(this)}get status(){return this.#Bd}switch(){switch(this.#Bd){case i.inactive:this.#Kd();break;case i.active:this.#_d()}return this.#Bd}};class Yo{#Ud;#Vd;#Wd;constructor(t,e,o){Object.freeze(this),this.#Ud=t,this.#Vd=e,this.#Wd=o}get removeTravelNotes(){return this.#Ud}get removeRoutesNotes(){return this.#Vd}get removeManeuvers(){return this.#Wd}}class Go extends ut{#Xd;#Yd;#Gd;constructor(t){super(t)}createContentHTML(){this.#Xd=new zt({afterText:j.getText("SaveAsDialog - Remove Travel Notes"),checked:!1}),this.#Yd=new zt({afterText:j.getText("SaveAsDialog - Remove Routes Notes"),checked:!1}),this.#Gd=new zt({afterText:j.getText("SaveAsDialog - Remove Maneuvers"),checked:!1})}onOk(){super.onOk(new Yo(this.#Xd.checked,this.#Yd.checked,this.#Gd.checked))}get contentHTMLElements(){return[this.#Xd.controlHTMLElement,this.#Yd.controlHTMLElement,this.#Gd.controlHTMLElement]}get title(){return j.getText("SaveAsDialog - SaveAs")}}const Zo=new class{#Zd(e){const o=new z;o.jsonObject=U.travel.jsonObject,o.name+="-partial";let s=o.routes.iterator;for(;!s.done;)s.value.hidden=!1;if(e.removeTravelNotes&&o.notes.removeAll(),e.removeRoutesNotes)for(s=o.routes.iterator;!s.done;)s.value.notes.removeAll();if(e.removeManeuvers)for(s=o.routes.iterator;!s.done;)s.value.itinerary.maneuvers.removeAll();const i=(new jo).compress(o);S.saveFile(i.name+"."+(ct.isTouch?t.files.writeTouch:t.files.writeOthers),JSON.stringify(i),"application/json")}#Jd(){return""!==U.travel.name||(St.showError(j.getText("TravelEditor - Gives a name to the travel")),Pt.dispatch("showtravelproperties"),!1)}constructor(){Object.freeze(this)}routeDropped(t,e,o){const s=t===U.travel.editedRoute.objId?U.editedRouteObjId:t,i=e===U.travel.editedRoute.objId?U.editedRouteObjId:e;U.travel.routes.moveTo(s,i,o),xo.chainRoutes(),Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook")}saveAsTravel(){if(this.#Jd())return g!==U.editedRouteObjId?(St.showError(j.getText("TravelEditor - Not possible to partial save when a route is edited.")),void Pt.dispatch("showtravelproperties")):void(new Go).show().then((t=>{this.#Zd(t)})).catch((t=>{t instanceof Error&&console.error(t)}))}saveTravel(){if(!this.#Jd())return;const e=U.travel.routes.iterator;for(;!e.done;)e.value.hidden=!1;const o=(new jo).compress(U.travel);S.saveFile(o.name+"."+(ct.isTouch?t.files.writeTouch:t.files.writeOthers),JSON.stringify(o),"application/json"),Vo.saveStatus=d.saved}newTravel(){t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(j.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(vo.deleteAllProfiles(),Pt.dispatch("removeallobjects"),U.editedRouteObjId=g,U.travel.jsonObject=(new z).jsonObject,Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelnotes"),t.travelNotes.startupRouteEdition&&xo.editRoute(U.travel.routes.first.objId),Vo.saveStatus=d.saved)}};class Jo extends ht{#qd;#$d(){this.onTop?(this.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"),this.dialogHTMLElement.style.top="0px",this.#qd=!0):(this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent"),this.#qd=!1)}constructor(){super(),this.#qd=!1}get dialogDocked(){return this.#qd}centerDialog(){this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-Docked"),this.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent"),super.centerDialog()}moveDialogTo(t,e,o){super.moveDialogTo(t,e,o),o&&"touchmove"===o||this.#$d()}}class qo extends ce{#me;#pe;#Qd;#tc;#Ed;#Td;static get#Ld(){return 100}static get#ec(){return 1500}#oc(){this.mover.dialogDocked&&(ye.isActive?this.#Qd=setTimeout((()=>{this.#oc()}),Math.max(qo.#ec,t.dockableBaseDialog.timeout)):this.mover.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"))}#sc(t){this.#Ed=t.timeStamp,this.#Qd&&(clearTimeout(this.#Qd),this.#Qd=null),this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.remove("TravelNotes-DockableBaseDialog-HiddenContent")}#ic(){this.mover.dialogDocked&&(this.#Qd=setTimeout((()=>{this.#oc()}),Math.max(qo.#ec,t.dockableBaseDialog.timeout)))}#nc(t){t.preventDefault(),qo.#Ld>t.timeStamp-this.#Ed||this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.toggle("TravelNotes-DockableBaseDialog-HiddenContent")}constructor(t,e){super(),this.#me=t,this.#pe=e,this.#Qd=null,this.#tc=null,this.#Ed=0,this.#Td=!1}get mover(){return this.#tc?this.#tc:this.#tc=new Jo}onCancel(){super.onCancel(),this.#Td=!1,this.#tc&&(this.#tc=null)}show(){this.#Td||(super.show(),this.addCssClass("TravelNotes-DockableBaseDialog"),this.updateContent(),null!==this.#me&&null!==this.#pe?(this.mover.moveDialogTo(this.#me,this.#pe),this.#me=null,this.#pe=null):this.mover.moveDialogToLastPosition(),this.mover.dialogHTMLElement.addEventListener("mouseenter",(t=>this.#sc(t)),!1),this.mover.dialogHTMLElement.addEventListener("mouseleave",(()=>this.#ic()),!1),this.mover.topBarHTMLElement.addEventListener("click",(t=>this.#nc(t)),!1),this.mover.dialogDocked&&this.mover.dialogHTMLElement.classList.add("TravelNotes-DockableBaseDialog-HiddenContent"),this.#Td=!0)}}class $o{#V="";#rc=!1;#ac=[];#lc=["node","way","relation"];#dc=[];#cc=!1;#hc=!1;#t=g;constructor(t,e){this.#V=O.sanitizeToJsString(t),e&&(this.#hc=!0,this.#rc=!0),this.#t=b.nextObjId,Object.freeze(this)}get name(){return this.#V}get isRoot(){return this.#rc}get items(){return this.#ac}get elementTypes(){return this.#lc}setElementType(t){T!==["node","way","relation"].indexOf(t)&&(this.#lc=[t])}get filterTagsArray(){return this.#dc}get isSelected(){return this.#cc}set isSelected(t){this.#cc=t,this.items.forEach((e=>{e.isSelected=t}))}get isExpanded(){return this.#hc}set isExpanded(t){this.#hc=t}get objId(){return this.#t}}const Qo=new class{#uc;#mc;#pc;#gc;#vc(t){const e=t.split(";");for(;""===e[e.length-1];)e.pop();let o=0;const s=[];e.forEach((t=>{if(""!==t)if(T===t.indexOf("="))this.#pc=new $o(t),this.#mc.set(this.#pc.objId,this.#pc),this.#gc[o].push(this.#pc),this.#gc[o+1]=this.#pc.items;else{let e=t.split("=");if("element"===e[0])this.#pc.setElementType(e[1]);else{let t={};t[e[0]]="*"===e[1]?null:e[1],s.push(t)}}o++})),0!==s.length&&this.#pc.filterTagsArray.push(s)}#Tc(t){t.items.forEach((t=>{this.#Tc(t)})),t.isExpanded=!0}#Lc(t){t.items.forEach((t=>{this.#Lc(t)})),t.isExpanded=!1}constructor(){this.#uc=new $o("",!0),this.#mc=new Map,this.#mc.set(this.#uc.objId,this.#uc),this.#gc=[this.#uc.items],Object.freeze(this)}get dictionary(){return this.#uc}parseDictionary(t){t.split(/\r\n|\r|\n/).forEach((t=>{""!==t&&this.#vc(t)}))}selectItem(t,e){this.#mc.get(t).isSelected=e}unselectAll(){this.#uc.isSelected=!1}expandItem(t){let e=this.#mc.get(t);e.isExpanded=!e.isExpanded}expand(){this.#Tc(this.#uc)}collapse(){this.#uc.items.forEach((t=>this.#Lc(t)))}};class ts{#Ec;constructor(t){Object.freeze(this),this.#Ec=t}handleEvent(t){t.stopPropagation(),Qo.unselectAll(),this.#Ec.redraw()}}class es{#Ec;constructor(t){Object.freeze(this),this.#Ec=t}handleEvent(t){t.stopPropagation(),Qo.collapse(),this.#Ec.redraw()}}class os{#Ec;constructor(t){Object.freeze(this),this.#Ec=t}handleEvent(t){t.stopPropagation(),Qo.expand(),this.#Ec.redraw()}}class ss{#bc;#yc;#wc;static get#fc(){return 5e3}#Mc(t,e){let o=!0;return e.forEach((e=>{const[s,i]=Object.entries(e)[0];o=o&&t.tags[s]&&(!i||t.tags[s]===i)})),o}#Ic(t,e){this.#yc.forEach((o=>{o.filterTagsArray.forEach((s=>{this.#Mc(t,s)&&(t.description=o.name,e.set(t.id,t))}))}))}#Nc(){const e=[],o=new Map;this.#yc.forEach((t=>{t.filterTagsArray.forEach((e=>{const[s,i]=Object.entries(e[0])[0];let n=o.get(s);n||(n={values:new Map,elements:new Map},o.set(s,n)),n.values.set(i,i),t.elementTypes.forEach((t=>{n.elements.set(t,t)}))}))}));const s=this.#Cc();this.#wc=s;const i="("+s.getSouthWest().lat.toFixed(a.fixed)+","+s.getSouthWest().lng.toFixed(a.fixed)+","+s.getNorthEast().lat.toFixed(a.fixed)+","+s.getNorthEast().lng.toFixed(a.fixed)+")";return o.forEach(((o,s)=>{let n='"'+s+'"';if(1===o.values.size){const t=o.values.values().next().value;t&&(n+='="'+t+'"')}else 1<o.values.size&&(n+='~"',o.values.forEach((t=>{n+=t+"|"})),n=n.substring(0,n.length-1)+'"');if(t.overpassApi.useNwr){const t=1===o.elements.size?o.elements.values().next().value:"nwr";e.push(t+"["+n+"]"+i+";"+("node"===t?"":"(._;>;);")+"out;")}else{let t=[];1===o.elements.size?t.push(o.elements.values().next().value):t=["node","way","rel"],t.forEach((t=>{e.push(t+"["+n+"]"+i+";"+("node"===t?"":"(._;>;);")+"out;")}))}})),e}#Dc(t){t.isSelected&&0<t.filterTagsArray.length&&this.#yc.push(t),t.items.forEach((t=>this.#Dc(t)))}#Cc(){const t=U.map.getCenter(),e=U.map.getBounds(),o=ot.getSquareBoundingBox([t.lat,t.lng],ss.#fc);return e.getSouthWest().lat=Math.max(e.getSouthWest().lat,o.getSouthWest().lat),e.getSouthWest().lng=Math.max(e.getSouthWest().lng,o.getSouthWest().lng),e.getNorthEast().lat=Math.min(e.getNorthEast().lat,o.getNorthEast().lat),e.getNorthEast().lng=Math.min(e.getNorthEast().lng,o.getNorthEast().lng),e}constructor(){Object.freeze(this),this.#bc=!1,this.#yc=[],this.#wc=null}async search(){if(this.#bc)return;this.#bc=!0,this.#yc=[],this.#Dc(Qo.dictionary);const t=new je({searchPlaces:!1});await t.loadData(this.#Nc());const e=new Map;[t.nodes,t.ways,t.relations].forEach((t=>{t.forEach((t=>{t.tags&&this.#Ic(t,e)}))})),U.searchData.length=0,Array.from(e.values()).sort(((t,e)=>t.description>e.description)).forEach((t=>U.searchData.push(t))),this.#bc=!1,Pt.dispatch("updateosmsearch")}get searchBounds(){return this.#Cc()}get previousSearchBounds(){return this.#wc}}const is=new ss;class ns{#Ec;#xc;constructor(t,e){Object.freeze(this),this.#Ec=t,this.#xc=e}handleEvent(t){t.stopPropagation(),Qo.dictionary.isExpanded=!1,this.#Ec.redraw(),U.searchData.length=0,Pt.dispatch("updateosmsearch"),this.#xc.showWait(),is.search()}}class rs{#Oc;constructor(t,e){Object.freeze(this),this.#Oc=W.create("div"),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Start the search"),textContent:"🔎"},this.#Oc).addEventListener("click",new ns(t,e),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Expand the tree"),textContent:"▼"},this.#Oc).addEventListener("click",new os(t),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Collapse the tree"),textContent:"▶"},this.#Oc).addEventListener("click",new es(t),!1),W.create("div",{className:"TravelNotes-BaseDialog-Button",title:j.getText("OsmSearchToolbarButtons - Clear the tree"),textContent:"❌"},this.#Oc).addEventListener("click",new ts(t),!1)}get toolbarButtonsHTMLElement(){return this.#Oc}}class as{#Ec=null;constructor(t){Object.freeze(this),this.#Ec=t}handleEvent(t){t.stopPropagation(),Qo.expandItem(Number.parseInt(t.target.parentNode.dataset.tanObjId)),this.#Ec.redraw()}}class ls{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*v[t.deltaMode]),t.stopPropagation()}}class ds{#Ec=null;constructor(t){Object.freeze(this),this.#Ec=t}handleEvent(t){t.stopPropagation(),Qo.selectItem(Number.parseInt(t.target.parentNode.dataset.tanObjId),t.target.checked),this.#Ec.redraw()}}class cs{#jc;#Sc;#Hc;#Pc;#Rc(t){this.#Pc++;const e=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchItemMargin"+this.#Pc,dataset:{ObjId:t.objId}},this.#jc);if(!t.isRoot){W.create("input",{type:"checkbox",checked:t.isSelected},e).addEventListener("change",this.#Hc,!1)}if(0===t.filterTagsArray.length){W.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-OsmSearchDialog-TreeArrow",textContent:t.isExpanded?"▼":"▶"},e).addEventListener("click",this.#Sc,!1)}W.create("text",{value:t.name},e),t.isExpanded&&t.items.forEach((t=>this.#Rc(t))),this.#Pc--}constructor(){Object.freeze(this),this.#Pc=0,this.#jc=W.create("div",{id:"TravelNotes-OsmSearchDialog-SearchTree"}),this.#jc.addEventListener("wheel",new ls,{passive:!0}),this.#Hc=new ds(this),this.#Sc=new as(this),this.#Rc(Qo.dictionary)}redraw(){this.#jc.textContent="",this.#Rc(Qo.dictionary)}get treeHTMLElement(){return this.#jc}}class hs{#Re;constructor(){this.#Re=W.create("div",{className:"TravelNotes-WaitAnimation"}),W.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.#Re),this.#Re.classList.add("TravelNotes-Hidden")}showWait(){this.#Re.classList.remove("TravelNotes-Hidden")}hideWait(){this.#Re.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.#Re}}class us{#da;constructor(t,e){Object.freeze(this),this.#da=new Ue(t,e)}destructor(){this.#da=null}get addressButtonClick(){return this.#da}}class ms extends ut{#Ac;#Bc;#La;#fa;constructor(t){super(),this.#Ac=t,this.#fa=new us(this,this.#Ac.latLng)}createContentHTML(){this.#Bc=new $t({headerText:j.getText("WayPointPropertiesDialog - Name")},this.#fa),this.#Bc.value=this.#Ac.name,this.#La=new xe(this.#fa),this.#La.address=this.#Ac.address}onCancel(){this.#fa.destructor(),super.onCancel()}onOk(){this.#Ac.address=this.#La.address,this.#Ac.name=this.#Bc.value,this.#fa.destructor(),super.onOk()}get contentHTMLElements(){return[this.#Bc.controlHTMLElement,this.#La.controlHTMLElement]}set name(t){this.#Bc.name=t}set address(t){this.#La.address=t}get title(){return j.getText("WayPointPropertiesDialog - Waypoint properties")}get wayPoint(){return this.#Ac}setControlsValues(t){this.#La.address=t.address,this.#Bc.value=t.name}}const ps=new class{#kc;#Fc;#_c(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;for(e.done,s.done,s.value.distance=o.defaultValue,s.done,t.distance=o.defaultValue,t.duration=o.defaultValue;!e.done;)e.previous.distance=At.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=o.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=o.defaultValue),s.done)}#zc(t){this.#kc=!1,t instanceof Error?(console.error(t),St.showError(t.message)):St.showError("A network error occurs when calling the provider")}#Kc(){if(this.#kc=!1,this.#_c(U.travel.editedRoute),"circle"!==U.travel.editedRoute.itinerary.transitMode){const t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=U.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=U.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=ot.getClosestLatLngDistance(U.travel.editedRoute,t.value.latLng).latLng}const t=U.travel.editedRoute.notes.iterator;for(;!t.done;){const e=ot.getClosestLatLngDistance(U.travel.editedRoute,t.value.latLng);t.value.latLng=e.latLng,t.value.distance=e.distance}xo.chainRoutes(),U.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.#Fc&&(new ao).zoomToRoute(U.travel.editedRoute.objId),vo.createProfile(U.travel.editedRoute),Pt.dispatch("routeupdated",{removedRouteObjId:U.travel.editedRoute.objId,addedRouteObjId:U.travel.editedRoute.objId}),Pt.dispatch("updateroadbook"),Pt.dispatch("updatetravelproperties")}constructor(){Object.freeze(this)}startRouting(){if(!this.#kc&&U.travel.editedRoute.haveValidWayPoints()){this.#Fc=0===U.travel.editedRoute.itinerary.itineraryPoints.length,this.#kc=!0;const t=U.providers.get(U.routing.provider.toLowerCase());U.travel.editedRoute.itinerary.provider=t.name,U.travel.editedRoute.itinerary.transitMode=U.routing.transitMode,t.getPromiseRoute(U.travel.editedRoute).then((()=>this.#Kc())).catch((()=>this.#zc()))}}};const gs=new class{async#Uc(e){if(!t.wayPoint.reverseGeocoding)return Pt.dispatch("updatetravelproperties"),void Pt.dispatch("updateroadbook");const o=await(new Pe).getAddressAsync(e.latLng);U.editedRouteObjId===U.travel.editedRoute.objId&&(U.travel.editedRoute.editionStatus=l.editedChanged),e.address=o.street,""!==o.city&&(e.address+=" "+o.city),e.name="",t.wayPoint.geocodingIncludeName&&(e.name=o.name),Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook")}#Vc(t){const e=U.travel.editedRoute.wayPoints.first;e.latLng=t,this.#Uc(e),Pt.dispatch("addwaypoint",{wayPoint:e,letter:"A"})}#Wc(t){const e=U.travel.editedRoute.wayPoints.last;e.latLng=t,this.#Uc(e),Pt.dispatch("addwaypoint",{wayPoint:e,letter:"B"})}constructor(){Object.freeze(this)}addWayPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged;const e=new R;e.latLng=t,U.travel.editedRoute.wayPoints.add(e),this.#Uc(e),Pt.dispatch("addwaypoint",{wayPoint:U.travel.editedRoute.wayPoints.last,letter:U.travel.editedRoute.wayPoints.length-2}),U.travel.editedRoute.wayPoints.swap(e.objId,!0),ps.startRouting()}addWayPointOnRoute(t,e){const o=ot.getClosestLatLngDistance(U.travel.editedRoute,t).distance;U.travel.editedRoute.editionStatus=l.editedChanged;const s=new R;s.latLng=e;let i="";const n=U.travel.editedRoute.wayPoints.iterator;for(;!n.done;){if(o<ot.getClosestLatLngDistance(U.travel.editedRoute,n.value.latLng).distance){i=String(n.index),U.travel.editedRoute.wayPoints.add(s),U.travel.editedRoute.wayPoints.moveTo(s.objId,n.value.objId,!0),this.#Uc(s),Pt.dispatch("addwaypoint",{wayPoint:s,letter:i}),ps.startRouting();break}}}reverseWayPoints(){U.travel.editedRoute.editionStatus=l.editedChanged;let t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)Pt.dispatch("removeobject",{objId:t.value.objId});for(U.travel.editedRoute.wayPoints.reverse(),t=U.travel.editedRoute.wayPoints.iterator;!t.done;)Pt.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":String(t.index)});Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook"),ps.startRouting()}removeWayPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,Pt.dispatch("removeobject",{objId:t}),U.travel.editedRoute.wayPoints.remove(t),ps.startRouting()}setStartPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Vc(t),ps.startRouting()}setEndPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Wc(t),ps.startRouting()}setStartAndEndPoint(t){U.travel.editedRoute.editionStatus=l.editedChanged,this.#Vc(t),this.#Wc(t),2<U.travel.editedRoute.wayPoints.length&&ps.startRouting()}wayPointDragEnd(t){U.travel.editedRoute.editionStatus=l.editedChanged;const e=U.travel.editedRoute.wayPoints.getAt(t.target.objId),o=t.target.getLatLng();e.latLng=[o.lat,o.lng],this.#Uc(e),ps.startRouting()}wayPointProperties(t){const e=U.travel.editedRoute.wayPoints.getAt(t);new ms(e).show().then((()=>{Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class vs{#en;#ja;constructor(t,e){this.#en=t,this.#ja=e}get latLng(){return this.#en}get geometry(){return this.#ja}}class Ts extends ye{#Xc;#en;constructor(t,e){super(t,e),this.#Xc=U.searchData[Number.parseInt(t.currentTarget.dataset.tanElementIndex)],this.#en=[this.#Xc.lat,this.#Xc.lon],Pt.dispatch("removeobject",{objId:this.targetObjId})}get menuItems(){return[new we(j.getText("OsmSearchContextMenu - Select this point as start point"),g!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat,(()=>gs.setStartPoint(this.#en))),new we(j.getText("OsmSearchContextMenu - Select this point as way point"),g!==U.editedRouteObjId,(()=>gs.addWayPoint(this.#en))),new we(j.getText("OsmSearchContextMenu - Select this point as end point"),g!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>gs.setEndPoint(this.#en))),new we(j.getText("OsmSearchContextMenu - Create a route note with this result"),!0,(()=>ro.newSearchRouteNote(this.#Xc))),new we(j.getText("OsmSearchContextMenu - Create a travel note with this result"),!0,(()=>ro.newSearchTravelNote(this.#Xc))),new we(j.getText(ro.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),!0,(()=>ro.changeOsmSearchNoteDialog())),new we(j.getText("OsmSearchContextMenu - Zoom to this result"),!0,(()=>(new ao).zoomToPoi(new vs(this.#en,this.#Xc.geometry))))]}}class Ls{#Yc;#Gc;#Zc;#Jc;#qc;#$c;#Qc;#th;#eh;#oh;#sh;#ih;#nh;#rh;static get#ah(){return 1e3}static get#lh(){return 40}static get#dh(){return 5}static get#ch(){return 200}static get#hh(){return 100}#uh(t){t!==this.#Jc&&Ls.#lh<t-this.#Jc&&(this.#Qc.scrollTop-=Ls.#dh,this.#Jc=t),this.#th>this.#oh&&0<this.#Qc.scrollTop&&window.requestAnimationFrame((t=>{this.#uh(t)}))}#mh(t){t!==this.#Jc&&Ls.#lh<t-this.#Jc&&(this.#Qc.scrollTop+=Ls.#dh,this.#Jc=t);let e=1>Math.abs(this.#Qc.scrollHeight-this.#Qc.clientHeight-this.#Qc.scrollTop);this.#eh<this.#oh&&!e&&window.requestAnimationFrame((t=>{this.#mh(t)}))}#oe(t){const e=t.changedTouches.item(0);if(1===t.touches.length){if(Ls.#ah<t.timeStamp-this.#Zc||0===this.#Zc)return void(this.#Zc=t.timeStamp);t.preventDefault(),this.#Gc=!0,this.#$c=t.currentTarget.parentNode,this.#Qc=t.currentTarget.parentNode.parentNode.parentNode,this.#oh=e.screenY;const o=t.currentTarget.getBoundingClientRect();this.#nh=e.screenX-o.left,this.#rh=e.screenY-o.top,this.#qc=t.currentTarget.cloneNode(!0),this.#qc.classList.add("TravelNotes-SortableList-DraggedListItemHTMLElement"),document.body.appendChild(this.#qc),this.#qc.style.left=String(e.screenX-this.#nh)+"px",this.#qc.style.top=String(e.screenY-this.#rh)+"px",this.#th=this.#$c.getBoundingClientRect().y-this.#Qc.getBoundingClientRect().y+this.#Qc.scrollTop+Ls.#ch,this.#eh=this.#Qc.getBoundingClientRect().bottom-Ls.#hh}}#ee(t){if(!this.#Gc)return;const e=t.changedTouches.item(0);if(1===t.touches.length&&this.#qc){this.#qc.style.left=String(e.screenX-this.#nh)+"px",this.#qc.style.top=String(e.screenY-this.#rh)+"px",this.#oh=e.screenY,this.#th>this.#oh&&0<this.#Qc.scrollTop&&window.requestAnimationFrame((t=>{this.#uh(t)}));let t=1>Math.abs(this.#Qc.scrollHeight-this.#Qc.clientHeight-this.#Qc.scrollTop);this.#eh<this.#oh&&!t&&window.requestAnimationFrame((t=>{this.#mh(t)}))}}#ph(t){this.#$c.childNodes.forEach((e=>{let o=e.getBoundingClientRect();o.left<t.clientX&&o.right>t.clientX&&o.top<t.clientY&&o.bottom>t.clientY&&(this.#sh=e,this.#ih=t.clientY-o.top<o.height/2)}))}#te(t){if(this.#Gc){let e=t.changedTouches.item(0);if(this.#ph(e),this.#sh)try{this.#Yc(Number.parseInt(t.currentTarget.dataset.tanObjId),Number.parseInt(this.#sh.dataset.tanObjId),this.#ih)}catch{}}this.#gh()}#gh(){this.#qc&&document.body.removeChild(this.#qc),this.#qc=null,this.#Qc=null,this.#Gc=!1,this.#Jc=0,this.#$c=null,this.#th=0,this.#eh=0,this.#oh=0,this.#sh=null,this.#ih=!0}constructor(t){Object.freeze(this),this.#Yc=t,this.#qc=null,this.#Zc=0,this.#gh()}handleEvent(t){switch(t.type){case"touchstart":this.#oe(t);break;case"touchmove":this.#ee(t);break;case"touchend":this.#te(t);break;case"touchcancel":this.#gh()}}}class Es{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class bs{#Yc;constructor(t){Object.freeze(this),this.#Yc=t}handleEvent(t){t.preventDefault();const e=t.currentTarget.getBoundingClientRect();try{this.#Yc(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(t.currentTarget.dataset.tanObjId),t.clientY-e.top<e.bottom-t.clientY)}catch{}}}class ys{#vh;constructor(t){Object.freeze(this),this.#vh=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new this.#vh(t,t.target.parentNode).show()}}class ws extends gt{#Th;#Lh;#Eh;#bh;#$c;constructor(t,e,o){super(),this.#Th=new Es,this.#Lh=new bs(t),this.#Eh=new ys(e),this.#bh=new Ls(t),o&&W.create("div",{className:"TravelNotes-BaseDialog-FlexRow",textContent:o},this.controlHTMLElement),this.#$c=W.create("div",{className:"TravelNotes-SortableList-ListHTMLElement"},this.controlHTMLElement)}updateContent(t){for(;this.#$c.firstChild;)this.#$c.firstChild.removeEventListener("dragstart",this.#Th,!1),this.#$c.firstChild.removeEventListener("drop",this.#Lh,!1),this.#$c.firstChild.removeEventListener("contextmenu",this.#Eh,!1),this.#$c.firstChild.removeEventListener("touchstart",this.#bh,!1),this.#$c.firstChild.removeEventListener("touchmove",this.#bh,!1),this.#$c.firstChild.removeEventListener("touchend",this.#bh,!1),this.#$c.removeChild(this.#$c.firstChild);t.forEach((t=>{t.draggable=!0,t.addEventListener("dragstart",this.#Th,!1),t.addEventListener("drop",this.#Lh,!1),t.addEventListener("contextmenu",this.#Eh,!1),t.addEventListener("touchstart",this.#bh,!1),t.addEventListener("touchmove",this.#bh,!1),t.addEventListener("touchend",this.#bh,!1),this.#$c.appendChild(t),t.classList.add("TravelNotes-SortableList-ListItemHTMLElement")}))}}class fs{#yh;#Xc;#wh;static get#pr(){return 40}#fh(){let t="";t=this.#Xc.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.#Xc.tags.rcn_ref+"</text></svg></div>":Ie.preDefinedIconDataFromName(this.#Xc.description)||"";const e=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResult-IconCell"},this.#yh);O.sanitizeToHtmlElement(t,e)}#Mh(t){t&&W.create("div",{textContent:t},this.#wh)}#zr(){const t=(this.#Xc.tags["addr:street"]?(this.#Xc.tags["addr:housenumber"]?this.#Xc.tags["addr:housenumber"]+" ":"")+this.#Xc.tags["addr:street"]+" ":"")+(this.#Xc.tags["addr:city"]?(this.#Xc.tags["addr:postcode"]?this.#Xc.tags["addr:postcode"]+" ":"")+this.#Xc.tags["addr:city"]:"");""!==t&&this.#Mh(t)}#Ih(){this.#Xc.tags.phone&&this.#Mh("☎️ : "+this.#Xc.tags.phone,this.#wh)}#Nh(){this.#Xc.tags.email&&W.create("a",{href:"mailto:"+this.#Xc.tags.email,textContent:this.#Xc.tags.email},W.create("div",{textContent:"📧 : "},this.#wh))}#Ch(){this.#Xc.tags.website&&W.create("a",{href:this.#Xc.tags.website,target:"_blank",textContent:this.#Xc.tags.website.length>fs.#pr?this.#Xc.tags.website.substring(0,fs.#pr)+"...":this.#Xc.tags.website},W.create("div",null,this.#wh))}#Dh(){this.#wh=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResult-Cell"},this.#yh),this.#Mh(this.#Xc.description),this.#Mh(this.#Xc.tags.name),this.#Mh(this.#Xc.tags.rcn_ref),this.#zr(),this.#Ih(),this.#Nh(),this.#Ch()}#xh(){for(const[t,e]of Object.entries(this.#Xc.tags))this.#yh.title+=t+"="+e+"\n"}constructor(){Object.freeze(this)}buildHTMLElement(t,e){return this.#Xc=t,this.#yh=W.create("div",{className:"TravelNotes-OsmSearchDialog-SearchResultHTMLElement",dataset:{ObjId:b.nextObjId,ElementIndex:e}}),this.#fh(),this.#Dh(),this.#xh(),this.#yh}}class Ms{#Oh;#jh;#Sh(){g===this.#jh?this.#jh=b.nextObjId:Pt.dispatch("removeobject",{objId:this.#jh}),Pt.dispatch("addrectangle",{objId:this.#jh,bounds:is.searchBounds,properties:t.osmSearch.nextSearchLimit})}#Hh(){const e=is.previousSearchBounds;e&&(g===this.#Oh?this.#Oh=b.nextObjId:Pt.dispatch("removeobject",{objId:this.#Oh}),Pt.dispatch("addrectangle",{objId:this.#Oh,bounds:[[e.getSouthWest().lat,e.getSouthWest().lng],[e.getNorthEast().lat,e.getNorthEast().lng]],properties:t.osmSearch.previousSearchLimit}))}constructor(){Object.freeze(this),this.#Oh=g,this.#jh=g}show(){U.map.on("zoom",this.#Sh,this),U.map.on("move",this.#Sh,this),this.#Sh(),this.#Hh()}hide(){U.map.off("zoom",this.#Sh,this),U.map.off("move",this.#Sh,this),g!==this.#jh&&(Pt.dispatch("removeobject",{objId:this.#jh}),this.#jh=g),g!==this.#Oh&&(Pt.dispatch("removeobject",{objId:this.#Oh}),this.#Oh=g)}}class Is{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation();const e=U.searchData[Number.parseInt(t.target.dataset.tanElementIndex)];Pt.dispatch("addsearchpointmarker",{objId:Number.parseInt(t.target.dataset.tanObjId),latLng:[e.lat,e.lon],geometry:e.geometry})}}class Ns{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),Pt.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanObjId)})}}class Cs extends qo{#Ph;#Eo;#Rh;#Ec;#xc;#Ah;#Bh;#kh;#Xl(){this.#Eo=W.create("div"),this.#Ec=new cs,this.#xc=new hs;const t=new rs(this.#Ec,this.#xc);this.#Eo.appendChild(t.toolbarButtonsHTMLElement),this.#Eo.appendChild(this.#Ec.treeHTMLElement),this.#Eo.appendChild(this.#xc.waitHTMLElement)}constructor(){super(t.osmSearchDialog.dialogX,t.osmSearchDialog.dialogY)}createContentHTML(){this.#Xl(),this.#Rh=new ws(null,Ts),this.#Ah=new fs,this.#Ph=new Ms,this.#Bh=new Is,this.#kh=new Ns}get contentHTMLElements(){return[].concat(this.#Rh.controlHTMLElement)}get title(){return j.getText("OsmSearchDialog - Searching OpenStreetMap")}get toolbarHTMLElement(){return this.#Eo}onCancel(){this.#Ph.hide(),super.onCancel()}show(){super.show(),this.#Ph.show()}updateContent(){this.#xc.hideWait(),this.#Ph.hide(),this.#Ph.show();const t=[];U.searchData.forEach(((e,o)=>{const s=this.#Ah.buildHTMLElement(e,o);s.addEventListener("mouseenter",this.#Bh,!1),s.addEventListener("mouseleave",this.#kh,!1),t.push(s)})),this.#Rh.updateContent(t)}}class Ds extends ut{#Fh;constructor(t){super(t)}createContentHTML(){this.#Fh=W.create("div",{textContent:this.options.text||""})}get contentHTMLElements(){return[this.#Fh]}get title(){return this.options.title||""}}class xs{#hs=null;#_h=0;#zh(t){const e=new F;for(const o in t)e[o]=t[o];e.iconLatLng=e.latLng,e.distance=ot.getClosestLatLngDistance(this.#hs,e.latLng).distance,e.chainedDistance=this.#hs.chainedDistance,this.#hs.notes.add(e),Pt.dispatch("noteupdated",{removedNoteObjId:g,addedNoteObjId:e.objId})}async#Kh(){const t=new no;t.createUI();const e=new Qe,o=this.#hs.itinerary.maneuvers.iterator;for(;!o.done;){t.showInfo(j.getText("AllManeuverNotesBuilder - Creating note",{noteNumber:o.index+1,notesLength:this.#_h}));const s=this.#hs.itinerary.itineraryPoints.getAt(o.value.itineraryPointObjId).latLng,i=await e.getIconAndAdressAsync(s,this.#hs);i?this.#zh(i):console.error("An error occurs when creating the svg icon "+o.index)}this.#hs.notes.sort(((t,e)=>t.distance-e.distance)),Pt.dispatch("updateroadbook"),t.close()}constructor(){Object.freeze(this)}addAllManeuverNotes(e){this.#hs=Ft.getRoute(e),this.#_h=this.#hs.itinerary.maneuvers.length,t.note.maxManeuversNotes<this.#_h?St.showError(j.getText("AllManeuverNotesBuilder - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:this.#_h,maxManeuversNotes:t.note.maxManeuversNotes})):new Ds({title:j.getText("AllManeuverNotesBuilder - Add a note for each maneuver"),text:j.getText("AllManeuverNotesBuilder - Add a note for each maneuver. Are you sure?",{noteLength:this.#_h}),secondButtonText:"❌"}).show().then((()=>this.#Kh())).catch((t=>{t instanceof Error&&console.error(t)}))}}class Os extends ye{#hs=null;constructor(t,e){super(t,e),this.#hs=Ft.getRoute(this.targetObjId)}get menuItems(){return[new we(j.getText("RouteContextMenu - Edit this route"),this.targetObjId!==U.travel.editedRoute.objId&&l.editedChanged!==U.travel.editedRoute.editionStatus,(()=>xo.editRoute(this.targetObjId))),new we(j.getText("RouteContextMenu - Delete this route"),this.targetObjId!==U.travel.editedRoute.objId||l.editedChanged!==U.travel.editedRoute.editionStatus,(()=>xo.removeRoute(this.targetObjId))),new we(j.getText(this.#hs.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),this.#hs.hidden||U.travel.editedRoute.objId!==this.targetObjId,(()=>{this.#hs.hidden?xo.showRoute(this.targetObjId):xo.hideRoute(this.targetObjId)})),new we(j.getText("RouteContextMenu - Properties"),!this.#hs.hidden,(()=>xo.routeProperties(this.targetObjId))),new we(j.getText("RouteContextMenu - Zoom to route"),!this.#hs.hidden,(()=>(new ao).zoomToRoute(this.targetObjId))),new we(j.getText("RouteContextMenu - View the elevation"),this.#hs.itinerary.hasProfile,(()=>vo.showProfile(this.targetObjId))),new we(j.getText("RouteContextMenu - Print route map"),t.printRouteMap.isEnabled,(()=>xo.printRouteMap(this.targetObjId))),new we(j.getText("RouteContextMenu - Save this route in a GPX file"),0<this.#hs.itinerary.itineraryPoints.length,(()=>xo.saveGpx(this.targetObjId))),new we(j.getText("RouteContextMenu - Invert waypoints"),U.travel.editedRoute.objId===this.targetObjId,(()=>gs.reverseWayPoints())),new we(j.getText("RouteContextMenu - Add a note on the route"),!this.haveParentNode,(()=>ro.newRouteNote(this.targetObjId,this.latLng))),new we(j.getText("RouteContextMenu - Create a note for each route maneuver"),!this.#hs.hidden,(()=>(new xs).addAllManeuverNotes(this.targetObjId))),new we(j.getText("RouteContextMenu - Save modifications on this route"),U.travel.editedRoute.objId===this.targetObjId,(()=>xo.saveEdition())),new we(j.getText("RouteContextMenu - Cancel modifications on this route"),U.travel.editedRoute.objId===this.targetObjId,(()=>xo.cancelEdition()))]}}class js{constructor(){Object.freeze(this)}handleEvent(t){t.stopPropagation(),U.travel.name=O.sanitizeToJsString(t.target.value),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name),Pt.dispatch("updateroadbook")}}class Ss extends qo{#Uh=null;#Vh=null;constructor(){super(t.travelPropertiesDialog.dialogX,t.travelPropertiesDialog.dialogY)}createContentHTML(){this.#Uh=new $t(j.getText("TravelPropertiesDialog - Name"),{controlInput:new js}),this.#Uh.value=U.travel.name,this.#Vh=new ws(Zo.routeDropped,Os,j.getText("TravelPropertiesDialog - Routes"))}get contentHTMLElements(){return[this.#Uh.controlHTMLElement,this.#Vh.controlHTMLElement]}get title(){return j.getText("TravelPropertiesDialog - Travel properties")}#fs(t,e){const o=(t.editionStatus===l.notEdited?"":"🔴 ")+(t.chain?"⛓ ":"")+(t.objId===U.editedRouteObjId?U.travel.editedRoute.computedName:t.computedName);e.push(W.create("div",{textContent:o,dataset:{ObjId:String(t.objId)}}))}updateContent(){if(!this.#Vh)return;const t=[];U.travel.routes.forEach((e=>{e.objId===U.editedRouteObjId?this.#fs(U.travel.editedRoute,t):this.#fs(e,t)})),this.#Vh.updateContent(t),this.#Uh.value=U.travel.name}}class Hs extends ye{#hs;constructor(t,e){super(t,e),this.#hs=Ft.getNoteAndRoute(this.targetObjId).route}get menuItems(){return[new we(j.getText("NoteContextMenu - Edit this note"),!0,(()=>ro.editNote(this.targetObjId))),new we(j.getText("NoteContextMenu - Delete this note"),!0,(()=>ro.removeNote(this.targetObjId))),new we(j.getText("NoteContextMenu - Zoom to note"),!0,(()=>(new ao).zoomToNote(this.targetObjId))),new we(j.getText(this.#hs?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),g===U.editedRouteObjId,(()=>{this.#hs?ro.detachNoteFromRoute(this.targetObjId):ro.attachNoteToRoute(this.targetObjId)}))]}}class Ps extends qo{#Wh;constructor(){super(t.travelNotesDialog.dialogX,t.travelNotesDialog.dialogY)}createContentHTML(){this.#Wh=new ws(ro.travelNoteDropped,Hs)}get contentHTMLElements(){return[this.#Wh.controlHTMLElement]}get title(){return j.getText("TravelNotesDialog - Travel notes dialog")}updateContent(){if(!this.#Wh)return;let t=Fe.getTravelNotesHTML("TravelNotes-TravelNotesDialog-");this.#Wh.updateContent(Array.from(t.childNodes))}}const Rs=new class{#Xh=null;#Yh=null;#Gh=null;constructor(){Object.freeze(this)}get osmSearchDialog(){return this.#Xh||(this.#Xh=new Cs(t.osmSearchDialog.dialogX,t.osmSearchDialog.dialogY)),this.#Xh}get travelPropertiesDialog(){return this.#Yh||(this.#Yh=new Ss(t.travelPropertiesDialog.dialogX,t.travelPropertiesDialog.dialogY)),this.#Yh}get travelNotesDialog(){return this.#Gh||(this.#Gh=new Ps(t.travelNotesDialog.dialogX,t.travelNotesDialog.dialogY)),this.#Gh}showTravelProperties(){this.travelPropertiesDialog.show(),this.travelPropertiesDialog.mover.centerDialog()}};const As=new class{#Xo;#Go=null;hide(){this.#Go&&(clearTimeout(this.#Go),this.#Go=null),this.#Xo.removeEventListener("click",this.toggle,!1),document.body.removeChild(this.#Xo)}constructor(){Object.freeze(this)}async toggle(){document.fullscreenElement?await document.exitFullscreen():await document.body.requestFullscreen()}show(){const e=t.FullScreenUI.timeOut;0===e||!document.fullscreenEnabled||document.body.clientWidth>t.FullScreenUI.screenMaxWidth||(this.#Xo=W.create("div",{id:"TravelNotes-FullScreenUI",textContent:j.getText("FullScreenUI - start full screen")},document.body),this.#Xo.addEventListener("click",this.toggle,!1),this.#Go=setTimeout((()=>this.hide()),e))}};const Bs=new class{#Zh;constructor(){Object.freeze(this),this.#Zh=null}increment(){this.#Zh||(this.#Zh=t.fontSize.initialValue),this.#Zh+=t.fontSize.incrementValue,document.body.style["font-size"]=String(this.#Zh)+"mm"}decrement(){this.#Zh||(this.#Zh=t.fontSize.initialValue),this.#Zh-=t.fontSize.incrementValue,document.body.style["font-size"]=String(this.#Zh)+"mm"}};class ks{#Jh;#Pt;#hs;#qh;#$h(t){let e=new A;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const o=t.childNodes;for(let t=0;t<o.length;t++)if("ele"===o[t].nodeName)e.elev=Number.parseFloat(o[t].textContent),0!==e.elev&&(this.#hs.itinerary.hasProfile=!0);this.#hs.itinerary.itineraryPoints.add(e)}#Qh(t){const e=t.childNodes;for(let t=0;t<e.length;t++)if("trkpt"===e[t].nodeName)this.#$h(e[t])}#tu(){let t=0,e=0,o=this.#hs.itinerary.itineraryPoints.iterator;for(o.done;!o.done;){let s=o.value.elev-o.previous.elev;0>s?e-=s:t+=s}this.#hs.itinerary.ascent=t,this.#hs.itinerary.descent=e}#eu(t){this.#hs=new _;const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.#hs.name=e[t].textContent;break;case"trkseg":this.#Qh(e[t])}this.#hs.itinerary.hasProfile&&this.#tu(),this.#Pt.routes.add(this.#hs)}#ou(t){let e=Number.MAX_VALUE,o=g;return this.#hs.itinerary.itineraryPoints.forEach((s=>{const i=At.pointsDistance(t,s.latLng);i<e&&(e=i,o=s.objId)})),o}#su(t){const e=new B;e.iconName="kUndefined";const o=Number.parseFloat(t.getAttributeNS(null,"lat")),s=Number.parseFloat(t.getAttributeNS(null,"lon"));e.itineraryPointObjId=this.#ou([o,s]);const i=t.childNodes;for(let t=0;t<i.length;t++)if("desc"===i[t].nodeName)e.instruction=i[t].textContent;this.#hs.itinerary.maneuvers.add(e)}#iu(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.#hs.name=e[t].textContent;break;case"rtept":this.#su(e[t])}}#nu(t){const e=new F;e.latLng=t.latLng,e.iconLatLng=t.latLng;const o=t.name.split("+");e.iconContent='<div class="TravelNotes-MapNote TravelNotes-MapNoteCategory-0073"><svg viewBox="0 0 20 20"><text x="10" y="14">'+o[0]+"</text></svg></div>",e.tooltipContent=j.getText("GpxParser - Network node")+o[0],o[1]&&(e.tooltipContent+=j.getText("GpxParser - Go to network node")+o[1]),e.distance=ot.getClosestLatLngDistance(this.#hs,e.latLng).distance,this.#hs.notes.add(e)}#ru(t){let e=new R;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const o=t.childNodes;for(let t=0;t<o.length;t++)if("name"===o[t].nodeName)e.name=o[t].textContent;this.#hs.wayPoints.add(e),this.#qh&&this.#nu(e)}#au(t){for(let e=0;e<t.length;e++)this.#ru(t[e])}#lu(){this.#Pt.routes.forEach((t=>{t.wayPoints.remove(t.wayPoints.first.objId),t.wayPoints.remove(t.wayPoints.last.objId);const e=new R;e.latLng=t.itinerary.itineraryPoints.first.latLng,t.wayPoints.add(e);const o=new R;o.latLng=t.itinerary.itineraryPoints.last.latLng,t.wayPoints.add(o)}))}#_c(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;e.done;let i=s.done;for(i||(s.value.distance=o.defaultValue,i=s.done),t.distance=o.defaultValue,t.duration=o.defaultValue;!e.done;)e.previous.distance=At.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,i||(s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=o.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(i=s.done,s.value.distance=o.defaultValue),i=s.done))}constructor(){Object.freeze(this)}parse(t){this.#Jh=(new DOMParser).parseFromString(t,"text/xml"),this.#qh=Boolean(this.#Jh.querySelector("gpx").getAttributeNS(null,"creator").match(/fietsnet|knooppuntnet/g)),this.#Pt=new z,this.#Pt.routes.remove(this.#Pt.routes.first.objId);const e=this.#Jh.querySelectorAll("trk");for(let t=0;t<e.length;t++)this.#eu(e[t]);const o=this.#Jh.querySelectorAll("rte");1===o.length&&1===this.#Pt.routes.length&&this.#iu(o[0]),this.#Pt.routes.forEach((t=>this.#_c(t)));const s=this.#Jh.querySelectorAll("wpt");return 0<s.length&&1===this.#Pt.routes.length?(this.#hs.wayPoints.remove(this.#hs.wayPoints.first.objId),this.#hs.wayPoints.remove(this.#hs.wayPoints.last.objId),this.#au(s)):this.#lu(),this.#Pt}}class Fs{#du(){Pt.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name);const t=U.travel.routes.iterator;for(;!t.done;)l.notEdited===t.value.editionStatus&&Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:t.value.objId});g!==U.editedRouteObjId&&Pt.dispatch("routeupdated",{removedRouteObjId:g,addedRouteObjId:U.travel.editedRoute.objId});const e=U.travel.notes.iterator;for(;!e.done;)Pt.dispatch("noteupdated",{removedNoteObjId:g,addedNoteObjId:e.value.objId});if(Pt.dispatch("updatetravelnotes"),(new ao).zoomToTravel(),Po.setMapLayer(U.travel.layerName),g!==U.editedRouteObjId){const t=U.travel.editedRoute.itinerary.provider;if(""===t||U.providers.get(t.toLowerCase())){Pt.dispatch("setprovider",{provider:t});const e=U.travel.editedRoute.itinerary.transitMode;""!==e&&Pt.dispatch("settransitmode",{transitMode:e})}else St.showError(j.getText("FileLoader - Not possible to select as provider",{provider:t}))}xo.chainRoutes(),Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook")}constructor(){Object.freeze(this)}openLocalGpxFile(t){vo.deleteAllProfiles(),U.travel.jsonObject=(new ks).parse(t).jsonObject,U.editedRouteObjId=g,this.#du(),Vo.saveStatus=d.saved}openLocalTrvFile(t){vo.deleteAllProfiles();const e=JSON.parse(t);(new jo).decompress(e),U.travel.jsonObject=e,U.editedRouteObjId=g,U.travel.routes.forEach((t=>{l.notEdited!==t.editionStatus&&(U.editedRouteObjId=t.objId)})),this.#du(),Vo.saveStatus=d.saved}#cu(t){const e=t.routes.iterator;for(;!e.done;)U.travel.routes.add(e.value);const o=t.notes.iterator;for(;!o.done;)U.travel.notes.add(o.value);this.#du(),Vo.saveStatus=d.modified}mergeLocalGpxFile(t){this.#cu((new ks).parse(t))}mergeLocalTrvFile(t){const e=JSON.parse(t);(new jo).decompress(e);const o=new z;o.jsonObject=e,this.#cu(o)}}class _s{constructor(){Object.freeze(this)}handleEvent(e){e.stopPropagation();const o=e.target.files[0].name,s=o.split(".").pop().toLowerCase(),i=new FileReader;i.onload=()=>{try{T!==t.files.openTaN.indexOf(s)?(new Fs).openLocalTrvFile(i.result):T!==t.files.openGpx.indexOf(s)&&(new Fs).openLocalGpxFile(i.result)}catch(t){t instanceof Error&&(console.error(t),St.showError("An error occurs when reading the file "+o))}},i.readAsText(e.target.files[0])}}class zs{constructor(){Object.freeze(this)}handleEvent(e){e.stopPropagation();const o=e.target.files[0].name,s=o.split(".").pop().toLowerCase(),i=new FileReader;i.onload=()=>{try{T!==t.files.openTaN.indexOf(s)?(new Fs).mergeLocalTrvFile(i.result):T!==t.files.openGpx.indexOf(s)&&(new Fs).mergeLocalGpxFile(i.result)}catch(t){t instanceof Error&&(console.error(t),St.showError("An error occurs when reading the file "+o))}},i.readAsText(e.target.files[0])}}const Ks=new class extends _o{constructor(){super()}createUI(){super.createUI("Travel & Notes",c.topRight)}addToolbarItems(){this.addToolbarItem(new zo("🏠","Home",window.location.origin)),this.addToolbarItem(new zo("?","Help","https://wwwouaiebe.github.io/TravelNotes/userGuides/README.html#")),this.addToolbarItem(new zo("@","Contact",t.TravelNotesToolbar.contactMail.url||window.location.origin)),t.ApiKeysDialog.showButton&&this.addToolbarItem(new zo("🔑",j.getText("TravelNotesToolbar - api keys"),(()=>{Rt.setKeysFromDialog()}))),this.addToolbarItem(Xo.status===i.active?new zo("🏀",j.getText("TravelNotesToolbar - Stop Geo location"),(()=>{Xo.switch()})):new zo("🌐",j.getText("TravelNotesToolbar - Start Geo location"),(()=>{Xo.switch()})));const e=ct.isTouch?t.files.writeTouch:t.files.writeOthers;this.addToolbarItem(new zo("☢️",j.getText("TravelNotesToolbar - Save as travel",{extension:e}),(()=>{Zo.saveAsTravel()}))),this.addToolbarItem(new zo("❌",j.getText("TravelNotesToolbar - Cancel travel"),(()=>{Zo.newTravel(),document.title="Travel & Notes"+(""===U.travel.name?"":" - "+U.travel.name)}))),this.addToolbarItem(new zo("💾",j.getText("TravelNotesToolbar - Save travel",{extension:e}),(()=>{Zo.saveTravel()})));const o=Object.seal({openTaN:"",openGpx:""});t.files.openTaN.forEach((t=>o.openTaN+="."+t+",")),t.files.openGpx.forEach((t=>o.openGpx+="."+t+","));const s=(o.openTaN+o.openGpx).slice(0,-1);o.openTaN=o.openTaN.slice(0,-1),o.openGpx=o.openGpx.slice(0,-1),o.openTaN.replaceAll(",",", "),o.openGpx.replaceAll(",",", "),this.addToolbarItem(new zo("📂",j.getText("TravelNotesToolbar - Open travel",o),(()=>{t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(j.getText("TravelNotesToolbar - This page ask to close; data are perhaps not saved."))||S.openFile(new _s,s)}))),this.addToolbarItem(new zo("🌏",j.getText("TravelNotesToolbar - Import travel",o),(()=>{g===U.editedRouteObjId?S.openFile(new zs,s):St.showError(j.getText("TravelNotesToolbar - Not possible to merge a travel when a route is edited"))}))),this.addToolbarItem(new zo("📙",j.getText("TravelNotesToolbar - Open travel roadbook"),"TravelNotesRoadbook.html?lng="+t.travelNotes.language+"&page="+U.UUID)),this.addToolbarItem(new zo("🛄",j.getText("TravelNotesToolbar - Travel properties"),(()=>{Rs.travelPropertiesDialog.show()}))),this.addToolbarItem(new zo("🗨️",j.getText("TravelNotesToolbar - Travel notes"),(()=>{Rs.travelNotesDialog.show()}))),this.addToolbarItem(new zo("🔍",j.getText("Search with OpenStreetMap"),(()=>{Rs.osmSearchDialog.show()}))),document.fullscreenEnabled&&this.addToolbarItem(document.fullscreenElement?new zo("🔻",j.getText("TravelNotesToolbar - disable fullscreen"),(()=>As.toggle())):new zo("🔺",j.getText("TravelNotesToolbar - enable fullscreen"),(()=>As.toggle()))),this.addToolbarItem(new zo("+",j.getText("TravelNotesToolbar - Increment the font size"),(()=>{Bs.increment()}))),this.addToolbarItem(new zo("-",j.getText("TravelNotesToolbar - Decrement the font size"),(()=>{Bs.decrement()}))),this.addToolbarItem(new zo("🛠️",j.getText("TravelNotesToolbar - About Travel & Notes"),(()=>(new Wo).show())))}};class Us{#hu;#it;#uu;static get#mu(){return Object.freeze({bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625 H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /> </svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /> </g> </svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"> <path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"> <rect x="1" y="10" width="2" height="3" /> <rect x="11" y="10" width="2" height="3" /> </g> </g> </svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"> <path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2= "11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1= "16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'})}constructor(t,e){Object.freeze(this),this.#hu=t,this.#it=e,this.#uu=W.create("img",{src:Us.#mu[e],id:"TravelNotes-ProvidersToolbar-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbar-ImgButton",title:j.getText("ProvidersToolbar - TransitMode "+e)}),this.#uu.addEventListener("click",this),this.visible=!1}handleEvent(t){t.stopPropagation(),this.#hu.transitMode=this.#it,this.#hu.hide(),ps.startRouting()}get buttonHTMLElement(){return this.#uu}get transitMode(){return this.#it}set active(t){t?this.#uu.classList.add("TravelNotes-ProvidersToolbar-ActiveTransitModeImgButton"):this.#uu.classList.remove("TravelNotes-ProvidersToolbar-ActiveTransitModeImgButton")}set visible(t){t?this.#uu.classList.remove("TravelNotes-Hidden"):this.#uu.classList.add("TravelNotes-Hidden")}}class Vs{#hu;#st;#uu;constructor(t,e){Object.freeze(this),this.#hu=t,this.#st=e,this.#uu=W.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbar-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbar-ImgButton",title:e.title||e.name}),this.#uu.addEventListener("click",this)}handleEvent(t){t.stopPropagation(),this.#hu.provider=this.#st.name,ps.startRouting()}get buttonHTMLElement(){return this.#uu}get provider(){return this.#st}set active(t){t?this.#uu.classList.add("TravelNotes-ProvidersToolbar-ActiveProviderImgButton"):this.#uu.classList.remove("TravelNotes-ProvidersToolbar-ActiveProviderImgButton")}}class Ws{#Eo;#pu;#ud;#gu;#vu;#Tu;#Lu;#Go;#Td;static get#Eu(){return 100}static get#Ld(){return 100}#bu(){["bike","pedestrian","car","train","line","circle"].forEach((t=>{const e=new Us(this,t);this.#gu.set(t,e),this.#ud.appendChild(e.buttonHTMLElement)}))}#yu(){U.providers.forEach((t=>{if(!t.providerKeyNeeded||Rt.hasKey(t.name)){const e=new Vs(this,t);this.#vu.set(t.name,e),this.#ud.appendChild(e.buttonHTMLElement)}}))}#Qe(){this.#wu(),this.#Td=!0,setTimeout((()=>this.#fu()),Ws.#Eu)}#fu(){this.#ud.classList.remove("TravelNotes-Hidden")}#Ed;#Mu(t){Ws.#Ld>t.timeStamp-this.#Ed||this.#Iu(t)}#Iu(t){if(this.#Ed=t.timeStamp,this.#Td){if(this.#Go)return clearTimeout(this.#Go),void(this.#Go=null);this.hide()}else this.#Qe()}#Nu(){this.#Td&&(this.#Go=setTimeout((()=>this.hide()),t.toolbars.timeOut))}#wu(){this.#pu.textContent=j.getText("ProvidersToolbar - Computed by {provider} for {transitMode}",{provider:U.routing.provider,transitMode:j.getText("ProvidersToolbar - TransitMode "+U.routing.transitMode)}),this.#Eo.style.left=String((ct.screenAvailable.width-this.#Eo.clientWidth)/2)+"px"}constructor(){Object.freeze(this),this.#gu=new Map,this.#vu=new Map}hide(){this.#Go&&(clearTimeout(this.#Go),this.#Go=null),this.#ud.classList.add("TravelNotes-Hidden"),this.#wu(),this.#Td=!1}createUI(){this.#Eo=W.create("div",{id:"TravelNotes-ProvidersToolbar-Container"},document.body),this.#Eo.addEventListener("mouseenter",(t=>this.#Iu(t)),!1),this.#Eo.addEventListener("mouseleave",(t=>this.#Nu(t)),!1),this.#pu=W.create("div",{className:"TravelNotes-ProvidersToolbar-TopBar",textContent:j.getText("TravelNotes-ProvidersToolbar - Providers")},this.#Eo),this.#pu.addEventListener("click",(t=>this.#Mu(t)),!1),this.#ud=W.create("div",{className:"TravelNotes-ProvidersToolbar-ImgButtonsDiv TravelNotes-Hidden"},this.#Eo),this.#bu(),this.#yu(),this.provider=this.#vu.keys().next().value,this.#wu()}set provider(t){U.routing.provider=t,this.#Lu&&(this.#Lu.active=!1),this.#Lu=this.#vu.get(t),this.#Lu.active=!0;const e=U.providers.get(t.toLowerCase());this.#gu.forEach((t=>{t.visible=T!==e.transitModes.indexOf(t.transitMode)})),this.#Tu&&T!==e.transitModes.indexOf(this.#Tu.transitMode)||(this.#Tu=null,this.#gu.forEach((t=>{this.#Tu||T===e.transitModes.indexOf(t.transitMode)?t.active=!1:(this.#Tu=t,t.active=!0,U.routing.transitMode=t.transitMode)}))),this.#wu()}set transitMode(t){U.routing.transitMode=t,this.#Tu&&(this.#Tu.active=!1),this.#Tu=this.#gu.get(t),this.#Tu.active=!0,this.#wu()}providersAdded(){for(;this.#ud.firstChild;)this.#ud.removeChild(this.#ud.firstChild);this.#gu.clear(),this.#vu.clear(),this.#bu(),this.#yu(),this.provider=this.#vu.keys().next().value;const t=this.#vu.keys().next().value;this.provider=t,this.transitMode=U.providers.get(t.toLowerCase()).transitModes[0],this.#wu()}}const Xs=new Ws;class Ys extends ye{constructor(t,e){super(t,e)}get menuItems(){return[new we(j.getText("MapContextMenu - Select this point as start point"),g!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat,(()=>gs.setStartPoint(this.latLng))),new we(j.getText("MapContextMenu - Select this point as way point"),g!==U.editedRouteObjId,(()=>gs.addWayPoint(this.latLng))),new we(j.getText("MapContextMenu - Select this point as end point"),g!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>gs.setEndPoint(this.latLng))),new we(j.getText("MapContextMenu - Select this point as start and end point"),g!==U.editedRouteObjId&&a.defaultValue===U.travel.editedRoute.wayPoints.first.lat&&a.defaultValue===U.travel.editedRoute.wayPoints.last.lat,(()=>gs.setStartAndEndPoint(this.latLng))),new we(j.getText("MapContextMenu - Add a route"),!0,(()=>xo.addRoute())),new we(j.getText("MapContextMenu - Hide all routes"),!0,(()=>xo.hideRoutes())),new we(j.getText("MapContextMenu - Show all routes"),!0,(()=>xo.showRoutes())),new we(j.getText("MapContextMenu - New travel note"),!0,(()=>ro.newTravelNote(this.latLng))),new we(j.getText("MapContextMenu - Hide all notes"),!0,(()=>ro.hideNotes())),new we(j.getText("MapContextMenu - Show all notes"),!0,(()=>ro.showNotes())),new we(j.getText("MapContextMenu - Zoom to travel"),!0,(()=>(new ao).zoomToTravel()))]}}class Gs{static handleEvent(){window.L.DomEvent.off(Co.marker,"mouseout",Do.handleEvent)}}class Zs{static handleEvent(t){t.latlng.lat=Co.initialLatLng[0],t.latlng.lng=Co.initialLatLng[1],t.target.objId=U.travel.editedRoute.objId,new Os(t).show()}}class Js{static handleEvent(t){U.mapObjects.get(U.travel.editedRoute.objId).openPopup(t.latlng)}}class qs{static handleEvent(t){gs.addWayPointOnRoute(Co.initialLatLng,[t.target.getLatLng().lat,t.target.getLatLng().lng]),Co.marker&&(window.L.DomEvent.off(Co.marker,"dragstart",Gs.handleEvent),window.L.DomEvent.off(Co.marker,"dragend",qs.handleEvent),window.L.DomEvent.off(Co.marker,"contextmenu",Zs.handleEvent),U.map.removeLayer(Co.marker),Co.marker=null)}}class $s{static#Cu=1;static handleEvent(e){const o=Ft.getRoute(e.target.objId);if(Co.initialLatLng=[e.latlng.lat,e.latlng.lng],Co.marker)Co.marker.setLatLng(e.latlng);else{Co.marker=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[E,E],iconAnchor:[10,E],html:'<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>',className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});let s="";(T===t.route.showDragTooltip||$s.#Cu<=t.route.showDragTooltip)&&($s.#Cu++,s=j.getText("EditedRouteMouseOverEL - Drag and drop to add a waypoint")+" - "),s+=o.computedName+" - ";let i=ot.getClosestLatLngDistance(o,[e.latlng.lat,e.latlng.lng]).distance;i+=o.chainedDistance,s+=S.formatDistance(i),Co.marker.bindTooltip(s),Co.marker.getTooltip().options.offset=[0,0],Co.marker.addTo(U.map),window.L.DomEvent.on(Co.marker,"mouseout",Do.handleEvent),window.L.DomEvent.on(Co.marker,"dragstart",Gs.handleEvent),window.L.DomEvent.on(Co.marker,"dragend",qs.handleEvent),window.L.DomEvent.on(Co.marker,"contextmenu",Zs.handleEvent),window.L.DomEvent.on(Co.marker,"click",Js.handleEvent)}}}class Qs{static createFakeEvent(e){const o=Ft.getNearestRouteData([e.latlng.lat,e.latlng.lng]);if(!o.route)return;const s=window.L.latLng(o.latLngOnRoute[0],o.latLngOnRoute[1]),i=U.map.latLngToContainerPoint(s);return i.distanceTo(e.containerPoint)>(ct.isTouch?t.mapContextMenu.touchMaxRouteDistance:t.mapContextMenu.mouseMaxRouteDistance)?void 0:Object.freeze({clientX:i.x,clientY:i.y,latlng:s,target:o.route})}static handleClickEvent(t){const e=Qs.createFakeEvent(t);e&&ct.isTouch&&e.target.editionStatus!==l.notEdited&&$s.handleEvent(e)}static handleContextMenuEvent(t){const e=Qs.createFakeEvent(t);e?new Os(e).show():new Ys(t).show()}}const ti=new class{#Du=!1;constructor(){Object.freeze(this)}async addReadOnlyTravel(t){if(this.#Du)return;this.#Du=!0,Ho.createUI(),Po.setMapLayer("OSM - Color");const e=await fetch(t);p===e.status&&e.ok?(new So).openDistantFile(await e.json()):(U.map.setView([a.defaultValue,a.defaultValue],2),document.title="Travel & Notes")}addToolbarsMenusUIs(){this.#Du||(this.#Du=!0,document.title="Travel & Notes",U.map.on("contextmenu",Qs.handleContextMenuEvent),U.map.on("click",Qs.handleClickEvent),U.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),Ho.createUI(),Vo.createUI(),Vo.saveStatus=d.saved,St.showHelp("<p>"+j.getText("Help - Continue with interface1")+"</p><p>"+j.getText("Help - Continue with interface2")+"</p>"),Ko.createUI(),Po.setMapLayer("OSM - Color"),Ks.createUI(),Xs.createUI(),Rt.setKeysFromServerFile(),U.travel.jsonObject=(new z).jsonObject,t.travelNotes.startupRouteEdition&&xo.editRoute(U.travel.routes.first.objId),Pt.dispatch("updatetravelproperties"),Pt.dispatch("updateroadbook"),As.show())}addProvider(t){Rt.addProvider(t)}showInfo(t){St.showInfo(t)}get overpassApiUrl(){return t.overpassApi.url}get map(){return U.map}get version(){return w}};class ei{#xu(t,e){if("object"==typeof t&&"object"==typeof e){for(const o in e)"object"==typeof e[o]?this.#xu(t[o],e[o]):typeof t[o]==typeof e[o]&&("string"==typeof e[o]?e[o]="color"===o?O.sanitizeToColor(t[o])||e[o]:"url"===o?O.sanitizeToUrl(t[o]).url:O.sanitizeToJsString(t[o]):e[o]=t[o]||e[o]);for(const o in t)"object"==typeof t[o]?("[object Array]"===Object.prototype.toString.call(t[o])?e[o]=e[o]||[]:e[o]=e[o]||{},this.#xu(t[o],e[o])):"string"==typeof e.property?e[o]=O.sanitizeToHtmlString(t[o],[]).htmlString:e[o]=t[o]}}#Ou(t){for(const e in t)"object"==typeof t[e]&&this.#Ou(t[e]);Object.freeze(t)}constructor(){Object.freeze(this)}overload(e){this.#xu(e,t),this.#Ou(t)}}const oi=new class{#ju(t,e){const s=W.create("div"),i=W.create("div",{className:t+"Route-ManeuversAndNotes-IconCell"},s);W.create("div",{className:"TravelNotes-ManeuverNote TravelNotes-ManeuverNote-"+e.maneuver.iconName},i),i.dataset.tanWidth=String(n.width)+"px",i.dataset.tanHeight=String(n.height)+"px";const r=W.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},s);return W.create("div",{className:t+"Route-Maneuver-TooltipContent",textContent:j.getText("RouteHTMLViewsFactory - "+e.maneuver.iconName)},r),O.sanitizeToHtmlElement(e.maneuver.instruction,W.create("div",{className:t+"Route-Maneuver-Instruction"},r)),e.route.chain&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+S.formatDistance(e.route.chainedDistance+e.maneuverDistance),W.create("div",{className:t+"Route-Maneuver-TravelDistance"},r)),O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+S.formatDistance(e.maneuverDistance),W.create("div",{className:t+"Route-Maneuver-RouteDistance"},r)),o.defaultValue<e.maneuver.distance&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+S.formatDistance(e.maneuver.distance),W.create("div",{className:t+"Route-Maneuver-NextDistance"},r)),s}constructor(){Object.freeze(this)}getRouteProfileHTML(t,e){const o=W.create("div",{className:t+"RouteProfile"});return O.sanitizeToHtmlElement(j.getText("RouteHTMLViewsFactory - Profile"),o),o.appendChild((new he).createSvg(e)),o}getRouteManeuversAndNotesHTML(t,e,o){const s=[],i=e.notes.iterator;for(;!i.done;)s.push({data:i.value,distance:i.value.distance});const n=e.itinerary.maneuvers.iterator;let r=0;for(;!n.done;)s.push({data:n.value,distance:r}),r+=n.value.distance;s.sort(((t,e)=>t.distance-e.distance));const a=W.create("div",{className:t+"Route-ManeuversAndNotes"});return s.forEach((s=>{let i=null;"Note"===s.data.objType.name?(i=Fe.getNoteTextAndIconHTML(t,{note:s.data,route:e}),i.className=t+"Route-Notes-Row"):(i=this.#ju(t,{route:e,maneuver:s.data,maneuverDistance:s.distance}),i.className=t+"Route-Maneuvers-Row"),o&&(i.dataset.tanObjId=s.data.objId,i.dataset.tanMarkerObjId=b.nextObjId,i.dataset.tanObjType=s.data.objType.name),a.appendChild(i)})),a}getRouteHeaderHTML(t,e){const o=W.create("div",{className:t+"Route-Header",id:"route"+e.objId});return O.sanitizeToHtmlElement(e.computedName,W.create("div",{className:t+"Route-Header-Name"},o)),0!==e.distance&&O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+S.formatDistance(e.distance),W.create("div",{className:t+"Route-Header-Distance"},o)),U.travel.readOnly||"bike"===e.itinerary.transitMode||O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+S.formatTime(e.duration),W.create("div",{className:t+"Route-Header-Duration"},o)),e.itinerary.hasProfile&&(O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(e.itinerary.ascent.toFixed(0))+" m.",W.create("div",{className:t+"Route-Header-Ascent"},o)),O.sanitizeToHtmlElement("<span>"+j.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(e.itinerary.descent.toFixed(0))+" m.",W.create("div",{className:t+"Route-Header-Descent"},o))),o}getRouteFooterHTML(t,e){let o=""!==e.itinerary.provider&&""!==e.itinerary.transitMode?j.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:j.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}):"";const s=W.create("div",{className:t+"RouteFooter"});return O.sanitizeToHtmlElement(o,s),s}};class si{static handleEvent(t){const e=Ft.getRoute(t.target.objId);let o=ot.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;o+=e.chainedDistance,o=S.formatDistance(o);const s=U.mapObjects.get(t.target.objId);s.closeTooltip();let i=e.computedName;U.travel.readOnly||(i+=0===i.length?"":" - ",i+=o),s.setTooltipContent(i),s.openTooltip(t.latlng)}}class ii{#Pa;#Su;#Hu;constructor(t,e,o){Object.freeze(this),this.#Pa=t,this.#Su=e,this.#Hu=o}get marker(){return this.#Pa}get polyline(){return this.#Su}get bullet(){return this.#Hu}}class ni{#Pu;#Ru;static get#Au(){return 18}static get#Bu(){return 0}static get#ku(){return 100}constructor(){Object.freeze(this),this.#Pu=null,this.#Ru=null}addToMap(t,e){e.objId=t,e.addTo(U.map),U.mapObjects.set(t,e)}addRoute(t){const e=Ft.getRoute(t),o=[],s=e.itinerary.itineraryPoints.iterator;for(;!s.done;)o.push(s.value.latLng);const i=window.L.polyline(o,{color:e.color,weight:e.width,dashArray:e.dashString});this.addToMap(e.objId,i),l.notEdited===e.editionStatus&&(i.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),ct.isTouch||(window.L.DomEvent.on(i,"mouseover",si.handleEvent),window.L.DomEvent.on(i,"mousemove",si.handleEvent),i.bindPopup((t=>O.clone(oi.getRouteHeaderHTML("TravelNotes-Map-",Ft.getRoute(t.objId))))),window.L.DomEvent.on(i,"click",(t=>t.target.openPopup(t.latlng)))));const n=e.notes.iterator;for(;!n.done;)this.addNote(n.value.objId);return e}addNote(e){const o=Ft.getNoteAndRoute(e).note,s=window.L.marker(o.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!U.travel.readOnly});s.objId=o.objId;const i=window.L.marker(o.iconLatLng,{zIndexOffset:ni.#ku,icon:window.L.divIcon({iconSize:[o.iconWidth,o.iconHeight],iconAnchor:[o.iconWidth/2,o.iconHeight/2],popupAnchor:[0,-o.iconHeight/2],html:o.iconContent,className:"TravelNotes-Map-AllNotes "}),draggable:!U.travel.readOnly});i.objId=o.objId,i.bindPopup((t=>O.clone(Fe.getNoteTextHTML("TravelNotes-Map-",Ft.getNoteAndRoute(t.objId))))),0!==o.tooltipContent.length&&(i.bindTooltip((t=>Ft.getNoteAndRoute(t.objId).note.tooltipContent)),i.getTooltip().options.offset[0]=o.iconWidth/2);const n=window.L.polyline([o.latLng,o.iconLatLng],t.note.polyline);n.objId=o.objId;const r=window.L.layerGroup([i,n,s]);return r.markerId=window.L.Util.stamp(i),r.polylineId=window.L.Util.stamp(n),r.bulletId=window.L.Util.stamp(s),this.addToMap(o.objId,r),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),new ii(i,n,s)}zoomTo(e,o){if(o){let t=[];o.forEach((e=>t=t.concat(e))),U.map.fitBounds(ot.getLatLngBounds(t))}else U.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){const o="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);this.#Pu&&U.map.removeLayer(this.#Pu),U.map.addLayer(o),this.#Pu=o,U.travel.readOnly||(U.map.getZoom()<(t.minZoom||ni.#Bu)&&U.map.setZoom(t.minZoom||ni.#Bu),U.map.setMinZoom(t.minZoom||ni.#Bu),U.map.getZoom()>(t.maxZoom||ni.#Au)&&U.map.setZoom(t.maxZoom||ni.#Au),U.map.setMaxZoom(t.maxZoom||ni.#Au),t.bounds?(U.map.getBounds().intersects(t.bounds)&&!U.map.getBounds().contains(t.bounds)||(U.map.setMaxBounds(null),U.map.fitBounds(t.bounds),U.map.setZoom(t.minZoom||ni.#Bu)),U.map.setMaxBounds(t.bounds)):U.map.setMaxBounds(null)),U.map.fire("baselayerchange",o)}onGeolocationStatusChanged(t){i.active!==t&&this.#Ru&&(U.map.removeLayer(this.#Ru),this.#Ru=null)}onGeolocationPositionChanged(e){let o=t.geoLocation.zoomToPosition;this.#Ru&&(U.map.removeLayer(this.#Ru),o=!1);let s="Position (+/- "+e.coords.accuracy.toFixed(0)+" m) : <br/>"+S.formatLatLngDMS([e.coords.latitude,e.coords.longitude])+"<br/>"+S.formatLatLng([e.coords.latitude,e.coords.longitude])+"<br/>";e.coords.altitude&&(s+="<br/> Altitude  :<br/>"+e.coords.altitude.toFixed(0)+" m",e.coords.altitudeAccuracy&&(s+="(+/- "+e.coords.altitudeAccuracy.toFixed(0)+" m)")),0===t.geoLocation.marker.radius?this.#Ru=window.L.circle(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).setRadius(e.coords.accuracy.toFixed(0)):this.#Ru=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker),this.#Ru.bindTooltip(s).addTo(U.map),t.geoLocation.watch||this.#Ru.bindPopup(s).openPopup(),this.#Ru.on("click",(t=>{const e=t.target.getTooltip().getContent();t.target.getTooltip().setContent(e+"Copied"),navigator.clipboard.writeText(e.replaceAll("<br/>","\n")).then((()=>{t.target.getTooltip().setContent(e+"<br/><br/>"+j.getText("MapEditorViewer -Copied to clipboard"))})).catch((()=>console.error("Failed to copy to clipboard ")))})),o&&U.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class ri{static handleEvent(t){const e=Ft.getNoteAndRoute(t.target.objId),o=e.note,s=e.route,i=U.mapObjects.get(t.target.objId);if(null===s)o.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],Pt.dispatch("updatetravelnotes");else{const e=ot.getClosestLatLngDistance(s,[t.target.getLatLng().lat,t.target.getLatLng().lng]);o.latLng=e.latLng,o.distance=e.distance,s.notes.sort(((t,e)=>t.distance-e.distance)),i.getLayer(i.bulletId).setLatLng(e.latLng)}i.getLayer(i.polylineId).setLatLngs([o.latLng,o.iconLatLng]),Pt.dispatch("updateroadbook")}}class ai{static handleEvent(t){const e=Ft.getNoteAndRoute(t.target.objId).note,o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],e.iconLatLng])}}class li{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}}class di{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}}class ci{static handleEvent(t){new Hs(t).show()}}class hi{static handleEvent(t){const e=Ft.getNoteAndRoute(t.target.objId).note;e.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];const o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([e.latLng,e.iconLatLng])}}class ui{static handleEvent(t){const e=Ft.getNoteAndRoute(t.target.objId).note,o=U.mapObjects.get(t.target.objId);o.getLayer(o.polylineId).setLatLngs([e.latLng,[t.latlng.lat,t.latlng.lng]])}}class mi extends ye{constructor(t,e){super(t,e)}get menuItems(){return[new we(j.getText("WayPointContextMenu - Delete this waypoint"),U.travel.editedRoute.wayPoints.first.objId!==this.targetObjId&&U.travel.editedRoute.wayPoints.last.objId!==this.targetObjId,(()=>gs.removeWayPoint(this.targetObjId))),new we(j.getText("WayPointContextMenu - Modify properties"),!0,(()=>gs.wayPointProperties(this.targetObjId)))]}}class pi{static handleEvent(t){new mi(t).show()}}class gi{static handleEvent(t){gs.wayPointDragEnd(t)}}class vi{static handleEvent(t){window.L.DomEvent.stopPropagation(t),new Os(t).show()}}class Ti extends ni{static get#Fu(){return.01}#_u(t){const e=U.mapObjects.get(t);e&&(window.L.DomEvent.off(e),U.map.removeLayer(e),U.mapObjects.delete(t))}constructor(){super()}updateRoute(t,e){if(g!==t){const e=Ft.getRoute(t);this.#_u(e.objId);const o=e.notes.iterator;for(;!o.done;)this.#_u(o.value.objId);const s=e.wayPoints.iterator;for(;!s.done;)this.#_u(s.value.objId)}if(g!==e){const t=this.addRoute(e),o=U.mapObjects.get(e);if(!U.travel.readOnly){window.L.DomEvent.on(o,"contextmenu",vi.handleEvent),l.notEdited===t.editionStatus||ct.isTouch||window.L.DomEvent.on(o,"mouseover",$s.handleEvent);const e=t.notes.iterator;for(;!e.done;){const t=U.mapObjects.get(e.value.objId),o=t.getLayer(t.markerId),s=t.getLayer(t.bulletId);window.L.DomEvent.on(s,"dragend",ri.handleEvent),window.L.DomEvent.on(s,"drag",ai.handleEvent),window.L.DomEvent.on(s,"mouseenter",li.handleEvent),window.L.DomEvent.on(s,"mouseleave",di.handleEvent),window.L.DomEvent.on(o,"contextmenu",ci.handleEvent),window.L.DomEvent.on(o,"dragend",hi.handleEvent),window.L.DomEvent.on(o,"drag",ui.handleEvent)}}if(!U.travel.readOnly&&l.notEdited!==t.editionStatus){const t=U.travel.editedRoute.wayPoints.iterator;for(;!t.done;)this.addWayPoint(t.value,t.first?"A":t.last?"B":t.index)}}}updateRouteProperties(t){const e=U.mapObjects.get(t),o=Ft.getRoute(t);e.setStyle({color:o.color,weight:o.width,dashArray:o.dashString})}updateNote(t,e){let o=!1;if(g!==t){const e=U.mapObjects.get(t);e&&(o=e.getLayer(e.markerId).isPopupOpen()),this.#_u(t)}if(g!==e){const t=this.addNote(e);o&&t.marker.openPopup(),U.travel.readOnly||(window.L.DomEvent.on(t.bullet,"dragend",ri.handleEvent),window.L.DomEvent.on(t.bullet,"drag",ai.handleEvent),window.L.DomEvent.on(t.bullet,"mouseenter",li.handleEvent),window.L.DomEvent.on(t.bullet,"mouseleave",di.handleEvent),window.L.DomEvent.on(t.marker,"contextmenu",ci.handleEvent),window.L.DomEvent.on(t.marker,"dragend",hi.handleEvent),window.L.DomEvent.on(t.marker,"drag",ui.handleEvent))}}removeObject(t){this.#_u(t)}removeAllObjects(){U.mapObjects.forEach((t=>{window.L.DomEvent.off(t),U.map.removeLayer(t)})),U.mapObjects.clear()}addWayPoint(t,e){if(a.defaultValue===t.lat&&a.defaultValue===t.lng)return;const o='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===e?"Start":"B"===e?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+e+"</div>",s=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[E,E],iconAnchor:[10,E],html:o,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});s.bindTooltip((t=>Ft.getWayPoint(t.objId).fullName)),s.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(s,"contextmenu",pi.handleEvent),s.objId=t.objId,this.addToMap(t.objId,s),window.L.DomEvent.on(s,"dragend",gi.handleEvent)}addItineraryPointMarker(e,o){this.addToMap(e,window.L.circleMarker(o,t.itineraryPoint.marker))}addSearchPointMarker(e,o,s){let i=!1;if(s){let t=[];s.forEach((e=>{t=t.concat(e)}));const e=ot.getLatLngBounds(t),o=U.map.getBounds();i=(e.getEast()-e.getWest())/(o.getEast()-o.getWest())>Ti.#Fu&&(e.getNorth()-e.getSouth())/(o.getNorth()-o.getSouth())>Ti.#Fu}i?this.addToMap(e,window.L.polyline(s,t.osmSearch.searchPointPolyline)):this.addToMap(e,window.L.circleMarker(o,t.osmSearch.searchPointMarker))}addRectangle(t,e,o){this.addToMap(t,window.L.rectangle(e,o))}setLayer(t){const e=Rt.getUrl(t);e&&super.setLayer(t,e)}}const Li=new Ti;class Ei{#zu;#St;#Ku;static get#Uu(){return 1}#Vu(t,e){if(this.#zu)return void t();const o=window.indexedDB.open("TravelNotesDb",Ei.#Uu);o.onerror=()=>{this.#zu=null,e(new Error("Not possible to open the db"))},o.onsuccess=e=>{this.#zu=e.target.result,t()},o.onupgradeneeded=t=>{this.#zu=t.target.result,this.#zu.createObjectStore("Travels",{keyPath:"UUID"})}}#Wu(t,e){if(!this.#zu)return void e(new Error("Database not opened"));const o=this.#zu.transaction(["Travels"],"readonly");o.onerror=()=>e(new Error("Transaction error"));o.objectStore("Travels").get(this.#St).onsuccess=e=>t(e.target.result?e.target.result.data:null)}#Xu(t,e){if(!this.#zu)return void e(new Error("Database not opened"));const o=this.#zu.transaction(["Travels"],"readwrite");o.onerror=()=>e(new Error("Transaction error"));o.objectStore("Travels").put({UUID:this.#St,data:this.#Ku}).onsuccess=()=>t()}#Yu(){this.#zu.close(),this.#zu=null}constructor(){Object.freeze(this)}getOpenPromise(){return new Promise(((t,e)=>this.#Vu(t,e)))}getReadPromise(t){return this.#St=t,new Promise(((t,e)=>this.#Wu(t,e)))}getWritePromise(t,e){return this.#St=t,this.#Ku=e,new Promise(((t,e)=>this.#Xu(t,e)))}closeDb(t){if(!this.#zu)return;if(!t)return void this.#Yu();const e=this.#zu.transaction(["Travels"],"readwrite");e.onerror=()=>{};const o=e.objectStore("Travels").delete(t);o.onerror=()=>this.#Yu(),o.onsuccess=()=>this.#Yu()}}const bi=new Ei;const yi=new class{#Gu(e){const s=W.create("div",{className:e+"Travel-Header"});O.sanitizeToHtmlElement(U.travel.name,W.create("div",{className:e+"Travel-Header-Name"},s));let i=o.defaultValue,n=0,r=0;const a=U.travel.routes.iterator;for(;!a.done;){const o=a.value.objId===U.editedRouteObjId&&t.routeEditor.showEditedRouteInRoadbook?U.travel.editedRoute:a.value;O.sanitizeToHtmlElement('<a href="#route'+o.objId+'" >'+o.computedName+"</a> : "+S.formatDistance(o.distance)+".",W.create("div",{className:e+"Travel-Header-RouteName"},s)),o.chain&&(i+=o.distance,n+=o.itinerary.ascent,r+=o.itinerary.descent)}return O.sanitizeToHtmlElement("<span>"+j.getText("TravelHTMLViewsFactory - Travel distance")+"</span> : "+S.formatDistance(i),W.create("div",{className:e+"Travel-Header-TravelDistance"},s)),0!==n&&O.sanitizeToHtmlElement("<span>"+j.getText("travelHTMLViewsFactory - Travel ascent")+"</span> : "+String(n.toFixed(0))+" m.",W.create("div",{className:e+"Travel-Header-TravelAscent"},s)),0!==r&&O.sanitizeToHtmlElement("<span>"+j.getText("TravelHTMLViewsFactory - Travel descent")+"</span> : "+String(r.toFixed(0))+" m.",W.create("div",{className:e+"Travel-Header-TravelDescent"},s)),s}#Zu(t){const e=j.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 '+new Date(Date.now()).getFullYear()+'</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+j.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",o=W.create("div",{className:t+"TravelFooter"});return O.sanitizeToHtmlElement(e,o),o}constructor(){Object.freeze(this)}getTravelHTML(e){const o=W.create("div",{className:e+"Travel"});o.appendChild(this.#Gu(e)),o.appendChild(Fe.getTravelNotesHTML(e));const s=U.travel.routes.iterator;for(;!s.done;){const i=t.routeEditor.showEditedRouteInRoadbook&&s.value.objId===U.editedRouteObjId?U.travel.editedRoute:s.value;o.appendChild(oi.getRouteHeaderHTML(e,i)),i.itinerary.hasProfile&&o.appendChild(oi.getRouteProfileHTML(e,i)),o.appendChild(oi.getRouteManeuversAndNotesHTML(e,i,!1)),o.appendChild(oi.getRouteFooterHTML(e,i))}return o.appendChild(this.#Zu(e)),o}};class wi{#Ju;constructor(){Object.freeze(this),this.#Ju=S.storageAvailable("localStorage")}handleEvent(){Vo.saveStatus=d.modified,this.#Ju&&bi.getOpenPromise().then((()=>{bi.getWritePromise(U.UUID,yi.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(U.UUID,Date.now()))).catch((t=>{t instanceof Error&&console.error(t)}))}}class fi{static addEventsListeners(){document.addEventListener("additinerarypointmarker",(t=>{t.data&&Li.addItineraryPointMarker(t.data.objId,t.data.latLng)})),document.addEventListener("addrectangle",(t=>{t.data&&Li.addRectangle(t.data.objId,t.data.bounds,t.data.properties)})),document.addEventListener("addsearchpointmarker",(t=>{t.data&&Li.addSearchPointMarker(t.data.objId,t.data.latLng,t.data.geometry)})),document.addEventListener("addwaypoint",(t=>{t.data&&Li.addWayPoint(t.data.wayPoint,t.data.letter)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&Li.onGeolocationPositionChanged(t.data.position)})),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&Li.onGeolocationStatusChanged(t.data.status)})),document.addEventListener("layerchange",(t=>{t.data&&Li.setLayer(t.data.layer)})),document.addEventListener("noteupdated",(t=>{t.data&&Li.updateNote(t.data.removedNoteObjId,t.data.addedNoteObjId)})),document.addEventListener("profileclosed",(t=>{t.data&&vo.onProfileClosed(t.data.objId)})),document.addEventListener("providersadded",(()=>Xs.providersAdded())),document.addEventListener("removeallobjects",(()=>Li.removeAllObjects())),document.addEventListener("removeobject",(t=>{t.data&&Li.removeObject(t.data.objId)})),document.addEventListener("routepropertiesupdated",(t=>{t.data&&Li.updateRouteProperties(t.data.routeObjId)})),document.addEventListener("routeupdated",(t=>{t.data&&Li.updateRoute(t.data.removedRouteObjId,t.data.addedRouteObjId)})),document.addEventListener("setprovider",(t=>{t?.data?.provider&&(Xs.provider=t.data.provider)})),document.addEventListener("settransitmode",(t=>{t?.data?.transitMode&&(Xs.transitMode=t.data.transitMode)})),document.addEventListener("showtravelproperties",(()=>Rs.showTravelProperties())),document.addEventListener("updateosmsearch",(()=>Rs.osmSearchDialog.updateContent())),document.addEventListener("updateroadbook",new wi),document.addEventListener("updatetravelnotes",(()=>Rs.travelNotesDialog.updateContent())),document.addEventListener("updatetravelproperties",(()=>Rs.travelPropertiesDialog.updateContent())),document.addEventListener("zoomto",(t=>{t.data&&Li.zoomTo(t.data.latLng,t.data.geometry)}))}static addUnloadEventsListeners(){window.addEventListener("unload",(()=>localStorage.removeItem(U.UUID))),window.addEventListener("beforeunload",(e=>{if(bi.closeDb(U.UUID),t.travelNotes.haveBeforeUnloadWarning)return e.returnValue="x","x"}))}}(new class{#qu;#$u;#Qu;#tm;#em(){const t=new URL(window.location);let e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");const o=new URL(e);if(!(t.protocol&&o.protocol&&t.protocol===o.protocol&&t.hostname&&o.hostname&&t.hostname===o.hostname))throw new Error("The distant file is not on the same site than the app");this.#qu=encodeURI(o.href)}catch(t){t instanceof Error&&console.error(t)}const o=t.searchParams.get("lng");o&&o.match(/^[A-Z,a-z]{2}$/)&&(this.#$u=o.toLowerCase())}async#om(){const e=await fetch(this.#Qu+"Config.json");if(p===e.status&&e.ok){const o=await e.json();return o.travelNotes.language=this.#$u||o.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(o.ApiKeysDialog.haveUnsecureButtons=!0,o.errorsUI.showHelp=!0,o.mapLayersToolbar.theDevil.addButton=!1,o.note.maxManeuversNotes=12,o.note.haveBackground=!0,o.noteDialog.theDevil.addButton=!1,o.printRouteMap.maxTiles=10,o.route.showDragTooltip=T),(new ei).overload(o),U.providers.forEach((e=>{e.userLanguage=t.travelNotes.language})),!0}return!1}async#sm(t,e){return"fulfilled"===t.status&&p===t.value.status&&t.value.ok?(j.setTranslations(await t.value.json()),!0):"fulfilled"===e.status&&p===e.value.status&&e.value.ok?(j.setTranslations(await e.value.json()),this.#tm+="Not possible to load the TravelNotes"+this.#$u.toUpperCase()+".json file. English will be used. ",!0):(this.#tm+="Not possible to load the translations. ",!1)}async#im(t,e){if("fulfilled"===t.status&&p===t.value.status&&t.value.ok){const e=await t.value.json();return Ie.loadJson(e),!0}if("fulfilled"===e.status&&p===e.value.status&&e.value.ok){const t=await e.value.json();return Ie.loadJson(t),this.#tm+="Not possible to load the TravelNotesNoteDialog"+this.#$u.toUpperCase()+".json file. English will be used. ",!0}return this.#tm+="Not possible to load the translations for the note dialog. ",!1}async#nm(t,e){return"fulfilled"===t.status&&p===t.value.status&&t.value.ok?(Qo.parseDictionary(await t.value.text()),!0):"fulfilled"===e.status&&p===e.value.status&&e.value.ok?(Qo.parseDictionary(await e.value.text()),this.#tm+="Not possible to load the TravelNotesSearchDictionary"+this.#$u.toUpperCase()+".csv file. English will be used. ",!0):(this.#tm+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async#rm(t){return"fulfilled"===t.status&&p===t.value.status&&t.value.ok?(wo.addMapLayers(await t.value.json()),!0):(this.#tm+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async#am(){const t=await Promise.allSettled([fetch(this.#Qu+this.#$u.toUpperCase()+".json"),fetch(this.#Qu+"EN.json"),fetch(this.#Qu+"NoteDialog"+this.#$u.toUpperCase()+".json"),fetch(this.#Qu+"NoteDialogEN.json"),fetch(this.#Qu+"SearchDictionary"+this.#$u.toUpperCase()+".csv"),fetch(this.#Qu+"SearchDictionaryEN.csv"),fetch(this.#Qu+"Layers.json")]),e=await this.#sm(t[0],t[1])&&await this.#im(t[2],t[3])&&await this.#nm(t[4],t[5])&&await this.#rm(t[6]);return""!==this.#tm&&e?St.showError(this.#tm):""!==this.#tm&&(document.body.textContent=this.#tm),e}#lm(){document.body.style["font-size"]=String(t.fontSize.initialValue)+"mm";const e=document.createElement("div");e.id="TravelNotes-Map",document.body.appendChild(e),U.map=window.L.map(e.id,{attributionControl:!1,zoomControl:!1}).setView([a.defaultValue,a.defaultValue],0),this.#qu?ti.addReadOnlyTravel(this.#qu):(fi.addUnloadEventsListeners(),ti.addToolbarsMenusUIs())}constructor(){Object.freeze(this),this.#Qu=window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",this.#tm=""}async loadApp(){fi.addEventsListeners(),window.TaN=ti,this.#em(),await this.#om()?(this.#$u=this.#$u||t.travelNotes.language||"fr",St.createUI(),await this.#am()&&this.#lm()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();