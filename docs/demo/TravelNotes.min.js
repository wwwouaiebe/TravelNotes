/**
 * 
 * @source: https://github.com/wwwouaiebe/TravelNotes
 * 
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this page.
 * 
 * travelnotes - version 4.0.0-dev
 * Build 00026 - 2022-07-30T11:33:29+0200 
 * Copyright 2017 2022 wwwouaiebe 
 * Contact: https://www.ouaie.be/
 * License: GPL-3.0
 * 
 * The JavaScript code in this page is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 * 
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 * 
 * @licend  The above is the entire license notice
 * for the JavaScript code in this page.
 * 
 */


!function(){"use strict";const t={APIKeys:{saveToSessionStorage:!0},APIKeysDialog:{haveUnsecureButtons:!0,showAPIKeys:!0,showButton:!0},baseDialog:{cancelTouchX:100,cancelTouchY:150,deltaZoomDistance:75},contextMenu:{timeout:1500},errorsUI:{helpTimeOut:3e4,showError:!0,showHelp:!0,showInfo:!0,showWarning:!0,timeOut:1e4},geoCoder:{distances:{city:1200,hamlet:200,town:1500,village:400},osmCityAdminLevel:{DEFAULT:"8",GB:"10"}},geoLocation:{marker:{color:"#ff0000",radius:11},options:{enableHighAccuracy:!1,maximumAge:0,timeout:1/0},watch:!0,zoomFactor:17,zoomToPosition:!0},itineraryPaneUI:{showManeuvers:!1,showNotes:!0},itineraryPoint:{marker:{color:"#ff0000",fill:!1,radius:7,weight:2},zoomFactor:17},layersToolbarUI:{haveLayersToolbarUI:!0,toolbarTimeOut:1500,theDevil:{addButton:!1}},map:{center:{lat:50.50923,lng:5.49542},zoom:12},mouseUI:{haveMouseUI:!0},nominatim:{url:"https://nominatim.openstreetmap.org/",language:"*"},note:{grip:{size:10,opacity:0,moveOpacity:1},haveBackground:!1,maxManeuversNotes:100,polyline:{color:"#808080",weight:1},reverseGeocoding:!1,svgIcon:{angleDistance:10,angleDirection:{right:35,slightRight:80,continue:100,slightLeft:145,left:200,sharpLeft:270,sharpRight:340},rcnRefDistance:20,roadbookFactor:1,zoom:17}},noteDialog:{areaHeight:{icon:2,popupContent:8},mask:{iconsDimension:!0,iconTextArea:!1,tooltip:!1,popupContent:!1,address:!1,link:!1,phone:!0},theDevil:{addButton:!1,zoomFactor:17}},osmSearch:{nextSearchLimit:{color:"#ff0000",fill:!1,weight:1},previousSearchLimit:{color:"#006400",fill:!1,weight:1},searchPointMarker:{color:"#006400",fill:!1,radius:20,weight:4},searchPointPolyline:{color:"#006400",fill:!1,weight:4},showSearchNoteDialog:!1},overpassApi:{useNwr:!0,timeOut:40,url:"https://lz4.overpass-api.de/api/interpreter"},paneUI:{switchToItinerary:!1,switchToTravelNotes:!1,switchToSearch:!0},printRouteMap:{firefoxBrowser:!0,isEnabled:!0,maxTiles:240,paperWidth:287,paperHeight:200,printNotes:!0,borderWidth:10,zoomFactor:15,entryPointMarker:{color:"#00ff00",weight:4,radius:10,fill:!0,fillOpacity:1},exitPointMarker:{color:"#ff0000",weight:4,radius:10,fill:!0,fillOpacity:1}},route:{color:"#ff0000",dashIndex:0,dashChoices:[{text:"——————",iDashArray:[0]},{text:"— — — — —",iDashArray:[4,2]},{text:"—‧—‧—‧—‧—",iDashArray:[4,2,0,2]},{text:"················",iDashArray:[0,2]}],elev:{smooth:!0,smoothCoefficient:2.5,smoothPoints:3},showDragTooltip:3,width:3},routeEditor:{showEditedRouteInRoadbook:!0},travelEditor:{startMinimized:!0,startupRouteEdition:!0,timeout:1e3},travelNotes:{haveBeforeUnloadWarning:!0,language:"fr"},travelNotesToolbarUI:{contactMail:{url:"https://github.com/wwwouaiebe/TravelNotes/issues"}},wayPoint:{reverseGeocoding:!1,geocodingIncludeName:!1}};class e{static get minColorValue(){return 0}static get maxColorValue(){return 255}static get rowsNumber(){return 6}static get cellsNumber(){return 6}static get deltaColor(){return 51}static get sliderMaxValue(){return 100}static get sliderStep(){return 20}static get initialRed(){return 0}}class s{static get d0(){return 0}static get d90(){return 90}static get d180(){return 180}static get d270(){return 270}static get d360(){return 360}static get d540(){return 540}static get toRadians(){return Math.PI/180}static get fromRadians(){return 180/Math.PI}}class i{static get fixed(){return 2}static get invalid(){return-1}static get defaultValue(){return 0}static get metersInKm(){return 1e3}}class r{static get fixed(){return 2}static get defaultValue(){return 0}}class o{static get refusedByUser(){return-1}static get disabled(){return 0}static get inactive(){return 1}static get active(){return 2}}class a{static get width(){return 40}static get height(){return 40}static get svgViewboxDim(){return 200}}class n{static get atStart(){return-1}static get onRoute(){return 0}static get atEnd(){return 1}}class h{static get defaultValue(){return 0}static get fixed(){return 6}static get maxLat(){return 90}static get minLat(){return-90}static get maxLng(){return 180}static get minLng(){return-180}}class l{static get invalidPane(){return"43a6a53e-008a-4910-80a6-7a87d301ea15"}static get itineraryPane(){return"8fbf0da7-4e6f-4bc7-8e20-1388461ccde7"}static get travelNotesPane(){return"dffe782b-07df-4b81-a318-f287c0cf5ec6"}static get searchPane(){return"228f00d7-43a8-4c13-897d-70400cb6dd58"}}class c{static get notEdited(){return 0}static get editedNoChange(){return 1}static get editedChanged(){return 2}}class u{static get notSaved(){return"🔴"}static get modified(){return"🟡"}static get saved(){return"🟢"}}const v=20,d=6371e3,p=16,_=200,m=-1,g=[.3,10,1],w=-1,N="http://www.w3.org/2000/svg",T=20;class f{static t=0;static get nextObjId(){return++f.t}}const b="2.4.0",y="v4.0.0-dev";class I{i="";o=["Itinerary","ItineraryPoint","Maneuver","Note","Route","Travel","WayPoint"];h=[];constructor(t,e){if(w===this.o.indexOf(t))throw new Error("Invalid ObjType name : "+t);this.i=t,this.h=e,Object.freeze(this.h)}get name(){return this.i}get version(){return b}get properties(){return this.h}get jsonObject(){return{name:this.i,version:b}}validate(t){if(!Object.getOwnPropertyNames(t).includes("name"))throw new Error("No name for "+this.i);if(this.i!==t.name)throw new Error("Invalid name for "+this.i);if(!Object.getOwnPropertyNames(t).includes("version"))throw new Error("No version for "+this.i)}}class M{l=null;u=w;constructor(t){this.l=t}get value(){return this.u<this.l.length?this.l.at(this.u):null}get previous(){return 0>=this.u?null:this.l.at(this.u-1)}get next(){return this.u<this.l.length-1?this.l.at(this.u+1):null}get done(){return++this.u>=this.l.length}get first(){return 0===this.u}get last(){return this.u>=this.l.length-1}get index(){return this.u}}class D{v;p;_;m(t){return this.v.findIndex((e=>e.objId===t))}g(t,e,s){let i=this.m(t);if(w===i)throw new Error("invalid objId for next or previous function");if(1!==s&&-1!==s)throw new Error("invalid direction");let r=e;for(r||(r=()=>!0),i+=s;w<i&&i<this.v.length&&!r(this.v[i]);)i+=s;return w===i||this.v.length===i?null:this.v[i]}constructor(t){this.v=[],this._=t;const e=new t;if(!e.objType||!e.objType.name)throw new Error("invalid object name for collection");this.p=e.objType.name}add(t){if(!t.objType||!t.objType.name||t.objType.name!==this.p)throw new Error("invalid object name for add function");this.v.push(t)}at(t){return t<this.v.length&&t>w?this.v[t]:null}forEach(t){let e=null;const s=this.iterator;for(;!s.done;)e=t(s.value,e);return e}getAt(t){const e=this.m(t);return w===e?null:this.v[e]}moveTo(t,e,s){let i=this.m(t),r=this.m(e);if(w===i||w===r)throw new Error("invalid objId for function  myMoveTo");s||r++,this.v.splice(r,0,this.v[i]),r<i&&i++,this.v.splice(i,1)}next(t,e){return this.g(t,e,1)}previous(t,e){return this.g(t,e,-1)}remove(t){const e=this.m(t);if(w===e)throw new Error("invalid objId for remove function");this.v.splice(e,1)}removeAll(t){t?this.v.splice(1,this.v.length-2):this.v.length=0}replace(t,e){const s=this.m(t);if(w===s)throw new Error("invalid objId for replace function");if(!e.objType||!e.objType.name||e.objType.name!==this.p)throw new Error("invalid object name for replace function");this.v[s]=e}reverse(){this.v.reverse()}sort(t){this.v.sort(t)}swap(t,e){const s=this.m(t);if(w===s||0===s&&e||this.v.length-1===s&&!e)throw new Error("invalid objId for swap function");const i=e?-1:1,r=this.v[s];this.v[s]=this.v[s+i],this.v[s+i]=r}get first(){return this.v[0]}get iterator(){return new M(this)}get last(){return this.v[this.v.length-1]}get length(){return this.v.length}get jsonObject(){const t=[],e=this.iterator;for(;!e.done;)t.push(e.value.jsonObject);return t}set jsonObject(t){this.v.length=0,Array.isArray(t)&&t.forEach((t=>{const e=new this._;e.jsonObject=t,this.add(e)}))}}class x{N;T;constructor(t,e){this.N=t,this.T=e}get url(){return this.N}get errorsString(){return this.T}}class E{I;T;constructor(t,e){this.I=t,this.T=e}get htmlString(){return this.I}get errorsString(){return this.T}}class P{M=new Map;constructor(){this.M.set("a",["href","target"]),this.M.set("div",[]),this.M.set("del",[]),this.M.set("em",[]),this.M.set("figcaption",[]),this.M.set("figure",[]),this.M.set("h1",[]),this.M.set("h2",[]),this.M.set("h3",[]),this.M.set("h4",[]),this.M.set("h5",[]),this.M.set("h6",[]),this.M.set("hr",[]),this.M.set("img",["src","alt","width","height"]),this.M.set("ins",[]),this.M.set("li",[]),this.M.set("mark",[]),this.M.set("ol",[]),this.M.set("p",[]),this.M.set("s",[]),this.M.set("small",[]),this.M.set("strong",[]),this.M.set("span",[]),this.M.set("sub",[]),this.M.set("sup",[]),this.M.set("ul",[]),this.M.set("svg",["xmlns","viewBox","class"]),this.M.set("text",["x","y","text-anchor"]),this.M.set("polyline",["points","class","transform"]),this.M.set("#text",[])}getValidAttributesNames(t){return this.M.get(t).concat(["id","class","dir","title"])}getValidNodeName(t){const e=t.toLowerCase();return this.M.get(e)?e:""}}class C{D="";P="";static C=new P;L(t){return t.replaceAll(/\u003c/g,"&lt;").replaceAll(/\u003e/g,"&gt;").replaceAll(/\u0022/g,"&quot;").replaceAll(/\u0027/g,"&apos;").replaceAll(/\u0a00/g,"&nbsp;")}S(t,e){const s=this.sanitizeToUrl(t,e).url;""===s&&""!==t?this.P+="\nAn invalid url ("+t+") was removed from a "+e+" attribute":this.D+=" "+e+'="'+s+'"'}k(t,e){C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(this.D+=" "+e+'="'+this.L(t.getAttributeNS(null,e))+'"',t.removeAttributeNS(null,e))}))}A(t,e){t.hasAttribute("target")&&(this.D+=' rel="noopener noreferrer"'),C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttribute(e)&&("href"===e||"src"===e?this.S(t.getAttribute(e),e):this.D+=" "+e+'="'+this.L(t.getAttribute(e))+'"',t.removeAttribute(e))}))}R(t){for(let e=0;e<t.attributes.length;e++)"rel"!==t.attributes[e].name&&(this.P+="\nAn unsecure attribute "+t.attributes[e].name+'="'+t.attributes[e].value+'" was removed.')}O(t){const e=t.childNodes;for(let s=0;s<e.length;s++){const e=t.childNodes[s],i=C.C.getValidNodeName(e.nodeName);""===i?this.P+="\nAn invalid tag "+e.nodeName+" was removed":"#text"===i?this.D+=this.L(e.nodeValue):(this.D+="<"+i,"svg"===i||"text"===i||"polyline"===i?this.k(e,i):this.A(e,i),this.D+=">",this.O(e),this.D+="</"+i+">",e.attributes&&this.R(e))}}B(t,e){const s=document.createElementNS(N,e);return C.C.getValidAttributesNames(e).forEach((e=>{t.hasAttributeNS(null,e)&&(s.setAttributeNS(null,e,t.getAttributeNS(null,e)),t.removeAttributeNS(null,e))})),s}j(t,e){const s=document.createElement(e);return C.C.getValidAttributesNames(e).forEach((e=>{if(t.hasAttribute(e))if("href"===e||"src"===e){const i=this.sanitizeToUrl(t.getAttribute(e),e).url;""!==i&&s.setAttribute(e,i)}else s.setAttribute(e,t.getAttribute(e))})),t.hasAttribute("target")&&s.setAttribute("rel","noopener noreferrer"),s}H(t,e){const s=t.childNodes;for(let i=0;i<s.length;i++){const s=t.childNodes[i],r=C.C.getValidNodeName(s.nodeName);if("#text"===r)e.appendChild(document.createTextNode(s.nodeValue));else if(""!==r){const t="svg"===r||"text"===r||"polyline"===r?this.B(s,r):this.j(s,r);e.appendChild(t),this.H(s,t)}}}constructor(){}sanitizeToHtmlElement(t,e){const s=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html"),i=new DocumentFragment;s&&"#document"===s.nodeName?(this.H(s.body.firstChild,i),e.appendChild(i)):e.textContent=""}clone(t){const e=document.createElement(t.tagName);return this.H(t,e),e}sanitizeToHtmlString(t){this.D="",this.P="";const e=(new DOMParser).parseFromString("<div>"+t.replace("&nbsp;","਀")+"</div>","text/html");return e&&"#document"===e.nodeName?(this.O(e.body.firstChild),new E(this.D,this.P)):new E("","Parsing error")}sanitizeToUrl(t,e){const s=e||"href",i=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!i||"#document"!==i.nodeName)return new x("","Parsing error");const r=i.body.firstChild;let o="";for(let t=0;t<r.childNodes.length;t++){if("#text"!==r.childNodes[t].nodeName)return new x("","Invalid characters found in the url");o+=r.childNodes[t].nodeValue}if(o=o.replaceAll(/</g,"").replaceAll(/>/g,"").replaceAll(/"/g,"").replaceAll(/\u0027/g,"").replaceAll(/&lt;/g,"").replaceAll(/&gt;/g,"").replaceAll(/&quot;/g,"").replaceAll(/&apos;/g,"").replaceAll(/%3C/g,"").replaceAll(/%3c/g,"").replaceAll(/%3E/g,"").replaceAll(/%3e/g,"").replaceAll(/%22/g,"").replaceAll(/%27/g,""),o!==t)return new x("","Invalid characters found in the url");const a=["https:"];if("http:"!==window.location.protocol&&"href"!==s||a.push("http:"),"href"===s){a.push("mailto:"),a.push("sms:"),a.push("tel:");const t=o.match(/^\u0023\w*/);if(t&&o===t[0])return new x(o,"")}"src"===s&&a.push("data:");let n=null;try{n=new URL(o)}catch(t){return new x("","Invalid url string")}if(w===a.indexOf(n.protocol))return new x("","Invalid protocol "+n.protocol);if(w!==["sms:","tel:"].indexOf(n.protocol))return n.pathname.match(/^\+[0-9,*,\u0023]*$/)?new x(o,""):new x("","Invalid sms: or tel: url");try{encodeURIComponent(n.href)}catch(t){return new x("","Invalid character in url")}return new x(o,"")}sanitizeToJsString(t){const e=(new DOMParser).parseFromString("<div>"+t+"</div>","text/html");if(!e||"#document"!==e.nodeName)return"";const s=e.body.firstChild;let i="";for(let t=0;t<s.childNodes.length;t++){if("#text"!==s.childNodes[t].nodeName)return"";i+=s.childNodes[t].nodeValue}return i=i.replaceAll(/</g,"≺").replaceAll(/>/g,"≻").replaceAll(/"/g,"″").replaceAll(/\u0027/g,"′"),i}sanitizeToColor(t){const e=t.match(/^\u0023[0-9,A-F,a-f]{6}$/);return e?e[0]:null}}const L=new C;const S=new class{U=new Map;constructor(){}setTranslations(t){t.forEach((t=>this.U.set(t.msgid,L.sanitizeToJsString(t.msgstr))))}getText(t,e){let s=this.U.get(t);return e&&s&&Object.getOwnPropertyNames(e).forEach((t=>s=s.replace("{"+t+"}",e[t]))),s||t}};const k=new class{constructor(){}get UUID(){const t=["","","","-","","-","","-","","-","","","","","",""],e=new Uint8Array(16);window.crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let s="";for(let i=0;i<16;i++)s+=e[i].toString(p).padStart(2,"0")+t[i];return s}storageAvailable(t){try{const e=window[t],s="__storage_test__";return e.setItem(s,s),e.removeItem(s),!0}catch(t){return!1}}openFile(t,e){const s=document.createElement("input");s.type="file",e&&(s.accept=e),s.addEventListener("change",t,!1),s.click()}saveFile(t,e,s){try{const i=s?window.URL.createObjectURL(new File([e],t,{type:s})):URL.createObjectURL(e),r=document.createElement("a");r.setAttribute("href",i),r.setAttribute("download",t),r.click(),window.URL.revokeObjectURL(i)}catch(t){t instanceof Error&&console.error(t)}}formatTime(t){const e=Math.floor(t);if(0===e)return"";const s=Math.floor(e/86400),i=Math.floor(e%86400/3600),r=Math.floor(e%3600/60),o=Math.floor(e%60);return 0<s?s+" "+S.getText("Utilities - Day")+" "+i+" "+S.getText("Utilities - Hour"):0<i?i+" "+S.getText("Utilities - Hour")+" "+r+" "+S.getText("Utilities - Minute"):0<r?r+" "+S.getText("Utilities - Minute"):o+" "+S.getText("Utilities - Second")}formatDistance(t){const e=Math.floor(t);return 0>=e?"0 km":Math.floor(e/i.metersInKm)+","+Math.floor(e%i.metersInKm/10).toFixed(0).padStart(2,"0").padEnd(3,"0")+" km"}numberToDMS(t){let e=t,s=Math.floor(t);e-=s;let i=Math.floor(60*e);e-=i/60,e*=3600;let r=Math.floor(e);return e-=r,e=Math.floor(100*e),s.toString()+"° "+i.toString()+"' "+r+'" '+e}formatLatDMS(t){return t>0?this.numberToDMS(t)+" N":this.numberToDMS(-t)+" S"}formatLngDMS(t){return t>0?this.numberToDMS(t)+" E":this.numberToDMS(-t)+" W"}formatLatLngDMS(t){return 0===t[0]&&0===t[1]?"":this.formatLatDMS(t[0])+" - "+this.formatLngDMS(t[1])}formatLat(t){return t>0?t.toFixed(h.fixed)+" N":(-t).toFixed(h.fixed)+" S"}formatLng(t){return t>0?t.toFixed(h.fixed)+" E":(-t).toFixed(h.fixed)+" W"}formatLatLng(t){return 0===t[0]&&0===t[1]?"":this.formatLat(t[0])+" - "+this.formatLng(t[1])}};class A{F;K(){this.F.routes.forEach((t=>{t.dashArray=0,t.hidden=!1}))}W(){this.F.routes.forEach((t=>{t.edited=c.notEdited}))}V(){this.W(),this.F.editedRoute={name:"",wayPoints:[{name:"",lat:0,lng:0,objId:2,objType:{name:"WayPoint",version:"1.4.0"}},{name:"",lat:0,lng:0,objId:3,objType:{name:"WayPoint",version:"1.4.0"}}],notes:[],itinerary:{itineraryPoints:[],maneuvers:[],provider:"",transitMode:"",objId:1,objType:{name:"Itinerary",version:"1.4.0"}},width:3,color:"_private_ff0000",dashArray:0,chain:!0,distance:0,duration:0,edited:c.notEdited,hidden:!1,chainedDistance:0,objId:4,objType:{name:"Route",version:"1.4.0"}}}G(){if(this.F.userData.layerId){const t=[{layerId:"0",layerName:"OSM - Color"},{layerId:"1",layerName:"OSM - Black and White"},{layerId:"2",layerName:"Thunderforest - Transport"},{layerId:"3",layerName:"Thunderforest - OpenCycleMap"},{layerId:"4",layerName:"Thunderforest - Outdoors"},{layerId:"5",layerName:"Esri - Aerial view"},{layerId:"6",layerName:"Kartverket - Norway"},{layerId:"7",layerName:"IGN-NGI - Belgium now"},{layerId:"12",layerName:"Thunderforest - Landscape"},{layerId:"24",layerName:"Lantmäteriet - Sweden"},{layerId:"25",layerName:"Maanmittauslaitos - Finland"}].find((t=>t.layerId===this.F.userData.layerId));this.F.layerName=t?t.layerName:"OSM - Color"}else this.F.layerName="OSM - Color"}X(t){t.forEach((t=>{t.elev=r.defaultValue}))}Z(){this.F.routes.forEach((t=>{t.itinerary.hasProfile=!1,t.itinerary.ascent=0,t.itinerary.descent=0,this.X(t.itinerary.itineraryPoints)})),this.F.editedRoute.itinerary.hasProfile=!1,this.F.editedRoute.itinerary.ascent=0,this.F.editedRoute.itinerary.descent=0,this.X(this.F.editedRoute.itinerary.itineraryPoints)}J(t){t.itinerary.maneuvers.forEach((t=>{"kArriveDefault"===t.iconName&&(t.distance=i.defaultValue)}))}Y(t){t.wayPoints.forEach((t=>{t.address=t.name,t.name=""}))}q(){this.F.routes.forEach((t=>{t.editionStatus=t.edited,this.J(t),this.Y(t)})),this.F.editedRoute.editionStatus=this.F.editedRoute.edited,this.J(this.F.editedRoute),this.Y(this.F.editedRoute)}$(){this.F.routes.forEach((t=>{t.dashIndex=t.dashArray})),this.F.editedRoute.dashIndex=this.F.editedRoute.dashArray}tt(t){return t.replaceAll(/style='color:white;background-color:red'/g,"class='TravelNotes-Note-WhiteRed'").replaceAll(/style='color:white;background-color:green'/g,"class='TravelNotes-Note-WhiteGreen'").replaceAll(/style='color:white;background-color:blue'/g,"class='TravelNotes-Note-WhiteBlue'").replaceAll(/style='color:white;background-color:brown'/g,"class='TravelNotes-Note-WhiteBrown'").replaceAll(/style='color:white;background-color:black'/g,"class='TravelNotes-Note-WhiteBlack'").replaceAll(/style='border:solid 0.1em'/g,"class='TravelNotes-Note-BlackWhite'").replaceAll(/style='background-color:white;'/g,"class='TravelNotes-Note-Knooppunt'").replaceAll(/style='fill:green;font:bold 120px sans-serif;'/g,"").replaceAll(/style='fill:none;stroke:green;stroke-width:10;'/g,"")}et(t){"string"==typeof t.iconHeight&&(t.iconHeight=Number.parseInt(t.iconHeight)),"string"==typeof t.iconWidth&&(t.iconWidth=Number.parseInt(t.iconWidth)),t.iconContent=this.tt(t.iconContent),t.popupContent=this.tt(t.popupContent),t.tooltipContent=this.tt(t.tooltipContent),t.phone=this.tt(t.phone),t.address=this.tt(t.address)}st(){this.F.notes.forEach((t=>{this.et(t)})),this.jsonTravel.routes.forEach((t=>{t.notes.forEach((t=>{this.et(t)}))}))}it(){switch(this.F.objType.version){case"1.0.0":this.K();case"1.1.0":case"1.2.0":case"1.3.0":case"1.4.0":this.V();case"1.5.0":this.G();case"1.6.0":this.Z();case"1.7.0":case"1.7.1":case"1.8.0":case"1.9.0":case"1.10.0":case"1.11.0":this.q();case"1.12.0":case"1.13.0":this.st();case"2.0.0":case"2.1.0":case"2.2.0":case"2.3.0":this.$(),this.F.objType.version="2.4.0";break;default:throw new Error("invalid version for travel")}}constructor(){}update(t){t.objType.version!==b&&(this.F=t,this.it())}}class R{constructor(){}validateObject(t){if(!Object.getOwnPropertyNames(t).includes("objType"))throw new Error("No objType for "+this.objType.name);this.objType.validate(t.objType),"Travel"===this.objType.name&&this.objType.version!==t.objType.version&&(new A).update(t);const e=Object.getOwnPropertyNames(t);return this.objType.properties.forEach((t=>{if(!e.includes(t))throw new Error("No "+t+" for "+this.objType.name)})),t}}class O extends R{static rt=new I("WayPoint",["address","name","lat","lng","objId"]);ot="";nt="";ht=h.defaultValue;lt=h.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get address(){return this.nt}set address(t){this.nt="string"==typeof t?L.sanitizeToJsString(t):""}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get fullName(){let t=""===this.name?this.address:this.name+", "+this.address;return""===t&&(t=k.formatLatLng([this.lat,this.lng])),t}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objId(){return this.t}get objType(){return O.rt}get jsonObject(){return{name:this.name,address:this.address,lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.address=e.address,this.name=e.name,this.lat=e.lat,this.lng=e.lng,this.t=f.nextObjId}}class B extends R{static rt=new I("ItineraryPoint",["lat","lng","distance","elev","objId"]);ht=h.defaultValue;lt=h.defaultValue;ct=i.defaultValue;ut=r.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get elev(){return this.ut}set elev(t){this.ut="number"==typeof t?t:h.defaultValue}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objType(){return B.rt}get objId(){return this.t}get jsonObject(){return{lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),elev:parseFloat(this.elev.toFixed(r.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.elev=e.elev,this.t=f.nextObjId}}class j extends R{static rt=new I("Maneuver",["iconName","instruction","distance","duration","itineraryPointObjId","objId"]);vt="";dt="";_t=m;ct=i.defaultValue;gt=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconName(){return this.vt}set iconName(t){this.vt="string"==typeof t?L.sanitizeToJsString(t):""}get instruction(){return this.dt}set instruction(t){this.dt="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPointObjId(){return this._t}set itineraryPointObjId(t){this._t="number"==typeof t?t:m}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get duration(){return this.gt}set duration(t){this.gt="number"==typeof t?t:i.defaultValue}get objType(){return j.rt}get objId(){return this.t}get jsonObject(){return{iconName:this.iconName,instruction:this.instruction,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,itineraryPointObjId:this.itineraryPointObjId,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconName=e.iconName,this.instruction=e.instruction,this.distance=e.distance,this.duration=e.duration,this.itineraryPointObjId=e.itineraryPointObjId,this.t=f.nextObjId}}class H extends R{static rt=new I("Itinerary",["hasProfile","ascent","descent","itineraryPoints","maneuvers","provider","transitMode","objId"]);t=m;wt=!1;Nt=0;Tt=0;ft="";bt="";yt=new D(B);It=new D(j);constructor(){super(),this.t=f.nextObjId}get hasProfile(){return this.wt}set hasProfile(t){this.wt="boolean"==typeof t&&t}get ascent(){return this.Nt}set ascent(t){this.Nt="number"==typeof t?Number.parseInt(t):0}get descent(){return this.Tt}set descent(t){this.Tt="number"==typeof t?Number.parseInt(t):0}get provider(){return this.ft}set provider(t){this.ft="string"==typeof t?L.sanitizeToJsString(t):""}get transitMode(){return this.bt}set transitMode(t){this.bt="string"==typeof t?L.sanitizeToJsString(t):""}get itineraryPoints(){return this.yt}get maneuvers(){return this.It}get objType(){return H.rt}get objId(){return this.t}get jsonObject(){return{hasProfile:this.hasProfile,ascent:this.ascent,descent:this.descent,itineraryPoints:this.itineraryPoints.jsonObject,maneuvers:this.maneuvers.jsonObject,provider:this.provider,transitMode:this.transitMode,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.hasProfile=e.hasProfile,this.ascent=e.ascent,this.descent=e.descent,this.itineraryPoints.jsonObject=e.itineraryPoints,this.maneuvers.jsonObject=e.maneuvers,this.provider=e.provider,this.transitMode=e.transitMode,this.t=f.nextObjId;const s=new Map;let i=0;const r=this.itineraryPoints.iterator;for(;!r.done;)s.set(e.itineraryPoints[i].objId,r.value.objId),i++;const o=this.maneuvers.iterator;for(;!o.done;)o.value.itineraryPointObjId=s.get(o.value.itineraryPointObjId)}}class U extends R{static rt=new I("Note",["iconHeight","iconWidth","iconContent","popupContent","tooltipContent","phone","url","address","iconLat","iconLng","lat","lng","distance","chainedDistance","objId"]);Mt=a.height;Dt=a.width;xt="";Et="";Pt="";Ct="";N="";nt="";Lt=h.defaultValue;St=h.defaultValue;ht=h.defaultValue;lt=h.defaultValue;ct=i.invalid;kt=i.defaultValue;t=m;constructor(){super(),this.t=f.nextObjId}get iconHeight(){return this.Mt}set iconHeight(t){this.Mt="number"==typeof t?t:a.height}get iconWidth(){return this.Dt}set iconWidth(t){this.Dt="number"==typeof t?t:a.width}get iconContent(){return this.xt}set iconContent(t){this.xt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get popupContent(){return this.Et}set popupContent(t){this.Et="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get tooltipContent(){return this.Pt}set tooltipContent(t){this.Pt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get phone(){return this.Ct}set phone(t){this.Ct="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get url(){return this.N}set url(t){this.N="string"==typeof t?encodeURI(L.sanitizeToUrl(t).url):""}get address(){return this.nt}set address(t){this.nt="string"==typeof t?L.sanitizeToHtmlString(t).htmlString:""}get iconLat(){return this.Lt}set iconLat(t){this.Lt="number"==typeof t?t:h.defaultValue}get iconLng(){return this.St}set iconLng(t){this.St="number"==typeof t?t:h.defaultValue}get lat(){return this.ht}set lat(t){this.ht="number"==typeof t?t:h.defaultValue}get lng(){return this.lt}set lng(t){this.lt="number"==typeof t?t:h.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.invalid}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get isRouteNote(){return this.ct!==i.invalid}get iconLatLng(){return[this.iconLat,this.iconLng]}set iconLatLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.Lt=t[0],this.St=t[1]):(this.Lt=h.defaultValue,this.St=h.defaultValue)}get latLng(){return[this.lat,this.lng]}set latLng(t){"number"==typeof t[0]&&"number"==typeof t[1]?(this.ht=t[0],this.lt=t[1]):(this.ht=h.defaultValue,this.lt=h.defaultValue)}get objType(){return U.rt}get objId(){return this.t}get jsonObject(){return{iconHeight:this.iconHeight,iconWidth:this.iconWidth,iconContent:this.iconContent,popupContent:this.popupContent,tooltipContent:this.tooltipContent,phone:this.phone,url:this.url,address:this.address,iconLat:parseFloat(this.iconLat.toFixed(h.fixed)),iconLng:parseFloat(this.iconLng.toFixed(h.fixed)),lat:parseFloat(this.lat.toFixed(h.fixed)),lng:parseFloat(this.lng.toFixed(h.fixed)),distance:parseFloat(this.distance.toFixed(i.fixed)),chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.iconHeight=e.iconHeight,this.iconWidth=e.iconWidth,this.iconContent=e.iconContent,this.popupContent=e.popupContent,this.tooltipContent=e.tooltipContent,this.phone=e.phone,this.url=e.url,this.address=e.address,this.iconLat=e.iconLat,this.iconLng=e.iconLng,this.lat=e.lat,this.lng=e.lng,this.distance=e.distance,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class F extends R{static rt=new I("Route",["name","wayPoints","notes","itinerary","width","color","dashIndex","chain","chainedDistance","distance","duration","editionStatus","hidden","objId"]);ot="";At=new D(O);Rt=new D(U);Ot=new H;Bt=t.route.width;jt=t.route.color;Ht=t.route.dashIndex;Ut=!0;kt=i.defaultValue;ct=i.defaultValue;gt=i.defaultValue;Ft=c.notEdited;Kt=!1;t=m;constructor(){super(),this.At.add(new O),this.At.add(new O),this.t=f.nextObjId}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get wayPoints(){return this.At}get notes(){return this.Rt}get itinerary(){return this.Ot}get width(){return this.Bt}set width(e){this.Bt="number"==typeof e?e:t.route.width}get color(){return this.jt}set color(e){this.jt="string"==typeof e&&L.sanitizeToColor(e)||t.route.color}get dashIndex(){return this.Ht}set dashIndex(e){this.Ht="number"==typeof e&&t.route.dashChoices[e]?e:0}get dashString(){let e="";return t.route.dashChoices[this.Ht].iDashArray.forEach((t=>e+=String(t*this.Bt)+",")),e.substring(0,e.length-1)}get chain(){return this.Ut}set chain(t){this.Ut="boolean"==typeof t&&t}get chainedDistance(){return this.kt}set chainedDistance(t){this.kt="number"==typeof t?t:i.defaultValue}get distance(){return this.ct}set distance(t){this.ct="number"==typeof t?t:i.defaultValue}get duration(){return this.gt}set duration(t){this.gt="number"==typeof t?t:i.defaultValue}get editionStatus(){return this.Ft}set editionStatus(t){this.Ft="number"==typeof t?t:c.notEdited}get hidden(){return this.Kt}set hidden(t){this.Kt="boolean"==typeof t&&t}get computedName(){let t=this.name;return""===t&&(t=(""===this.wayPoints.first.fullName?"???":this.wayPoints.first.fullName)+" ⮞ "+(""===this.wayPoints.last.fullName?"???":this.wayPoints.last.fullName)),t}get objId(){return this.t}get objType(){return F.rt}haveValidWayPoints(){let t=!0;return this.wayPoints.forEach((e=>{t=t&&h.defaultValue!==e.lat&&h.defaultValue!==e.lng})),t}get jsonObject(){return{name:this.name,wayPoints:this.wayPoints.jsonObject,notes:this.notes.jsonObject,itinerary:this.itinerary.jsonObject,width:this.width,color:this.color,dashIndex:this.dashIndex,chain:this.chain,distance:parseFloat(this.distance.toFixed(i.fixed)),duration:this.duration,editionStatus:this.editionStatus,hidden:this.hidden,chainedDistance:parseFloat(this.chainedDistance.toFixed(i.fixed)),objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.name=e.name,this.wayPoints.jsonObject=e.wayPoints,this.notes.jsonObject=e.notes,this.itinerary.jsonObject=e.itinerary,this.width=e.width,this.color=e.color,this.dashIndex=e.dashIndex,this.chain=e.chain,this.distance=e.distance,this.duration=e.duration,this.editionStatus=e.editionStatus,this.hidden=e.hidden,this.chainedDistance=e.chainedDistance,this.t=f.nextObjId}}class K extends R{static rt=new I("Travel",["editedRoute","routes","notes","layerName","name","readOnly","objId"]);Wt=new F;Vt=new D(F);Rt=new D(U);zt="OSM - Color";ot="";Gt=!1;t=m;constructor(){super(),this.Vt.add(new F),this.t=f.nextObjId}get editedRoute(){return this.Wt}set editedRoute(t){this.Wt="Route"===t?.objType?.name?t:new F}get routes(){return this.Vt}get notes(){return this.Rt}get layerName(){return this.zt}set layerName(t){this.zt="string"==typeof t?L.sanitizeToJsString(t):"OSM - Color"}get name(){return this.ot}set name(t){this.ot="string"==typeof t?L.sanitizeToJsString(t):""}get readOnly(){return this.Gt}set readOnly(t){this.Gt="boolean"!=typeof t||t}get objId(){return this.t}get objType(){return K.rt}get jsonObject(){return{editedRoute:this.editedRoute.jsonObject,layerName:this.layerName,name:this.name,routes:this.routes.jsonObject,notes:this.notes.jsonObject,readOnly:this.readOnly,objId:this.t,objType:this.objType.jsonObject}}set jsonObject(t){const e=this.validateObject(t);this.editedRoute.jsonObject=e.editedRoute,this.layerName=t.layerName,this.name=e.name,this.readOnly=e.readOnly,this.routes.jsonObject=e.routes,this.notes.jsonObject=e.notes,this.t=f.nextObjId}}class W{ft="";bt="";constructor(){}get provider(){return this.ft}set provider(t){this.ft="string"==typeof t?t:""}get transitMode(){return this.bt}set transitMode(t){this.bt="string"==typeof t?t:""}}const V=new class{Xt;Zt;Jt;Yt;qt;$t;Qt;te;constructor(){this.Xt=new Map,this.Zt=new Map,this.Jt=new W,this.Yt=k.UUID,this.qt=null,this.$t=new K,this.Qt=m,this.te=[]}get map(){return this.qt}set map(t){this.qt||(this.qt=t)}get travel(){return this.$t}get editedRouteObjId(){return this.Qt}set editedRouteObjId(t){this.Qt="number"==typeof t?t:m}get searchData(){return this.te}get providers(){return this.Xt}get mapObjects(){return this.Zt}get routing(){return this.Jt}get UUID(){return this.Yt}};class z{ht;lt;constructor(t,e){this.ht=t,this.lt=e}static clone(t){return new z(t.lat,t.lng)}get latLng(){return[this.ht,this.lt]}get lat(){return this.ht}get lng(){return this.lt}}class G extends z{ct;constructor(t,e,s){super(t,e),this.ct=s}get distance(){return this.ct}}class X extends G{ut;Nt;constructor(t,e,s,i,r){super(t,e,s),this.ut=i,this.Nt=r}get elev(){return this.ut}get ascent(){return this.Nt}}class Z{ee;se;constructor(t,e){this.ee="string"==typeof t?t:"",this.se="string"==typeof e?e:""}get providerName(){return this.ee}get providerKey(){return this.se}}class J{static get ie(){return 100}constructor(){}getLatLngElevAtDist(t,e){if(t.distance<=e||0>=e)return null;let s=0;const i=t.itinerary.itineraryPoints.iterator;for(;s<e&&!i.done;)s+=i.value.distance;const r=i.value;i.done;const o=(r.distance-s+e)/r.distance;return new X(r.lat+(i.value.lat-r.lat)*o,r.lng+(i.value.lng-r.lng)*o,e,r.elev+(i.value.elev-r.elev)*o,J.ie*(i.value.elev-r.elev)/r.distance)}getClosestLatLngDistance(t,e){if(0===t.itinerary.itineraryPoints.length)return null;const s=t.itinerary.itineraryPoints.iterator;s.done;let r=Number.MAX_VALUE;const o=window.L.Projection.SphericalMercator.project(window.L.latLng(e[0],e[1]));let a=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng)),n=null,h=i.defaultValue,l=s.value.distance;for(;!s.done;){const t=window.L.Projection.SphericalMercator.project(window.L.latLng(s.value.lat,s.value.lng));let e=window.L.LineUtil.pointToSegmentDistance(o,a,t);e<r&&(r=e,n=window.L.Projection.SphericalMercator.unproject(window.L.LineUtil.closestPointOnSegment(o,a,t)),h=l-n.distanceTo(window.L.latLng(s.value.lat,s.value.lng))),l+=s.value.distance,a=t}return new G(n.lat,n.lng,h)}getLatLngBounds(t){const e=window.L.latLng([h.maxLat,h.maxLng]),s=window.L.latLng([h.minLat,h.minLng]);return t.forEach((t=>{e.lat=Math.min(e.lat,t[0]),e.lng=Math.min(e.lng,t[1]),s.lat=Math.max(s.lat,t[0]),s.lng=Math.max(s.lng,t[1])})),window.L.latLngBounds(e,s)}getSquareBoundingBox(t,e){const i=t[0]*s.toRadians,r=e/d*s.fromRadians,o=Math.acos((Math.cos(e/d)-Math.sin(i)**2)/Math.cos(i)**2)*s.fromRadians;return window.L.latLngBounds(window.L.latLng([t[0]-r,t[1]-o]),window.L.latLng([t[0]+r,t[1]+o]))}project(t,e){const s=V.map.project(window.L.latLng(t),e);return[s.x,s.y]}screenCoordToLatLng(t,e){const s=V.map.containerPointToLatLng(window.L.point(t,e));return[s.lat,s.lng]}addPoints(t,e){return[t[0]+e[0],t[1]+e[1]]}subtrackPoints(t,e){return[t[0]-e[0],t[1]-e[1]]}}const Y=new J;const q=new class{re(t){return(t+s.d540)%s.d360-s.d180}constructor(){}arcFromSummitArcArc(t,e,s){return Math.acos(Math.cos(e)*Math.cos(s)+Math.sin(e)*Math.sin(s)*Math.cos(t))}summitFromArcArcArc(t,e,s){return Math.acos((Math.cos(s)-Math.cos(t)*Math.cos(e))/(Math.sin(t)*Math.sin(e)))}pointsDistance(t,e){if(t[0]===e[0]&&t[1]===e[1])return 0;const i=t[0]*s.toRadians,r=e[0]*s.toRadians,o=(this.re(e[1])-this.re(t[1]))*s.toRadians;return Math.acos(Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos(o))*d}};class ${oe;ae;constructor(t,e){this.oe=t,this.ae=e}get note(){return this.oe}get route(){return this.ae}}class Q{constructor(){}distance=Number.MAX_VALUE;route=null;distanceOnRoute=0;latLngOnRoute=[h.defaultValue,h.defaultValue]}const tt=new class{ne(t,e,s){if(t.objId!==V.editedRouteObjId){const i=Y.getClosestLatLngDistance(t,e);if(i){const r=q.pointsDistance(e,i.latLng);r<s.distance&&(s.route=t,s.distance=r,s.latLngOnRoute=i.latLng,s.distanceOnRoute=i.distance)}}}constructor(){}getNearestRouteData(t){const e=new Q;return V.travel.routes.forEach((s=>this.ne(s,t,e))),m!==V.editedRouteObjId&&this.ne(V.travel.editedRoute,t,e),Object.freeze(e)}getRoute(t){let e=null;return e=V.travel.routes.getAt(t),e||t===V.travel.editedRoute.objId&&(e=V.travel.editedRoute),e}getNoteAndRoute(t){let e=null,s=null;if(e=V.travel.notes.getAt(t),!e){const i=V.travel.routes.iterator;for(;!i.done&&!e;)e=i.value.notes.getAt(t),e&&(s=i.value);e||(e=V.travel.editedRoute.notes.getAt(t),e&&(s=V.travel.editedRoute))}return new $(e,s)}getWayPoint(t){let e=V.travel.editedRoute.wayPoints.getAt(t);if(!e){const s=V.travel.routes.iterator;for(;!s.done&&!e;)e=s.value.wayPoints.getAt(t)}return e}};const et=new class{he(t,e){for(const s in e)try{if("dataset"===s){const s=e.dataset;for(const e in s)t.dataset["tan"+e]=s[e]}else t[s]=e[s]}catch(t){t instanceof Error&&console.error(t)}t.target&&(t.rel="noopener noreferrer")}constructor(){}create(t,e,s){let i=null;return"text"===t.toLowerCase()?i=document.createTextNode(e.value||""):(i="select"===t.toLowerCase()?document.createElement(t):Object.seal(document.createElement(t)),e&&this.he(i,e)),s&&s.appendChild(i),i}};class st{le;constructor(t){this.le=t}handleEvent(){this.le.onOk()}}class it{le;constructor(t){this.le=t}handleEvent(){this.le.onCancel()}}class rt{le;constructor(t){this.le=t}handleEvent(t){this.le.keyboardELEnabled&&("Escape"===t.key||"Esc"===t.key?this.le.onCancel():"Enter"===t.key&&this.le.onOk())}}class ot{constructor(){}handleEvent(t){t.preventDefault()}}class at{constructor(){}handleEvent(t){if(!t.target.classList.contains("TravelNotes-Background"))return;let e=V.map.getZoom()+(0>t.deltaY?1:-1);e=Math.min(V.map.getMaxZoom(),e),e=Math.max(V.map.getMinZoom(),e),V.map.setZoomAround(window.L.point(t.clientX,t.clientY),e)}}class nt{constructor(){}handleEvent(t){t.preventDefault()}}class ht{le;ce=!1;ue=!1;ve=0;de=0;pe;_e;me;ge;we(e){if(this.ce&&(this.ve!==e.screenX||this.de!==e.screenY)){t.baseDialog.cancelTouchY>this.de&&e.screenY<this.de&&t.baseDialog.cancelTouchX>this.ve&&this.le.onCancel();const s=Y.screenCoordToLatLng(this.ve,this.de),i=Y.screenCoordToLatLng(e.screenX,e.screenY);V.map.panTo([this.pe.lat+s[0]-i[0],this.pe.lng+s[1]-i[1]])}}Ne(e){let s=Math.sqrt((e.item(0).clientX-e.item(1).clientX)**2+(e.item(0).clientY-e.item(1).clientY)**2),i=this._e,r=s-this.me;t.baseDialog.deltaZoomDistance<r?i++:-t.baseDialog.deltaZoomDistance>r&&i--,i=Math.min(V.map.getMaxZoom(),i),i=Math.max(V.map.getMinZoom(),i),i!==this._e&&(V.map.setZoomAround(this.ge,i),this._e=i,this.me=s)}Te(t){this.ce&&1===t.changedTouches.length&&(this.we(t.changedTouches.item(0)),this.ce=!1)}fe(t){this.ce&&1===t.changedTouches.length?this.we(t.changedTouches.item(0)):this.ue&&2===t.targetTouches.length&&this.Ne(t.targetTouches)}be(t){if(1===t.targetTouches.length){const e=t.changedTouches.item(0);this.ve=e.screenX,this.de=e.screenY,this.pe=V.map.getCenter(),this.ce=!0,this.ue=!1}2===t.targetTouches.length&&(this._e=V.map.getZoom(),this.ge=window.L.point((t.targetTouches.item(0).clientX+t.targetTouches.item(1).clientX)/2,(t.targetTouches.item(0).clientY+t.targetTouches.item(1).clientY)/2),this.me=Math.sqrt((t.targetTouches.item(0).clientX-t.targetTouches.item(1).clientX)**2+(t.targetTouches.item(0).clientY-t.targetTouches.item(1).clientY)**2),this.ce=!1,this.ue=!0)}constructor(t){this.le=t}handleEvent(t){switch(t.currentTarget===t.target&&t.preventDefault(),t.type){case"touchstart":this.be(t);break;case"touchmove":this.fe(t);break;case"touchend":this.Te(t)}}}class lt{static get LEFT_BUTTON(){return 0}ce=!1;ve=0;de=0;pe;we(t){const e=Y.screenCoordToLatLng(this.ve,this.de),s=Y.screenCoordToLatLng(t.screenX,t.screenY);V.map.panTo([this.pe.lat+e[0]-s[0],this.pe.lng+e[1]-s[1]])}constructor(){}handleEvent(t){switch(t.type){case"mousedown":t.button===lt.LEFT_BUTTON&&(this.ve=t.screenX,this.de=t.screenY,this.pe=V.map.getCenter(),this.ce=!0);break;case"mousemove":t.button===lt.LEFT_BUTTON&&this.ce&&(document.selection?document.selection.empty():window.getSelection().removeAllRanges(),this.we(t));break;case"mouseup":t.button!==lt.LEFT_BUTTON||!this.ce||this.ve===t.screenX&&this.de===t.screenY||this.we(t),this.ce=!1}}}class ct{ye;constructor(t){this.ye=t}handleEvent(t){this.ye.dragStartX=t.screenX,this.ye.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class ut{ye;Ie;Me;constructor(t,e,s){this.ye=t,this.Ie=e,this.Me=s}handleEvent(t){this.ye.dialogX+=t.screenX-this.ye.dragStartX,this.ye.dialogX=Math.min(Math.max(this.ye.dialogX,v),this.Me.clientWidth-this.Ie.clientWidth-v),this.ye.dialogY+=t.screenY-this.ye.dragStartY,this.ye.dialogY=Math.max(this.ye.dialogY,v);const e=this.Me.clientHeight-Math.max(this.ye.dialogY,0)-v;this.Ie.style.left=String(this.ye.dialogX)+"px",this.Ie.style.top=String(this.ye.dialogY)+"px",this.Ie.style["max-height"]=String(e)+"px"}}class vt{De;constructor(t){this.De=t}handleEvent(t){if(t.stopPropagation(),1===t.targetTouches.length){const e=t.changedTouches.item(0);this.De.touchStartX=e.screenX,this.De.touchStartY=e.screenY}}}class dt{De;Ie;constructor(t,e){this.De=t,this.Ie=e}handleEvent(t){if(t.stopPropagation(),1===t.changedTouches.length){const e=t.changedTouches.item(0);this.De.dialogX+=e.screenX-this.De.touchStartX,this.De.dialogY+=e.screenY-this.De.touchStartY,this.De.touchStartX=e.screenX,this.De.touchStartY=e.screenY,this.Ie.style.left=String(this.De.dialogX)+"px",this.Ie.style.top=String(this.De.dialogY)+"px"}}}class pt{De;Ie;Me;constructor(t,e,s){this.De=t,this.Ie=e,this.Me=s}handleEvent(t){if(t.stopPropagation(),1===t.changedTouches.length){const e=t.changedTouches.item(0);this.De.dialogX+=e.screenX-this.De.touchStartX,this.De.dialogY+=e.screenY-this.De.touchStartY,this.De.dialogX=Math.min(Math.max(this.De.dialogX,v),this.Me.clientWidth-this.Ie.clientWidth-v),this.De.dialogY=Math.min(Math.max(this.De.dialogY,v),this.Me.clientHeight-this.Ie.clientHeight-v),this.Ie.style.left=String(this.De.dialogX)+"px",this.Ie.style.top=String(this.De.dialogY)+"px"}this.De.reset()}}class _t{De;constructor(t){this.De=t}handleEvent(){this.De.reset()}}class mt{constructor(){}dragStartX=0;dragStartY=0;dialogX=0;dialogY=0}class gt{constructor(){}touchStartX=0;touchStartY=0;dialogX=0;dialogY=0;reset(){this.touchStartX=0,this.touchStartY=0}}class wt{xe=null;Ee=null;Pe=null;Ce=null;Le=null;constructor(t){for(const e in t)switch(e){case"firstButtonText":this.xe=t.firstButtonText;break;case"secondButtonText":this.Ee=t.secondButtonText;break;case"selectOptionsData":this.Pe=t.selectOptionsData;break;case"title":this.Ce=t.title;break;case"text":this.Le=t.text}}get firstButtonText(){return this.xe}get secondButtonText(){return this.Ee}get selectOptionsData(){return this.Pe}get title(){return this.Ce}get text(){return this.Le}}class Nt{Se;ke;Ae;Re;Oe;Be;je;He;Ue;ye;De;Fe;Ke;We;Ve;ze;Ge;Xe;Ze;Je;Ye;qe;$e;Qe;ts;es=null;ss;rs;os(){this.Se=et.create("div",{className:"TravelNotes-Background"}),this.Fe=new ot,this.Se.addEventListener("dragover",this.Fe,!1),this.Ve=new at,this.Se.addEventListener("wheel",this.Ve,{passive:!0}),this.ze=new nt,this.Se.addEventListener("contextmenu",this.ze,!1),this.Ke=new ht(this),this.Se.addEventListener("touchstart",this.Ke,!1),this.Se.addEventListener("touchmove",this.Ke,!1),this.Se.addEventListener("touchend",this.Ke,!1),this.Se.addEventListener("touchcancel",this.Ke,!1),this.We=new lt,this.Se.addEventListener("mouseup",this.We,!1),this.Se.addEventListener("mousemove",this.We,!1),this.Se.addEventListener("mousedown",this.We,!1)}ns(){this.ke=et.create("div",{className:"TravelNotes-BaseDialog-Container"},this.Se)}hs(){this.je=et.create("div",{className:"TravelNotes-BaseDialog-TopBar",draggable:!0},this.ke),this.Ze=new vt(this.De),this.je.addEventListener("touchstart",this.Ze,!1),this.Je=new dt(this.De,this.ke),this.je.addEventListener("touchmove",this.Je,!1),this.Ye=new pt(this.De,this.ke,this.Se),this.je.addEventListener("touchend",this.Ye,!1),this.qe=new _t(this.De),this.je.addEventListener("touchcancel",this.qe,!1),this.Ge=new ct(this.ye),this.je.addEventListener("dragstart",this.Ge,!1),this.Xe=new ut(this.ye,this.ke,this.Se),this.je.addEventListener("dragend",this.Xe,!1),this.Be=et.create("div",{textContent:"❌",className:"TravelNotes-BaseDialog-CancelButton",title:S.getText("BaseDialog - Cancel")},this.je),this.$e=new it(this),this.Be.addEventListener("click",this.$e,!1)}ls(){et.create("text",{value:this.title},et.create("div",{className:"TravelNotes-BaseDialog-HeaderDiv"},this.ke))}cs(){const t=et.create("div",{className:"TravelNotes-BaseDialog-ContentDiv"},this.ke);this.contentHTMLElements.forEach((e=>t.appendChild(e)))}us(){this.Ae=et.create("div",{className:"TravelNotes-BaseDialog-ErrorDiv TravelNotes-Hidden"},this.ke)}vs(){et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},this.Re=et.create("div",{className:"TravelNotes-BaseDialog-WaitDiv  TravelNotes-Hidden"},this.ke)))}ds(){const t=et.create("div",{className:"TravelNotes-BaseDialog-FooterDiv"},this.ke);this.Oe=et.create("div",{textContent:this.es.firstButtonText||"🆗",className:"TravelNotes-BaseDialog-Button"},t),this.Qe=new st(this),this.Oe.addEventListener("click",this.Qe,!1),this.es.secondButtonText?(this.He=et.create("div",{textContent:this.es.secondButtonText,className:"TravelNotes-BaseDialog-Button"},t),this.He.addEventListener("click",this.$e,!1)):this.He=null,this.footerHTMLElements.forEach((e=>t.appendChild(e)))}ps(){this.os(),this.ns(),this.hs(),this.ls(),this.cs(),this.us(),this.vs(),this.ds()}_s(){this.ye.dialogX=(this.Se.clientWidth-this.ke.clientWidth)/2,this.ye.dialogY=(this.Se.clientHeight-this.ke.clientHeight)/2,this.ye.dialogX=Math.min(Math.max(this.ye.dialogX,v),this.Se.clientWidth-this.ke.clientWidth-v),this.ye.dialogY=Math.max(this.ye.dialogY,v),this.De.dialogX=this.ye.dialogX,this.De.dialogY=this.ye.dialogY;const t=this.Se.clientHeight-Math.max(this.ye.dialogY,0)-v;this.ke.style.left=String(this.ye.dialogX)+"px",this.ke.style.top=String(this.ye.dialogY)+"px",this.ke.style["max-height"]=String(t)+"px"}gs(t,e){this.ss=t,this.rs=e,this.ps(),document.body.appendChild(this.Se),this._s(),this.ts=new rt(this),document.addEventListener("keydown",this.ts,{capture:!0}),this.onShow()}constructor(t){this.ye=new mt,this.De=new gt,this.es=new wt(t),this.Ue=!0}ws(){document.removeEventListener("keydown",this.ts,{capture:!0}),this.ts=null,this.je.removeEventListener("dragstart",this.Ge,!1),this.Ge=null,this.je.removeEventListener("dragend",this.Xe,!1),this.Xe=null,this.je.removeEventListener("touchstart",this.Ze,!1),this.Ze=null,this.je.removeEventListener("touchmove",this.Je,!1),this.Je=null,this.je.removeEventListener("touchend",this.Ye,!1),this.Ye=null,this.je.removeEventListener("touchcancel",this.qe,!1),this.qe=null,this.Be.removeEventListener("click",this.$e,!1),this.es.secondButtonText&&this.He.removeEventListener("click",this.$e,!1),this.$e=null,this.Oe.removeEventListener("click",this.Qe,!1),this.Qe=null,this.Se.removeEventListener("wheel",this.Ve,{passive:!0}),this.Ve=null,this.Se.removeEventListener("contextmenu",this.ze,!1),this.ze=null,this.Se.removeEventListener("dragover",this.Fe,!1),this.Fe=null,this.Se.removeEventListener("touchstart",this.Ke,!1),this.Se.removeEventListener("touchmove",this.Ke,!1),this.Se.removeEventListener("touchend",this.Ke,!1),this.Se.removeEventListener("touchcancel",this.Ke,!1),this.Ke=null,this.Se.removeEventListener("mouseup",this.We,!1),this.Se.removeEventListener("mousemove",this.We,!1),this.Se.removeEventListener("mousedown",this.We,!1),this.We=null,document.body.removeChild(this.Se)}onCancel(){this.ws(),this.rs("Canceled by user")}canClose(){return!0}onOk(t){return!!this.canClose()&&(this.ws(),this.ss(t),!0)}onShow(){}get title(){return""}get contentHTMLElements(){return[]}get footerHTMLElements(){return[]}show(){return new Promise(((t,e)=>this.gs(t,e)))}showWait(){this.Re.classList.remove("TravelNotes-Hidden"),this.Oe.classList.add("TravelNotes-Hidden")}hideWait(){this.Re.classList.add("TravelNotes-Hidden"),this.Oe.classList.remove("TravelNotes-Hidden")}showError(t){this.Ae.textContent="",L.sanitizeToHtmlElement(t,this.Ae),this.Ae.classList.remove("TravelNotes-Hidden")}hideError(){this.Ae.textContent="",this.Ae.classList.add("TravelNotes-Hidden")}get keyboardELEnabled(){return this.Ue}set keyboardELEnabled(t){this.Ue=t}get options(){return this.es}}class Tt{Ns=null;constructor(t){this.Ns=t}handleEvent(t){t.currentTarget.textContent="👀",t.preventDefault(),t.stopPropagation(),this.Ns.type="text"}}class ft{Ns;constructor(t){this.Ns=t}handleEvent(t){t.currentTarget.textContent="👁️",t.preventDefault(),t.stopPropagation(),this.Ns.type="password",this.Ns.focus()}}class bt extends Nt{Ts;Ns;fs;bs;ys;Is;static get Ms(){return 12}constructor(t){super(),this.bs=t,this.Ts=et.create("div",{id:"TravelNotes-PasswordDialog-PasswordDiv"}),this.Ns=et.create("input",{type:"password"},this.Ts),this.fs=et.create("span",{id:"TravelNotes-PasswordDialog-EyeSpan",textContent:"👁️"},this.Ts),this.ys=new Tt(this.Ns),this.Is=new ft(this.Ns),this.fs.addEventListener("mousedown",this.ys,!1),this.fs.addEventListener("touchstart",this.ys,!1),this.fs.addEventListener("mouseup",this.Is,!1),this.fs.addEventListener("touchend",this.Is,!1)}Ds(){this.fs.removeEventListener("touchend",this.ys,!1),this.fs.removeEventListener("mouseup",this.Is,!1),this.fs.removeEventListener("touchstart",this.ys,!1),this.fs.removeEventListener("mousedown",this.Is,!1),this.ys=null,this.Is=null}canClose(){return this.hideError(),!(this.bs&&(this.Ns.value.length<bt.Ms||!this.Ns.value.match(/[0-9]+/)||!this.Ns.value.match(/[a-z]+/)||!this.Ns.value.match(/[A-Z]+/)||!this.Ns.value.match(/[^0-9a-zA-Z]/)))||(this.showError("<p>"+S.getText("PasswordDialog - Password rules1")+"</p><ul><li>"+S.getText("PasswordDialog - Password rules2")+"</li><li>"+S.getText("PasswordDialog - Password rules3")+"</li><li>"+S.getText("PasswordDialog - Password rules4")+"</li><li>"+S.getText("PasswordDialog - Password rules5")+"</li><li>"+S.getText("PasswordDialog - Password rules6")+"</li></ul>"),this.Ns.focus(),!1)}onCancel(){this.Ds(),super.onCancel()}onOk(){this.Ds(),super.onOk((new window.TextEncoder).encode(this.Ns.value))}onShow(){this.Ns.focus()}get contentHTMLElements(){return[this.Ts]}get title(){return S.getText("PasswordDialog - password")}}class yt{xs;Es(t){return window.crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}Ps(t,e){return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:(new window.TextEncoder).encode(e),iterations:1e6,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}Cs(t,e){return window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(e.slice(0,16))},t,new Uint8Array(e.slice(16)))}Ls(t,e,s){return window.crypto.subtle.encrypt({name:"AES-GCM",iv:e},t,s)}constructor(t){this.xs=t||"Tire la chevillette la bobinette cherra. Le Petit Chaperon rouge tira la chevillette."}encryptData(t,e,s,i){let r=window.crypto.getRandomValues(new Uint8Array(16));i.then((t=>this.Es(t))).then((t=>this.Ps(t,this.xs))).then((e=>this.Ls(e,r,t))).then((t=>{e(new Blob([r,new Uint8Array(t)],{type:"application/octet-stream"}))})).catch(s)}decryptData(t,e,s,i){i.then((t=>this.Es(t))).then((t=>this.Ps(t,this.xs))).then((e=>this.Cs(e,t))).then(e).catch(s)}}class It{constructor(){}handleEvent(t){t.stopPropagation();const e=new Event("apikeydeleted");e.data={objId:Number.parseInt(t.target.dataset.tanObjId)},t.target.parentNode.parentNode.dispatchEvent(e)}}class Mt{Ss;ks;As;t;constructor(e){this.t=f.nextObjId,this.Ss=et.create("div",{className:"TravelNotes-APIKeysDialog-ApiKeyRow"}),this.ks=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyName TravelNotes-APIKeysDialog-Input",value:e.providerName,placeholder:S.getText("APIKeysDialogKeyControl - provider name")},this.Ss),this.As=et.create("input",{className:"TravelNotes-APIKeysDialog-ApiKeyValue TravelNotes-APIKeysDialog-Input",value:e.providerKey,placeholder:S.getText("APIKeysDialogKeyControl - API key"),type:t.APIKeysDialog.showAPIKeys?"text":"password"},this.Ss),et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:S.getText("APIKeysDialogKeyControl - delete API key"),textContent:"❌",dataset:{ObjId:this.t}},this.Ss).addEventListener("click",new It,!1)}get objId(){return this.t}get HTMLElements(){return[this.Ss]}get providerName(){return this.ks.value}get providerKey(){return this.As.value}get apiKey(){return new Z(this.ks.value,this.As.value)}}class Dt{Rs;constructor(t){this.Rs=t}onErrorDecrypt(t){this.Rs.hideWait(),this.Rs.keyboardELEnabled=!0,t&&"Canceled by user"!==t&&this.Rs.showError(S.getText("DataEncryptorHandlers - An error occurs when reading the file"))}onOkDecrypt(t){try{this.Rs.addAPIKeys(JSON.parse((new TextDecoder).decode(t)))}catch(t){return void this.onErrorDecrypt(t)}this.Rs.hideWait(),this.Rs.hideError(),this.Rs.keyboardELEnabled=!0}onOkEncrypt(t){this.Rs.hideError(),this.Rs.hideWait(),k.saveFile("APIKeys",t),this.Rs.keyboardELEnabled=!0}onErrorEncrypt(){this.Rs.showError(S.getText("DataEncryptorHandlers - An error occurs when saving the keys")),this.Rs.hideWait(),this.Rs.keyboardELEnabled=!0}}class xt{Os;constructor(t){this.Os=t}getAPIKeysJsonString(){const t=[];return this.Os.forEach((e=>{t.push({providerName:e.providerName,providerKey:e.providerKey})})),JSON.stringify(t)}}class Et{Rs;Os;constructor(t,e){this.Rs=t,this.Os=e}handleEvent(t){t.stopPropagation(),this.Os.delete(t.data.objId),this.Rs.refreshAPIKeys()}}class Pt{Rs;constructor(t){this.Rs=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{this.Rs.addAPIKeys(JSON.parse(e.result))}catch(t){this.Rs.showError(t.message),t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Ct{Rs;constructor(t){this.Rs=t}handleEvent(t){t.stopPropagation(),this.Rs.hideError(),k.openFile(new Pt(this.Rs),".json")}}class Lt{Rs;constructor(t){this.Rs=t}handleEvent(t){t.stopPropagation(),this.Rs.hideError(),this.Rs.showWait(),this.Rs.keyboardELEnabled=!1,fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((t=>{_===t.status&&t.ok?t.arrayBuffer().then((t=>{const e=new Dt(this.Rs);(new yt).decryptData(t,(t=>{e.onOkDecrypt(t)}),(t=>{e.onErrorDecrypt(t)}),new bt(!1).show())})):new Dt(this.Rs).onErrorDecrypt(new Error("Invalid http status"))})).catch((t=>{new Dt(this.Rs).onErrorDecrypt(t),t instanceof Error&&console.error(t)}))}}class St{Rs;constructor(t){this.Rs=t}handleEvent(t){t.stopPropagation(),this.Rs.showWait(),this.Rs.keyboardELEnabled=!1;const e=new FileReader;e.onload=()=>{const t=new Dt(this.Rs);(new yt).decryptData(e.result,(e=>{t.onOkDecrypt(e)}),(e=>{t.onErrorDecrypt(e)}),new bt(!1).show())},e.readAsArrayBuffer(t.target.files[0])}}class kt{Rs;constructor(t){this.Rs=t}handleEvent(t){t.stopPropagation(),this.Rs.hideError(),k.openFile(new St(this.Rs))}}class At{Rs;Os;constructor(t,e){this.Rs=t,this.Os=e}handleEvent(t){if(t.stopPropagation(),!this.Rs.validateAPIKeys())return;this.Rs.showWait(),this.Rs.keyboardELEnabled=!1;const e=new Dt(this.Rs);(new yt).encryptData((new window.TextEncoder).encode(new xt(this.Os).getAPIKeysJsonString()),(t=>e.onOkEncrypt(t)),(()=>e.onErrorEncrypt()),new bt(!0).show())}}class Rt{Rs;Os;constructor(t,e){this.Rs=t,this.Os=e}handleEvent(t){t.stopPropagation(),this.Rs.validateAPIKeys()&&k.saveFile("APIKeys.json",new xt(this.Os).getAPIKeysJsonString(),"application/json")}}class Ot{Rs;Os;constructor(t,e){this.Rs=t,this.Os=e}handleEvent(t){t.stopPropagation();const e=new Z,s=new Mt(e);this.Os.set(s.objId,s),this.Rs.refreshAPIKeys()}}class Bt{Rs;Os;Bs;Ss;js;Hs;Us;Fs;Ks;Ws;Vs;zs;Gs;Xs;Zs;Js;Ys(){this.js=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Reload from server"),textContent:"🔄"},this.Ss),this.Vs=new Lt(this.Rs),this.js.addEventListener("click",this.Vs,!1)}qs(){this.Hs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Save to file"),textContent:"💾"},this.Ss),this.zs=new At(this.Rs,this.Os),this.Hs.addEventListener("click",this.zs,!1)}$s(){this.Us=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Open file"),textContent:"📂"},this.Ss),this.Gs=new kt(this.Rs),this.Us.addEventListener("click",this.Gs,!1)}Qs(){this.Fs=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - new API key"),textContent:"+"},this.Ss),this.Xs=new Ot(this.Rs,this.Os),this.Fs.addEventListener("click",this.Xs,!1)}ti(){this.Ks=et.create("div",{className:"TravelNotes-BaseDialog-Button TravelNotes-APIKeysDialog-AtRightButton",title:S.getText("APIKeysDialogToolbar - Save to json file"),textContent:"💾"},this.Ss),this.Zs=new Rt(this.Rs,this.Os),this.Ks.addEventListener("click",this.Zs,!1)}ei(){this.Ws=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("APIKeysDialogToolbar - Open json file"),textContent:"📂"},this.Ss),this.Js=new Ct(this.Rs),this.Ws.addEventListener("click",this.Js,!1)}si(){window?.crypto?.subtle?.importKey&&window.isSecureContext&&(this.Bs&&this.Ys(),this.qs(),this.$s()),this.Qs(),t.APIKeysDialog.haveUnsecureButtons&&(this.ti(),this.ei())}constructor(t,e,s){this.Rs=t,this.Os=e,this.Bs=s,this.Ss=et.create("div",{id:"TravelNotes-APIKeysDialog-ToolbarDiv"}),this.si()}destructor(){this.js&&this.js.removeEventListener("click",this.Vs,!1),this.Vs=null,this.Hs&&this.Hs.removeEventListener("click",this.zs,!1),this.zs=null,this.Us&&this.Us.removeEventListener("click",this.Gs,!1),this.Gs=null,this.Fs&&this.Fs.removeEventListener("click",this.Xs,!1),this.Xs=null,this.Ks&&this.Ks.removeEventListener("click",this.Zs,!1),this.Zs=null,this.Ws&&this.Ws.removeEventListener("click",this.Js,!1),this.Js=null}get rootHTMLElement(){return this.Ss}}const jt=new class{ii;ri;oi;ai;ni;hi;li(){this.oi&&(clearTimeout(this.oi),this.oi=null),this.ii.classList.remove("TravelNotes-ErrorsUI-"+this.hi),this.ii.classList.add("TravelNotes-Hidden"),this.ni.classList.add("TravelNotes-Hidden"),this.ri.textContent=""}gs(e,s){if(this.hi=s,!t.errorsUI["show"+this.hi]||"Help"===s&&this.ai.checked)return;this.oi&&(clearTimeout(this.oi),this.oi=null),this.ri.textContent="",L.sanitizeToHtmlElement(e,this.ri),this.ii.classList.add("TravelNotes-ErrorsUI-"+this.hi),this.ii.classList.remove("TravelNotes-Hidden");let i=t.errorsUI.timeOut;"Help"===this.hi&&(this.ni.classList.remove("TravelNotes-Hidden"),i=t.errorsUI.helpTimeOut),this.oi=setTimeout((()=>this.li()),i)}constructor(){}createUI(){if(this.ii)return;this.ii=et.create("div",{id:"TravelNotes-ErrorsUI",className:"TravelNotes-Hidden"},document.body);const e=et.create("div",null,this.ii);et.create("span",{id:"TravelNotes-ErrorsUI-CancelButton",textContent:"❌"},e).addEventListener("click",(()=>this.li()),!1),this.ri=et.create("div",{id:"TravelNotes-ErrorsUI-Message"},this.ii),this.ni=et.create("div",{id:"TravelNotes-ErrorsUI-HelpInputDiv",className:"TravelNotes-Hidden"},this.ii),this.ai=et.create("input",{id:"TravelNotes-ErrorsUI-HelpInput",type:"checkbox",checked:!t.errorsUI.showHelp},this.ni),et.create("label",{id:"TravelNotes-ErrorsUI-HelpInputLabel",htmlFor:"TravelNotes-ErrorsUI-HelpInput",textContent:"Don't show help again"},this.ni)}showError(t){this.gs(t,"Error")}showWarning(t){this.gs(t,"Warning")}showInfo(t){this.gs(t,"Info")}showHelp(t){this.gs(t,"Help")}};class Ht extends Nt{ci;ui;vi;di;pi(){this.vi=et.create("div"),this.di=new Et(this,this.ci),this.vi.addEventListener("apikeydeleted",this.di,!1)}constructor(t,e){super(),this.ci=new Map,this.ui=new Bt(this,this.ci,e),this.pi(),this.addAPIKeys(t)}Ds(){this.ui.destructor(),this.ui=null,this.vi.removeEventListener("apikeydeleted",this.di,!1),this.di=null}validateAPIKeys(){this.hideError();let t=!1;const e=[];this.ci.forEach((s=>{t=t||""===s.providerName||""===s.providerKey,e.push(s.providerName)}));let s=!1;return e.forEach((t=>{s=s||e.indexOf(t)!==e.lastIndexOf(t)})),t?(this.showError(S.getText("APIKeysDialog - empty API key name or value")),!1):!s||(this.showError(S.getText("APIKeysDialog - duplicate API key name found")),!1)}addAPIKeys(t){this.ci.clear(),t.forEach((t=>{const e=new Mt(t);this.ci.set(e.objId,e)})),this.refreshAPIKeys()}refreshAPIKeys(){for(;this.vi.firstChild;)this.vi.removeChild(this.vi.firstChild);this.ci.forEach((t=>{this.vi.appendChild(t.HTMLElements[0])}))}onShow(){jt.showHelp("<p>"+S.getText("Help - Complete the APIKeys1")+"</p><p>"+S.getText("Help - Complete the APIKeys2")+"</p><p>"+S.getText("Help - Complete the APIKeys3")+"</p>")}canClose(){return this.validateAPIKeys()}onCancel(){this.Ds(),super.onCancel()}onOk(){const t=[];this.ci.forEach((e=>t.push(e.apiKey))),super.onOk(t)&&this.Ds()}get title(){return S.getText("APIKeysDialog - API keys")}get contentHTMLElements(){return[this.ui.rootHTMLElement,this.vi]}}const Ut=new class{constructor(){}dispatch(t,e){const s=new Event(t);e&&(s.data=e),document.dispatchEvent(s)}};const Ft=new class{Bs=!1;_i=new Map;mi(t){this.gi(JSON.parse((new TextDecoder).decode(t)))}wi(t){t instanceof Error&&console.error(t),t&&"Canceled by user"!==t&&jt.showError(S.getText("APIKeysManager - An error occurs when reading the APIKeys file"))}Ni(t){window.isSecureContext&&window?.crypto?.subtle?.importKey&&(new yt).decryptData(t,(t=>this.mi(t)),(t=>this.wi(t)),new bt(!1).show())}Ti(t){return this._i.get(t.toLowerCase())}fi(t,e){this._i.set(t.toLowerCase(),e)}bi(){if(!k.storageAvailable("sessionStorage"))return 0;let t=0;for(let e=0;e<sessionStorage.length;e++){const s=sessionStorage.key(e);s.match(/^\w*ProviderKey$/)&&(this.fi(s.replace("ProviderKey",""),atob(sessionStorage.getItem(s))),t++)}return V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.Ti(t.name)||"")})),t}gi(e){sessionStorage.clear(),this._i.clear();const s=k.storageAvailable("sessionStorage")&&t.APIKeys.saveToSessionStorage;e.forEach((t=>{s&&sessionStorage.setItem(t.providerName.toLowerCase()+"ProviderKey",btoa(t.providerKey)),this.fi(t.providerName,t.providerKey)})),V.providers.forEach((t=>{t.providerKeyNeeded&&(t.providerKey=this.Ti(t.name)||"")})),Ut.dispatch("providersadded")}constructor(){}hasKey(t){return this._i.has(t.toLowerCase())}getUrl(t){if(t.providerKeyNeeded){const e=this._i.get(t.providerName.toLowerCase());return e?t.url.replace("{providerKey}",e):null}return t.url}setKeysFromServerFile(){let t=!1;0!==this.bi()&&(Ut.dispatch("providersadded"),t=!0),fetch(window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"APIKeys").then((e=>{_===e.status&&e.ok&&(this.Bs=!0,t||e.arrayBuffer().then((t=>this.Ni(t))))})).catch((t=>{t instanceof Error&&console.error(t)}))}setKeysFromDialog(){const t=[];this._i.forEach(((e,s)=>{t.push(new Z(s,e))})),t.sort(((t,e)=>t.providerName.localeCompare(e.providerName))),new Ht(t,this.Bs).show().then((t=>this.gi(t))).catch((t=>{t instanceof Error&&console.error(t)}))}addProvider(t){const e=new t,s=e.name.toLowerCase();let i=this.Ti(s);e.providerKeyNeeded&&!i&&k.storageAvailable("sessionStorage")&&(i=sessionStorage.getItem(s),i&&(i=atob(i))),e.providerKeyNeeded&&i&&(e.providerKey=i),V.providers.set(e.name.toLowerCase(),e)}};class Kt{ae;yi;Ii;Mi;Di;xi;Ei;static get PROFILE_MARGIN(){return 100}static get PROFILE_HEIGHT(){return 500}static get PROFILE_WIDTH(){return 1e3}static get X_DELTA_TEXT(){return 10}static get Y_DELTA_TEXT(){return 30}static get Pi(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3,1e4,2e4,5e4,1e5]}static get Ci(){return[1,2,5,10,20,50,100,200,500,1e3,2e3,5e3]}static get Li(){return 8}static get Si(){return 4}static get ki(){return Kt.PROFILE_MARGIN.toFixed(0)}static get Ai(){return(Kt.PROFILE_MARGIN+Kt.PROFILE_WIDTH).toFixed(0)}static get Ri(){return Kt.PROFILE_MARGIN.toFixed(0)}static get Oi(){return(Kt.PROFILE_MARGIN+Kt.PROFILE_HEIGHT).toFixed(0)}static get Bi(){return(Kt.PROFILE_MARGIN-Kt.X_DELTA_TEXT).toFixed(0)}static get ji(){return(Kt.PROFILE_MARGIN+Kt.PROFILE_WIDTH+Kt.X_DELTA_TEXT).toFixed(0)}static get Hi(){return Kt.PROFILE_MARGIN+Kt.PROFILE_HEIGHT+Kt.PROFILE_MARGIN/2}Ui(){let t="",e=0,s=0,i=0;this.ae.itinerary.itineraryPoints.forEach((r=>{s=(Kt.PROFILE_MARGIN+this.Mi*e).toFixed(0),i=(Kt.PROFILE_MARGIN+this.Ii*(this.xi-r.elev)).toFixed(0),t+=s+","+i+" ",e+=r.distance}));const r=document.createElementNS(N,"polyline");r.setAttributeNS(null,"points",t),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-profilePolyline"),this.yi.appendChild(r)}Fi(){const t=Kt.ki+","+Kt.Ri+" "+Kt.ki+","+Kt.Oi+" "+Kt.Ai+","+Kt.Oi+" "+Kt.Ai+","+Kt.Ri,e=document.createElementNS(N,"polyline");e.setAttributeNS(null,"points",t),e.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-framePolyline"),this.yi.appendChild(e)}Ki(){let t=Number.MAX_VALUE,e=0;Kt.Pi.forEach((s=>{const i=Math.abs(this.ae.distance/Kt.Li-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.ae.chainedDistance/e)*e;for(;s<this.ae.distance+this.ae.chainedDistance;){const t=document.createElementNS(N,"text");t.appendChild(document.createTextNode(i.metersInKm<e||0<this.ae.chainedDistance?s/i.metersInKm+" km":s+" m ")),t.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-distLegend"),t.setAttributeNS(null,"x",Kt.PROFILE_MARGIN+(s-this.ae.chainedDistance)*this.Mi),t.setAttributeNS(null,"y",Kt.Hi),t.setAttributeNS(null,"text-anchor","start"),this.yi.appendChild(t),s+=e}}Wi(){let t=Number.MAX_VALUE,e=0;Kt.Ci.forEach((s=>{const i=Math.abs(this.Ei/Kt.Si-s);i<t&&(t=i,e=s)}));let s=Math.ceil(this.Di/e)*e;for(;s<this.xi;){const t=Kt.PROFILE_MARGIN+(this.xi-s)*this.Ii,i=document.createElementNS(N,"text");i.appendChild(document.createTextNode(s.toFixed(0))),i.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),i.setAttributeNS(null,"x",Kt.ji),i.setAttributeNS(null,"y",t),i.setAttributeNS(null,"text-anchor","start"),this.yi.appendChild(i);const r=document.createElementNS(N,"text");r.appendChild(document.createTextNode(s.toFixed(0))),r.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevLegend"),r.setAttributeNS(null,"x",Kt.Bi),r.setAttributeNS(null,"y",t),r.setAttributeNS(null,"text-anchor","end"),this.yi.appendChild(r),s+=e}}Vi(){this.yi=document.createElementNS(N,"svg"),this.yi.setAttributeNS(null,"viewBox","0 0 "+(Kt.PROFILE_WIDTH+2*Kt.PROFILE_MARGIN)+" "+(Kt.PROFILE_HEIGHT+2*Kt.PROFILE_MARGIN)),this.yi.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile")}constructor(){}createSvg(t){return this.ae=t,this.Di=Number.MAX_VALUE,this.xi=0,this.ae.itinerary.itineraryPoints.forEach((t=>{this.xi=Math.max(this.xi,t.elev),this.Di=Math.min(this.Di,t.elev)})),this.Ei=this.xi-this.Di,this.Ii=Kt.PROFILE_HEIGHT/this.Ei,this.Mi=Kt.PROFILE_WIDTH/this.ae.distance,this.Vi(),this.Ui(),this.Fi(),this.Wi(),this.Ki(),this.yi}}class Wt{static get zi(){return 40}static get Gi(){return 40}constructor(){}getNoteTextAndIconHTML(e,s){const i=et.create("div",{dataset:{ObjId:s.note.objId}}),r=et.create("div",{className:e+(s.route?"Route-ManeuversAndNotes-IconCell":"Travel-Notes-IconCell")},i);let o=1;L.sanitizeToHtmlElement(s.note.iconContent,r),"TravelNotes-Roadbook-"===e&&r.firstChild&&("svg"===r.firstChild.tagName?(r.firstChild.setAttributeNS(null,"viewBox","0 0 "+a.svgViewboxDim+" "+a.svgViewboxDim),o=t.note.svgIcon.roadbookFactor):r?.firstChild?.classList?.contains("TravelNotes-MapNoteCategory-0073")&&(o=t.note.svgIcon.roadbookFactor)),r.dataset.tanWidth=String(s.note.iconWidth*o)+"px",r.dataset.tanHeight=String(s.note.iconHeight*o)+"px",r.style.width=String(s.note.iconWidth*o)+"px",r.style.height=String(s.note.iconHeight*o)+"px";const n=this.getNoteTextHTML(e,s);return n.className=e+(s.route?"Route-ManeuversAndNotes-Cell":"Travel-Notes-Cell"),i.appendChild(n),i}getNoteTextHTML(t,e){const s=e.note,i=et.create("div");if(0!==s.tooltipContent.length&&L.sanitizeToHtmlElement(s.tooltipContent,et.create("div",{className:t+"NoteHtml-TooltipContent"},i)),0!==s.popupContent.length&&L.sanitizeToHtmlElement(s.popupContent,et.create("div",{className:t+"NoteHtml-PopupContent"},i)),0!==s.address.length&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Address")+"</span> : "+s.address,et.create("div",{className:t+"NoteHtml-Address"},i)),0!==s.url.length&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Link")+"</span><a href="+s.url+' target="_blank" >'+s.url.substring(0,Wt.zi)+"...</a>",et.create("div",{className:t+"NoteHtml-Url"},i)),0!==s.phone.length){let e=s.phone;if(s.phone.match(/^\+[0-9, ,*,\u0023]*$/)){const t=s.phone.replaceAll(/\u0020/g,""),i=s.phone.replaceAll(/\u0020/g," ");e=S.getText("NoteHTMLViewsFactory - Phone")+" : "+S.getText("NoteHTMLViewsFactory - call")+'<a target="_blank" href="tel:'+t+'" >'+i+"</a>"+S.getText("NoteHTMLViewsFactory - Send a sms to")+'<a target="_blank" href="sms:'+t+'" >'+i+"</a>"}else e=S.getText("NoteHTMLViewsFactory - Phone")+" : "+s.phone;L.sanitizeToHtmlElement(e,et.create("div",{className:t+"NoteHtml-Phone"},i))}if(L.sanitizeToHtmlElement(k.formatLatLng(s.latLng),et.create("div",{className:t+"NoteHtml-LatLng"},i)),e.route){e.route.chain&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Distance from start of travel")+"</span> : "+k.formatDistance(s.chainedDistance+s.distance),et.create("div",{className:t+"NoteHtml-TravelDistance"},i)),L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Distance from start of route")+"</span> : "+k.formatDistance(s.distance),et.create("div",{className:t+"NoteHtml-RouteDistance"},i));const r=e.route.notes.next(s.objId);if(r){const e=r.distance-s.distance;Wt.Gi<e&&L.sanitizeToHtmlElement("<span>"+S.getText("NoteHTMLViewsFactory - Next note after")+"</span> : "+k.formatDistance(e),et.create("div",{className:t+"NoteHtml-NextDistance"},i))}}return i}getTravelNotesHTML(t){const e=et.create("div",{className:t+"Travel-Notes"}),s=V.travel.notes.iterator;for(;!s.done;){const i=this.getNoteTextAndIconHTML(t,{note:s.value,route:null});i.className=t+"Travel-Notes-Row",e.appendChild(i)}return e}}const Vt=new Wt;const zt=new class{Xi(t,e){const s=et.create("div"),r=et.create("div",{className:t+"Route-ManeuversAndNotes-IconCell"},s);et.create("div",{className:"TravelNotes-ManeuverNote TravelNotes-ManeuverNote-"+e.maneuver.iconName},r),r.dataset.tanWidth=String(a.width)+"px",r.dataset.tanHeight=String(a.height)+"px";const o=et.create("div",{className:t+"Route-ManeuversAndNotes-Cell"},s);return et.create("div",{className:t+"Route-Maneuver-TooltipContent",textContent:S.getText("RouteHTMLViewsFactory - "+e.maneuver.iconName)},o),L.sanitizeToHtmlElement(e.maneuver.instruction,et.create("div",{className:t+"Route-Maneuver-Instruction"},o)),e.route.chain&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Distance from start of travel")+"</span> : "+k.formatDistance(e.route.chainedDistance+e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-TravelDistance"},o)),L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Distance from start of route")+"</span> : "+k.formatDistance(e.maneuverDistance),et.create("div",{className:t+"Route-Maneuver-RouteDistance"},o)),i.defaultValue<e.maneuver.distance&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Next maneuver after")+"</span> : "+k.formatDistance(e.maneuver.distance),et.create("div",{className:t+"Route-Maneuver-NextDistance"},o)),s}constructor(){}getRouteProfileHTML(t,e){const s=et.create("div",{className:t+"RouteProfile"});return L.sanitizeToHtmlElement(S.getText("RouteHTMLViewsFactory - Profile"),s),s.appendChild((new Kt).createSvg(e)),s}getRouteManeuversAndNotesHTML(t,e,s){const i=[],r=e.notes.iterator;for(;!r.done;)i.push({data:r.value,distance:r.value.distance});const o=e.itinerary.maneuvers.iterator;let a=0;for(;!o.done;)i.push({data:o.value,distance:a}),a+=o.value.distance;i.sort(((t,e)=>t.distance-e.distance));const n=et.create("div",{className:t+"Route-ManeuversAndNotes"});return i.forEach((i=>{let r=null;"Note"===i.data.objType.name?(r=Vt.getNoteTextAndIconHTML(t,{note:i.data,route:e}),r.className=t+"Route-Notes-Row"):(r=this.Xi(t,{route:e,maneuver:i.data,maneuverDistance:i.distance}),r.className=t+"Route-Maneuvers-Row"),s&&(r.dataset.tanObjId=i.data.objId,r.dataset.tanMarkerObjId=f.nextObjId,r.dataset.tanObjType=i.data.objType.name),n.appendChild(r)})),n}getRouteHeaderHTML(t,e){const s=et.create("div",{className:t+"Route-Header",id:"route"+e.objId});return L.sanitizeToHtmlElement(e.computedName,et.create("div",{className:t+"Route-Header-Name"},s)),0!==e.distance&&L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Route distance")+"</span> : "+k.formatDistance(e.distance),et.create("div",{className:t+"Route-Header-Distance"},s)),V.travel.readOnly||"bike"===e.itinerary.transitMode||L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Duration")+"</span> : "+k.formatTime(e.duration),et.create("div",{className:t+"Route-Header-Duration"},s)),e.itinerary.hasProfile&&(L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Ascent")+"</span> : "+String(e.itinerary.ascent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Ascent"},s)),L.sanitizeToHtmlElement("<span>"+S.getText("RouteHTMLViewsFactory - Descent")+"</span> : "+String(e.itinerary.descent.toFixed(0))+" m.",et.create("div",{className:t+"Route-Header-Descent"},s))),s}getRouteFooterHTML(t,e){let s=""!==e.itinerary.provider&&""!==e.itinerary.transitMode?S.getText("RouteHTMLViewsFactory - Itinerary computed by {provider} and optimized for {transitMode}",{provider:e.itinerary.provider,transitMode:S.getText("RouteHTMLViewsFactory - TransitMode "+e.itinerary.transitMode)}):"";const i=et.create("div",{className:t+"RouteFooter"});return L.sanitizeToHtmlElement(s,i),i}};class Gt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onKeydownKeyboard(t.key)}}class Xt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onCancelMenu()}}class Zt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onMouseLeaveMenuItem(t.currentTarget)}}class Jt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onMouseEnterMenuItem(t.currentTarget)}}class Yt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.selectItem(Number.parseInt(t.currentTarget.dataset.tanObjId))}}class qt{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onMouseLeaveContainer()}}class $t{Zi=null;constructor(t){this.Zi=t}handleEvent(t){t.stopPropagation(),this.Zi.onMouseEnterContainer()}}class Qt{static Ji=Object.freeze({get previousItem(){return-1},get firstItem(){return 0},get nextItem(){return 1},get lastItem(){return 2}});Yi=null;qi;$i;Qi;tr;er;sr;ir;rr=w;oi=null;ar(){this.Yi.menuItemHTMLElements.forEach((t=>{t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}))}nr(t){switch(this.ar(),t){case Qt.Ji.previousItem:case Qt.Ji.nextItem:this.rr+=t,w===this.rr&&(this.rr=this.Yi.menuItemHTMLElements.length-1),this.Yi.menuItemHTMLElements.length===this.rr&&(this.rr=0);break;case Qt.Ji.firstItem:this.rr=0;break;case Qt.Ji.lastItem:this.rr=this.Yi.menuItemHTMLElements.length-1}this.Yi.menuItemHTMLElements[this.rr].classList.add("TravelNotes-ContextMenu-ItemSelected")}constructor(t){this.Yi=t,this.qi=new Gt(this),this.$i=new qt(this),this.Qi=new $t(this),this.tr=new Xt(this),this.er=new Yt(this),this.sr=new Zt(this),this.ir=new Jt(this),document.addEventListener("keydown",this.qi,!0),this.Yi.container.addEventListener("mouseleave",this.$i),this.Yi.container.addEventListener("mouseenter",this.Qi),this.Yi.cancelButton.addEventListener("click",this.tr),this.Yi.menuItemHTMLElements.forEach((t=>{t.addEventListener("click",this.er),t.addEventListener("mouseleave",this.sr),t.addEventListener("mouseenter",this.ir)}))}destructor(){this.oi&&(clearTimeout(this.oi),this.oi=null),document.removeEventListener("keydown",this.qi,!0),this.Yi.container.removeEventListener("mouseleave",this.$i),this.Yi.container.removeEventListener("mouseenter",this.Qi),this.Yi.cancelButton.removeEventListener("click",this.tr),this.Yi.menuItemHTMLElements.forEach((t=>{t.removeEventListener("click",this.er),t.removeEventListener("mouseleave",this.sr),t.removeEventListener("mouseenter",this.ir)})),this.qi=null,this.$i=null,this.Qi=null,this.tr=null,this.er=null,this.sr=null,this.ir=null,this.Yi.parentNode.removeChild(this.Yi.container),this.Yi=null}onMouseLeaveContainer(){this.oi=setTimeout((()=>this.onCancelMenu()),t.contextMenu.timeout)}onMouseEnterContainer(){this.oi&&(clearTimeout(this.oi),this.oi=null)}onKeydownKeyboard(t){switch(t){case"Escape":case"Esc":this.onCancelMenu();break;case"ArrowDown":case"ArrowRight":case"Tab":this.nr(Qt.Ji.nextItem);break;case"ArrowUp":case"ArrowLeft":this.nr(Qt.Ji.previousItem);break;case"Home":this.nr(Qt.Ji.firstItem);break;case"End":this.nr(Qt.Ji.lastItem);break;case"Enter":if(w===this.rr||this.Yi.menuItemHTMLElements[this.rr].classList.contains("TravelNotes-ContextMenu-ItemDisabled"))return;this.Yi.onOk(this.rr)}}onCancelMenu(){this.Yi.onCancel("Canceled by user")}selectItem(t){this.Yi.menuItemHTMLElements[t].classList.contains("TravelNotes-ContextMenu-ItemDisabled")||this.Yi.onOk(t)}onMouseLeaveMenuItem(t){t.classList.remove("TravelNotes-ContextMenu-ItemSelected")}onMouseEnterMenuItem(t){this.ar(),this.rr=Number.parseInt(t.dataset.tanObjId),t.classList.add("TravelNotes-ContextMenu-ItemSelected")}}class te{hr;lr;cr;constructor(t,e,s){this.hr=t,this.lr=e,this.cr=s}get itemText(){return this.hr}get isActive(){return this.lr}get action(){return this.cr}}class ee{ur;vr;dr;pr;_r;constructor(t,e){this.ur=t.clientX||t.originalEvent.clientX||0,this.vr=t.clientY||t.originalEvent.clientY||0,this.dr=[t.latlng?t.latlng.lat:h.defaultValue,t.latlng?t.latlng.lng:h.defaultValue],this.pr=t.target?.objId??(Number.parseInt(t?.currentTarget?.dataset?.tanObjId)||m),this._r=Boolean(e)}get clientX(){return this.ur}get clientY(){return this.vr}get latLng(){return this.dr}get targetObjId(){return this.pr}get haveParentNode(){return this._r}}class se{static mr=null;gr;wr;Nr;Ie;Be;Tr;br;Zi;static get yr(){return 20}Ir(){this.Ie=et.create("div",{className:"TravelNotes-ContextMenu-Container"},this.Nr)}Mr(){this.Be=et.create("div",{textContent:"❌",className:"TravelNotes-ContextMenu-CloseButton",title:S.getText("BaseContextMenu - Close")},this.Ie)}Dr(){this.Tr=[];let t=0;this.menuItems.forEach((e=>{const s=et.create("div",{textContent:e.itemText,className:"TravelNotes-ContextMenu-Item",dataset:{ObjId:String(t++)}},this.Ie);e.isActive||s.classList.add("TravelNotes-ContextMenu-ItemDisabled"),this.Tr.push(s)}))}Er(){const t=Math.min(this.br.clientY,V.map.getContainer().clientHeight-this.Ie.clientHeight-se.yr);if(this.Ie.style.top=String(t)+"px",this.br.haveParentNode)this.Ie.style.right=String(se.yr)+"px";else{const t=Math.min(this.br.clientX,V.map.getContainer().clientWidth-this.Ie.clientWidth-se.yr);this.Ie.style.left=String(t)+"px"}}Pr(t,e){this.gr=t,this.wr=e,this.Ir(),this.Mr(),this.Dr(),this.Er(),this.Zi=new Qt(this)}constructor(t,e){se.mr?se.mr.onCancel():(this.br=new ee(t,e),this.Nr=e||document.body,se.mr=this)}onOk(t){this.Zi.destructor(),se.mr=null,this.gr(t)}onCancel(){this.Zi.destructor(),se.mr=null,this.wr()}show(){se.mr&&new Promise(((t,e)=>{this.Pr(t,e)})).then((t=>this.menuItems[t].action())).catch((t=>{t&&console.error(t)}))}get menuItems(){return[]}get parentNode(){return this.Nr}get container(){return this.Ie}get cancelButton(){return this.Be}get menuItemHTMLElements(){return this.Tr}get eventData(){return this.br}}class ie{Ce;Cr;Lr;constructor(t){if("string"!=typeof t?.title||"string"!=typeof t?.htmlBefore||t.htmlAfter&&"string"!=typeof t.htmlAfter)throw new Error("Invalid toolbar button");let e=(t.htmlBefore||"")+(t.htmlAfter||""),s=L.sanitizeToHtmlString(e).errorsString;if(""!==s)throw new Error("Invalid toolbar button : "+e+s);this.Ce=L.sanitizeToHtmlString(t.title).htmlString,""===this.title&&(this.title="?"),this.Cr=t.htmlBefore||"",this.Lr=t.htmlAfter||""}get title(){return this.Ce}get htmlBefore(){return this.Cr}get htmlAfter(){return this.Lr}}class re{ot;Sr;kr;Bt;Ar;constructor(t){this.ot="string"==typeof t?.name?L.sanitizeToJsString(t.name):"?",this.Sr="string"==typeof t.icon?L.sanitizeToHtmlString(t?.icon).htmlString:"?",this.kr="string"==typeof t?.tooltip?L.sanitizeToHtmlString(t.tooltip).htmlString:"?",this.Bt="number"==typeof t?.width?t.width:a.width,this.Ar="number"==typeof t?.height?t.height:a.height}get name(){return this.ot}get icon(){return this.Sr}get tooltip(){return this.kr}get width(){return this.Bt}get height(){return this.Ar}}const oe=new class{Rr;Or;Br;constructor(){this.Rr=[],this.Or=new Map,this.Br=[]}get editionButtonsData(){return this.Rr}get preDefinedIconsData(){return this.Br}preDefinedIconDataAt(t){return this.Br[t]}preDefinedIconDataFromName(t){const e=this.Or.get(t);return e?e.icon:""}loadJson(t){if(t.editionButtons&&t.editionButtons.forEach((t=>{try{let e=new ie(t);this.Rr.push(e)}catch(t){console.error(t.message)}})),t.preDefinedIconsList){t.preDefinedIconsList.forEach((t=>{const e=new re(t);this.Or.set(e.name,e)})),this.Br.length=0;for(const t of this.Or)this.Br.push(t[1]);this.Br=this.Br.sort(((t,e)=>t.name.localeCompare(e.name)))}}};class ae{Ss;jr;Hr;Ur;Fr;Kr(){this.jr=et.create("select",{className:"TravelNotes-NoteDialog-Select",id:"TravelNotes-NoteDialog-IconSelect"},this.Ss),oe.preDefinedIconsData.forEach((t=>{this.jr.add(et.create("option",{text:t.name}))})),this.jr.selectedIndex=w}si(){this.Hr=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogToolbar - show hidden contents"),textContent:"▼"},this.Ss),this.Ur=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogToolbar - Open a configuration file"),textContent:"📂"},this.Ss)}Wr(){oe.editionButtonsData.forEach((t=>{const e=et.create("div",{dataset:{HtmlBefore:t.htmlBefore,HtmlAfter:t.htmlAfter},className:"TravelNotes-NoteDialog-EditorButton"},this.Ss);L.sanitizeToHtmlElement(t.title,e),this.Fr.push(e)}))}Vr(){this.Kr(),this.si(),this.Wr()}zr(t){this.jr.addEventListener("change",t.iconSelectorChange),this.Hr.addEventListener("click",t.toggleContentsButtonClick),this.Fr.forEach((e=>{e.addEventListener("click",t.editionButtonsClick)})),this.Ur.addEventListener("click",t.openFileButtonClick,!1)}Gr(t){this.jr.removeEventListener("change",t.iconSelectorChange),this.Hr.removeEventListener("click",t.toggleContentsButtonClick),this.Fr.forEach((e=>{e.removeEventListener("click",t.editionButtonsClick)})),this.Ur.removeEventListener("click",t.openFileButtonClick,!1)}constructor(t){this.Fr=[],this.Ss=et.create("div",{id:"TravelNotes-NoteDialog-ToolbarDiv"}),this.Vr(),this.zr(t)}destructor(t){this.Gr(t)}update(t){this.Gr(t),this.Ss.textContent="",this.Fr=[],this.Vr(),this.zr(t)}get rootHTMLElement(){return this.Ss}}class ne{Xr=null;Zr=null;Jr=null;constructor(t){this.Xr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:S.getText("NoteDialogIconDimsControl - Icon width")},this.Xr),this.Zr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:a.width,dataset:{Name:"iconWidth"}},this.Xr),et.create("text",{value:S.getText("NoteDialogIconDimsControl - Icon height")},this.Xr),this.Jr=et.create("input",{type:"number",className:"TravelNotes-NoteDialog-NumberInput",value:a.height,dataset:{Name:"iconHeight"}},this.Xr),this.Zr.addEventListener("input",t.controlInput),this.Jr.addEventListener("input",t.controlInput)}destructor(t){this.Zr.removeEventListener("input",t.controlInput),this.Jr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Xr]}get iconWidth(){return Number.parseInt(this.Zr.value)}set iconWidth(t){this.Zr.value=t}get iconHeight(){return Number.parseInt(this.Jr.value)}set iconHeight(t){this.Jr.value=t}}class he{Yr;qr;constructor(e){this.Yr=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogIconControl - Icon content")}),this.qr=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",placeholder:"?????",rows:t.noteDialog.areaHeight.icon,dataset:{Name:"iconContent"}},this.Yr),this.qr.addEventListener("focus",e.controlFocus),this.qr.addEventListener("input",e.controlInput)}destructor(t){this.qr.removeEventListener("focus",t.controlFocus),this.qr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.Yr]}get iconContent(){return this.qr.value}set iconContent(t){this.qr.value=t}}class le{$r;Qr;constructor(t){this.$r=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogTooltipControl - Tooltip content")}),this.Qr=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"tooltipContent"}},this.$r),this.Qr.addEventListener("focus",t.controlFocus),this.Qr.addEventListener("input",t.controlInput)}destructor(t){this.Qr.removeEventListener("focus",t.controlFocus),this.Qr.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.$r]}get tooltipContent(){return this.Qr.value}set tooltipContent(t){this.Qr.value=t}}class ce{eo;so;constructor(e){this.eo=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv",textContent:S.getText("NoteDialogPopupControl - Text")}),this.so=et.create("textarea",{className:"TravelNotes-NoteDialog-TextArea",rows:t.noteDialog.areaHeight.popupContent,dataset:{Name:"popupContent"}},this.eo),this.so.addEventListener("focus",e.controlFocus),this.so.addEventListener("input",e.controlInput)}destructor(t){this.so.removeEventListener("focus",t.controlFocus),this.so.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.eo]}get popupContent(){return this.so.value}set popupContent(t){this.so.value=t}}class ue{io;ro;oo;ao;constructor(t){this.io=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.ao=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("NoteDialogAddressControl - Reset address"),textContent:"🔄"},this.io),et.create("text",{value:S.getText("NoteDialogAddressControl - Address")},this.io),this.ro=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.oo=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"address"}},this.ro),this.oo.addEventListener("focus",t.controlFocus),this.oo.addEventListener("input",t.controlInput),this.ao.addEventListener("click",t.addressButtonClick)}destructor(t){this.oo.removeEventListener("focus",t.controlFocus),this.oo.removeEventListener("input",t.controlInput),this.ao.removeEventListener("click",t.addressButtonClick)}get HTMLElements(){return[this.io,this.ro]}get address(){return this.oo.value}set address(t){this.oo.value=t}}class ve{no;ho;lo;co(e){t.noteDialog.theDevil.addButton&&et.create("text",{value:"👿"},et.create("a",{href:"https://www.google.com/maps/@"+e[0].toFixed(h.fixed)+","+e[1].toFixed(h.fixed)+","+t.noteDialog.theDevil.zoomFactor+"z",target:"_blank",title:"Reminder! The devil will know everything about you"},et.create("div",{className:"TravelNotes-BaseDialog-Button",title:"Reminder! The devil will know everything about you"},this.no)))}constructor(t,e){this.no=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.co(e),et.create("text",{value:S.getText("NoteDialogLinkControl - Link")},this.no),this.ho=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.lo=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"url"}},this.ho),this.lo.addEventListener("focus",t.controlFocus),this.lo.addEventListener("input",t.controlInput),this.lo.addEventListener("blur",t.urlInputBlur)}destructor(t){this.lo.removeEventListener("focus",t.controlFocus),this.lo.removeEventListener("input",t.controlInput),this.lo.removeEventListener("blur",t.urlInputBlur)}get HTMLElements(){return[this.no,this.ho]}get url(){return this.lo.value}set url(t){this.lo.value=t}}class de{uo;vo;do;constructor(t){this.uo=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),et.create("text",{value:" "+S.getText("NoteDialogPhoneControl - Phone")},this.uo),this.vo=et.create("div",{className:"TravelNotes-NoteDialog-DataDiv"}),this.do=et.create("input",{type:"text",className:"TravelNotes-NoteDialog-InputText",dataset:{Name:"phone"}},this.vo),this.do.addEventListener("focus",t.controlFocus),this.do.addEventListener("input",t.controlInput)}destructor(t){this.do.removeEventListener("focus",t.controlFocus),this.do.removeEventListener("input",t.controlInput)}get HTMLElements(){return[this.uo,this.vo]}get phone(){return this.do.value}set phone(t){this.do.value=t}}class pe{po;_o;constructor(t){this._o=t,this.po=et.create("div",{className:"TravelNotes-NoteDialog-PreviewDiv"}),this.po.appendChild(Vt.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",new $(this._o,null)))}update(){this.po.textContent="",this.po.appendChild(Vt.getNoteTextAndIconHTML("TravelNotes-NoteDialog-",{note:this._o,route:null}))}get HTMLElements(){return[this.po]}}class _e{searchPlaces=!0;searchWays=!0;searchRelations=!0;setGeometry=!0;constructor(){}}class me{es;mo;wo;No;To;fo;bo;dr;yo;Io;Mo;Do(){this.wo.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.nodes.forEach((s=>{const i=this.mo.get(s);t.geometry[0].push([i.lat,i.lon]),t.lat+=i.lat,t.lon+=i.lon,e++})),0!==e&&(t.lat/=e,t.lon/=e)})),this.No.forEach((t=>{t.geometry=[[]],t.lat=h.defaultValue,t.lon=h.defaultValue;let e=0;t.members.forEach((s=>{if("way"===s.type){const i=this.wo.get(s.ref);t.geometry.push(i.geometry[0]),t.lat+=i.lat,t.lon+=i.lon,e++}})),0!==e&&(t.lat/=e,t.lon/=e)}))}xo(e){e.forEach((e=>{switch(e.type){case"node":if(this.mo.set(e.id,e),e?.tags?.place&&this.es.searchPlaces&&this.bo[e.tags.place]&&e?.tags?.name){const t=q.pointsDistance(this.dr,[e.lat,e.lon]),s=this.bo[e.tags.place];s.maxDistance>t&&s.distance>t&&(s.distance=t,s.name=e.tags.name)}break;case"way":this.es.searchWays&&this.wo.set(e.id,e);break;case"relation":this.es.searchRelations&&this.No.set(e.id,e);break;case"area":if(this.es.searchPlaces){let s=e.tags.name;"*"!==t.nominatim.language&&e.tags["name:"+t.nominatim.language]&&(s=e.tags["name:"+t.nominatim.language]),this.To[Number.parseInt(e.tags.admin_level)]=s,"2"===e.tags.admin_level&&(this.fo=t.geoCoder.osmCityAdminLevel[e.tags["ISO3166-1"]]||this.fo)}}})),this.es.setGeometry&&this.Do(),this.es.searchPlaces&&this.Eo()}Eo(){let t=null;for(let e=2;e<this.To.length;e++)void 0!==this.To[e]&&(this.fo>=e?this.Io=this.To[e]:t=this.To[e]);let e=Number.MAX_VALUE;Object.values(this.bo).forEach((t=>{t.distance<e&&(e=t.distance,this.yo=t.name)})),this.yo=t||this.yo,this.yo===this.Io&&(this.yo=null)}async Po(t){for(let e=0;e<t.length;e++)if("fulfilled"===t[e].status&&_===t[e].value.status&&t[e].value.ok){const s=await t[e].value.json();this.xo(s.elements)}else this.Mo=!1,console.error("An error occurs when calling theOverpassAPI: "),console.error(t[e])}constructor(t){if(this.es=new _e,t)for(const[e,s]of Object.entries(t))this.es[e]&&(this.es[e]=s);this.mo=new Map,this.wo=new Map,this.No=new Map}async loadData(e,s){this.dr=s,this.Mo=!0,this.To=[],this.fo=t.geoCoder.osmCityAdminLevel.DEFAULT,this.bo=Object.freeze({hamlet:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.hamlet}),village:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.village}),city:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.city}),town:Object.seal({name:null,distance:Number.MAX_VALUE,maxDistance:t.geoCoder.distances.town})}),this.yo=null,this.Io=null,this.mo.clear(),this.wo.clear(),this.No.clear();const i=[];e.forEach((e=>{i.push(fetch(t.overpassApi.url+"?data=[out:json][timeout:"+t.overpassApi.timeOut+"];"+e))})),await Promise.allSettled(i).then((t=>this.Po(t)))}get nodes(){return this.mo}get ways(){return this.wo}get relations(){return this.No}get place(){return this.yo}get city(){return this.Io}get country(){return this.To[2]}get statusOk(){return this.Mo}}class ge{Co=!1;ot="";Lo="";Io="";So="";ko(t,e){t.error||e.error?this.Co=!1:(this.ot=e.namedetails.name,e.address.house_number&&(this.Lo=e.address.house_number+" "),e.address.road?this.Lo+=e.address.road+" ":e.address.pedestrian&&(this.Lo+=e.address.pedestrian+" "),this.Io=t.address.city||t.address.town||t.address.municipality||t.address.village||"",this.So=e.address.country,this.Co=!0)}constructor(){}async loadData(e){this.Co=!1;const s=t.nominatim.url+"reverse?format=json&lat="+e[0]+"&lon="+e[1];let i=s+"&zoom=10&addressdetails=1&namedetails=0",r=s+"&zoom=18&addressdetails=1&namedetails=1";const o=t.nominatim.language;o&&"*"!==o&&(i+="&accept-language="+o,r+="&accept-language="+o);const a=new Headers;o&&"*"===o&&a.append("accept-language","");const n=await fetch(i,{headers:a}),h=await fetch(r,{headers:a});_===n.status&&n.ok&&_===h.status&&h.ok?this.ko(await n.json(),await h.json()):this.Co=!1}get name(){return this.Co?this.ot:null}get street(){return this.Co?this.Lo:null}get city(){return this.Co?this.Io:null}get country(){return this.Co?this.So:null}}class we{ot;Lo;Io;constructor(t,e,s){this.ot=L.sanitizeToJsString(t),this.Lo=L.sanitizeToJsString(e),this.Io=L.sanitizeToJsString(s)}get name(){return this.ot}get street(){return this.Lo}get city(){return this.Io}}class Ne{static get Ao(){return Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town)}dr;Ro;Oo;Bo(){let t=this.Oo.city||this.Oo.country||"";const e=this.Ro.place;e&&e!==t&&(t+=" ("+e+")");let s=(this.Oo.street||"").replaceAll(";"," "),i=this.Oo.name||"";return(s.includes(i)||t.includes(i))&&(i=""),new we(i,s,t)}jo(){return["node(around:"+Ne.Ao+","+this.dr[0]+","+this.dr[1]+")[place];out;"]}async Ho(){return await this.Ro.loadData(this.jo(),this.dr),await this.Oo.loadData(this.dr),this.Bo()}async Uo(t,e){t(await this.Ho())}constructor(){this.Ro=new me({searchWays:!1,searchRelations:!1,setGeometry:!0}),this.Oo=new ge({searchPlaces:!0,searchWays:!1,searchRelations:!1,setGeometry:!1})}async getAddressAsync(t){return this.dr=t,this.Ho()}getAddressWithPromise(t){return this.dr=t,new Promise(((t,e)=>this.Uo(t,e)))}}class Te{Fo;Ro;Ko;Wo(){this.Ko=document.createElementNS(N,"svg"),this.Ko.setAttributeNS(null,"viewBox",String(a.svgViewboxDim/4)+" "+a.svgViewboxDim/4+" "+a.svgViewboxDim/2+" "+a.svgViewboxDim/2),this.Ko.setAttributeNS(null,"class","TravelNotes-SvgIcon")}Vo(){let e=-1,s=w,i=w;const r=[];if(this.Fo.route.itinerary.itineraryPoints.forEach((o=>{e++;const n=Y.addPoints(Y.project(o.latLng,t.note.svgIcon.zoom),this.Fo.translation);r.push(n);n[0]>=0&&n[1]>=0&&n[0]<=a.svgViewboxDim&&n[1]<=a.svgViewboxDim&&(w===s&&(s=e),i=e)})),w!==s&&w!==i){0<s&&s--,this.Fo.route.itinerary.itineraryPoints.length-1>i&&i++;let t="";for(e=s;e<=i;e++)t+=r[e][0].toFixed(0)+","+r[e][1].toFixed(0)+" ";const o=document.createElementNS(N,"polyline");o.setAttributeNS(null,"points",t),o.setAttributeNS(null,"class","TravelNotes-OSM-Itinerary"),o.setAttributeNS(null,"transform","rotate("+this.Fo.rotation+","+a.svgViewboxDim/2+","+a.svgViewboxDim/2+")"),this.Ko.appendChild(o)}}zo(){this.Ro.ways.forEach((e=>{let s=w,i=w,r=-1;const o=[];if(e.nodes.forEach((e=>{r++;const n=this.Ro.nodes.get(e),h=Y.addPoints(Y.project([n.lat,n.lon],t.note.svgIcon.zoom),this.Fo.translation);o.push(h);h[0]>=0&&h[1]>=0&&h[0]<=a.svgViewboxDim&&h[1]<=a.svgViewboxDim&&(w===s&&(s=r),i=r)})),w!==s&&w!==i){0<s&&s--,e.nodes.length-1>i&&i++;let t="";for(r=s;r<=i;r++)t+=o[r][0].toFixed(0)+","+o[r][1].toFixed(0)+" ";const n=document.createElementNS(N,"polyline");n.setAttributeNS(null,"points",t),n.setAttributeNS(null,"class","TravelNotes-OSM-Highway TravelNotes-OSM-Highway-"+e.tags.highway),n.setAttributeNS(null,"transform","rotate("+this.Fo.rotation+","+a.svgViewboxDim/2+","+a.svgViewboxDim/2+")"),this.Ko.appendChild(n)}}))}Go(){if(""===this.Fo.rcnRef)return;const t=document.createElementNS(N,"text");t.textContent=this.Fo.rcnRef,t.setAttributeNS(null,"x",String(a.svgViewboxDim/2)),t.setAttributeNS(null,"y",String(a.svgViewboxDim/2)),t.setAttributeNS(null,"class","TravelNotes-OSM-RcnRef"),this.Ko.appendChild(t)}constructor(){}buildSvg(t,e,s){this.Fo=t,this.Ro=s,this.Wo(),this.Vo(),this.zo(),this.Go(),e.iconContent=this.Ko.outerHTML}}class fe{isMini;isEntry;isExit;constructor(){this.isMini=!1,this.isEntry=!1,this.isExit=!1}}class be{Fo;Xo;Ro;Zo;Jo;Yo;qo;$o;Qo;ta;ea;sa(t){return(t.tags.name?t.tags.name:"")+(t.tags.name&&t.tags.ref?" ":"")+(t.tags.ref?"["+t.tags.ref+"]":"")}ia(t){const e=5e-6;let s=!1;return this.Fo.route.wayPoints.forEach((i=>{Math.abs(t.lat-i.lat)<e&&Math.abs(t.lng-i.lng)<e&&(s=!0)})),!s&&(this.Xo.latLng[0]!==t.lat||this.Xo.latLng[1]!==t.lng)}ra(){const e=this.Fo.route.itinerary.itineraryPoints.previous(this.Fo.nearestItineraryPointObjId,(t=>this.ia(t))),s=this.Fo.route.itinerary.itineraryPoints.next(this.Fo.nearestItineraryPointObjId,(t=>this.ia(t)));let r=Number.MAX_VALUE,o=Number.MAX_VALUE,a=Number.MAX_VALUE,n=Number.MAX_VALUE,h=i.defaultValue;this.Ro.nodes.forEach((i=>{h=q.pointsDistance([i.lat,i.lon],this.Xo.latLng),"bike"===this.Fo.route.itinerary.transitMode&&i?.tags?.rcn_ref&&i.tags["network:type"]&&"node_network"===i.tags["network:type"]&&h<t.note.svgIcon.rcnRefDistance&&h<o&&(this.Zo=i,o=h),h<r&&(this.Yo=i.id,r=h),e&&(h=q.pointsDistance([i.lat,i.lon],e.latLng),h<a&&(this.qo=i.id,a=h)),s&&(h=q.pointsDistance([i.lat,i.lon],s.latLng),h<n&&(this.$o=i.id,n=h))})),this.Jo=this.Ro.nodes.get(this.Yo)}oa(){this.ea.isMini="mini_roundabout"===this?.Jo?.tags?.highway}aa(){this.Zo&&(this.Fo.rcnRef=this.Zo.tags.rcn_ref,this.Xo.tooltipContent+=S.getText("StreetFinder - rcnRef",{rcnRef:this.Fo.rcnRef}))}na(){this.Ro.ways.forEach((t=>{if(!t.nodes.includes(this.Yo))return;const e=this.sa(t),s=""!==e,i=t.nodes.includes(this.qo),r=t.nodes.includes(this.$o);let o=2*t.nodes.filter((t=>t===this.Yo)).length;if(t.nodes[0]===this.Yo&&o--,t.nodes[t.nodes.length-1]===this.Yo&&o--,i&&(this.Qo=s?e:"???",o--,"roundabout"===t?.tags?.junction&&(this.ea.isExit=!0)),0!==o&&(r&&(this.ta=s?e:"???",o--,"roundabout"===t?.tags?.junction&&(this.ea.isEntry=!0)),0!==o&&s))for(;0!==o;)this.Xo.address=""===this.Xo.address?e:this.Xo.address+" ⪥  "+e,o--}))}ha(){""!==this.Ro.city&&(this.Xo.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+this.Ro.city+"</span>"),this.Ro.place&&this.Ro.place!==this.Ro.city&&(this.Xo.address+=" ("+this.Ro.place+")")}la(){n.atStart===this.Fo.positionOnRoute?(this.Xo.address="🟢 "+this.ta,this.ha()):n.atEnd===this.Fo.positionOnRoute?(this.ha(),this.Xo.address=this.Qo,this.ha(),this.Xo.address+=" 🔴 "):(this.Xo.address=this.Qo+(""===this.Xo.address?"":" ⪥  "+this.Xo.address)+" "+this.Fo.directionArrow+" "+this.ta,this.ha())}ca(){this.ea.isEntry&&!this.ea.isExit?this.Xo.tooltipContent+=S.getText("StreetFinder - entry roundabout"):!this.ea.isEntry&&this.ea.isExit?this.Xo.tooltipContent+=S.getText("StreetFinder - exit roundabout"):this.ea.isEntry&&this.ea.isExit&&(this.Xo.tooltipContent+=S.getText("StreetFinder - continue roundabout")),this.ea.isMini&&(this.Xo.tooltipContent+=S.getText("StreetFinder - at the small roundabout on the ground"))}constructor(){}findData(t,e,s){this.Fo=t,this.Xo=e,this.Ro=s,this.Yo=w,this.qo=w,this.$o=w,this.Qo="",this.ta="",this.ea=new fe,this.ra(),this.oa(),this.aa(),this.na(),this.la(),this.ca()}}class ye{constructor(){}findData(e,s){null!==e.direction&&(e.direction<t.note.svgIcon.angleDirection.right?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂"):e.direction<t.note.svgIcon.angleDirection.slightRight?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn slight right"),e.directionArrow="🢅"):e.direction<t.note.svgIcon.angleDirection.continue?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Continue"),e.directionArrow="🢁"):e.direction<t.note.svgIcon.angleDirection.slightLeft?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn slight left"),e.directionArrow="🢄"):e.direction<t.note.svgIcon.angleDirection.left?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn left"),e.directionArrow="🢀"):e.direction<t.note.svgIcon.angleDirection.sharpLeft?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn sharp left"),e.directionArrow="🢇"):e.direction<t.note.svgIcon.angleDirection.sharpRight?(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn sharp right"),e.directionArrow="🢆"):(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Turn right"),e.directionArrow="🢂")),n.atStart===e.positionOnRoute?s.tooltipContent=S.getText("ArrowAndTooltipFinder - Start"):n.atEnd===e.positionOnRoute&&(s.tooltipContent=S.getText("ArrowAndTooltipFinder - Stop"))}}class Ie{Fo;Xo;ua;va;da;pa(){this.Fo.translation=Y.subtrackPoints([a.svgViewboxDim/2,a.svgViewboxDim/2],Y.project(this.Xo.latLng,t.note.svgIcon.zoom))}_a(){this.ua=this.Fo.route.itinerary.itineraryPoints.previous(this.Fo.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Xo.latLng)>t.note.svgIcon.angleDistance))||this.Fo.route.itinerary.itineraryPoints.first}ma(){this.va=this.Fo.route.itinerary.itineraryPoints.next(this.Fo.nearestItineraryPointObjId,(e=>q.pointsDistance(e.latLng,this.Xo.latLng)>t.note.svgIcon.angleDistance))||this.Fo.route.itinerary.itineraryPoints.last}ga(){this.da=Y.addPoints(Y.project(this.Xo.latLng,t.note.svgIcon.zoom),this.Fo.translation)}wa(){if(this.Fo.nearestItineraryPointObjId!==this.Fo.route.itinerary.itineraryPoints.first.objId){const e=Y.addPoints(Y.project(this.ua.latLng,t.note.svgIcon.zoom),this.Fo.translation);this.Fo.rotation=Math.atan((this.da[1]-e[1])/(e[0]-this.da[0]))*s.d180/Math.PI,0>this.Fo.rotation&&(this.Fo.rotation+=s.d360),this.Fo.rotation-=s.d270,0>e[0]-this.da[0]&&(this.Fo.rotation+=s.d180)}}Na(){if(this.Fo.nearestItineraryPointObjId!==this.Fo.route.itinerary.itineraryPoints.last.objId){const e=Y.addPoints(Y.project(this.va.latLng,t.note.svgIcon.zoom),this.Fo.translation);for(this.Fo.direction=Math.atan((this.da[1]-e[1])/(e[0]-this.da[0]))*s.d180/Math.PI,0>e[0]-this.da[0]&&(this.Fo.direction+=s.d180),this.Fo.direction-=this.Fo.rotation;s.d0>this.Fo.direction;)this.Fo.direction+=s.d360;for(;s.d360<this.Fo.direction;)this.Fo.direction-=s.d360}}Ta(){this.Fo.nearestItineraryPointObjId===this.Fo.route.itinerary.itineraryPoints.first.objId&&(this.Fo.rotation=-this.Fo.direction-s.d90,this.Fo.direction=null,this.Fo.positionOnRoute=n.atStart),this.Xo.latLng[0]===this.Fo.route.itinerary.itineraryPoints.last.lat&&this.Xo.latLng[1]===this.Fo.route.itinerary.itineraryPoints.last.lng&&(this.Fo.direction=null,this.Fo.positionOnRoute=n.atEnd)}constructor(){}findData(t,e){this.Fo=t,this.Xo=e,this.pa(),this._a(),this.ma(),this.ga(),this.wa(),this.Na(),this.Ta()}}class Me{constructor(){}iconContent="";tooltipContent="";address="";latLng=[h.defaultValue,h.defaultValue]}class De{constructor(){}nearestItineraryPointObjId=m;route=null;positionOnRoute=n.onRoute;direction=null;directionArrow=" ";rcnRef="";rotation=0;translation=[0,0]}class xe{Xo;Fo;Ro;Ao;fa;static get ba(){return 1.5}ya(){let t=null,e=Number.MAX_VALUE;this.Fo.route.itinerary.itineraryPoints.forEach((s=>{const i=q.pointsDistance(this.Xo.latLng,s.latLng);e>i&&(e=i,t=s)})),this.Xo.latLng=t.latLng,this.Fo.nearestItineraryPointObjId=t.objId}Ia(){return(new Ie).findData(this.Fo,this.Xo),(new ye).findData(this.Fo,this.Xo),(new be).findData(this.Fo,this.Xo,this.Ro),(new Te).buildSvg(this.Fo,this.Xo,this.Ro),this.fa=!1,this.Xo}async Ma(){if(this.fa)return null;this.fa=!0,this.Fo.nearestItineraryPointObjId=m,this.Fo.positionOnRoute=n.onRoute,this.Fo.direction=null,this.Fo.directionArrow=" ",this.Fo.translation=[0,0],this.Fo.rotation=0,this.Fo.rcnRef="",this.Xo.iconContent="",this.Xo.tooltipContent="",this.Xo.address="",this.ya();const t=this.Xo.latLng[0].toFixed(h.fixed)+","+this.Xo.latLng[1].toFixed(h.fixed),e=["way[highway](around:"+(a.svgViewboxDim*xe.ba).toFixed(0)+","+t+")->.a;(.a >;.a;)->.a;.a out;is_in("+t+')->.e;area.e[admin_level][boundary="administrative"];out;node(around:'+this.Ao+","+t+")[place];out;"];return await this.Ro.loadData(e,this.Xo.latLng),this.Ro.statusOk?this.Ia():null}async Da(t,e){const s=await this.Ma();s?t(s):e("An error occurs...")}constructor(){this.Xo=new Me,this.Fo=new De,this.Ro=new me({searchRelations:!1,setGeometry:!1}),this.Ao=Math.max(t.geoCoder.distances.hamlet,t.geoCoder.distances.village,t.geoCoder.distances.city,t.geoCoder.distances.town),this.fa=!1}async getIconAndAdressAsync(t,e){return this.Xo.latLng=t,this.Fo.route=e,this.Ma()}getIconAndAdressWithPromise(t){return this.Xo.latLng=t.latLng,this.Fo.route=t.route,new Promise(((t,e)=>this.Da(t,e)))}}class Ee{xa;Ea(t){this.xa.hideWait();let e=t.street;""!==t.city&&(e+=' <span class="TravelNotes-NoteHtml-Address-City">'+t.city+"</span>"),this.xa.setControlsValues({address:e}),this.xa.updatePreview({address:e})}constructor(t){this.xa=t}setAddressWithGeoCoder(t){this.xa.showWait(),this.xa.hideError(),(new Ne).getAddressWithPromise(t).then((t=>{this.Ea(t)})).catch((t=>{t&&console.error(t),this.xa.hideWait(),this.xa.showError(S.getText("NoteDialogGeoCoderHelper - an error occurs when searching the adress"))}))}}class Pe{xa;dr;constructor(t,e){this.xa=t,this.dr=e}handleEvent(t){t.stopPropagation(),new Ee(this.xa).setAddressWithGeoCoder(this.dr)}}class Ce{xa;constructor(t){this.xa=t}handleEvent(t){t.stopPropagation(),"url"===t.target.dataset.tanName?this.xa.focusControl=null:this.xa.focusControl=t.target}}class Le{xa;constructor(t){this.xa=t}handleEvent(t){if(t.stopPropagation(),""===t.target.value)return void this.xa.hideError();""===L.sanitizeToUrl(t.target.value).errorsString?this.xa.hideError():this.xa.showError(S.getText("UrlInputBlurEL - invalidUrl"))}}class Se{xa;constructor(t){this.xa=t}handleEvent(t){t.stopPropagation();const e={};"iconWidth"===t.target.dataset.tanName||"iconHeight"===t.target.dataset.tanName?e[t.target.dataset.tanName]=Number.parseInt(t.target.value):e[t.target.dataset.tanName]=t.target.value,this.xa.updatePreview(e)}}class ke{xa;constructor(t){this.xa=t}handleEvent(t){if(!this.xa.focusControl)return;const e=t.currentTarget;let s=this.xa.focusControl.selectionStart,i=this.xa.focusControl.selectionEnd;this.xa.focusControl.value=this.xa.focusControl.value.slice(0,s)+e.dataset.tanHtmlBefore+(0===e.dataset.tanHtmlAfter.length?"":this.xa.focusControl.value.slice(s,i))+e.dataset.tanHtmlAfter+this.xa.focusControl.value.slice(i),s===i||0===e.dataset.tanHtmlAfter.length?(s+=e.dataset.tanHtmlBefore.length,i=s):i+=e.dataset.tanHtmlBefore.length+e.dataset.tanHtmlAfter.length,this.xa.focusControl.setSelectionRange(s,i),this.xa.focusControl.focus();const r={};r[this.xa.focusControl.dataset.tanName]=this.xa.focusControl.value,this.xa.updatePreview(r)}}class Ae{xa;Pa(t){this.xa.setControlsValues(t),this.xa.updatePreview(t)}Ca(){const t=this.xa.mapIconData;t.route?(this.xa.showWait(),(new xe).getIconAndAdressWithPromise(t).then((t=>{this.xa.hideWait(),this.Pa(t)})).catch((t=>{t instanceof Error&&console.error(t),this.xa.hideWait(),this.xa.showError(S.getText("IconSelectorChangeEL - an error occurs when creating the SVG icon"))}))):this.xa.showError(S.getText("IconSelectorChangeEL - not possible to create a SVG icon for a travel note"))}constructor(t){this.xa=t}handleEvent(t){t.stopPropagation();const e=oe.preDefinedIconDataAt(t.target.selectedIndex);"SvgIcon"!==e.icon?this.Pa({iconContent:e.icon,iconHeight:e.height,iconWidth:e.width,tooltipContent:e.tooltip}):this.Ca()}}class Re{xa;constructor(t){this.xa=t}handleEvent(t){t.target.textContent="▼"===t.target.textContent?"▶":"▼",this.xa.toogleContents()}}class Oe{xa;constructor(t){this.xa=t}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{oe.loadJson(JSON.parse(e.result)),this.xa.updateToolbar()}catch(t){t instanceof Error&&console.error(t)}},e.readAsText(t.target.files[0])}}class Be{xa;constructor(t){this.xa=t}handleEvent(t){t.stopPropagation(),k.openFile(new Oe(this.xa),".json")}}class je{La;Sa;ka;Aa;Ra;Oa;Ba;ja;constructor(t,e){this.La=new Ce(t),this.Sa=new Se(t),this.ka=new Pe(t,e),this.Aa=new Le(t),this.Ra=new ke(t),this.Oa=new Ae(t),this.Ba=new Re(t),this.ja=new Be(t)}destructor(){this.La=null,this.Sa=null,this.ka=null,this.Aa=null,this.Ra=null,this.Oa=null,this.Ba=null,this.ja=null}get controlFocus(){return this.La}get controlInput(){return this.Sa}get addressButtonClick(){return this.ka}get urlInputBlur(){return this.Aa}get editionButtonsClick(){return this.Ra}get iconSelectorChange(){return this.Oa}get toggleContentsButtonClick(){return this.Ba}get openFileButtonClick(){return this.ja}}class He{dr;ae;constructor(t,e){this.dr=t,this.ae=e}get latLng(){return this.dr}get route(){return this.ae}}class Ue extends Nt{oe;Ha;ae;_o;Ua;Fa;Ka;Wa;Va;za;Ga;Xa;ui;Za;Ja;Ds(){this.ui.destructor(this.Ja),this.Ua.destructor(this.Ja),this.Fa.destructor(this.Ja),this.Ka.destructor(this.Ja),this.Wa.destructor(this.Ja),this.Va.destructor(this.Ja),this.za.destructor(this.Ja),this.Ga.destructor(this.Ja),this.Ja.destructor()}constructor(t,e){super(),this.Za=null,this.oe=t,this.ae=e,this.Ha=""===this.oe.address,this.Ja=new je(this,t.latLng),this._o=new U,this._o.jsonObject=t.jsonObject,this.ui=new ae(this.Ja),this.Ua=new ne(this.Ja),this.Fa=new he(this.Ja),this.Ka=new le(this.Ja),this.Wa=new ce(this.Ja),this.Va=new ue(this.Ja,this.Ha),this.za=new ve(this.Ja,t.latLng),this.Ga=new de(this.Ja),this.Xa=new pe(this._o),this.setControlsValues(t)}get focusControl(){return this.Za}set focusControl(t){this.Za=t}get mapIconData(){return new He(this._o.latLng,this.ae)}updatePreview(t){for(const e in t)this._o[e]=t[e];this.Xa.update()}onShow(){this.Ha&&new Ee(this).setAddressWithGeoCoder(this._o.latLng),this.toogleContents()}canClose(){return""===this.Fa.iconContent?(this.showError(S.getText("Notedialog - The icon content cannot be empty")),!1):""===this.za.url||""!==L.sanitizeToUrl(this.za.url).url||(this.showError(S.getText("NoteDialog - invalidUrl")),!1)}onCancel(){this.Ds(),super.onCancel()}onOk(){super.onOk()&&(this.oe.iconWidth=this.Ua.iconWidth,this.oe.iconHeight=this.Ua.iconHeight,this.oe.iconContent=this.Fa.iconContent,this.oe.tooltipContent=this.Ka.tooltipContent,this.oe.popupContent=this.Wa.popupContent,this.oe.address=this.Va.address,this.oe.url=this.za.url,this.oe.phone=this.Ga.phone,this.oe.latLng=this._o.latLng,this.Ds())}get title(){return S.getText("NoteDialog - Note")}get contentHTMLElements(){return[].concat(this.ui.rootHTMLElement,this.Ua.HTMLElements,this.Fa.HTMLElements,this.Ka.HTMLElements,this.Wa.HTMLElements,this.Va.HTMLElements,this.za.HTMLElements,this.Ga.HTMLElements)}get footerHTMLElements(){return this.Xa.HTMLElements}setControlsValues(t){this.Ua.iconHeight=t.iconHeight||this.Ua.iconHeight,this.Ua.iconWidth=t.iconWidth||this.Ua.iconWidth,this.Fa.iconContent=t.iconContent||this.Fa.iconContent,this.Ka.tooltipContent=t.tooltipContent||this.Ka.tooltipContent,this.Wa.popupContent=t.popupContent||this.Wa.popupContent,this.Va.address=t.address||this.Va.address,this.za.url=t.url||this.za.url,this.Ga.phone=t.phone||this.Ga.phone}toogleContents(){t.noteDialog.mask.iconsDimension&&this.Ua.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.iconTextArea&&this.Fa.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.popupContent&&this.Wa.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.tooltip&&this.Ka.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),t.noteDialog.mask.address&&(this.Va.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Va.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.link&&(this.za.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.za.HTMLElements[1].classList.toggle("TravelNotes-Hidden")),t.noteDialog.mask.phone&&(this.Ga.HTMLElements[0].classList.toggle("TravelNotes-Hidden"),this.Ga.HTMLElements[1].classList.toggle("TravelNotes-Hidden"))}updateToolbar(){this.ui.update(this.Ja)}}class Fe{Se;Ya;constructor(){}createUI(){if(this.Se)return;this.Se=et.create("div",{className:"TravelNotes-Background"},document.body);const t=et.create("div",{id:"TravelNotes-WaitUI"},this.Se);this.Ya=et.create("div",{id:"TravelNotes-WaitUI-MessageDiv"},t),et.create("div",{className:"TravelNotes-WaitAnimationBullet"},et.create("div",{className:"TravelNotes-WaitAnimation"},t))}showInfo(t){this.Ya.textContent=t}close(){document.body.removeChild(this.Se),this.Se=null}}const Ke=new class{oe=null;ae=null;qa=!0;$a=null;Qa(){this.qa?this.ae?(this.ae.notes.add(this.oe),this.oe.chainedDistance=this.ae.chainedDistance,this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Ut.dispatch("showitinerary")):(V.travel.notes.add(this.oe),Ut.dispatch("showtravelnotes")):Ut.dispatch(this.ae?"updateitinerary":"updatetravelnotes"),Ut.dispatch("noteupdated",{removedNoteObjId:this.oe.objId,addedNoteObjId:this.oe.objId}),Ut.dispatch("roadbookupdate")}xa(){new Ue(this.oe,this.ae).show().then((()=>this.Qa())).catch((t=>{console.error(t)}))}tn(t){this.qa=!0,this.oe=new U,this.oe.latLng=t,this.oe.iconLatLng=t}async en(t){if(t.tags.rcn_ref?this.oe.iconContent="<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text x='10' y='14'>"+t.tags.rcn_ref+"</text></svg></div>":this.oe.iconContent=oe.preDefinedIconDataFromName(t.description),this.oe.url=t.tags.website||"",this.oe.phone=t.tags.phone||"",this.oe.tooltipContent=t.description||"",this.oe.popupContent=t.tags.name||"",t.tags["addr:street"]&&t.tags["addr:city"])this.oe.address=(t.tags["addr:housenumber"]?t.tags["addr:housenumber"]+" ":"")+t.tags["addr:street"]+' <span class="TravelNotes-NoteHtml-Address-City">'+t.tags["addr:city"]+"</span>";else{const e=new Fe;e.createUI(),e.showInfo("Creating address");let s=null;try{s=await(new Ne).getAddressAsync([t.lat,t.lon])}catch(t){console.error(t)}e.close(),this.oe.address=s.street,""!==s.city&&(this.oe.address+=' <span class="TravelNotes-NoteHtml-Address-City">'+s.city+"</span>")}this.osmSearchNoteDialog||""===this.oe.iconContent?this.xa():this.Qa()}constructor(){}get osmSearchNoteDialog(){return null===this.$a&&(this.$a=t.osmSearch.showSearchNoteDialog),this.$a}changeOsmSearchNoteDialog(){this.$a=!this.osmSearchNoteDialog}newRouteNote(t,e){this.ae=tt.getRoute(t);const s=Y.getClosestLatLngDistance(this.ae,e);this.tn(s.latLng),this.oe.distance=s.distance,this.xa()}newSearchRouteNote(t){const e=tt.getNearestRouteData([t.lat,t.lon]);e.route?(this.tn(e.latLngOnRoute),this.oe.iconLatLng=[t.lat,t.lon],this.oe.distance=e.distanceOnRoute,this.ae=e.route,this.en(t)):jt.showError(S.getText("NoteEditor - No route was found"))}newSearchTravelNote(t){this.ae=null,this.tn([t.lat,t.lon]),this.en(t)}newTravelNote(t){this.ae=null,this.tn(t),this.xa()}editNote(t){this.qa=!1;const e=tt.getNoteAndRoute(t);this.ae=e.route,this.oe=e.note,this.xa()}removeNote(t){const e=tt.getNoteAndRoute(t);e.route?(e.route.notes.remove(t),Ut.dispatch("updateitinerary")):(V.travel.notes.remove(t),Ut.dispatch("updatetravelnotes")),Ut.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:m}),Ut.dispatch("roadbookupdate")}hideNotes(){let t=V.travel.notes.iterator;for(;!t.done;)Ut.dispatch("removeobject",{objId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)for(t=e.value.notes.iterator;!t.done;)Ut.dispatch("removeobject",{objId:t.value.objId});if(m!==V.editedRouteObjId)for(t=V.travel.editedRoute.notes.iterator;!t.done;)Ut.dispatch("removeobject",{objId:t.value.objId})}showNotes(){this.hideNotes();const t=V.travel.notes.iterator;for(;!t.done;)Ut.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:t.value.objId});const e=V.travel.routes.iterator;for(;!e.done;)e.value.hidden||Ut.dispatch("routeupdated",{removedRouteObjId:e.value.objId,addedRouteObjId:e.value.objId})}attachNoteToRoute(t){const e=tt.getNoteAndRoute(t).note,s=tt.getNearestRouteData(e.latLng);s.route&&(V.travel.notes.remove(t),e.distance=s.distance,e.latLng=s.latLngOnRoute,e.chainedDistance=s.route.chainedDistance,s.route.notes.add(e),s.route.notes.sort(((t,e)=>t.distance-e.distance)),Ut.dispatch("noteupdated",{removedNoteObjId:t,addedNoteObjId:t}),Ut.dispatch("updateitinerary"),Ut.dispatch("updatetravelnotes"),Ut.dispatch("roadbookupdate"))}detachNoteFromRoute(t){const e=tt.getNoteAndRoute(t);e.route.notes.remove(t),e.note.distance=i.invalid,e.note.chainedDistance=i.defaultValue,V.travel.notes.add(e.note),Ut.dispatch("updateitinerary"),Ut.dispatch("updatetravelnotes"),Ut.dispatch("roadbookupdate")}travelNoteDropped(t,e,s){V.travel.notes.moveTo(t,e,s),Ut.dispatch("updatetravelnotes"),Ut.dispatch("roadbookupdate")}};class We{sn;rn;ae;static get an(){return"\n"}static get nn(){return"\n\t"}static get hn(){return"\n\t\t"}static get ln(){return"\n\t\t\t"}static get cn(){return"\n\t\t\t\t"}un(){this.sn='<?xml version="1.0"?>'+We.an,this.sn+='<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" creator="TravelNotes">'}vn(t){return t.replaceAll("&","&amp;").replaceAll(/\u0027/g,"&apos;").replaceAll(/"/g,"&quot;").replaceAll(/</g,"&lt;").replaceAll(/>/g,"&gt;")}dn(){const t=this.ae.wayPoints.iterator;for(;!t.done;)this.sn+=We.nn+'<wpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+We.hn+this.rn+We.hn+"<name>"+this.vn(t.value.fullName)+"</name>"+We.nn+"</wpt>"}pn(){this.sn+=We.nn+"<rte>",this.sn+=We.hn+"<name>"+this.vn(this.ae.computedName)+"</name>";const t=this.ae.itinerary.maneuvers.iterator;for(;!t.done;){const e=this.ae.itinerary.itineraryPoints.getAt(t.value.itineraryPointObjId);this.sn+=We.hn+'<rtept lat="'+e.lat+'" lon="'+e.lng+'">'+We.ln+this.rn+We.ln+"<desc>"+this.vn(t.value.instruction)+"</desc>"+We.hn+"</rtept>"}this.sn+=We.nn+"</rte>"}_n(){this.sn+=We.nn+"<trk>",this.sn+=We.hn+"<name>"+this.vn(this.ae.computedName)+"</name>",this.sn+=We.hn+"<trkseg>";const t=this.ae.itinerary.itineraryPoints.iterator;for(;!t.done;)this.sn+=We.ln+'<trkpt lat="'+t.value.lat+'" lon="'+t.value.lng+'">'+We.cn+this.rn+We.cn+"<ele>"+t.value.elev+"</ele>"+We.ln+"</trkpt>";this.sn+=We.hn+"</trkseg>",this.sn+=We.nn+"</trk>"}mn(){this.sn+=We.an+"</gpx>"}gn(){let t=(""===V.travel.name?"":V.travel.name+" - ")+this.ae.computedName;""===t&&(t="TravelNote"),t+=".gpx",k.saveFile(t,this.sn,"application/xml")}constructor(){}routeToGpx(t){this.ae=tt.getRoute(t),this.ae&&(this.rn="<time>"+(new Date).toISOString()+"</time>",this.un(),this.dn(),this.pn(),this._n(),this.mn(),this.gn())}}class Ve{wn;Nn;Tn;constructor(t,s,i){this.wn="number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t?t:e.maxColorValue,this.Nn="number"==typeof s&&e.maxColorValue>=s&&e.minColorValue<=s?s:e.maxColorValue,this.Tn="number"==typeof i&&e.maxColorValue>=i&&e.minColorValue<=i?i:e.maxColorValue}get red(){return this.wn}set red(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.wn=t)}get green(){return this.Nn}set green(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.Nn=t)}get blue(){return this.Tn}set blue(t){"number"==typeof t&&e.maxColorValue>=t&&e.minColorValue<=t&&(this.Tn=t)}get cssColor(){return"#"+this.wn.toString(p).padStart(2,"0")+this.Nn.toString(p).padStart(2,"0")+this.Tn.toString(p).padStart(2,"0")}set cssColor(t){"#"===t[0]?(this.wn=Number.parseInt(t.substring(1,3),p),this.Nn=Number.parseInt(t.substring(3,5),p),this.Tn=Number.parseInt(t.substring(5,7),p)):"rgb"===t.substring(0,3)&&([this.wn,this.Nn,this.Tn]=Array.from(t.match(/[0-9]{1,3}/g),(t=>Number.parseInt(t))))}clone(){return new Ve(this.wn,this.Nn,this.Tn)}copyTo(t){t.red=this.wn,t.green=this.Nn,t.blue=this.Tn}}class ze{fn;constructor(t){this.fn=t}handleEvent(t){t.stopPropagation();const s=new Ve;s.red=Math.ceil(t.target.valueAsNumber*(e.maxColorValue/e.sliderMaxValue));for(let t=0;t<e.rowsNumber;++t){s.blue=t*e.deltaColor;for(let i=0;i<e.rowsNumber;++i)s.green=i*e.deltaColor,this.fn[e.rowsNumber*t+i].style["background-color"]=s.cssColor}}}class Ge{bn;yn;constructor(t,e){this.bn=t,this.yn=e}handleEvent(t){t.stopPropagation();const e=new Ve(Number.parseInt(this.yn.red.value),Number.parseInt(this.yn.green.value),Number.parseInt(this.yn.blue.value));this.bn.color=e}}class Xe{bn=null;constructor(t){this.bn=t}handleEvent(t){t.stopPropagation();const e=new Ve;e.cssColor=t.target.style["background-color"],this.bn.color=e}}class Ze{wn;Nn;Tn;constructor(t,e,s){this.wn=t,this.Nn=e,this.Tn=s}get red(){return this.wn}get green(){return this.Nn}get blue(){return this.Tn}}class Je{In;fn;yn;Mn;Dn;xn;En;Pn;Cn;Ln;Sn(){const t=et.create("div",null,this.In),s=new Ve(e.initialRed,e.minColorValue,e.minColorValue);this.Pn=new Xe(this);for(let i=0;i<e.rowsNumber;++i){const i=et.create("div",null,t);s.green=e.minColorValue;for(let t=0;t<e.cellsNumber;++t){const t=et.create("div",{className:"TravelNotes-ColorControl-CellColorDiv"},i);t.style["background-color"]=s.cssColor,t.addEventListener("click",this.Pn,!1),s.green+=e.deltaColor,this.fn.push(t)}s.blue+=e.deltaColor}}kn(){const t=et.create("div",null,this.In);this.Mn=et.create("input",{type:"range",value:Math.ceil(e.initialRed*(e.sliderMaxValue/e.maxColorValue)),min:0,max:e.sliderMaxValue,step:e.sliderStep},t),this.Ln=new ze(this.fn),this.Mn.addEventListener("input",this.Ln,!1),this.Mn.focus()}An(t,s){et.create("text",{value:t},this.Dn);return et.create("input",{type:"number",className:"TravelNotes-ColorControl-NumberInput",value:s,min:e.minColorValue,max:e.maxColorValue},this.Dn)}Rn(){this.Dn=et.create("div",null,this.In),this.yn=new Ze(this.An(S.getText("ColorControl - Red"),this.En.red),this.An(S.getText("ColorControl - Green"),this.En.green),this.An(S.getText("ColorControl - Blue"),this.En.blue)),this.Cn=new Ge(this,this.yn);for(const t in this.yn)this.yn[t].addEventListener("input",this.Cn,!1)}On(){this.xn=et.create("div",{id:"TravelNotes-ColorControl-ColorSampleDiv"},this.In),this.xn.style["background-color"]=this.En.cssColor}constructor(t){this.fn=[],this.En=new Ve,this.En.cssColor=t,this.In=et.create("div",{id:"TravelNotes-ColorControl-ColorDiv"}),this.Sn(),this.kn(),this.Rn(),this.On()}destructor(){this.fn.forEach((t=>{t.removeEventListener("click",this.Pn,!1)})),this.Pn=null;for(const t in this.yn)this.yn[t].removeEventListener("input",this.Cn,!1);this.Cn=null,this.Mn.removeEventListener("input",this.Ln,!1),this.Ln=null}get HTMLElements(){return[this.In]}get cssColor(){return this.En.cssColor}set color(t){this.yn.red.value=t.red,this.yn.green.value=t.green,this.yn.blue.value=t.blue,this.xn.style["background-color"]=t.cssColor,t.copyTo(this.En)}}class Ye extends Nt{ae;bn;Bn;jn;Hn;Un;static get Fn(){return 1}static get Kn(){return 40}Wn(){const t=et.create("div",{textContent:S.getText("RoutePropertiesDialog - Name")}),e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-NameInputDiv"});return this.Bn=et.create("input",{type:"text",id:"TravelNotes-RoutePropertiesDialog-NameInput",value:this.ae.computedName},e),[t,e]}Vn(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});return et.create("text",{value:S.getText("RoutePropertiesDialog - Width")},et.create("span",null,t)),this.jn=et.create("input",{type:"number",id:"TravelNotes-RoutePropertiesDialog-WidthInput",value:this.ae.width,min:Ye.Fn,max:Ye.Kn},t),t}zn(){const e=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv"});et.create("text",{value:S.getText("RoutePropertiesDialog - Linetype")},et.create("span",null,e)),this.Hn=et.create("select",null,e);const s=t.route.dashChoices;return s.forEach((t=>{this.Hn.add(et.create("option",{text:t.text}))})),this.Hn.selectedIndex=this.ae.dashIndex<s.length?this.ae.dashIndex:0,e}Gn(){const t=et.create("div",{className:"TravelNotes-RoutePropertiesDialog-DataDiv",id:"TravelNotes-RoutePropertiesDialog-ChainDiv"});return et.create("text",{value:S.getText("RoutePropertiesDialog - Chained route")},et.create("span",null,t)),this.Un=et.create("input",{type:"checkbox",checked:this.ae.chain},t),t}Xn(){return et.create("div",{textContent:S.getText("RoutePropertiesDialog - Color"),id:"TravelNotes-RoutePropertiesDialog-ColorHeaderDiv"})}constructor(t){super(),this.ae=t,this.bn=new Je(t.color)}onCancel(){this.bn.destructor(),super.onCancel()}onOk(){this.ae.color=this.bn.cssColor,this.ae.computedName!==this.Bn.value&&(this.ae.name=this.Bn.value),this.ae.width=parseInt(this.jn.value),this.ae.chain=this.Un.checked,this.ae.dashIndex=this.Hn.selectedIndex,this.bn.destructor(),super.onOk()}get title(){return S.getText("RoutePropertiesDialog - Route properties")}get contentHTMLElements(){return[].concat(this.Wn(),this.Vn(),this.zn(),this.Gn(),this.Xn(),this.bn.HTMLElements)}}class qe{constructor(){}paperWidth=0;paperHeight=0;borderWidth=0;zoomFactor=0;printNotes=!1;firefoxBrowser=!0}class $e extends Nt{Zn;Jn;Yn;qn;$n;Qn;static get th(){return 15}eh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Paper width")},e),this.Zn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput"},e),this.Zn.value=t.printRouteMap.paperWidth,et.create("text",{value:S.getText("PrintRouteMapDialog - Paper width units")},e),e}sh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Paper height")},e),this.Jn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.paperHeight},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Paper height units")},e),e}ih(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Border width")},e),this.Yn=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:t.printRouteMap.borderWidth},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Border width units")},e),e}rh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Zoom factor")},e),this.$n=et.create("input",{type:"number",className:"TravelNotes-PrintRouteMapDialog-NumberInput",value:Math.min(t.printRouteMap.zoomFactor,$e.th),min:V.map.getMinZoom(),max:Math.min(V.map.getMaxZoom(),$e.th)},e),e}oh(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return this.qn=et.create("input",{type:"checkbox",checked:t.printRouteMap.printNotes},e),et.create("text",{value:S.getText("PrintRouteMapDialog - Print notes")},e),e}ah(){const e=et.create("div",{className:"TravelNotes-PrintRouteMapDialog-DataDiv"});return et.create("text",{value:S.getText("PrintRouteMapDialog - Print with")},e),this.Qn=et.create("input",{type:"radio",checked:t.printRouteMap.firefoxBrowser,id:"TravelNotes-PrintRouteMapDialog-FirefoxBrowser",name:"Browser"},e),et.create("label",{htmlFor:"TravelNotes-PrintRouteMapDialog-FirefoxBrowser",innerText:"Firefox"},e),et.create("input",{type:"radio",checked:!t.printRouteMap.firefoxBrowser,id:"TravelNotes-PrintRouteMapDialog-OtherBrowser",name:"Browser"},e),et.create("label",{htmlFor:"TravelNotes-PrintRouteMapDialog-OtherBrowser",innerText:S.getText("PrintRouteMapDialog - Another browser")},e),e}constructor(){super()}onOk(){const t=new qe;t.paperWidth=parseInt(this.Zn.value),t.paperHeight=parseInt(this.Jn.value),t.borderWidth=parseInt(this.Yn.value),t.zoomFactor=parseInt(this.$n.value),t.printNotes=this.qn.checked,t.firefoxBrowser=this.Qn.checked,Object.freeze(t),super.onOk(t)}get contentHTMLElements(){return[this.eh(),this.sh(),this.ih(),this.rh(),this.oh(),this.ah()]}get title(){return S.getText("PrintRouteMapDialog - Print")}}class Qe{ye;constructor(t){this.ye=t}handleEvent(t){this.ye.dragStartX=t.screenX,this.ye.dragStartY=t.screenY,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move"}}class ts{ye;constructor(t){this.ye=t}handleEvent(t){const e=t.target.parentNode;this.ye.dialogX+=t.screenX-this.ye.dragStartX,this.ye.dialogY+=t.screenY-this.ye.dragStartY,this.ye.dialogX=Math.min(Math.max(this.ye.dialogX,v),V.map.getContainer().clientWidth-e.clientWidth-v),this.ye.dialogY=Math.max(this.ye.dialogY,v);const s=V.map.getContainer().clientHeight-Math.max(this.ye.dialogY,0)-v;e.style.top=String(this.ye.dialogY)+"px",e.style.left=String(this.ye.dialogX)+"px",e.style["max-height"]=String(s)+"px"}}class es{nh=[];hh(t){this.nh.push(t.latLng),this.nh.push(t.iconLatLng)}lh(t){t.itinerary.itineraryPoints.forEach((t=>this.nh.push(t.latLng))),t.notes.forEach((t=>this.hh(t)))}constructor(){}zoomToLatLng(t){Ut.dispatch("zoomto",{latLng:t})}zoomToManeuver(t){const e=V.travel.editedRoute.itinerary.maneuvers.getAt(t).itineraryPointObjId,s=V.travel.editedRoute.itinerary.itineraryPoints.getAt(e).latLng;Ut.dispatch("zoomto",{latLng:s})}zoomToNote(t){this.nh=[],this.hh(tt.getNoteAndRoute(t).note),Ut.dispatch("zoomto",{geometry:[this.nh]})}zoomToRoute(t){this.nh=[],this.lh(tt.getRoute(t)),Ut.dispatch("zoomto",{geometry:[this.nh]})}zoomToTravel(){this.nh=[],V.travel.routes.forEach((t=>this.lh(t))),m!==V.travel.editedRouteObjId&&this.lh(V.travel.editedRoute),V.travel.notes.forEach((t=>this.hh(t))),Ut.dispatch("zoomto",{geometry:[this.nh]})}zoomToPoi(t){Ut.dispatch("zoomto",t)}}class ss extends se{constructor(t,e){super(t,e)}get menuItems(){return[new te(S.getText("ProfileContextMenu - Add a note to the route at this point"),!0,(()=>Ke.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new te(S.getText("ProfileContextMenu - Zoom to this point"),!0,(()=>(new es).zoomToLatLng(this.eventData.latLng)))]}}class is{constructor(){}getlatLngElevOnRouteAtMousePosition(t){const e=tt.getRoute(Number.parseInt(t.currentTarget.dataset.tanObjId)),s=t.currentTarget.getBoundingClientRect(),i=(t.clientX-s.x-Kt.PROFILE_MARGIN/(2*Kt.PROFILE_MARGIN+Kt.PROFILE_WIDTH)*s.width)/(Kt.PROFILE_WIDTH/(2*Kt.PROFILE_MARGIN+Kt.PROFILE_WIDTH)*s.width)*e.distance;return 0<i&&i<e.distance?Y.getLatLngElevAtDist(e,i):null}}class rs extends is{constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation();const e=this.getlatLngElevOnRouteAtMousePosition(t);e&&(t.latlng={lat:e.latLng[0],lng:e.latLng[1]},new ss(t).show())}}class os{constructor(){}handleEvent(t){t.preventDefault(),t.stopPropagation(),Ut.dispatch("removeobject",{objId:Number.parseInt(t.currentTarget.dataset.tanMarkerObjId)})}}class as extends is{uh;dh;ph;_h;mh;gh;wh;Nh(t,e){const s=document.createElementNS(N,"text");return s.appendChild(document.createTextNode(t)),s.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-elevText"),s.setAttributeNS(null,"x",this.gh),s.setAttributeNS(null,"y",e),s.setAttributeNS(null,"text-anchor",this.mh),this.wh.appendChild(s),s}constructor(){super()}handleEvent(t){t.preventDefault(),t.stopPropagation(),this.wh=t.currentTarget;const e=this.getlatLngElevOnRouteAtMousePosition(t);if(e){const s=Number.parseInt(this.wh.dataset.tanMarkerObjId);Ut.dispatch("removeobject",{objId:s}),Ut.dispatch("additinerarypointmarker",{objId:s,latLng:e.latLng}),this.uh&&this.wh.contains(this.uh)?(this.wh.removeChild(this.uh),this.wh.removeChild(this.dh),this.wh.removeChild(this.ph),this.wh.removeChild(this._h)):(this.uh=null,this.dh=null,this.ph=null,this._h=null);const i=this.wh.getBoundingClientRect();this.gh=(2*Kt.PROFILE_MARGIN+Kt.PROFILE_WIDTH)*(t.clientX-i.x)/i.width;const r=Kt.PROFILE_MARGIN+Kt.PROFILE_HEIGHT;this.uh=document.createElementNS(N,"polyline"),this.uh.setAttributeNS(null,"points",String(this.gh)+","+Kt.PROFILE_MARGIN+" "+this.gh+","+r),this.uh.setAttributeNS(null,"class","TravelNotes-Route-SvgProfile-markerPolyline"),this.wh.appendChild(this.uh);const o=tt.getRoute(Number.parseInt(this.wh.dataset.tanObjId));this.mh=e.distance>o.distance/2?"end":"start",this.gh+=e.distance>o.distance/2?-Kt.X_DELTA_TEXT:Kt.X_DELTA_TEXT,this.dh=this.Nh(k.formatDistance(e.distance),Kt.PROFILE_MARGIN+Kt.Y_DELTA_TEXT),this.ph=this.Nh("Alt. "+e.elev.toFixed(0)+" m.",Kt.PROFILE_MARGIN+2*Kt.Y_DELTA_TEXT),this._h=this.Nh("Pente "+e.ascent.toFixed(0)+" % ",Kt.PROFILE_MARGIN+3*Kt.Y_DELTA_TEXT)}}}class ns extends class{ye;ke;je;Th;fh;Ge;Xe;ns(){this.ke=et.create("div",{className:"TravelNotes-FloatWindow-Container"},document.body)}hs(){this.je=et.create("div",{className:"TravelNotes-FloatWindow-TopBar",draggable:!0},this.ke),this.je.addEventListener("dragstart",this.Ge,!1),this.je.addEventListener("dragend",this.Xe,!1),et.create("div",{textContent:"❌",className:"TravelNotes-FloatWindow-CancelButton",title:S.getText("FloatWindow - Close")},this.je).addEventListener("click",(()=>this.close()),!1)}ls(){this.Th=et.create("div",null,this.ke)}cs(){this.fh=et.create("div",null,this.ke)}constructor(){this.ye=new mt,this.Ge=new Qe(this.ye),this.Xe=new ts(this.ye),this.ns(),this.hs(),this.ls(),this.cs()}close(){this.je.removeEventListener("dragstart",this.Ge,!1),this.je.removeEventListener("dragend",this.Xe,!1),this.Ge=null,this.Xe=null,document.body.removeChild(this.ke)}update(){}get header(){return this.Th}get content(){return this.fh}}{yi=null;bh=null;ae=null;yh=null;Ih=null;Mh=null;Dh=f.nextObjId;xh(){this.yi&&(this.yi.removeEventListener("contextmenu",this.yh,!1),this.yi.removeEventListener("mousemove",this.Ih,!1),this.yi.removeEventListener("mouseleave",this.Mh,!1),Ut.dispatch("removeobject",{objId:this.Dh}),this.content.removeChild(this.bh),this.content.removeChild(this.yi)),this.yi=null,this.bh=null}constructor(){super(),this.yh=new rs,this.Ih=new as,this.Mh=new os}close(){this.xh(),Ut.dispatch("profileclosed",{objId:this.ae.objId}),super.close()}update(t){this.xh(),this.ae=t,this.yi=(new Kt).createSvg(this.ae),this.yi.dataset.tanObjId=t.objId,this.yi.dataset.tanMarkerObjId=this.Dh,this.header.textContent=S.getText("ProfileWindow - Profile {name}",{name:this.ae.computedName}),this.content.appendChild(this.yi),this.yi.addEventListener("contextmenu",this.yh,!1),this.yi.addEventListener("mousemove",this.Ih,!1),this.yi.addEventListener("mouseleave",this.Mh,!1),this.bh=et.create("div",{className:"TravelNotes-ProfileWindow-Ascent",textContent:S.getText("ProfileWindow - Ascent: {ascent} m. - Descent: {descent} m. - Distance: {distance}",{ascent:this.ae.itinerary.ascent.toFixed(0),descent:this.ae.itinerary.descent.toFixed(0),distance:k.formatDistance(this.ae.distance)})}),this.content.appendChild(this.bh)}}class hs{ae;Eh;Ph;get Ch(){return t.route.elev.smoothPoints}Lh(){this.Ph=[],this.Ph.push({distance:0,elev:this.ae.itinerary.itineraryPoints.first.elev,smoothElev:this.ae.itinerary.itineraryPoints.first.elev});const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=0,s=t.value.distance,i=t.value.elev;t.done;let r=this.Eh;for(;r<this.ae.distance;){if(s<r)for(e=s,i=t.value.elev;s<r;)s+=t.value.distance,t.done;const o=i+(r-e)*((t.value.elev-i)/(s-e));this.Ph.push({distance:r,elev:o,smoothElev:0}),r+=this.Eh}this.Ph.push({distance:this.ae.distance,elev:this.ae.itinerary.itineraryPoints.last.elev,smoothElev:this.ae.itinerary.itineraryPoints.last.elev})}Sh(){let t=(this.Ph[this.Ch-1].elev-this.Ph[0].elev)/(this.Ch-1),e=0;for(e=0;e<this.Ch;e++)this.Ph[e].smoothElev=this.Ph[0].elev+t*e;for(e=this.Ch;e<this.Ph.length-this.Ch;e++){let t=0;for(let s=e-this.Ch;s<=e+this.Ch;s++)t+=this.Ph[s].elev;this.Ph[e].smoothElev=t/(2*this.Ch+1)}e--;const s=(this.Ph[e+this.Ch].smoothElev-this.Ph[e].smoothElev)/this.Ch;let i=this.Ph[e].smoothElev,r=1;for(e++;e<this.Ph.length-1;r++,e++)this.Ph[e].smoothElev=i+s*r}kh(){const e=this.ae.itinerary.itineraryPoints.iterator;let s=0;for(;!e.done;)s+=e.next?Math.abs(e.value.elev-e.next.elev):0;this.Eh=Math.floor(Math.min(t.route.elev.smoothCoefficient*this.ae.distance/s,this.ae.distance/(3*this.Ch)))}Ah(){const t=this.ae.itinerary.itineraryPoints.iterator;t.done;let e=t.value.distance;for(;!t.done;){const s=this.Ph[Math.floor(e/this.Eh)],i=this.Ph[Math.ceil(e/this.Eh)];if(s&&i){const r=e-s.distance,o=(i.elev-s.elev)/(i.distance-s.distance);t.value.elev=s.elev+r*o}e+=t.value.distance}}constructor(){}smooth(t){this.ae=t,this.kh(),this.Lh(),this.Sh(),this.Ah()}}const ls=new class{Rh=new Map;constructor(){}createProfile(e){const s=this.Rh.get(e.objId);if(e.itinerary.hasProfile){t.route.elev.smooth&&(new hs).smooth(e);let i=0,r=0,o=e.itinerary.itineraryPoints.first.elev;e.itinerary.itineraryPoints.forEach((t=>{let e=t.elev-o;0>e?r-=e:i+=e,o=t.elev})),e.itinerary.ascent=i,e.itinerary.descent=r,s&&s.update(e)}else s&&s.close()}updateProfile(t,e){const s=this.Rh.get(t);s&&(this.Rh.delete(t),e&&e.itinerary.hasProfile?(s.update(e),this.Rh.set(e.objId,s)):s.close())}deleteProfile(t){const e=this.Rh.get(t);e&&e.close()}deleteAllProfiles(){this.Rh.forEach((t=>t.close()))}showProfile(t){let e=this.Rh.get(t);e||(e=new ns);const s=tt.getRoute(t);e.update(s),this.Rh.set(t,e)}onProfileClosed(t){this.Rh.delete(t)}};class cs{Bt;Ar;constructor(t,e){this.Bt=t,this.Ar=e}get width(){return this.Bt}get height(){return this.Ar}}class us{constructor(){}bottomLeft;upperRight;entryPoint;exitPoint}class vs{Oh;ae;Bh;jh(t,e,s){return e.lng===s.lng?new z(e.lat>s.lat?t.bottomLeft.lat:t.upperRight.lat,e.lng):e.lat===s.lat?new z(e.lat,e.lng<s.lng?t.upperRight.lng:t.bottomLeft.lng):null}Hh(t,e){const s=1e-6;return e.lat-t.bottomLeft.lat<s||t.upperRight.lat-e.lat<s||e.lng-t.bottomLeft.lng<s||t.upperRight.lng-e.lng<s?z.clone(e):null}Uh(t,e,s){if(t.bottomLeft.lat===t.upperRight.lat&&t.bottomLeft.lng===t.upperRight.lng){const t=Math.min(Math.abs(this.Bh.height/(s.lat-e.lat)),Math.abs(this.Bh.width/(s.lng-e.lng)));return new z(e.lat+t*(s.lat-e.lat),e.lng+t*(s.lng-e.lng))}return null}Fh(t,e,s){let i=this.Uh(t,e,s);if(i)return i;if(i=this.Hh(t,e),i)return i;if(i=this.jh(t,e,s),i)return i;const r=(e.lat-s.lat)/(e.lng-s.lng),o=e.lat-r*e.lng;if(i=new z(r*t.upperRight.lng+o,t.upperRight.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng<s.lng)return i;if(i=new z(t.upperRight.lat,(t.upperRight.lat-o)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat<s.lat)return i;if(i=new z(r*t.bottomLeft.lng+o,t.bottomLeft.lng),i.lat<=t.upperRight.lat&&i.lat>=t.bottomLeft.lat&&i.lng>s.lng)return i;if(i=new z(t.bottomLeft.lat,(t.bottomLeft.lat-o)/r),i.lng>=t.bottomLeft.lng&&i.lng<=t.upperRight.lng&&i.lat>s.lat)return i;throw new Error("intermediate point not found")}Kh(){this.Oh=[];const t=this.ae.itinerary.itineraryPoints.iterator;let e=t.done,s=new us;s.bottomLeft=z.clone(t.value),s.upperRight=z.clone(t.value),s.entryPoint=z.clone(t.value);let i=t.value,r=z.clone(t.value);e=t.done;let o=t.value;for(;!e;){const a=new us;a.bottomLeft=new z(Math.min(s.bottomLeft.lat,o.lat),Math.min(s.bottomLeft.lng,o.lng)),a.upperRight=new z(Math.max(s.upperRight.lat,o.lat),Math.max(s.upperRight.lng,o.lng)),a.entryPoint=z.clone(s.entryPoint),this.Bh.height>a.upperRight.lat-a.bottomLeft.lat&&this.Bh.width>a.upperRight.lng-a.bottomLeft.lng?(s=a,i=t.value,r=z.clone(t.value),e=t.done,o=t.value,e&&(s.exitPoint=r,this.Oh.push(Object.freeze(s)))):(r=this.Fh(s,i,o),s.bottomLeft=new z(Math.min(s.bottomLeft.lat,r.lat),Math.min(s.bottomLeft.lng,r.lng)),s.upperRight=new z(Math.max(s.upperRight.lat,r.lat),Math.max(s.upperRight.lng,r.lng)),s.exitPoint=r,this.Oh.push(Object.freeze(s)),s=new us,s.bottomLeft=z.clone(r),s.upperRight=z.clone(r),s.entryPoint=z.clone(r))}}constructor(t,e){this.ae=t,this.Bh=e,this.Kh()}get printViews(){return this.Oh}}class ds{Le;jt;Wh;constructor(t){if("string"!=typeof t?.text||"string"!=typeof t?.color||"string"!=typeof t?.backgroundColor)throw new Error("invalid toolbar for layer");this.Le=L.sanitizeToJsString(t.text),this.jt=L.sanitizeToColor(t.color),this.Wh=L.sanitizeToColor(t.backgroundColor)}get text(){return this.Le}get color(){return this.jt}get backgroundColor(){return this.Wh}}class ps{ot=null;Vh=null;N=null;zh=null;Gh=null;Xh=null;Zh=null;Jh=null;ee=null;Yh=!1;qh=null;$h=null;Qh(){if("string"!=typeof this.$h?.name)throw new Error("invalid name for layer");this.ot=L.sanitizeToJsString(this.$h.name)}tl(){if("wms"!==this.$h?.service&&"wmts"!==this.$h?.service)throw new Error("invalid service for layer "+this.ot);this.Vh=this.$h.service}el(){if("string"!=typeof this.$h?.url)throw new Error("invalid url for layer "+this.ot);this.N=this.$h.url}sl(){if("wms"===this.Vh){if("string"!=typeof this.$h?.wmsOptions?.layers||"string"!=typeof this.$h?.wmsOptions?.format||"boolean"!=typeof this.$h?.wmsOptions?.transparent)throw new Error("invalid wmsOptions for layer "+this.ot);this.zh=this.$h.wmsOptions,this.zh.layers=L.sanitizeToJsString(this.zh.layers),this.zh.format=L.sanitizeToJsString(this.zh.format)}}il(){try{this.$h.bounds&&"number"==typeof this.$h.bounds[0][0]&&"number"==typeof this.$h.bounds[0][1]&&"number"==typeof this.$h.bounds[1][0]&&"number"==typeof this.$h.bounds[1][1]&&(this.Gh=this.$h.bounds)}catch(t){throw new Error("invalid bounds for layer "+this.ot)}}rl(){if(this.$h.minZoom){if("number"!=typeof this.$h.minZoom)throw new Error("invalid minZoom for layer "+this.ot);this.Xh=this.$h.minZoom}if(this.$h.maxZoom){if("number"!=typeof this.$h.maxZoom)throw new Error("invalid maxZoom for layer "+this.ot);this.Zh=this.$h.maxZoom}}ol(){this.Jh=new ds(this.$h.toolbar)}al(){if("string"!=typeof this.$h?.providerName)throw new Error("invalid providerName for layer "+this.ot);this.ee=L.sanitizeToJsString(this.$h.providerName)}nl(){if("boolean"!=typeof this.$h.providerKeyNeeded)throw new Error("invalid providerKeyNeeded for layer "+this.ot);this.Yh=this.$h.providerKeyNeeded}hl(){if(""===this.$h.attribution)this.qh="";else{if("string"!=typeof this.$h?.attribution)throw new Error("invalid attribution for map layer "+this.ot);this.qh=L.sanitizeToHtmlString(this.$h.attribution).htmlString}}constructor(t){this.$h=t,this.Qh(),this.tl(),this.el(),this.sl(),this.il(),this.rl(),this.ol(),this.al(),this.nl(),this.hl(),this.$h=null}get name(){return this.ot}get service(){return this.Vh}get url(){return this.N}get wmsOptions(){return this.zh}get bounds(){return this.Gh}get minZoom(){return this.Xh}get maxZoom(){return this.Zh}get toolbarButtonData(){return this.Jh}get providerName(){return this.ee}get providerKeyNeeded(){return this.Yh}get attribution(){return this.qh}}const _s=new class{ll;cl;ul;constructor(){this.ll=new Map,this.ul=!1,this.cl=new ps({service:"wmts",url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",name:"OSM - Color",toolbar:{text:"OSM",color:"#ff0000",backgroundColor:"#ffffff"},providerName:"OSM",providerKeyNeeded:!1,attribution:""}),this.ll.set(this.cl.name,this.cl)}getMapLayer(t){let e=this.ll.get(t)||this.cl;return e.providerKeyNeeded&&(Ft.hasKey(e.providerName.toLowerCase())||(e=this.cl)),e}forEach(t){this.ll.forEach(t)}addMapLayers(t){this.ul||(t.forEach((t=>{const e=new ps(t);this.ll.get(e.name)||this.ll.set(e.name,e)})),this.ul=!0)}get defaultMapLayer(){return this.cl}};class ms{constructor(){}handleEvent(){window.print()}}class gs{vl=null;constructor(t){this.vl=t}handleEvent(){this.vl.onAfterPrint(),this.vl=null}}class ws{dl;ae;Oh;pl;_l;Be;ml;gl;wl;Nl;Tl;onAfterPrint(){this.gl.forEach((t=>document.body.removeChild(t))),this.gl.length=0,this._l.removeEventListener("click",this.Nl,!1),this.Be.removeEventListener("click",this.Tl,!1),document.body.removeChild(this.pl);const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.remove("TravelNotes-Hidden");V.map.invalidateSize(!1),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),window.removeEventListener("afterprint",this.Tl,!0),this.Tl=null,this.Nl=null}fl(){const t=_s.getMapLayer(V.travel.layerName),e=Ft.getUrl(t),s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);return s.options.attribution=L.sanitizeToHtmlString(' © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t.attribution+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a> ').htmlString,s}bl(){const t=[];return this.ae.notes.forEach((e=>{const s=window.L.divIcon({iconSize:[e.iconWidth,e.iconHeight],iconAnchor:[e.iconWidth/2,e.iconHeight/2],popupAnchor:[0,-e.iconHeight/2],html:e.iconContent,className:"TravelNotes-Map-AllNotes "}),i=window.L.marker(e.iconLatLng,{zIndexOffset:100,icon:s,draggable:!0});t.push(i)})),t}yl(e){this.ml++;const s="TravelNotes-RouteViewDiv"+this.ml,i=document.createElement("div");i.className="TravelNotes-routeViewDiv",i.id=s,document.body.appendChild(i),this.gl.push(i),i.style.width=String(this.dl.paperWidth)+"mm",i.style.height=String(this.dl.paperHeight)+"mm";const r=this.dl.printNotes?this.bl():[];r.push(this.fl()),r.push(window.L.circleMarker([e.entryPoint.lat,e.entryPoint.lng],t.printRouteMap.entryPointMarker)),r.push(window.L.circleMarker([e.exitPoint.lat,e.exitPoint.lng],t.printRouteMap.exitPointMarker)),r.push(this.wl),window.L.map(s,{attributionControl:!0,zoomControl:!1,center:[(e.bottomLeft.lat+e.upperRight.lat)/2,(e.bottomLeft.lng+e.upperRight.lng)/2],zoom:this.dl.zoomFactor,minZoom:this.dl.zoomFactor,maxZoom:this.dl.zoomFactor,layers:r})}Il(){this.pl=et.create("div",{id:"TravelNotes-PrintToolbar"},document.body),this._l=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("PrintPageBuilder - Print"),textContent:"🖨️"},this.pl),this._l.addEventListener("click",this.Nl,!1),this.Be=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("PrintPageBuilder - Cancel print"),textContent:"❌"},this.pl),this.Be.addEventListener("click",this.Tl,!1)}constructor(t,e,s){this.ae=t,this.Oh=e,this.dl=s,this.ml=0,this.gl=[],this.Nl=new ms,this.Tl=new gs(this)}preparePage(){this.dl.firefoxBrowser?document.body.classList.add("TravelNotes-Maps-FirefoxBrowser"):document.body.classList.remove("TravelNotes-Maps-FirefoxBrowser");const t=document.body.children;for(let e=0;e<t.length;e++)t.item(e).classList.add("TravelNotes-Hidden");document.title=""===V.travel.name?"maps":V.travel.name+" - "+this.ae.computedName+" - maps",this.Il(),window.addEventListener("afterprint",this.Tl,!0);const e=[],s=this.ae.itinerary.itineraryPoints.iterator;for(;!s.done;)e.push(s.value.latLng);this.wl=window.L.polyline(e,{color:this.ae.color,weight:this.ae.width,dashArray:this.ae.dashString}),this.ml=0,this.Oh.forEach((t=>this.yl(t)))}}class Ns{Ml=0;static get Dl(){return 256}xl(t){const e=et.create("div",{},document.body);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width=String(t.paperWidth-2*t.borderWidth)+"mm",e.style.height=String(t.paperHeight-2*t.borderWidth)+"mm";const s=Y.screenCoordToLatLng(0,0),i=Y.screenCoordToLatLng(e.clientWidth,e.clientHeight);this.Ml=Math.ceil(e.clientWidth/Ns.Dl)*Math.ceil(e.clientHeight/Ns.Dl),document.body.removeChild(e);const r=V.map.getZoomScale(V.map.getZoom(),t.zoomFactor);return new cs(Math.abs(s[1]-i[1])*r,Math.abs(s[0]-i[0])*r)}constructor(){}print(e,s){const i=tt.getRoute(s);if(!i)return;const r=new vs(i,this.xl(e));if(t.printRouteMap.maxTiles<r.printViews.length*this.Ml)return void jt.showError(S.getText("RoutePrinter - The maximum of allowed pages is reached."));new ws(i,r.printViews,e).preparePage()}}const Ts=new class{constructor(){}addRoute(){const t=new F;V.travel.routes.add(t),this.chainRoutes(),c.editedChanged===V.travel.editedRoute.editionStatus?(Ut.dispatch("setrouteslist"),Ut.dispatch("roadbookupdate")):this.editRoute(t.objId)}editRoute(t){const e=tt.getRoute(t),s=e.itinerary.provider,i=V.providers.get(s.toLowerCase());if(s&&""!==s&&(!i||i.providerKeyNeeded&&!Ft.hasKey(s)))return void jt.showError(S.getText("RouteEditor - Not possible to edit a route created with this provider",{provider:s}));m!==V.editedRouteObjId&&this.cancelEdition(),s&&""!==s&&Ut.dispatch("setprovider",{provider:s});const r=e.itinerary.transitMode;r&&""!==r&&Ut.dispatch("settransitmode",{transitMode:r}),V.travel.editedRoute=new F,e.editionStatus=c.editedNoChange,V.travel.editedRoute.jsonObject=e.jsonObject,V.editedRouteObjId=e.objId,V.travel.editedRoute.hidden=!1,e.hidden=!1,ls.updateProfile(V.editedRouteObjId,V.travel.editedRoute),this.chainRoutes(),Ut.dispatch("routeupdated",{removedRouteObjId:e.objId,addedRouteObjId:V.travel.editedRoute.objId}),Ut.dispatch("roadbookupdate"),Ut.dispatch("showitinerary"),Ut.dispatch("setrouteslist")}removeRoute(t){let e=t;e!==V.editedRouteObjId&&e!==V.travel.editedRoute.objId||(e=V.editedRouteObjId,this.cancelEdition()),Ut.dispatch("routeupdated",{removedRouteObjId:e,addedRouteObjId:m}),V.travel.routes.remove(e),ls.deleteProfile(e),this.chainRoutes(),Ut.dispatch("roadbookupdate"),Ut.dispatch("setrouteslist")}saveGpx(t){(new We).routeToGpx(t)}chainRoutes(){const t=V.travel.routes.iterator;let e=i.defaultValue;for(;!t.done;){t.value.chain?(t.value.chainedDistance=e,e+=t.value.distance):t.value.chainedDistance=i.defaultValue;const s=t.value.notes.iterator;for(;!s.done;)s.value.chainedDistance=t.value.chainedDistance;if(t.value.objId===V.editedRouteObjId){V.travel.editedRoute.chainedDistance=V.travel.editedRoute.chain?t.value.chainedDistance:i.defaultValue;const e=V.travel.editedRoute.notes.iterator;for(;!e.done;)e.value.chainedDistance=V.travel.editedRoute.chainedDistance}}}saveEdition(){const t=new F;t.jsonObject=V.travel.editedRoute.jsonObject,V.travel.routes.replace(V.editedRouteObjId,t),V.editedRouteObjId=t.objId,this.cancelEdition()}cancelEdition(){const t=tt.getRoute(V.editedRouteObjId);t.editionStatus=c.notEdited,ls.updateProfile(V.travel.editedRoute.objId,t),Ut.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.editedRouteObjId}),V.editedRouteObjId=m,V.travel.editedRoute=new F,this.chainRoutes(),Ut.dispatch("roadbookupdate"),Ut.dispatch("setrouteslist"),Ut.dispatch("showitinerary")}routeProperties(t){const e=tt.getRoute(t);new Ye(e).show().then((()=>{this.chainRoutes(),e.haveValidWayPoints()&&Ut.dispatch("routepropertiesupdated",{routeObjId:e.objId}),Ut.dispatch("roadbookupdate"),Ut.dispatch("setrouteslist"),Ut.dispatch("updateitinerary")})).catch((t=>{t instanceof Error&&console.error(t)}))}printRouteMap(t){(new $e).show().then((e=>(new Ns).print(e,t))).catch((t=>{t instanceof Error&&console.error(t)}))}showRoute(t){tt.getRoute(t).hidden=!1,Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t}),Ut.dispatch("setrouteslist")}hideRoute(t){tt.getRoute(t).hidden=!0,Ut.dispatch("routeupdated",{removedRouteObjId:t,addedRouteObjId:m}),Ut.dispatch("setrouteslist")}showRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden&&(t.value.hidden=!1,Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId}));Ut.dispatch("setrouteslist")}hideRoutes(){const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden||t.value.objId===V.editedRouteObjId||(t.value.hidden=!0,Ut.dispatch("routeupdated",{removedRouteObjId:t.value.objId,addedRouteObjId:m}));Ut.dispatch("setrouteslist")}};class fs extends Nt{El;oo;Pl;Bn;async handleEvent(e){if(e.stopPropagation(),!t.wayPoint.reverseGeocoding)return;this.showWait();const s=await(new Ne).getAddressAsync(this.El.latLng);this.hideWait(),t.wayPoint.geocodingIncludeName&&(this.Bn.value=s.name);let i=s.street;""!==s.city&&(i+=" "+s.city),this.oo.value=i}Cl(){const t=et.create("div");this.Pl=et.create("div",{className:"TravelNotes-BaseDialog-Button",title:S.getText("WayPointPropertiesDialog - Reset address"),textContent:"🔄"},t),this.Pl.addEventListener("click",this,!1),et.create("text",{value:S.getText("WayPointPropertiesDialog - Address")},t);const e=et.create("div");return this.oo=et.create("input",{type:"text",value:this.El.address,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}Ll(){const t=et.create("div",{textContent:S.getText("WayPointPropertiesDialog - Name")}),e=et.create("div");return this.Bn=et.create("input",{type:"text",value:this.El.name,className:"TravelNotes-WayPointPropertiesDialog-Input"},e),[t,e]}constructor(t){super(),this.El=t}onCancel(){this.Pl.removeEventListener("click",this,!1),super.onCancel()}onOk(){this.El.address=this.oo.value,this.El.name=this.Bn.value,this.Pl.removeEventListener("click",this,!1),super.onOk()}get contentHTMLElements(){return[].concat(this.Ll(),this.Cl())}get title(){return S.getText("WayPointPropertiesDialog - Waypoint properties")}}const bs=new class{Sl;kl;Al(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;for(e.done,s.done,s.value.distance=i.defaultValue,s.done,t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(s.done,s.value.distance=i.defaultValue),s.done)}Rl(t){this.Sl=!1,t instanceof Error?(console.error(t),jt.showError(t.message)):jt.showError("A network error occurs when calling the provider")}Ol(){if(this.Sl=!1,this.Al(V.travel.editedRoute),"circle"!==V.travel.editedRoute.itinerary.transitMode){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)t.first?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.first.latLng:t.last?t.value.latLng=V.travel.editedRoute.itinerary.itineraryPoints.last.latLng:t.value.latLng=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng).latLng}const t=V.travel.editedRoute.notes.iterator;for(;!t.done;){const e=Y.getClosestLatLngDistance(V.travel.editedRoute,t.value.latLng);t.value.latLng=e.latLng,t.value.distance=e.distance}Ts.chainRoutes(),V.travel.editedRoute.notes.sort(((t,e)=>t.distance-e.distance)),this.kl&&(new es).zoomToRoute(V.travel.editedRoute.objId),ls.createProfile(V.travel.editedRoute),Ut.dispatch("routeupdated",{removedRouteObjId:V.travel.editedRoute.objId,addedRouteObjId:V.travel.editedRoute.objId}),Ut.dispatch("roadbookupdate"),Ut.dispatch("showitinerary"),Ut.dispatch("setrouteslist")}constructor(){}startRouting(){if(!this.Sl&&V.travel.editedRoute.haveValidWayPoints()){this.kl=0===V.travel.editedRoute.itinerary.itineraryPoints.length,this.Sl=!0;const t=V.providers.get(V.routing.provider.toLowerCase());V.travel.editedRoute.itinerary.provider=t.name,V.travel.editedRoute.itinerary.transitMode=V.routing.transitMode,t.getPromiseRoute(V.travel.editedRoute).then((()=>this.Ol())).catch((()=>this.Rl()))}}};const ys=new class{async Bl(e){if(!t.wayPoint.reverseGeocoding)return Ut.dispatch("setrouteslist"),Ut.dispatch("showitinerary"),void Ut.dispatch("roadbookupdate");const s=await(new Ne).getAddressAsync(e.latLng);V.editedRouteObjId===V.travel.editedRoute.objId&&(V.travel.editedRoute.editionStatus=c.editedChanged),e.address=s.street,""!==s.city&&(e.address+=" "+s.city),e.name="",t.wayPoint.geocodingIncludeName&&(e.name=s.name),Ut.dispatch("setrouteslist"),Ut.dispatch("updateitinerary"),Ut.dispatch("roadbookupdate")}jl(t){const e=V.travel.editedRoute.wayPoints.first;e.latLng=t,this.Bl(e),Ut.dispatch("addwaypoint",{wayPoint:e,letter:"A"})}Hl(t){const e=V.travel.editedRoute.wayPoints.last;e.latLng=t,this.Bl(e),Ut.dispatch("addwaypoint",{wayPoint:e,letter:"B"})}constructor(){}addWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=new O;e.latLng=t,V.travel.editedRoute.wayPoints.add(e),this.Bl(e),Ut.dispatch("addwaypoint",{wayPoint:V.travel.editedRoute.wayPoints.last,letter:V.travel.editedRoute.wayPoints.length-2}),V.travel.editedRoute.wayPoints.swap(e.objId,!0),bs.startRouting()}addWayPointOnRoute(t,e){const s=Y.getClosestLatLngDistance(V.travel.editedRoute,t).distance;V.travel.editedRoute.editionStatus=c.editedChanged;const i=new O;i.latLng=e;let r="";const o=V.travel.editedRoute.wayPoints.iterator;for(;!o.done;){if(s<Y.getClosestLatLngDistance(V.travel.editedRoute,o.value.latLng).distance){r=String(o.index),V.travel.editedRoute.wayPoints.add(i),V.travel.editedRoute.wayPoints.moveTo(i.objId,o.value.objId,!0),this.Bl(i),Ut.dispatch("addwaypoint",{wayPoint:i,letter:r}),bs.startRouting();break}}}reverseWayPoints(){V.travel.editedRoute.editionStatus=c.editedChanged;let t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)Ut.dispatch("removeobject",{objId:t.value.objId});for(V.travel.editedRoute.wayPoints.reverse(),t=V.travel.editedRoute.wayPoints.iterator;!t.done;)Ut.dispatch("addwaypoint",{wayPoint:t.value,letter:t.first?"A":t.last?"B":String(t.index)});Ut.dispatch("setrouteslist"),Ut.dispatch("showitinerary"),Ut.dispatch("roadbookupdate"),bs.startRouting()}removeWayPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,Ut.dispatch("removeobject",{objId:t}),V.travel.editedRoute.wayPoints.remove(t),bs.startRouting()}setStartPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.jl(t),bs.startRouting()}setEndPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.Hl(t),bs.startRouting()}setStartAndEndPoint(t){V.travel.editedRoute.editionStatus=c.editedChanged,this.jl(t),this.Hl(t),2<V.travel.editedRoute.wayPoints.length&&bs.startRouting()}wayPointDragEnd(t){V.travel.editedRoute.editionStatus=c.editedChanged;const e=V.travel.editedRoute.wayPoints.getAt(t.target.objId),s=t.target.getLatLng();e.latLng=[s.lat,s.lng],this.Bl(e),bs.startRouting()}wayPointProperties(t){const e=V.travel.editedRoute.wayPoints.getAt(t);new fs(e).show().then((()=>{Ut.dispatch("setrouteslist"),Ut.dispatch("showitinerary"),Ut.dispatch("roadbookupdate")})).catch((t=>{t instanceof Error&&console.error(t)}))}};class Is extends Nt{constructor(t){super(t)}get contentHTMLElements(){return[et.create("div",{textContent:this.options.text||""})]}get title(){return this.options.title||""}}class Ms{ae=null;Ul=0;Fl(t){const e=new U;for(const s in t)e[s]=t[s];e.iconLatLng=e.latLng,e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,e.chainedDistance=this.ae.chainedDistance,this.ae.notes.add(e),Ut.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.objId})}async Kl(){const t=new Fe;t.createUI();const e=new xe,s=this.ae.itinerary.maneuvers.iterator;for(;!s.done;){t.showInfo(S.getText("AllManeuverNotesBuilder - Creating note",{noteNumber:s.index+1,notesLength:this.Ul}));const i=this.ae.itinerary.itineraryPoints.getAt(s.value.itineraryPointObjId).latLng,r=await e.getIconAndAdressAsync(i,this.ae);r?this.Fl(r):console.error("An error occurs when creating the svg icon "+s.index)}this.ae.notes.sort(((t,e)=>t.distance-e.distance)),Ut.dispatch("updateitinerary"),Ut.dispatch("roadbookupdate"),t.close()}constructor(){}addAllManeuverNotes(e){this.ae=tt.getRoute(e),this.Ul=this.ae.itinerary.maneuvers.length,t.note.maxManeuversNotes<this.Ul?jt.showError(S.getText("AllManeuverNotesBuilder - max maneuvers notes reached {maneuversLength}{maxManeuversNotes}",{maneuversLength:this.Ul,maxManeuversNotes:t.note.maxManeuversNotes})):new Is({title:S.getText("AllManeuverNotesBuilder - Add a note for each maneuver"),text:S.getText("AllManeuverNotesBuilder - Add a note for each maneuver. Are you sure?",{noteLength:this.Ul}),secondButtonText:"❌"}).show().then((()=>this.Kl())).catch((t=>{t instanceof Error&&console.error(t)}))}}class Ds extends se{ae=null;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getRoute(this.eventData.targetObjId))}get menuItems(){return[new te(S.getText("RouteContextMenu - Edit this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId&&c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>Ts.editRoute(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Delete this route"),this.eventData.targetObjId!==V.travel.editedRoute.objId||c.editedChanged!==V.travel.editedRoute.editionStatus,(()=>Ts.removeRoute(this.eventData.targetObjId))),new te(S.getText(this.ae.hidden?"RouteContextMenu - Show this route":"RouteContextMenu - Hide this route"),this.ae.hidden||V.travel.editedRoute.objId!==this.eventData.targetObjId,(()=>{this.ae.hidden?Ts.showRoute(this.eventData.targetObjId):Ts.hideRoute(this.eventData.targetObjId)})),new te(S.getText("RouteContextMenu - Properties"),!this.ae.hidden,(()=>Ts.routeProperties(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Zoom to route"),!this.ae.hidden,(()=>(new es).zoomToRoute(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - View the elevation"),this.ae.itinerary.hasProfile,(()=>ls.showProfile(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Print route map"),t.printRouteMap.isEnabled,(()=>Ts.printRouteMap(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Save this route in a GPX file"),0<this.ae.itinerary.itineraryPoints.length,(()=>Ts.saveGpx(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Invert waypoints"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>ys.reverseWayPoints())),new te(S.getText("RouteContextMenu - Add a note on the route"),!this.eventData.haveParentNode,(()=>Ke.newRouteNote(this.eventData.targetObjId,this.eventData.latLng))),new te(S.getText("RouteContextMenu - Create a note for each route maneuver"),!this.ae.hidden,(()=>(new Ms).addAllManeuverNotes(this.eventData.targetObjId))),new te(S.getText("RouteContextMenu - Save modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>Ts.saveEdition())),new te(S.getText("RouteContextMenu - Cancel modifications on this route"),V.travel.editedRoute.objId===this.eventData.targetObjId,(()=>Ts.cancelEdition()))]}}class xs{static handleEvent(t){const e=tt.getRoute(t.target.objId);let s=Y.getClosestLatLngDistance(e,[t.latlng.lat,t.latlng.lng]).distance;s+=e.chainedDistance,s=k.formatDistance(s);const i=V.mapObjects.get(t.target.objId);i.closeTooltip();let r=e.computedName;V.travel.readOnly||(r+=0===r.length?"":" - ",r+=s),i.setTooltipContent(r),i.openTooltip(t.latlng)}}class Es{static handleEvent(t){window.L.DomEvent.stopPropagation(t),new Ds(t).show()}}class Ps{uh;Wl;Vl;constructor(t,e,s){this.uh=t,this.Wl=e,this.Vl=s}get marker(){return this.uh}get polyline(){return this.Wl}get bullet(){return this.Vl}}class Cs{zl;Gl;static get Xl(){return 18}static get Zl(){return 0}static get Jl(){return 100}constructor(){this.zl=null,this.Gl=null}addToMap(t,e){e.objId=t,e.addTo(V.map),V.mapObjects.set(t,e)}addRoute(t){const e=tt.getRoute(t),s=[],i=e.itinerary.itineraryPoints.iterator;for(;!i.done;)s.push(i.value.latLng);const r=window.L.polyline(s,{color:e.color,weight:e.width,dashArray:e.dashString});this.addToMap(e.objId,r),c.notEdited===e.editionStatus&&(r.bindTooltip(e.computedName,{sticky:!0,direction:"right"}),window.L.DomEvent.on(r,"mouseover",xs.handleEvent),window.L.DomEvent.on(r,"mousemove",xs.handleEvent)),r.bindPopup((t=>L.clone(zt.getRouteHeaderHTML("TravelNotes-Map-",tt.getRoute(t.objId))))),window.L.DomEvent.on(r,"click",(t=>t.target.openPopup(t.latlng)));const o=e.notes.iterator;for(;!o.done;)this.addNote(o.value.objId);return e}addNote(e){const s=tt.getNoteAndRoute(e).note,i=window.L.marker(s.latLng,{icon:window.L.divIcon({iconSize:[t.note.grip.size,t.note.grip.size],iconAnchor:[t.note.grip.size/2,t.note.grip.size/2],html:"<div></div>",className:"TravelNotes-Map-Note-Bullet"}),opacity:t.note.grip.opacity,draggable:!V.travel.readOnly});i.objId=s.objId;const r=window.L.marker(s.iconLatLng,{zIndexOffset:Cs.Jl,icon:window.L.divIcon({iconSize:[s.iconWidth,s.iconHeight],iconAnchor:[s.iconWidth/2,s.iconHeight/2],popupAnchor:[0,-s.iconHeight/2],html:s.iconContent,className:"TravelNotes-Map-AllNotes "}),draggable:!V.travel.readOnly});r.objId=s.objId,r.bindPopup((t=>L.clone(Vt.getNoteTextHTML("TravelNotes-Map-",tt.getNoteAndRoute(t.objId))))),0!==s.tooltipContent.length&&(r.bindTooltip((t=>tt.getNoteAndRoute(t.objId).note.tooltipContent)),r.getTooltip().options.offset[0]=s.iconWidth/2);const o=window.L.polyline([s.latLng,s.iconLatLng],t.note.polyline);o.objId=s.objId;const a=window.L.layerGroup([r,o,i]);return a.markerId=window.L.Util.stamp(r),a.polylineId=window.L.Util.stamp(o),a.bulletId=window.L.Util.stamp(i),this.addToMap(s.objId,a),t.note.haveBackground&&document.querySelectorAll(".TravelNotes-MapNote,.TravelNotes-SvgIcon").forEach((t=>t.classList.add("TravelNotes-Map-Note-Background"))),new Ps(r,o,i)}zoomTo(e,s){if(s){let t=[];s.forEach((e=>t=t.concat(e))),V.map.fitBounds(Y.getLatLngBounds(t))}else V.map.setView(e,t.itineraryPoint.zoomFactor)}setLayer(t,e){const s="wmts"===t.service.toLowerCase()?window.L.tileLayer(e):window.L.tileLayer.wms(e,t.wmsOptions);this.zl&&V.map.removeLayer(this.zl),V.map.addLayer(s),this.zl=s,V.travel.readOnly||(V.map.getZoom()<(t.minZoom||Cs.Zl)&&V.map.setZoom(t.minZoom||Cs.Zl),V.map.setMinZoom(t.minZoom||Cs.Zl),V.map.getZoom()>(t.maxZoom||Cs.Xl)&&V.map.setZoom(t.maxZoom||Cs.Xl),V.map.setMaxZoom(t.maxZoom||Cs.Xl),t.bounds?(V.map.getBounds().intersects(t.bounds)&&!V.map.getBounds().contains(t.bounds)||(V.map.setMaxBounds(null),V.map.fitBounds(t.bounds),V.map.setZoom(t.minZoom||Cs.Zl)),V.map.setMaxBounds(t.bounds)):V.map.setMaxBounds(null)),V.map.fire("baselayerchange",s)}onGeolocationStatusChanged(t){o.active!==t&&this.Gl&&(V.map.removeLayer(this.Gl),this.Gl=null)}onGeolocationPositionChanged(e){let s=t.geoLocation.zoomToPosition;this.Gl&&(V.map.removeLayer(this.Gl),s=!1);let i="Position (+/- "+e.coords.accuracy.toFixed(0)+" m) : <br/>"+k.formatLatLngDMS([e.coords.latitude,e.coords.longitude])+"<br/>"+k.formatLatLng([e.coords.latitude,e.coords.longitude])+"<br/>";e.coords.altitude&&(i+="<br/> Altitude  :<br/>"+e.coords.altitude.toFixed(0)+" m",e.coords.altitudeAccuracy&&(i+="(+/- "+e.coords.altitudeAccuracy.toFixed(0)+" m)")),0===t.geoLocation.marker.radius?this.Gl=window.L.circle(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker).setRadius(e.coords.accuracy.toFixed(0)):this.Gl=window.L.circleMarker(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.marker),this.Gl.bindTooltip(i).addTo(V.map),t.geoLocation.watch||this.Gl.bindPopup(i).openPopup(),s&&V.map.setView(window.L.latLng(e.coords.latitude,e.coords.longitude),t.geoLocation.zoomFactor)}}class Ls{static marker=null;static initialLatLng=null}class Ss{static handleEvent(){Ls.marker&&(window.L.DomEvent.off(Ls.marker),V.map.removeLayer(Ls.marker),Ls.marker=null)}}class ks{static handleEvent(){window.L.DomEvent.off(Ls.marker,"mouseout",Ss.handleEvent)}}class As{static handleEvent(t){V.mapObjects.get(V.travel.editedRoute.objId).openPopup(t.latlng)}}class Rs{static handleEvent(t){t.latlng.lat=Ls.initialLatLng[0],t.latlng.lng=Ls.initialLatLng[1],t.target.objId=V.travel.editedRoute.objId,new Ds(t).show()}}class Os{static handleEvent(t){ys.addWayPointOnRoute(Ls.initialLatLng,[t.target.getLatLng().lat,t.target.getLatLng().lng]),Ls.marker&&(window.L.DomEvent.off(Ls.marker,"dragstart",ks.handleEvent),window.L.DomEvent.off(Ls.marker,"dragend",Os.handleEvent),window.L.DomEvent.off(Ls.marker,"contextmenu",Rs.handleEvent),V.map.removeLayer(Ls.marker),Ls.marker=null)}}class Bs{static Yl=1;static handleEvent(e){const s=tt.getRoute(e.target.objId);if(c.notEdited!==s.editionStatus)if(Ls.initialLatLng=[e.latlng.lat,e.latlng.lng],Ls.marker)Ls.marker.setLatLng(e.latlng);else{Ls.marker=window.L.marker(e.latlng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:'<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPointTmp"></div><div class="TravelNotes-Map-WayPointText">?</div>',className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});let i="";(w===t.route.showDragTooltip||Bs.Yl<=t.route.showDragTooltip)&&(Bs.Yl++,i=S.getText("EditedRouteMouseOverEL - Drag and drop to add a waypoint")+" - "),i+=s.computedName+" - ";let r=Y.getClosestLatLngDistance(s,[e.latlng.lat,e.latlng.lng]).distance;r+=s.chainedDistance,i+=k.formatDistance(r),Ls.marker.bindTooltip(i),Ls.marker.getTooltip().options.offset=[0,0],Ls.marker.addTo(V.map),window.L.DomEvent.on(Ls.marker,"mouseout",Ss.handleEvent),window.L.DomEvent.on(Ls.marker,"dragstart",ks.handleEvent),window.L.DomEvent.on(Ls.marker,"dragend",Os.handleEvent),window.L.DomEvent.on(Ls.marker,"contextmenu",Rs.handleEvent),window.L.DomEvent.on(Ls.marker,"click",As.handleEvent)}}}class js{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId),s=e.note,i=e.route,r=V.mapObjects.get(t.target.objId);if(null===i)s.latLng=[t.target.getLatLng().lat,t.target.getLatLng().lng],Ut.dispatch("updatetravelnotes");else{const e=Y.getClosestLatLngDistance(i,[t.target.getLatLng().lat,t.target.getLatLng().lng]);s.latLng=e.latLng,s.distance=e.distance,i.notes.sort(((t,e)=>t.distance-e.distance)),r.getLayer(r.bulletId).setLatLng(e.latLng),Ut.dispatch("updateitinerary")}r.getLayer(r.polylineId).setLatLngs([s.latLng,s.iconLatLng]),Ut.dispatch("roadbookupdate")}}class Hs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([[t.latlng.lat,t.latlng.lng],e.iconLatLng])}}class Us{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.moveOpacity}}class Fs{static handleEvent(e){e.originalEvent.target.style.opacity=t.note.grip.opacity}}class Ks extends se{ae;constructor(t,e){super(t,e),this.eventData&&(this.ae=tt.getNoteAndRoute(this.eventData.targetObjId).route)}get menuItems(){return[new te(S.getText("NoteContextMenu - Edit this note"),!0,(()=>Ke.editNote(this.eventData.targetObjId))),new te(S.getText("NoteContextMenu - Delete this note"),!0,(()=>Ke.removeNote(this.eventData.targetObjId))),new te(S.getText("NoteContextMenu - Zoom to note"),!0,(()=>(new es).zoomToNote(this.eventData.targetObjId))),new te(S.getText(this.ae?"NoteContextMenu - Detach note from route":"NoteContextMenu - Attach note to route"),m===V.editedRouteObjId,(()=>{this.ae?Ke.detachNoteFromRoute(this.eventData.targetObjId):Ke.attachNoteToRoute(this.eventData.targetObjId)}))]}}class Ws{static handleEvent(t){new Ks(t).show()}}class Vs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note;e.iconLatLng=[t.target.getLatLng().lat,t.target.getLatLng().lng];const s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,e.iconLatLng])}}class zs{static handleEvent(t){const e=tt.getNoteAndRoute(t.target.objId).note,s=V.mapObjects.get(t.target.objId);s.getLayer(s.polylineId).setLatLngs([e.latLng,[t.latlng.lat,t.latlng.lng]])}}class Gs extends se{constructor(t,e){super(t,e)}get menuItems(){return[new te(S.getText("WayPointContextMenu - Delete this waypoint"),V.travel.editedRoute.wayPoints.first.objId!==this.eventData.targetObjId&&V.travel.editedRoute.wayPoints.last.objId!==this.eventData.targetObjId,(()=>ys.removeWayPoint(this.eventData.targetObjId))),new te(S.getText("WayPointContextMenu - Modify properties"),!0,(()=>ys.wayPointProperties(this.eventData.targetObjId)))]}}class Xs{static handleEvent(t){new Gs(t).show()}}class Zs{static handleEvent(t){ys.wayPointDragEnd(t)}}class Js extends Cs{static get ql(){return.01}$l(t){const e=V.mapObjects.get(t);e&&(window.L.DomEvent.off(e),V.map.removeLayer(e),V.mapObjects.delete(t))}constructor(){super()}updateRoute(t,e){if(m!==t){const e=tt.getRoute(t);this.$l(e.objId);const s=e.notes.iterator;for(;!s.done;)this.$l(s.value.objId);const i=e.wayPoints.iterator;for(;!i.done;)this.$l(i.value.objId)}if(m!==e){const t=this.addRoute(e),s=V.mapObjects.get(e);if(!V.travel.readOnly){window.L.DomEvent.on(s,"contextmenu",Es.handleEvent),window.L.DomEvent.on(s,"mouseover",Bs.handleEvent);const e=t.notes.iterator;for(;!e.done;){const t=V.mapObjects.get(e.value.objId),s=t.getLayer(t.markerId),i=t.getLayer(t.bulletId);window.L.DomEvent.on(i,"dragend",js.handleEvent),window.L.DomEvent.on(i,"drag",Hs.handleEvent),window.L.DomEvent.on(i,"mouseenter",Us.handleEvent),window.L.DomEvent.on(i,"mouseleave",Fs.handleEvent),window.L.DomEvent.on(s,"contextmenu",Ws.handleEvent),window.L.DomEvent.on(s,"dragend",Vs.handleEvent),window.L.DomEvent.on(s,"drag",zs.handleEvent)}}if(!V.travel.readOnly&&c.notEdited!==t.editionStatus){const t=V.travel.editedRoute.wayPoints.iterator;for(;!t.done;)this.addWayPoint(t.value,t.first?"A":t.last?"B":t.index)}}}updateRouteProperties(t){const e=V.mapObjects.get(t),s=tt.getRoute(t);e.setStyle({color:s.color,weight:s.width,dashArray:s.dashString})}updateNote(t,e){let s=!1;if(m!==t){const e=V.mapObjects.get(t);e&&(s=e.getLayer(e.markerId).isPopupOpen()),this.$l(t)}if(m!==e){const t=this.addNote(e);s&&t.marker.openPopup(),V.travel.readOnly||(window.L.DomEvent.on(t.bullet,"dragend",js.handleEvent),window.L.DomEvent.on(t.bullet,"drag",Hs.handleEvent),window.L.DomEvent.on(t.bullet,"mouseenter",Us.handleEvent),window.L.DomEvent.on(t.bullet,"mouseleave",Fs.handleEvent),window.L.DomEvent.on(t.marker,"contextmenu",Ws.handleEvent),window.L.DomEvent.on(t.marker,"dragend",Vs.handleEvent),window.L.DomEvent.on(t.marker,"drag",zs.handleEvent))}}removeObject(t){this.$l(t)}removeAllObjects(){V.mapObjects.forEach((t=>{window.L.DomEvent.off(t),V.map.removeLayer(t)})),V.mapObjects.clear()}addWayPoint(t,e){if(h.defaultValue===t.lat&&h.defaultValue===t.lng)return;const s='<div class="TravelNotes-Map-WayPoint TravelNotes-Map-WayPoint'+("A"===e?"Start":"B"===e?"End":"Via")+'"></div><div class="TravelNotes-Map-WayPointText">'+e+"</div>",i=window.L.marker(t.latLng,{icon:window.L.divIcon({iconSize:[T,T],iconAnchor:[10,T],html:s,className:"TravelNotes-Map-WayPointStyle"}),draggable:!0});i.bindTooltip((t=>tt.getWayPoint(t.objId).fullName)),i.getTooltip().options.offset=[10,-10],window.L.DomEvent.on(i,"contextmenu",Xs.handleEvent),i.objId=t.objId,this.addToMap(t.objId,i),window.L.DomEvent.on(i,"dragend",Zs.handleEvent)}addItineraryPointMarker(e,s){this.addToMap(e,window.L.circleMarker(s,t.itineraryPoint.marker))}addSearchPointMarker(e,s,i){let r=!1;if(i){let t=[];i.forEach((e=>{t=t.concat(e)}));const e=Y.getLatLngBounds(t),s=V.map.getBounds();r=(e.getEast()-e.getWest())/(s.getEast()-s.getWest())>Js.ql&&(e.getNorth()-e.getSouth())/(s.getNorth()-s.getSouth())>Js.ql}r?this.addToMap(e,window.L.polyline(i,t.osmSearch.searchPointPolyline)):this.addToMap(e,window.L.circleMarker(s,t.osmSearch.searchPointMarker))}addRectangle(t,e,s){this.addToMap(t,window.L.rectangle(e,s))}setLayer(t){const e=Ft.getUrl(t);e&&super.setLayer(t,e)}}const Ys=new Js;class qs{Ql;Yt;tc;static get ec(){return 1}sc(t,e){if(this.Ql)return void t();const s=window.indexedDB.open("TravelNotesDb",qs.ec);s.onerror=()=>{this.Ql=null,e(new Error("Not possible to open the db"))},s.onsuccess=e=>{this.Ql=e.target.result,t()},s.onupgradeneeded=t=>{this.Ql=t.target.result,this.Ql.createObjectStore("Travels",{keyPath:"UUID"})}}ic(t,e){if(!this.Ql)return void e(new Error("Database not opened"));const s=this.Ql.transaction(["Travels"],"readonly");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").get(this.Yt).onsuccess=e=>t(e.target.result?e.target.result.data:null)}rc(t,e){if(!this.Ql)return void e(new Error("Database not opened"));const s=this.Ql.transaction(["Travels"],"readwrite");s.onerror=()=>e(new Error("Transaction error"));s.objectStore("Travels").put({UUID:this.Yt,data:this.tc}).onsuccess=()=>t()}oc(){this.Ql.close(),this.Ql=null}constructor(){}getOpenPromise(){return new Promise(((t,e)=>this.sc(t,e)))}getReadPromise(t){return this.Yt=t,new Promise(((t,e)=>this.ic(t,e)))}getWritePromise(t,e){return this.Yt=t,this.tc=e,new Promise(((t,e)=>this.rc(t,e)))}closeDb(t){if(!this.Ql)return;if(!t)return void this.oc();const e=this.Ql.transaction(["Travels"],"readwrite");e.onerror=()=>{};const s=e.objectStore("Travels").delete(t);s.onerror=()=>this.oc(),s.onsuccess=()=>this.oc()}}const $s=new qs;const Qs=new class{ac(e){const s=et.create("div",{className:e+"Travel-Header"});L.sanitizeToHtmlElement(V.travel.name,et.create("div",{className:e+"Travel-Header-Name"},s));let r=i.defaultValue,o=0,a=0;const n=V.travel.routes.iterator;for(;!n.done;){const i=n.value.objId===V.editedRouteObjId&&t.routeEditor.showEditedRouteInRoadbook?V.travel.editedRoute:n.value;L.sanitizeToHtmlElement('<a href="#route'+i.objId+'" >'+i.computedName+"</a> : "+k.formatDistance(i.distance)+".",et.create("div",{className:e+"Travel-Header-RouteName"},s)),i.chain&&(r+=i.distance,o+=i.itinerary.ascent,a+=i.itinerary.descent)}return L.sanitizeToHtmlElement("<span>"+S.getText("TravelHTMLViewsFactory - Travel distance")+"</span> : "+k.formatDistance(r),et.create("div",{className:e+"Travel-Header-TravelDistance"},s)),0!==o&&L.sanitizeToHtmlElement("<span>"+S.getText("travelHTMLViewsFactory - Travel ascent")+"</span> : "+String(o.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelAscent"},s)),0!==a&&L.sanitizeToHtmlElement("<span>"+S.getText("TravelHTMLViewsFactory - Travel descent")+"</span> : "+String(a.toFixed(0))+" m.",et.create("div",{className:e+"Travel-Header-TravelDescent"},s)),s}nc(t){const e=S.getText("TravelHTMLViewsFactory - Travel footer")+'<a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank" title="https://github.com/wwwouaiebe/TravelNotes" >Travel & Notes</a>, © <a href="https://www.ouaie.be/" target="_blank" title="https://www.ouaie.be/" >wwwouaiebe 2017 '+new Date(Date.now()).getFullYear()+'</a> © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="https://www.openstreetmap.org/copyright">'+S.getText("TravelHTMLViewsFactory - OpenStreetMap contributors")+"</a>",s=et.create("div",{className:t+"TravelFooter"});return L.sanitizeToHtmlElement(e,s),s}constructor(){}getTravelHTML(e){const s=et.create("div",{className:e+"Travel"});s.appendChild(this.ac(e)),s.appendChild(Vt.getTravelNotesHTML(e));const i=V.travel.routes.iterator;for(;!i.done;){const r=t.routeEditor.showEditedRouteInRoadbook&&i.value.objId===V.editedRouteObjId?V.travel.editedRoute:i.value;s.appendChild(zt.getRouteHeaderHTML(e,r)),r.itinerary.hasProfile&&s.appendChild(zt.getRouteProfileHTML(e,r)),s.appendChild(zt.getRouteManeuversAndNotesHTML(e,r,!1)),s.appendChild(zt.getRouteFooterHTML(e,r))}return s.appendChild(this.nc(e)),s}};class ti{hc;lc;cc;uc;vc;static get dc(){return 3e5}_c(){this.hc&&(this.hc.textContent=this.lc+" "+this.cc+" - Zoom : "+this.uc)}constructor(){this.lc=u.saved,this.cc="",this.uc="",this.vc=null}set saveStatus(t){u.modified===t&&u.notSaved===this.lc||(this.lc=t,u.modified!==t||this.vc?u.saved===t&&this.vc&&(clearTimeout(this.vc),this.vc=null):this.vc=setTimeout((()=>this.lc=u.notSaved),ti.dc),this._c())}createUI(){this.hc=et.create("span",null,et.create("div",{id:"TravelNotes-MouseUI"},document.body)),this.uc=V.map.getZoom(),this.cc=k.formatLat(t.map.center.lat)+" - "+k.formatLng(t.map.center.lng),V.map.on("mousemove",(t=>{this.cc=k.formatLatLng([t.latlng.lat,t.latlng.lng]),this._c()})),V.map.on("zoomend",(()=>{this.uc=String(V.map.getZoom()),this._c()}))}}const ei=new ti;class si{static get mc(){return.5}static get gc(){return 5}static get wc(){return 10}static get Nc(){return 31}static get Tc(){return 32}static get fc(){return 63}bc(t){return Math.floor(Math.abs(t)+si.mc)*(0<=t?1:-1)}yc(t,e,s){const i=this.bc(t*s),r=this.bc(e*s);let o=i-r;o<<=1,0>i-r&&(o=~o);let a="";for(;si.Tc<=o;)a+=String.fromCharCode((si.Tc|o&si.Nc)+si.fc),o>>=si.gc;return a+=String.fromCharCode(o+si.fc),a}u;Ic(t){let e=null,s=0,i=0;do{e=t.charCodeAt(this.u++)-si.fc,i|=(e&si.Nc)<<s,s+=si.gc}while(si.Tc<=e);return 1&i?~(i>>1):i>>1}constructor(){}encode(t,e){if(!t.length)return"";const s=e.length,i=Array.from(e,(t=>Math.pow(si.wc,t)));let r="";for(let e=0;e<s;e++)r+=this.yc(t[0][e],0,i[e]);for(let e=1;e<t.length;e++){const o=t[e],a=t[e-1];for(let t=0;t<s;t++)r+=this.yc(o[t],a[t],i[t])}return r}decode(t,e){const s=e.length;if(!t||0===t.length)return[];this.u=0;const i=[],r=Array.from(e,(t=>Math.pow(si.wc,t))),o=new Array(s).fill(0);for(;this.u<t.length;){const e=new Array(s).fill(0);for(let i=0;i<s;i++)o[i]+=this.Ic(t),e[i]=o[i]/r[i];i.push(e)}return i}}class ii{Mc(t){const e={values:"",objType:(new B).objType.jsonObject},s=[];t.itinerary.itineraryPoints.forEach((t=>{s.push([t.lat,t.lng,t.distance,t.elev,t.objId])})),e.values=(new si).encode(s,[h.fixed,h.fixed,2,2,0]),t.itinerary.itineraryPoints=e}Dc(t){const e=[];if(t.itinerary.itineraryPoints.values)(new si).decode(t.itinerary.itineraryPoints.values,[h.fixed,h.fixed,2,2,0]).forEach((s=>{const o={lat:h.defaultValue,lng:h.defaultValue,distance:i.defaultValue,elev:r.defaultValue,objId:m};[o.lat,o.lng,o.distance,o.elev,o.objId]=s,o.objType=t.itinerary.itineraryPoints.objType,e.push(o)}));else{t.itinerary.itineraryPoints.latLngs=(new si).decode(t.itinerary.itineraryPoints.latLngs,[h.fixed,h.fixed]);let s=0;t.itinerary.itineraryPoints.latLngs.forEach((i=>{const o={};o.lat=i[0],o.lng=i[1],o.distance=t.itinerary.itineraryPoints.distances[s],t.itinerary.itineraryPoints.elevs?o.elev=t.itinerary.itineraryPoints.elevs[s]:o.elev=r.defaultValue,o.objId=t.itinerary.itineraryPoints.objIds[s],o.objType=t.itinerary.itineraryPoints.objType,e.push(o),s++}))}t.itinerary.itineraryPoints=e}constructor(){}decompress(t){t.routes.forEach(this.Dc),t.editedRoute&&this.Dc(t.editedRoute)}compress(t){const e=t.jsonObject;return e.routes.forEach((t=>this.Mc(t))),this.Mc(e.editedRoute),e}}class ri{xc;Ec;Pc;constructor(t,e,s){this.xc=t,this.Ec=e,this.Pc=s}get removeTravelNotes(){return this.xc}get removeRoutesNotes(){return this.Ec}get removeManeuvers(){return this.Pc}}class oi extends Nt{Cc;Lc;Sc;kc;Ac;Rc;Oc(t){const e=et.create("div",null),s=et.create("input",{type:"checkbox",checked:!1},e);return et.create("text",{value:t},e),[e,s]}constructor(t){super(t),[this.kc,this.Cc]=this.Oc(S.getText("SaveAsDialog - Remove Travel Notes")),[this.Ac,this.Lc]=this.Oc(S.getText("SaveAsDialog - Remove Routes Notes")),[this.Rc,this.Sc]=this.Oc(S.getText("SaveAsDialog - Remove Maneuvers"))}onOk(){super.onOk(new ri(this.Cc.checked,this.Lc.checked,this.Sc.checked))}get contentHTMLElements(){return[this.kc,this.Ac,this.Rc]}get title(){return S.getText("SaveAsDialog - SaveAs")}}const ai=new class{Bc(t){const e=new K;e.jsonObject=V.travel.jsonObject,e.name+="-partial";let s=e.routes.iterator;for(;!s.done;)s.value.hidden=!1;if(t.removeTravelNotes&&e.notes.removeAll(),t.removeRoutesNotes)for(s=e.routes.iterator;!s.done;)s.value.notes.removeAll();if(t.removeManeuvers)for(s=e.routes.iterator;!s.done;)s.value.itinerary.maneuvers.removeAll();const i=(new ii).compress(e);k.saveFile(i.name+".trv",JSON.stringify(i),"application/json")}constructor(){}routeDropped(t,e,s){const i=t===V.travel.editedRoute.objId?V.editedRouteObjId:t,r=e===V.travel.editedRoute.objId?V.editedRouteObjId:e;V.travel.routes.moveTo(i,r,s),Ts.chainRoutes(),Ut.dispatch("setrouteslist"),Ut.dispatch("roadbookupdate")}saveAsTravel(){""!==V.travel.name?m===V.editedRouteObjId?(new oi).show().then((t=>{this.Bc(t)})).catch((t=>{t instanceof Error&&console.error(t)})):jt.showError(S.getText("TravelEditor - Not possible to partial save when a route is edited.")):jt.showError(S.getText("TravelEditor - Gives a name to the travel"))}saveTravel(){if(""===V.travel.name)return void jt.showError(S.getText("TravelEditor - Gives a name to the travel"));const t=V.travel.routes.iterator;for(;!t.done;)t.value.hidden=!1;const e=(new ii).compress(V.travel);k.saveFile(e.name+".trv",JSON.stringify(e),"application/json"),ei.saveStatus=u.saved}newTravel(){t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(S.getText("TravelEditor - This page ask to close; data are perhaps not saved."))||(ls.deleteAllProfiles(),Ut.dispatch("removeallobjects"),V.editedRouteObjId=m,V.travel.jsonObject=(new K).jsonObject,Ut.dispatch("setrouteslist"),Ut.dispatch("showitinerary"),Ut.dispatch("roadbookupdate"),Ut.dispatch("travelnameupdated"),t.travelEditor.startupRouteEdition&&Ts.editRoute(V.travel.routes.first.objId),ei.saveStatus=u.saved)}};class ni{jc;$t;ae;Hc;Uc(t){let e=new B;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)if("ele"===s[t].nodeName)e.elev=Number.parseFloat(s[t].textContent),0!==e.elev&&(this.ae.itinerary.hasProfile=!0);this.ae.itinerary.itineraryPoints.add(e)}Fc(t){const e=t.childNodes;for(let t=0;t<e.length;t++)if("trkpt"===e[t].nodeName)this.Uc(e[t])}Kc(){let t=0,e=0,s=this.ae.itinerary.itineraryPoints.iterator;for(s.done;!s.done;){let i=s.value.elev-s.previous.elev;0>i?e-=i:t+=i}this.ae.itinerary.ascent=t,this.ae.itinerary.descent=e}Wc(t){this.ae=new F;const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"trkseg":this.Fc(e[t])}this.ae.itinerary.hasProfile&&this.Kc(),this.$t.routes.add(this.ae)}Vc(t){let e=Number.MAX_VALUE,s=m;return this.ae.itinerary.itineraryPoints.forEach((i=>{const r=q.pointsDistance(t,i.latLng);r<e&&(e=r,s=i.objId)})),s}zc(t){const e=new j;e.iconName="kUndefined";const s=Number.parseFloat(t.getAttributeNS(null,"lat")),i=Number.parseFloat(t.getAttributeNS(null,"lon"));e.itineraryPointObjId=this.Vc([s,i]);const r=t.childNodes;for(let t=0;t<r.length;t++)if("desc"===r[t].nodeName)e.instruction=r[t].textContent;this.ae.itinerary.maneuvers.add(e)}Gc(t){const e=t.childNodes;for(let t=0;t<e.length;t++)switch(e[t].nodeName){case"name":this.ae.name=e[t].textContent;break;case"rtept":this.zc(e[t])}}Xc(t){const e=new U;e.latLng=t.latLng,e.iconLatLng=t.latLng;const s=t.name.split("+");e.iconContent='<div class="TravelNotes-MapNote TravelNotes-MapNoteCategory-0073"><svg viewBox="0 0 20 20"><text x="10" y="14">'+s[0]+"</text></svg></div>",e.tooltipContent=S.getText("GpxParser - Network node")+s[0],s[1]&&(e.tooltipContent+=S.getText("GpxParser - Go to network node")+s[1]),e.distance=Y.getClosestLatLngDistance(this.ae,e.latLng).distance,this.ae.notes.add(e)}Zc(t){let e=new O;e.lat=Number.parseFloat(t.getAttributeNS(null,"lat")),e.lng=Number.parseFloat(t.getAttributeNS(null,"lon"));const s=t.childNodes;for(let t=0;t<s.length;t++)if("name"===s[t].nodeName)e.name=s[t].textContent;this.ae.wayPoints.add(e),this.Hc&&this.Xc(e)}Jc(t){for(let e=0;e<t.length;e++)this.Zc(t[e])}Yc(){this.$t.routes.forEach((t=>{t.wayPoints.remove(t.wayPoints.first.objId),t.wayPoints.remove(t.wayPoints.last.objId);const e=new O;e.latLng=t.itinerary.itineraryPoints.first.latLng,t.wayPoints.add(e);const s=new O;s.latLng=t.itinerary.itineraryPoints.last.latLng,t.wayPoints.add(s)}))}Al(t){const e=t.itinerary.itineraryPoints.iterator,s=t.itinerary.maneuvers.iterator;e.done;let r=s.done;for(r||(s.value.distance=i.defaultValue,r=s.done),t.distance=i.defaultValue,t.duration=i.defaultValue;!e.done;)e.previous.distance=q.pointsDistance(e.previous.latLng,e.value.latLng),t.distance+=e.previous.distance,r||(s.previous.distance+=e.previous.distance,s.value.itineraryPointObjId===e.value.objId&&(t.duration+=s.previous.duration,s.value.distance=i.defaultValue,s.next&&s.value.itineraryPointObjId===s.next.itineraryPointObjId&&(r=s.done,s.value.distance=i.defaultValue),r=s.done))}constructor(){}parse(t){this.jc=(new DOMParser).parseFromString(t,"text/xml"),this.Hc=Boolean(this.jc.querySelector("gpx").getAttributeNS(null,"creator").match(/fietsnet|knooppuntnet/g)),this.$t=new K,this.$t.routes.remove(this.$t.routes.first.objId);const e=this.jc.querySelectorAll("trk");for(let t=0;t<e.length;t++)this.Wc(e[t]);const s=this.jc.querySelectorAll("rte");1===s.length&&1===this.$t.routes.length&&this.Gc(s[0]),this.$t.routes.forEach((t=>this.Al(t)));const i=this.jc.querySelectorAll("wpt");return 0<i.length&&1===this.$t.routes.length?(this.ae.wayPoints.remove(this.ae.wayPoints.first.objId),this.ae.wayPoints.remove(this.ae.wayPoints.last.objId),this.Jc(i)):this.Yc(),this.$t}}const hi=new class{ii=null;constructor(){}createUI(){this.ii=et.create("div",{id:"TravelNotes-AttributionsUI"},document.body)}set attributions(t){const e='© <a href="https://leafletjs.com/" target="_blank" title="Leaflet">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright" target="_blank" title="OpenStreetMap contributors">OpenStreetMap contributors</a> '+t+'| © <a href="https://github.com/wwwouaiebe" target="_blank" title="https://github.com/wwwouaiebe">Travel & Notes</a>';for(;this.ii.firstChild;)this.ii.removeChild(this.ii.firstChild);L.sanitizeToHtmlElement(e,this.ii)}};class li{constructor(){}handleEvent(t){const e=_s.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.backgroundColor,t.target.style["background-color"]=e.toolbarButtonData.color}}class ci{constructor(){}handleEvent(t){t.stopPropagation();const e=_s.getMapLayer(t.target.dataset.tanMapLayerName);t.target.style.color=e.toolbarButtonData.color,t.target.style["background-color"]=e.toolbarButtonData.backgroundColor}}class ui{constructor(){}handleEvent(t){t.stopPropagation();const e=_s.getMapLayer(t.target.dataset.tanMapLayerName);Ut.dispatch("layerchange",{layer:e}),hi.attributions=e.attribution,V.travel.layerName=e.name}}class vi{qc;$c;Qc;tu;constructor(t,e){this.qc=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-Button",title:t.name,dataset:{MapLayerName:t.name},textContent:t.toolbarButtonData.text,style:"color:"+t.toolbarButtonData.color+";background-color:"+t.toolbarButtonData.backgroundColor},e),this.$c=new li,this.Qc=new ci,this.tu=new ui,this.qc.addEventListener("mouseenter",this.$c,!1),this.qc.addEventListener("mouseleave",this.Qc,!1),this.qc.addEventListener("click",this.tu,!1)}destructor(){this.qc.removeEventListener("mouseenter",this.$c,!1),this.qc.removeEventListener("mouseleave",this.Qc,!1),this.qc.removeEventListener("click",this.tu,!1)}get height(){return this.qc.clientHeight}}class di{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Enter"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Leave")}}class pi{constructor(){}handleEvent(t){t.stopPropagation(),t.target.classList.add("TravelNotes-MapLayersToolbarUI-LinkButton-Leave"),t.target.classList.remove("TravelNotes-MapLayersToolbarUI-LinkButton-Enter")}}class _i{eu;su;iu;constructor(t,e){this.iu=et.create("div",{className:"TravelNotes-MapLayersToolbarUI-LinkButton TravelNotes-MapLayersToolbarUI-LinkButton-Leave"},e),et.create("a",t,this.iu),this.eu=new di,this.su=new pi,this.iu.addEventListener("mouseenter",this.eu,!1),this.iu.addEventListener("mouseleave",this.su,!1)}destructor(){this.iu.removeEventListener("mouseenter",this.eu,!1),this.iu.removeEventListener("mouseleave",this.su,!1)}get height(){return this.iu.clientHeight}}class mi{constructor(){}marginTop=0;buttonHeight=0;buttonsHeight=0;buttonTop=0}class gi{ru;static get ou(){return 3}constructor(t){this.ru=t}handleEvent(t){t.stopPropagation(),t.deltaY&&(this.ru.marginTop-=t.deltaY*g[t.deltaMode],this.ru.marginTop=this.ru.marginTop>this.ru.buttonTop?this.ru.buttonTop:this.ru.marginTop,this.ru.marginTop=this.ru.marginTop<this.ru.buttonTop-this.ru.buttonsHeight+gi.ou*this.ru.buttonHeight?this.ru.buttonTop-this.ru.buttonsHeight+gi.ou*this.ru.buttonHeight:this.ru.marginTop,t.currentTarget.style.marginTop=String(this.ru.marginTop)+"px")}}const wi=new class{ii;au;nu;ru;oi;hu;gs(){if(this.oi)return clearTimeout(this.oi),void(this.oi=null);if(this.au=et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Buttons"},this.ii),this.ru.buttonTop=this.ii.clientHeight,this.ru.buttonsHeight=0,_s.forEach((t=>{if(t.providerKeyNeeded&&Ft.hasKey(t.providerName.toLowerCase())||!t.providerKeyNeeded){const e=new vi(t,this.au);this.ru.buttonHeight=e.height,this.ru.buttonsHeight+=e.height,this.nu.push(e)}})),t.layersToolbarUI?.theDevil?.addButton){const t=new _i({href:"https://www.google.com/maps/@"+V.map.getCenter().lat+","+V.map.getCenter().lng+","+V.map.getZoom()+"z",title:"Reminder! The devil will know everything about you",textContent:"👿",target:"_blank"},this.au);this.ru.buttonsHeight+=t.height,this.nu.push(t)}this.ru.buttonTop+=this.ru.buttonHeight,this.ru.marginTop=this.ru.buttonTop,this.au.style.marginTop=String(this.ru.marginTop)+"px",this.au.addEventListener("wheel",this.hu,{passive:!0})}li(){this.nu.forEach((t=>t.destructor())),this.nu.length=0,this.au.removeEventListener("wheel",this.hu,{passive:!0}),this.ii.removeChild(this.au),this.oi=null}lu(){this.oi=setTimeout((()=>this.li()),t.layersToolbarUI.toolbarTimeOut)}constructor(){this.ru=new mi,this.hu=new gi(this.ru),this.nu=[]}createUI(){this.ii=et.create("div",{id:"TravelNotes-MapLayersToolbarUI"},document.body),et.create("div",{id:"TravelNotes-MapLayersToolbarUI-Header",textContent:S.getText("MapLayersToolbarUI - Layers")},this.ii),this.ii.addEventListener("mouseenter",(()=>this.gs()),!1),this.ii.addEventListener("mouseleave",(()=>this.lu()),!1),Ut.dispatch("layerchange",{layer:_s.defaultMapLayer}),hi.attributions=_s.defaultMapLayer.attribution}setMapLayer(t){const e=_s.getMapLayer(t);Ut.dispatch("layerchange",{layer:e}),hi.attributions=e.attribution,V.travel.layerName=e.name}};class Ni{cu(){Ut.dispatch("removeallobjects"),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const t=V.travel.routes.iterator;for(;!t.done;)c.notEdited===t.value.editionStatus&&Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:t.value.objId});m!==V.editedRouteObjId&&Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const e=V.travel.notes.iterator;for(;!e.done;)Ut.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:e.value.objId});if((new es).zoomToTravel(),wi.setMapLayer(V.travel.layerName),m!==V.editedRouteObjId){const t=V.travel.editedRoute.itinerary.provider;if(""===t||V.providers.get(t.toLowerCase())){Ut.dispatch("setprovider",{provider:t});const e=V.travel.editedRoute.itinerary.transitMode;""!==e&&Ut.dispatch("settransitmode",{transitMode:e})}else jt.showError(S.getText("FileLoader - Not possible to select as provider",{provider:t}))}Ts.chainRoutes(),Ut.dispatch("setrouteslist"),Ut.dispatch("travelnameupdated"),Ut.dispatch("showitinerary"),Ut.dispatch("roadbookupdate")}constructor(){}openLocalGpxFile(t){ls.deleteAllProfiles(),V.travel.jsonObject=(new ni).parse(t).jsonObject,V.editedRouteObjId=m,this.cu(),ei.saveStatus=u.saved}openLocalTrvFile(t){ls.deleteAllProfiles();const e=JSON.parse(t);(new ii).decompress(e),V.travel.jsonObject=e,V.editedRouteObjId=m,V.travel.routes.forEach((t=>{c.notEdited!==t.editionStatus&&(V.editedRouteObjId=t.objId)})),this.cu(),ei.saveStatus=u.saved}uu(t){const e=t.routes.iterator;for(;!e.done;)V.travel.routes.add(e.value);const s=t.notes.iterator;for(;!s.done;)V.travel.notes.add(s.value);this.cu(),ei.saveStatus=u.modified}mergeLocalGpxFile(t){this.uu((new ni).parse(t))}mergeLocalTrvFile(t){const e=JSON.parse(t);(new ii).decompress(e);const s=new K;s.jsonObject=e,this.uu(s)}}class Ti{constructor(){}handleEvent(t){t.stopPropagation(),ai.saveAsTravel()}}class fi{constructor(){}handleEvent(t){t.stopPropagation(),ai.newTravel(),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name)}}class bi{constructor(){}handleEvent(t){t.stopPropagation(),ai.saveTravel()}}class yi{constructor(){}handleEvent(t){t.stopPropagation();const e=t.target.files[0].name.split(".").pop().toLowerCase(),s=new FileReader;s.onload=()=>{try{switch(e){case"trv":(new Ni).openLocalTrvFile(s.result);break;case"gpx":(new Ni).openLocalGpxFile(s.result)}}catch(t){t instanceof Error&&(console.error(t),jt.showError("An error occurs when reading the file : "+t.message))}},s.readAsText(t.target.files[0])}}class Ii{constructor(){}handleEvent(e){e.stopPropagation(),t.travelNotes.haveBeforeUnloadWarning&&!window.confirm(S.getText("OpenButtonClickEL - This page ask to close; data are perhaps not saved."))||k.openFile(new yi,".trv,.gpx")}}class Mi{constructor(){}handleEvent(t){t.stopPropagation();const e=new FileReader;e.onload=()=>{try{switch(t.target.files[0].name.split(".").pop().toLowerCase()){case"trv":(new Ni).mergeLocalTrvFile(e.result);break;case"gpx":(new Ni).mergeLocalGpxFile(e.result)}}catch(t){t instanceof Error&&(console.error(t),jt.showError("An error occurs when reading the file : "+t.message))}},e.readAsText(t.target.files[0])}}class Di{constructor(){}handleEvent(t){t.stopPropagation(),m===V.editedRouteObjId?k.openFile(new Mi,".trv,.gpx"):jt.showError(S.getText("TravelToolbarUI - Not possible to merge a travel when a route is edited"))}}class xi{vu;du(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-TravelUI-SaveAsButton",title:S.getText("TravelToolbarUI - Save as travel"),textContent:"💾"},this.vu).addEventListener("click",new Ti,!1)}pu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Cancel travel"),textContent:"❌"},this.vu).addEventListener("click",new fi,!1)}_u(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Save travel"),textContent:"💾"},this.vu).addEventListener("click",new bi,!1)}mu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Open travel"),textContent:"📂"},this.vu).addEventListener("click",new Ii,!1)}gu(){et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Import travel"),textContent:"🌏"},this.vu).addEventListener("click",new Di,!1)}wu(){et.create("text",{value:"📋"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"TravelNotesRoadbook.html?lng="+t.travelNotes.language+"&page="+V.UUID,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelToolbarUI - Open travel roadbook")},this.vu)))}constructor(t){this.vu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.du(),this.pu(),this._u(),this.mu(),this.gu(),this.wu()}}class Ei{constructor(){}handleEvent(t){t.preventDefault()}}class Pi{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class Ci{constructor(){}handleEvent(t){t.preventDefault();const e=t.target,s=e.getBoundingClientRect();ai.routeDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class Li{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Si{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Ds(t,t.target.parentNode).show()}}class ki{Nu;Tu;fu;bu;constructor(t){this.Nu=et.create("div",{className:"TravelNotes-TravelUI-RoutesListDiv"},t),this.Nu.addEventListener("dragover",new Ei),this.Nu.addEventListener("wheel",new Li,{passive:!0}),this.Tu=new Si,this.fu=new Ci,this.bu=new Pi}toogleExpand(){return this.Nu.classList.toggle("TravelNotes-Hidden"),this.Nu.classList.contains("TravelNotes-Hidden")}setRoutesList(){for(;this.Nu.firstChild;)this.Nu.firstChild.removeEventListener("dragstart",this.bu),this.Nu.firstChild.removeEventListener("drop",this.fu),this.Nu.firstChild.removeEventListener("contextmenu",this.Tu),this.Nu.removeChild(this.Nu.firstChild);const t=V.travel.routes.iterator;for(;!t.done;){const e=t.value.objId===V.editedRouteObjId?V.travel.editedRoute:t.value,s=(t.value.objId===V.editedRouteObjId?"🔴 ":"")+(e.chain?"⛓ ":"")+(t.value.objId===V.editedRouteObjId?V.travel.editedRoute.computedName:e.computedName),i=et.create("div",{draggable:!0,className:"TravelNotes-TravelUI-RoutesList-Item TravelNotes-UI-MoveCursor"+(t.value.hidden?" TravelNotes-TravelUI-RoutesList-HiddenItem":""),dataset:{ObjId:e.objId},textContent:s},this.Nu);i.addEventListener("dragstart",this.bu),i.addEventListener("drop",this.fu),i.addEventListener("contextmenu",this.Tu)}}}class Ai{constructor(){}handleEvent(t){t.stopPropagation(),V.travel.name=L.sanitizeToJsString(t.target.value),document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name),Ut.dispatch("roadbookupdate")}}class Ri{yu=null;constructor(t){this.yu=t}handleEvent(t){t.stopPropagation();const e=this.yu.toogleExpand();t.target.textContent=e?"▶":"▼",t.target.title=e?S.getText("TravelUI - Show"):S.getText("TravelUI - Hide")}}class Oi{constructor(){}handleEvent(t){t.stopPropagation(),Ts.addRoute()}}class Bi{Iu;Mu;yu;Du;xu(t){const e=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t);et.create("span",{textContent:S.getText("TravelUI - Travel")},e),this.Mu=et.create("input",{id:"TravelNotes-TravelUI-InputTravelName",type:"text",value:V.travel.name},e),this.Mu.addEventListener("change",new Ai,!1)}Eu(){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton",title:S.getText("TravelUI - Add a route"),textContent:"+"},this.Iu).addEventListener("click",new Oi,!1)}Pu(t){this.Iu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Du=et.create("div",{textContent:"▼",className:"TravelNotes-TravelUI-RouteList-ExpandButton"},this.Iu),et.create("span",{textContent:S.getText("TravelUI - Travel routes")},this.Iu),this.Eu(this.Iu)}constructor(t){this.xu(t),new xi(t),this.Pu(t),this.yu=new ki(t),this.Du.addEventListener("click",new Ri(this.yu),!1)}setTravelName(){this.Mu.value=V.travel.name}get routesListUI(){return this.yu}}class ji{Cu=null;constructor(t){this.Cu=t}handleEvent(t){this.Cu.showPane(t.target.dataset.tanPaneId)}}class Hi{constructor(){}handleEvent(t){t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Ui{Lu;Su;ku;Au;Th;Ru(){l.invalidPane!==this.Lu&&this.Su.get(this.Lu).remove()}constructor(t){this.Lu=l.invalidPane,this.Su=new Map,this.Th=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.Au=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneControlsDiv"},t),this.ku=et.create("div",{id:"TravelNotes-PanesManagerUI-PaneDataDiv"},t),this.ku.addEventListener("wheel",new Hi,{passive:!0})}addPane(t){const e=new t(this.ku,this.Au);this.Su.set(e.paneId,e),et.create("div",{textContent:e.buttonText,className:"TravelNotes-PanesManagerUI-PaneButton",dataset:{PaneId:e.paneId}},this.Th).addEventListener("click",new ji(this))}showPane(t){this.Ru(),this.Lu=t,this.Su.get(this.Lu).add(),document.querySelectorAll(".TravelNotes-PanesManagerUI-PaneButton").forEach((t=>{t.dataset.tanPaneId===this.Lu?t.classList.add("TravelNotes-PanesManagerUI-ActivePaneButton"):t.classList.remove("TravelNotes-PanesManagerUI-ActivePaneButton")}))}updatePane(t){t===this.Lu&&this.showPane(t)}}class Fi{Ou;bt;qc;static get Bu(){return Object.freeze({bike:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <path fill="rgb(0,0,191)" d="m 11.25,3.125 v 1.09375 l 1.5625,0.9765625 V 6.5625 H 7.4999999 V 5.625 h 0.625 c 1.25,0 1.25,-1.25 0,-1.25 h -2.5 c -1.25,0 -1.25,1.25 0,1.25 h 0.625 V 6.5625 L 5.0781249,8.75 c -0.026125,-5.821e-4 -0.0519,0 -0.078125,0 -2.0153538,0 -3.75,1.734646 -3.75,3.75 0,2.015354 1.7346462,3.75 3.75,3.75 2.0153537,0 3.75,-1.734646 3.75,-3.75 0,-0.432461 -0.089462,-0.858226 -0.234375,-1.25 h 0.546875 c 0.9375,0 1.1534331,-0.567495 1.4843751,-0.898437 L 12.773438,7.8125 13.4375,9.1015625 C 12.159328,9.7073948 11.25,11.031094 11.25,12.5 c 0,2.015354 1.734646,3.75 3.75,3.75 2.015354,0 3.75,-1.734646 3.75,-3.75 0,-2.015354 -1.734646,-3.75 -3.75,-3.75 -0.03934,0 -0.07808,-0.00131 -0.117187,0 L 13.75,6.5625 V 4.5703125 Z M 7.2265624,7.8125 H 11.132813 L 9.1796874,10 h -1.40625 c -0.0231,0 -0.054487,0.0026 -0.078125,0 C 7.3660586,9.6463159 6.9994024,9.3504739 6.5624999,9.140625 6.5471874,9.1173375 6.5373874,9.0856825 6.5234374,9.0625 Z M 4.9999999,10 c 1.2571387,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.2428613,2.5 -2.5,2.5 -1.2571388,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.2428612,-2.5 2.5,-2.5 z M 15,10 c 1.257137,0 2.5,1.242862 2.5,2.5 0,1.257139 -1.242863,2.5 -2.5,2.5 -1.257139,0 -2.5,-1.242861 -2.5,-2.5 0,-1.257138 1.242861,-2.5 2.5,-2.5 z" /> </svg>',pedestrian:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20"  xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)" transform="matrix(0.15866777,0,0,0.12627988,148.47251,-116.69398)"> <path d="m -875.5,962.4 c 2,-1.5 4.6,-2.3 7.4,-2.2 3.6,0.3 6.7,2.5 8.4,5.2 l 10.7,21.2 14.5,10.1 c 1.2,1 2,2.5 1.9,4.2 -0.1,2.6 -2.5,4.6 -5.2,4.3 -0.7,0 -1.5,-0.3 -2.2,-0.7 l -15.6,-10.7 c -0.4,-0.4 -0.9,-0.9 -1.2,-1.5 l -4.1,-7.9 -4.8,21.1 18.9,22.3 c 0.4,0.7 0.7,1.5 0.9,2.2 l 5.1,26.9 c 0,0.6 0,1 0,1.5 -0.3,4.1 -3.8,6.8 -7.7,6.7 -3.2,-0.3 -5.7,-2.6 -6.5,-5.7 l -4.8,-25.1 -15.3,-17 -3.6,16.3 c -0.1,0.7 -1.2,2.3 -1.5,2.9 l -14.6,24.9 c -1.5,2.2 -3.9,3.8 -6.7,3.4 -4.1,-0.3 -7,-3.8 -6.7,-7.7 0.1,-1.2 0.6,-2.2 1,-3.1 l 13.7,-22.8 11.4,-50.4 -7.4,6 -4.1,18 c -0.4,2.2 -2.6,4.2 -5.1,4.1 -2.6,-0.1 -4.6,-2.5 -4.5,-5.2 0,-0.1 0,-0.4 0.1,-0.6 l 4.6,-20.9 c 0.3,-0.9 0.7,-1.6 1.5,-2.2 z" /> <path d="m -884.5,943.5 c 1.3,8.6 8.7,15.3 17.8,15.3 5.7,0 10.2,-4.6 10.2,-10.2 0,-5.6 -4.6,-10.2 -10.2,-10.2 -3.9,0 -7.2,2 -8.9,5.2 -0.2,0.4 -0.5,0.7 -0.8,1 -2,2 -5.3,2 -7.3,0 -0.4,-0.4 -0.6,-0.7 -0.8,-1.1 z" /> </g> </svg>',car:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" > <g fill="rgb(0,0,191)"> <path d="m 2,13 a 1.7142857,1.7142857 0 0 0 1.7142857,1.714286 H 16.285714 A 1.7142857,1.7142857 0 0 0 18,13 V 9.5714286 A 1.7142857,1.7142857 0 0 0 16.285714,7.8571429 H 3.7142857 A 1.7142857,1.7142857 0 0 0 2,9.5714286 Z m 1.8285714,-2.285714 a 1.0285714,1.0285714 0 1 1 0,0.01143 z m 10.2857146,0 a 1.0285714,1.0285714 0 1 1 0,0.01143 z" /> <path d="M 4.2857143,7.8571429 V 5 A 1.7142857,1.7142857 0 0 1 6,3.2857143 h 8 A 1.7142857,1.7142857 0 0 1 15.714286,5 V 7.8571429 H 14 V 6.1428571 A 1.1428571,1.1428571 0 0 0 12.857143,5 H 7.1428571 A 1.1428571,1.1428571 0 0 0 6,6.1428571 v 1.7142858 z" /> <g transform="matrix(1.1428571,0,0,1.1428571,2,2.1428571)"> <rect x="1" y="10" width="2" height="3" /> <rect x="11" y="10" width="2" height="3" /> </g> </g> </svg>',train:'data:image/svg+xml;utf8,<svg viewBox="-3 -3 20 20" xmlns="http://www.w3.org/2000/svg"> <g fill="rgb(0,0,191)"> <path d="M 5,0 C 3.025911,-0.0084 1,3 1,7 l 0,2 c 0,1 1,2 2,2 l 8,0 c 1,0 2,-1 2,-2 L 13,7 C 13,3 11,0 9,0 z m -1,3 6,0 c 0,0 1,1 1,3 L 3.03125,6 C 2.994661,3.9916 4,3 4,3 z M 3,8 6,8 6,9 3,9 z m 5,0 3,0 0,1 -3,0 z m -6,4 -1,2 3,0 1,-2 z m 7,0 1,2 3,0 -1,-2 z"/></g></svg>',line:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <line x1="5" y1="17" x2= "11" y2="2" stroke="rgb(0,0,0)" /> <line x1="3" y1="6" x2="17" y2="9" stroke="rgb(191,0,0)" /> <line x1="3" y1= "16" x2="17" y2="5" stroke="rgb(255,204,0)" /> </svg>',circle:'data:image/svg+xml;utf8,<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" > <g fill="transparent"> <circle cx="8" cy="6" r="5" stroke="rgb(0,0,0)" /> <circle cx="12" cy="12" r="4" stroke="rgb(255,204,0)" /> <circle cx="14" cy="8" r="3" stroke="rgb(191,0,0)" /> </g> </svg>'})}constructor(t,e){this.Ou=t,this.bt=e,this.qc=et.create("img",{src:Fi.Bu[e],id:"TravelNotes-ProvidersToolbarUI-"+e+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:S.getText("ProvidersToolbarUI - "+e)}),this.qc.addEventListener("click",this),this.visible=!1}handleEvent(t){t.stopPropagation(),this.Ou.transitMode=this.bt,bs.startRouting()}get buttonHTMLElement(){return this.qc}get transitMode(){return this.bt}set active(t){t?this.qc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton"):this.qc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveTransitModeImgButton")}set visible(t){t?this.qc.classList.remove("TravelNotes-Hidden"):this.qc.classList.add("TravelNotes-Hidden")}}class Ki{Ou;ft;qc;constructor(t,e){this.Ou=t,this.ft=e,this.qc=et.create("img",{src:e.icon,id:"TravelNotes-ProvidersToolbarUI-"+e.name+"ImgButton",className:"TravelNotes-ProvidersToolbarUI-ImgButton",title:e.title||e.name}),this.qc.addEventListener("click",this)}handleEvent(t){t.stopPropagation(),this.Ou.provider=this.ft.name,bs.startRouting()}get buttonHTMLElement(){return this.qc}get provider(){return this.ft}set active(t){t?this.qc.classList.add("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton"):this.qc.classList.remove("TravelNotes-ProvidersToolbarUI-ActiveProviderImgButton")}}class Wi{ju;Hu;Uu;Fu;Ku;Wu(){["bike","pedestrian","car","train","line","circle"].forEach((t=>{const e=new Fi(this,t);this.Hu.set(t,e),this.ju.appendChild(e.buttonHTMLElement)}))}Vu(){V.providers.forEach((t=>{if(!t.providerKeyNeeded||Ft.hasKey(t.name)){const e=new Ki(this,t);this.Uu.set(t.name,e),this.ju.appendChild(e.buttonHTMLElement)}}))}constructor(t){this.Hu=new Map,this.Uu=new Map,this.ju=et.create("div",{className:"TravelNotes-UI-FlexRowDiv TravelNotes-ProvidersToolbarUI-ImgButtonsDiv"},t),this.Wu(),this.Vu(),this.provider=this.Uu.keys().next().value}set provider(t){V.routing.provider=t,this.Ku&&(this.Ku.active=!1),this.Ku=this.Uu.get(t),this.Ku.active=!0;const e=V.providers.get(t.toLowerCase());this.Hu.forEach((t=>{t.visible=w!==e.transitModes.indexOf(t.transitMode)})),this.Fu&&w!==e.transitModes.indexOf(this.Fu.transitMode)||(this.Fu=null,this.Hu.forEach((t=>{this.Fu||w===e.transitModes.indexOf(t.transitMode)?t.active=!1:(this.Fu=t,t.active=!0,V.routing.transitMode=t.transitMode)})))}set transitMode(t){V.routing.transitMode=t,this.Fu&&(this.Fu.active=!1),this.Fu=this.Hu.get(t),this.Fu.active=!0}providersAdded(){for(;this.ju.firstChild;)this.ju.removeChild(this.ju.firstChild);this.Hu.clear(),this.Uu.clear(),this.Wu(),this.Vu(),this.provider=this.Uu.keys().next().value;const t=this.Uu.keys().next().value;this.provider=t,this.transitMode=V.providers.get(t.toLowerCase()).transitModes[0]}}const Vi=new class{zu=navigator.geolocation?o.inactive:o.disabled;Gu=null;Xu(t){Ut.dispatch("geolocationpositionchanged",{position:t})}Zu(){o.active===this.zu&&(this.zu=o.inactive),Ut.dispatch("geolocationstatuschanged",{status:this.zu}),this.Gu&&(navigator.geolocation.clearWatch(this.Gu),this.Gu=null)}Ju(t){1===t.code&&(this.zu=o.refusedByUser),2===t.code&&jt.showError(S.getText("GeoLocator - Geolocation disabled on the device")),this.Zu()}Yu(){this.zu=o.active,Ut.dispatch("geolocationstatuschanged",{status:this.zu}),t.geoLocation.watch?this.Gu=navigator.geolocation.watchPosition((t=>this.Xu(t)),(t=>this.Ju(t)),t.geoLocation.options):navigator.geolocation.getCurrentPosition((t=>this.Xu(t)),(t=>this.Ju(t)),t.geoLocation.options)}constructor(){}get status(){return this.zu}switch(){switch(this.zu){case o.inactive:this.Yu();break;case o.active:this.Zu()}return this.zu}};class zi{constructor(){}handleEvent(t){t.stopPropagation(),Ft.setKeysFromDialog()}}class Gi{constructor(){}handleEvent(t){t.stopPropagation(),Vi.switch()}}class Xi{constructor(){}handleEvent(t){t.stopPropagation(),t.target.textContent="📌"===t.target.textContent?"❌":"📌",Ut.dispatch("uipinned")}}class Zi{qu;vu;$u(){et.create("text",{value:"🏠"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Home"},this.vu)))}Qu(){et.create("text",{value:"?"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:"https://wwwouaiebe.github.io/TravelNotes/userGuides/README.html#"+t.travelNotes.language,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Help"},this.vu)))}tv(){et.create("text",{value:"@"},et.create("a",{className:"TravelNotes-UI-LinkButton",href:t.travelNotesToolbarUI.contactMail.url||window.location.origin,target:"_blank"},et.create("div",{className:"TravelNotes-UI-Button",title:"Contact"},this.vu)))}ev(){t.APIKeysDialog.showButton&&et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelNotesToolbarUI - API keys"),textContent:"🔑"},this.vu).addEventListener("click",new zi,!1)}sv(){o.disabled<Vi.status&&(this.qu=et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("TravelNotesToolbarUI - Geo location"),textContent:"🌐"},this.vu),this.qu.addEventListener("click",new Gi,!1))}rv(){et.create("div",{textContent:t.travelEditor.startMinimized?"📌":"❌",className:"TravelNotes-UI-Button TravelNotes-UI-FlexRow-RightButton"},this.vu).addEventListener("click",new Xi,!1)}constructor(t){this.vu=et.create("div",{className:"TravelNotes-UI-FlexRowDiv"},t),this.$u(),this.Qu(),this.tv(),this.ev(),this.sv(),this.rv()}geoLocationStatusChanged(t){switch(t){case o.inactive:this.qu.classList.remove("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;case o.active:this.qu.classList.add("TravelNotes-TravelNotesToolbarUI-GeoLocationButton-Striked");break;default:this.qu&&(this.qu.parentNode.removeChild(this.qu),this.qu=null)}}}class Ji{ku;Au;constructor(t,e){this.ku=t,this.Au=e}get paneData(){return this.ku}get paneControl(){return this.Au}remove(){}add(){}get paneId(){return l.invalidPane}get buttonText(){return""}}class Yi{ov;constructor(t){this.ov=t}handleEvent(t){t.stopPropagation(),this.ov.toggleNotes()}}class qi{ov;constructor(t){this.ov=t}handleEvent(t){t.stopPropagation(),this.ov.toggleManeuvers()}}class $i{av;nv;hv;lv;cv=t.itineraryPaneUI.showNotes;uv=t.itineraryPaneUI.showManeuvers;vv=null;dv=null;Au=null;ov=null;constructor(t,e){this.Au=t,this.ov=e,this.vv=new Yi(e),this.dv=new qi(e)}addControl(){this.nv=et.create("div",null,this.Au),et.create("text",{value:S.getText("ItineraryControlUI - Show notes")},this.nv),this.hv=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowNotesInput",checked:this.cv},this.nv),this.hv.addEventListener("click",this.vv),et.create("text",{value:S.getText("ItineraryControlUI - Show maneuvers")},this.nv),this.lv=et.create("input",{type:"checkbox",id:"TravelNotes-ItineraryPane-ShowManeuversInput",checked:this.uv},this.nv),this.lv.addEventListener("click",this.dv),this.av=zt.getRouteHeaderHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute),this.Au.appendChild(this.av),this.uv||this.ov.toggleManeuvers(),this.cv||this.ov.toggleNotes()}clearControl(){this.nv&&(this.lv&&(this.uv=this.lv.checked,this.lv.removeEventListener("click",this.dv),this.nv.removeChild(this.lv),this.lv=null),this.hv&&(this.cv=this.hv.checked,this.hv.removeEventListener("click",this.vv),this.nv.removeChild(this.hv),this.hv=null),this.Au.removeChild(this.nv),this.nv=null),this.av&&(this.Au.removeChild(this.av),this.av=null)}}class Qi extends se{constructor(t,e){super(t,e)}get menuItems(){return[new te(S.getText("ManeuverContextMenu - Zoom to this maneuver"),!0,(()=>(new es).zoomToManeuver(this.eventData.targetObjId)))]}}class tr{ku;constructor(t){this.ku=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Qi(t,this.ku).show()}}class er{ku;constructor(t){this.ku=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Ks(t,this.ku).show()}}class sr{constructor(){}handleEvent(t){t.stopPropagation(),Ut.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.itinerary.itineraryPoints.getAt(V.travel.editedRoute.itinerary.maneuvers.getAt(Number.parseInt(t.target.dataset.tanObjId)).itineraryPointObjId).latLng})}}class ir{constructor(){}handleEvent(t){t.stopPropagation(),Ut.dispatch("additinerarypointmarker",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId),latLng:V.travel.editedRoute.notes.getAt(Number.parseInt(t.target.dataset.tanObjId)).latLng})}}class rr{constructor(){}handleEvent(t){t.stopPropagation(),Ut.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanMarkerObjId)})}}class or{ku;pv;_v;mv;gv;wv;Nv;Tv(t){this.pv.childNodes.forEach((e=>{t===e.dataset.tanObjType&&e.classList.toggle("TravelNotes-Hidden")}))}constructor(t){this.ku=t,this._v=new tr(this.ku),this.mv=new er(this.ku),this.gv=new sr,this.wv=new ir,this.Nv=new rr}toggleNotes(){this.Tv("Note")}toggleManeuvers(){this.Tv("Maneuver")}addData(){this.pv=zt.getRouteManeuversAndNotesHTML("TravelNotes-ItineraryPaneUI-",V.travel.editedRoute,!0),this.pv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.addEventListener("contextmenu",this._v),t.addEventListener("mouseenter",this.gv),t.addEventListener("mouseleave",this.Nv)):"Note"===t.dataset.tanObjType&&(t.addEventListener("contextmenu",this.mv),t.addEventListener("mouseenter",this.wv),t.addEventListener("mouseleave",this.Nv))})),this.ku.appendChild(this.pv)}clearData(){this.pv&&(this.pv.childNodes.forEach((t=>{"Maneuver"===t.dataset.tanObjType?(t.removeEventListener("contextmenu",this._v),t.removeEventListener("mouseenter",this.gv),t.removeEventListener("mouseleave",this.Nv)):"Note"===t.dataset.tanObjType&&(t.removeEventListener("contextmenu",this.mv),t.removeEventListener("mouseenter",this.wv),t.removeEventListener("mouseleave",this.Nv))})),this.ku.removeChild(this.pv)),this.pv=null}}class ar extends Ji{ov;fv;constructor(t,e){super(t,e),this.ov=new or(this.paneData),this.fv=new $i(this.paneControl,this.ov)}remove(){this.ov.clearData(),this.fv.clearControl()}add(){m!==V.editedRouteObjId&&(this.ov.addData(),this.fv.addControl())}get paneId(){return l.itineraryPane}get buttonText(){return S.getText("ItineraryPaneUI - Itinerary")}}class nr{constructor(){}handleEvent(t){t.stopPropagation();try{t.dataTransfer.setData("ObjId",t.target.dataset.tanObjId),t.dataTransfer.dropEffect="move"}catch(t){t instanceof Error&&console.error(t)}}}class hr{constructor(){}handleEvent(t){t.preventDefault()}}class lr{constructor(){}handleEvent(t){t.preventDefault();const e=t.currentTarget,s=e.getBoundingClientRect();Ke.travelNoteDropped(Number.parseInt(t.dataTransfer.getData("ObjId")),Number.parseInt(e.dataset.tanObjId),t.clientY-s.top<s.bottom-t.clientY)}}class cr{ku=null;constructor(t){this.ku=t}handleEvent(t){t.stopPropagation(),t.preventDefault(),new Ks(t,this.ku).show()}}class ur extends Ji{bv;yv;Iv;Mv;Dv;constructor(t,e){super(t,e),this.yv=new nr,this.Iv=new hr,this.Mv=new lr,this.Dv=new cr(t)}remove(){this.bv&&(this.bv.childNodes.forEach((t=>{t.removeEventListener("contextmenu",this.Dv,!1),t.removeEventListener("dragstart",this.yv,!1),t.removeEventListener("drop",this.Mv,!1)})),this.bv.removeEventListener("dragover",this.Iv,!1),this.paneData.removeChild(this.bv)),this.bv=null}add(){this.bv=Vt.getTravelNotesHTML("TravelNotes-TravelNotesPaneUI-"),this.bv.addEventListener("dragover",this.Iv,!1),this.paneData.appendChild(this.bv),this.bv.childNodes.forEach((t=>{t.draggable=!0,t.addEventListener("contextmenu",this.Dv,!1),t.addEventListener("dragstart",this.yv,!1),t.addEventListener("drop",this.Mv,!1),t.classList.add("TravelNotes-UI-MoveCursor")}))}get paneId(){return l.travelNotesPane}get buttonText(){return S.getText("TravelNotesPaneUI - Travel notes")}}class vr{ot="";xv=!1;Ev=[];Pv=["node","way","relation"];Cv=[];Lv=!1;Sv=!1;t=m;constructor(t,e){this.ot=L.sanitizeToJsString(t),e&&(this.Sv=!0,this.xv=!0),this.t=f.nextObjId}get name(){return this.ot}get isRoot(){return this.xv}get items(){return this.Ev}get elementTypes(){return this.Pv}setElementType(t){w!==["node","way","relation"].indexOf(t)&&(this.Pv=[t])}get filterTagsArray(){return this.Cv}get isSelected(){return this.Lv}set isSelected(t){this.Lv=t,this.items.forEach((e=>{e.isSelected=t}))}get isExpanded(){return this.Sv}set isExpanded(t){this.Sv=t}get objId(){return this.t}}const dr=new class{kv;Av;Rv;Ov;Bv(t){const e=t.split(";");for(;""===e[e.length-1];)e.pop();let s=0;const i=[];e.forEach((t=>{if(""!==t)if(w===t.indexOf("="))this.Rv=new vr(t),this.Av.set(this.Rv.objId,this.Rv),this.Ov[s].push(this.Rv),this.Ov[s+1]=this.Rv.items;else{let e=t.split("=");if("element"===e[0])this.Rv.setElementType(e[1]);else{let t={};t[e[0]]="*"===e[1]?null:e[1],i.push(t)}}s++})),0!==i.length&&this.Rv.filterTagsArray.push(i)}jv(t){t.items.forEach((t=>{this.jv(t)})),t.isExpanded=!0}Hv(t){t.items.forEach((t=>{this.Hv(t)})),t.isExpanded=!1}constructor(){this.kv=new vr("",!0),this.Av=new Map,this.Av.set(this.kv.objId,this.kv),this.Ov=[this.kv.items]}get dictionary(){return this.kv}parseDictionary(t){t.split(/\r\n|\r|\n/).forEach((t=>{""!==t&&this.Bv(t)}))}selectItem(t,e){this.Av.get(t).isSelected=e}unselectAll(){this.kv.isSelected=!1}expandItem(t){let e=this.Av.get(t);e.isExpanded=!e.isExpanded}expand(){this.jv(this.kv)}collapse(){this.kv.items.forEach((t=>this.Hv(t)))}};class pr{Uv;Fv;Kv;static get Wv(){return 5e3}Vv(t,e){let s=!0;return e.forEach((e=>{const[i,r]=Object.entries(e)[0];s=s&&t.tags[i]&&(!r||t.tags[i]===r)})),s}zv(t,e){this.Fv.forEach((s=>{s.filterTagsArray.forEach((i=>{this.Vv(t,i)&&(t.description=s.name,e.set(t.id,t))}))}))}Gv(){const e=[],s=new Map;this.Fv.forEach((t=>{t.filterTagsArray.forEach((e=>{const[i,r]=Object.entries(e[0])[0];let o=s.get(i);o||(o={values:new Map,elements:new Map},s.set(i,o)),o.values.set(r,r),t.elementTypes.forEach((t=>{o.elements.set(t,t)}))}))}));const i=this.Xv();this.Kv=i;const r="("+i.getSouthWest().lat.toFixed(h.fixed)+","+i.getSouthWest().lng.toFixed(h.fixed)+","+i.getNorthEast().lat.toFixed(h.fixed)+","+i.getNorthEast().lng.toFixed(h.fixed)+")";return s.forEach(((s,i)=>{let o='"'+i+'"';if(1===s.values.size){const t=s.values.values().next().value;t&&(o+='="'+t+'"')}else 1<s.values.size&&(o+='~"',s.values.forEach((t=>{o+=t+"|"})),o=o.substring(0,o.length-1)+'"');if(t.overpassApi.useNwr){const t=1===s.elements.size?s.elements.values().next().value:"nwr";e.push(t+"["+o+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}else{let t=[];1===s.elements.size?t.push(s.elements.values().next().value):t=["node","way","rel"],t.forEach((t=>{e.push(t+"["+o+"]"+r+";"+("node"===t?"":"(._;>;);")+"out;")}))}})),e}Zv(t){t.isSelected&&0<t.filterTagsArray.length&&this.Fv.push(t),t.items.forEach((t=>this.Zv(t)))}Xv(){const t=V.map.getCenter(),e=V.map.getBounds(),s=Y.getSquareBoundingBox([t.lat,t.lng],pr.Wv);return e.getSouthWest().lat=Math.max(e.getSouthWest().lat,s.getSouthWest().lat),e.getSouthWest().lng=Math.max(e.getSouthWest().lng,s.getSouthWest().lng),e.getNorthEast().lat=Math.min(e.getNorthEast().lat,s.getNorthEast().lat),e.getNorthEast().lng=Math.min(e.getNorthEast().lng,s.getNorthEast().lng),e}constructor(){this.Uv=!1,this.Fv=[],this.Kv=null}async search(){if(this.Uv)return;this.Uv=!0,this.Fv=[],this.Zv(dr.dictionary);const t=new me({searchPlaces:!1});await t.loadData(this.Gv());const e=new Map;[t.nodes,t.ways,t.relations].forEach((t=>{t.forEach((t=>{t.tags&&this.zv(t,e)}))})),V.searchData.length=0,Array.from(e.values()).sort(((t,e)=>t.description>e.description)).forEach((t=>V.searchData.push(t))),this.Uv=!1,Ut.dispatch("showsearch")}get searchBounds(){return this.Xv()}get previousSearchBounds(){return this.Kv}}const _r=new pr;class mr{Jv;Yv;qv(){m===this.Yv?this.Yv=f.nextObjId:Ut.dispatch("removeobject",{objId:this.Yv}),Ut.dispatch("addrectangle",{objId:this.Yv,bounds:_r.searchBounds,properties:t.osmSearch.nextSearchLimit})}$v(){const e=_r.previousSearchBounds;e&&(m===this.Jv?this.Jv=f.nextObjId:Ut.dispatch("removeobject",{objId:this.Jv}),Ut.dispatch("addrectangle",{objId:this.Jv,bounds:[[e.getSouthWest().lat,e.getSouthWest().lng],[e.getNorthEast().lat,e.getNorthEast().lng]],properties:t.osmSearch.previousSearchLimit}))}constructor(){this.Jv=m,this.Yv=m}show(){V.map.on("zoom",this.qv,this),V.map.on("move",this.qv,this),this.qv(),this.$v()}hide(){V.map.off("zoom",this.qv,this),V.map.off("move",this.qv,this),m!==this.Yv&&(Ut.dispatch("removeobject",{objId:this.Yv}),this.Yv=m),m!==this.Jv&&(Ut.dispatch("removeobject",{objId:this.Jv}),this.Jv=m)}}class gr{dr;nh;constructor(t,e){this.dr=t,this.nh=e}get latLng(){return this.dr}get geometry(){return this.nh}}class wr extends se{Qv;dr;constructor(t,e){super(t,e),this.Qv=V.searchData[Number.parseInt(t.currentTarget.dataset.tanElementIndex)],this.dr=[this.Qv.lat,this.Qv.lon]}get menuItems(){return[new te(S.getText("OsmSearchContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>ys.setStartPoint(this.dr))),new te(S.getText("OsmSearchContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>ys.addWayPoint(this.dr))),new te(S.getText("OsmSearchContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>ys.setEndPoint(this.dr))),new te(S.getText("OsmSearchContextMenu - Create a route note with this result"),!0,(()=>Ke.newSearchRouteNote(this.Qv))),new te(S.getText("OsmSearchContextMenu - Create a travel note with this result"),!0,(()=>Ke.newSearchTravelNote(this.Qv))),new te(S.getText(Ke.osmSearchNoteDialog?"OsmSearchContextMenu - Hide note dialog":"OsmSearchContextMenu - Show note dialog"),!0,(()=>Ke.changeOsmSearchNoteDialog())),new te(S.getText("OsmSearchContextMenu - Zoom to this result"),!0,(()=>(new es).zoomToPoi(new gr(this.dr,this.Qv.geometry))))]}}class Nr{constructor(){}handleEvent(t){t.stopPropagation(),t.preventDefault(),new wr(t,this.paneDataDiv).show()}}class Tr{constructor(){}handleEvent(t){t.stopPropagation();const e=V.searchData[Number.parseInt(t.target.dataset.tanElementIndex)];Ut.dispatch("addsearchpointmarker",{objId:Number.parseInt(t.target.dataset.tanObjId),latLng:[e.lat,e.lon],geometry:e.geometry})}}class fr{constructor(){}handleEvent(t){t.stopPropagation(),Ut.dispatch("removeobject",{objId:Number.parseInt(t.target.dataset.tanObjId)})}}class br{ku;td;ed;sd;rd;od;ad;nd;hd(){let t="";t=this.td.tags.rcn_ref?"<div class='TravelNotes-MapNote TravelNotes-MapNoteCategory-0073'><svg viewBox='0 0 20 20'><text class='' x=10 y=14>"+this.td.tags.rcn_ref+"</text></svg></div>":oe.preDefinedIconDataFromName(this.td.description)||"";const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-IconCell"},this.ed);L.sanitizeToHtmlElement(t,e)}ld(t){t&&et.create("div",{textContent:t},this.sd)}la(){const t=(this.td.tags["addr:street"]?(this.td.tags["addr:housenumber"]?this.td.tags["addr:housenumber"]+" ":"")+this.td.tags["addr:street"]+" ":"")+(this.td.tags["addr:city"]?(this.td.tags["addr:postcode"]?this.td.tags["addr:postcode"]+" ":"")+this.td.tags["addr:city"]:"");""!==t&&this.ld(t,this.sd)}ud(){this.td.tags.phone&&this.ld("☎️ : "+this.td.tags.phone,this.sd)}vd(){this.td.tags.email&&et.create("a",{href:"mailto:"+this.td.tags.email,textContent:this.td.tags.email},et.create("div",{textContent:"📧 : "},this.sd))}dd(){this.td.tags.website&&et.create("a",{href:this.td.tags.website,target:"_blank",textContent:this.td.tags.website},et.create("div",null,this.sd))}pd(){this.sd=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Cell"},this.ed),this.ld(this.td.description),this.ld(this.td.tags.name),this.ld(this.td.tags.rcn_ref),this.la(),this.ud(),this.vd(),this.dd()}_d(){for(const[t,e]of Object.entries(this.td.tags))this.ed.title+=t+"="+e+"\n"}zr(){this.ed.addEventListener("contextmenu",this.od,!1),this.ed.addEventListener("mouseenter",this.ad,!1),this.ed.addEventListener("mouseleave",this.nd,!1)}md(t){this.ed=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchResult-Row",dataset:{ObjId:f.nextObjId,ElementIndex:this.rd++}},t),this.hd(),this.pd(),this._d(),this.zr()}constructor(t){this.ku=t,this.od=new Nr,this.ad=new Tr,this.nd=new fr,this.rd=0}addData(){this.td=null,this.ed=null,this.sd=null,this.rd=0,V.searchData.forEach((t=>{this.td=t,this.md(this.ku)}))}clearData(){for(;this.ku.firstChild;)this.ku.firstChild.removeEventListener("contextmenu",this.od,!1),this.ku.firstChild.removeEventListener("mouseenter",this.ad,!1),this.ku.firstChild.removeEventListener("mouseleave",this.nd,!1),Ut.dispatch("removeobject",{objId:Number.parseInt(this.ku.firstChild.dataset.tanObjId)}),this.ku.removeChild(this.ku.firstChild)}}class yr{gd;wd;constructor(t,e){this.gd=t,this.wd=e}handleEvent(t){t.stopPropagation(),dr.dictionary.isExpanded=!1,this.gd.redraw(),V.searchData.length=0,Ut.dispatch("showsearch"),this.wd.showWait(),_r.search()}}class Ir{gd;constructor(t){this.gd=t}handleEvent(t){t.stopPropagation(),dr.expand(),this.gd.redraw()}}class Mr{gd;constructor(t){this.gd=t}handleEvent(t){t.stopPropagation(),dr.collapse(),this.gd.redraw()}}class Dr{gd;constructor(t){this.gd=t}handleEvent(t){t.stopPropagation(),dr.unselectAll(),this.gd.redraw()}}class xr{ju;constructor(t,e){this.ju=et.create("div"),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Search OpenStreetMap"),textContent:"🔎"},this.ju).addEventListener("click",new yr(t,e),!1),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Expand tree"),textContent:"▼"},this.ju).addEventListener("click",new Ir(t),!1),et.create("div",{className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Collapse tree"),textContent:"▶"},this.ju).addEventListener("click",new Mr(t),!1),et.create("div",{id:"TravelNotes-OsmSearchPaneUI-ClearAllButton",className:"TravelNotes-UI-Button",title:S.getText("OsmSearchToolbarUI - Clear tree"),textContent:"❌"},this.ju).addEventListener("click",new Dr(t),!1)}get toolbarHTMLElement(){return this.ju}}class Er{gd=null;constructor(t){this.gd=t}handleEvent(t){t.stopPropagation(),dr.selectItem(Number.parseInt(t.target.parentNode.dataset.tanObjId),t.target.checked),this.gd.redraw()}}class Pr{constructor(){}handleEvent(t){t.stopPropagation(),t.deltaY&&(t.target.scrollTop+=t.deltaY*g[t.deltaMode]),t.stopPropagation()}}class Cr{gd=null;constructor(t){this.gd=t}handleEvent(t){t.stopPropagation(),dr.expandItem(Number.parseInt(t.target.parentNode.dataset.tanObjId)),this.gd.redraw()}}class Lr{Nd;Td;fd;bd;yd(t){this.bd++;const e=et.create("div",{className:"TravelNotes-OsmSearchPaneUI-SearchItem TravelNotes-OsmSearchPaneUI-SearchItemMargin"+this.bd,dataset:{ObjId:t.objId}},this.Nd);if(!t.isRoot){et.create("input",{type:"checkbox",checked:t.isSelected},e).addEventListener("change",this.fd,!1)}if(0===t.filterTagsArray.length){et.create("div",{className:"TravelNotes-UI-Button TravelNotes-OsmSearchPaneUI-TreeArrow",textContent:t.isExpanded?"▼":"▶"},e).addEventListener("click",this.Td,!1)}et.create("text",{value:t.name},e),t.isExpanded&&t.items.forEach((t=>this.yd(t))),this.bd--}constructor(){this.bd=0,this.Nd=et.create("div",{id:"TravelNotes-OsmSearchPaneUI-SearchTree"}),this.Nd.addEventListener("wheel",new Pr,{passive:!0}),this.fd=new Er(this),this.Td=new Cr(this),this.yd(dr.dictionary)}redraw(){this.Nd.textContent="",this.yd(dr.dictionary)}get treeHTMLElement(){return this.Nd}}class Sr{Re;constructor(){this.Re=et.create("div",{className:"TravelNotes-WaitAnimation"}),et.create("div",{className:"TravelNotes-WaitAnimationBullet"},this.Re),this.Re.classList.add("TravelNotes-Hidden")}showWait(){this.Re.classList.remove("TravelNotes-Hidden")}hideWait(){this.Re.classList.add("TravelNotes-Hidden")}get waitHTMLElement(){return this.Re}}class kr{gd;Id;wd;Au;constructor(t){this.Au=t,this.gd=new Lr,this.wd=new Sr,this.Id=new xr(this.gd,this.wd)}addControl(){this.Au.appendChild(this.Id.toolbarHTMLElement),this.Au.appendChild(this.gd.treeHTMLElement),this.Au.appendChild(this.wd.waitHTMLElement)}clearControl(){this.Au.removeChild(this.gd.treeHTMLElement),this.Au.removeChild(this.Id.toolbarHTMLElement),this.wd.hideWait(),this.Au.removeChild(this.wd.waitHTMLElement)}}class Ar extends Ji{Md;Dd;xd;constructor(t,e){super(t,e),this.Md=new br(this.paneData),this.Dd=new kr(this.paneControl),this.xd=new mr}remove(){this.xd.hide(),this.Md.clearData(),this.Dd.clearControl()}add(){this.xd.show(),this.Dd.addControl(),this.Md.addData()}get paneId(){return l.searchPane}get buttonText(){return S.getText("OsmSearchPaneUI - Search")}}class Rr{ii;Ed;Pd;Cd;Ld;Ou;oi;Sd;kd;Ad=Number.MAX_VALUE;static get Rd(){return 100}Od(t){switch(t.type){case"touchstart":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);this.Ad=e.screenX,this.kd||this.gs()}break;case"touchend":if(1===t.changedTouches.length){const e=t.changedTouches.item(0);Rr.Rd<e.screenX-this.Ad&&this.li()}this.Ad=Number.MAX_VALUE}}lu(){this.Sd||(this.oi=setTimeout((()=>this.li()),t.travelEditor.timeout))}gs(){if(this.Sd)return;this.oi&&(clearTimeout(this.oi),this.oi=null),this.ii.classList.remove("TravelNotes-UI-Minimized"),this.Ed.classList.add("TravelNotes-Hidden");const t=this.ii.childNodes;for(let e=1;e<t.length;e++)t[e].classList.remove("TravelNotes-Hidden");this.kd=!0}li(){if(this.Sd)return;this.ii.classList.add("TravelNotes-UI-Minimized"),this.Ed.classList.remove("TravelNotes-Hidden");const t=this.ii.childNodes;for(let e=1;e<t.length;e++)t[e].classList.add("TravelNotes-Hidden");this.kd=!1}constructor(){this.Sd=!1}pin(){this.Sd=!this.Sd}createUI(e){this.ii||(this.ii=et.create("div",{id:"TravelNotes-UI-MainDiv"},e),this.Ed=et.create("div",{id:"TravelNotes-UI-MainDiv-Title",textContent:"Travel & Notes"},this.ii),this.Pd=new Zi(this.ii),this.Cd=new Bi(this.ii),this.Ld=new Ui(this.ii),this.Ld.addPane(ar),this.Ld.addPane(ur),this.Ld.addPane(Ar),this.Ld.showPane(l.itineraryPane),this.Ou=new Wi(this.ii),this.ii.addEventListener("touchstart",(t=>this.Od(t)),!1),this.ii.addEventListener("touchend",(t=>this.Od(t)),!1),this.ii.addEventListener("mouseenter",(()=>this.gs()),!1),this.ii.addEventListener("mouseleave",(()=>this.lu()),!1),t.travelEditor.startMinimized?(this.li(),this.Sd=!1):(this.gs(),this.Sd=!0))}get travelNotesToolbarUI(){return this.Pd}get travelUI(){return this.Cd}get panesManagerUI(){return this.Ld}get providersToolbarUI(){return this.Ou}}const Or=new Rr;class Br{constructor(){}openDistantFile(t){(new ii).decompress(t),V.travel.jsonObject=t,V.travel.readOnly=!0,document.title="Travel & Notes"+(""===V.travel.name?"":" - "+V.travel.name);const e=V.travel.routes.iterator;for(;!e.done;)c.notEdited===e.value.editionStatus?Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:e.value.objId}):V.editedRouteObjId=e.value.objId;m!==V.editedRouteObjId&&Ut.dispatch("routeupdated",{removedRouteObjId:m,addedRouteObjId:V.travel.editedRoute.objId});const s=V.travel.notes.iterator;for(;!s.done;)Ut.dispatch("noteupdated",{removedNoteObjId:m,addedNoteObjId:s.value.objId});(new es).zoomToTravel()}}class jr extends Nt{Bd=null;constructor(){super(),this.Bd=et.create("div",{id:"TravelNotes-AboutDialog-AboutDiv"}),L.sanitizeToHtmlElement('<p>This  program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or any later version.</p><p>Copyright - 2017 2022 - wwwouaiebe</p><p>Contact : <a href="https://www.ouaie.be/pages/Contact" target="_blank">https://www.ouaie.be/</a></p><p>GitHub : <a href="https://github.com/wwwouaiebe/TravelNotes" target="_blank">https://github.com/wwwouaiebe/TravelNotes</a></p><p>Version : v4.0.0-dev.<p>This program uses: <a href="https://leafletjs.com/" target="_blank">leaflet</a>, <a href="https://github.com/Project-OSRM/osrm-text-instructions" target="_blank">Project-OSRM/osrm-text-instructions</a> and  <a href="https://github.com/drolbr/Overpass-API" target="_blank">the Overpass API</a></p>',this.Bd)}get contentHTMLElements(){return[this.Bd]}get title(){return S.getText("AboutDialog - About Travel & Notes")}}class Hr extends se{constructor(t,e){super(t,e)}get menuItems(){return[new te(S.getText("MapContextMenu - Select this point as start point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat,(()=>ys.setStartPoint(this.eventData.latLng))),new te(S.getText("MapContextMenu - Select this point as way point"),m!==V.editedRouteObjId,(()=>ys.addWayPoint(this.eventData.latLng))),new te(S.getText("MapContextMenu - Select this point as end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>ys.setEndPoint(this.eventData.latLng))),new te(S.getText("MapContextMenu - Select this point as start and end point"),m!==V.editedRouteObjId&&h.defaultValue===V.travel.editedRoute.wayPoints.first.lat&&h.defaultValue===V.travel.editedRoute.wayPoints.last.lat,(()=>ys.setStartAndEndPoint(this.eventData.latLng))),new te(S.getText("MapContextMenu - Add a route"),!0,(()=>Ts.addRoute())),new te(S.getText("MapContextMenu - Hide all routes"),!0,(()=>Ts.hideRoutes())),new te(S.getText("MapContextMenu - Show all routes"),!0,(()=>Ts.showRoutes())),new te(S.getText("MapContextMenu - New travel note"),!0,(()=>Ke.newTravelNote(this.eventData.latLng))),new te(S.getText("MapContextMenu - Hide all notes"),!0,(()=>Ke.hideNotes())),new te(S.getText("MapContextMenu - Show all notes"),!0,(()=>Ke.showNotes())),new te(S.getText("MapContextMenu - Zoom to travel"),!0,(()=>(new es).zoomToTravel())),new te(S.getText("MapContextMenu - About Travel & Notes"),!0,(()=>(new jr).show().catch((()=>{}))))]}}const Ur=new class{jd=!1;async Hd(t){const e=await fetch(t);_===e.status&&e.ok?(new Br).openDistantFile(await e.json()):(V.map.setView([h.defaultValue,h.defaultValue],2),document.title="Travel & Notes")}constructor(){}addReadOnlyMap(t){this.jd||(this.jd=!0,hi.createUI(),wi.setMapLayer("OSM - Color"),this.Hd(t))}addControl(){this.jd||(this.jd=!0,document.title="Travel & Notes",V.map.on("contextmenu",(t=>new Hr(t).show())),V.map.setView([t.map.center.lat,t.map.center.lng],t.map.zoom),Or.createUI(et.create("div",{id:"TravelNotes-UI"},document.body)),hi.createUI(),t.layersToolbarUI.haveLayersToolbarUI?wi.createUI():wi.setMapLayer("OSM - Color"),t.mouseUI.haveMouseUI&&(ei.createUI(),ei.saveStatus=u.saved),jt.showHelp("<p>"+S.getText("Help - Continue with interface1")+"</p><p>"+S.getText("Help - Continue with interface2")+"</p>"),Ft.setKeysFromServerFile(),V.travel.jsonObject=(new K).jsonObject,t.travelEditor.startupRouteEdition&&Ts.editRoute(V.travel.routes.first.objId),Ut.dispatch("setrouteslist"),Ut.dispatch("roadbookupdate"))}addProvider(t){Ft.addProvider(t)}showInfo(t){jt.showInfo(t)}get overpassApiUrl(){return t.overpassApi.url}get map(){return V.map}get version(){return y}};class Fr{Ud(t,e){if("object"==typeof t&&"object"==typeof e){for(const s in e)"object"==typeof e[s]?this.Ud(t[s],e[s]):typeof t[s]==typeof e[s]&&("string"==typeof e[s]?e[s]="color"===s?L.sanitizeToColor(t[s])||e[s]:"url"===s?L.sanitizeToUrl(t[s]).url:L.sanitizeToJsString(t[s]):e[s]=t[s]||e[s]);for(const s in t)"object"==typeof t[s]?("[object Array]"===Object.prototype.toString.call(t[s])?e[s]=e[s]||[]:e[s]=e[s]||{},this.Ud(t[s],e[s])):"string"==typeof e.property?e[s]=L.sanitizeToHtmlString(t[s],[]).htmlString:e[s]=t[s]}}Fd(t){for(const e in t)"object"==typeof t[e]&&this.Fd(t[e]);Object.freeze(t)}constructor(){}overload(e){this.Ud(e,t),this.Fd(t)}}class Kr{Kd;constructor(){this.Kd=k.storageAvailable("localStorage")}handleEvent(){ei.saveStatus=u.modified,this.Kd&&$s.getOpenPromise().then((()=>{$s.getWritePromise(V.UUID,Qs.getTravelHTML("TravelNotes-Roadbook-").outerHTML)})).then((()=>localStorage.setItem(V.UUID,Date.now()))).catch((t=>{t instanceof Error&&console.error(t)}))}}(new class{Wd;Vd;zd;Gd;Xd(){document.addEventListener("routeupdated",(t=>{t.data&&Ys.updateRoute(t.data.removedRouteObjId,t.data.addedRouteObjId)}),!1),document.addEventListener("routepropertiesupdated",(t=>{t.data&&Ys.updateRouteProperties(t.data.routeObjId)}),!1),document.addEventListener("noteupdated",(t=>{t.data&&Ys.updateNote(t.data.removedNoteObjId,t.data.addedNoteObjId)}),!1),document.addEventListener("removeobject",(t=>{t.data&&Ys.removeObject(t.data.objId)}),!1),document.addEventListener("removeallobjects",(()=>Ys.removeAllObjects()),!1),document.addEventListener("zoomto",(t=>{t.data&&Ys.zoomTo(t.data.latLng,t.data.geometry)}),!1),document.addEventListener("additinerarypointmarker",(t=>{t.data&&Ys.addItineraryPointMarker(t.data.objId,t.data.latLng)}),!1),document.addEventListener("addsearchpointmarker",(t=>{t.data&&Ys.addSearchPointMarker(t.data.objId,t.data.latLng,t.data.geometry)}),!1),document.addEventListener("addrectangle",(t=>{t.data&&Ys.addRectangle(t.data.objId,t.data.bounds,t.data.properties)}),!1),document.addEventListener("addwaypoint",(t=>{t.data&&Ys.addWayPoint(t.data.wayPoint,t.data.letter)}),!1),document.addEventListener("layerchange",(t=>{t.data&&Ys.setLayer(t.data.layer)})),document.addEventListener("geolocationpositionchanged",(t=>{t.data&&Ys.onGeolocationPositionChanged(t.data.position)}),!1),document.addEventListener("geolocationstatuschanged",(t=>{t.data&&Ys.onGeolocationStatusChanged(t.data.status)}),!1),document.addEventListener("roadbookupdate",new Kr,!1),document.addEventListener("profileclosed",(t=>{t.data&&ls.onProfileClosed(t.data.objId)}),!1),document.addEventListener("uipinned",(()=>Or.pin()),!1),document.addEventListener("geolocationstatuschanged",(t=>{Or.travelNotesToolbarUI.geoLocationStatusChanged(t.data.status)}),!1),document.addEventListener("travelnameupdated",(()=>Or.travelUI.setTravelName()),!1),document.addEventListener("setrouteslist",(()=>Or.travelUI.routesListUI.setRoutesList()),!1),document.addEventListener("showitinerary",(()=>{t.paneUI.switchToItinerary?Or.panesManagerUI.showPane(l.itineraryPane):Or.panesManagerUI.updatePane(l.itineraryPane)}),!1),document.addEventListener("updateitinerary",(()=>Or.panesManagerUI.updatePane(l.itineraryPane)),!1),document.addEventListener("showtravelnotes",(()=>{t.paneUI.switchToTravelNotes?Or.panesManagerUI.showPane(l.travelNotesPane):Or.panesManagerUI.updatePane(l.travelNotesPane)}),!1),document.addEventListener("updatetravelnotes",(()=>Or.panesManagerUI.updatePane(l.travelNotesPane)),!1),document.addEventListener("showsearch",(()=>{t.paneUI.switchToSearch?Or.panesManagerUI.showPane(l.searchPane):Or.panesManagerUI.updatePane(l.searchPane)}),!1),document.addEventListener("updatesearch",(()=>Or.panesManagerUI.updatePane(l.searchPane)),!1),document.addEventListener("providersadded",(()=>Or.providersToolbarUI.providersAdded()),!1),document.addEventListener("setprovider",(t=>{t?.data?.provider&&(Or.providersToolbarUI.provider=t.data.provider)}),!1),document.addEventListener("settransitmode",(t=>{t?.data?.transitMode&&(Or.providersToolbarUI.transitMode=t.data.transitMode)}),!1)}Zd(){window.addEventListener("unload",(()=>localStorage.removeItem(V.UUID))),window.addEventListener("beforeunload",(e=>{if($s.closeDb(V.UUID),t.travelNotes.haveBeforeUnloadWarning)return e.returnValue="x","x"}))}Jd(){const t=new URL(window.location);let e=t.searchParams.get("fil");if(e&&0!==e.length)try{if(e=atob(e),e.match(/[^\w-%:./]/))throw new Error("invalid char in the url encoded in the fil parameter");const s=new URL(e);if(!(t.protocol&&s.protocol&&t.protocol===s.protocol&&t.hostname&&s.hostname&&t.hostname===s.hostname))throw new Error("The distant file is not on the same site than the app");this.Wd=encodeURI(s.href)}catch(t){t instanceof Error&&console.error(t)}const s=t.searchParams.get("lng");s&&s.match(/^[A-Z,a-z]{2}$/)&&(this.Vd=s.toLowerCase())}async Yd(){const e=await fetch(this.zd+"Config.json");if(_===e.status&&e.ok){const s=await e.json();return s.travelNotes.language=this.Vd||s.travelNotes.language,"wwwouaiebe.github.io"===window.location.hostname&&(s.APIKeysDialog.haveUnsecureButtons=!0,s.errorsUI.showHelp=!0,s.layersToolbarUI.theDevil.addButton=!1,s.note.maxManeuversNotes=120,s.note.haveBackground=!0,s.noteDialog.theDevil.addButton=!1,s.printRouteMap.maxTiles=10,s.route.showDragTooltip=w),(new Fr).overload(s),V.providers.forEach((e=>{e.userLanguage=t.travelNotes.language})),!0}return!1}async qd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(S.setTranslations(await t.value.json()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(S.setTranslations(await e.value.json()),this.Gd+="Not possible to load the TravelNotes"+this.Vd.toUpperCase()+".json file. English will be used. ",!0):(this.Gd+="Not possible to load the translations. ",!1)}async $d(t,e){if("fulfilled"===t.status&&_===t.value.status&&t.value.ok){const e=await t.value.json();return oe.loadJson(e),!0}if("fulfilled"===e.status&&_===e.value.status&&e.value.ok){const t=await e.value.json();return oe.loadJson(t),this.Gd+="Not possible to load the TravelNotesNoteDialog"+this.Vd.toUpperCase()+".json file. English will be used. ",!0}return this.Gd+="Not possible to load the translations for the note dialog. ",!1}async Qd(t,e){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(dr.parseDictionary(await t.value.text()),!0):"fulfilled"===e.status&&_===e.value.status&&e.value.ok?(dr.parseDictionary(await e.value.text()),this.Gd+="Not possible to load the TravelNotesSearchDictionary"+this.Vd.toUpperCase()+".csv file. English will be used. ",!0):(this.Gd+="Not possible to load the search dictionary. OSM search will not be available.",!0)}async tp(t){return"fulfilled"===t.status&&_===t.value.status&&t.value.ok?(_s.addMapLayers(await t.value.json()),!0):(this.Gd+="Not possible to load the TravelNotesLayers.json file. Only the OpenStreetMap background will be available. ",!0)}async ep(){const t=await Promise.allSettled([fetch(this.zd+this.Vd.toUpperCase()+".json"),fetch(this.zd+"EN.json"),fetch(this.zd+"NoteDialog"+this.Vd.toUpperCase()+".json"),fetch(this.zd+"NoteDialogEN.json"),fetch(this.zd+"SearchDictionary"+this.Vd.toUpperCase()+".csv"),fetch(this.zd+"SearchDictionaryEN.csv"),fetch(this.zd+"Layers.json")]),e=await this.qd(t[0],t[1])&&await this.$d(t[2],t[3])&&await this.Qd(t[4],t[5])&&await this.tp(t[6]);return""!==this.Gd&&e?jt.showError(this.Gd):""!==this.Gd&&(document.body.textContent=this.Gd),e}sp(){const t=document.createElement("div");t.id="TravelNotes-Map",document.body.appendChild(t),V.map=window.L.map(t.id,{attributionControl:!1,zoomControl:!1}).setView([h.defaultValue,h.defaultValue],0),this.Wd?Ur.addReadOnlyMap(this.Wd):(this.Zd(),Ur.addControl("TravelNotes-UI"))}constructor(){this.zd=window.location.href.substring(0,window.location.href.lastIndexOf("/")+1)+"TravelNotes",this.Gd=""}async loadApp(){this.Xd(),window.TaN=Ur,this.Jd(),await this.Yd()?(this.Vd=this.Vd||t.travelNotes.language||"fr",jt.createUI(),await this.ep()&&this.sp()):document.body.textContent="Not possible to load the TravelNotesConfig.json file. "}}).loadApp()}();